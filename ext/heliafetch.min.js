(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.HeliaVerifiedFetch = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var HeliaVerifiedFetch=(()=>{var DF=Object.create;var Jm=Object.defineProperty;var NF=Object.getOwnPropertyDescriptor;var OF=Object.getOwnPropertyNames;var LF=Object.getPrototypeOf,BF=Object.prototype.hasOwnProperty;var ft=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Ft=(r,e)=>{for(var t in e)Jm(r,t,{get:e[t],enumerable:!0})},wS=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of OF(e))!BF.call(r,i)&&i!==t&&Jm(r,i,{get:()=>e[i],enumerable:!(n=NF(e,i))||n.enumerable});return r};var it=(r,e,t)=>(t=r!=null?DF(LF(r)):{},wS(e||!r||!r.__esModule?Jm(t,"default",{value:r,enumerable:!0}):t,r)),MF=r=>wS(Jm({},"__esModule",{value:!0}),r);var z_=ft((iue,f7)=>{"use strict";var pz=Object.prototype.hasOwnProperty,wn="~";function np(){}Object.create&&(np.prototype=Object.create(null),new np().__proto__||(wn=!1));function mz(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function V_(r,e,t,n,i){if(typeof t!="function")throw new TypeError("The listener must be a function");var o=new mz(t,n||r,i),s=wn?wn+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],o]:r._events[s].push(o):(r._events[s]=o,r._eventsCount++),r}function og(r,e){--r._eventsCount===0?r._events=new np:delete r._events[e]}function tn(){this._events=new np,this._eventsCount=0}tn.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)pz.call(t,n)&&e.push(wn?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};tn.prototype.listeners=function(e){var t=wn?wn+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,s=new Array(o);i<o;i++)s[i]=n[i].fn;return s};tn.prototype.listenerCount=function(e){var t=wn?wn+e:e,n=this._events[t];return n?n.fn?1:n.length:0};tn.prototype.emit=function(e,t,n,i,o,s){var a=wn?wn+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,i),!0;case 5:return c.fn.call(c.context,t,n,i,o),!0;case 6:return c.fn.call(c.context,t,n,i,o,s),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,i);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};tn.prototype.on=function(e,t,n){return V_(this,e,t,n,!1)};tn.prototype.once=function(e,t,n){return V_(this,e,t,n,!0)};tn.prototype.removeListener=function(e,t,n,i){var o=wn?wn+e:e;if(!this._events[o])return this;if(!t)return og(this,o),this;var s=this._events[o];if(s.fn)s.fn===t&&(!i||s.once)&&(!n||s.context===n)&&og(this,o);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||i&&!s[a].once||n&&s[a].context!==n)&&c.push(s[a]);c.length?this._events[o]=c.length===1?c[0]:c:og(this,o)}return this};tn.prototype.removeAllListeners=function(e){var t;return e?(t=wn?wn+e:e,this._events[t]&&og(this,t)):(this._events=new np,this._eventsCount=0),this};tn.prototype.off=tn.prototype.removeListener;tn.prototype.addListener=tn.prototype.on;tn.prefixed=wn;tn.EventEmitter=tn;typeof f7<"u"&&(f7.exports=tn)});var y7=ft((Tue,W_)=>{W_.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(o,s){t[o]=s,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(o){return t[o]!==void 0||n[o]!==void 0},remove:function(o){t[o]!==void 0&&(t[o]=void 0),n[o]!==void 0&&(n[o]=void 0)},get:function(o){var s=t[o];if(s!==void 0)return s;if((s=n[o])!==void 0)return i(o,s),s},set:function(o,s){t[o]!==void 0?t[o]=s:i(o,s)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var kT=ft(gp=>{(function(){var r,e,t,n,i,o,s,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},s=function(c){var l,u,f,h,d,m;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),d=m[0],u=m[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),o=t("a"),i=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-o)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-i)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=function(){function c(l,u){var f,h,d,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(m=l.split("/",2),l=m[0],u=m[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=s(u)}catch(g){throw f=g,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(s(l)&this.maskLong)>>>0}catch(g){throw f=g,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(s(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=s(this.first),f=s(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),gp.ip2long=s,gp.long2ip=a,gp.Netmask=r}).call(gp)});var u2=ft((hme,Tx)=>{var dme=function(){typeof Tx<"u"&&(Tx.exports=g);var r=86400,e=3200,t=146097*e/400,n=r*t,i=1e3*n,o=864e13,s=4294967296,a=1e6,c="000000000",l=Math.trunc||function(I){var k=I-I%1;return k==0&&(I<0||I===0&&1/I!=1/0)?-0:k},u=g.prototype,f=(g.fromDate=function(I){return new g(+I)},g.fromInt64BE=S(0,1,2,3,0,4),g.fromInt64LE=S(3,2,1,0,4,0),g.fromString=function(K){var k,Q=new g,K=(K+="").replace(/^\s*[+\-]?\d+/,function(X){var X=+X,$=1970+(X-1970)%400;return Q.year=X-$,$}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(V,X,$){return X<0&&($*=-1),k=6e4*(60*+X+ +$),""}).replace(/\.\d+$/,function(V){return Q.nano=+(V+c).substr(1,9),""}).split(/\D+/);if(1<K.length?K[1]--:K[1]=0,Q.time=k=Date.UTC.apply(Date,K)-(k||0),isNaN(k))throw new TypeError("Invalid Date");return w(Q)},g.fromTimeT=function(I){return v(I,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(I){return this.nano+=+I||0,this},u.getNano=function(){var I=w(this);return(I.time%1e3*a+ +I.nano+1e9)%1e9},u.getTimeT=function(){var k=w(this),I=Math.floor(k.time/1e3),k=k.year;return k&&(I+=k*t*r/e),I},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return x(w(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(I){var k=this,Q=k.toDate(),K={H:function(){return D(Q.getUTCHours())},L:function(){return A(Q.getUTCMilliseconds(),3)},M:function(){return D(Q.getUTCMinutes())},N:function(){return A(k.getNano(),9)},S:function(){return D(Q.getUTCSeconds())},Y:function(){var V=k.getYear();return 999999<V?"+"+V:9999<V?"+"+A(V,6):0<=V?A(V,4):-999999<=V?"-"+A(-V,6):V},a:function(){return d[Q.getUTCDay()]},b:function(){return h[Q.getUTCMonth()]},d:function(){return D(Q.getUTCDate())},e:function(){return function(V){return(9<V?"":" ")+(0|V)}(Q.getUTCDate())},m:function(){return D(Q.getUTCMonth()+1)}};return function V(X){return X.replace(/%./g,function($){var z=$[1],F=m[z],z=K[z];return F?V(F):z?z():$})}(I||f)},u.writeInt64BE=b(0,1,2,3,0,4),u.writeInt64LE=b(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return g;function g(I,k,Q){var K=this;if(!(K instanceof g))return new g(I,k,Q);K.time=+I||0,K.nano=+k||0,K.year=+Q||0,w(K)}function w(I){var k,Q,K,V=I.year,X=I.time,$=I.nano,F=(($<0||a<=$)&&($-=(Q=Math.floor($/a))*a,X+=Q,Q=1),V%e);return(X<-o||o<X||F)&&((k=l(X/i))&&(V+=k*e,X-=k*i),(K=x(X)).setUTCFullYear(F+K.getUTCFullYear()),K=(X=+K)+(k=l((V-=F)/e))*i,k&&-o<=K&&K<=o&&(V-=k*e,X=K),Q=1),Q&&(I.year=V,I.time=X,I.nano=$),I}function x(I){var k=new Date(0);return k.setTime(I),k}function v(V,K){V=+V||0;var Q=l((K=(K|0)*s)/n)+l(V/n),K=K%n+V%n,V=l(K/n);return V&&(Q+=V,K-=V*n),new g(1e3*K,0,Q*e)}function b(I,k,Q,K,V,X){return function(F,z){var R=w(this);F=F||new Array(8),T(F,z|=0);var N=Math.floor(R.time/1e3),R=R.year*(t*r/e),M=l(R/s)+l(N/s),R=R%s+N%s,N=Math.floor(R/s);return N&&(M+=N,R-=N*s),$(F,z+V,M),$(F,z+X,R),F};function $(F,z,M){F[z+I]=M>>24&255,F[z+k]=M>>16&255,F[z+Q]=M>>8&255,F[z+K]=255&M}}function S(I,k,Q,K,V,X){return function(F,z){T(F,z|=0);var M=$(F,z+V);return v($(F,z+X),M)};function $(F,z){return 16777216*F[z+I]+(F[z+k]<<16|F[z+Q]<<8|F[z+K])}}function T(I,k){if(I=I&&I.length,I==null)throw new TypeError("Invalid Buffer");if(I<k+8)throw new RangeError("Out of range")}function D(I){return(9<I?"":"0")+(0|I)}function A(I,k){return(c+(0|I)).substr(-k)}}()});var ZP=ft((sve,QP)=>{"use strict";QP.exports=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;let e=Object.getPrototypeOf(r);return e===null||e===Object.prototype}});var iR=ft((rR,nR)=>{"use strict";var g3=ZP(),{hasOwnProperty:eR}=Object.prototype,{propertyIsEnumerable:qW}=Object,ed=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),jW=rR,JP={concatArrays:!1,ignoreUndefined:!1},y3=r=>{let e=[];for(let t in r)eR.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)qW.call(r,n)&&e.push(n)}return e};function td(r){return Array.isArray(r)?WW(r):g3(r)?GW(r):r}function WW(r){let e=r.slice(0,0);return y3(r).forEach(t=>{ed(e,t,td(r[t]))}),e}function GW(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return y3(r).forEach(t=>{ed(e,t,td(r[t]))}),e}var tR=(r,e,t,n)=>(t.forEach(i=>{typeof e[i]>"u"&&n.ignoreUndefined||(i in r&&r[i]!==Object.getPrototypeOf(r)?ed(r,i,$9(r[i],e[i],n)):ed(r,i,td(e[i])))}),r),XW=(r,e,t)=>{let n=r.slice(0,0),i=0;return[r,e].forEach(o=>{let s=[];for(let a=0;a<o.length;a++)eR.call(o,a)&&(s.push(String(a)),o===r?ed(n,i++,o[a]):ed(n,i++,td(o[a])));n=tR(n,o,y3(o).filter(a=>!s.includes(a)),t)}),n};function $9(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?XW(r,e,t):!g3(e)||!g3(r)?td(e):tR(r,e,y3(e),t)}nR.exports=function(...r){let e=$9(td(JP),this!==jW&&this||{},JP),t={_:{}};for(let n of r)if(n!==void 0){if(!g3(n))throw new TypeError("`"+n+"` is not an Option Object");t=$9(t,{_:n},e)}return t._}});var aR=ft((cve,sR)=>{"use strict";function YW(r){return r>=55296&&r<=56319}function QW(r){return r>=56320&&r<=57343}sR.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,o=0,s,a,c=0;c<i;c+=1){if(s=t.charCodeAt(c),a=t[c],YW(s)&&QW(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),o+=e(a),o===n)return t.slice(0,c+1);if(o>n)return t.slice(0,c-a.length+1)}return t}});var lR=ft((lve,cR)=>{"use strict";function ZW(r){return r>=55296&&r<=56319}function JW(r){return r>=56320&&r<=57343}cR.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,o=null,s=0;s<t;s++)i=e.charCodeAt(s),JW(i)?o!=null&&ZW(o)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),o=i;return n}});var fR=ft((uve,uR)=>{"use strict";var eG=aR(),tG=lR();uR.exports=eG.bind(null,tG)});var pR=ft((fve,hR)=>{"use strict";var rG=fR(),nG=/[\/\?<>\\:\*\|"]/g,iG=/[\x00-\x1f\x80-\x9f]/g,oG=/^\.+$/,sG=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,aG=/[\. ]+$/;function dR(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(nG,e).replace(iG,e).replace(oG,e).replace(sG,e).replace(aG,e);return rG(t,255)}hR.exports=function(r,e){var t=e&&e.replacement||"",n=dR(r,t);return t===""?n:dR(n,"")}});var Ms=ft(nd=>{"use strict";var lG="[object ArrayBuffer]",Bs=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===lG}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),i=r.toUint8Array(t);if(n.length!==i.byteLength)return!1;for(let o=0;o<n.length;o++)if(n[o]!==i[o])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let s of t)n+=s.byteLength;let i=new Uint8Array(n),o=0;for(let s of t){let a=this.toUint8Array(s);i.set(a,o),o+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}},H9="string",uG=/^[0-9a-f\s]+$/i,fG=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,dG=/^[a-zA-Z0-9-_]+$/,x3=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}static toString(e){let t=Bs.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return decodeURIComponent(escape(n))}},Ni=class{static toString(e,t=!1){let n=Bs.toArrayBuffer(e),i=new DataView(n),o="";for(let s=0;s<n.byteLength;s+=2){let a=i.getUint16(s,t);o+=String.fromCharCode(a)}return o}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),i=new DataView(n);for(let o=0;o<e.length;o++)i.setUint16(o*2,e.charCodeAt(o),t);return n}},b3=class r{static isHex(e){return typeof e===H9&&uG.test(e)}static isBase64(e){return typeof e===H9&&fG.test(e)}static isBase64Url(e){return typeof e===H9&&dG.test(e)}static ToString(e,t="utf8"){let n=Bs.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Ni.toString(n,!0);case"utf16":case"utf16be":return Ni.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Ni.fromString(e,!0);case"utf16":case"utf16be":return Ni.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=Bs.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return x3.fromString(e);case"utf16":case"utf16be":return Ni.fromString(e);case"utf16le":case"usc2":return Ni.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return x3.toString(e);case"utf16":case"utf16be":return Ni.toString(e);case"utf16le":case"usc2":return Ni.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n.buffer}static ToBinary(e){let t=Bs.toUint8Array(e),n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return n}static ToHex(e){let t=Bs.toUint8Array(e),n="",i=t.length;for(let o=0;o<i;o++){let s=t[o];s<16&&(n+="0"),n+=s.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){let o=t.slice(i,i+2);n[i/2]=parseInt(o,16)}return n.buffer}static ToUtf16String(e,t=!1){return Ni.toString(e,t)}static FromUtf16String(e,t=!1){return Ni.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};b3.DEFAULT_UTF8_ENCODING="utf8";function hG(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let i=arguments[n];for(let o in i)t[o]=i[o]}return t}function pG(...r){let e=r.map(i=>i.byteLength).reduce((i,o)=>i+o),t=new Uint8Array(e),n=0;return r.map(i=>new Uint8Array(i)).forEach(i=>{for(let o of i)t[n++]=o}),t.buffer}function mG(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}nd.BufferSourceConverter=Bs;nd.Convert=b3;nd.assign=hG;nd.combine=pG;nd.isEqual=mG});var HD=ft(()=>{var $D;(function(r){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),n=i(r);typeof t.Reflect<"u"&&(n=i(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function i(c,l){return function(u,f){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:f}),l&&l(u,f)}}function o(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return o()||s()}})(function(e,t){var n=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",o=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return g8(Object.create(null))}:c?function(){return g8({__proto__:null})}:function(){return g8({})},has:l?function(C,L){return n.call(C,L)}:function(C,L){return L in C},get:l?function(C,L){return n.call(C,L)?C[L]:void 0}:function(C,L){return C[L]}},f=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:TF(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:CF(),m=typeof WeakMap=="function"?WeakMap:kF(),g=i?Symbol.for("@reflect-metadata:registry"):void 0,w=AF(),x=_F(w);function v(C,L,j,te){if(q(j)){if(!Rt(C))throw new TypeError;if(!mr(L))throw new TypeError;return V(C,L)}else{if(!Rt(C))throw new TypeError;if(!le(L))throw new TypeError;if(!le(te)&&!q(te)&&!ge(te))throw new TypeError;return ge(te)&&(te=void 0),j=bt(j),X(C,L,j,te)}}e("decorate",v);function b(C,L){function j(te,Ae){if(!le(te))throw new TypeError;if(!q(Ae)&&!Qn(Ae))throw new TypeError;R(C,L,te,Ae)}return j}e("metadata",b);function S(C,L,j,te){if(!le(j))throw new TypeError;return q(te)||(te=bt(te)),R(C,L,j,te)}e("defineMetadata",S);function T(C,L,j){if(!le(L))throw new TypeError;return q(j)||(j=bt(j)),$(C,L,j)}e("hasMetadata",T);function D(C,L,j){if(!le(L))throw new TypeError;return q(j)||(j=bt(j)),F(C,L,j)}e("hasOwnMetadata",D);function A(C,L,j){if(!le(L))throw new TypeError;return q(j)||(j=bt(j)),z(C,L,j)}e("getMetadata",A);function I(C,L,j){if(!le(L))throw new TypeError;return q(j)||(j=bt(j)),M(C,L,j)}e("getOwnMetadata",I);function k(C,L){if(!le(C))throw new TypeError;return q(L)||(L=bt(L)),N(C,L)}e("getMetadataKeys",k);function Q(C,L){if(!le(C))throw new TypeError;return q(L)||(L=bt(L)),Z(C,L)}e("getOwnMetadataKeys",Q);function K(C,L,j){if(!le(L))throw new TypeError;if(q(j)||(j=bt(j)),!le(L))throw new TypeError;q(j)||(j=bt(j));var te=yh(L,j,!1);return q(te)?!1:te.OrdinaryDeleteMetadata(C,L,j)}e("deleteMetadata",K);function V(C,L){for(var j=C.length-1;j>=0;--j){var te=C[j],Ae=te(L);if(!q(Ae)&&!ge(Ae)){if(!mr(Ae))throw new TypeError;L=Ae}}return L}function X(C,L,j,te){for(var Ae=C.length-1;Ae>=0;--Ae){var Yt=C[Ae],gr=Yt(L,j,te);if(!q(gr)&&!ge(gr)){if(!le(gr))throw new TypeError;te=gr}}return te}function $(C,L,j){var te=F(C,L,j);if(te)return!0;var Ae=m8(L);return ge(Ae)?!1:$(C,Ae,j)}function F(C,L,j){var te=yh(L,j,!1);return q(te)?!1:Ye(te.OrdinaryHasOwnMetadata(C,L,j))}function z(C,L,j){var te=F(C,L,j);if(te)return M(C,L,j);var Ae=m8(L);if(!ge(Ae))return z(C,Ae,j)}function M(C,L,j){var te=yh(L,j,!1);if(!q(te))return te.OrdinaryGetOwnMetadata(C,L,j)}function R(C,L,j,te){var Ae=yh(j,te,!0);Ae.OrdinaryDefineOwnMetadata(C,L,j,te)}function N(C,L){var j=Z(C,L),te=m8(C);if(te===null)return j;var Ae=N(te,L);if(Ae.length<=0)return j;if(j.length<=0)return Ae;for(var Yt=new d,gr=[],qe=0,ae=j;qe<ae.length;qe++){var fe=ae[qe],he=Yt.has(fe);he||(Yt.add(fe),gr.push(fe))}for(var we=0,je=Ae;we<je.length;we++){var fe=je[we],he=Yt.has(fe);he||(Yt.add(fe),gr.push(fe))}return gr}function Z(C,L){var j=yh(C,L,!1);return j?j.OrdinaryOwnMetadataKeys(C,L):[]}function ne(C){if(C===null)return 1;switch(typeof C){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return C===null?1:6;default:return 6}}function q(C){return C===void 0}function ge(C){return C===null}function ke(C){return typeof C=="symbol"}function le(C){return typeof C=="object"?C!==null:typeof C=="function"}function De(C,L){switch(ne(C)){case 0:return C;case 1:return C;case 2:return C;case 3:return C;case 4:return C;case 5:return C}var j=L===3?"string":L===5?"number":"default",te=gh(C,o);if(te!==void 0){var Ae=te.call(C,j);if(le(Ae))throw new TypeError;return Ae}return et(C,j==="default"?"number":j)}function et(C,L){if(L==="string"){var j=C.toString;if(Et(j)){var te=j.call(C);if(!le(te))return te}var Ae=C.valueOf;if(Et(Ae)){var te=Ae.call(C);if(!le(te))return te}}else{var Ae=C.valueOf;if(Et(Ae)){var te=Ae.call(C);if(!le(te))return te}var Yt=C.toString;if(Et(Yt)){var te=Yt.call(C);if(!le(te))return te}}throw new TypeError}function Ye(C){return!!C}function pt(C){return""+C}function bt(C){var L=De(C,3);return ke(L)?L:pt(L)}function Rt(C){return Array.isArray?Array.isArray(C):C instanceof Object?C instanceof Array:Object.prototype.toString.call(C)==="[object Array]"}function Et(C){return typeof C=="function"}function mr(C){return typeof C=="function"}function Qn(C){switch(ne(C)){case 3:return!0;case 4:return!0;default:return!1}}function ds(C,L){return C===L||C!==C&&L!==L}function gh(C,L){var j=C[L];if(j!=null){if(!Et(j))throw new TypeError;return j}}function Xm(C){var L=gh(C,s);if(!Et(L))throw new TypeError;var j=L.call(C);if(!le(j))throw new TypeError;return j}function Ym(C){return C.value}function Qm(C){var L=C.next();return L.done?!1:L}function Zm(C){var L=C.return;L&&L.call(C)}function m8(C){var L=Object.getPrototypeOf(C);if(typeof C!="function"||C===f||L!==f)return L;var j=C.prototype,te=j&&Object.getPrototypeOf(j);if(te==null||te===Object.prototype)return L;var Ae=te.constructor;return typeof Ae!="function"||Ae===C?L:Ae}function SF(){var C;!q(g)&&typeof t.Reflect<"u"&&!(g in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(C=IF(t.Reflect));var L,j,te,Ae=new m,Yt={registerProvider:gr,getProvider:ae,setProvider:he};return Yt;function gr(we){if(!Object.isExtensible(Yt))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case C===we:break;case q(L):L=we;break;case L===we:break;case q(j):j=we;break;case j===we:break;default:te===void 0&&(te=new d),te.add(we);break}}function qe(we,je){if(!q(L)){if(L.isProviderFor(we,je))return L;if(!q(j)){if(j.isProviderFor(we,je))return L;if(!q(te))for(var Tt=Xm(te);;){var Qt=Qm(Tt);if(!Qt)return;var Gi=Ym(Qt);if(Gi.isProviderFor(we,je))return Zm(Tt),Gi}}}if(!q(C)&&C.isProviderFor(we,je))return C}function ae(we,je){var Tt=Ae.get(we),Qt;return q(Tt)||(Qt=Tt.get(je)),q(Qt)&&(Qt=qe(we,je),q(Qt)||(q(Tt)&&(Tt=new h,Ae.set(we,Tt)),Tt.set(je,Qt))),Qt}function fe(we){if(q(we))throw new TypeError;return L===we||j===we||!q(te)&&te.has(we)}function he(we,je,Tt){if(!fe(Tt))throw new Error("Metadata provider not registered.");var Qt=ae(we,je);if(Qt!==Tt){if(!q(Qt))return!1;var Gi=Ae.get(we);q(Gi)&&(Gi=new h,Ae.set(we,Gi)),Gi.set(je,Tt)}return!0}}function AF(){var C;return!q(g)&&le(t.Reflect)&&Object.isExtensible(t.Reflect)&&(C=t.Reflect[g]),q(C)&&(C=SF()),!q(g)&&le(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,g,{enumerable:!1,configurable:!1,writable:!1,value:C}),C}function _F(C){var L=new m,j={isProviderFor:function(fe,he){var we=L.get(fe);return q(we)?!1:we.has(he)},OrdinaryDefineOwnMetadata:gr,OrdinaryHasOwnMetadata:Ae,OrdinaryGetOwnMetadata:Yt,OrdinaryOwnMetadataKeys:qe,OrdinaryDeleteMetadata:ae};return w.registerProvider(j),j;function te(fe,he,we){var je=L.get(fe),Tt=!1;if(q(je)){if(!we)return;je=new h,L.set(fe,je),Tt=!0}var Qt=je.get(he);if(q(Qt)){if(!we)return;if(Qt=new h,je.set(he,Qt),!C.setProvider(fe,he,j))throw je.delete(he),Tt&&L.delete(fe),new Error("Wrong provider for target.")}return Qt}function Ae(fe,he,we){var je=te(he,we,!1);return q(je)?!1:Ye(je.has(fe))}function Yt(fe,he,we){var je=te(he,we,!1);if(!q(je))return je.get(fe)}function gr(fe,he,we,je){var Tt=te(we,je,!0);Tt.set(fe,he)}function qe(fe,he){var we=[],je=te(fe,he,!1);if(q(je))return we;for(var Tt=je.keys(),Qt=Xm(Tt),Gi=0;;){var yS=Qm(Qt);if(!yS)return we.length=Gi,we;var PF=Ym(yS);try{we[Gi]=PF}catch(RF){try{Zm(Qt)}finally{throw RF}}Gi++}}function ae(fe,he,we){var je=te(he,we,!1);if(q(je)||!je.delete(fe))return!1;if(je.size===0){var Tt=L.get(he);q(Tt)||(Tt.delete(we),Tt.size===0&&L.delete(Tt))}return!0}}function IF(C){var L=C.defineMetadata,j=C.hasOwnMetadata,te=C.getOwnMetadata,Ae=C.getOwnMetadataKeys,Yt=C.deleteMetadata,gr=new m,qe={isProviderFor:function(ae,fe){var he=gr.get(ae);return!q(he)&&he.has(fe)?!0:Ae(ae,fe).length?(q(he)&&(he=new d,gr.set(ae,he)),he.add(fe),!0):!1},OrdinaryDefineOwnMetadata:L,OrdinaryHasOwnMetadata:j,OrdinaryGetOwnMetadata:te,OrdinaryOwnMetadataKeys:Ae,OrdinaryDeleteMetadata:Yt};return qe}function yh(C,L,j){var te=w.getProvider(C,L);if(!q(te))return te;if(j){if(w.setProvider(C,L,x))return x;throw new Error("Illegal state.")}}function TF(){var C={},L=[],j=function(){function qe(ae,fe,he){this._index=0,this._keys=ae,this._values=fe,this._selector=he}return qe.prototype["@@iterator"]=function(){return this},qe.prototype[s]=function(){return this},qe.prototype.next=function(){var ae=this._index;if(ae>=0&&ae<this._keys.length){var fe=this._selector(this._keys[ae],this._values[ae]);return ae+1>=this._keys.length?(this._index=-1,this._keys=L,this._values=L):this._index++,{value:fe,done:!1}}return{value:void 0,done:!0}},qe.prototype.throw=function(ae){throw this._index>=0&&(this._index=-1,this._keys=L,this._values=L),ae},qe.prototype.return=function(ae){return this._index>=0&&(this._index=-1,this._keys=L,this._values=L),{value:ae,done:!0}},qe}(),te=function(){function qe(){this._keys=[],this._values=[],this._cacheKey=C,this._cacheIndex=-2}return Object.defineProperty(qe.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),qe.prototype.has=function(ae){return this._find(ae,!1)>=0},qe.prototype.get=function(ae){var fe=this._find(ae,!1);return fe>=0?this._values[fe]:void 0},qe.prototype.set=function(ae,fe){var he=this._find(ae,!0);return this._values[he]=fe,this},qe.prototype.delete=function(ae){var fe=this._find(ae,!1);if(fe>=0){for(var he=this._keys.length,we=fe+1;we<he;we++)this._keys[we-1]=this._keys[we],this._values[we-1]=this._values[we];return this._keys.length--,this._values.length--,ds(ae,this._cacheKey)&&(this._cacheKey=C,this._cacheIndex=-2),!0}return!1},qe.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=C,this._cacheIndex=-2},qe.prototype.keys=function(){return new j(this._keys,this._values,Ae)},qe.prototype.values=function(){return new j(this._keys,this._values,Yt)},qe.prototype.entries=function(){return new j(this._keys,this._values,gr)},qe.prototype["@@iterator"]=function(){return this.entries()},qe.prototype[s]=function(){return this.entries()},qe.prototype._find=function(ae,fe){if(!ds(this._cacheKey,ae)){this._cacheIndex=-1;for(var he=0;he<this._keys.length;he++)if(ds(this._keys[he],ae)){this._cacheIndex=he;break}}return this._cacheIndex<0&&fe&&(this._cacheIndex=this._keys.length,this._keys.push(ae),this._values.push(void 0)),this._cacheIndex},qe}();return te;function Ae(qe,ae){return qe}function Yt(qe,ae){return ae}function gr(qe,ae){return[qe,ae]}}function CF(){var C=function(){function L(){this._map=new h}return Object.defineProperty(L.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),L.prototype.has=function(j){return this._map.has(j)},L.prototype.add=function(j){return this._map.set(j,j),this},L.prototype.delete=function(j){return this._map.delete(j)},L.prototype.clear=function(){this._map.clear()},L.prototype.keys=function(){return this._map.keys()},L.prototype.values=function(){return this._map.keys()},L.prototype.entries=function(){return this._map.entries()},L.prototype["@@iterator"]=function(){return this.keys()},L.prototype[s]=function(){return this.keys()},L}();return C}function kF(){var C=16,L=u.create(),j=te();return function(){function ae(){this._key=te()}return ae.prototype.has=function(fe){var he=Ae(fe,!1);return he!==void 0?u.has(he,this._key):!1},ae.prototype.get=function(fe){var he=Ae(fe,!1);return he!==void 0?u.get(he,this._key):void 0},ae.prototype.set=function(fe,he){var we=Ae(fe,!0);return we[this._key]=he,this},ae.prototype.delete=function(fe){var he=Ae(fe,!1);return he!==void 0?delete he[this._key]:!1},ae.prototype.clear=function(){this._key=te()},ae}();function te(){var ae;do ae="@@WeakMap@@"+qe();while(u.has(L,ae));return L[ae]=!0,ae}function Ae(ae,fe){if(!n.call(ae,j)){if(!fe)return;Object.defineProperty(ae,j,{value:u.create()})}return ae[j]}function Yt(ae,fe){for(var he=0;he<fe;++he)ae[he]=Math.random()*255|0;return ae}function gr(ae){if(typeof Uint8Array=="function"){var fe=new Uint8Array(ae);return typeof crypto<"u"?crypto.getRandomValues(fe):typeof msCrypto<"u"?msCrypto.getRandomValues(fe):Yt(fe,ae),fe}return Yt(new Array(ae),ae)}function qe(){var ae=gr(C);ae[6]=ae[6]&79|64,ae[8]=ae[8]&191|128;for(var fe="",he=0;he<C;++he){var we=ae[he];(he===4||he===6||he===8)&&(fe+="-"),we<16&&(fe+="0"),fe+=we.toString(16).toLowerCase()}return fe}}function g8(C){return C.__=void 0,delete C.__,C}})})($D||($D={}))});var YN=ft((DBe,D4)=>{var PN,RN,DN,NN,ON,LN,BN,MN,UN,R4,dv,FN,$N,Ud,HN,VN,zN,KN,qN,jN,WN,GN,XN;(function(r){var e=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(n){r(t(e,t(n)))}):typeof D4=="object"&&typeof D4.exports=="object"?r(t(e,t(D4.exports))):r(t(e));function t(n,i){return n!==e&&(typeof Object.create=="function"?Object.defineProperty(n,"__esModule",{value:!0}):n.__esModule=!0),function(o,s){return n[o]=i?i(o,s):s}}})(function(r){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])};PN=function(t,n){e(t,n);function i(){this.constructor=t}t.prototype=n===null?Object.create(n):(i.prototype=n.prototype,new i)},RN=Object.assign||function(t){for(var n,i=1,o=arguments.length;i<o;i++){n=arguments[i];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},DN=function(t,n){var i={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&n.indexOf(o)<0&&(i[o]=t[o]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,o=Object.getOwnPropertySymbols(t);s<o.length;s++)n.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(t,o[s])&&(i[o[s]]=t[o[s]]);return i},NN=function(t,n,i,o){var s=arguments.length,a=s<3?n:o===null?o=Object.getOwnPropertyDescriptor(n,i):o,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(t,n,i,o);else for(var l=t.length-1;l>=0;l--)(c=t[l])&&(a=(s<3?c(a):s>3?c(n,i,a):c(n,i))||a);return s>3&&a&&Object.defineProperty(n,i,a),a},ON=function(t,n){return function(i,o){n(i,o,t)}},LN=function(t,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,n)},BN=function(t,n,i,o){function s(a){return a instanceof i?a:new i(function(c){c(a)})}return new(i||(i=Promise))(function(a,c){function l(h){try{f(o.next(h))}catch(d){c(d)}}function u(h){try{f(o.throw(h))}catch(d){c(d)}}function f(h){h.done?a(h.value):s(h.value).then(l,u)}f((o=o.apply(t,n||[])).next())})},MN=function(t,n){var i={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},o,s,a,c;return c={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(f){return function(h){return u([f,h])}}function u(f){if(o)throw new TypeError("Generator is already executing.");for(;i;)try{if(o=1,s&&(a=f[0]&2?s.return:f[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,f[1])).done)return a;switch(s=0,a&&(f=[f[0]&2,a.value]),f[0]){case 0:case 1:a=f;break;case 4:return i.label++,{value:f[1],done:!1};case 5:i.label++,s=f[1],f=[0];continue;case 7:f=i.ops.pop(),i.trys.pop();continue;default:if(a=i.trys,!(a=a.length>0&&a[a.length-1])&&(f[0]===6||f[0]===2)){i=0;continue}if(f[0]===3&&(!a||f[1]>a[0]&&f[1]<a[3])){i.label=f[1];break}if(f[0]===6&&i.label<a[1]){i.label=a[1],a=f;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(f);break}a[2]&&i.ops.pop(),i.trys.pop();continue}f=n.call(t,i)}catch(h){f=[6,h],s=0}finally{o=a=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},XN=function(t,n,i,o){o===void 0&&(o=i),t[o]=n[i]},UN=function(t,n){for(var i in t)i!=="default"&&!n.hasOwnProperty(i)&&(n[i]=t[i])},R4=function(t){var n=typeof Symbol=="function"&&Symbol.iterator,i=n&&t[n],o=0;if(i)return i.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},dv=function(t,n){var i=typeof Symbol=="function"&&t[Symbol.iterator];if(!i)return t;var o=i.call(t),s,a=[],c;try{for(;(n===void 0||n-- >0)&&!(s=o.next()).done;)a.push(s.value)}catch(l){c={error:l}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(c)throw c.error}}return a},FN=function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(dv(arguments[n]));return t},$N=function(){for(var t=0,n=0,i=arguments.length;n<i;n++)t+=arguments[n].length;for(var o=Array(t),s=0,n=0;n<i;n++)for(var a=arguments[n],c=0,l=a.length;c<l;c++,s++)o[s]=a[c];return o},Ud=function(t){return this instanceof Ud?(this.v=t,this):new Ud(t)},HN=function(t,n,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o=i.apply(t,n||[]),s,a=[];return s={},c("next"),c("throw"),c("return"),s[Symbol.asyncIterator]=function(){return this},s;function c(m){o[m]&&(s[m]=function(g){return new Promise(function(w,x){a.push([m,g,w,x])>1||l(m,g)})})}function l(m,g){try{u(o[m](g))}catch(w){d(a[0][3],w)}}function u(m){m.value instanceof Ud?Promise.resolve(m.value.v).then(f,h):d(a[0][2],m)}function f(m){l("next",m)}function h(m){l("throw",m)}function d(m,g){m(g),a.shift(),a.length&&l(a[0][0],a[0][1])}},VN=function(t){var n,i;return n={},o("next"),o("throw",function(s){throw s}),o("return"),n[Symbol.iterator]=function(){return this},n;function o(s,a){n[s]=t[s]?function(c){return(i=!i)?{value:Ud(t[s](c)),done:s==="return"}:a?a(c):c}:a}},zN=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t[Symbol.asyncIterator],i;return n?n.call(t):(t=typeof R4=="function"?R4(t):t[Symbol.iterator](),i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i);function o(a){i[a]=t[a]&&function(c){return new Promise(function(l,u){c=t[a](c),s(l,u,c.done,c.value)})}}function s(a,c,l,u){Promise.resolve(u).then(function(f){a({value:f,done:l})},c)}},KN=function(t,n){return Object.defineProperty?Object.defineProperty(t,"raw",{value:n}):t.raw=n,t},qN=function(t){if(t&&t.__esModule)return t;var n={};if(t!=null)for(var i in t)Object.hasOwnProperty.call(t,i)&&(n[i]=t[i]);return n.default=t,n},jN=function(t){return t&&t.__esModule?t:{default:t}},WN=function(t,n){if(!n.has(t))throw new TypeError("attempted to get private field on non-instance");return n.get(t)},GN=function(t,n,i){if(!n.has(t))throw new TypeError("attempted to set private field on non-instance");return n.set(t,i),i},r("__extends",PN),r("__assign",RN),r("__rest",DN),r("__decorate",NN),r("__param",ON),r("__metadata",LN),r("__awaiter",BN),r("__generator",MN),r("__exportStar",UN),r("__createBinding",XN),r("__values",R4),r("__read",dv),r("__spread",FN),r("__spreadArrays",$N),r("__await",Ud),r("__asyncGenerator",HN),r("__asyncDelegator",VN),r("__asyncValues",zN),r("__makeTemplateObject",KN),r("__importStar",qN),r("__importDefault",jN),r("__classPrivateFieldGet",WN),r("__classPrivateFieldSet",GN)})});var CL=ft(l6=>{"use strict";Object.defineProperty(l6,"__esModule",{value:!0});var rE=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},c6=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let i=new rE;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:o=>i.push(o),stop:()=>i.stop(),fail:o=>i.fail(o),on:(o,s)=>{i.eventHandlers[o]=s}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};l6.EventIterator=c6;l6.default=c6});var kL=ft(pm=>{"use strict";Object.defineProperty(pm,"__esModule",{value:!0});var nE=CL();pm.EventIterator=nE.EventIterator;function vY(r,e,t){return new nE.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}pm.subscribe=vY;pm.default=nE.EventIterator});var wB=ft((Lje,yB)=>{function ji(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}yB.exports=ji;ji.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};ji.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};ji.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};ji.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};ji.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};ji.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};ji.prototype.start=ji.prototype.try;ji.prototype.errors=function(){return this._errors};ji.prototype.attempts=function(){return this._attempts};ji.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],o=i.message,s=(r[o]||0)+1;r[o]=s,s>=t&&(e=i,t=s)}return e}});var xB=ft(Cu=>{var sQ=wB();Cu.operation=function(r){var e=Cu.timeouts(r);return new sQ(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};Cu.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<e.retries;i++)n.push(this.createTimeout(i,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(i,e)),n.sort(function(o,s){return o-s}),n};Cu.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};Cu.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var i=0;i<t.length;i++){var o=t[i],s=r[o];r[o]=function(c){var l=Cu.operation(e),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(h){l.retry(h)||(h&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,s),r[o].options=e}}});var vB=ft((Mje,bB)=>{bB.exports=xB()});var zB=ft((RXe,VB)=>{VB.exports=NE;var HB=128,kQ=127,PQ=~kQ,RQ=Math.pow(2,31);function NE(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw NE.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=RQ;)e[t++]=r&255|HB,r/=128;for(;r&PQ;)e[t++]=r&255|HB,r>>>=7;return e[t]=r|0,NE.bytes=t-n+1,e}});var jB=ft((DXe,qB)=>{qB.exports=OE;var DQ=128,KB=127;function OE(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a||i>49)throw OE.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&KB)<<i:(s&KB)*Math.pow(2,i),i+=7}while(s>=DQ);return OE.bytes=o-n,t}});var GB=ft((NXe,WB)=>{var NQ=Math.pow(2,7),OQ=Math.pow(2,14),LQ=Math.pow(2,21),BQ=Math.pow(2,28),MQ=Math.pow(2,35),UQ=Math.pow(2,42),FQ=Math.pow(2,49),$Q=Math.pow(2,56),HQ=Math.pow(2,63);WB.exports=function(r){return r<NQ?1:r<OQ?2:r<LQ?3:r<BQ?4:r<MQ?5:r<UQ?6:r<FQ?7:r<$Q?8:r<HQ?9:10}});var f5=ft((OXe,XB)=>{XB.exports={encode:zB(),decode:jB(),encodingLength:GB()}});var mM=ft((Nm,_5)=>{(function(r,e){"use strict";var t={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function n(d){if(!Array.isArray(d)&&!ArrayBuffer.isView(d))return!1;for(var m=0;m<d.length;m++)if(!Number.isInteger(d[m])||d[m]<0||d[m]>255)return!1;return!0}function i(d,m){return(d&65535)*m+(((d>>>16)*m&65535)<<16)}function o(d,m){return d<<m|d>>>32-m}function s(d){return d^=d>>>16,d=i(d,2246822507),d^=d>>>13,d=i(d,3266489909),d^=d>>>16,d}function a(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var g=[0,0,0,0];return g[3]+=d[3]+m[3],g[2]+=g[3]>>>16,g[3]&=65535,g[2]+=d[2]+m[2],g[1]+=g[2]>>>16,g[2]&=65535,g[1]+=d[1]+m[1],g[0]+=g[1]>>>16,g[1]&=65535,g[0]+=d[0]+m[0],g[0]&=65535,[g[0]<<16|g[1],g[2]<<16|g[3]]}function c(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var g=[0,0,0,0];return g[3]+=d[3]*m[3],g[2]+=g[3]>>>16,g[3]&=65535,g[2]+=d[2]*m[3],g[1]+=g[2]>>>16,g[2]&=65535,g[2]+=d[3]*m[2],g[1]+=g[2]>>>16,g[2]&=65535,g[1]+=d[1]*m[3],g[0]+=g[1]>>>16,g[1]&=65535,g[1]+=d[2]*m[2],g[0]+=g[1]>>>16,g[1]&=65535,g[1]+=d[3]*m[1],g[0]+=g[1]>>>16,g[1]&=65535,g[0]+=d[0]*m[3]+d[1]*m[2]+d[2]*m[1]+d[3]*m[0],g[0]&=65535,[g[0]<<16|g[1],g[2]<<16|g[3]]}function l(d,m){return m%=64,m===32?[d[1],d[0]]:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m|d[0]>>>32-m]:(m-=32,[d[1]<<m|d[0]>>>32-m,d[0]<<m|d[1]>>>32-m])}function u(d,m){return m%=64,m===0?d:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m]:[d[1]<<m-32,0]}function f(d,m){return[d[0]^m[0],d[1]^m[1]]}function h(d){return d=f(d,[0,d[0]>>>1]),d=c(d,[4283543511,3981806797]),d=f(d,[0,d[0]>>>1]),d=c(d,[3301882366,444984403]),d=f(d,[0,d[0]>>>1]),d}t.x86.hash32=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%4,w=d.length-g,x=m,v=0,b=3432918353,S=461845907,T=0;T<w;T=T+4)v=d[T]|d[T+1]<<8|d[T+2]<<16|d[T+3]<<24,v=i(v,b),v=o(v,15),v=i(v,S),x^=v,x=o(x,13),x=i(x,5)+3864292196;switch(v=0,g){case 3:v^=d[T+2]<<16;case 2:v^=d[T+1]<<8;case 1:v^=d[T],v=i(v,b),v=o(v,15),v=i(v,S),x^=v}return x^=d.length,x=s(x),x>>>0},t.x86.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%16,w=d.length-g,x=m,v=m,b=m,S=m,T=0,D=0,A=0,I=0,k=597399067,Q=2869860233,K=951274213,V=2716044179,X=0;X<w;X=X+16)T=d[X]|d[X+1]<<8|d[X+2]<<16|d[X+3]<<24,D=d[X+4]|d[X+5]<<8|d[X+6]<<16|d[X+7]<<24,A=d[X+8]|d[X+9]<<8|d[X+10]<<16|d[X+11]<<24,I=d[X+12]|d[X+13]<<8|d[X+14]<<16|d[X+15]<<24,T=i(T,k),T=o(T,15),T=i(T,Q),x^=T,x=o(x,19),x+=v,x=i(x,5)+1444728091,D=i(D,Q),D=o(D,16),D=i(D,K),v^=D,v=o(v,17),v+=b,v=i(v,5)+197830471,A=i(A,K),A=o(A,17),A=i(A,V),b^=A,b=o(b,15),b+=S,b=i(b,5)+2530024501,I=i(I,V),I=o(I,18),I=i(I,k),S^=I,S=o(S,13),S+=x,S=i(S,5)+850148119;switch(T=0,D=0,A=0,I=0,g){case 15:I^=d[X+14]<<16;case 14:I^=d[X+13]<<8;case 13:I^=d[X+12],I=i(I,V),I=o(I,18),I=i(I,k),S^=I;case 12:A^=d[X+11]<<24;case 11:A^=d[X+10]<<16;case 10:A^=d[X+9]<<8;case 9:A^=d[X+8],A=i(A,K),A=o(A,17),A=i(A,V),b^=A;case 8:D^=d[X+7]<<24;case 7:D^=d[X+6]<<16;case 6:D^=d[X+5]<<8;case 5:D^=d[X+4],D=i(D,Q),D=o(D,16),D=i(D,K),v^=D;case 4:T^=d[X+3]<<24;case 3:T^=d[X+2]<<16;case 2:T^=d[X+1]<<8;case 1:T^=d[X],T=i(T,k),T=o(T,15),T=i(T,Q),x^=T}return x^=d.length,v^=d.length,b^=d.length,S^=d.length,x+=v,x+=b,x+=S,v+=x,b+=x,S+=x,x=s(x),v=s(v),b=s(b),S=s(S),x+=v,x+=b,x+=S,v+=x,b+=x,S+=x,("00000000"+(x>>>0).toString(16)).slice(-8)+("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)},t.x64.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%16,w=d.length-g,x=[0,m],v=[0,m],b=[0,0],S=[0,0],T=[2277735313,289559509],D=[1291169091,658871167],A=0;A<w;A=A+16)b=[d[A+4]|d[A+5]<<8|d[A+6]<<16|d[A+7]<<24,d[A]|d[A+1]<<8|d[A+2]<<16|d[A+3]<<24],S=[d[A+12]|d[A+13]<<8|d[A+14]<<16|d[A+15]<<24,d[A+8]|d[A+9]<<8|d[A+10]<<16|d[A+11]<<24],b=c(b,T),b=l(b,31),b=c(b,D),x=f(x,b),x=l(x,27),x=a(x,v),x=a(c(x,[0,5]),[0,1390208809]),S=c(S,D),S=l(S,33),S=c(S,T),v=f(v,S),v=l(v,31),v=a(v,x),v=a(c(v,[0,5]),[0,944331445]);switch(b=[0,0],S=[0,0],g){case 15:S=f(S,u([0,d[A+14]],48));case 14:S=f(S,u([0,d[A+13]],40));case 13:S=f(S,u([0,d[A+12]],32));case 12:S=f(S,u([0,d[A+11]],24));case 11:S=f(S,u([0,d[A+10]],16));case 10:S=f(S,u([0,d[A+9]],8));case 9:S=f(S,[0,d[A+8]]),S=c(S,D),S=l(S,33),S=c(S,T),v=f(v,S);case 8:b=f(b,u([0,d[A+7]],56));case 7:b=f(b,u([0,d[A+6]],48));case 6:b=f(b,u([0,d[A+5]],40));case 5:b=f(b,u([0,d[A+4]],32));case 4:b=f(b,u([0,d[A+3]],24));case 3:b=f(b,u([0,d[A+2]],16));case 2:b=f(b,u([0,d[A+1]],8));case 1:b=f(b,[0,d[A]]),b=c(b,T),b=l(b,31),b=c(b,D),x=f(x,b)}return x=f(x,[0,d.length]),v=f(v,[0,d.length]),x=a(x,v),v=a(v,x),x=h(x),v=h(v),x=a(x,v),v=a(v,x),("00000000"+(x[0]>>>0).toString(16)).slice(-8)+("00000000"+(x[1]>>>0).toString(16)).slice(-8)+("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)},typeof Nm<"u"?(typeof _5<"u"&&_5.exports&&(Nm=_5.exports=t),Nm.murmurHash3=t):typeof define=="function"&&define.amd?define([],function(){return t}):(t._murmurHash3=r.murmurHash3,t.noConflict=function(){return r.murmurHash3=t._murmurHash3,t._murmurHash3=e,t.noConflict=e,t},r.murmurHash3=t)})(Nm)});var yM=ft((DQe,gM)=>{gM.exports=mM()});var T5=ft((FQe,xM)=>{"use strict";xM.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let i=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):i=!0,this._setInternalPos(n,e,t,i),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();let t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){let e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,i=t;for(;n<this.length;){let o=this.get(n);i=e(i,o,n),n++}return i}find(e){let t=0,n,i;for(;t<this.length&&!n;)i=this.get(t),n=e(i),t++;return n?i:void 0}_internalPositionFor(e,t){let n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;let i=this._bitArrays[n],o=e-n*7;if(!((i&1<<o)>0))return-1;let a=this._bitArrays.slice(0,n).reduce(hZ,0),c=~(4294967295<<o+1),l=wM(i&c);return a+l-1}_bytePosFor(e,t){let n=Math.floor(e/7),i=n+1;for(;!t&&this._bitArrays.length<i;)this._bitArrays.push(0);return n}_setBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*7}_unsetBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*7)}_setInternalPos(e,t,n,i){let o=this._data,s=[t,n];if(i)this._sortData(),o[e]=s;else{if(o.length)if(o[o.length-1][0]>=t)o.push(s);else if(o[0][0]<=t)o.unshift(s);else{let a=Math.round(o.length/2);this._data=o.slice(0,a).concat(s).concat(o.slice(a))}else this._data.push(s);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(pZ),this._changedData=!1}bitField(){let e=[],t=8,n=0,i=0,o,s=this._bitArrays.slice();for(;s.length||n;){n===0&&(o=s.shift(),n=7);let c=Math.min(n,t),l=~(255<<c),u=o&l;i|=u<<8-t,o=o>>>c,n-=c,t-=c,(!t||!n&&!s.length)&&(e.push(i),i=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(mZ)}};function hZ(r,e){return r+wM(e)}function wM(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function pZ(r,e){return r[0]-e[0]}function mZ(r){return r[1]}});var xU=ft(JE=>{JE.read=function(r,e,t,n,i){var o,s,a=i*8-n-1,c=(1<<a)-1,l=c>>1,u=-7,f=t?i-1:0,h=t?-1:1,d=r[e+f];for(f+=h,o=d&(1<<-u)-1,d>>=-u,u+=a;u>0;o=o*256+r[e+f],f+=h,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=n;u>0;s=s*256+r[e+f],f+=h,u-=8);if(o===0)o=1-l;else{if(o===c)return s?NaN:(d?-1:1)*(1/0);s=s+Math.pow(2,n),o=o-l}return(d?-1:1)*s*Math.pow(2,o-n)};JE.write=function(r,e,t,n,i,o){var s,a,c,l=o*8-i-1,u=(1<<l)-1,f=u>>1,h=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,m=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=u):(s=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-s))<1&&(s--,c*=2),s+f>=1?e+=h/c:e+=h*Math.pow(2,1-f),e*c>=2&&(s++,c/=2),s+f>=u?(a=0,s=u):s+f>=1?(a=(e*c-1)*Math.pow(2,i),s=s+f):(a=e*Math.pow(2,f-1)*Math.pow(2,i),s=0));i>=8;r[t+d]=a&255,d+=m,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;r[t+d]=s&255,d+=m,s/=256,l-=8);r[t+d-m]|=g*128}});var BU=ft((tit,LU)=>{var dh=1e3,hh=dh*60,ph=hh*60,Fu=ph*24,see=Fu*7,aee=Fu*365.25;LU.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return cee(r);if(t==="number"&&isFinite(r))return e.long?uee(r):lee(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function cee(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*aee;case"weeks":case"week":case"w":return t*see;case"days":case"day":case"d":return t*Fu;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ph;case"minutes":case"minute":case"mins":case"min":case"m":return t*hh;case"seconds":case"second":case"secs":case"sec":case"s":return t*dh;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function lee(r){var e=Math.abs(r);return e>=Fu?Math.round(r/Fu)+"d":e>=ph?Math.round(r/ph)+"h":e>=hh?Math.round(r/hh)+"m":e>=dh?Math.round(r/dh)+"s":r+"ms"}function uee(r){var e=Math.abs(r);return e>=Fu?Y5(r,e,Fu,"day"):e>=ph?Y5(r,e,ph,"hour"):e>=hh?Y5(r,e,hh,"minute"):e>=dh?Y5(r,e,dh,"second"):r+" ms"}function Y5(r,e,t,n){var i=e>=t*1.5;return Math.round(r/t)+" "+n+(i?"s":"")}});var UU=ft((rit,MU)=>{function fee(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=a,t.humanize=BU(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,m;function g(...w){if(!g.enabled)return;let x=g,v=Number(new Date),b=v-(f||v);x.diff=b,x.prev=f,x.curr=v,f=v,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let S=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(D,A)=>{if(D==="%%")return"%";S++;let I=t.formatters[A];if(typeof I=="function"){let k=w[S];D=I.call(x,k),w.splice(S,1),S--}return D}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(u)),m),set:w=>{h=w}}),typeof t.init=="function"&&t.init(g),g}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f=(typeof u=="string"?u:"").trim().replace(" ",",").split(",").filter(Boolean);for(let h of f)h[0]==="-"?t.skips.push(h.slice(1)):t.names.push(h)}function o(u,f){let h=0,d=0,m=-1,g=0;for(;h<u.length;)if(d<f.length&&(f[d]===u[h]||f[d]==="*"))f[d]==="*"?(m=d,g=h,d++):(h++,d++);else if(m!==-1)d=m+1,g++,h=g;else return!1;for(;d<f.length&&f[d]==="*";)d++;return d===f.length}function s(){let u=[...t.names,...t.skips.map(f=>"-"+f)].join(",");return t.enable(""),u}function a(u){for(let f of t.skips)if(o(u,f))return!1;for(let f of t.names)if(o(u,f))return!0;return!1}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}MU.exports=fee});var FU=ft((bi,Q5)=>{bi.formatArgs=hee;bi.save=pee;bi.load=mee;bi.useColors=dee;bi.storage=gee();bi.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();bi.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function dee(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function hee(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Q5.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}bi.log=console.debug||console.log||(()=>{});function pee(r){try{r?bi.storage.setItem("debug",r):bi.storage.removeItem("debug")}catch{}}function mee(){let r;try{r=bi.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function gee(){try{return localStorage}catch{}}Q5.exports=UU()(bi);var{formatters:yee}=Q5.exports;yee.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var rF=ft((Uot,tF)=>{"use strict";tF.exports={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,EXTENSIONLESS_FORMAT_JAVASCRIPT:0,EXTENSIONLESS_FORMAT_WASM:1,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:805306608,SSL_OP_ALL:2147485776,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,RSA_PKCS1_PADDING:1,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}});var Rte={};Ft(Rte,{BasePlugin:()=>Mt,DirIndexHtmlPlugin:()=>Gm,PluginError:()=>Km,PluginFatalError:()=>na,createVerifiedFetch:()=>gS,dirIndexHtmlPluginFactory:()=>EF,verifiedFetch:()=>p8});var xS=Symbol.for("@libp2p/connection");var Ro=Symbol.for("@libp2p/content-routing");function bS(r){return r==null?!1:(r.type==="RSA"||r.type==="Ed25519"||r.type==="secp256k1"||r.type==="ECDSA")&&r.raw instanceof Uint8Array&&typeof r.equals=="function"&&typeof r.toMultihash=="function"&&typeof r.toCID=="function"&&typeof r.verify=="function"}var Ic=Symbol.for("@libp2p/peer-discovery");var e0=Symbol.for("@libp2p/peer-id");function t0(r){return!!r?.[e0]}var Do=Symbol.for("@libp2p/peer-routing");var ia="keep-alive";var oa=Symbol.for("@libp2p/transport");var Tc;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Tc||(Tc={}));var Cr=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},r0=class extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}},n0=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},U=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},hs=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},wh=class extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}};var i0=class extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}},Hu=class extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}},Vu=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},No=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},o0=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},Cc=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},We=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}},zu=class extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}},sa=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},s0=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},aa=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},ps=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}},Be=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},a0=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Oo=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},Zn=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var ms=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},kc=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}},Ku=class extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}},c0=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}},ca=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},Xi=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var Me=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:o})=>o!==t),this.#e.set(e,i))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:i})=>!i),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};function l0(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function kr(...r){let e=[];for(let t of r)l0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Gr(...r){let e=[];for(let t of r)l0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var tt=Symbol.for("@libp2p/service-capabilities"),Jn=Symbol.for("@libp2p/service-dependencies");function Ne(r){let e=new globalThis.AbortController;function t(){e.abort();for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(let o of r){if(o?.aborted===!0){t();break}o?.addEventListener!=null&&o.addEventListener("abort",t)}function n(){for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}let i=e.signal;return i.clear=n,i}function ye(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var u0=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},qu=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new u0(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new u0(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var y8=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Xr(r={}){return UF(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function UF(r,e){e=e??{};let t=e.onEnd,n=new qu,i,o,s,a=ye(),c=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((w,x)=>{o=v=>{o=null,n.push(v);try{w(r(n))}catch(b){x(b)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ye()})}},l=w=>o!=null?o(w):(n.push(w),i),u=w=>(n=new qu,o!=null?o({error:w}):(n.push({error:w}),i)),f=w=>{if(s)return i;if(e?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},h=w=>s?i:(s=!0,w!=null?u(w):l({done:!0})),d=()=>(n=new qu,h(),{done:!0}),m=w=>(h(w),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:d,throw:m,push:f,end:h,get readableLength(){return n.size},onEmpty:async w=>{let x=w?.signal;if(x?.throwIfAborted(),n.isEmpty())return;let v,b;x!=null&&(v=new Promise((S,T)=>{b=()=>{T(new y8)},x.addEventListener("abort",b)}));try{await Promise.race([a.promise,v])}finally{b!=null&&x!=null&&x?.removeEventListener("abort",b)}}},t==null)return i;let g=i;return i={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(w){return g.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(w){return g.end(w),t!=null&&(t(w),t=void 0),i},get readableLength(){return g.readableLength},onEmpty:w=>g.onEmpty(w)},i}var w8=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function Er(r,e,t,n){let i=new w8(n?.errorMessage,n?.errorCode);return t?.aborted===!0?Promise.reject(i):new Promise((o,s)=>{function a(){t?.removeEventListener("abort",u),r.removeEventListener(e,c),n?.errorEvent!=null&&r.removeEventListener(n.errorEvent,l)}let c=f=>{try{if(n?.filter?.(f)===!1)return}catch(h){a(),s(h);return}a(),o(f)},l=f=>{a(),s(f.detail)},u=()=>{a(),s(i)};t?.addEventListener("abort",u),r.addEventListener(e,c),n?.errorEvent!=null&&r.addEventListener(n.errorEvent,l)})}var f0=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}},d0=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var h0=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function Dt(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new h0(t?.errorMessage,t?.errorCode,t?.errorName));let n,i=new h0(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((o,s)=>{n=()=>{s(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var p0=class{deferred;signal;constructor(e){this.signal=e,this.deferred=ye(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Cr)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function FF(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var m0=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=FF(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Cr),this.cleanup())}async join(e={}){let t=new p0(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await Dt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var ln=class extends Me{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new d0;let n=new m0(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:n,result:i}}),i)).catch(i=>{if(n.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===n){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("error",{detail:i}),this.safeDispatchEvent("failure",{detail:{job:n,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Cr)}),this.clear()}async onEmpty(e){this.size!==0&&await Er(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Er(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Er(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=Xr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail)},o=c=>{n(c.detail)},s=()=>{n()},a=()=>{n(new Cr("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var Pr=class extends ln{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};function $F(r){return r[Symbol.asyncIterator]!=null}function HF(r){if($F(r))return(async()=>{for await(let e of r);})();for(let e of r);}var Sr=HF;function Pe(r=0){return new Uint8Array(r)}function $t(r=0){return new Uint8Array(r)}var VF=Math.pow(2,7),zF=Math.pow(2,14),KF=Math.pow(2,21),x8=Math.pow(2,28),b8=Math.pow(2,35),v8=Math.pow(2,42),E8=Math.pow(2,49),dt=128,Yr=127;function Oe(r){if(r<VF)return 1;if(r<zF)return 2;if(r<KF)return 3;if(r<x8)return 4;if(r<b8)return 5;if(r<v8)return 6;if(r<E8)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function S8(r,e,t=0){switch(Oe(r)){case 8:e[t++]=r&255|dt,r/=128;case 7:e[t++]=r&255|dt,r/=128;case 6:e[t++]=r&255|dt,r/=128;case 5:e[t++]=r&255|dt,r/=128;case 4:e[t++]=r&255|dt,r>>>=7;case 3:e[t++]=r&255|dt,r>>>=7;case 2:e[t++]=r&255|dt,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function qF(r,e,t=0){switch(Oe(r)){case 8:e.set(t++,r&255|dt),r/=128;case 7:e.set(t++,r&255|dt),r/=128;case 6:e.set(t++,r&255|dt),r/=128;case 5:e.set(t++,r&255|dt),r/=128;case 4:e.set(t++,r&255|dt),r>>>=7;case 3:e.set(t++,r&255|dt),r>>>=7;case 2:e.set(t++,r&255|dt),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function A8(r,e){let t=r[e],n=0;if(n+=t&Yr,t<dt||(t=r[e+1],n+=(t&Yr)<<7,t<dt)||(t=r[e+2],n+=(t&Yr)<<14,t<dt)||(t=r[e+3],n+=(t&Yr)<<21,t<dt)||(t=r[e+4],n+=(t&Yr)*x8,t<dt)||(t=r[e+5],n+=(t&Yr)*b8,t<dt)||(t=r[e+6],n+=(t&Yr)*v8,t<dt)||(t=r[e+7],n+=(t&Yr)*E8,t<dt))return n;throw new RangeError("Could not decode varint")}function jF(r,e){let t=r.get(e),n=0;if(n+=t&Yr,t<dt||(t=r.get(e+1),n+=(t&Yr)<<7,t<dt)||(t=r.get(e+2),n+=(t&Yr)<<14,t<dt)||(t=r.get(e+3),n+=(t&Yr)<<21,t<dt)||(t=r.get(e+4),n+=(t&Yr)*x8,t<dt)||(t=r.get(e+5),n+=(t&Yr)*b8,t<dt)||(t=r.get(e+6),n+=(t&Yr)*v8,t<dt)||(t=r.get(e+7),n+=(t&Yr)*E8,t<dt))return n;throw new RangeError("Could not decode varint")}function ht(r,e,t=0){return e==null&&(e=$t(Oe(r))),e instanceof Uint8Array?S8(r,e,t):qF(r,e,t)}function Zt(r,e=0){return r instanceof Uint8Array?A8(r,e):jF(r,e)}function Ve(r,e){e==null&&(e=r.reduce((i,o)=>i+o.length,0));let t=$t(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}function pe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var ES=Symbol.for("@achingbrain/uint8arraylist");function vS(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function vi(r){return!!r?.[ES]}var oe=class r{bufs;length;[ES]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(vi(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(vi(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=vS(this.bufs,e);return t.buf[t.index]}set(e,t){let n=vS(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(vi(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:i}=this._subList(e,t);return Ve(n,i)}subarray(e,t){let{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:Ve(n,i)}sublist(e,t){let{bufs:n,length:i}=this._subList(e,t),o=new r;return o.length=i,o.bufs=[...n],o}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],i=0;for(let o=0;o<this.bufs.length;o++){let s=this.bufs[o],a=i,c=a+s.byteLength;if(i=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(s);break}let f=e-a;n.push(s.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(s);continue}n.push(s.subarray(e-a));continue}if(u){if(t===c){n.push(s);break}n.push(s.subarray(0,t-a));break}n.push(s)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!vi(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");let o=256,s=new Int32Array(o);for(let f=0;f<o;f++)s[f]=-1;for(let f=0;f<i;f++)s[n[f]]=f;let a=s,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=$t(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let i=Pe(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let i=Pe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let i=Pe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=$t(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let i=Pe(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let i=Pe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let i=Pe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let i=Pe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let i=Pe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((i,o)=>i+o.byteLength,0)),n.length=t,n}};var g0=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ju=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},y0=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},xh=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function w0(r){return r[Symbol.asyncIterator]!=null}function SS(r,e){if(r.byteLength>e)throw new ju("Message length too long")}var b0=r=>{let e=Oe(r),t=$t(e);return ht(r,t),b0.bytes=e,t};b0.bytes=0;function Yi(r,e){e=e??{};let t=e.lengthEncoder??b0,n=e?.maxDataLength??4194304;function*i(o){SS(o,n);let s=t(o.byteLength);s instanceof Uint8Array?yield s:yield*s,o instanceof Uint8Array?yield o:yield*o}return w0(r)?async function*(){for await(let o of r)yield*i(o)}():function*(){for(let o of r)yield*i(o)}()}Yi.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??b0,n=e?.maxDataLength??4194304;return SS(r,n),new oe(t(r.byteLength),r)};var Pc;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Pc||(Pc={}));var _8=r=>{let e=Zt(r);return _8.bytes=Oe(e),e};_8.bytes=0;function Qi(r,e){let t=new oe,n=Pc.LENGTH,i=-1,o=e?.lengthDecoder??_8,s=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===Pc.LENGTH)try{if(i=o(t),i<0)throw new g0("Invalid message length");if(i>a)throw new ju("Message length too long");let l=o.bytes;t.consume(l),e?.onLength!=null&&e.onLength(i),n=Pc.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>s)throw new y0("Message length length too long");break}throw l}if(n===Pc.DATA){if(t.byteLength<i)break;let l=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(l),yield l,n=Pc.LENGTH}}}return w0(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new xh("Unexpected end of input")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new xh("Unexpected end of input")}()}Qi.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:o,value:s}=await r.next(t);if(o===!0)return;s!=null&&(yield s)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{t=1}}();return Qi(n,{...e??{},onLength:o=>{t=o}})};function XF(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Wu=XF;function YF(r){return r[Symbol.asyncIterator]!=null}function QF(r,e){let t=0;if(YF(r))return async function*(){for await(let c of r)yield e(c,t++)}();let n=Wu(r),{value:i,done:o}=n.next();if(o===!0)return function*(){}();let s=e(i,t++);if(typeof s.then=="function")return async function*(){yield await s;for await(let c of n)yield e(c,t++)}();let a=e;return function*(){yield s;for(let c of n)yield a(c,t++)}()}var Nt=QF;var T8=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=ye(),this.haveNext=ye()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ye(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ye(),await Dt(this.readNext.promise,t?.signal,t)}};function v0(){return new T8}function ZF(r){return r[Symbol.asyncIterator]!=null}async function JF(r,e){try{await Promise.all(r.map(async t=>{for await(let n of t)await e.push(n)})),await e.end()}catch(t){await e.end(t).catch(()=>{})}}async function*e$(r){let e=v0();JF(r,e).catch(()=>{}),yield*e}function*t$(r){for(let e of r)yield*e}function r$(...r){let e=[];for(let t of r)ZF(t)||e.push(t);return e.length===r.length?t$(e):e$(r)}var un=r$;function ot(r,...e){if(r==null)throw new Error("Empty pipeline");if(C8(r)){let n=r;r=()=>n.source}else if(_S(r)||AS(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&C8(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)C8(t[n])&&(t[n]=i$(t[n]));return n$(...t)}var n$=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},AS=r=>r?.[Symbol.asyncIterator]!=null,_S=r=>r?.[Symbol.iterator]!=null,C8=r=>r==null?!1:r.sink!=null&&r.source!=null,i$=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=Xr({objectMode:!0});t.then(()=>{n.end()},s=>{n.end(s)});let i,o=r.source;if(AS(o))i=async function*(){yield*o,n.end()};else if(_S(o))i=function*(){yield*o,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return un(n,i())}return r.source};function o$(r){return r[Symbol.asyncIterator]!=null}function s$(r,e){return o$(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var la=s$;var G=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var bh="/ipfs/bitswap/1.2.0";var k8=new Float32Array([-0]),ua=new Uint8Array(k8.buffer);function IS(r,e,t){k8[0]=r,e[t]=ua[0],e[t+1]=ua[1],e[t+2]=ua[2],e[t+3]=ua[3]}function TS(r,e){return ua[0]=r[e],ua[1]=r[e+1],ua[2]=r[e+2],ua[3]=r[e+3],k8[0]}var P8=new Float64Array([-0]),Qr=new Uint8Array(P8.buffer);function CS(r,e,t){P8[0]=r,e[t]=Qr[0],e[t+1]=Qr[1],e[t+2]=Qr[2],e[t+3]=Qr[3],e[t+4]=Qr[4],e[t+5]=Qr[5],e[t+6]=Qr[6],e[t+7]=Qr[7]}function kS(r,e){return Qr[0]=r[e],Qr[1]=r[e+1],Qr[2]=r[e+2],Qr[3]=r[e+3],Qr[4]=r[e+4],Qr[5]=r[e+5],Qr[6]=r[e+6],Qr[7]=r[e+7],P8[0]}var a$=BigInt(Number.MAX_SAFE_INTEGER),c$=BigInt(Number.MIN_SAFE_INTEGER),ti=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Rc;if(e<a$&&e>c$)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>PS&&(i=0n,++n>PS&&(n=0n))),new r(Number(i),Number(n))}static fromNumber(e){if(e===0)return Rc;let t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new r(n,i)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Rc}},Rc=new ti(0,0);Rc.toBigInt=function(){return 0n};Rc.zzEncode=Rc.zzDecode=function(){return this};Rc.length=function(){return 1};var PS=4294967296n;function RS(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function DS(r,e,t){if(t-e<1)return"";let i,o=[],s=0,a;for(;e<t;)a=r[e++],a<128?o[s++]=a:a>191&&a<224?o[s++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[s++]=55296+(a>>10),o[s++]=56320+(a&1023)):o[s++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,s>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i!=null?(s>0&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))}function R8(r,e,t){let n=t,i,o;for(let s=0;s<r.length;++s)i=r.charCodeAt(s),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((o=r.charCodeAt(s+1))&64512)===56320?(i=65536+((i&1023)<<10)+(o&1023),++s,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function Zi(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function E0(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var D8=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Zi(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Zi(this,4);return E0(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Zi(this,4);return E0(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Zi(this,4);let e=TS(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Zi(this,4);let e=kS(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Zi(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return DS(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Zi(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Zi(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new ti(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Zi(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Zi(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Zi(this,8);let e=E0(this.buf,this.pos+=4),t=E0(this.buf,this.pos+=4);return new ti(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=A8(this.buf,this.pos);return this.pos+=Oe(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function N8(r){return new D8(r instanceof Uint8Array?r:r.subarray())}function be(r,e,t){let n=N8(r);return e.decode(n,void 0,t)}var H8={};Ft(H8,{base10:()=>y$});var Dc={};Ft(Dc,{coerce:()=>Ei,empty:()=>OS,equals:()=>O8,fromHex:()=>u$,fromString:()=>L8,isBinary:()=>f$,toHex:()=>l$,toString:()=>B8});var OS=new Uint8Array(0);function l$(r){return r.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")}function u$(r){let e=r.match(/../g);return e!=null?new Uint8Array(e.map(t=>parseInt(t,16))):OS}function O8(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Ei(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function f$(r){return r instanceof ArrayBuffer||ArrayBuffer.isView(r)}function L8(r){return new TextEncoder().encode(r)}function B8(r){return new TextDecoder().decode(r)}function d$(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var o=r.charAt(i),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var g=0,w=0,x=0,v=m.length;x!==v&&m[x]===0;)x++,g++;for(var b=(v-x)*u+1>>>0,S=new Uint8Array(b);x!==v;){for(var T=m[x],D=0,A=b-1;(T!==0||D<w)&&A!==-1;A--,D++)T+=256*S[A]>>>0,S[A]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");w=D,x++}for(var I=b-w;I!==b&&S[I]===0;)I++;for(var k=c.repeat(g);I<b;++I)k+=r.charAt(S[I]);return k}function h(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var g=0;if(m[g]!==" "){for(var w=0,x=0;m[g]===c;)w++,g++;for(var v=(m.length-g)*l+1>>>0,b=new Uint8Array(v);m[g];){var S=t[m.charCodeAt(g)];if(S===255)return;for(var T=0,D=v-1;(S!==0||T<x)&&D!==-1;D--,T++)S+=a*b[D]>>>0,b[D]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");x=T,g++}if(m[g]!==" "){for(var A=v-x;A!==v&&b[A]===0;)A++;for(var I=new Uint8Array(w+(v-A)),k=w;A!==v;)I[k++]=b[A++];return I}}}function d(m){var g=h(m);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var h$=d$,p$=h$,LS=p$;var M8=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},U8=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return BS(this,e)}},F8=class{decoders;constructor(e){this.decoders=e}or(e){return BS(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function BS(r,e){return new F8({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var $8=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new M8(e,t,n),this.decoder=new U8(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Gu({name:r,prefix:e,encode:t,decode:n}){return new $8(r,e,t,n)}function fa({name:r,prefix:e,alphabet:t}){let{encode:n,decode:i}=LS(t,r);return Gu({prefix:e,name:r,encode:n,decode:o=>Ei(i(o))})}function m$(r,e,t,n){let i={};for(let u=0;u<e.length;++u)i[e[u]]=u;let o=r.length;for(;r[o-1]==="=";)--o;let s=new Uint8Array(o*t/8|0),a=0,c=0,l=0;for(let u=0;u<o;++u){let f=i[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=t||(255&c<<8-a)!==0)throw new SyntaxError("Unexpected end of data");return s}function g$(r,e,t){let n=e[e.length-1]==="=",i=(1<<t)-1,o="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,o+=e[i&a>>s];if(s!==0&&(o+=e[i&a<<t-s]),n)for(;(o.length*t&7)!==0;)o+="=";return o}function Kt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return Gu({prefix:e,name:r,encode(i){return g$(i,n,t)},decode(i){return m$(i,n,t,r)}})}var y$=fa({prefix:"9",name:"base10",alphabet:"0123456789"});var V8={};Ft(V8,{base16:()=>w$,base16upper:()=>x$});var w$=Kt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),x$=Kt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var z8={};Ft(z8,{base2:()=>b$});var b$=Kt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var K8={};Ft(K8,{base256emoji:()=>_$});var MS=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),v$=MS.reduce((r,e,t)=>(r[t]=e,r),[]),E$=MS.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function S$(r){return r.reduce((e,t)=>(e+=v$[t],e),"")}function A$(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let i=E$[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}var _$=Gu({prefix:"\u{1F680}",name:"base256emoji",encode:S$,decode:A$});var q8={};Ft(q8,{base32:()=>Jt,base32hex:()=>k$,base32hexpad:()=>R$,base32hexpadupper:()=>D$,base32hexupper:()=>P$,base32pad:()=>T$,base32padupper:()=>C$,base32upper:()=>I$,base32z:()=>N$});var Jt=Kt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),I$=Kt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),T$=Kt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),C$=Kt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),k$=Kt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),P$=Kt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),R$=Kt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),D$=Kt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),N$=Kt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var j8={};Ft(j8,{base36:()=>fn,base36upper:()=>O$});var fn=fa({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),O$=fa({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var W8={};Ft(W8,{base58btc:()=>Le,base58flickr:()=>L$});var Le=fa({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),L$=fa({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var G8={};Ft(G8,{base64:()=>ar,base64pad:()=>B$,base64url:()=>Nc,base64urlpad:()=>M$});var ar=Kt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),B$=Kt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Nc=Kt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),M$=Kt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var X8={};Ft(X8,{base8:()=>U$});var U$=Kt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Y8={};Ft(Y8,{identity:()=>F$});var F$=Gu({prefix:"\0",name:"identity",encode:r=>B8(r),decode:r=>L8(r)});var Xu={};Ft(Xu,{code:()=>Lo,decode:()=>Q8,encode:()=>z$,name:()=>V$});var $$=new TextEncoder,H$=new TextDecoder,V$="json",Lo=512;function z$(r){return $$.encode(JSON.stringify(r))}function Q8(r){return JSON.parse(H$.decode(r))}var _n={};Ft(_n,{code:()=>vt,decode:()=>j$,encode:()=>q$,name:()=>K$});var K$="raw",vt=85;function q$(r){return Ei(r)}function j$(r){return Ei(r)}var ew={};Ft(ew,{identity:()=>cr});var yt={};Ft(yt,{Digest:()=>Oc,create:()=>Zr,decode:()=>Ue,equals:()=>J8,hasCode:()=>fH});var W$=$S,US=128,G$=127,X$=~G$,Y$=Math.pow(2,31);function $S(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Y$;)e[t++]=r&255|US,r/=128;for(;r&X$;)e[t++]=r&255|US,r>>>=7;return e[t]=r|0,$S.bytes=t-n+1,e}var Q$=Z8,Z$=128,FS=127;function Z8(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a)throw Z8.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&FS)<<i:(s&FS)*Math.pow(2,i),i+=7}while(s>=Z$);return Z8.bytes=o-n,t}var J$=Math.pow(2,7),eH=Math.pow(2,14),tH=Math.pow(2,21),rH=Math.pow(2,28),nH=Math.pow(2,35),iH=Math.pow(2,42),oH=Math.pow(2,49),sH=Math.pow(2,56),aH=Math.pow(2,63),cH=function(r){return r<J$?1:r<eH?2:r<tH?3:r<rH?4:r<nH?5:r<iH?6:r<oH?7:r<sH?8:r<aH?9:10},lH={encode:W$,decode:Q$,encodingLength:cH},uH=lH,vh=uH;function Eh(r,e=0){return[vh.decode(r,e),vh.decode.bytes]}function Yu(r,e,t=0){return vh.encode(r,e,t),e}function Qu(r){return vh.encodingLength(r)}function Zr(r,e){let t=e.byteLength,n=Qu(r),i=n+Qu(t),o=new Uint8Array(i+t);return Yu(r,o,0),Yu(t,o,n),o.set(e,i),new Oc(r,t,e,o)}function Ue(r){let e=Ei(r),[t,n]=Eh(e),[i,o]=Eh(e.subarray(n)),s=e.subarray(n+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new Oc(t,i,s,e)}function J8(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&O8(r.bytes,t.bytes)}}var Oc=class{code;size;digest;bytes;constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}};function fH(r,e){return r.code===e}var HS=0,dH="identity",VS=Ei;function hH(r){return Zr(HS,VS(r))}var cr={code:HS,name:dH,encode:VS,digest:hH};var rw={};Ft(rw,{sha256:()=>Fe,sha512:()=>A0});function Lc({name:r,code:e,encode:t}){return new tw(r,e,t)}var tw=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Zr(this.code,t):t.then(n=>Zr(this.code,n))}else throw Error("Unknown type, must be binary type")}};function KS(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var Fe=Lc({name:"sha2-256",code:18,encode:KS("SHA-256")}),A0=Lc({name:"sha2-512",code:19,encode:KS("SHA-512")});function qS(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return mH(t,nw(r),e??Le.encoder);default:return gH(t,nw(r),e??Jt.encoder)}}var jS=new WeakMap;function nw(r){let e=jS.get(r);if(e==null){let t=new Map;return jS.set(r,t),t}return e}var W=class r{code;version;multihash;bytes;"/";constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Sh)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==yH)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Zr(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&J8(e.multihash,n.multihash)}toString(e){return qS(this,e)}toJSON(){return{"/":qS(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:i,multihash:o,bytes:s}=t;return new r(n,i,o,s??WS(n,i,o.bytes))}else if(t[wH]===!0){let{version:n,multihash:i,code:o}=t,s=Ue(i);return r.create(n,o,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Sh)throw new Error(`Version 0 CID must use dag-pb (code: ${Sh}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let i=WS(e,t,n.bytes);return new r(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Sh,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,i=Ei(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=i.subarray(t.multihashSize-t.digestSize),s=new Oc(t.multihashCode,t.digestSize,o,i);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Eh(e.subarray(t));return t+=h,f},i=n(),o=Sh;if(i===18?(i=0,t=0):o=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);let s=t,a=n(),c=n(),l=t+c,u=l-s;return{version:i,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,i]=pH(e,t),o=r.decode(i);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return nw(o).set(n,e),o}};function pH(r,e){switch(r[0]){case"Q":{let t=e??Le;return[Le.prefix,t.decode(`${Le.prefix}${r}`)]}case Le.prefix:{let t=e??Le;return[Le.prefix,t.decode(r)]}case Jt.prefix:{let t=e??Jt;return[Jt.prefix,t.decode(r)]}case fn.prefix:{let t=e??fn;return[fn.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function mH(r,e,t){let{prefix:n}=t;if(n!==Le.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let i=e.get(n);if(i==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return i}function gH(r,e,t){let{prefix:n}=t,i=e.get(n);if(i==null){let o=t.encode(r);return e.set(n,o),o}else return i}var Sh=112,yH=18;function WS(r,e,t){let n=Qu(r),i=n+Qu(e),o=new Uint8Array(i+t.byteLength);return Yu(r,o,0),Yu(e,o,n),o.set(t,i),o}var wH=Symbol.for("@ipld/js-cid/CID");var Bc={...Y8,...z8,...X8,...H8,...V8,...q8,...j8,...W8,...G8,...K8},pie={...rw,...ew};function XS(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var GS=XS("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),iw=XS("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=$t(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),xH={utf8:GS,"utf-8":GS,hex:Bc.base16,latin1:iw,ascii:iw,binary:iw,...Bc},_0=xH;function O(r,e="utf8"){let t=_0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function ow(r){let e=r??8192,t=e>>>1,n,i=e;return function(s){if(s<1||s>t)return $t(s);i+s>e&&(n=$t(e),i=0);let a=n.subarray(i,i+=s);return(i&7)!==0&&(i=(i|7)+1),a}}var Mc=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function sw(){}var cw=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},bH=ow();function vH(r){return globalThis.Buffer!=null?$t(r):bH(r)}var _h=class{len;head;tail;states;constructor(){this.len=0,this.head=new Mc(sw,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Mc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new lw((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(I0,10,ti.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=ti.fromBigInt(e);return this._push(I0,t.length(),t)}uint64Number(e){return this._push(S8,Oe(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=ti.fromBigInt(e).zzEncode();return this._push(I0,t.length(),t)}sint64Number(e){let t=ti.fromNumber(e).zzEncode();return this._push(I0,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(aw,1,e?1:0)}fixed32(e){return this._push(Ah,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=ti.fromBigInt(e);return this._push(Ah,4,t.lo)._push(Ah,4,t.hi)}fixed64Number(e){let t=ti.fromNumber(e);return this._push(Ah,4,t.lo)._push(Ah,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(IS,4,e)}double(e){return this._push(CS,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(aw,1,0):this.uint32(t)._push(SH,t,e)}string(e){let t=RS(e);return t!==0?this.uint32(t)._push(R8,t,e):this._push(aw,1,0)}fork(){return this.states=new cw(this),this.head=this.tail=new Mc(sw,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Mc(sw,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=vH(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function aw(r,e,t){e[t]=r&255}function EH(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var lw=class extends Mc{next;constructor(e,t){super(EH,e,t),this.next=void 0}};function I0(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Ah(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function SH(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(_h.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(AH,e,r),this},_h.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(_H,e,r),this});function AH(r,e,t){e.set(r,t)}function _H(r,e,t){r.length<40?R8(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(O(r),t)}function uw(){return new _h}function ve(r,e){let t=uw();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Zu;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Zu||(Zu={}));function T0(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function St(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}let t=function(o,s){let a=e(o);s.int32(a)},n=function(o){let s=o.int32();return e(s)};return T0("enum",Zu.VARINT,t,n)}function Ee(r,e){return T0("message",Zu.LENGTH_DELIMITED,r,e)}var wt=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Ih=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var er;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(er||(er={}));var fw;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(fw||(fw={}));(function(r){r.codec=()=>St(fw)})(er||(er={}));var Ju;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),er.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={cid:Pe(0),priority:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.cid=t.bytes();break}case 2:{o.priority=t.int32();break}case 3:{o.cancel=t.bool();break}case 4:{o.wantType=er.codec().decode(t);break}case 5:{o.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Ju||(Ju={}));var C0;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(let o of t.entries)n.uint32(10),Ju.codec().encode(o,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={entries:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.entries!=null&&o.entries.length===i.limits.entries)throw new wt('Decode error - map field "entries" had too many elements');o.entries.push(Ju.codec().decode(t,t.uint32(),{limits:i.limits?.entries$}));break}case 2:{o.full=t.bool();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(C0||(C0={}));var ef;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={prefix:Pe(0),data:Pe(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.prefix=t.bytes();break}case 2:{o.data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(ef||(ef={}));var Si;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Si||(Si={}));var k0;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(k0||(k0={}));(function(r){r.codec=()=>St(k0)})(Si||(Si={}));var tf;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&k0[t.type]!==0&&(n.uint32(16),Si.codec().encode(t.type,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={cid:Pe(0),type:Si.HaveBlock},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.cid=t.bytes();break}case 2:{o.type=Si.codec().decode(t);break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(tf||(tf={}));var Uc;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),C0.codec().encode(t.wantlist,n)),t.blocks!=null)for(let o of t.blocks)n.uint32(26),ef.codec().encode(o,n);if(t.blockPresences!=null)for(let o of t.blockPresences)n.uint32(34),tf.codec().encode(o,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={blocks:[],blockPresences:[],pendingBytes:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.wantlist=C0.codec().decode(t,t.uint32(),{limits:i.limits?.wantlist});break}case 3:{if(i.limits?.blocks!=null&&o.blocks.length===i.limits.blocks)throw new wt('Decode error - map field "blocks" had too many elements');o.blocks.push(ef.codec().decode(t,t.uint32(),{limits:i.limits?.blocks$}));break}case 4:{if(i.limits?.blockPresences!=null&&o.blockPresences.length===i.limits.blockPresences)throw new wt('Decode error - map field "blockPresences" had too many elements');o.blockPresences.push(tf.codec().decode(t,t.uint32(),{limits:i.limits?.blockPresences$}));break}case 5:{o.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Uc||(Uc={}));function YS(r,e){for(let[t,n]of e.wantlist.entries()){let i=r.wantlist.get(t);i!=null&&(i.priority>n.priority&&(n.priority=i.priority),n.cancel=n.cancel??i.cancel,n.wantType=n.wantType??i.wantType,n.sendDontHave=n.sendDontHave??i.sendDontHave),r.wantlist.set(t,n)}for(let[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(let[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}var P0=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var IH=4193648,TH=IH+16;function*QS(r,e){let t=[...r.wantlist.values()],n=[...r.blockPresences.values()],i=[...r.blocks.values()],o=0,s=0,a=0,c=!1;for(;;){let l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},u=Uc.encode(l).byteLength,{added:f,hasMore:h,newSize:d}=dw(i,l.blocks,a,e,u,CH);a+=f,u=d;let m=h;({added:f,hasMore:h,newSize:d}=dw(n,l.blockPresences,s,e,u,kH)),s+=f,u=d;let g=h;if({added:f,hasMore:h,newSize:d}=dw(t,l.wantlist.entries,o,e,u,PH),o+=f,u=d,c=!m&&!g&&!h,c||(l.wantlist.full=!1),yield Uc.encode(l),c)break}}function dw(r,e,t,n,i,o){let s=0,a=!1;for(let c=t;c<r.length;c++){let l=r[c],u=o(l);if(u>TH)throw new P0("Cannot send block as after encoding it is over the max message size");let f=i+u;if(f>n){a=!0;break}e.push(l),s++,i=f}return{hasMore:a,added:s,newSize:i}}function CH(r){return hw(3,ef.encode(r))}function kH(r){return hw(4,tf.encode(r))}function PH(r){return hw(1,Ju.encode(r))}function hw(r,e){let t=Oe(r),n=Oe(e.byteLength);return t+n+e.byteLength}var R0=class extends Me{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[bh],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Pr({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",n=>{this.log.error("error sending wantlist to peer",n.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;let{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);let i=()=>{t.status==="open"?t.abort(new Oo(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)},o=AbortSignal.timeout(this.messageReceiveTimeout);o.addEventListener("abort",i),await t.closeWrite(),await ot(t,s=>Qi(s,{maxDataLength:this.maxIncomingMessageSize}),async s=>{for await(let a of s)try{let c=Uc.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:c}}),o.removeEventListener("abort",i),o=AbortSignal.timeout(this.messageReceiveTimeout),o.addEventListener("abort",i)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,c),t.abort(c);break}})}).catch(i=>{this.log.error("error handling incoming stream from %p",n.remotePeer,i),t.abort(i)})}async*findProviders(e,t){t?.onProgress?.(new G("bitswap:network:find-providers",e));for await(let n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield n)}async findAndConnect(e,t){await Sr(Nt(la(this.findProviders(e,t),t?.maxProviders??3),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");let i=this.sendQueue.queue.find(o=>e.equals(o.options.peerId)&&o.status==="queued");if(i!=null){i.options.message=YS(i.options.message,t),await i.join({signal:n?.signal});return}await this.sendQueue.add(async o=>{let s=o?.message;if(s==null)throw new U("No message to send");this.log("sendMessage to %p",e),o?.onProgress?.(new G("bitswap:network:send-wantlist",e));let a=await this.libp2p.dialProtocol(e,bh,o);await a.closeRead();try{await ot(QS(s,this.maxOutgoingMessageSize),c=>Yi(c),a),await a.close(o)}catch(c){o?.onProgress?.(new G("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(s.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Zn("Network isn't running");t?.onProgress?.(new G("bitswap:network:dial",e));let[n]=await Promise.all([this.libp2p.dial(e,t),Er(this.libp2p,"peer:identify",t?.signal,{filter:i=>{if(!i.detail.peerId.equals(e))return!1;if(i.detail.protocols.includes(bh))return!0;throw new ps(`${e} did not support ${bh}`)}})]);return n}_updateSentStats(e){let t=0;for(let n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};function H(r,e="utf8"){let t=_0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var FH=parseInt("11111",2),pw=parseInt("10000000",2),$H=parseInt("01111111",2),ZS={0:Th,1:Th,2:HH,3:KH,4:qH,5:zH,6:VH,16:Th,22:Th,48:Th};function Ai(r,e={offset:0}){let t=r[e.offset]&FH;if(e.offset++,ZS[t]!=null)return ZS[t](r,e);throw new Error("No decoder for tag "+t)}function Ch(r,e){let t=0;if((r[e.offset]&pw)===pw){let n=r[e.offset]&$H,i="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)i+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=r[e.offset],e.offset++;return t}function Th(r,e){Ch(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Ai(r,e);if(n===null)break;t.push(n)}return t}function HH(r,e){let t=Ch(r,e),n=e.offset,i=e.offset+t,o=[];for(let s=n;s<i;s++)s===n&&r[s]===0||o.push(r[s]);return e.offset+=t,Uint8Array.from(o)}function VH(r,e){let t=Ch(r,e),n=e.offset+t,i=r[e.offset];e.offset++;let o=0,s=0;i<40?(o=0,s=i):i<80?(o=1,s=i-40):(o=2,s=i-80);let a=`${o}.${s}`,c=[];for(;e.offset<n;){let l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let f=0;f<c.length;f++)u+=c[f]<<f*7;a+=`.${u}`,c=[]}}return a}function zH(r,e){return e.offset++,null}function KH(r,e){let t=Ch(r,e),n=r[e.offset];e.offset++;let i=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function qH(r,e){let t=Ch(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function jH(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new oe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function D0(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=jH(r.byteLength);return new oe(Uint8Array.from([e.byteLength|pw]),e)}function dn(r){let e=new oe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new oe(Uint8Array.from([2]),D0(e),e)}function kh(r){let e=Uint8Array.from([0]),t=new oe(e,r);return new oe(Uint8Array.from([3]),D0(t),t)}function JS(r){return new oe(Uint8Array.from([4]),D0(r),r)}function Ji(r,e=48){let t=new oe;for(let n of r)t.append(n);return new oe(Uint8Array.from([e]),D0(t),t)}var eA="1.2.840.10045.3.1.7",tA="1.3.132.0.34",rA="1.3.132.0.35";async function nA(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function iA(r,e){let t=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]),n=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,e.subarray());return new Uint8Array(n,0,n.byteLength)}async function oA(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);return crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},n,e,t.subarray())}var WH=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),GH=Uint8Array.from([6,5,43,129,4,0,34]),XH=Uint8Array.from([6,5,43,129,4,0,35]),sA={ext:!0,kty:"EC",crv:"P-256"},aA={ext:!0,kty:"EC",crv:"P-384"},cA={ext:!0,kty:"EC",crv:"P-521"},rf=32,nf=48,of=66;function lA(r){let e=Ai(r);return mw(e)}function mw(r){let e=r[1],t=H(e,"base64url"),n=r[2][1][0],i=1,o,s;if(e.byteLength===rf)return o=H(n.subarray(i,i+rf),"base64url"),s=H(n.subarray(i+rf),"base64url"),new $c({...sA,key_ops:["sign"],d:t,x:o,y:s});if(e.byteLength===nf)return o=H(n.subarray(i,i+nf),"base64url"),s=H(n.subarray(i+nf),"base64url"),new $c({...aA,key_ops:["sign"],d:t,x:o,y:s});if(e.byteLength===of)return o=H(n.subarray(i,i+of),"base64url"),s=H(n.subarray(i+of),"base64url"),new $c({...cA,key_ops:["sign"],d:t,x:o,y:s});throw new U(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function gw(r){let e=Ai(r);return uA(e)}function uA(r){let e=r[1][1][0],t=1,n,i;if(e.byteLength===rf*2+1)return n=H(e.subarray(t,t+rf),"base64url"),i=H(e.subarray(t+rf),"base64url"),new Fc({...sA,key_ops:["verify"],x:n,y:i});if(e.byteLength===nf*2+1)return n=H(e.subarray(t,t+nf),"base64url"),i=H(e.subarray(t+nf),"base64url"),new Fc({...aA,key_ops:["verify"],x:n,y:i});if(e.byteLength===of*2+1)return n=H(e.subarray(t,t+of),"base64url"),i=H(e.subarray(t+of),"base64url"),new Fc({...cA,key_ops:["verify"],x:n,y:i});throw new U(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function fA(r){return Ji([dn(Uint8Array.from([1])),JS(O(r.d??"","base64url")),Ji([hA(r.crv)],160),Ji([kh(new oe(Uint8Array.from([4]),O(r.x??"","base64url"),O(r.y??"","base64url")))],161)]).subarray()}function dA(r){return Ji([dn(Uint8Array.from([1])),Ji([hA(r.crv)],160),Ji([kh(new oe(Uint8Array.from([4]),O(r.x??"","base64url"),O(r.y??"","base64url")))],161)]).subarray()}function hA(r){if(r==="P-256")return WH;if(r==="P-384")return GH;if(r==="P-521")return XH;throw new U(`Invalid curve ${r}`)}async function pA(r="P-256"){let e=await nA(r);return new $c(e.privateKey)}var Fc=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=dA(this.jwk)),this._raw}toMultihash(){return cr.digest(lr(this))}toCID(){return W.createV1(114,this.toMultihash())}toString(){return Le.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async verify(e,t){return oA(this.jwk,t,e)}},$c=class{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Fc({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=fA(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async sign(e){return iA(this.jwk,e)}};var Hc=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function YH(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Bo(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function da(r,...e){if(!YH(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Vc(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Bo(r.outputLen),Bo(r.blockLen)}function af(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function mA(r,e){da(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Jr(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function zc(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function eo(r,e){return r<<32-e|r>>>e}function N0(r,e){return r<<e|r>>>32-e>>>0}var QH=async()=>{};async function gA(r,e,t){let n=Date.now();for(let i=0;i<r;i++){t(i);let o=Date.now()-n;o>=0&&o<e||(await QH(),n+=o)}}function yw(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function ha(r){return typeof r=="string"&&(r=yw(r)),da(r),r}function ww(r){return typeof r=="string"&&(r=yw(r)),da(r),r}function xw(...r){let e=0;for(let n=0;n<r.length;n++){let i=r[n];da(i),e+=i.length}let t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){let o=r[n];t.set(o,i),i+=o.length}return t}function yA(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}var sf=class{};function Ph(r){let e=n=>r().update(ha(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Kc(r=32){if(Hc&&typeof Hc.getRandomValues=="function")return Hc.getRandomValues(new Uint8Array(r));if(Hc&&typeof Hc.randomBytes=="function")return Uint8Array.from(Hc.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function ZH(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),s=Number(t>>i&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function O0(r,e,t){return r&e^~r&t}function L0(r,e,t){return r&e^r&t^e&t}var qc=class extends sf{constructor(e,t,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=zc(this.buffer)}update(e){af(this),e=ha(e),da(e);let{view:t,buffer:n,blockLen:i}=this,o=e.length;for(let s=0;s<o;){let a=Math.min(i-this.pos,o-s);if(a===i){let c=zc(e);for(;i<=o-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){af(this),mA(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;t[s++]=128,Jr(this.buffer.subarray(s)),this.padOffset>i-s&&(this.process(n,0),s=0);for(let f=s;f<i;f++)t[f]=0;ZH(n,i-8,BigInt(this.length*8),o),this.process(n,0);let a=zc(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:s,pos:a}=this;return e.destroyed=s,e.finished=o,e.length=i,e.pos=a,i%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},gs=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var Rr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var B0=BigInt(4294967295),wA=BigInt(32);function JH(r,e=!1){return e?{h:Number(r&B0),l:Number(r>>wA&B0)}:{h:Number(r>>wA&B0)|0,l:Number(r&B0)|0}}function xA(r,e=!1){let t=r.length,n=new Uint32Array(t),i=new Uint32Array(t);for(let o=0;o<t;o++){let{h:s,l:a}=JH(r[o],e);[n[o],i[o]]=[s,a]}return[n,i]}var bw=(r,e,t)=>r>>>t,vw=(r,e,t)=>r<<32-t|e>>>t,jc=(r,e,t)=>r>>>t|e<<32-t,Wc=(r,e,t)=>r<<32-t|e>>>t,Rh=(r,e,t)=>r<<64-t|e>>>t-32,Dh=(r,e,t)=>r>>>t-32|e<<64-t;function Mo(r,e,t,n){let i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}var bA=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),vA=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,EA=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),SA=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,AA=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),_A=(r,e,t,n,i,o)=>e+t+n+i+o+(r/2**32|0)|0;var tV=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),pa=new Uint32Array(64),M0=class extends qc{constructor(e=32){super(64,e,8,!1),this.A=gs[0]|0,this.B=gs[1]|0,this.C=gs[2]|0,this.D=gs[3]|0,this.E=gs[4]|0,this.F=gs[5]|0,this.G=gs[6]|0,this.H=gs[7]|0}get(){let{A:e,B:t,C:n,D:i,E:o,F:s,G:a,H:c}=this;return[e,t,n,i,o,s,a,c]}set(e,t,n,i,o,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)pa[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=pa[f-15],d=pa[f-2],m=eo(h,7)^eo(h,18)^h>>>3,g=eo(d,17)^eo(d,19)^d>>>10;pa[f]=g+pa[f-7]+m+pa[f-16]|0}let{A:n,B:i,C:o,D:s,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=eo(a,6)^eo(a,11)^eo(a,25),d=u+h+O0(a,c,l)+tV[f]+pa[f]|0,g=(eo(n,2)^eo(n,13)^eo(n,22))+L0(n,i,o)|0;u=l,l=c,c=a,a=s+d|0,s=o,o=i,i=n,n=d+g|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,i,o,s,a,c,l,u)}roundClean(){Jr(pa)}destroy(){this.set(0,0,0,0,0,0,0,0),Jr(this.buffer)}};var IA=xA(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),rV=IA[0],nV=IA[1],ma=new Uint32Array(80),ga=new Uint32Array(80),U0=class extends qc{constructor(e=64){super(128,e,16,!1),this.Ah=Rr[0]|0,this.Al=Rr[1]|0,this.Bh=Rr[2]|0,this.Bl=Rr[3]|0,this.Ch=Rr[4]|0,this.Cl=Rr[5]|0,this.Dh=Rr[6]|0,this.Dl=Rr[7]|0,this.Eh=Rr[8]|0,this.El=Rr[9]|0,this.Fh=Rr[10]|0,this.Fl=Rr[11]|0,this.Gh=Rr[12]|0,this.Gl=Rr[13]|0,this.Hh=Rr[14]|0,this.Hl=Rr[15]|0}get(){let{Ah:e,Al:t,Bh:n,Bl:i,Ch:o,Cl:s,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:m,Hh:g,Hl:w}=this;return[e,t,n,i,o,s,a,c,l,u,f,h,d,m,g,w]}set(e,t,n,i,o,s,a,c,l,u,f,h,d,m,g,w){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=o|0,this.Cl=s|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=m|0,this.Hh=g|0,this.Hl=w|0}process(e,t){for(let b=0;b<16;b++,t+=4)ma[b]=e.getUint32(t),ga[b]=e.getUint32(t+=4);for(let b=16;b<80;b++){let S=ma[b-15]|0,T=ga[b-15]|0,D=jc(S,T,1)^jc(S,T,8)^bw(S,T,7),A=Wc(S,T,1)^Wc(S,T,8)^vw(S,T,7),I=ma[b-2]|0,k=ga[b-2]|0,Q=jc(I,k,19)^Rh(I,k,61)^bw(I,k,6),K=Wc(I,k,19)^Dh(I,k,61)^vw(I,k,6),V=EA(A,K,ga[b-7],ga[b-16]),X=SA(V,D,Q,ma[b-7],ma[b-16]);ma[b]=X|0,ga[b]=V|0}let{Ah:n,Al:i,Bh:o,Bl:s,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:m,Gh:g,Gl:w,Hh:x,Hl:v}=this;for(let b=0;b<80;b++){let S=jc(f,h,14)^jc(f,h,18)^Rh(f,h,41),T=Wc(f,h,14)^Wc(f,h,18)^Dh(f,h,41),D=f&d^~f&g,A=h&m^~h&w,I=AA(v,T,A,nV[b],ga[b]),k=_A(I,x,S,D,rV[b],ma[b]),Q=I|0,K=jc(n,i,28)^Rh(n,i,34)^Rh(n,i,39),V=Wc(n,i,28)^Dh(n,i,34)^Dh(n,i,39),X=n&o^n&a^o&a,$=i&s^i&c^s&c;x=g|0,v=w|0,g=d|0,w=m|0,d=f|0,m=h|0,{h:f,l:h}=Mo(l|0,u|0,k|0,Q|0),l=a|0,u=c|0,a=o|0,c=s|0,o=n|0,s=i|0;let F=bA(Q,V,$);n=vA(F,k,K,X),i=F|0}({h:n,l:i}=Mo(this.Ah|0,this.Al|0,n|0,i|0)),{h:o,l:s}=Mo(this.Bh|0,this.Bl|0,o|0,s|0),{h:a,l:c}=Mo(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Mo(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Mo(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:m}=Mo(this.Fh|0,this.Fl|0,d|0,m|0),{h:g,l:w}=Mo(this.Gh|0,this.Gl|0,g|0,w|0),{h:x,l:v}=Mo(this.Hh|0,this.Hl|0,x|0,v|0),this.set(n,i,o,s,a,c,l,u,f,h,d,m,g,w,x,v)}roundClean(){Jr(ma,ga)}destroy(){Jr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var F0=Ph(()=>new M0);var $0=Ph(()=>new U0);var _w=BigInt(0),Aw=BigInt(1);function Gc(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Iw(r){if(!Gc(r))throw new Error("Uint8Array expected")}function Uo(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function Nh(r){let e=r.toString(16);return e.length&1?"0"+e:e}function kA(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?_w:BigInt("0x"+r)}var PA=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",iV=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ya(r){if(Iw(r),PA)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=iV[r[t]];return e}var ys={_0:48,_9:57,A:65,F:70,a:97,f:102};function TA(r){if(r>=ys._0&&r<=ys._9)return r-ys._0;if(r>=ys.A&&r<=ys.F)return r-(ys.A-10);if(r>=ys.a&&r<=ys.f)return r-(ys.a-10)}function Oh(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(PA)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let i=0,o=0;i<t;i++,o+=2){let s=TA(r.charCodeAt(o)),a=TA(r.charCodeAt(o+1));if(s===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[i]=s*16+a}return n}function ws(r){return kA(ya(r))}function Fo(r){return Iw(r),kA(ya(Uint8Array.from(r).reverse()))}function Xc(r,e){return Oh(r.toString(16).padStart(e*2,"0"))}function wa(r,e){return Xc(r,e).reverse()}function At(r,e,t){let n;if(typeof e=="string")try{n=Oh(e)}catch(o){throw new Error(r+" must be hex string or Uint8Array, cause: "+o)}else if(Gc(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");let i=n.length;if(typeof t=="number"&&i!==t)throw new Error(r+" of length "+t+" expected, got "+i);return n}function xa(...r){let e=0;for(let n=0;n<r.length;n++){let i=r[n];Iw(i),e+=i.length}let t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){let o=r[n];t.set(o,i),i+=o.length}return t}var Ew=r=>typeof r=="bigint"&&_w<=r;function H0(r,e,t){return Ew(r)&&Ew(e)&&Ew(t)&&e<=r&&r<t}function en(r,e,t,n){if(!H0(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function RA(r){let e;for(e=0;r>_w;r>>=Aw,e+=1);return e}var Yc=r=>(Aw<<BigInt(r))-Aw,Sw=r=>new Uint8Array(r),CA=r=>Uint8Array.from(r);function DA(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=Sw(r),i=Sw(r),o=0,s=()=>{n.fill(1),i.fill(0),o=0},a=(...f)=>t(i,n,...f),c=(f=Sw(0))=>{i=a(CA([0]),f),n=a(),f.length!==0&&(i=a(CA([1]),f),n=a())},l=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let f=0,h=[];for(;f<e;){n=a();let d=n.slice();h.push(d),f+=n.length}return xa(...h)};return(f,h)=>{s(),c(f);let d;for(;!(d=h(l()));)c();return s(),d}}var oV={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||Gc(r),isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function to(r,e,t={}){let n=(i,o,s)=>{let a=oV[o];if(typeof a!="function")throw new Error("invalid validator function");let c=r[i];if(!(s&&c===void 0)&&!a(c,r))throw new Error("param "+String(i)+" is invalid. Expected "+o+", got "+c)};for(let[i,o]of Object.entries(e))n(i,o,!1);for(let[i,o]of Object.entries(t))n(i,o,!0);return r}function cf(r){let e=new WeakMap;return(t,...n)=>{let i=e.get(t);if(i!==void 0)return i;let o=r(t,...n);return e.set(t,o),o}}var hn=BigInt(0),yr=BigInt(1),Qc=BigInt(2),sV=BigInt(3),Tw=BigInt(4),NA=BigInt(5),OA=BigInt(8),aV=BigInt(9),cV=BigInt(16);function st(r,e){let t=r%e;return t>=hn?t:e+t}function Ct(r,e,t){let n=r;for(;e-- >hn;)n*=n,n%=t;return n}function V0(r,e){if(r===hn)throw new Error("invert: expected non-zero number");if(e<=hn)throw new Error("invert: expected positive modulus, got "+e);let t=st(r,e),n=e,i=hn,o=yr,s=yr,a=hn;for(;t!==hn;){let l=n/t,u=n%t,f=i-s*l,h=o-a*l;n=t,t=u,i=s,o=a,s=f,a=h}if(n!==yr)throw new Error("invert: does not exist");return st(i,e)}function lV(r){let e=r-yr,t=0;for(;e%Qc===hn;)e/=Qc,t++;let n=Qc,i=ro(r);for(;n<r&&LA(i,n);)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1){let s=(r+yr)/Tw;return function(c,l){let u=c.pow(l,s);if(!c.eql(c.sqr(u),l))throw new Error("Cannot find square root");return u}}let o=(e+yr)/Qc;return function(a,c){if(!LA(a,c))throw new Error("Cannot find square root");let l=t,u=a.pow(a.mul(a.ONE,n),e),f=a.pow(c,o),h=a.pow(c,e);for(;!a.eql(h,a.ONE);){if(a.eql(h,a.ZERO))return a.ZERO;let d=1;for(let g=a.sqr(h);d<l&&!a.eql(g,a.ONE);d++)g=a.sqr(g);let m=a.pow(u,yr<<BigInt(l-d-1));u=a.sqr(m),f=a.mul(f,m),h=a.mul(h,u),l=d}return f}}function uV(r){return r%Tw===sV?function(t,n){let i=(r+yr)/Tw,o=t.pow(n,i);if(!t.eql(t.sqr(o),n))throw new Error("Cannot find square root");return o}:r%OA===NA?function(t,n){let i=t.mul(n,Qc),o=(r-NA)/OA,s=t.pow(i,o),a=t.mul(n,s),c=t.mul(t.mul(a,Qc),s),l=t.mul(a,t.sub(c,t.ONE));if(!t.eql(t.sqr(l),n))throw new Error("Cannot find square root");return l}:(r%cV,lV(r))}var BA=(r,e)=>(st(r,e)&yr)===yr,fV=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Cw(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=fV.reduce((n,i)=>(n[i]="function",n),e);return to(r,t)}function dV(r,e,t){if(t<hn)throw new Error("invalid exponent, negatives unsupported");if(t===hn)return r.ONE;if(t===yr)return e;let n=r.ONE,i=e;for(;t>hn;)t&yr&&(n=r.mul(n,i)),i=r.sqr(i),t>>=yr;return n}function lf(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),i=e.reduce((s,a,c)=>r.is0(a)?s:(n[c]=s,r.mul(s,a)),r.ONE),o=r.inv(i);return e.reduceRight((s,a,c)=>r.is0(a)?s:(n[c]=r.mul(s,n[c]),r.mul(s,a)),o),n}function hV(r,e){let t=(r.ORDER-yr)/Qc,n=r.pow(e,t),i=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),s=r.eql(n,r.neg(r.ONE));if(!i&&!o&&!s)throw new Error("Cannot find square root: probably non-prime P");return i?1:o?0:-1}function LA(r,e){let t=hV(r,e);return t===0||t===1}function kw(r,e){e!==void 0&&Bo(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function ro(r,e,t=!1,n={}){if(r<=hn)throw new Error("invalid field: expected ORDER > 0, got "+r);let{nBitLength:i,nByteLength:o}=kw(r,e);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let s,a=Object.freeze({ORDER:r,isLE:t,BITS:i,BYTES:o,MASK:Yc(i),ZERO:hn,ONE:yr,create:c=>st(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return hn<=c&&c<r},is0:c=>c===hn,isOdd:c=>(c&yr)===yr,neg:c=>st(-c,r),eql:(c,l)=>c===l,sqr:c=>st(c*c,r),add:(c,l)=>st(c+l,r),sub:(c,l)=>st(c-l,r),mul:(c,l)=>st(c*l,r),pow:(c,l)=>dV(a,c,l),div:(c,l)=>st(c*V0(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>V0(c,r),sqrt:n.sqrt||(c=>(s||(s=uV(r)),s(a,c))),toBytes:c=>t?wa(c,o):Xc(c,o),fromBytes:c=>{if(c.length!==o)throw new Error("Field.fromBytes: expected "+o+" bytes, got "+c.length);return t?Fo(c):ws(c)},invertBatch:c=>lf(a,c),cmov:(c,l,u)=>u?l:c});return Object.freeze(a)}function MA(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function Pw(r){let e=MA(r);return e+Math.ceil(e/2)}function UA(r,e,t=!1){let n=r.length,i=MA(e),o=Pw(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let s=t?Fo(r):ws(r),a=st(s,e-yr)+yr;return t?wa(a,i):Xc(a,i)}var FA=BigInt(0),Lw=BigInt(1);function Rw(r,e){let t=e.negate();return r?t:e}function HA(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Dw(r,e){HA(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),i=2**r,o=Yc(r),s=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:i,shiftBy:s}}function $A(r,e,t){let{windowSize:n,mask:i,maxNumber:o,shiftBy:s}=t,a=Number(r&i),c=r>>s;a>n&&(a-=o,c+=Lw);let l=e*n,u=l+Math.abs(a)-1,f=a===0,h=a<0,d=e%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:l}}function pV(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function mV(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}var Nw=new WeakMap,VA=new WeakMap;function Ow(r){return VA.get(r)||1}function z0(r,e){return{constTimeNegate:Rw,hasPrecomputes(t){return Ow(t)!==1},unsafeLadder(t,n,i=r.ZERO){let o=t;for(;n>FA;)n&Lw&&(i=i.add(o)),o=o.double(),n>>=Lw;return i},precomputeWindow(t,n){let{windows:i,windowSize:o}=Dw(n,e),s=[],a=t,c=a;for(let l=0;l<i;l++){c=a,s.push(c);for(let u=1;u<o;u++)c=c.add(a),s.push(c);a=c.double()}return s},wNAF(t,n,i){let o=r.ZERO,s=r.BASE,a=Dw(t,e);for(let c=0;c<a.windows;c++){let{nextN:l,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:m}=$A(i,c,a);i=l,f?s=s.add(Rw(d,n[m])):o=o.add(Rw(h,n[u]))}return{p:o,f:s}},wNAFUnsafe(t,n,i,o=r.ZERO){let s=Dw(t,e);for(let a=0;a<s.windows&&i!==FA;a++){let{nextN:c,offset:l,isZero:u,isNeg:f}=$A(i,a,s);if(i=c,!u){let h=n[l];o=o.add(f?h.negate():h)}}return o},getPrecomputes(t,n,i){let o=Nw.get(n);return o||(o=this.precomputeWindow(n,t),t!==1&&Nw.set(n,i(o))),o},wNAFCached(t,n,i){let o=Ow(t);return this.wNAF(o,this.getPrecomputes(o,t,i),n)},wNAFCachedUnsafe(t,n,i,o){let s=Ow(t);return s===1?this.unsafeLadder(t,n,o):this.wNAFUnsafe(s,this.getPrecomputes(s,t,i),n,o)},setWindowSize(t,n){HA(n,e),VA.set(t,n),Nw.delete(t)}}}function K0(r,e,t,n){if(pV(t,r),mV(n,e),t.length!==n.length)throw new Error("arrays of points and scalars must have equal length");let i=r.ZERO,o=RA(BigInt(t.length)),s=o>12?o-3:o>4?o-2:o?2:1,a=Yc(s),c=new Array(Number(a)+1).fill(i),l=Math.floor((e.BITS-1)/s)*s,u=i;for(let f=l;f>=0;f-=s){c.fill(i);for(let d=0;d<n.length;d++){let m=n[d],g=Number(m>>BigInt(f)&a);c[g]=c[g].add(t[d])}let h=i;for(let d=c.length-1,m=i;d>0;d--)m=m.add(c[d]),h=h.add(m);if(u=u.add(h),f!==0)for(let d=0;d<s;d++)u=u.double()}return u}function Lh(r){return Cw(r.Fp),to(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...kw(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}var $o=BigInt(0),pn=BigInt(1),zA=BigInt(2),gV=BigInt(8),yV={zip215:!0};function wV(r){let e=Lh(r);return to(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function KA(r){let e=wV(r),{Fp:t,n,prehash:i,hash:o,randomBytes:s,nByteLength:a,h:c}=e,l=zA<<BigInt(a*8)-pn,u=t.create,f=ro(e.n,e.nBitLength),h=e.uvRatio||((M,R)=>{try{return{isValid:!0,value:t.sqrt(M*t.inv(R))}}catch{return{isValid:!1,value:$o}}}),d=e.adjustScalarBytes||(M=>M),m=e.domain||((M,R,N)=>{if(Uo("phflag",N),R.length||N)throw new Error("Contexts/pre-hash are not supported");return M});function g(M,R,N=!1){let Z=N?pn:$o;en("coordinate "+M,R,Z,l)}function w(M){if(!(M instanceof b))throw new Error("ExtendedPoint expected")}let x=cf((M,R)=>{let{ex:N,ey:Z,ez:ne}=M,q=M.is0();R==null&&(R=q?gV:t.inv(ne));let ge=u(N*R),ke=u(Z*R),le=u(ne*R);if(q)return{x:$o,y:pn};if(le!==pn)throw new Error("invZ was invalid");return{x:ge,y:ke}}),v=cf(M=>{let{a:R,d:N}=e;if(M.is0())throw new Error("bad point: ZERO");let{ex:Z,ey:ne,ez:q,et:ge}=M,ke=u(Z*Z),le=u(ne*ne),De=u(q*q),et=u(De*De),Ye=u(ke*R),pt=u(De*u(Ye+le)),bt=u(et+u(N*u(ke*le)));if(pt!==bt)throw new Error("bad point: equation left != right (1)");let Rt=u(Z*ne),Et=u(q*ge);if(Rt!==Et)throw new Error("bad point: equation left != right (2)");return!0});class b{constructor(R,N,Z,ne){g("x",R),g("y",N),g("z",Z,!0),g("t",ne),this.ex=R,this.ey=N,this.ez=Z,this.et=ne,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(R){if(R instanceof b)throw new Error("extended point not allowed");let{x:N,y:Z}=R||{};return g("x",N),g("y",Z),new b(N,Z,pn,u(N*Z))}static normalizeZ(R){let N=lf(t,R.map(Z=>Z.ez));return R.map((Z,ne)=>Z.toAffine(N[ne])).map(b.fromAffine)}static msm(R,N){return K0(b,f,R,N)}_setWindowSize(R){D.setWindowSize(this,R)}assertValidity(){v(this)}equals(R){w(R);let{ex:N,ey:Z,ez:ne}=this,{ex:q,ey:ge,ez:ke}=R,le=u(N*ke),De=u(q*ne),et=u(Z*ke),Ye=u(ge*ne);return le===De&&et===Ye}is0(){return this.equals(b.ZERO)}negate(){return new b(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:R}=e,{ex:N,ey:Z,ez:ne}=this,q=u(N*N),ge=u(Z*Z),ke=u(zA*u(ne*ne)),le=u(R*q),De=N+Z,et=u(u(De*De)-q-ge),Ye=le+ge,pt=Ye-ke,bt=le-ge,Rt=u(et*pt),Et=u(Ye*bt),mr=u(et*bt),Qn=u(pt*Ye);return new b(Rt,Et,Qn,mr)}add(R){w(R);let{a:N,d:Z}=e,{ex:ne,ey:q,ez:ge,et:ke}=this,{ex:le,ey:De,ez:et,et:Ye}=R,pt=u(ne*le),bt=u(q*De),Rt=u(ke*Z*Ye),Et=u(ge*et),mr=u((ne+q)*(le+De)-pt-bt),Qn=Et-Rt,ds=Et+Rt,gh=u(bt-N*pt),Xm=u(mr*Qn),Ym=u(ds*gh),Qm=u(mr*gh),Zm=u(Qn*ds);return new b(Xm,Ym,Zm,Qm)}subtract(R){return this.add(R.negate())}wNAF(R){return D.wNAFCached(this,R,b.normalizeZ)}multiply(R){let N=R;en("scalar",N,pn,n);let{p:Z,f:ne}=this.wNAF(N);return b.normalizeZ([Z,ne])[0]}multiplyUnsafe(R,N=b.ZERO){let Z=R;return en("scalar",Z,$o,n),Z===$o?T:this.is0()||Z===pn?this:D.wNAFCachedUnsafe(this,Z,b.normalizeZ,N)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return D.unsafeLadder(this,n).is0()}toAffine(R){return x(this,R)}clearCofactor(){let{h:R}=e;return R===pn?this:this.multiplyUnsafe(R)}static fromHex(R,N=!1){let{d:Z,a:ne}=e,q=t.BYTES;R=At("pointHex",R,q),Uo("zip215",N);let ge=R.slice(),ke=R[q-1];ge[q-1]=ke&-129;let le=Fo(ge),De=N?l:t.ORDER;en("pointHex.y",le,$o,De);let et=u(le*le),Ye=u(et-pn),pt=u(Z*et-ne),{isValid:bt,value:Rt}=h(Ye,pt);if(!bt)throw new Error("Point.fromHex: invalid y coordinate");let Et=(Rt&pn)===pn,mr=(ke&128)!==0;if(!N&&Rt===$o&&mr)throw new Error("Point.fromHex: x=0 and x_0=1");return mr!==Et&&(Rt=u(-Rt)),b.fromAffine({x:Rt,y:le})}static fromPrivateKey(R){let{scalar:N}=k(R);return S.multiply(N)}toRawBytes(){let{x:R,y:N}=this.toAffine(),Z=wa(N,t.BYTES);return Z[Z.length-1]|=R&pn?128:0,Z}toHex(){return ya(this.toRawBytes())}}b.BASE=new b(e.Gx,e.Gy,pn,u(e.Gx*e.Gy)),b.ZERO=new b($o,pn,pn,$o);let{BASE:S,ZERO:T}=b,D=z0(b,a*8);function A(M){return st(M,n)}function I(M){return A(Fo(M))}function k(M){let R=t.BYTES;M=At("private key",M,R);let N=At("hashed private key",o(M),2*R),Z=d(N.slice(0,R)),ne=N.slice(R,2*R),q=I(Z);return{head:Z,prefix:ne,scalar:q}}function Q(M){let{head:R,prefix:N,scalar:Z}=k(M),ne=S.multiply(Z),q=ne.toRawBytes();return{head:R,prefix:N,scalar:Z,point:ne,pointBytes:q}}function K(M){return Q(M).pointBytes}function V(M=Uint8Array.of(),...R){let N=xa(...R);return I(o(m(N,At("context",M),!!i)))}function X(M,R,N={}){M=At("message",M),i&&(M=i(M));let{prefix:Z,scalar:ne,pointBytes:q}=Q(R),ge=V(N.context,Z,M),ke=S.multiply(ge).toRawBytes(),le=V(N.context,ke,q,M),De=A(ge+le*ne);en("signature.s",De,$o,n);let et=xa(ke,wa(De,t.BYTES));return At("result",et,t.BYTES*2)}let $=yV;function F(M,R,N,Z=$){let{context:ne,zip215:q}=Z,ge=t.BYTES;M=At("signature",M,2*ge),R=At("message",R),N=At("publicKey",N,ge),q!==void 0&&Uo("zip215",q),i&&(R=i(R));let ke=Fo(M.slice(ge,2*ge)),le,De,et;try{le=b.fromHex(N,q),De=b.fromHex(M.slice(0,ge),q),et=S.multiplyUnsafe(ke)}catch{return!1}if(!q&&le.isSmallOrder())return!1;let Ye=V(ne,De.toRawBytes(),le.toRawBytes(),R);return De.add(le.multiplyUnsafe(Ye)).subtract(et).clearCofactor().equals(b.ZERO)}return S._setWindowSize(8),{CURVE:e,getPublicKey:K,sign:X,verify:F,ExtendedPoint:b,utils:{getExtendedPublicKey:Q,randomPrivateKey:()=>s(t.BYTES),precompute(M=8,R=b.BASE){return R._setWindowSize(M),R.multiply(BigInt(3)),R}}}}var uf=BigInt(0),Bw=BigInt(1);function xV(r){return to(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function qA(r){let e=xV(r),{P:t}=e,n=ro(t),i=b=>st(b,t),o=e.montgomeryBits,s=Math.ceil(o/8),a=e.nByteLength,c=e.adjustScalarBytes||(b=>b),l=e.powPminus2||(b=>n.pow(b,t-BigInt(2)));function u(b,S,T){let D=i(b*(S-T));return S=i(S-D),T=i(T+D),[S,T]}let f=(e.a-BigInt(2))/BigInt(4);function h(b,S){en("u",b,uf,t),en("scalar",S,uf,t);let T=S,D=b,A=Bw,I=uf,k=b,Q=Bw,K=uf,V;for(let $=BigInt(o-1);$>=uf;$--){let F=T>>$&Bw;K^=F,V=u(K,A,k),A=V[0],k=V[1],V=u(K,I,Q),I=V[0],Q=V[1],K=F;let z=A+I,M=i(z*z),R=A-I,N=i(R*R),Z=M-N,ne=k+Q,q=k-Q,ge=i(q*z),ke=i(ne*R),le=ge+ke,De=ge-ke;k=i(le*le),Q=i(D*i(De*De)),A=i(M*N),I=i(Z*(M+i(f*Z)))}V=u(K,A,k),A=V[0],k=V[1],V=u(K,I,Q),I=V[0],Q=V[1];let X=l(I);return i(A*X)}function d(b){return wa(i(b),s)}function m(b){let S=At("u coordinate",b,s);return a===32&&(S[31]&=127),Fo(S)}function g(b){let S=At("scalar",b),T=S.length;if(T!==s&&T!==a){let D=""+s+" or "+a;throw new Error("invalid scalar, expected "+D+" bytes, got "+T)}return Fo(c(S))}function w(b,S){let T=m(S),D=g(b),A=h(T,D);if(A===uf)throw new Error("invalid private or public key received");return d(A)}let x=d(e.Gu);function v(b){return w(b,x)}return{scalarMult:w,scalarMultBase:v,getSharedSecret:(b,S)=>w(b,S),getPublicKey:b=>v(b),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:x}}var Bh=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),jA=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),lse=BigInt(0),bV=BigInt(1),WA=BigInt(2),vV=BigInt(3),EV=BigInt(5),SV=BigInt(8);function XA(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),i=BigInt(80),o=Bh,a=r*r%o*r%o,c=Ct(a,WA,o)*a%o,l=Ct(c,bV,o)*r%o,u=Ct(l,EV,o)*l%o,f=Ct(u,e,o)*u%o,h=Ct(f,t,o)*f%o,d=Ct(h,n,o)*h%o,m=Ct(d,i,o)*d%o,g=Ct(m,i,o)*d%o,w=Ct(g,e,o)*u%o;return{pow_p_5_8:Ct(w,WA,o)*r%o,b2:a}}function YA(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function AV(r,e){let t=Bh,n=st(e*e*e,t),i=st(n*n*e,t),o=XA(r*i).pow_p_5_8,s=st(r*n*o,t),a=st(e*s*s,t),c=s,l=st(s*jA,t),u=a===r,f=a===st(-r,t),h=a===st(-r*jA,t);return u&&(s=c),(f||h)&&(s=l),BA(s,t)&&(s=st(-s,t)),{isValid:u||f,value:s}}var GA=ro(Bh,void 0,!0),_V={a:GA.create(BigInt(-1)),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:GA,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:SV,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:$0,randomBytes:Kc,adjustScalarBytes:YA,uvRatio:AV},Mh=KA(_V);var Uh=qA({P:Bh,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{let e=Bh,{pow_p_5_8:t,b2:n}=XA(r);return st(Ct(t,vV,e)*n,e)},adjustScalarBytes:YA,randomBytes:Kc});var Zc=32,_i=64,Mw=32;function QA(){let r=Mh.utils.randomPrivateKey(),e=Mh.getPublicKey(r);return{privateKey:IV(r,e),publicKey:e}}function ZA(r,e){let t=r.subarray(0,Mw);return Mh.sign(e instanceof Uint8Array?e:e.subarray(),t)}function JA(r,e,t){return Mh.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function IV(r,e){let t=new Uint8Array(_i);for(let n=0;n<Mw;n++)t[n]=r[n],t[Mw+n]=e[n];return t}var Fh=class{type="Ed25519";raw;constructor(e){this.raw=df(e,Zc)}toMultihash(){return cr.digest(lr(this))}toCID(){return W.createV1(114,this.toMultihash())}toString(){return Le.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t){return JA(this.raw,t,e)}},ff=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=df(e,_i),this.publicKey=new Fh(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e){return ZA(this.raw,e)}};function Uw(r){if(r.length>_i){r=df(r,_i+Zc);let n=r.subarray(0,_i),i=r.subarray(_i,r.length);return new ff(n,i)}r=df(r,_i);let e=r.subarray(0,_i),t=r.subarray(Zc);return new ff(e,t)}function Fw(r){return r=df(r,Zc),new Fh(r)}async function t_(){let{privateKey:r,publicKey:e}=QA();return new ff(r,e)}function df(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new U(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var _t;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(_t||(_t={}));var $w;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})($w||($w={}));(function(r){r.codec=()=>St($w)})(_t||(_t={}));var Ho;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=_t.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Ho||(Ho={}));var $h;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),_t.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=_t.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})($h||($h={}));function mn(r){if(isNaN(r)||r<=0)throw new U("random bytes length must be a Number bigger than 0");return Kc(r)}var Hh=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},Vh=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},q0=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var n_={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new q0("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var In=n_;var Kh={};Ft(Kh,{MAX_RSA_KEY_SIZE:()=>Hw,generateRSAKeyPair:()=>Yw,jwkToJWKKeyPair:()=>s_,jwkToPkcs1:()=>PV,jwkToPkix:()=>qw,jwkToRSAPrivateKey:()=>Xw,pkcs1MessageToJwk:()=>zw,pkcs1MessageToRSAPrivateKey:()=>j0,pkcs1ToJwk:()=>kV,pkcs1ToRSAPrivateKey:()=>jw,pkixMessageToJwk:()=>Kw,pkixMessageToRSAPublicKey:()=>Gw,pkixToJwk:()=>RV,pkixToRSAPublicKey:()=>Ww});var Vo=F0;var hf=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Kh.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return W.createV1(114,this._multihash)}toString(){return Le.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t){return o_(this.jwk,t,e)}},zh=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Kh.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e){return i_(this.jwk,e)}};var Hw=8192,Vw=18,TV=1062,CV=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function kV(r){let e=Ai(r);return zw(e)}function zw(r){return{n:H(r[1],"base64url"),e:H(r[2],"base64url"),d:H(r[3],"base64url"),p:H(r[4],"base64url"),q:H(r[5],"base64url"),dp:H(r[6],"base64url"),dq:H(r[7],"base64url"),qi:H(r[8],"base64url"),kty:"RSA"}}function PV(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new U("JWK was missing components");return Ji([dn(Uint8Array.from([0])),dn(O(r.n,"base64url")),dn(O(r.e,"base64url")),dn(O(r.d,"base64url")),dn(O(r.p,"base64url")),dn(O(r.q,"base64url")),dn(O(r.dp,"base64url")),dn(O(r.dq,"base64url")),dn(O(r.qi,"base64url"))]).subarray()}function RV(r){let e=Ai(r,{offset:0});return Kw(e)}function Kw(r){let e=Ai(r[1],{offset:0});return{kty:"RSA",n:H(e[0],"base64url"),e:H(e[1],"base64url")}}function qw(r){if(r.n==null||r.e==null)throw new U("JWK was missing components");return Ji([CV,kh(Ji([dn(O(r.n,"base64url")),dn(O(r.e,"base64url"))]))]).subarray()}function jw(r){let e=Ai(r);return j0(e)}function j0(r){let e=zw(r);return Xw(e)}function Ww(r,e){if(r.byteLength>=TV)throw new hs("Key size is too large");let t=Ai(r,{offset:0});return Gw(t,r,e)}function Gw(r,e,t){let n=Kw(r);if(t==null){let i=Vo(Ho.encode({Type:_t.RSA,Data:e}));t=Zr(Vw,i)}return new hf(n,t)}function Xw(r){if(c_(r)>Hw)throw new U("Key size is too large");let e=s_(r),t=Vo(Ho.encode({Type:_t.RSA,Data:qw(e.publicKey)})),n=Zr(Vw,t);return new zh(e.privateKey,new hf(e.publicKey,n))}async function Yw(r){if(r>Hw)throw new U("Key size is too large");let e=await a_(r),t=Vo(Ho.encode({Type:_t.RSA,Data:qw(e.publicKey)})),n=Zr(Vw,t);return new zh(e.privateKey,new hf(e.publicKey,n))}function s_(r){if(r==null)throw new U("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function a_(r){let e=await In.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await DV(e);return{privateKey:t[0],publicKey:t[1]}}async function i_(r,e){let t=await In.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await In.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function o_(r,e,t){let n=await In.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return In.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function DV(r){if(r.privateKey==null||r.publicKey==null)throw new U("Private and public key are required");return Promise.all([In.get().subtle.exportKey("jwk",r.privateKey),In.get().subtle.exportKey("jwk",r.publicKey)])}function c_(r){if(r.kty!=="RSA")throw new U("invalid key type");if(r.n==null)throw new U("invalid key modulus");return O(r.n,"base64url").length*8}var W0=class extends sf{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Vc(e);let n=ha(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let i=this.blockLen,o=new Uint8Array(i);o.set(n.length>i?e.create().update(n).digest():n);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=e.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),Jr(o)}update(e){return af(this),this.iHash.update(e),this}digestInto(e){af(this),da(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:i,destroyed:o,blockLen:s,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=o,e.blockLen=s,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ba=(r,e,t)=>new W0(r,e).update(t).digest();ba.create=(r,e)=>new W0(r,e);function l_(r){r.lowS!==void 0&&Uo("lowS",r.lowS),r.prehash!==void 0&&Uo("prehash",r.prehash)}function NV(r){let e=Lh(r);to(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:n,a:i}=e;if(t){if(!n.eql(i,n.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}var Qw=class extends Error{constructor(e=""){super(e)}},xs={Err:Qw,_tlv:{encode:(r,e)=>{let{Err:t}=xs;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,i=Nh(n);if(i.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?Nh(i.length/2|128):"";return Nh(r)+o+i+e},decode(r,e){let{Err:t}=xs,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let i=e[n++],o=!!(i&128),s=0;if(!o)s=i;else{let c=i&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let u of l)s=s<<8|u;if(n+=c,s<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+s);if(a.length!==s)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+s)}}},_int:{encode(r){let{Err:e}=xs;if(r<bs)throw new e("integer: negative integers are not allowed");let t=Nh(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=xs;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return ws(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=xs,i=At("signature",r),{v:o,l:s}=n.decode(48,i);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){let{_tlv:e,_int:t}=xs,n=e.encode(2,t.encode(r.r)),i=e.encode(2,t.encode(r.s)),o=n+i;return e.encode(48,o)}},bs=BigInt(0),Ar=BigInt(1),sae=BigInt(2),u_=BigInt(3),aae=BigInt(4);function OV(r){let e=NV(r),{Fp:t}=e,n=ro(e.n,e.nBitLength),i=e.toBytes||((g,w,x)=>{let v=w.toAffine();return xa(Uint8Array.from([4]),t.toBytes(v.x),t.toBytes(v.y))}),o=e.fromBytes||(g=>{let w=g.subarray(1),x=t.fromBytes(w.subarray(0,t.BYTES)),v=t.fromBytes(w.subarray(t.BYTES,2*t.BYTES));return{x,y:v}});function s(g){let{a:w,b:x}=e,v=t.sqr(g),b=t.mul(v,g);return t.add(t.add(b,t.mul(g,w)),x)}if(!t.eql(t.sqr(e.Gy),s(e.Gx)))throw new Error("bad generator point: equation left != right");function a(g){return H0(g,Ar,e.n)}function c(g){let{allowedPrivateKeyLengths:w,nByteLength:x,wrapPrivateKey:v,n:b}=e;if(w&&typeof g!="bigint"){if(Gc(g)&&(g=ya(g)),typeof g!="string"||!w.includes(g.length))throw new Error("invalid private key");g=g.padStart(x*2,"0")}let S;try{S=typeof g=="bigint"?g:ws(At("private key",g,x))}catch{throw new Error("invalid private key, expected hex or "+x+" bytes, got "+typeof g)}return v&&(S=st(S,b)),en("private key",S,Ar,b),S}function l(g){if(!(g instanceof h))throw new Error("ProjectivePoint expected")}let u=cf((g,w)=>{let{px:x,py:v,pz:b}=g;if(t.eql(b,t.ONE))return{x,y:v};let S=g.is0();w==null&&(w=S?t.ONE:t.inv(b));let T=t.mul(x,w),D=t.mul(v,w),A=t.mul(b,w);if(S)return{x:t.ZERO,y:t.ZERO};if(!t.eql(A,t.ONE))throw new Error("invZ was invalid");return{x:T,y:D}}),f=cf(g=>{if(g.is0()){if(e.allowInfinityPoint&&!t.is0(g.py))return;throw new Error("bad point: ZERO")}let{x:w,y:x}=g.toAffine();if(!t.isValid(w)||!t.isValid(x))throw new Error("bad point: x or y not FE");let v=t.sqr(x),b=s(w);if(!t.eql(v,b))throw new Error("bad point: equation left != right");if(!g.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class h{constructor(w,x,v){if(w==null||!t.isValid(w))throw new Error("x required");if(x==null||!t.isValid(x)||t.is0(x))throw new Error("y required");if(v==null||!t.isValid(v))throw new Error("z required");this.px=w,this.py=x,this.pz=v,Object.freeze(this)}static fromAffine(w){let{x,y:v}=w||{};if(!w||!t.isValid(x)||!t.isValid(v))throw new Error("invalid affine point");if(w instanceof h)throw new Error("projective point not allowed");let b=S=>t.eql(S,t.ZERO);return b(x)&&b(v)?h.ZERO:new h(x,v,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(w){let x=lf(t,w.map(v=>v.pz));return w.map((v,b)=>v.toAffine(x[b])).map(h.fromAffine)}static fromHex(w){let x=h.fromAffine(o(At("pointHex",w)));return x.assertValidity(),x}static fromPrivateKey(w){return h.BASE.multiply(c(w))}static msm(w,x){return K0(h,n,w,x)}_setWindowSize(w){m.setWindowSize(this,w)}assertValidity(){f(this)}hasEvenY(){let{y:w}=this.toAffine();if(t.isOdd)return!t.isOdd(w);throw new Error("Field doesn't support isOdd")}equals(w){l(w);let{px:x,py:v,pz:b}=this,{px:S,py:T,pz:D}=w,A=t.eql(t.mul(x,D),t.mul(S,b)),I=t.eql(t.mul(v,D),t.mul(T,b));return A&&I}negate(){return new h(this.px,t.neg(this.py),this.pz)}double(){let{a:w,b:x}=e,v=t.mul(x,u_),{px:b,py:S,pz:T}=this,D=t.ZERO,A=t.ZERO,I=t.ZERO,k=t.mul(b,b),Q=t.mul(S,S),K=t.mul(T,T),V=t.mul(b,S);return V=t.add(V,V),I=t.mul(b,T),I=t.add(I,I),D=t.mul(w,I),A=t.mul(v,K),A=t.add(D,A),D=t.sub(Q,A),A=t.add(Q,A),A=t.mul(D,A),D=t.mul(V,D),I=t.mul(v,I),K=t.mul(w,K),V=t.sub(k,K),V=t.mul(w,V),V=t.add(V,I),I=t.add(k,k),k=t.add(I,k),k=t.add(k,K),k=t.mul(k,V),A=t.add(A,k),K=t.mul(S,T),K=t.add(K,K),k=t.mul(K,V),D=t.sub(D,k),I=t.mul(K,Q),I=t.add(I,I),I=t.add(I,I),new h(D,A,I)}add(w){l(w);let{px:x,py:v,pz:b}=this,{px:S,py:T,pz:D}=w,A=t.ZERO,I=t.ZERO,k=t.ZERO,Q=e.a,K=t.mul(e.b,u_),V=t.mul(x,S),X=t.mul(v,T),$=t.mul(b,D),F=t.add(x,v),z=t.add(S,T);F=t.mul(F,z),z=t.add(V,X),F=t.sub(F,z),z=t.add(x,b);let M=t.add(S,D);return z=t.mul(z,M),M=t.add(V,$),z=t.sub(z,M),M=t.add(v,b),A=t.add(T,D),M=t.mul(M,A),A=t.add(X,$),M=t.sub(M,A),k=t.mul(Q,z),A=t.mul(K,$),k=t.add(A,k),A=t.sub(X,k),k=t.add(X,k),I=t.mul(A,k),X=t.add(V,V),X=t.add(X,V),$=t.mul(Q,$),z=t.mul(K,z),X=t.add(X,$),$=t.sub(V,$),$=t.mul(Q,$),z=t.add(z,$),V=t.mul(X,z),I=t.add(I,V),V=t.mul(M,z),A=t.mul(F,A),A=t.sub(A,V),V=t.mul(F,X),k=t.mul(M,k),k=t.add(k,V),new h(A,I,k)}subtract(w){return this.add(w.negate())}is0(){return this.equals(h.ZERO)}wNAF(w){return m.wNAFCached(this,w,h.normalizeZ)}multiplyUnsafe(w){let{endo:x,n:v}=e;en("scalar",w,bs,v);let b=h.ZERO;if(w===bs)return b;if(this.is0()||w===Ar)return this;if(!x||m.hasPrecomputes(this))return m.wNAFCachedUnsafe(this,w,h.normalizeZ);let{k1neg:S,k1:T,k2neg:D,k2:A}=x.splitScalar(w),I=b,k=b,Q=this;for(;T>bs||A>bs;)T&Ar&&(I=I.add(Q)),A&Ar&&(k=k.add(Q)),Q=Q.double(),T>>=Ar,A>>=Ar;return S&&(I=I.negate()),D&&(k=k.negate()),k=new h(t.mul(k.px,x.beta),k.py,k.pz),I.add(k)}multiply(w){let{endo:x,n:v}=e;en("scalar",w,Ar,v);let b,S;if(x){let{k1neg:T,k1:D,k2neg:A,k2:I}=x.splitScalar(w),{p:k,f:Q}=this.wNAF(D),{p:K,f:V}=this.wNAF(I);k=m.constTimeNegate(T,k),K=m.constTimeNegate(A,K),K=new h(t.mul(K.px,x.beta),K.py,K.pz),b=k.add(K),S=Q.add(V)}else{let{p:T,f:D}=this.wNAF(w);b=T,S=D}return h.normalizeZ([b,S])[0]}multiplyAndAddUnsafe(w,x,v){let b=h.BASE,S=(D,A)=>A===bs||A===Ar||!D.equals(b)?D.multiplyUnsafe(A):D.multiply(A),T=S(this,x).add(S(w,v));return T.is0()?void 0:T}toAffine(w){return u(this,w)}isTorsionFree(){let{h:w,isTorsionFree:x}=e;if(w===Ar)return!0;if(x)return x(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:w,clearCofactor:x}=e;return w===Ar?this:x?x(h,this):this.multiplyUnsafe(e.h)}toRawBytes(w=!0){return Uo("isCompressed",w),this.assertValidity(),i(h,this,w)}toHex(w=!0){return Uo("isCompressed",w),ya(this.toRawBytes(w))}}h.BASE=new h(e.Gx,e.Gy,t.ONE),h.ZERO=new h(t.ZERO,t.ONE,t.ZERO);let d=e.nBitLength,m=z0(h,e.endo?Math.ceil(d/2):d);return{CURVE:e,ProjectivePoint:h,normPrivateKeyToScalar:c,weierstrassEquation:s,isWithinCurveOrder:a}}function LV(r){let e=Lh(r);return to(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function f_(r){let e=LV(r),{Fp:t,n}=e,i=t.BYTES+1,o=2*t.BYTES+1;function s($){return st($,n)}function a($){return V0($,n)}let{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:u,isWithinCurveOrder:f}=OV({...e,toBytes($,F,z){let M=F.toAffine(),R=t.toBytes(M.x),N=xa;return Uo("isCompressed",z),z?N(Uint8Array.from([F.hasEvenY()?2:3]),R):N(Uint8Array.from([4]),R,t.toBytes(M.y))},fromBytes($){let F=$.length,z=$[0],M=$.subarray(1);if(F===i&&(z===2||z===3)){let R=ws(M);if(!H0(R,Ar,t.ORDER))throw new Error("Point is not on curve");let N=u(R),Z;try{Z=t.sqrt(N)}catch(ge){let ke=ge instanceof Error?": "+ge.message:"";throw new Error("Point is not on curve"+ke)}let ne=(Z&Ar)===Ar;return(z&1)===1!==ne&&(Z=t.neg(Z)),{x:R,y:Z}}else if(F===o&&z===4){let R=t.fromBytes(M.subarray(0,t.BYTES)),N=t.fromBytes(M.subarray(t.BYTES,2*t.BYTES));return{x:R,y:N}}else{let R=i,N=o;throw new Error("invalid Point, expected length of "+R+", or uncompressed "+N+", got "+F)}}}),h=$=>ya(Xc($,e.nByteLength));function d($){let F=n>>Ar;return $>F}function m($){return d($)?s(-$):$}let g=($,F,z)=>ws($.slice(F,z));class w{constructor(F,z,M){en("r",F,Ar,n),en("s",z,Ar,n),this.r=F,this.s=z,M!=null&&(this.recovery=M),Object.freeze(this)}static fromCompact(F){let z=e.nByteLength;return F=At("compactSignature",F,z*2),new w(g(F,0,z),g(F,z,2*z))}static fromDER(F){let{r:z,s:M}=xs.toSig(At("DER",F));return new w(z,M)}assertValidity(){}addRecoveryBit(F){return new w(this.r,this.s,F)}recoverPublicKey(F){let{r:z,s:M,recovery:R}=this,N=D(At("msgHash",F));if(R==null||![0,1,2,3].includes(R))throw new Error("recovery id invalid");let Z=R===2||R===3?z+e.n:z;if(Z>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let ne=(R&1)===0?"02":"03",q=c.fromHex(ne+h(Z)),ge=a(Z),ke=s(-N*ge),le=s(M*ge),De=c.BASE.multiplyAndAddUnsafe(q,ke,le);if(!De)throw new Error("point at infinify");return De.assertValidity(),De}hasHighS(){return d(this.s)}normalizeS(){return this.hasHighS()?new w(this.r,s(-this.s),this.recovery):this}toDERRawBytes(){return Oh(this.toDERHex())}toDERHex(){return xs.hexFromSig(this)}toCompactRawBytes(){return Oh(this.toCompactHex())}toCompactHex(){return h(this.r)+h(this.s)}}let x={isValidPrivateKey($){try{return l($),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{let $=Pw(e.n);return UA(e.randomBytes($),e.n)},precompute($=8,F=c.BASE){return F._setWindowSize($),F.multiply(BigInt(3)),F}};function v($,F=!0){return c.fromPrivateKey($).toRawBytes(F)}function b($){let F=Gc($),z=typeof $=="string",M=(F||z)&&$.length;return F?M===i||M===o:z?M===2*i||M===2*o:$ instanceof c}function S($,F,z=!0){if(b($))throw new Error("first arg must be private key");if(!b(F))throw new Error("second arg must be public key");return c.fromHex(F).multiply(l($)).toRawBytes(z)}let T=e.bits2int||function($){if($.length>8192)throw new Error("input is too large");let F=ws($),z=$.length*8-e.nBitLength;return z>0?F>>BigInt(z):F},D=e.bits2int_modN||function($){return s(T($))},A=Yc(e.nBitLength);function I($){return en("num < 2^"+e.nBitLength,$,bs,A),Xc($,e.nByteLength)}function k($,F,z=Q){if(["recovered","canonical"].some(Ye=>Ye in z))throw new Error("sign() legacy options not supported");let{hash:M,randomBytes:R}=e,{lowS:N,prehash:Z,extraEntropy:ne}=z;N==null&&(N=!0),$=At("msgHash",$),l_(z),Z&&($=At("prehashed msgHash",M($)));let q=D($),ge=l(F),ke=[I(ge),I(q)];if(ne!=null&&ne!==!1){let Ye=ne===!0?R(t.BYTES):ne;ke.push(At("extraEntropy",Ye))}let le=xa(...ke),De=q;function et(Ye){let pt=T(Ye);if(!f(pt))return;let bt=a(pt),Rt=c.BASE.multiply(pt).toAffine(),Et=s(Rt.x);if(Et===bs)return;let mr=s(bt*s(De+Et*ge));if(mr===bs)return;let Qn=(Rt.x===Et?0:2)|Number(Rt.y&Ar),ds=mr;return N&&d(mr)&&(ds=m(mr),Qn^=1),new w(Et,ds,Qn)}return{seed:le,k2sig:et}}let Q={lowS:e.lowS,prehash:!1},K={lowS:e.lowS,prehash:!1};function V($,F,z=Q){let{seed:M,k2sig:R}=k($,F,z),N=e;return DA(N.hash.outputLen,N.nByteLength,N.hmac)(M,R)}c.BASE._setWindowSize(8);function X($,F,z,M=K){let R=$;F=At("msgHash",F),z=At("publicKey",z);let{lowS:N,prehash:Z,format:ne}=M;if(l_(M),"strict"in M)throw new Error("options.strict was renamed to lowS");if(ne!==void 0&&ne!=="compact"&&ne!=="der")throw new Error("format must be compact or der");let q=typeof R=="string"||Gc(R),ge=!q&&!ne&&typeof R=="object"&&R!==null&&typeof R.r=="bigint"&&typeof R.s=="bigint";if(!q&&!ge)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let ke,le;try{if(ge&&(ke=new w(R.r,R.s)),q){try{ne!=="compact"&&(ke=w.fromDER(R))}catch(Qn){if(!(Qn instanceof xs.Err))throw Qn}!ke&&ne!=="der"&&(ke=w.fromCompact(R))}le=c.fromHex(z)}catch{return!1}if(!ke||N&&ke.hasHighS())return!1;Z&&(F=e.hash(F));let{r:De,s:et}=ke,Ye=D(F),pt=a(et),bt=s(Ye*pt),Rt=s(De*pt),Et=c.BASE.multiplyAndAddUnsafe(le,bt,Rt)?.toAffine();return Et?s(Et.x)===De:!1}return{CURVE:e,getPublicKey:v,getSharedSecret:S,sign:V,verify:X,ProjectivePoint:c,Signature:w,utils:x}}function BV(r){return{hash:r,hmac:(e,...t)=>ba(r,e,xw(...t)),randomBytes:Kc}}function d_(r,e){let t=n=>f_({...r,...BV(n)});return{...t(e),create:t}}var m_=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),h_=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),MV=BigInt(1),Zw=BigInt(2),p_=(r,e)=>(r+e/Zw)/e;function UV(r){let e=m_,t=BigInt(3),n=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=Ct(u,t,e)*u%e,h=Ct(f,t,e)*u%e,d=Ct(h,Zw,e)*l%e,m=Ct(d,i,e)*d%e,g=Ct(m,o,e)*m%e,w=Ct(g,a,e)*g%e,x=Ct(w,c,e)*w%e,v=Ct(x,a,e)*g%e,b=Ct(v,t,e)*u%e,S=Ct(b,s,e)*m%e,T=Ct(S,n,e)*l%e,D=Ct(T,Zw,e);if(!Jw.eql(Jw.sqr(D),r))throw new Error("Cannot find square root");return D}var Jw=ro(m_,void 0,void 0,{sqrt:UV}),Ii=d_({a:BigInt(0),b:BigInt(7),Fp:Jw,n:h_,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let e=h_,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-MV*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=t,s=BigInt("0x100000000000000000000000000000000"),a=p_(o*r,e),c=p_(-n*r,e),l=st(r-a*t-c*i,e),u=st(-a*n-c*o,e),f=l>s,h=u>s;if(f&&(l=e-l),h&&(u=e-u),l>s||u>s)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}}},F0),gae=BigInt(0);var yae=Ii.ProjectivePoint;function e7(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var g_=32;function y_(r,e){let t=Fe.digest(e instanceof Uint8Array?e:e.subarray());if(e7(t))return t.then(({digest:n})=>Ii.sign(n,r).toDERRawBytes()).catch(n=>{throw new Hh(String(n))});try{return Ii.sign(t.digest,r).toDERRawBytes()}catch(n){throw new Hh(String(n))}}function w_(r,e,t){let n=Fe.digest(t instanceof Uint8Array?t:t.subarray());if(e7(n))return n.then(({digest:i})=>Ii.verify(e,i,r)).catch(i=>{throw new Vh(String(i))});try{return Ii.verify(e,n.digest,r)}catch(i){throw new Vh(String(i))}}var qh=class{type="secp256k1";raw;_key;constructor(e){this._key=v_(e),this.raw=x_(this._key)}toMultihash(){return cr.digest(lr(this))}toCID(){return W.createV1(114,this.toMultihash())}toString(){return Le.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t){return w_(this._key,t,e)}},jh=class{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=b_(e),this.publicKey=new qh(t??E_(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e){return y_(this.raw,e)}};function t7(r){return new jh(r)}function r7(r){return new qh(r)}async function S_(){let r=FV();return new jh(r)}function x_(r){return Ii.ProjectivePoint.fromHex(r).toRawBytes(!0)}function b_(r){try{return Ii.getPublicKey(r,!0),r}catch(e){throw new wh(String(e))}}function v_(r){try{return Ii.ProjectivePoint.fromHex(r),r}catch(e){throw new hs(String(e))}}function E_(r){try{return Ii.getPublicKey(r,!0)}catch(e){throw new wh(String(e))}}function FV(){return Ii.utils.randomPrivateKey()}async function pf(r,e){if(r==="Ed25519")return t_();if(r==="secp256k1")return S_();if(r==="RSA")return Yw($V(e));if(r==="ECDSA")return pA(HV(e));throw new Xi}function tr(r,e){let{Type:t,Data:n}=Ho.decode(r),i=n??new Uint8Array;switch(t){case _t.RSA:return Ww(i,e);case _t.Ed25519:return Fw(i);case _t.secp256k1:return r7(i);case _t.ECDSA:return gw(i);default:throw new Xi}}function G0(r){let{Type:e,Data:t}=Ho.decode(r.digest),n=t??new Uint8Array;switch(e){case _t.Ed25519:return Fw(n);case _t.secp256k1:return r7(n);case _t.ECDSA:return gw(n);default:throw new Xi}}function lr(r){return Ho.encode({Type:_t[r.type],Data:r.raw})}function A_(r){let e=$h.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case _t.RSA:return jw(t);case _t.Ed25519:return Uw(t);case _t.secp256k1:return t7(t);case _t.ECDSA:return lA(t);default:throw new Xi}}function __(r){if(r.byteLength===_i)return Uw(r);if(r.byteLength===g_)return t7(r);let e=Ai(r),t=e[2]?.[0];if(t===eA||t===tA||t===rA)return mw(e);if(e.length>8)return j0(e);throw new U("Could not extract private key from raw bytes")}function Jc(r){return $h.encode({Type:_t[r.type],Data:r.raw})}function $V(r){return r==null?2048:parseInt(r,10)}function HV(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new U("Unsupported curve, should be P-256, P-384 or P-521")}async function X0(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new U("Only RSA and ECDSA keys are supported")}var I_=Symbol.for("nodejs.util.inspect.custom"),VV=114,Wh=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[e0]=!0;toString(){return this.string==null&&(this.string=Le.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return W.createV1(VV,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[I_](){return`PeerId(${this.toString()})`}},Gh=class extends Wh{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Xh=class extends Wh{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},Yh=class extends Wh{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},zV=2336,Qh=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=cr.digest(O(this.url))}[I_](){return`PeerId(${this.url})`}[e0]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return W.createV1(zV,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=H(e)),e.toString()===this.toString())}};var KV=114,T_=2336;function at(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=Ue(Le.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return gn(W.parse(r));if(e==null)throw new U('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=Ue(e.decode(r))}return ur(t)}function zo(r){if(r.type==="Ed25519")return new Xh({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new Yh({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new Gh({multihash:r.toCID().multihash,publicKey:r});throw new Xi}function C_(r){return zo(r.publicKey)}function ur(r){if(jV(r))return new Gh({multihash:r});if(qV(r))try{let e=G0(r);if(e.type==="Ed25519")return new Xh({multihash:r,publicKey:e});if(e.type==="secp256k1")return new Yh({multihash:r,publicKey:e})}catch{let t=H(r.digest);return new Qh(new URL(t))}throw new aa("Supplied PeerID Multihash is invalid")}function gn(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==KV&&r.code!==T_)throw new s0("Supplied PeerID CID is invalid");if(r.code===T_){let e=H(r.multihash.digest);return new Qh(new URL(e))}return ur(r.multihash)}function qV(r){return r.code===cr.code}function jV(r){return r.code===Fe.code}function el(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function Y0(r){let e=Ue(Le.decode(`z${r}`));return ur(e)}var _r=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return el(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return el(this.map.values(),e=>e.key)}values(){return el(this.map.values(),e=>e.value)}get size(){return this.map.size}};var yn=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return el(this.set.entries(),e=>{let t=Y0(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=Y0(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return el(this.set.values(),e=>Y0(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function n7(){return new yn}function k_(r,e,t,n){Vc(r);let i=yA({dkLen:32,asyncTick:10},n),{c:o,dkLen:s,asyncTick:a}=i;if(Bo(o),Bo(s),Bo(a),o<1)throw new Error("iterations (c) should be >= 1");let c=ww(e),l=ww(t),u=new Uint8Array(s),f=ba.create(r,c),h=f._cloneInto().update(l);return{c:o,dkLen:s,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function P_(r,e,t,n,i){return r.destroy(),e.destroy(),n&&n.destroy(),Jr(i),t}function R_(r,e,t,n){let{c:i,dkLen:o,DK:s,PRF:a,PRFSalt:c}=k_(r,e,t,n),l,u=new Uint8Array(4),f=zc(u),h=new Uint8Array(a.outputLen);for(let d=1,m=0;m<o;d++,m+=a.outputLen){let g=s.subarray(m,m+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),g.set(h.subarray(0,g.length));for(let w=1;w<i;w++){a._cloneInto(l).update(h).digestInto(h);for(let x=0;x<g.length;x++)g[x]^=h[x]}}return P_(a,c,s,l,h)}async function Q0(r,e,t,n){let{c:i,dkLen:o,asyncTick:s,DK:a,PRF:c,PRFSalt:l}=k_(r,e,t,n),u,f=new Uint8Array(4),h=zc(f),d=new Uint8Array(c.outputLen);for(let m=1,g=0;g<o;m++,g+=c.outputLen){let w=a.subarray(g,g+c.outputLen);h.setInt32(0,m,!1),(u=l._cloneInto(u)).update(f).digestInto(d),w.set(d.subarray(0,w.length)),await gA(i-1,s,()=>{c._cloneInto(u).update(d).digestInto(d);for(let x=0;x<w.length;x++)w[x]^=d[x]})}return P_(c,l,a,u,d)}var Zh=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),va=new Uint32Array(80),Z0=class extends qc{constructor(){super(64,20,8,!1),this.A=Zh[0]|0,this.B=Zh[1]|0,this.C=Zh[2]|0,this.D=Zh[3]|0,this.E=Zh[4]|0}get(){let{A:e,B:t,C:n,D:i,E:o}=this;return[e,t,n,i,o]}set(e,t,n,i,o){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0}process(e,t){for(let c=0;c<16;c++,t+=4)va[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)va[c]=N0(va[c-3]^va[c-8]^va[c-14]^va[c-16],1);let{A:n,B:i,C:o,D:s,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=O0(i,o,s),u=1518500249):c<40?(l=i^o^s,u=1859775393):c<60?(l=L0(i,o,s),u=2400959708):(l=i^o^s,u=3395469782);let f=N0(n,5)+l+a+u+va[c]|0;a=s,s=o,o=N0(i,30),i=n,n=f}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,this.set(n,i,o,s,a)}roundClean(){Jr(va)}destroy(){this.set(0,0,0,0,0),Jr(this.buffer)}},D_=Ph(()=>new Z0);var N_=D_;var mf=$0;var O_={sha1:N_,"sha2-256":Vo,"sha2-512":mf};function Jh(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){let a=Object.keys(O_).join(" / ");throw new U(`Hash '${i}' is unknown or not supported. Must be ${a}`)}let o=O_[i],s=R_(o,r,e,{c:t,dkLen:n});return ar.encode(s).substring(1)}var i7={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},L_={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},B_=new globalThis.TextEncoder;function WV(r,e){let t=i7[e],n=L_[e];for(let i=0;i<r.length;i++)n^=BigInt(r[i]),n=BigInt.asUintN(e,n*t);return n}function GV(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=i7[e],i=L_[e],o=r;for(;o.length>0;){let s=B_.encodeInto(o,t);o=o.slice(s.read);for(let a=0;a<s.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*n)}return i}function o7(r,{size:e=32,utf8Buffer:t}={}){if(!i7[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return GV(r,e,t);r=B_.encode(r)}return WV(r,e)}var ep={hash:r=>Number(o7(r,{size:32})),hashV:(r,e)=>XV(ep.hash(r,e))};function XV(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),O(e,"base16")}var s7=64,no=class{fp;h;seed;constructor(e,t,n,i=2){if(i>s7)throw new TypeError("Invalid Fingerprint Size");let o=t.hashV(e,n),s=Pe(i);for(let a=0;a<s.length;a++)s[a]=o[a];s.length===0&&(s[0]=7),this.fp=s,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?pe(this.fp,e.fp):!1}};function tl(r,e){return Math.floor(Math.random()*(e-r))+r}var rl=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof no))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof no))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof no))throw new TypeError("Invalid Fingerprint");let t=tl(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof no))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var YV=500,tp=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??ep,this.seed=e.seed??tl(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=O(e));let t=new no(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new rl(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new rl(this.bucketSize)),this.buckets[n].add(t)||this.buckets[i].add(t))return this.count++,!0;let o=[n,i],s=o[tl(0,o.length-1)];this.buckets[s]==null&&(this.buckets[s]=new rl(this.bucketSize));for(let a=0;a<YV;a++){let c=this.buckets[s].swap(t);if(c!=null&&(s=(s^c.hash())%this.filterSize,this.buckets[s]==null&&(this.buckets[s]=new rl(this.bucketSize)),this.buckets[s].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=O(e));let t=new no(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.has(t)??!1;if(i)return i;let o=(n^t.hash())%this.filterSize;return this.buckets[o]?.has(t)??!1}remove(e){typeof e=="string"&&(e=O(e));let t=new no(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.remove(t)??!1;if(i)return this.count--,i;let o=(n^t.hash())%this.filterSize,s=this.buckets[o]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},QV={1:.5,2:.84,4:.95,8:.98};function ZV(r=.001){return r>.002?2:r>1e-5?4:8}function M_(r,e=.001){let t=ZV(e),n=QV[t],i=Math.round(r/n),o=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),s7);return{filterSize:i,bucketSize:t,fingerprintSize:o}}var gf=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??ep,this.seed=e.seed??tl(0,Math.pow(2,10)),this.filterSeries=[new tp({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=O(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new tp({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=O(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=O(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Tn(r,e=.001,t){return new gf({...M_(r,e),...t??{}})}var J0=class{filter;constructor(e,t){this.filter=Tn(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function a7(r,e=.001){return new J0(r,e)}var c7=class extends _r{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function rp(r){let{name:e,metrics:t}=r,n;return t!=null?n=new c7({name:e,metrics:t}):n=new _r,n}var vs=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let n=ar.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){let n=ar.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){let n=ar.encode(e.multihash.bytes);this.blocks.set(n,t)}};function JV(r){let e=new Uint8Array(r.reduce((n,i)=>n+Oe(i),0)),t=0;for(let n of r)e=ht(n,e,t),t+=Oe(n);return e}var U_=JV;function l7(r){return U_([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}var eg=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new vs,n=new Set;for(let[i,o]of this.wants.entries())try{let s=await this.blockstore.get(o.cid,e);o.wantType===er.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",o.cid),n.add(i),t.addBlock(o.cid,{data:s,prefix:l7(o.cid)})):(this.log("sending have for %c",o.cid),t.addBlockPresence(o.cid,{cid:o.cid.bytes,type:Si.HaveBlock})):(this.log("sending block for %c",o.cid),n.add(i),t.addBlock(o.cid,{data:s,prefix:l7(o.cid)}))}catch(s){if(s.name!=="NotFoundError")throw s;if(this.log("do not have block for %c",o.cid),!o.sendDontHave||o.sentDoNotHave===!0)continue;o.sentDoNotHave=!0,t.addBlockPresence(o.cid,{cid:o.cid.bytes,type:Si.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,o)=>i+o.data.byteLength,0));for(let i of n)this.wants.delete(i)}}};var tg=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=rp({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new eg({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((i,o)=>i+o.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(let i of t.wantlist.entries){let o=W.decode(i.cid),s=H(o.multihash.bytes,"base64");i.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),n.wants.delete(s)):(i.wantType===er.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),n.wants.set(s,{cid:o,priority:i.priority,wantType:i.wantType??er.WantBlock,sendDontHave:i.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){let n=H(e.multihash.bytes,"base64"),i=[];for(let o of this.ledgerMap.values())o.wants.has(n)&&i.push(o);await Promise.all(i.map(async o=>o.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};function ez(r,e){try{if(typeof r=="string"&&r.length>0)return tz(r);if(typeof r=="number"&&isFinite(r))return e?.long?nz(r):rz(r);throw new Error("Value is not a string or number.")}catch(t){let n=iz(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function tz(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");let e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;let t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*315576e5;case"weeks":case"week":case"w":return t*6048e5;case"days":case"day":case"d":return t*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return t*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return t*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return t*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}var ng=ez;function rz(r){let e=Math.abs(r);return e>=864e5?`${Math.round(r/864e5)}d`:e>=36e5?`${Math.round(r/36e5)}h`:e>=6e4?`${Math.round(r/6e4)}m`:e>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function nz(r){let e=Math.abs(r);return e>=864e5?rg(r,e,864e5,"day"):e>=36e5?rg(r,e,36e5,"hour"):e>=6e4?rg(r,e,6e4,"minute"):e>=1e3?rg(r,e,1e3,"second"):`${r} ms`}function rg(r,e,t,n){let i=e>=t*1.5;return`${Math.round(r/t)} ${n}${i?"s":""}`}function iz(r){return typeof r=="object"&&r!==null&&"message"in r}function u7(r){t.debug=t,t.default=t,t.coerce=c,t.disable=o,t.enable=i,t.enabled=s,t.humanize=ng,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,m;function g(...w){if(!g.enabled)return;let x=g,v=Number(new Date),b=v-(f||v);x.diff=b,x.prev=f,x.curr=v,f=v,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let S=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(D,A)=>{if(D==="%%")return"%";S++;let I=t.formatters[A];if(typeof I=="function"){let k=w[S];D=I.call(x,k),w.splice(S,1),S--}return D}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(u)),m),set:w=>{h=w}}),typeof t.init=="function"&&t.init(g),g}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function o(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function s(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var ig=fz(),oz=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function sz(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function az(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+ng(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}var cz=console.debug??console.log??(()=>{});function lz(r){try{r?ig?.setItem("debug",r):ig?.removeItem("debug")}catch{}}function uz(){let r;try{r=ig?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function fz(){try{return localStorage}catch{}}function dz(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var F_=u7({formatArgs:az,save:lz,load:uz,useColors:sz,setupFormatters:dz,colors:oz,storage:ig,log:cz});var Cn=F_;Cn.formatters.b=r=>r==null?"undefined":Le.baseEncode(r);Cn.formatters.t=r=>r==null?"undefined":Jt.baseEncode(r);Cn.formatters.m=r=>r==null?"undefined":ar.baseEncode(r);Cn.formatters.p=r=>r==null?"undefined":r.toString();Cn.formatters.c=r=>r==null?"undefined":r.toString();Cn.formatters.k=r=>r==null?"undefined":r.toString();Cn.formatters.a=r=>r==null?"undefined":r.toString();Cn.formatters.e=r=>r==null?"undefined":$_(r.stack)??$_(r.message)??r.toString();function hz(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function H_(r){return{forComponent(e){return ze(`${r}:${e}`)}}}function Ea(){return{forComponent(r){return ze(r)}}}function ze(r){let e=hz(`${r}:trace`);return Cn.enabled(`${r}:trace`)&&Cn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Cn(`${r}:trace`)),Object.assign(Cn(r),{error:Cn(`${r}:error`),trace:e})}function $_(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}var d7=it(z_(),1);var ip=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},h7=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},K_=r=>globalThis.DOMException===void 0?new h7(r):new DOMException(r),q_=r=>{let e=r.reason===void 0?K_("This operation was aborted."):r.reason;return e instanceof Error?e:K_(e)};function io(r,e){let{milliseconds:t,fallback:n,message:i,customTimers:o={setTimeout,clearTimeout}}=e,s,a,l=new Promise((u,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:d}=e;d.aborted&&f(q_(d)),a=()=>{f(q_(d))},d.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,f);return}let h=new ip;s=o.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(d){f(d)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?u():i instanceof Error?f(i):(h.message=i??`Promise timed out after ${t} milliseconds`,f(h))},t),(async()=>{try{u(await r)}catch(d){f(d)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{o.clearTimeout.call(void 0,s),s=void 0},l}function p7(r,e,t){let n=0,i=r.length;for(;i>0;){let o=Math.trunc(i/2),s=n+o;t(r[s],e)<=0?(n=++s,i-=o+1):i=o}return n}var op=class{#e=[];enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}let i=p7(this.#e,n,(o,s)=>s.priority-o.priority);this.#e.splice(i,0,n)}setPriority(e,t){let n=this.#e.findIndex(o=>o.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[i]=this.#e.splice(n,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var kn=class extends d7.default{#e;#r;#n=0;#m;#u;#A=0;#y;#a;#s;#c;#i=0;#t;#l;#w;#p=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:op,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#r=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#m=e.intervalCap,this.#u=e.interval,this.#s=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#w=e.throwOnTimeout===!0,this.#l=e.autoStart===!1}get#f(){return this.#r||this.#n<this.#m}get#b(){return this.#i<this.#t}#d(){this.#i--,this.#g(),this.emit("next")}#v(){this.#_(),this.#x(),this.#a=void 0}get#E(){let e=Date.now();if(this.#y===void 0){let t=this.#A-e;if(t<0)this.#n=this.#e?this.#i:0;else return this.#a===void 0&&(this.#a=setTimeout(()=>{this.#v()},t)),!0}return!1}#g(){if(this.#s.size===0)return this.#y&&clearInterval(this.#y),this.#y=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#l){let e=!this.#E;if(this.#f&&this.#b){let t=this.#s.dequeue();return t?(this.emit("active"),t(),e&&this.#x(),!0):!1}}return!1}#x(){this.#r||this.#y!==void 0||(this.#y=setInterval(()=>{this.#_()},this.#u),this.#A=Date.now()+this.#u)}#_(){this.#n===0&&this.#i===0&&this.#y&&(clearInterval(this.#y),this.#y=void 0),this.#n=this.#e?this.#i:0,this.#h()}#h(){for(;this.#g(););}get concurrency(){return this.#t}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#t=e,this.#h()}async#R(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#s.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#p++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#w,...t},new Promise((n,i)=>{this.#s.enqueue(async()=>{this.#i++,this.#n++;try{t.signal?.throwIfAborted();let o=e({signal:t.signal});t.timeout&&(o=io(Promise.resolve(o),{milliseconds:t.timeout})),t.signal&&(o=Promise.race([o,this.#R(t.signal)]));let s=await o;n(s),this.emit("completed",s)}catch(o){if(o instanceof ip&&!t.throwOnTimeout){n();return}i(o),this.emit("error",o)}finally{this.#d()}},t),this.emit("add"),this.#g()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#l?(this.#l=!1,this.#h(),this):this}pause(){this.#l=!0}clear(){this.#s=new this.#c}async onEmpty(){this.#s.size!==0&&await this.#k("empty")}async onSizeLessThan(e){this.#s.size<e||await this.#k("next",()=>this.#s.size<e)}async onIdle(){this.#i===0&&this.#s.size===0||await this.#k("idle")}async#k(e,t){return new Promise(n=>{let i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})}get size(){return this.#s.size}sizeBy(e){return this.#s.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#l}};function sg(r){let e=[rn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var m7=60;function ag(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:rn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:rn[e.type],TTL:e.TTL??e.ttl??m7,data:e.data instanceof Uint8Array?H(e.data):e.data}))}}var gz=4;function g7(r,e={}){let t=new kn({concurrency:e.queryConcurrency??gz});return async(n,i={})=>{let o=new URLSearchParams;o.set("name",n),sg(i.types).forEach(a=>{o.append("type",rn[a])}),i.onProgress?.(new G("dns:query",{detail:n}));let s=await t.add(async()=>{let a=await fetch(`${r}?${o}`,{headers:{accept:"application/dns-json"},signal:i?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=ag(await a.json());return i.onProgress?.(new G("dns:response",{detail:c})),c},{signal:i.signal});if(s==null)throw new Error("No DNS response received");return s}}function j_(){return[g7("https://cloudflare-dns.com/dns-query"),g7("https://dns.google/resolve")]}var G_=it(y7(),1);var w7=class{lru;constructor(e){this.lru=(0,G_.default)(e)}get(e,t){let n=!0,i=[];for(let o of t){let s=this.getAnswers(e,o);if(s.length===0){n=!1;break}i.push(...s)}if(n)return ag({answers:i})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,i=this.lru.get(n);if(i!=null){let o=i.filter(s=>s.expires>Date.now()).map(({expires:s,value:a})=>({...a,TTL:Math.round((s-Date.now())/1e3),type:rn[a.type]}));return o.length===0&&this.lru.remove(n),o}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(n)??[];i.push({expires:Date.now()+(t.TTL??m7)*1e3,value:t}),this.lru.set(n,i)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function X_(r){return new w7(r)}var yz=1e3,cg=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=X_(e.cacheSize??yz),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=j_())}async query(e,t={}){let n=sg(t.types),i=t.cached!==!1?this.cache.get(e,n):void 0;if(i!=null)return t.onProgress?.(new G("dns:cache",{detail:i})),i;let o=`${e.split(".").pop()}.`,s=(this.resolvers[o]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of s){if(t.signal?.aborted===!0)break;try{let l=await c(e,{...t,types:n});for(let u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new G("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var rn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(rn||(rn={}));function nl(r={}){return new cg(r)}var wz=["string","number","bigint","symbol"],xz=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function Y_(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(wz.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(bz(r))return"Buffer";let t=vz(r);return t||"Object"}function bz(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function vz(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(xz.includes(e))return e}var _=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};_.uint=new _(0,"uint",!0);_.negint=new _(1,"negint",!0);_.bytes=new _(2,"bytes",!0);_.string=new _(3,"string",!0);_.array=new _(4,"array",!1);_.map=new _(5,"map",!1);_.tag=new _(6,"tag",!1);_.float=new _(7,"float",!0);_.false=new _(7,"false",!0);_.true=new _(7,"true",!0);_.null=new _(7,"null",!0);_.undefined=new _(7,"undefined",!0);_.break=new _(7,"break",!0);var Y=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var yf=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",Ez=new TextDecoder,Sz=new TextEncoder;function lg(r){return yf&&globalThis.Buffer.isBuffer(r)}function sp(r){return r instanceof Uint8Array?lg(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var eI=yf?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):Z_(r,e,t):(r,e,t)=>t-e>64?Ez.decode(r.subarray(e,t)):Z_(r,e,t),ug=yf?r=>r.length>64?globalThis.Buffer.from(r):Q_(r):r=>r.length>64?Sz.encode(r):Q_(r),Ko=r=>Uint8Array.from(r),wf=yf?(r,e,t)=>lg(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),tI=yf?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),sp(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},rI=yf?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function nI(r,e){if(lg(r)&&lg(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function Q_(r){let e=[],t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function Z_(r,e,t){let n=[];for(;e<t;){let i=r[e],o=null,s=i>239?4:i>223?3:i>191?2:1;if(e+s<=t){let a,c,l,u;switch(s){case 1:i<128&&(o=i);break;case 2:a=r[e+1],(a&192)===128&&(u=(i&31)<<6|a&63,u>127&&(o=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(i&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(o=u))}}o===null?(o=65533,s=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|o&1023),n.push(o),e+=s}return x7(n)}var J_=4096;function x7(r){let e=r.length;if(e<=J_)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=J_));return t}var Az=256,ap=class{constructor(e=Az){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){let i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=rI(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=wf(n,0,this.cursor)}else t=tI(this.chunks,this.cursor);return e&&this.reset(),t}};var me="CBOR decode error:",Es="CBOR encode error:",cp=[];cp[23]=1;cp[24]=2;cp[25]=3;cp[26]=5;cp[27]=9;function Ss(r,e,t){if(r.length-e<t)throw new Error(`${me} not enough data for type`)}var Ir=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ri(r,e,t){Ss(r,e,1);let n=r[e];if(t.strict===!0&&n<Ir[0])throw new Error(`${me} integer encoded in more bytes than necessary (strict decode)`);return n}function ni(r,e,t){Ss(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Ir[1])throw new Error(`${me} integer encoded in more bytes than necessary (strict decode)`);return n}function ii(r,e,t){Ss(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Ir[2])throw new Error(`${me} integer encoded in more bytes than necessary (strict decode)`);return n}function oi(r,e,t){Ss(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],o=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&o<Ir[3])throw new Error(`${me} integer encoded in more bytes than necessary (strict decode)`);if(o<=Number.MAX_SAFE_INTEGER)return Number(o);if(t.allowBigInt===!0)return o;throw new Error(`${me} integers outside of the safe integer range are not supported`)}function iI(r,e,t,n){return new Y(_.uint,ri(r,e+1,n),2)}function oI(r,e,t,n){return new Y(_.uint,ni(r,e+1,n),3)}function sI(r,e,t,n){return new Y(_.uint,ii(r,e+1,n),5)}function aI(r,e,t,n){return new Y(_.uint,oi(r,e+1,n),9)}function Ti(r,e){return Dr(r,0,e.value)}function Dr(r,e,t){if(t<Ir[0]){let n=Number(t);r.push([e|n])}else if(t<Ir[1]){let n=Number(t);r.push([e|24,n])}else if(t<Ir[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Ir[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<Ir[4]){let i=[e|27,0,0,0,0,0,0,0],o=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=o&255,o=o>>8,i[7]=o&255,o=o>>8,i[6]=o&255,o=o>>8,i[5]=o&255,i[4]=s&255,s=s>>8,i[3]=s&255,s=s>>8,i[2]=s&255,s=s>>8,i[1]=s&255,r.push(i)}else throw new Error(`${me} encountered BigInt larger than allowable range`)}}Ti.encodedSize=function(e){return Dr.encodedSize(e.value)};Dr.encodedSize=function(e){return e<Ir[0]?1:e<Ir[1]?2:e<Ir[2]?3:e<Ir[3]?5:9};Ti.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function cI(r,e,t,n){return new Y(_.negint,-1-ri(r,e+1,n),2)}function lI(r,e,t,n){return new Y(_.negint,-1-ni(r,e+1,n),3)}function uI(r,e,t,n){return new Y(_.negint,-1-ii(r,e+1,n),5)}var b7=BigInt(-1),fI=BigInt(1);function dI(r,e,t,n){let i=oi(r,e+1,n);if(typeof i!="bigint"){let o=-1-i;if(o>=Number.MIN_SAFE_INTEGER)return new Y(_.negint,o,9)}if(n.allowBigInt!==!0)throw new Error(`${me} integers outside of the safe integer range are not supported`);return new Y(_.negint,b7-BigInt(i),9)}function fg(r,e){let t=e.value,n=typeof t=="bigint"?t*b7-fI:t*-1-1;Dr(r,e.type.majorEncoded,n)}fg.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*b7-fI:t*-1-1;return n<Ir[0]?1:n<Ir[1]?2:n<Ir[2]?3:n<Ir[3]?5:9};fg.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function lp(r,e,t,n){Ss(r,e,t+n);let i=wf(r,e+t,e+t+n);return new Y(_.bytes,i,t+n)}function hI(r,e,t,n){return lp(r,e,1,t)}function pI(r,e,t,n){return lp(r,e,2,ri(r,e+1,n))}function mI(r,e,t,n){return lp(r,e,3,ni(r,e+1,n))}function gI(r,e,t,n){return lp(r,e,5,ii(r,e+1,n))}function yI(r,e,t,n){let i=oi(r,e+1,n);if(typeof i=="bigint")throw new Error(`${me} 64-bit integer bytes lengths not supported`);return lp(r,e,9,i)}function dg(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===_.string?ug(r.value):r.value),r.encodedBytes}function xf(r,e){let t=dg(e);Dr(r,e.type.majorEncoded,t.length),r.push(t)}xf.encodedSize=function(e){let t=dg(e);return Dr.encodedSize(t.length)+t.length};xf.compareTokens=function(e,t){return Iz(dg(e),dg(t))};function Iz(r,e){return r.length<e.length?-1:r.length>e.length?1:nI(r,e)}function up(r,e,t,n,i){let o=t+n;Ss(r,e,o);let s=new Y(_.string,eI(r,e+t,e+o),o);return i.retainStringBytes===!0&&(s.byteValue=wf(r,e+t,e+o)),s}function wI(r,e,t,n){return up(r,e,1,t,n)}function xI(r,e,t,n){return up(r,e,2,ri(r,e+1,n),n)}function bI(r,e,t,n){return up(r,e,3,ni(r,e+1,n),n)}function vI(r,e,t,n){return up(r,e,5,ii(r,e+1,n),n)}function EI(r,e,t,n){let i=oi(r,e+1,n);if(typeof i=="bigint")throw new Error(`${me} 64-bit integer string lengths not supported`);return up(r,e,9,i,n)}var SI=xf;function bf(r,e,t,n){return new Y(_.array,n,t)}function AI(r,e,t,n){return bf(r,e,1,t)}function _I(r,e,t,n){return bf(r,e,2,ri(r,e+1,n))}function II(r,e,t,n){return bf(r,e,3,ni(r,e+1,n))}function TI(r,e,t,n){return bf(r,e,5,ii(r,e+1,n))}function CI(r,e,t,n){let i=oi(r,e+1,n);if(typeof i=="bigint")throw new Error(`${me} 64-bit integer array lengths not supported`);return bf(r,e,9,i)}function kI(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${me} indefinite length items not allowed`);return bf(r,e,1,1/0)}function hg(r,e){Dr(r,_.array.majorEncoded,e.value)}hg.compareTokens=Ti.compareTokens;hg.encodedSize=function(e){return Dr.encodedSize(e.value)};function vf(r,e,t,n){return new Y(_.map,n,t)}function PI(r,e,t,n){return vf(r,e,1,t)}function RI(r,e,t,n){return vf(r,e,2,ri(r,e+1,n))}function DI(r,e,t,n){return vf(r,e,3,ni(r,e+1,n))}function NI(r,e,t,n){return vf(r,e,5,ii(r,e+1,n))}function OI(r,e,t,n){let i=oi(r,e+1,n);if(typeof i=="bigint")throw new Error(`${me} 64-bit integer map lengths not supported`);return vf(r,e,9,i)}function LI(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${me} indefinite length items not allowed`);return vf(r,e,1,1/0)}function pg(r,e){Dr(r,_.map.majorEncoded,e.value)}pg.compareTokens=Ti.compareTokens;pg.encodedSize=function(e){return Dr.encodedSize(e.value)};function BI(r,e,t,n){return new Y(_.tag,t,1)}function MI(r,e,t,n){return new Y(_.tag,ri(r,e+1,n),2)}function UI(r,e,t,n){return new Y(_.tag,ni(r,e+1,n),3)}function FI(r,e,t,n){return new Y(_.tag,ii(r,e+1,n),5)}function $I(r,e,t,n){return new Y(_.tag,oi(r,e+1,n),9)}function mg(r,e){Dr(r,_.tag.majorEncoded,e.value)}mg.compareTokens=Ti.compareTokens;mg.encodedSize=function(e){return Dr.encodedSize(e.value)};var Dz=20,Nz=21,Oz=22,Lz=23;function HI(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${me} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new Y(_.null,null,1):new Y(_.undefined,void 0,1)}function VI(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${me} indefinite length items not allowed`);return new Y(_.break,void 0,1)}function v7(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${me} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${me} Infinity values are not supported`)}return new Y(_.float,r,e)}function zI(r,e,t,n){return v7(E7(r,e+1),3,n)}function KI(r,e,t,n){return v7(S7(r,e+1),5,n)}function qI(r,e,t,n){return v7(XI(r,e+1),9,n)}function gg(r,e,t){let n=e.value;if(n===!1)r.push([_.float.majorEncoded|Dz]);else if(n===!0)r.push([_.float.majorEncoded|Nz]);else if(n===null)r.push([_.float.majorEncoded|Oz]);else if(n===void 0)r.push([_.float.majorEncoded|Lz]);else{let i,o=!1;(!t||t.float64!==!0)&&(WI(n),i=E7(oo,1),n===i||Number.isNaN(n)?(oo[0]=249,r.push(oo.slice(0,3)),o=!0):(GI(n),i=S7(oo,1),n===i&&(oo[0]=250,r.push(oo.slice(0,5)),o=!0))),o||(Bz(n),i=XI(oo,1),oo[0]=251,r.push(oo.slice(0,9)))}}gg.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){WI(n);let i=E7(oo,1);if(n===i||Number.isNaN(n))return 3;if(GI(n),i=S7(oo,1),n===i)return 5}return 9};var jI=new ArrayBuffer(9),Ci=new DataView(jI,1),oo=new Uint8Array(jI,0);function WI(r){if(r===1/0)Ci.setUint16(0,31744,!1);else if(r===-1/0)Ci.setUint16(0,64512,!1);else if(Number.isNaN(r))Ci.setUint16(0,32256,!1);else{Ci.setFloat32(0,r);let e=Ci.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Ci.setUint16(0,31744,!1);else if(t===0)Ci.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let i=t-127;i<-24?Ci.setUint16(0,0):i<-14?Ci.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):Ci.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function E7(r,e){if(r.length-e<2)throw new Error(`${me} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,i=t&1023,o;return n===0?o=i*2**-24:n!==31?o=(i+1024)*2**(n-25):o=i===0?1/0:NaN,t&32768?-o:o}function GI(r){Ci.setFloat32(0,r,!1)}function S7(r,e){if(r.length-e<4)throw new Error(`${me} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function Bz(r){Ci.setFloat64(0,r,!1)}function XI(r,e){if(r.length-e<8)throw new Error(`${me} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}gg.compareTokens=Ti.compareTokens;function rt(r,e,t){throw new Error(`${me} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function yg(r){return()=>{throw new Error(`${me} ${r}`)}}var ie=[];for(let r=0;r<=23;r++)ie[r]=rt;ie[24]=iI;ie[25]=oI;ie[26]=sI;ie[27]=aI;ie[28]=rt;ie[29]=rt;ie[30]=rt;ie[31]=rt;for(let r=32;r<=55;r++)ie[r]=rt;ie[56]=cI;ie[57]=lI;ie[58]=uI;ie[59]=dI;ie[60]=rt;ie[61]=rt;ie[62]=rt;ie[63]=rt;for(let r=64;r<=87;r++)ie[r]=hI;ie[88]=pI;ie[89]=mI;ie[90]=gI;ie[91]=yI;ie[92]=rt;ie[93]=rt;ie[94]=rt;ie[95]=yg("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ie[r]=wI;ie[120]=xI;ie[121]=bI;ie[122]=vI;ie[123]=EI;ie[124]=rt;ie[125]=rt;ie[126]=rt;ie[127]=yg("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ie[r]=AI;ie[152]=_I;ie[153]=II;ie[154]=TI;ie[155]=CI;ie[156]=rt;ie[157]=rt;ie[158]=rt;ie[159]=kI;for(let r=160;r<=183;r++)ie[r]=PI;ie[184]=RI;ie[185]=DI;ie[186]=NI;ie[187]=OI;ie[188]=rt;ie[189]=rt;ie[190]=rt;ie[191]=LI;for(let r=192;r<=215;r++)ie[r]=BI;ie[216]=MI;ie[217]=UI;ie[218]=FI;ie[219]=$I;ie[220]=rt;ie[221]=rt;ie[222]=rt;ie[223]=rt;for(let r=224;r<=243;r++)ie[r]=yg("simple values are not supported");ie[244]=rt;ie[245]=rt;ie[246]=rt;ie[247]=HI;ie[248]=yg("simple values are not supported");ie[249]=zI;ie[250]=KI;ie[251]=qI;ie[252]=rt;ie[253]=rt;ie[254]=rt;ie[255]=VI;var so=[];for(let r=0;r<24;r++)so[r]=new Y(_.uint,r,1);for(let r=-1;r>=-24;r--)so[31-r]=new Y(_.negint,r,1);so[64]=new Y(_.bytes,new Uint8Array(0),1);so[96]=new Y(_.string,"",1);so[128]=new Y(_.array,0,1);so[160]=new Y(_.map,0,1);so[244]=new Y(_.false,!1,1);so[245]=new Y(_.true,!0,1);so[246]=new Y(_.null,null,1);function A7(r){switch(r.type){case _.false:return Ko([244]);case _.true:return Ko([245]);case _.null:return Ko([246]);case _.bytes:return r.value.length?void 0:Ko([64]);case _.string:return r.value===""?Ko([96]):void 0;case _.array:return r.value===0?Ko([128]):void 0;case _.map:return r.value===0?Ko([160]):void 0;case _.uint:return r.value<24?Ko([Number(r.value)]):void 0;case _.negint:if(r.value>=-24)return Ko([31-Number(r.value)])}}var Uz={float64:!1,mapSorter:$z,quickEncodeToken:A7};function I7(){let r=[];return r[_.uint.major]=Ti,r[_.negint.major]=fg,r[_.bytes.major]=xf,r[_.string.major]=SI,r[_.array.major]=hg,r[_.map.major]=pg,r[_.tag.major]=mg,r[_.float.major]=gg,r}var YI=I7(),_7=new ap,wg=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Es} object contains circular references`);return new r(t,e)}},Sa={null:new Y(_.null,null),undefined:new Y(_.undefined,void 0),true:new Y(_.true,!0),false:new Y(_.false,!1),emptyArray:new Y(_.array,0),emptyMap:new Y(_.map,0)},Aa={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new Y(_.float,r):r>=0?new Y(_.uint,r):new Y(_.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new Y(_.uint,r):new Y(_.negint,r)},Uint8Array(r,e,t,n){return new Y(_.bytes,r)},string(r,e,t,n){return new Y(_.string,r)},boolean(r,e,t,n){return r?Sa.true:Sa.false},null(r,e,t,n){return Sa.null},undefined(r,e,t,n){return Sa.undefined},ArrayBuffer(r,e,t,n){return new Y(_.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new Y(_.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Sa.emptyArray,new Y(_.break)]:Sa.emptyArray;n=wg.createCheck(n,r);let i=[],o=0;for(let s of r)i[o++]=fp(s,t,n);return t.addBreakTokens?[new Y(_.array,r.length),i,new Y(_.break)]:[new Y(_.array,r.length),i]},Object(r,e,t,n){let i=e!=="Object",o=i?r.keys():Object.keys(r),s=i?r.size:o.length;if(!s)return t.addBreakTokens===!0?[Sa.emptyMap,new Y(_.break)]:Sa.emptyMap;n=wg.createCheck(n,r);let a=[],c=0;for(let l of o)a[c++]=[fp(l,t,n),fp(i?r.get(l):r[l],t,n)];return Fz(a,t),t.addBreakTokens?[new Y(_.map,s),a,new Y(_.break)]:[new Y(_.map,s),a]}};Aa.Map=Aa.Object;Aa.Buffer=Aa.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Aa[`${r}Array`]=Aa.DataView;function fp(r,e={},t){let n=Y_(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||Aa[n];if(typeof i=="function"){let s=i(r,n,e,t);if(s!=null)return s}let o=Aa[n];if(!o)throw new Error(`${Es} unsupported type: ${n}`);return o(r,n,e,t)}function Fz(r,e){e.mapSorter&&r.sort(e.mapSorter)}function $z(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let i=t.type.major,o=YI[i].compareTokens(t,n);return o===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),o}function QI(r,e,t,n){if(Array.isArray(e))for(let i of e)QI(r,i,t,n);else t[e.type.major](r,e,n)}function T7(r,e,t){let n=fp(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let i=t.quickEncodeToken(n);if(i)return i;let o=e[n.type.major];if(o.encodedSize){let s=o.encodedSize(n,t),a=new ap(s);if(o(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return sp(a.chunks[0])}}return _7.reset(),QI(_7,n,e,t),_7.toBytes(!0)}function As(r,e){return e=Object.assign({},Uz,e),T7(r,YI,e)}var Hz={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},xg=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=so[e];if(t===void 0){let n=ie[e];if(!n)throw new Error(`${me} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}},dp=Symbol.for("DONE"),bg=Symbol.for("BREAK");function Vz(r,e,t){let n=[];for(let i=0;i<r.value;i++){let o=Ef(e,t);if(o===bg){if(r.value===1/0)break;throw new Error(`${me} got unexpected break to lengthed array`)}if(o===dp)throw new Error(`${me} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=o}return n}function zz(r,e,t){let n=t.useMaps===!0,i=n?void 0:{},o=n?new Map:void 0;for(let s=0;s<r.value;s++){let a=Ef(e,t);if(a===bg){if(r.value===1/0)break;throw new Error(`${me} got unexpected break to lengthed map`)}if(a===dp)throw new Error(`${me} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${me} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&o.has(a)||!n&&a in i))throw new Error(`${me} found repeat map key "${a}"`);let c=Ef(e,t);if(c===dp)throw new Error(`${me} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?o.set(a,c):i[a]=c}return n?o:i}function Ef(r,e){if(r.done())return dp;let t=r.next();if(t.type===_.break)return bg;if(t.type.terminal)return t.value;if(t.type===_.array)return Vz(t,r,e);if(t.type===_.map)return zz(t,r,e);if(t.type===_.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Ef(r,e);return e.tags[t.value](n)}throw new Error(`${me} tag not supported (${t.value})`)}throw new Error("unsupported")}function C7(r,e){if(!(r instanceof Uint8Array))throw new Error(`${me} data to decode must be a Uint8Array`);e=Object.assign({},Hz,e);let t=e.tokenizer||new xg(r,e),n=Ef(t,e);if(n===dp)throw new Error(`${me} did not find any content to decode`);if(n===bg)throw new Error(`${me} got unexpected break`);return[n,r.subarray(t.pos())]}function xn(r,e){let[t,n]=C7(r,e);if(n.length>0)throw new Error(`${me} too many terminals, data makes no sense`);return t}var _s="/",ZI=new TextEncoder().encode(_s),vg=ZI[0],nt=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=O(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==vg)throw new Error("Invalid key")}toString(e="utf8"){return H(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(_s))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=ZI),this._buf[0]!==vg){let e=new Uint8Array(this._buf.byteLength+1);e.fill(vg,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===vg;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;let o=t[i],s=n[i];if(o<s)return!0;if(o>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(_s).slice(1)}type(){return Kz(this.baseNamespace())}name(){return qz(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(_s)||(e+=_s),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(_s):new r(e.slice(0,-1).join(_s))}child(e){return this.toString()===_s?e:e.toString()===_s?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...jz(e.map(t=>t.namespaces()))])}};function Kz(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function qz(r){let e=r.split(":");return e[e.length-1]}function jz(r){return[].concat(...r)}function Eg({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*Wz(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(let[t,n]of e.entries()){let i=[...r,t],o=W.asCID(n);o!=null?yield[i.join("/"),o]:typeof n=="object"&&(yield*P7(n,i))}else{let t=W.asCID(e);t!=null?yield[r.join("/"),t]:yield*P7(e,r)}}function*P7(r,e){if(r==null||r instanceof Uint8Array)return;let t=W.asCID(r);t!=null&&(yield[e.join("/"),t]);for(let[n,i]of Object.entries(r)){let o=[...e,n];yield*Wz(o,i)}}function*Gz(r,e){if(Array.isArray(e))for(let[t,n]of e.entries()){let i=[...r,t];yield i.join("/"),typeof n=="object"&&W.asCID(n)==null&&(yield*R7(n,i))}else yield*R7(e,r)}function*R7(r,e){if(!(r==null||typeof r!="object"))for(let[t,n]of Object.entries(r)){let i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&W.asCID(n)==null&&(yield*Gz(i,n))}}function Xz(r,e){let t=r;for(let[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(s=>`[${JSON.stringify(s)}]`).join("")}`);let o=W.asCID(t);if(o!=null)return{value:o,remaining:e.slice(n+1).join("/")}}return{value:t}}var D7=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Eg(),bytes:Eg(),value:Eg(),asBlock:Eg()})}links(){return P7(this.value,[])}tree(){return R7(this.value,[])}get(e="/"){return Xz(this.value,e.split("/").filter(Boolean))}};function Sg({bytes:r,cid:e,value:t,codec:n}){let i=t!==void 0?t:n?.decode(r);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new D7({cid:e,bytes:r,value:i})}var tT="/pin/",JI="/pinned-block/",N7=fn,eT=1;function Ag(r){return r.version===0&&(r=r.toV1()),new nt(`${tT}${r.toString(N7)}`)}var _g=class{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){let n=Ag(e);if(await this.datastore.has(n))throw new Error("Already pinned");let i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");let o=new ln({concurrency:eT});for await(let a of this.#e(e,o,{...t,depth:i}))await this.#r(a,c=>c.pinnedBy.find(l=>pe(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let s={depth:i,metadata:t.metadata??{}};await this.datastore.put(n,As(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let i=await this.getCodec(e.code),o=await this.blockstore.get(e,n),s=Sg({bytes:o,cid:e,codec:i});yield e;for await(let[,a]of s.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#r(e,t,n){let i=new nt(`${JI}${N7.encode(e.multihash.bytes)}`),o={pinCount:0,pinnedBy:[]};try{o=xn(await this.datastore.get(i,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(o)){if(o.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,As(o),n),n.onProgress?.(new G("helia:pin:add",e))}}async*rm(e,t={}){let n=Ag(e),i=await this.datastore.get(n,t),o=xn(i);await this.datastore.delete(n,t);let s=new ln({concurrency:eT});for await(let a of this.#e(e,s,{...t,depth:o.depth}))await this.#r(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>pe(l,e.bytes)),!0),{...t,depth:o.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:tT+(e.cid!=null?`${e.cid.toString(fn)}`:"")},e)){let i=W.parse(t.toString().substring(5),fn),o=xn(n);yield{cid:i,...o}}}async isPinned(e,t={}){let n=new nt(`${JI}${N7.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){let n=Ag(e),i=await this.datastore.get(n,t);return xn(i)}async setMetadata(e,t,n){let i=Ag(e),o=await this.datastore.get(i,n),s=xn(o);s.metadata=t??{},await this.datastore.put(i,As(s),n)}};var Ig=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}},ol=class extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}},Tg=class extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}},Cg=class extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}};var Yz=5,kg=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??Yz,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await kr(...this.routers)}async stop(){await Gr(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new ol("No content routers available");let n=new Pr({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(let i of un(n.toGenerator(),...sl(this.routers,"findProviders").map(o=>o.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(n.find(i.id)!=null)continue;n.add(async()=>{try{let o=await this.findPeer(i.id,t);return o.multiaddrs.length===0?null:o}catch(o){return this.log.error("could not load multiaddrs for peer %p",i.id,o),null}},{peerId:i.id,signal:t.signal}).catch(o=>{this.log.error("could not load multiaddrs for peer %p",i.id,o)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new ol("No content routers available");await Promise.all(sl(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(sl(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(sl(this.routers,"put").map(async i=>{await i.put(e,t,n)}))}async get(e,t){return Promise.any(sl(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new ol("No peer routers available");let n=this,i=un(...sl(this.routers,"findPeer").map(o=>async function*(){try{yield await o.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let o of i)if(o!=null)return o;throw new We("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new ol("No peer routers available");for await(let n of un(...sl(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))n!=null&&(yield n)}};function sl(r,e){return r.filter(t=>t[e]!=null)}var _a={},Sf=r=>{r.addEventListener("message",e=>{Sf.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Sf.dispatchEvent("message",r,e)})};Sf.addEventListener=(r,e)=>{_a[r]==null&&(_a[r]=[]),_a[r].push(e)};Sf.removeEventListener=(r,e)=>{_a[r]!=null&&(_a[r]=_a[r].filter(t=>t===e))};Sf.dispatchEvent=function(r,e,t){_a[r]!=null&&_a[r].forEach(n=>n(e,t))};var O7=Sf;var L7="lock:worker:request-read",B7="lock:worker:release-read",M7="lock:master:grant-read",U7="lock:worker:request-write",F7="lock:worker:release-write",$7="lock:master:grant-write";var rT=(r=21)=>Math.random().toString().substring(2);var nT=(r,e,t,n,i)=>(o,s)=>{if(s.data.type!==t)return;let a={type:s.data.type,name:s.data.name,identifier:s.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>{o.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise(c=>{let l=u=>{if(u?.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===n&&f.identifier===a.identifier&&(o.removeEventListener("message",l),c())};o.addEventListener("message",l)})}}}))},iT=(r,e,t,n)=>async()=>{let i=rT();return globalThis.postMessage({type:e,identifier:i,name:r}),new Promise(o=>{let s=a=>{if(a?.data==null)return;let c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===i&&(globalThis.removeEventListener("message",s),o(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",s)})},Qz={singleProcess:!1},oT=r=>{if(r=Object.assign({},Qz,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return O7.addEventListener("message",nT(t,"requestReadLock",L7,B7,M7)),O7.addEventListener("message",nT(t,"requestWriteLock",U7,F7,$7)),t}return{isWorker:!0,readLock:t=>iT(t,L7,M7,B7),writeLock:t=>iT(t,U7,$7,F7)}};var al={},Ia;async function H7(r,e){let t,n=new Promise(i=>{t=i});return r.add(async()=>io((async()=>{await new Promise(i=>{t(()=>{i()})})})(),{milliseconds:e.timeout})),n}var Zz=(r,e)=>{if(Ia.isWorker===!0)return{readLock:Ia.readLock(r,e),writeLock:Ia.writeLock(r,e)};let t=new kn({concurrency:1}),n;return{async readLock(){if(n!=null)return H7(n,e);n=new kn({concurrency:e.concurrency,autoStart:!1});let i=n,o=H7(n,e);return t.add(async()=>{i.start(),await i.onIdle().then(()=>{n===i&&(n=null)})}),o},async writeLock(){return n=null,H7(t,e)}}},Jz={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function cl(r){let e=Object.assign({},Jz,r);return Ia==null&&(Ia=oT(e),Ia.isWorker!==!0&&(Ia.addEventListener("requestReadLock",t=>{al[t.data.name]!=null&&al[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),Ia.addEventListener("requestWriteLock",async t=>{al[t.data.name]!=null&&al[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),al[e.name]==null&&(al[e.name]=Zz(e.name,e)),al[e.name]}var Pg=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=cl({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await kr(this.child),this.started=!0}async stop(){await Gr(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();let i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{let i=this;yield*this.child.deleteMany(async function*(){for await(let o of e){if(await i.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}};var V7=new nt("/version"),sT=1;async function aT(r){if(!await r.has(V7)){await r.put(V7,O(`${sT}`));return}let e=await r.get(V7),t=H(e);if(parseInt(t,10)!==sT)throw new Error("Unknown datastore version, a datastore migration may be required")}var Ca={};Ft(Ca,{code:()=>Pn,decode:()=>Ta,decodeOptions:()=>oK,encode:()=>Af,encodeOptions:()=>nK,name:()=>sK,toByteView:()=>lT});var cT=42;function lT(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function eK(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=W.asCID(r);if(!e)return null;let t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new Y(_.tag,cT),new Y(_.bytes,t)]}function tK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function rK(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var z7={float64:!0,typeEncoders:{Object:eK,undefined:tK,number:rK}},nK={...z7,typeEncoders:{...z7.typeEncoders}};function iK(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return W.decode(r.subarray(1))}var Rg={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Rg.tags[cT]=iK;var oK={...Rg,tags:Rg.tags.slice()},sK="dag-cbor",Pn=113,Af=r=>As(r,z7),Ta=r=>xn(lT(r),Rg);var ll={};Ft(ll,{code:()=>qo,decode:()=>If,encode:()=>Ng,format:()=>yK,name:()=>gK,parse:()=>xK,stringify:()=>yK});var K7=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===_.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===_.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[_.uint.major](e,t){this.prefix(e);let n=String(t.value),i=[];for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o);e.push(i)}[_.negint.major](e,t){this[_.uint.major](e,t)}[_.bytes.major](e,t){throw new Error(`${Es} unsupported type: Uint8Array`)}[_.string.major](e,t){this.prefix(e);let n=ug(JSON.stringify(t.value));e.push(n.length>32?sp(n):n)}[_.array.major](e,t){this.prefix(e),this.inRecursive.push({type:_.array,elements:0}),e.push([91])}[_.map.major](e,t){this.prefix(e),this.inRecursive.push({type:_.map,elements:0}),e.push([123])}[_.tag.major](e,t){}[_.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===_.array)e.push([93]);else if(s.type===_.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Es} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),i=[],o=!1;for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s),!o&&(i[s]===46||i[s]===101||i[s]===69)&&(o=!0);o||(i.push(46),i.push(48)),e.push(i)}};function aK(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Es} complex map keys are not supported`);let t=r[0],n=e[0];if(t.type!==_.string||n.type!==_.string)throw new Error(`${Es} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Es} unexpected duplicate map keys, this is not supported`)}var cK={addBreakTokens:!0,mapSorter:aK};function hp(r,e){return e=Object.assign({},cK,e),T7(r,new K7,e)}var _f=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${me} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${me} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,i=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new Y(_.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${me} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${me} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));let o=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(o);return n?new Y(_.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new Y(s>=0?_.uint:_.negint,s,this._pos-e):new Y(s>=0?_.uint:_.negint,BigInt(o),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${me} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let o=this._pos,s=0;o<this.data.length&&s<65536;o++,s++){let a=this.data[o];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,o));return this._pos=o+1,new Y(_.string,c,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${me} unexpected end of unicode escape sequence at position ${this._pos}`);let o=0;for(let s=0;s<4;s++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${me} unexpected unicode escape character at position ${this._pos}`);o=o*16+a,this._pos++}return o},i=()=>{let o=this.ch(),s=null,a=o>239?4:o>223?3:o>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${me} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:o<128&&(s=o);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(o&31)<<6|c&63,f>127&&(s=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(o&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(s=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(o&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(s=f))}s===null?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=a};for(;!this.done();){let o=this.ch(),s;switch(o){case 92:if(this._pos++,this.done())throw new Error(`${me} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${me} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new Y(_.string,x7(t),this._pos-e);default:if(o<32)throw new Error(`${me} invalid control character at position ${this._pos}`);o<128?(t.push(o),this._pos++):i()}}throw new Error(`${me} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new Y(_.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new Y(_.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Y(_.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Y(_.false,!1,5);case 116:return this.expect([116,114,117,101]),new Y(_.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${me} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new Y(_.break,void 0,1);if(this.ch()!==44)throw new Error(`${me} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new Y(_.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new Y(_.break,void 0,1);if(this.ch()!==44)throw new Error(`${me} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new Y(_.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${me} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${me} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function q7(r,e){return e=Object.assign({tokenizer:new _f(r,e)},e),xn(r,e)}function uK(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function fK(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=W.asCID(r);if(!e)return null;let t=e.toString();return[new Y(_.map,1/0,1),new Y(_.string,"/",1),new Y(_.string,t,t.length),new Y(_.break,void 0,1)]}function Dg(r){let e=ar.encode(r).slice(1);return[new Y(_.map,1/0,1),new Y(_.string,"/",1),new Y(_.map,1/0,1),new Y(_.string,"bytes",5),new Y(_.string,e,e.length),new Y(_.break,void 0,1),new Y(_.break,void 0,1)]}function ao(r){return Dg(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function dK(r){return Dg(new Uint8Array(r))}function hK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function pK(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var mK={typeEncoders:{Object:fK,Buffer:Dg,Uint8Array:Dg,Int8Array:ao,Uint16Array:ao,Int16Array:ao,Uint32Array:ao,Int32Array:ao,Float32Array:ao,Float64Array:ao,Uint8ClampedArray:ao,BigInt64Array:ao,BigUint64Array:ao,DataView:ao,ArrayBuffer:dK,undefined:hK,number:pK}},j7=class extends _f{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===_.map){let t=this._next();if(t.type===_.string&&t.value==="/"){let n=this._next();if(n.type===_.string){if(this._next().type!==_.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new Y(_.tag,42,0)}if(n.type===_.map){let i=this._next();if(i.type===_.string&&i.value==="bytes"){let o=this._next();if(o.type===_.string){for(let a=0;a<2;a++)if(this._next().type!==_.break)throw new Error("Invalid encoded Bytes form");let s=ar.decode(`m${o.value}`);return new Y(_.bytes,s,o.value.length)}this.tokenBuffer.push(o)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},W7={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};W7.tags[42]=W.parse;var gK="dag-json",qo=297,Ng=r=>hp(r,mK),If=r=>{let e=uK(r),t=Object.assign(W7,{tokenizer:new j7(e,W7)});return q7(e,t)},yK=r=>wK.decode(Ng(r));var wK=new TextDecoder,xK=r=>If(bK.encode(r)),bK=new TextEncoder;var nr={};Ft(nr,{code:()=>ct,createLink:()=>xT,createNode:()=>wT,decode:()=>rr,encode:()=>Qe,name:()=>RK,prepare:()=>qt,validate:()=>Y7});var vK=new TextDecoder;function G7(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function Og(r,e){let t;[t,e]=G7(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function uT(r,e){let t;return[t,e]=G7(r,e),[t&7,t>>3,e]}function EK(r){let e={},t=r.length,n=0;for(;n<t;){let i,o;if([i,o,n]=uT(r,n),o===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Og(r,n)}else if(o===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=Og(r,n),e.Name=vK.decode(s)}else if(o===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=G7(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${o}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function fT(r){let e=r.length,t=0,n,i=!1,o;for(;t<e;){let a,c;if([a,c,t]=uT(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(o)throw new Error("protobuf: (PBNode) duplicate Data section");[o,t]=Og(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Og(r,t),n.push(EK(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return o&&(s.Data=o),s.Links=n||[],s}var hT=new TextEncoder,dT=2**32,SK=2**31;function AK(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=pp(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){let n=hT.encode(r.Name);t-=n.length,e.set(n,t),t=pp(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=pp(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function pT(r){let e=IK(r),t=new Uint8Array(e),n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=pp(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let i=r.Links.length-1;i>=0;i--){let o=AK(r.Links[i],t.subarray(0,n));n-=o,n=pp(t,n,o)-1,t[n]=18}return t}function _K(r){let e=0;if(r.Hash){let t=r.Hash.length;e+=1+t+Tf(t)}if(typeof r.Name=="string"){let t=hT.encode(r.Name).length;e+=1+t+Tf(t)}return typeof r.Tsize=="number"&&(e+=1+Tf(r.Tsize)),e}function IK(r){let e=0;if(r.Data){let t=r.Data.length;e+=1+t+Tf(t)}if(r.Links)for(let t of r.Links){let n=_K(t);e+=1+n+Tf(n)}return e}function pp(r,e,t){e-=Tf(t);let n=e;for(;t>=SK;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function Tf(r){return r%2===0&&r++,Math.floor((TK(r)+6)/7)}function TK(r){let e=0;return r>=dT&&(r=Math.floor(r/dT),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+CK[r]}var CK=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var kK=["Data","Links"],PK=["Hash","Name","Tsize"],X7=new TextEncoder;function gT(r,e){if(r===e)return 0;let t=r.Name?X7.encode(r.Name):[],n=e.Name?X7.encode(e.Name):[],i=t.length,o=n.length;for(let s=0,a=Math.min(i,o);s<a;++s)if(t[s]!==n[s]){i=t[s],o=n[s];break}return i<o?-1:o<i?1:0}function mT(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function yT(r){if(typeof r.asCID=="object"){let t=W.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Hash){let t=W.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=W.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=W.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function qt(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=X7.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(yT),e.Links.sort(gT);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function Y7(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!mT(r,kK))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){let t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!mT(t,PK))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&gT(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function wT(r,e=[]){return qt({Data:r,Links:e})}function xT(r,e,t){return yT({Hash:t,Name:r,Tsize:e})}function bT(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}var RK="dag-pb",ct=112;function Qe(r){Y7(r);let e={};return r.Links&&(e.Links=r.Links.map(t=>{let n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),pT(e)}function rr(r){let e=bT(r),t=fT(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(i=>{let o={};try{o.Hash=W.decode(i.Hash)}catch{}if(!o.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(o.Name=i.Name),i.Tsize!==void 0&&(o.Tsize=i.Tsize),o})),n}function Cf(r){return r?.then!=null}function vT(r=[],e){let t={[ct]:nr,[vt]:_n,[Pn]:Ca,[qo]:ll,[Lo]:Xu};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){let o=e(n);Cf(o)?i=await o:i=o,t[i.code]=i}if(i!=null)return i;throw new Cg(`Could not load codec for ${n}`)}}function ET(r=[],e){let t={[Fe.code]:Fe,[A0.code]:A0,[cr.code]:cr};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){let o=e(n);Cf(o)?i=await o:i=o,t[i.code]=i}if(i!=null)return i;throw new Tg(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}var ki=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not Found"){super(e)}};var Is=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:i}of e)await this.put(n,i,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var Lg=0,Bg=class extends Is{child;constructor(e){super(),this.child=e}put(e,t){return e.multihash.code===Lg||this.child==null?e:this.child.put(e,t)}get(e){if(e.multihash.code===Lg)return e.multihash.digest;if(this.child==null)throw new ki;return this.child.get(e)}has(e){return e.multihash.code===Lg?!0:this.child==null?!1:this.child.has(e)}delete(e){if(e.code!==Lg&&this.child!=null)return this.child.delete(e)}getAll(e){return this.child!=null?this.child.getAll(e):[]}};function DK(r){return r[Symbol.asyncIterator]!=null}function NK(r,e){let t=0;if(DK(r))return async function*(){for await(let c of r)await e(c,t++)&&(yield c)}();let n=Wu(r),{value:i,done:o}=n.next();if(o===!0)return function*(){}();let s=e(i,t++);if(typeof s.then=="function")return async function*(){await s&&(yield i);for await(let c of n)await e(c,t++)&&(yield c)}();let a=e;return function*(){s===!0&&(yield i);for(let c of n)a(c,t++)&&(yield c)}()}var si=NK;function OK(r){return r[Symbol.asyncIterator]!=null}function ST(r){return r?.then!=null}function LK(r,e){let t=0;if(OK(r))return async function*(){for await(let c of r){let l=e(c,t++);ST(l)&&await l,yield c}}();let n=Wu(r),{value:i,done:o}=n.next();if(o===!0)return function*(){}();if(typeof e(i,t++)?.then=="function")return async function*(){yield i;for await(let c of n){let l=e(c,t++);ST(l)&&await l,yield c}}();let a=e;return function*(){yield i;for(let c of n)a(c,t++),yield c}()}var ul=LK;var Mg=class{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Bg(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new G("blocks:put:duplicate",e)),e):(n.onProgress?.(new G("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,t,n))),n.onProgress?.(new G("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=si(e,async({cid:o})=>{let s=await this.child.has(o,t);return s&&t.onProgress?.(new G("blocks:put-many:duplicate",o)),!s}),i=ul(n,async({cid:o,block:s})=>{t.onProgress?.(new G("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(o,s,t)))});t.onProgress?.(new G("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){let n=await this.getHasher(e.multihash.code);t.onProgress?.(new G("blocks:get:providers:get",e));let i=await AT(e,this.components.blockBrokers,n,{...t,log:this.log});return t.onProgress?.(new G("blocks:get:blockstore:put",e)),await this.child.put(e,i,t),t.onProgress?.(new G("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(e,i,t))),i}return t.onProgress?.(new G("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new G("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(ul(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){let i=await this.getHasher(n.multihash.code);t.onProgress?.(new G("blocks:get-many:providers:get",n));let o=await AT(n,this.components.blockBrokers,i,{...t,log:this.log});t.onProgress?.(new G("blocks:get-many:blockstore:put",n)),await this.child.put(n,o,t),t.onProgress?.(new G("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(n,o,t)))}}))}async delete(e,t={}){t.onProgress?.(new G("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new G("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new G("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},Ug=class extends Mg{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await kr(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Gr(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let n=this.components.blockBrokers.map(i=>i.createSession==null?i:i.createSession(t));return new Q7({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}},Q7=class extends Mg{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){let i=Ne([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:i})}finally{i.clear()}}async*putMany(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){let n=Ne([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){let t=Ne([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function BK(r){return typeof r.retrieve=="function"}var MK=(r,e)=>{if(e==null)throw new U(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n,i=e.digest(t);if(Cf(i)?n=await i:n=i,!pe(n.digest,r.multihash.digest))throw new aa("Hash of downloaded block did not match multihash from passed CID")}};async function AT(r,e,t,n){let i=MK(r,t),o=new AbortController,s=Ne([o.signal,n.signal]);o.signal;let a=[];for(let c of e)BK(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1,u=await c.retrieve(r,{...n,signal:s,validateFn:async f=>{await i(f),l=!0}});return l||await i(u),u}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{o.abort(),s.clear()}}var fl=class extends Me{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=Tn(this.maxProviders)}async retrieve(e,t={}){let n=ar.encode(e.multihash.bytes),i=this.requests.get(n);if(i!=null)return this.log("join existing request for %c",e),i;let o=ye();if(this.requests.set(n,o.promise),this.providers.length===0){let l=!1;this.initialPeerSearchComplete==null&&(l=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,l&&this.log("found initial session peers for %c",e)}let s=!1,a=new ln({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",l=>{this.log.error("error querying provider %o, evicting from session",l.detail.job.options.provider,l.detail.error),this.evict(l.detail.job.options.provider)}),a.addEventListener("success",l=>{s=!0,o.resolve(l.detail.result)}),a.addEventListener("idle",()=>{s||t.signal?.aborted===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let l=0;l<this.minProviders&&this.providers.length!==0;l++){let u=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(u)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),o.resolve(await this.retrieve(e,t))}).catch(l=>{this.log.error("could not find new providers for %c",e,l),o.reject(l)})});let c=l=>{a.add(async()=>this.queryProvider(e,l.detail,t),{provider:l.detail}).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async l=>a.add(async()=>this.queryProvider(e,l,t),{provider:l}))).catch(l=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,l)});try{return await o.promise}finally{this.removeEventListener("provider",c),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){let i=ye(),o=0;return Promise.resolve().then(async()=>{this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e);for await(let s of this.findNewProviders(e,n)){if(o===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),o++,o===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<t)throw new Ig(`Found ${o} of ${t} ${this.name} providers for ${e}`)}).catch(s=>{this.log.error("error searching routing for potential session peers for %c",e,s.errors??s),i.reject(s)}),i.promise}};var Fg=class{blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??Ea(),this.log=this.logger.forComponent("helia"),this.getHasher=ET(e.hashers,e.loadHasher),this.getCodec=vT(e.codecs,e.loadCodec),this.dns=e.dns??nl(),this.metrics=e.metrics;let t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new kg(t,{routers:(e.routers??[]).flatMap(i=>{let o=[i];return i[Ro]!=null&&o.push(i[Ro]),i[Do]!=null&&o.push(i[Do]),o}),providerLookupConcurrency:e.providerLookupConcurrency});let n=new Ug(t);this.pins=new _g(e.datastore,n,this.getCodec),this.blockstore=new Pg(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await aT(this.datastore),await kr(this.blockstore,this.datastore,this.routing)}async stop(){await Gr(this.blockstore,this.datastore,this.routing)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,i=this.blockstore.unwrap();this.log("gc start"),await Sr(i.deleteMany(async function*(){for await(let{cid:o}of i.getAll())try{if(await n.pins.isPinned(o,e))continue;yield o,e.onProgress?.(new G("helia:gc:deleted",o))}catch(s){n.log.error("Error during gc",s),e.onProgress?.(new G("helia:gc:error",s))}}()))}finally{t()}this.log("gc finished")}};var Z7=class extends fl{wantList;network;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);let i=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,i.has?"has":"does not have",e),i.has&&i.block!=null)return i.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}};function _T(r,e){return new Z7(r,e)}var $g=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}};var J7=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Hg(r){let{name:e,metrics:t}=r,n;return t!=null?n=new J7({name:e,metrics:t}):n=new Map,n}function $K(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=Zt(r);e.push(t),r=r.slice(Oe(t))}return e}var IT=$K;var Vg=class extends Me{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=rp({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Hg({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,i)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(i=>{this.log.error("error processing newly connected bitswap peer %p",n.detail,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){let n=H(e.multihash.bytes,"base64"),i=this.wants.get(n);i==null&&(i={cid:e,priority:t.priority??1,wantType:t.wantType??er.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,i)),i.wantType===er.WantHave&&t.wantType===er.WantBlock&&(i.wantType=er.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===er.WantBlock?(await Er(this,"block",t?.signal,{filter:a=>pe(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Er(this,"presence",t?.signal,{filter:s=>pe(e.multihash.digest,s.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),i.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=ye(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let n=new Set,i=new vs;for(let[o,s]of this.wants.entries())t.has(o)||s.cancel||(n.add(o),i.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(i.wantlist.size!==0)try{await this.network.sendMessage(e,i);for(let o of n)t.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(e=>{this.log.error("error sending messages",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){let t=H(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){let i=new vs;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:er.WantHave,priority:1}),await this.network.sendMessage(t,i),(await Er(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&pe(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:er.WantBlock})}async wantSessionBlock(e,t,n={}){let i=new vs;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:er.WantBlock,priority:1}),await this.network.sendMessage(t,i),(await Er(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&pe(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let n=H(e.multihash.bytes,"base64"),i=this.wants.get(n);i!=null&&(i.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(let i of t.blocks){if(i.prefix==null||i.data==null)continue;let o=IT(i.prefix),s=o[0],a=o[1],c=o[2],l=c===Fe.code?Fe:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(i.data);u.then!=null&&(u=await u);let f=W.create(s===0?0:1,a,u);this.log("received block from %p for %c",e,f),this.safeDispatchEvent("block",{detail:{sender:e,cid:f,block:i.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:f,has:!0,block:i.data}});let h=H(f.multihash.bytes,"base64"),d=this.wants.get(h);d!=null&&(d.cancel=!0,n=!0)}for(let{cid:i,type:o}of t.blockPresences){let s=W.decode(i);this.log("received %s from %p for %c",o,e,s),this.safeDispatchEvent("presence",{detail:{sender:e,cid:s,has:o===Si.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,n=new vs(!0);for(let[i,o]of this.wants.entries())o.cancel||(t.add(i),n.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:er.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(i){this.log.error("error sending full wantlist to new peer %p",e,i)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var zg=class{log;logger;stats;network;blockstore;peerWantLists;wantList;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new $g(e),this.network=new R0(e,t),this.peerWantLists=new tg({...e,network:this.network},t),this.wantList=new Vg({...e,network:this.network},t)}createSession(e={}){return _T({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){let n=new AbortController,i=Ne([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(o=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,o)});try{return(await this.wantList.wantBlock(e,{...t,signal:i})).block}finally{n.abort(),i.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var TT=(r,e={})=>new zg(r,e);var ex=class{bitswap;started;constructor(e,t={}){let{getHasher:n}=e;this.bitswap=TT(e,{hashLoader:{getHasher:async i=>n(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(n,i,o)=>{await this.bitswap.notify(n,i,o)},retrieve:async(n,i)=>t.retrieve(n,i)}}};function mp(r={}){return e=>new ex(e,r)}var Kg=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let o=0,s=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*i)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(o*=e,o+=u,o>l||(s+=1,t!==void 0&&s>t))return}if(s!==0)return!n&&c&&s>1?void 0:o})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let i=n*2;if(n<t.length-3){let s=this.readSeparator(":",n,()=>this.readIPv4Addr());if(s!==void 0)return t[i]=s[0],t[i+1]=s[1],t[i+2]=s[2],t[i+3]=s[3],[i+4,!0]}let o=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(o===void 0)return[i,!1];t[i]=o>>8,t[i+1]=o&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let o=new Uint8Array(14),s=16-(n+2),[a]=e(o.subarray(0,s));return t.set(o.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var CT=45,HK=15,kf=new Kg;function qg(r){if(!(r.length>HK))return kf.new(r).parseWith(()=>kf.readIPv4Addr())}function jg(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>CT))return kf.new(r).parseWith(()=>kf.readIPv6Addr())}function dl(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>CT)return;let t=kf.new(r).parseWith(()=>kf.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function co(r){return!!qg(r)}function Pf(r){return!!jg(r)}function Wg(r){return!!dl(r)}var PT=it(kT(),1),VK=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],zK=VK.map(r=>new PT.Netmask(r));function tx(r){for(let e of zK)if(e.contains(r))return!0;return!1}function KK(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function qK(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),i=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return tx(i)}function jK(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function WK(r){let e=r.split(":"),t=e[e.length-1];return tx(t)}function GK(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function bn(r){return co(r)?tx(r):KK(r)?qK(r):jK(r)?WK(r):Pf(r)?GK(r):void 0}var XK=r=>r.toString().split("/").slice(1),Rf=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),$e=r=>({match:e=>Rf(t=>t===r).match(e),pattern:r}),hl=()=>({match:r=>Rf(e=>typeof e=="string").match(r),pattern:"{string}"}),yp=()=>({match:r=>Rf(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),mt=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Le.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),wp=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Nc.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),lt=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),nn=(...r)=>({match:e=>{let t;for(let n of r){let i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Ge=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function gt(...r){function e(i){let o=XK(i);for(let s of r){let a=s.match(o);if(a===!1)return!1;o=a}return o}function t(i){return e(i)!==!1}function n(i){let o=e(i);return o===!1?!1:o.length===0}return{matchers:r,matches:t,exactMatch:n}}var YK=mt(),RT=gt(YK),Xg=Ge($e("dns4"),hl()),Yg=Ge($e("dns6"),hl()),Qg=Ge($e("dnsaddr"),hl()),nx=Ge($e("dns"),hl()),Rpe=gt(Xg,lt(mt())),Dpe=gt(Yg,lt(mt())),Npe=gt(Qg,lt(mt())),xp=gt(nn(nx,Qg,Xg,Yg),lt(mt())),DT=Ge($e("ip4"),Rf(co)),NT=Ge($e("ip6"),Rf(Pf)),ix=nn(DT,NT),Ts=nn(ix,nx,Xg,Yg,Qg),OT=gt(nn(ix,Ge(nn(nx,Qg,Xg,Yg),lt(mt())))),ox=gt(DT),sx=gt(NT),LT=gt(ix),ax=Ge(Ts,$e("tcp"),yp()),bp=Ge(Ts,$e("udp"),yp()),pl=gt(Ge(ax,lt(mt()))),Ope=gt(bp),cx=Ge(bp,$e("quic"),lt(mt())),Zg=Ge(bp,$e("quic-v1"),lt(mt())),QK=nn(cx,Zg),Lpe=gt(cx),BT=gt(Zg),rx=nn(Ts,ax,bp,cx,Zg),MT=nn(Ge(rx,$e("ws"),lt(mt()))),Cs=gt(MT),UT=nn(Ge(rx,$e("wss"),lt(mt())),Ge(rx,$e("tls"),lt(Ge($e("sni"),hl())),$e("ws"),lt(mt()))),ml=gt(UT),FT=Ge(bp,$e("webrtc-direct"),lt(wp()),lt(wp()),lt(mt())),vp=gt(FT),$T=Ge(Zg,$e("webtransport"),lt(wp()),lt(wp()),lt(mt())),lx=gt($T),Gg=nn(MT,UT,Ge(ax,lt(mt())),Ge(QK,lt(mt())),Ge(Ts,lt(mt())),FT,$T,mt()),Jg=gt(Gg),ZK=Ge(Gg,$e("p2p-circuit"),mt()),Rn=gt(ZK),JK=nn(Ge(Gg,$e("p2p-circuit"),$e("webrtc"),lt(mt())),Ge(Gg,$e("webrtc"),lt(mt())),Ge($e("webrtc"),lt(mt()))),Ep=gt(JK),eq=nn(Ge(Ts,$e("tcp"),yp(),$e("http"),lt(mt())),Ge(Ts,$e("http"),lt(mt()))),HT=gt(eq),tq=nn(Ge(Ts,$e("tcp"),nn(Ge($e("443"),$e("http")),Ge(yp(),$e("https"))),lt(mt())),Ge(Ts,$e("tls"),$e("http"),lt(mt())),Ge(Ts,$e("https"),lt(mt()))),VT=gt(tq),rq=nn(Ge($e("memory"),hl(),lt(mt()))),Bpe=gt(rq);function zT(r,e,t){let n=0;for(let i of r)if(!(n<e)){if(n>t)break;if(i!==255)return!1;n++}return!0}function KT(r,e,t,n){let i=0;for(let o of r)if(!(i<t)){if(i>n)break;if(o!==e[i])return!1;i++}return!0}function ux(r){switch(r.length){case gl:return r.join(".");case yl:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function qT(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let i=t+1;i<r.length;i++)if(r[i]!=0)return-1;break}return e}function jT(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var gl=4,yl=16,Vpe=parseInt("0xFFFF",16),nq=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Sp(r,e){e.length===yl&&r.length===gl&&zT(e,0,11)&&(e=e.slice(12)),e.length===gl&&r.length===yl&&KT(r,nq,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=r[i]&e[i];return n}function WT(r,e){if(typeof e=="string"&&(e=dl(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function fx(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=gl,i=qg(e);if(i==null&&(n=yl,i=jg(e),i==null))throw new Error("Failed to parse given CIDR: "+r);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n*8)throw new Error("Failed to parse given CIDR: "+r);let s=dx(o,8*n);return{network:Sp(i,s),mask:s}}function dx(r,e){if(e!==8*gl&&e!==8*yl)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let i=0;i<t;i++){if(r>=8){n[i]=255,r-=8;continue}n[i]=255-(255>>r),r=0}return n}var wl=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=fx(e));else{let n=dl(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n.length*8){let o=dl(t);if(o==null)throw new Error("Failed to parse mask");this.mask=o}else this.mask=dx(i,8*n.length);this.network=Sp(n,this.mask)}}contains(e){return WT({network:this.network,mask:this.mask},e)}toString(){let e=qT(this.mask),t=e!==-1?String(e):jT(this.mask);return ux(this.network)+"/"+t}};function GT(r,e){return new wl(r).contains(e)}var XT=co,iq=Pf,hx=function(r){let e=0;if(r=r.toString().trim(),XT(r)){let t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(iq(r)){let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=XT(t[n]),s;o&&(s=hx(t[n]),t[n]=H(s.slice(0,2),"base16")),s!=null&&++n<8&&t.splice(n,0,H(s.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let i=new Uint8Array(e+16);for(n=0;n<t.length;n++){let o=parseInt(t[n],16);i[e++]=o>>8&255,i[e++]=o&255}return i}throw new Error("invalid ip address")},YT=function(r,e=0,t){e=~~e,t=t??r.length-e;let n=new DataView(r.buffer);if(t===4){let i=[];for(let o=0;o<t;o++)i.push(r[e+o]);return i.join(".")}if(t===16){let i=[];for(let o=0;o<t;o+=2)i.push(n.getUint16(e+o).toString(16));return i.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var Df={},px={},sq=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,-1,"http-path"],[777,-1,"memory"]];sq.forEach(r=>{let e=aq(...r);px[e.code]=e,Df[e.name]=e});function aq(r,e,t,n,i){return{code:r,size:e,name:t,resolvable:!!n,path:!!i}}function Ie(r){if(typeof r=="number"){if(px[r]!=null)return px[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Df[r]!=null)return Df[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var cq=Ie("ip4"),lq=Ie("ip6"),uq=Ie("ipcidr");function wx(r,e){switch(Ie(r).code){case 4:case 41:return dq(e);case 42:return yx(e);case 43:return H(e,"base10");case 6:case 273:case 33:case 132:return JT(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return yx(e);case 421:return gq(e);case 444:return ZT(e);case 445:return ZT(e);case 466:return mq(e);case 481:return globalThis.encodeURIComponent(yx(e));default:return H(e,"base16")}}function xx(r,e){switch(Ie(r).code){case 4:return QT(e);case 41:return QT(e);case 42:return gx(e);case 43:return O(e,"base10");case 6:case 273:case 33:case 132:return vx(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return gx(e);case 421:return hq(e);case 444:return yq(e);case 445:return wq(e);case 466:return pq(e);case 481:return gx(globalThis.decodeURIComponent(e));default:return O(e,"base16")}}function bx(r){let e,t;if(r.stringTuples().forEach(([n,i])=>{(n===cq.code||n===lq.code)&&(t=i),n===uq.code&&(e=i)}),e==null||t==null)throw new Error("Invalid multiaddr");return new wl(t,e)}var mx=Object.values(Bc).map(r=>r.decoder),fq=function(){let r=mx[0].or(mx[1]);return mx.slice(2).forEach(e=>r=r.or(e)),r}();function QT(r){if(!Wg(r))throw new Error("invalid ip address");return hx(r)}function dq(r){let e=YT(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!Wg(e))throw new Error("invalid ip address");return e}function vx(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function JT(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function gx(r){let e=O(r),t=Uint8Array.from(ht(e.length));return Ve([t,e],t.length+e.length)}function yx(r){let e=Zt(r);if(r=r.slice(Oe(e)),r.length!==e)throw new Error("inconsistent lengths");return H(r)}function hq(r){let e;r[0]==="Q"||r[0]==="1"?e=Ue(Le.decode(`z${r}`)).bytes:e=W.parse(r).multihash.bytes;let t=Uint8Array.from(ht(e.length));return Ve([t,e],t.length+e.length)}function pq(r){let e=fq.decode(r),t=Uint8Array.from(ht(e.length));return Ve([t,e],t.length+e.length)}function mq(r){let e=Zt(r),t=r.slice(Oe(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+H(t,"base64url")}function gq(r){let e=Zt(r),t=r.slice(Oe(e));if(t.length!==e)throw new Error("inconsistent lengths");return H(t,"base58btc")}function yq(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=Jt.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=vx(n);return Ve([t,i],t.length+i.length)}function wq(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=Jt.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=vx(n);return Ve([t,i],t.length+i.length)}function ZT(r){let e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=H(e,"base32"),i=JT(t);return`${n}:${i}`}function eC(r){r=Ex(r);let e=[],t=[],n=null,i=r.split("/").slice(1);if(i.length===1&&i[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let o=0;o<i.length;o++){let s=i[o],a=Ie(s);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(o++,o>=i.length)throw new e2("invalid address: "+r);if(a.path===!0){n=Ex(i.slice(o).join("/")),e.push([a.code,xx(a.code,n)]),t.push([a.code,n]);break}let c=xx(a.code,i[o]);e.push([a.code,c]),t.push([a.code,wx(a.code,c)])}return{string:tC(t),bytes:t2(e),tuples:e,stringTuples:t,path:n}}function Sx(r){let e=[],t=[],n=null,i=0;for(;i<r.length;){let o=Zt(r,i),s=Oe(o),a=Ie(o),c=xq(a,r.slice(i+s));if(c===0){e.push([o]),t.push([o]),i+=s;continue}let l=r.slice(i+s,i+s+c);if(i+=c+s,i>r.length)throw new e2("Invalid address Uint8Array: "+H(r,"base16"));e.push([o,l]);let u=wx(o,l);if(t.push([o,u]),a.path===!0){n=u;break}}return{bytes:Uint8Array.from(r),string:tC(t),tuples:e,stringTuples:t,path:n}}function tC(r){let e=[];return r.map(t=>{let n=Ie(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),Ex(e.join("/"))}function t2(r){return Ve(r.map(e=>{let t=Ie(e[0]),n=Uint8Array.from(ht(t.code));return e.length>1&&e[1]!=null&&(n=Ve([n,e[1]])),n}))}function xq(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let t=Zt(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Oe(t)}}function Ex(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}var e2=class extends Error{static name="ParseError";name="ParseError";constructor(e){super(`Error parsing address: ${e}`)}};var bq=Symbol.for("nodejs.util.inspect.custom"),_x=Symbol.for("@multiformats/js-multiaddr/multiaddr"),vq=[Ie("dns").code,Ie("dns4").code,Ie("dns6").code,Ie("dnsaddr").code],Ax=class extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}},r2=class r{bytes;#e;#r;#n;#m;[_x]=!0;constructor(e){e==null&&(e="");let t;if(e instanceof Uint8Array)t=Sx(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=eC(e)}else if(ka(e))t=Sx(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,this.#e=t.string,this.#r=t.tuples,this.#n=t.stringTuples,this.#m=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,n,i,o="",s=Ie("tcp"),a=Ie("udp"),c=Ie("ip4"),l=Ie("ip6"),u=Ie("dns6"),f=Ie("ip6zone");for(let[d,m]of this.stringTuples())d===f.code&&(o=`%${m??""}`),vq.includes(d)&&(t=s.name==="tcp"?"tcp":"udp",i=443,n=`${m??""}${o}`,e=d===u.code?6:4),(d===s.code||d===a.code)&&(t=Ie(d).name==="tcp"?"tcp":"udp",i=parseInt(m??"")),(d===c.code||d===l.code)&&(t=Ie(d).name==="tcp"?"tcp":"udp",n=`${m??""}${o}`,e=d===l.code?6:4);if(e==null||t==null||n==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:i}}protos(){return this.#r.map(([e])=>Object.assign({},Ie(e)))}protoCodes(){return this.#r.map(([e])=>e)}protoNames(){return this.#r.map(([e])=>Ie(e).name)}tuples(){return this.#r.map(([e,t])=>t==null?[e]:[e,t])}stringTuples(){return this.#n.map(([e,t])=>t==null?[e]:[e,t])}encapsulate(e){return e=new r(e),new r(this.toString()+e.toString())}decapsulate(e){let t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,i))}decapsulateCode(e){let t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new r(t2(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,i])=>{n===Df.p2p.code&&e.push([n,i]),n===Df["p2p-circuit"].code&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?H(Le.decode(`z${n}`),"base58btc"):H(W.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#m}equals(e){return pe(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(o=>o.resolvable);if(t==null)return[this];let n=Nf.get(t.name);if(n==null)throw new Ax(`no available resolver for ${t.name}`);return(await n(this,e)).map(o=>se(o))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){let t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[bq](){return`Multiaddr(${this.#e})`}};var Nf=new Map;function ka(r){return!!r?.[_x]}function se(r){return new r2(r)}var Eq=[Ie("tcp").code,Ie("dns").code,Ie("dnsaddr").code,Ie("dns4").code,Ie("dns6").code];function rC(r){return oC("sni",r)?.[1]}function nC(r){let e=oC("tcp",r)?.[1];return e==null?"":`:${e}`}function oC(r,e){let t;try{t=Ie(r).code}catch{return}for(let[n,i]of e)if(n===t&&i!=null)return[n,i]}function iC(r){return r.some(([e,t])=>e===Ie("tls").code)}function lo(r,e,t){let n=sC[Ie(r).name];if(n==null)throw new Error(`Can't interpret protocol ${Ie(r).name}`);let i=n(e,t);return r===Ie("ip6").code?`[${i}]`:i}var sC={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${lo(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${lo(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${lo(t[0],t[1]??"",e)}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${lo(t[0],t[1]??"",e)}`},http:(r,e)=>{let t=iC(e),n=rC(e),i=nC(e);if(t&&n!=null)return`https://${n}${i}`;let o=t?"https://":"http://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=lo(s[0],s[1]??"",e);return a=a.replace("tcp://",""),`${o}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=lo(t[0],t[1]??"",e),i=decodeURIComponent(r);return`${n}/${i}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return lo(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return lo(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=lo(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=iC(e),n=rC(e),i=nC(e);if(t&&n!=null)return`wss://${n}${i}`;let o=t?"wss://":"ws://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=lo(s[0],s[1]??"",e);return a=a.replace("tcp://",""),`${o}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=lo(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`}};function n2(r,e){let n=se(r).stringTuples(),i=n.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let o=Ie(i[0]),s=sC[o.name];if(s==null)throw new Error(`No interpreter found for ${o.name}`);let a=s(i[1]??"",n);return e?.assumeHttp!==!1&&Eq.includes(i[0])&&(a=a.replace(/^.*:\/\//,""),i[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var i2=class{url;#e=0;#r=0;#n=0;#m=0;#u=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#A(e){let t=e.multihash.bytes;return ar.encode(t)}async getRawBlock(e,t){let n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let i=this.#A(e),o=new AbortController,s=()=>{o.abort()};t?.addEventListener("abort",s);try{let a=this.#u.get(i);if(a==null){this.#e++;let c={signal:o.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async u=>{if(this.log("GET %s %d",n,u.status),!u.ok)throw this.#r++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#m++,new Uint8Array(await u.arrayBuffer())}),this.#u.set(i,a)}return await a}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#r++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",s),this.#u.delete(i)}}reliability(){return this.#e===0?1:this.#n>0?-1/0:this.#m/(this.#e+this.#r*3)}incrementInvalidBlocks(){this.#n++}getStats(){return{attempts:this.#e,errors:this.#r,invalidBlocks:this.#n,successes:this.#m,pendingResponses:this.#u.size}}};function Sq(r,e,t){return r.filter(n=>{if(VT.matches(n)||e&&HT.matches(n))return t||xp.matches(n)?!0:bn(n.toOptions().host)===!1;if(!e&&t){let{host:i}=n.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*o2(r,e,t,n,i,o={}){for await(let s of e.findProviders(r,o)){let a=Sq(s.multiaddrs,n,i);if(a.length===0)continue;let c=n2(a[0]);yield new i2(c,{logger:t,transformRequestInit:o.transformRequestInit})}}var Ix=class extends fl{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??s2,this.allowLocal=t.allowLocal??a2,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);let i=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(i),i}async*findNewProviders(e,t={}){yield*o2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}};function aC(r,e){return new Ix(r,e)}var c2=class{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??s2,this.allowLocal=t.allowLocal??a2,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){let n=[];for await(let i of o2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,i.url);try{let o=await i.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,i.url);try{await t.validateFn?.(o)}catch(s){this.log.error("failed to validate block for %c from %s",e,i.url,s);continue}return o}catch(o){if(this.log.error("failed to get block for %c from %s",e,i.url,o),o instanceof Error?n.push(o):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${i.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,i.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return aC({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}};var s2=!1,a2=!1;function Ap(r={}){return e=>new c2(e,r)}async function*l2(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var hC=it(u2(),1);var f2=class extends Error{static name="SignatureCreationError";constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}},uo=class extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}},d2=class extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}},xl=class extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}},h2=class extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}},_p=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},p2=class extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}},Ip=class extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}};var Nr;(function(r){let e;(function(i){i.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(i){i[i.EOL=0]="EOL"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.value!=null&&(o.uint32(10),o.bytes(i.value)),i.signatureV1!=null&&(o.uint32(18),o.bytes(i.signatureV1)),i.validityType!=null&&(o.uint32(24),r.ValidityType.codec().encode(i.validityType,o)),i.validity!=null&&(o.uint32(34),o.bytes(i.validity)),i.sequence!=null&&(o.uint32(40),o.uint64(i.sequence)),i.ttl!=null&&(o.uint32(48),o.uint64(i.ttl)),i.pubKey!=null&&(o.uint32(58),o.bytes(i.pubKey)),i.signatureV2!=null&&(o.uint32(66),o.bytes(i.signatureV2)),i.data!=null&&(o.uint32(74),o.bytes(i.data)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.value=i.bytes();break}case 2:{a.signatureV1=i.bytes();break}case 3:{a.validityType=r.ValidityType.codec().decode(i);break}case 4:{a.validity=i.bytes();break}case 5:{a.sequence=i.uint64();break}case 6:{a.ttl=i.uint64();break}case 7:{a.pubKey=i.bytes();break}case 8:{a.signatureV2=i.bytes();break}case 9:{a.data=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(Nr||(Nr={}));var Aq=ze("ipns:utils"),cC=O("/ipns/"),_q=114,Iq=0,Tq=18;function Tp(r){let e;if(r.pubKey!=null)try{e=tr(r.pubKey)}catch(t){throw Aq.error(t),t}if(e!=null)return e}function lC(r,e,t){let n=O(e);return Ve([r,t,n])}function g2(r){let e=O("ipns-signature:");return Ve([e,r])}function Pa(r){return"signatureV1"in r?Nr.encode({value:O(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:O(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):Nr.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function Dn(r){let e=Nr.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new uo("Missing data or signatureV2");let t=fC(e.data),n=Cq(t.Value),i=H(t.Validity);if(e.value!=null&&e.signatureV1!=null)return kq(e),{value:n,validityType:Nr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Nr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function ks(r){return Ve([cC,r.bytes])}function Of(r){let e=Ue(r.slice(cC.length));if(!m2(e,Iq)&&!m2(e,Tq))throw new aa("Multihash in IPNS key was not identity or sha2-256");return e}function uC(r,e,t,n,i){let o;if(e===Nr.ValidityType.EOL)o=0;else throw new xl("The validity type is unsupported");return As({Value:r,Validity:t,ValidityType:o,Sequence:n,TTL:i})}function fC(r){let e=xn(r);if(e.ValidityType===0)e.ValidityType=Nr.ValidityType.EOL;else throw new xl("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function Cq(r){let e=H(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${W.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${W.parse(e).toV1().toString()}`}catch{}throw new _p("Value must be a valid content path starting with /")}function dC(r){if(r!=null){let e=Dq(r);if(e!=null)return e.code===_q?`/ipns/${e.toString(fn)}`:`/ipfs/${e.toV1().toString()}`;if(Pq(r))return`/ipns/${fn.encode(r.bytes)}`;let t=r.toString().trim();if(t.startsWith("/")&&t.length>1)return t}throw new _p("Value must be a valid content path starting with /")}function kq(r){if(r.data==null)throw new p2("Record data is missing");let e=fC(r.data);if(!pe(e.Value,r.value??new Uint8Array(0)))throw new uo('Field "value" did not match between protobuf and CBOR');if(!pe(e.Validity,r.validity??new Uint8Array(0)))throw new uo('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new uo('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new uo('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new uo('Field "ttl" did not match between protobuf and CBOR')}function Pq(r){return r.bytes instanceof Uint8Array}function Rq(r){return typeof r?.toCID=="function"}function Dq(r){if(Rq(r))return r.toCID();try{return W.parse(r)}catch{}return W.asCID(r)}function m2(r,e){return r.code===e}var Nq=ze("ipns"),pC=5*60*1e9,Oq="/ipns/",Bme=Oq.length,mC={v1Compatible:!0,ttlNs:pC};async function gC(r,e,t,n,i=mC){let o=new hC.default(Date.now()+Number(n)),s=Nr.ValidityType.EOL,a=BigInt(i.ttlNs??pC);return Lq(r,e,t,s,o.toString(),a,i)}var Lq=async(r,e,t,n,i,o,s=mC)=>{t=BigInt(t);let a=O(i),c=dC(e),l=O(c),u=uC(l,n,a,t,o),f=g2(u),h=await r.sign(f),d;if(r.type==="RSA"&&(d=lr(r.publicKey)),s.v1Compatible===!0){let m=await Bq(r,l,n,a),g={value:c,signatureV1:m,validity:i,validityType:n,sequence:t,ttl:o,signatureV2:h,data:u};return d!=null&&(g.pubKey=d),g}else{let m={value:c,validity:i,validityType:n,sequence:t,ttl:o,signatureV2:h,data:u};return d!=null&&(m.pubKey=d),m}},Bq=async(r,e,t,n)=>{try{let i=lC(e,t,n);return await r.sign(i)}catch(i){throw Nq.error("record signature creation failed",i),new f2("Record signature creation failed")}};var yC=it(u2(),1);var y2=ze("ipns:validator"),Mq=1024*10,Uq=async(r,e)=>{let t=Dn(e),n;try{let i=g2(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw y2.error("record signature verification failed"),new uo("Record signature verification failed");if(t.validityType===Nr.ValidityType.EOL){if(yC.default.fromString(t.validity).toDate().getTime()<Date.now())throw y2.error("record has expired"),new d2("record has expired")}else if(t.validityType!=null)throw y2.error("the validity type is unsupported"),new xl("The validity type is unsupported");y2("ipns record for %s is valid",t.value)};async function Ra(r,e){if(e.byteLength>Mq)throw new h2("The record is too large");let t=Of(r),n;m2(t,0)&&(n=G0(t));let i=Dn(e),o=Tp(i)??n;if(o==null)throw new Ip("Could not extract public key from IPNS record or routing key");let s=ks(o.toMultihash());if(!pe(s,r))throw new Ip("Embedded public key did not match routing key");await Uq(o,e)}var w2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*Cp(r,e={}){let t=/\r?\n/,n=new TextDecoder("utf8"),i="";for await(let o of r){if(typeof o=="string"&&(o=new TextEncoder().encode(o)),vi(o)&&(o=o.subarray()),i+=n.decode(o,{stream:!0}),i.length>(e?.maxMessageLength??i.length))throw new w2("Incoming message too long");let s=i.split(t);i=s.pop()??"";for(let a=0;a<s.length;a++)yield JSON.parse(s[a])}i+=n.decode(),i!==""&&(yield JSON.parse(i))}var Lf=class extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}},fo=class extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}};function Fq(r){return r[Symbol.asyncIterator]!=null}function $q(r){if(Fq(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var Bf=$q;var wC=O("/ipns/");function xC(r){return pe(r.subarray(0,wC.byteLength),wC)}var x2=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*Nt(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!xC(e))return;let i=Of(e),o=W.createV1(114,i),s=Dn(t);await this.client.putIPNS(o,s,n)}async get(e,t){if(!xC(e))throw new We("Not found");let n=Of(e),i=W.createV1(114,n);try{let o=await this.client.getIPNS(i,t);return Pa(o)}catch(o){throw o.name==="BadResponseError"?new We("Not found"):o}}},b2=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await Bf(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new We("Not found")}async*getClosestPeers(e,t={}){}};var Tr=ze("delegated-routing-v1-http-api-client"),v2={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"},E2=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new kn({concurrency:t.concurrentRequests??v2.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??v2.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new x2(this),this.peerRouting=new b2(this),this.cacheName=t.cacheName??v2.cacheName,this.cacheTTL=t.cacheTTL??v2.cacheTTL}get[Ro](){return this.contentRouting}get[Do](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&Tr("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){Tr("getProviders starts: %c",e);let n=AbortSignal.timeout(this.timeout),i=Ne([this.shutDownController.signal,n,t.signal]);let o=ye(),s=ye();this.httpQueue.add(async()=>(o.resolve(),s.promise));try{await o.promise;let a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#r(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#n(a.toString(),c);if(l==null)throw new fo("No response received");if(!l.ok)throw l.status===404?new We("No matching records found"):l.status===422?new Lf("Request does not conform to schema or semantic constraints"):new fo(`Unexpected status code: ${l.status}`);if(l.body==null)throw new fo("Routing response had no body");let u=l.headers.get("Content-Type");if(u==null)throw new fo("No Content-Type header received");if(u?.startsWith("application/json")){let f=await l.json();for(let h of f.Providers){let d=this.#e(h);d!=null&&(yield d)}}else if(u.includes("application/x-ndjson"))for await(let f of Cp(l2(l.body))){let h=this.#e(f);h!=null&&(yield h)}else throw new fo(`Unsupported Content-Type: ${u}`)}catch(a){Tr.error("getProviders errored:",a)}finally{i.clear(),s.resolve(),Tr("getProviders finished: %c",e)}}async*getPeers(e,t={}){Tr("getPeers starts: %c",e);let n=AbortSignal.timeout(this.timeout),i=Ne([this.shutDownController.signal,n,t.signal]);let o=ye(),s=ye();this.httpQueue.add(async()=>(o.resolve(),s.promise));try{await o.promise;let a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#r(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#n(a.toString(),c);if(l.status===404)throw new We("No matching records found");if(l.status===422)throw new Lf("Request does not conform to schema or semantic constraints");if(l.body==null)throw new fo("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){let f=await l.json();for(let h of f.Peers){let d=this.#e(h);d!=null&&(yield d)}}else for await(let f of Cp(l2(l.body))){let h=this.#e(f);h!=null&&(yield h)}}catch(a){Tr.error("getPeers errored:",a)}finally{i.clear(),s.resolve(),Tr("getPeers finished: %c",e)}}async getIPNS(e,t={}){Tr("getIPNS starts: %s",e);let n=AbortSignal.timeout(this.timeout),i=Ne([this.shutDownController.signal,n,t.signal]);let o=ye(),s=ye();this.httpQueue.add(async()=>(o.resolve(),s.promise));let a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;let c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await this.#n(a,c);if(Tr("getIPNS GET %s %d",a,l.status),l.status===404)throw new We("No matching records found");if(l.status===422)throw new Lf("Request does not conform to schema or semantic constraints");if(l.body==null)throw new fo("GET ipns response had no body");let u=await l.arrayBuffer(),f=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await Ra(ks(e.multihash),f),Dn(f)}catch(c){throw Tr.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),s.resolve(),Tr("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){Tr("putIPNS starts: %c",e);let i=AbortSignal.timeout(this.timeout),o=Ne([this.shutDownController.signal,i,n.signal]);let s=ye(),a=ye();this.httpQueue.add(async()=>(s.resolve(),a.promise));let c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;let l=Pa(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:o},f=await this.#n(c,u);if(Tr("putIPNS PUT %s %d",c,f.status),f.status!==200)throw new fo("PUT ipns response had status other than 200")}catch(l){throw Tr.error("putIPNS PUT %s error:",c,l.stack),l}finally{o.clear(),a.resolve(),Tr("putIPNS finished: %c",e)}}#e(e){try{let t=[],n=e.Addrs?.map(se)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:at(e.ID),Addrs:n,Protocols:t}}catch(t){Tr.error("could not conform record to peer schema",t)}}#r(e,t,n){if(t!=null||this.filterAddrs!=null){let i=t?.join(",")??this.filterAddrs?.join(",")??"";i!==""&&e.searchParams.set("filter-addrs",i)}if(n!=null||this.filterProtocols!=null){let i=n?.join(",")??this.filterProtocols?.join(",")??"";i!==""&&e.searchParams.set("filter-protocols",i)}}async#n(e,t){let n=t.method??"GET",i=`${n}-${e}`;if(n==="GET"){let c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return Tr("returning cached response for %s",i),c;await this.cache?.delete(e)}}let o=this.inFlightRequests.get(i);if(o!=null){let c=await o;return Tr("deduplicating outgoing request for %s",i),c.clone()}let s=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){let l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());let f=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,f)}return c}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,s),await s}};function S2(r,e={}){return new E2(new URL(r),e)}var Cx=it(u2(),1);function A2(r,e){let t=e.map((n,i)=>({record:Dn(n),index:i}));return t.sort((n,i)=>{let o=n.record.sequence,s=i.record.sequence;if(o>s)return-1;if(o<s)return 1;if(n.record.validityType===Nr.ValidityType.EOL&&i.record.validityType===Nr.ValidityType.EOL){let a=Cx.default.fromString(n.record.validity).toDate(),c=Cx.default.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}var _2=class extends Error{static name="DNSLinkNotFoundError";constructor(e="DNSLink not found"){super(e),this.name="DNSLinkNotFoundError"}},I2=class extends Error{static name="RecordsFailedValidationError";constructor(e="Records failed validation"){super(e),this.name="RecordsFailedValidationError"}},T2=class extends Error{static name="UnsupportedMultibasePrefixError";constructor(e="Unsupported multibase prefix"){super(e),this.name="UnsupportedMultibasePrefixError"}},C2=class extends Error{static name="UnsupportedMultihashCodecError";constructor(e="Unsupported multihash codec"){super(e),this.name="UnsupportedMultihashCodecError"}},k2=class extends Error{static name="InvalidValueError";constructor(e="Invalid value"){super(e),this.name="InvalidValueError"}};var Hq=32;async function bC(r,e,t,n,i={}){if(e===0)throw new Error("recursion limit exceeded");n("query %s for TXT and CNAME records",r);let s=((await t.query(r,{...i,types:[rn.TXT]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));n("found %d TXT records for %s",s.length,r);for(let l of s)try{let u=l.data;if(u.startsWith('"')&&u.endsWith('"')&&(u=u.substring(1,u.length-1)),!u.startsWith("dnslink="))continue;n("%s TXT %s",l.name,u),u=u.replace("dnslink=","");let[,f,h,...d]=u.split("/");if(f==="ipfs")try{return{value:`/ipfs/${W.parse(h)}${d.length>0?`/${d.join("/")}`:""}`,answer:l}}catch{}else if(f==="ipns"){try{let m;return h.charAt(0)==="1"||h.charAt(0)==="Q"?m=at(h):m=gn(W.parse(h)),{value:`/ipns/${m}${d.length>0?`/${d.join("/")}`:""}`,answer:l}}catch{}return await P2(h,e-1,t,n,i)}else{if(f==="dnslink")return await P2(h,e-1,t,n,i);n('unknown protocol "%s" in DNSLink record for domain: %s',f,r);continue}}catch(u){n.error("could not parse DNS link record for domain %s, %s",r,l.data,u)}n("no DNSLink records found for %s, falling back to CNAME",r);let c=((await t.query(r,{...i,types:[rn.CNAME]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));n("found %d CNAME records for %s",c.length,r);for(let l of c)try{return await P2(l.data,e-1,t,n,i)}catch(u){n.error("domain %s cname %s had no DNSLink records",r,l.data,u)}throw new _2(`No DNSLink records found for domain: ${r}`)}async function P2(r,e,t,n,i={}){if(e===0)throw new Error("recursion limit exceeded");r.startsWith("_dnslink.")||(r=`_dnslink.${r}`);try{return await bC(r,e,t,n,i)}catch(o){if(o.code!=="ENOTFOUND"&&o.code!=="ENODATA"&&o.name!=="DNSLinkNotFoundError"&&o.name!=="NotFoundError")throw o;return r.startsWith("_dnslink.")?r=r.replace("_dnslink.",""):r=`_dnslink.${r}`,bC(r,e,t,n,i)}}async function vC(r,e,t,n={}){return P2(r,n.maxRecursiveDepth??Hq,e,t,n)}var kx=class{routing;constructor(e){this.routing=e}async put(e,t,n={}){try{await this.routing.put(e,t,n)}catch(i){n.onProgress?.(new G("ipns:routing:helia:error",i))}}async get(e,t={}){try{return await this.routing.get(e,t)}catch(n){t.onProgress?.(new G("ipns:routing:helia:error",n))}throw new Error("Not found")}};function EC(r){return new kx(r)}var kp;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={key:Pe(0),value:Pe(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.key=t.bytes();break}case 2:{o.value=t.bytes();break}case 5:{o.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(kp||(kp={}));function SC(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),o=String(r.getUTCMinutes()).padStart(2,"0"),s=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${o}:${s}.${c}Z`}function AC(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),i=parseInt(t[2],10)-1,o=parseInt(t[3],10),s=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,o,s,a,c,l))}var kt=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return kp.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:SC(this.timeReceived)}}static deserialize(e){let t=kp.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=AC(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var R2=globalThis.CustomEvent??Event;async function*Or(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,i=new EventTarget,o=[],s=ye(),a=ye(),c=!1,l,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let m of r){if(o.length===t&&(s=ye(),await s.promise),u)break;let g={done:!1};o.push(g),m().then(w=>{g.done=!0,g.ok=!0,g.value=w,i.dispatchEvent(new R2("task-complete"))},w=>{g.done=!0,g.err=w,i.dispatchEvent(new R2("task-complete"))})}c=!0,i.dispatchEvent(new R2("task-complete"))}catch(m){l=m,i.dispatchEvent(new R2("task-complete"))}});function f(){return n?o[0]?.done:!!o.find(m=>m.done)}function*h(){for(;o.length>0&&o[0].done;){let m=o[0];if(o.shift(),m.ok)yield m.value;else throw u=!0,s.resolve(),m.err;s.resolve()}}function*d(){for(;f();)for(let m=0;m<o.length;m++)if(o[m].done){let g=o[m];if(o.splice(m,1),m--,g.ok)yield g.value;else throw u=!0,s.resolve(),g.err;s.resolve()}}for(;;){if(f()||(a=ye(),await a.promise),l!=null)throw l;if(n?yield*h():yield*d(),c&&o.length===0)break}}var Mf=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),i=e-this.movingAverage,o=n*i;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+i*o),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*i}else this.movingAverage=e;this.previousTime=t}};var zq=1.2,Kq=2,qq=2e3,ho=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;constructor(e={}){this.success=new Mf(e.interval??5e3),this.failure=new Mf(e.interval??5e3),this.next=new Mf(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??Kq,this.timeoutMultiplier=e.timeoutMultiplier??zq,this.minTimeout=e.minTimeout??qq,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),i=Ne([e.signal,n]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var Px=class{readNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.readNext=ye(),this.haveNext=ye()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ye(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ye(),await Dt(this.readNext.promise,t?.signal,t)}};function _C(){return new Px}var D2=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};var Rx=class extends Error{code;constructor(e,t){super(e),this.code=t}},Dx=class extends Rx{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted",this.name="AbortError"}};function IC(r,e){let t=_C();r.sink(t).catch(async s=>{await t.end(s)}),r.sink=async s=>{for await(let a of s)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let i=new oe;return{read:async(s,a)=>{a?.signal?.throwIfAborted();let c,l=new Promise((u,f)=>{c=()=>{f(new Dx("Read aborted"))},a?.signal?.addEventListener("abort",c)});try{if(s==null){let{done:f,value:h}=await Promise.race([n.next(),l]);return f===!0?new oe:h}for(;i.byteLength<s;){let{value:f,done:h}=await Promise.race([n.next(),l]);if(h===!0)throw new D2("unexpected end of input");i.append(f)}let u=i.sublist(0,s);return i.consume(s),u}finally{c!=null&&a?.signal?.removeEventListener("abort",c)}},write:async(s,a)=>{a?.signal?.throwIfAborted(),s instanceof Uint8Array?await t.push(s,a):await t.push(s.subarray(),a)},unwrap:()=>{if(i.byteLength>0){let s=r.source;r.source=async function*(){e?.yieldBytes===!1?yield i:yield*i,yield*s}()}return r}}}var N2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},O2=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},L2=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function TC(r,e={}){let t=IC(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Oe(e.maxDataLength));let n=e?.lengthDecoder??Zt,i=e?.lengthEncoder??ht;return{read:async s=>{let a=-1,c=new oe;for(;;){c.append(await t.read(1,s));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new N2("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new L2("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new O2("message length too long");return t.read(a,s)},write:async(s,a)=>{await t.write(new oe(i(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new oe(...s.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function Nn(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=$t(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}function Da(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function jq(r){return r[Symbol.asyncIterator]!=null}function Wq(r){if(jq(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var B2=Wq;var Gq=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Xq(r,e,t){let n,i=new Promise((o,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=Gq(r),f=(...d)=>{let m=t.multiArgs?d:d[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(n(),o(c)))},h=d=>{n(),s(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(i.cancel=n,typeof t.timeout=="number"){let o=io(i,{milliseconds:t.timeout});return o.cancel=n,o}return i}function CC(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=Xq(r,e,t),i=n.then(o=>o[0]);return i.cancel=n.cancel,i}function Qq(r){return r[Symbol.asyncIterator]!=null}function Zq(r){if(Qq(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var Ps=Zq;var kC;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(kC||(kC={}));function M2(r){return new nt("/dht/record/"+H(r,"base32"),!1)}function PC(r){return{async put(e,t,n={}){try{let i=M2(e);try{let s=await r.get(i),a=kt.deserialize(s);if(pe(a.value,t))return}catch(s){if(s.name!=="NotFoundError")throw s}let o=new kt(e,t,new Date);n.onProgress?.(new G("ipns:routing:datastore:put")),await r.put(i,o.serialize(),n)}catch(i){throw n.onProgress?.(new G("ipns:routing:datastore:error",i)),i}},async get(e,t={}){try{let n=M2(e);t.onProgress?.(new G("ipns:routing:datastore:get"));let i=await r.get(n,t),o=kt.deserialize(i);return{record:o.value,created:o.timeReceived}}catch(n){throw t.onProgress?.(new G("ipns:routing:datastore:error",n)),n}},async has(e,t={}){let n=M2(e);return r.has(n,t)},async delete(e,t){let n=M2(e);return r.delete(n,t)}}}var Nx="/ipns/";function Ox(r,e){return r.code===e}var Rs=ze("helia:ipns"),NC=60*1e3,OC=60*NC,tj=48*OC,Lx=23*OC,RC=BigInt(NC)*5000000n,DC={[fn.prefix]:fn,[Le.prefix]:Le},Bx=class{routers;localStore;timeout;dns;log;constructor(e,t=[]){this.routers=[EC(e.routing),...t],this.localStore=PC(e.datastore),this.dns=e.dns,this.log=e.logger.forComponent("helia:ipns")}async publish(e,t,n={}){try{let i=1n,o=ks(e.publicKey.toMultihash());if(await this.localStore.has(o,n)){let{record:l}=await this.localStore.get(o,n);i=Dn(l).sequence+1n}let s=n.ttl!=null?BigInt(n.ttl)*1000000n:RC,a=await gC(e,t,i,n.lifetime??tj,{...n,ttlNs:s}),c=Pa(a);return await this.localStore.put(o,c,n),n.offline!==!0&&await Promise.all(this.routers.map(async l=>{await l.put(o,c,n)})),a}catch(i){throw n.onProgress?.(new G("ipns:publish:error",i)),i}}async resolve(e,t={}){let n=bS(e)?e.toMultihash():e,i=ks(n),o=await this.#r(i,t);return{...await this.#e(o.value,t),record:o}}async resolveDNSLink(e,t={}){let n=await vC(e,this.dns,this.log,t);return{...await this.#e(n.value,t),answer:n.answer}}republish(e={}){if(this.timeout!=null)throw new Error("Republish is already running");e.signal?.addEventListener("abort",()=>{clearTimeout(this.timeout)});async function t(){let n=Date.now();e.onProgress?.(new G("ipns:republish:start"));let o=Date.now()-n,s=Lx-o;s<0&&(s=e.interval??Lx),setTimeout(()=>{t().catch(a=>{Rs.error("error republishing",a)})},s)}this.timeout=setTimeout(()=>{t().catch(n=>{Rs.error("error republishing",n)})},e.interval??Lx)}async#e(e,t={}){let n=e.split("/");try{let i=n[1];if(i==="ipns"){let o=n[2],s=o.substring(0,1),a;if(s==="1"||s==="Q")a=Le.decode(`z${o}`);else if(DC[s]!=null)a=DC[s].decode(o);else throw new T2(`Unsupported multibase prefix "${s}"`);let c;try{c=Ue(a)}catch{c=W.decode(a).multihash}if(!Ox(c,0)&&!Ox(c,18))throw new C2(`Unsupported multihash codec "${c.code}"`);let{cid:l}=await this.resolve(c,t),u=n.slice(3).join("/");return{cid:l,path:u}}else if(i==="ipfs"){let o=W.parse(n[2]),s=n.slice(3).join("/");return{cid:o,path:s}}}catch(i){Rs.error("error parsing ipfs path",i)}throw Rs.error("invalid ipfs path %s",e),new k2("Invalid value")}async#r(e,t={}){let n=[];if(await this.localStore.has(e,t))if(Rs("record is present in the cache"),t.nocache!==!0)try{let{record:a,created:c}=await this.localStore.get(e,t);this.log("record retrieved from cache"),await Ra(e,a),this.log("record was valid");let l=Dn(a),u=Number((l.ttl??RC)/1000000n);if(c.getTime()+u>Date.now())return this.log("record TTL was valid"),l;if(t.offline===!0)return this.log("record TTL has been reached but we are resolving offline-only, returning record"),l;this.log("record TTL has been reached, searching routing for updates"),n.push(a)}catch(a){this.log("cached record was invalid",a),await this.localStore.delete(e,t)}else Rs("ignoring local cache due to nocache=true option");if(t.offline===!0)throw new We("Record was not present in the cache or has expired");Rs("did not have record locally");let o=0;if(await Promise.all(this.routers.map(async a=>{let c;try{c=await a.get(e,{...t,validate:!1})}catch(l){Rs.error("error finding IPNS record",l);return}try{await Ra(e,c),n.push(c)}catch(l){o++,Rs.error("error finding IPNS record",l)}})),n.length===0)throw o>0?new I2(`${o>1?`${o} records`:"Record"} found for routing key ${o>1?"were":"was"} invalid`):new We("Could not find record for routing key");let s=n[A2(e,n)];return await this.localStore.put(e,s,t),Dn(s)}async republishRecord(e,t,n={}){let i;try{if(i=Tp(t)?.toMultihash(),i==null)if(typeof e=="string"){e.startsWith(Nx)&&(e=e.slice(Nx.length));try{i=at(e).toMultihash()}catch(a){throw new Error(`Invalid string key: ${a.message}`)}}else i=e;if(i==null)throw new Error("No public key multihash found to determine the routing key");let o=ks(i),s=Pa(t);await Ra(o,s),await this.localStore.put(o,s,n),n.offline!==!0&&await Promise.all(this.routers.map(async a=>{await a.put(o,s,n)}))}catch(o){throw n.onProgress?.(new G("ipns:republish:error",{key:i,record:t,err:o})),o}}};function LC(r,{routers:e=[]}={}){return new Bx(r,e)}function Mx(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}var BC="[a-fA-F\\d:]",Na=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${BC})|(?<=${BC})(?=\\s|$))`:"",po="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",fr="[a-fA-F\\d]{1,4}",U2=`
(?:
(?:${fr}:){7}(?:${fr}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${fr}:){6}(?:${po}|:${fr}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${fr}:){5}(?::${po}|(?::${fr}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${fr}:){4}(?:(?::${fr}){0,1}:${po}|(?::${fr}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${fr}:){3}(?:(?::${fr}){0,2}:${po}|(?::${fr}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${fr}:){2}(?:(?::${fr}){0,3}:${po}|(?::${fr}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${fr}:){1}(?:(?::${fr}){0,4}:${po}|(?::${fr}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${fr}){0,5}:${po}|(?::${fr}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),rj=new RegExp(`(?:^${po}$)|(?:^${U2}$)`),nj=new RegExp(`^${po}$`),ij=new RegExp(`^${U2}$`),Ux=r=>r&&r.exact?rj:new RegExp(`(?:${Na(r)}${po}${Na(r)})|(?:${Na(r)}${U2}${Na(r)})`,"g");Ux.v4=r=>r&&r.exact?nj:new RegExp(`${Na(r)}${po}${Na(r)}`,"g");Ux.v6=r=>r&&r.exact?ij:new RegExp(`${Na(r)}${U2}${Na(r)}`,"g");var Fx=Ux;function $x(r){let e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}function MC(){return!1}var{toString:oj}=Object.prototype;function Hx(r){return oj.call(r)==="[object RegExp]"}var UC={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function Vx(r,e={}){if(!Hx(r))throw new TypeError("Expected a RegExp instance");let t=Object.keys(UC).map(i=>(typeof e[i]=="boolean"?e[i]:r[i])?UC[i]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function zx(r,e,{timeout:t}={}){try{return $x(()=>Vx(r).test(e),{timeout:t})()}catch(n){if(MC(n))return!1;throw n}}var sj=15,aj=45,FC={timeout:400};function Kx(r){return r.length>aj?!1:zx(Fx.v6({exact:!0}),r,FC)}function $C(r){return r.length>sj?!1:zx(Fx.v4({exact:!0}),r,FC)}var HC={http:"80",https:"443",ws:"80",wss:"443"},cj=["http","https","ws","wss"];function VC(r,e){e=e??{};let t=e.defaultDnsType??"dns4",{scheme:n,hostname:i,port:o,path:s}=lj(r),a=[uj(i,t),fj(o,n),dj(n)];s!=null&&a.push(hj(s));let c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return se(c)}function lj(r){let[e]=r.split(":");cj.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:i,pathname:o,search:s}=new URL(r);if(i==null||i===""){let c=pj(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return o!=null&&o!==""&&o!=="/"&&(o.startsWith("/")&&(o=o.substring(1)),a=o),s!=null&&s!==""&&(a=a??"",a+=s),{scheme:e,hostname:n,port:i,path:a}}function uj(r,e){if(!(r==null||r==="")){if($C(r))return["ip4",r];if(Kx(r))return["ip6",r];if(r[0]==="["){let t=r.substring(1,r.length-1);if(Kx(t))return["ip6",t]}return[e,r]}}function fj(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function dj(r){if(r.match(/^tcp$|^udp$/)==null)return[r]}function hj(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function pj(r){if(!(r==null||r===""||HC[r]==null))return HC[r]}var mj=["https://trustless-gateway.link","https://4everland.io"],gj=2336;function yj(r){return r=r.toString(),{id:gn(W.createV1(gj,cr.digest(O(r)))),multiaddrs:[VC(r)]}}var qx=class{gateways;constructor(e={}){this.gateways=(e.gateways??mj).map(t=>yj(t))}async*findProviders(e,t){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}};function Pp(r={}){return new qx(r)}var jx=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}};function Rp(r){return new jx(r)}var Dp=class extends Is{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(Jt.encode(e.multihash.bytes),t),e}get(e){let t=this.data.get(Jt.encode(e.multihash.bytes));if(t==null)throw new ki;return t}has(e){return this.data.has(Jt.encode(e.multihash.bytes))}async delete(e){this.data.delete(Jt.encode(e.multihash.bytes))}async*getAll(){for(let[e,t]of this.data.entries())yield{cid:W.createV1(vt,Ue(Jt.decode(e))),block:t}}};var z2e=ze("blockstore:core:tiered");var qC="SHARDING";function xj(r){return r[Symbol.asyncIterator]!=null}function bj(r,e){return xj(r)?async function*(){yield*(await Ps(r)).sort(e)}():function*(){yield*Ps(r).sort(e)}()}var F2=bj;var Ds=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await Sr(this.putMany(e,n)),e=[],await Sr(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let i=e.prefix;n=si(n,o=>o.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,o)=>si(i,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,o)=>F2(i,o),n)),e.offset!=null){let i=0,o=e.offset;n=si(n,()=>i++>=o)}return e.limit!=null&&(n=la(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let i=e.prefix;n=si(n,o=>o.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,o)=>si(i,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,o)=>F2(i,o),n)),e.offset!=null){let i=e.offset,o=0;n=si(n,()=>o++>=i)}return e.limit!=null&&(n=la(n,e.limit)),n}};var bl=class extends Ds{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){let t=this.data.get(e.toString());if(t==null)throw new ki;return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(let[e,t]of this.data.entries())yield{key:new nt(e),value:t}}*_allKeys(){for(let e of this.data.keys())yield new nt(e)}};var vye=new nt(qC);var Lye=ze("datastore:core:tiered");var $2=class extends Fg{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}};var H2=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function mo(r,e){let t=v0();r.sink(t).catch(async s=>{await t.end(s)}),r.sink=async s=>{for await(let a of s)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let i=new oe;return{read:async s=>{if(s?.signal?.throwIfAborted(),s?.bytes==null){let{done:c,value:l}=await Dt(n.next(),s?.signal);return c===!0?null:l}for(;i.byteLength<s.bytes;){let{value:c,done:l}=await Dt(n.next(),s?.signal);if(l===!0)throw new H2("unexpected end of input");i.append(c)}let a=i.sublist(0,s.bytes);return i.consume(s.bytes),a},write:async(s,a)=>{a?.signal?.throwIfAborted(),s instanceof Uint8Array?await t.push(s,a):await t.push(s.subarray(),a)},unwrap:()=>{if(i.byteLength>0){let s=r.source;r.source=async function*(){e?.yieldBytes===!1?yield i:yield*i,yield*s}()}return r}}}var V2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},z2=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},K2=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Wx(r,e={}){let t=mo(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Oe(e.maxDataLength));let n=e?.lengthDecoder??Zt,i=e?.lengthEncoder??ht;return{read:async s=>{let a=-1,c=new oe;for(;;){c.append(await t.read({...s,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new V2("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new K2("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new z2("message length too long");return t.read({...s,bytes:a})},write:async(s,a)=>{await t.write(new oe(i(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new oe(...s.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function Gx(){let r=ye(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function WC(){let r=Gx(),e=Gx();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var Uf=!!globalThis.process?.env?.DUMP_SESSION_KEYS;function XC(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function q2(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function j2(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function on(r,...e){if(!XC(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Xx(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function YC(r,e){on(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ns(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function Os(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function vj(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}var Ej=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Sj(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function W2(r){if(typeof r=="string")r=Sj(r);else if(XC(r))r=G2(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function QC(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function ZC(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var Yx=(r,e)=>{function t(n,...i){if(on(n),!Ej)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){let u=i[0];if(!u)throw new Error("nonce / iv required");r.varSizeNonce?on(u):on(u,r.nonceLength)}let o=r.tagLength;o&&i[1]!==void 0&&on(i[1]);let s=e(n,...i),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");on(f)}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,on(u),a(s.encrypt.length,f),s.encrypt(u,f)},decrypt(u,f){if(on(u),o&&u.length<o)throw new Error("invalid ciphertext length: smaller than tagLength="+o);return a(s.decrypt.length,f),s.decrypt(u,f)}}}return Object.assign(t,r),t};function Qx(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!Aj(e))throw new Error("invalid output, must be aligned");return e}function GC(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),s=Number(t>>i&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function JC(r,e,t){q2(t);let n=new Uint8Array(16),i=vj(n);return GC(i,0,BigInt(e),t),GC(i,8,BigInt(r),t),n}function Aj(r){return r.byteOffset%4===0}function G2(r){return Uint8Array.from(r)}var tk=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),_j=tk("expand 16-byte k"),Ij=tk("expand 32-byte k"),Tj=Ns(_j),Cj=Ns(Ij);function de(r,e){return r<<e|r>>>32-e}function Zx(r){return r.byteOffset%4===0}var X2=64,kj=16,rk=2**32-1,ek=new Uint32Array;function Pj(r,e,t,n,i,o,s,a){let c=i.length,l=new Uint8Array(X2),u=Ns(l),f=Zx(i)&&Zx(o),h=f?Ns(i):ek,d=f?Ns(o):ek;for(let m=0;m<c;s++){if(r(e,t,n,u,s,a),s>=rk)throw new Error("arx: counter overflow");let g=Math.min(X2,c-m);if(f&&g===X2){let w=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let x=0,v;x<kj;x++)v=w+x,d[v]=h[v]^u[x];m+=X2;continue}for(let w=0,x;w<g;w++)x=m+w,o[x]=i[x]^l[w];m+=g}}function Jx(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:o,rounds:s}=QC({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return j2(i),j2(s),q2(o),q2(t),(a,c,l,u,f=0)=>{on(a),on(c),on(l);let h=l.length;if(u===void 0&&(u=new Uint8Array(h)),on(u),j2(f),f<0||f>=rk)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],m=a.length,g,w;if(m===32)d.push(g=G2(a)),w=Cj;else if(m===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),w=Tj,d.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);Zx(c)||d.push(c=G2(c));let x=Ns(g);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(w,x,Ns(c.subarray(0,16)),x),c=c.subarray(16)}let v=16-i;if(v!==c.length)throw new Error(`arx: nonce must be ${v} or 16 bytes`);if(v!==12){let S=new Uint8Array(12);S.set(c,o?0:12-c.length),c=S,d.push(c)}let b=Ns(c);return Pj(r,w,x,b,l,u,f,s),Os(...d),u}}var Lr=(r,e)=>r[e++]&255|(r[e++]&255)<<8,e9=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=W2(e),on(e,32);let t=Lr(e,0),n=Lr(e,2),i=Lr(e,4),o=Lr(e,6),s=Lr(e,8),a=Lr(e,10),c=Lr(e,12),l=Lr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|o<<9)&8191,this.r[4]=(o>>>4|s<<12)&255,this.r[5]=s>>>1&8190,this.r[6]=(s>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Lr(e,16+2*u)}process(e,t,n=!1){let i=n?0:2048,{h:o,r:s}=this,a=s[0],c=s[1],l=s[2],u=s[3],f=s[4],h=s[5],d=s[6],m=s[7],g=s[8],w=s[9],x=Lr(e,t+0),v=Lr(e,t+2),b=Lr(e,t+4),S=Lr(e,t+6),T=Lr(e,t+8),D=Lr(e,t+10),A=Lr(e,t+12),I=Lr(e,t+14),k=o[0]+(x&8191),Q=o[1]+((x>>>13|v<<3)&8191),K=o[2]+((v>>>10|b<<6)&8191),V=o[3]+((b>>>7|S<<9)&8191),X=o[4]+((S>>>4|T<<12)&8191),$=o[5]+(T>>>1&8191),F=o[6]+((T>>>14|D<<2)&8191),z=o[7]+((D>>>11|A<<5)&8191),M=o[8]+((A>>>8|I<<8)&8191),R=o[9]+(I>>>5|i),N=0,Z=N+k*a+Q*(5*w)+K*(5*g)+V*(5*m)+X*(5*d);N=Z>>>13,Z&=8191,Z+=$*(5*h)+F*(5*f)+z*(5*u)+M*(5*l)+R*(5*c),N+=Z>>>13,Z&=8191;let ne=N+k*c+Q*a+K*(5*w)+V*(5*g)+X*(5*m);N=ne>>>13,ne&=8191,ne+=$*(5*d)+F*(5*h)+z*(5*f)+M*(5*u)+R*(5*l),N+=ne>>>13,ne&=8191;let q=N+k*l+Q*c+K*a+V*(5*w)+X*(5*g);N=q>>>13,q&=8191,q+=$*(5*m)+F*(5*d)+z*(5*h)+M*(5*f)+R*(5*u),N+=q>>>13,q&=8191;let ge=N+k*u+Q*l+K*c+V*a+X*(5*w);N=ge>>>13,ge&=8191,ge+=$*(5*g)+F*(5*m)+z*(5*d)+M*(5*h)+R*(5*f),N+=ge>>>13,ge&=8191;let ke=N+k*f+Q*u+K*l+V*c+X*a;N=ke>>>13,ke&=8191,ke+=$*(5*w)+F*(5*g)+z*(5*m)+M*(5*d)+R*(5*h),N+=ke>>>13,ke&=8191;let le=N+k*h+Q*f+K*u+V*l+X*c;N=le>>>13,le&=8191,le+=$*a+F*(5*w)+z*(5*g)+M*(5*m)+R*(5*d),N+=le>>>13,le&=8191;let De=N+k*d+Q*h+K*f+V*u+X*l;N=De>>>13,De&=8191,De+=$*c+F*a+z*(5*w)+M*(5*g)+R*(5*m),N+=De>>>13,De&=8191;let et=N+k*m+Q*d+K*h+V*f+X*u;N=et>>>13,et&=8191,et+=$*l+F*c+z*a+M*(5*w)+R*(5*g),N+=et>>>13,et&=8191;let Ye=N+k*g+Q*m+K*d+V*h+X*f;N=Ye>>>13,Ye&=8191,Ye+=$*u+F*l+z*c+M*a+R*(5*w),N+=Ye>>>13,Ye&=8191;let pt=N+k*w+Q*g+K*m+V*d+X*h;N=pt>>>13,pt&=8191,pt+=$*f+F*u+z*l+M*c+R*a,N+=pt>>>13,pt&=8191,N=(N<<2)+N|0,N=N+Z|0,Z=N&8191,N=N>>>13,ne+=N,o[0]=Z,o[1]=ne,o[2]=q,o[3]=ge,o[4]=ke,o[5]=le,o[6]=De,o[7]=et,o[8]=Ye,o[9]=pt}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(i^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)e[a]=e[a]&o|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let s=e[0]+t[0];e[0]=s&65535;for(let a=1;a<8;a++)s=(e[a]+t[a]|0)+(s>>>16)|0,e[a]=s&65535;Os(n)}update(e){Xx(this),e=W2(e),on(e);let{buffer:t,blockLen:n}=this,i=e.length;for(let o=0;o<i;){let s=Math.min(n-this.pos,i-o);if(s===n){for(;n<=i-o;o+=n)this.process(e,o);continue}t.set(e.subarray(o,o+s),this.pos),this.pos+=s,o+=s,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Os(this.h,this.r,this.buffer,this.pad)}digestInto(e){Xx(this),YC(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let o=0;for(let s=0;s<8;s++)e[o++]=n[s]>>>0,e[o++]=n[s]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function Rj(r){let e=(n,i)=>r(i).update(W2(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var nk=Rj(r=>new e9(r));function sk(r,e,t,n,i,o=20){let s=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],m=e[4],g=e[5],w=e[6],x=e[7],v=i,b=t[0],S=t[1],T=t[2],D=s,A=a,I=c,k=l,Q=u,K=f,V=h,X=d,$=m,F=g,z=w,M=x,R=v,N=b,Z=S,ne=T;for(let ge=0;ge<o;ge+=2)D=D+Q|0,R=de(R^D,16),$=$+R|0,Q=de(Q^$,12),D=D+Q|0,R=de(R^D,8),$=$+R|0,Q=de(Q^$,7),A=A+K|0,N=de(N^A,16),F=F+N|0,K=de(K^F,12),A=A+K|0,N=de(N^A,8),F=F+N|0,K=de(K^F,7),I=I+V|0,Z=de(Z^I,16),z=z+Z|0,V=de(V^z,12),I=I+V|0,Z=de(Z^I,8),z=z+Z|0,V=de(V^z,7),k=k+X|0,ne=de(ne^k,16),M=M+ne|0,X=de(X^M,12),k=k+X|0,ne=de(ne^k,8),M=M+ne|0,X=de(X^M,7),D=D+K|0,ne=de(ne^D,16),z=z+ne|0,K=de(K^z,12),D=D+K|0,ne=de(ne^D,8),z=z+ne|0,K=de(K^z,7),A=A+V|0,R=de(R^A,16),M=M+R|0,V=de(V^M,12),A=A+V|0,R=de(R^A,8),M=M+R|0,V=de(V^M,7),I=I+X|0,N=de(N^I,16),$=$+N|0,X=de(X^$,12),I=I+X|0,N=de(N^I,8),$=$+N|0,X=de(X^$,7),k=k+Q|0,Z=de(Z^k,16),F=F+Z|0,Q=de(Q^F,12),k=k+Q|0,Z=de(Z^k,8),F=F+Z|0,Q=de(Q^F,7);let q=0;n[q++]=s+D|0,n[q++]=a+A|0,n[q++]=c+I|0,n[q++]=l+k|0,n[q++]=u+Q|0,n[q++]=f+K|0,n[q++]=h+V|0,n[q++]=d+X|0,n[q++]=m+$|0,n[q++]=g+F|0,n[q++]=w+z|0,n[q++]=x+M|0,n[q++]=v+R|0,n[q++]=b+N|0,n[q++]=S+Z|0,n[q++]=T+ne|0}function Dj(r,e,t,n){let i=r[0],o=r[1],s=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],h=e[4],d=e[5],m=e[6],g=e[7],w=t[0],x=t[1],v=t[2],b=t[3];for(let T=0;T<20;T+=2)i=i+c|0,w=de(w^i,16),h=h+w|0,c=de(c^h,12),i=i+c|0,w=de(w^i,8),h=h+w|0,c=de(c^h,7),o=o+l|0,x=de(x^o,16),d=d+x|0,l=de(l^d,12),o=o+l|0,x=de(x^o,8),d=d+x|0,l=de(l^d,7),s=s+u|0,v=de(v^s,16),m=m+v|0,u=de(u^m,12),s=s+u|0,v=de(v^s,8),m=m+v|0,u=de(u^m,7),a=a+f|0,b=de(b^a,16),g=g+b|0,f=de(f^g,12),a=a+f|0,b=de(b^a,8),g=g+b|0,f=de(f^g,7),i=i+l|0,b=de(b^i,16),m=m+b|0,l=de(l^m,12),i=i+l|0,b=de(b^i,8),m=m+b|0,l=de(l^m,7),o=o+u|0,w=de(w^o,16),g=g+w|0,u=de(u^g,12),o=o+u|0,w=de(w^o,8),g=g+w|0,u=de(u^g,7),s=s+f|0,x=de(x^s,16),h=h+x|0,f=de(f^h,12),s=s+f|0,x=de(x^s,8),h=h+x|0,f=de(f^h,7),a=a+c|0,v=de(v^a,16),d=d+v|0,c=de(c^d,12),a=a+c|0,v=de(v^a,8),d=d+v|0,c=de(c^d,7);let S=0;n[S++]=i,n[S++]=o,n[S++]=s,n[S++]=a,n[S++]=w,n[S++]=x,n[S++]=v,n[S++]=b}var Nj=Jx(sk,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Oj=Jx(sk,{counterRight:!1,counterLength:8,extendNonceFn:Dj,allowShortKeys:!1});var Lj=new Uint8Array(16),ik=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(Lj.subarray(t))},Bj=new Uint8Array(32);function ok(r,e,t,n,i){let o=r(e,t,Bj),s=nk.create(o);i&&ik(s,i),ik(s,n);let a=JC(n.length,i?i.length:0,!0);s.update(a);let c=s.digest();return Os(o,a),c}var ak=r=>(e,t,n)=>({encrypt(o,s){let a=o.length;s=Qx(a+16,s,!1),s.set(o);let c=s.subarray(0,-16);r(e,t,c,c,1);let l=ok(r,e,t,c,n);return s.set(l,a),Os(l),s},decrypt(o,s){s=Qx(o.length-16,s,!1);let a=o.subarray(0,-16),c=o.subarray(-16),l=ok(r,e,t,a,n);if(!ZC(c,l))throw new Error("invalid tag");return s.set(o.subarray(0,-16)),r(e,t,s,s,1),Os(l),s}}),t9=Yx({blockSize:64,nonceLength:12,tagLength:16},ak(Nj)),I3e=Yx({blockSize:64,nonceLength:24,tagLength:16},ak(Oj));function lk(r,e,t){return Vc(r),t===void 0&&(t=new Uint8Array(r.outputLen)),ba(r,ha(t),ha(e))}var r9=Uint8Array.from([0]),ck=Uint8Array.of();function uk(r,e,t,n=32){Vc(r),Bo(n);let i=r.outputLen;if(n>255*i)throw new Error("Length should be <= 255*HashLen");let o=Math.ceil(n/i);t===void 0&&(t=ck);let s=new Uint8Array(o*i),a=ba.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<o;u++)r9[0]=u+1,c.update(u===0?ck:l).update(t).update(r9).digestInto(l),s.set(l,i*u),a._cloneInto(c);return a.destroy(),c.destroy(),Jr(l,r9),s.slice(0,n)}var n9={hashSHA256(r){return Vo(r.subarray())},getHKDF(r,e){let t=lk(Vo,e,r),i=uk(Vo,t,void 0,96),o=i.subarray(0,32),s=i.subarray(32,64),a=i.subarray(64,96);return[o,s,a]},generateX25519KeyPair(){let r=Uh.utils.randomPrivateKey();return{publicKey:Uh.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:Uh.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return Uh.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return t9(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,i){return t9(n,e,t).decrypt(r.subarray(),i)}};var fk=n9;function dk(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var Ff=r=>{let e=$t(2);return e[0]=r>>8,e[1]=r,e};Ff.bytes=2;var Np=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Np.bytes=2;function hk(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function i9(r,e){!e.enabled||!Uf||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${H(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${H(r.privateKey,"hex")}`)):e("Missing local static keys."))}function o9(r,e){!e.enabled||!Uf||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${H(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${H(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function pk(r,e){!e.enabled||!Uf||e(r?`REMOTE_STATIC_PUBLIC_KEY ${H(r.subarray(),"hex")}`:"Missing remote static public key.")}function s9(r,e){!e.enabled||!Uf||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${H(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function a9(r,e,t){!t.enabled||!Uf||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&H(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&H(e.k,"hex")}`))}var $f=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var Mj=0,Uj=4294967295,Fj="Cipherstate has reached maximum n, a new handshake must be performed",Y2=class{n;bytes;view;constructor(e=Mj){this.n=e,this.bytes=Pe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>Uj)throw new Error(Fj)}};var vl=Pe(0),Hf=class{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new Y2(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),i}},c9=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let n=O(t,"utf-8");this.h=$j(e,n),this.ck=this.h,this.cs=new Hf(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Hf(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new oe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,vl);return[new Hf(this.crypto,e),new Hf(this.crypto,t)]}},l9=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:n,prologue:i,initiator:o,s,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new c9(t,n),this.ss.mixHash(i),this.initiator=o,this.s=s,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let i=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(i),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},Op=class extends l9{writeMessageA(e){return new oe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new oe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new oe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new $f(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new $f(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new $f(`handshake stage 2 validation fail: ${t.message}`)}}};function $j(r,e){if(e.length<=32){let t=Pe(32);return t.set(e),t}else return r.hash(e)}var Q2;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let o of t.webtransportCerthashes)n.uint32(10),n.bytes(o);if(t.streamMuxers!=null)for(let o of t.streamMuxers)n.uint32(18),n.string(o);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={webtransportCerthashes:[],streamMuxers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.webtransportCerthashes!=null&&o.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new wt('Decode error - map field "webtransportCerthashes" had too many elements');o.webtransportCerthashes.push(t.bytes());break}case 2:{if(i.limits?.streamMuxers!=null&&o.streamMuxers.length===i.limits.streamMuxers)throw new wt('Decode error - map field "streamMuxers" had too many elements');o.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Q2||(Q2={}));var Lp;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),Q2.codec().encode(t.extensions,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={identityKey:Pe(0),identitySig:Pe(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.identityKey=t.bytes();break}case 2:{o.identitySig=t.bytes();break}case 4:{o.extensions=Q2.codec().decode(t,t.uint32(),{limits:i.limits?.extensions});break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Lp||(Lp={}));async function u9(r,e,t){let n=await r.sign(mk(e));return Lp.encode({identityKey:lr(r.publicKey),identitySig:n,extensions:t})}async function f9(r,e,t){try{let n=Lp.decode(r),i=tr(n.identityKey);if(t?.equals(i)===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");let o=mk(e);if(!await i.verify(o,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new r0(n.message)}}function mk(r){let e=O("noise-libp2p-static-key:");return r instanceof Uint8Array?Ve([e,r],e.length+r.length):(r.prepend(e),r)}async function gk(r,e){let{log:t,connection:n,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await u9(o,a.publicKey,l),f=new Op({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});i9(f.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(f.writeMessageA(vl),e),t.trace("Stage 0 - Initiator finished sending first message."),o9(f.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let h=f.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),s9(f.re,t),pk(f.rs,t),t.trace("Initiator going to check remote's signature...");let d=await f9(h,f.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(f.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[m,g]=f.ss.split();return a9(m,g,t),{payload:d,encrypt:w=>m.encryptWithAd(vl,w),decrypt:(w,x)=>g.decryptWithAd(vl,w,x)}}async function yk(r,e){let{log:t,connection:n,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await u9(o,a.publicKey,l),f=new Op({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});i9(f.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),f.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),s9(f.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(f.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),o9(f.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let h=f.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let d=await f9(h,f.rs,c),[m,g]=f.ss.split();return a9(m,g,t),{payload:d,encrypt:w=>g.encryptWithAd(vl,w),decrypt:(w,x)=>m.decryptWithAd(vl,w,x)}}var xk=16;function bk(r,e){return async function*(t){for await(let n of t)for(let i=0;i<n.length;i+=65519){let o=i+65519;o>n.length&&(o=n.length);let s;n instanceof Uint8Array?s=r.encrypt(n.subarray(i,o)):s=r.encrypt(n.sublist(i,o)),e?.encryptedPackets.increment(),yield new oe(Ff(s.byteLength),s)}}}function vk(r,e){return async function*(t){for await(let n of t)for(let i=0;i<n.length;i+=65535){let o=i+65535;if(o>n.length&&(o=n.length),o-xk<i)throw new Error("Invalid chunk");let s=n.sublist(i,o),a=n.subarray(i,o-xk);try{let c=r.decrypt(s,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}var Z2=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){let{staticNoiseKey:n,extensions:i,crypto:o,prologueBytes:s}=t,{metrics:a}=e;this.components=e;let c=o??fk;this.crypto=dk(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?hk(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=s??Pe(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[tt]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){let n=Wx(e,{lengthEncoder:Ff,lengthDecoder:Np,maxDataLength:65535}),i=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),o=await this.createSecureConnection(n,i);e.source=o.source,e.sink=o.sink;let s=tr(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:zo(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;let t=this.components.upgrader.getStreamMuxers();if(t!=null)for(let n of e){let i=t.get(n);if(i!=null)return i}if(e.length)throw new n0("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){let n=Wx(e,{lengthEncoder:Ff,lengthDecoder:Np,maxDataLength:65535}),i=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),o=await this.createSecureConnection(n,i);e.source=o.source,e.sink=o.sink;let s=tr(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:zo(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,i){let o,s=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{o=await gk({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return o}async performHandshakeResponder(e,t,n,i){let o,s=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{o=await yk({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return o}async createSecureConnection(e,t){let[n,i]=WC(),o=e.unwrap();return await ot(n,bk(t,this.metrics),o,s=>Qi(s,{lengthDecoder:Np}),vk(t,this.metrics),n),i}};function J2(r={}){return e=>new Z2(e,r)}function Oa(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}var go=class extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}},Vf=class extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}},zf=class extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}},ey=class extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}},ty=class extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}},ry=class extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}},ny=class extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}},Kf=class extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}};var Ek=new Set([go.name,Vf.name,zf.name,ty.name,ry.name,ny.name,Kf.name]),Mp=256*1024,Sk=16*1024*1024;var Ak={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Mp,maxStreamWindowSize:Sk,maxMessageSize:64*1024};function _k(r){if(r.keepAliveInterval<=0)throw new U("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new U("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new U("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<Mp)throw new U("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new U("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new U("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new U("MaxMessageSize must be greater than a kilobyte")}var jt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(jt||(jt={}));var Ot;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Ot||(Ot={}));var q4e=Object.values(Ot).filter(r=>typeof r!="string"),Ik=0,Pi;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Pi||(Pi={}));var La=12;var Tk=2**24;function Hj(r){if(r[0]!==Ik)throw new go("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Tk+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Tk+(r[9]<<16)+(r[10]<<8)+r[11]}}var iy=class{source;buffer;frameInProgress;constructor(e){this.source=Vj(e),this.buffer=new oe,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:i}=t;n===jt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new ey("decoding frame already in progress");if(this.buffer.length<La)return;let e=Hj(this.buffer.subarray(0,La));return this.buffer.consume(La),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Vj(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function d9(r){let e=new Uint8Array(La);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function Ck(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function oy(r,e){let t=Oa(r).return?.();Ck(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var zj=5e3;function h9(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Ba=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=ye(),this.closed=ye(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??zj,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=Xr({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Cc(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let i=this.sendNewStream(t);h9(i)&&await i}let n=()=>{oy(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new oe(i):i;let o=this.sendData(i,t);h9(o)&&(this.sendingData=ye(),await o,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Dt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Dt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Dt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Dt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();h9(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new o0("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var Ri;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Ri||(Ri={}));var sy=class extends Ba{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Ri.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Mp,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=ul(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-La,e.length),i=this.getSendFlags();this.sendFrame({type:jt.Data,flag:i,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:jt.WindowUpdate,flag:Ot.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|Ot.FIN;this.sendFrame({type:jt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,i=()=>{this.status==="open"||this.status==="closing"?n(new Cr("Stream aborted")):t()};e.signal?.addEventListener("abort",i);try{await new Promise((o,s)=>{this.sendWindowCapacityUpdate=()=>{o()},n=s,t=o})}finally{e.signal?.removeEventListener("abort",i)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Kf("Receive window exceeded");let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Ot.ACK)===Ot.ACK&&this.state===Ri.SYNSent&&(this.state=Ri.Established),(e&Ot.FIN)===Ot.FIN&&this.remoteCloseWrite(),(e&Ot.RST)===Ot.RST&&this.reset()}getSendFlags(){switch(this.state){case Ri.Init:return this.state=Ri.SYNSent,Ot.SYN;case Ri.SYNReceived:return this.state=Ri.Established,Ot.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:jt.WindowUpdate,flag:e,streamID:this._id,length:i})}};var kk="/yamux/1.0.0",Kj=500,ay=class{protocol=kk;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[tt]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new p9(this._components,{...this._init,...e})}},p9=class{protocol=kk;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...Ak,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),_k(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Xr({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{let i=()=>{let a=Oa(n);if(a.return!=null){let c=a.return();qj(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}},o,s;try{let a=new iy(n);try{this.closeController.signal.addEventListener("abort",i);for await(let c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",i)}o=Pi.NormalTermination}catch(a){Ek.has(a.name)?(this.log?.error("protocol error in sink",a),o=Pi.ProtocolError):(this.log?.error("internal error in sink",a),o=Pi.InternalError),s=a}this.log?.trace("muxer sink ended"),s!=null?this.abort(s,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new No("Muxer closed remotely");if(this.localGoAway!==void 0)throw new No("Muxer closed locally");let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new ca("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,Ri.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new No("Muxer closed remotely");if(this.localGoAway!==void 0)throw new No("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,o)=>{let s=()=>{o(new No("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",s,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",s),i()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Pi.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){let n=AbortSignal.timeout(Kj);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Pi.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,i){if(this._streams.get(e)!=null)throw new U("Stream already exists with that id");let o=new sy({id:e.toString(),name:t,state:n,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(o)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return o}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:i,length:o}=e;if(this.log?.trace("received frame %o",e),n===0)switch(i){case jt.Ping:{this.handlePing(e);return}case jt.GoAway:{this.handleGoAway(o);return}default:throw new go("Invalid frame type")}else switch(e.type){case jt.Data:case jt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new go("Invalid frame type")}}handlePing(e){if(e.flag===Ot.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Ot.ACK);else if(e.flag===Ot.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new go("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new Vf("ping not requested");if(this.activePing.id!==e)throw new zf("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Pi[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:i,type:o}=e;(i&Ot.SYN)===Ot.SYN&&this.incomingStream(n);let s=this._streams.get(n);if(s===void 0){if(o===jt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(o){case jt.WindowUpdate:{s.handleWindowUpdate(e);return}case jt.Data:{if(t===void 0)throw new Error("unreachable");await s.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new U("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:jt.WindowUpdate,flag:Ot.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:jt.WindowUpdate,flag:Ot.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,Ri.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===jt.Data){if(t===void 0)throw new go("Invalid frame");this.source.push(new oe(d9(e),t))}else this.source.push(d9(e))}sendPing(e,t=Ot.SYN){t===Ot.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:jt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Pi.NormalTermination){this.log?.("sending GoAway reason=%s",Pi[e]),this.localGoAway=e,this.sendFrame({type:jt.GoAway,flag:0,streamID:0,length:e})}};function qj(r){return r!=null&&typeof r.then=="function"}function Pk(r={}){return e=>new ay(e,r)}var jj=41;function cy(r){try{let[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===jj)return GT("2000::/3",t)}catch{}return!1}function ly(r){try{let[[e]]=r.stringTuples();return e===4||e===41}catch{}return!1}function Di(r){try{if(!ly(r))return!1;let[[,e]]=r.stringTuples();return e==null?!1:bn(e)??!1}catch{}return!0}function Rk(r,e,t){let n,i;function o(){let a={signal:i.signal};if(t?.timeout!=null){let c=Ne([i.signal,AbortSignal.timeout(t.timeout)]);a.signal=c}Promise.resolve().then(async()=>{await r(a)}).catch(()=>{}).finally(()=>{i.signal.aborted||(n=setTimeout(o,e))})}let s=!1;return{setInterval:a=>{e=a,n!=null&&(clearTimeout(n),n=setTimeout(o,e))},setTimeout:a=>{t==null&&(t={}),t.timeout=a},start:()=>{s||(s=!0,i=new AbortController,i.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),i?.abort(),s=!1}}}var uy=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},fy=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},dy=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Dk(r,e={}){let t=mo(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Oe(e.maxDataLength));let n=e?.lengthDecoder??Zt,i=e?.lengthEncoder??ht;return{read:async s=>{let a=-1,c=new oe;for(;;){c.append(await t.read({...s,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new uy("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new dy("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new fy("message length too long");return t.read({...s,bytes:a})},write:async(s,a)=>{await t.write(new oe(i(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new oe(...s.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function ir(r,e){let t=Dk(r,e),n={read:async(i,o)=>{let s=await t.read(o);return i.decode(s)},write:async(i,o,s)=>{await t.write(o.encode(i),s)},writeV:async(i,o,s)=>{await t.writeV(i.map(a=>o.encode(a)),s)},pb:i=>({read:async o=>n.read(i,o),write:async(o,s)=>n.write(o,i,s),writeV:async(o,s)=>n.writeV(o,i,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var Nk="libp2p",Ok="autonat",Lk="1.0.0";var Pt;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>St(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(i||(i={})),function(l){l.codec=()=>St(i)}(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){let u;l.codec=()=>(u==null&&(u=Ee((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let m of f.addrs)h.uint32(18),h.bytes(m);d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={addrs:[]},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.id=f.bytes();break}case 2:{if(d.limits?.addrs!=null&&m.addrs.length===d.limits.addrs)throw new wt('Decode error - map field "addrs" had too many elements');m.addrs.push(f.bytes());break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>ve(f,l.codec()),l.decode=(f,h)=>be(f,l.codec(),h)})(o=r.PeerInfo||(r.PeerInfo={}));let s;(function(l){let u;l.codec=()=>(u==null&&(u=Ee((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.peer=r.PeerInfo.codec().decode(f,f.uint32(),{limits:d.limits?.peer});break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>ve(f,l.codec()),l.decode=(f,h)=>be(f,l.codec(),h)})(s=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=Ee((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.status=r.ResponseStatus.codec().decode(f);break}case 2:{m.statusText=f.string();break}case 3:{m.addr=f.bytes();break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>ve(f,l.codec()),l.decode=(f,h)=>be(f,l.codec(),h)})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=Ee((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u,f={})=>{let h={},d=u==null?l.len:l.pos+u;for(;l.pos<d;){let m=l.uint32();switch(m>>>3){case 1:{h.type=r.MessageType.codec().decode(l);break}case 2:{h.dial=r.Dial.codec().decode(l,l.uint32(),{limits:f.limits?.dial});break}case 3:{h.dialResponse=r.DialResponse.codec().decode(l,l.uint32(),{limits:f.limits?.dialResponse});break}default:{l.skipType(m&7);break}}}return h})),c),r.encode=l=>ve(l,r.codec()),r.decode=(l,u)=>be(l,r.codec(),u)})(Pt||(Pt={}));var Zj=4,Jj=8,hy=class{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??Nk}/${Ok}/${Lk}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??20,this.connectionThreshold=t.connectionThreshold??80,this.maxMessageSize=t.maxMessageSize??8192,this.dialResults=new Map,this.findPeers=Rk(this.findRandomPeers.bind(this),6e4),this.addressFilter=Tn(1024)}[Symbol.toStringTag]="@libp2p/autonat";[tt]=["@libp2p/autonat"];get[Jn](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;let t=Ne([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(let n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout);let n=ir(e.stream,{maxDataLength:this.maxMessageSize}).pb(Pt);try{let i=await n.read({signal:t}),o=await this.handleAutonatMessage(i,e.connection,{signal:t});await n.write(o,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.stream.abort(i)}}async handleAutonatMessage(e,t,n){let i=this.components.addressManager.getAddresses().map(f=>f.toOptions().host),o=e.dial;if(o==null)return this.log.error("dial was missing from message"),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,a=o.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{let f=Ue(a.id);s=ur(f)}catch(f){return this.log.error("invalid PeerId - %e",f),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let c=a.addrs.map(f=>se(f)).filter(f=>{let h=f.toOptions();return Di(f)?!1:h.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",f,t.remoteAddr),!1):i.includes(h.host)?!1:this.components.transportManager.dialTransportForMultiaddr(f)==null?(this.log.trace("not dialing %a - transport unsupported",f),!1):!0}).map(f=>(f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${s.toString()}`)),f));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",s),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(f=>f.toString()).join(", "),s);let l="",u=c[0];for await(let f of c){let h;u=f;try{if(h=await this.components.connectionManager.openConnection(f,n),!h.remoteAddr.equals(f))throw this.log.error("tried to dial %a but dialed %a",f,h.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",s,f),{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.OK,addr:h.remoteAddr.decapsulateCode(Ie("p2p").code).bytes}}}catch(d){this.log.error("could not dial %p - %e",s,d),l=d.message}finally{h!=null&&await h.close()}}return{type:Pt.MessageType.DIAL_RESPONSE,dialResponse:{status:Pt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){let n=this.components.addressManager.getAddressesWithMetadata().sort((i,o)=>i.type==="observed"&&o.type!=="observed"?1:o.type==="observed"&&i.type!=="observed"?-1:0).filter(i=>!(!(i.expires<Date.now())||i.multiaddr.toOptions().family===6&&(!t||!cy(i.multiaddr))||Di(i.multiaddr)));for(let i of n){let o=i.multiaddr.toString(),s=this.dialResults.get(o);if(s!=null){if(s.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",s.multiaddr,e);continue}if(s.queue.size>10){this.log.trace("%a already has enough peers queued",s.multiaddr);continue}}if(s==null){let a=i.expires<Date.now();if(a&&this.addressFilter.remove?.(o),this.addressFilter.has(o))continue;this.addressFilter.add(o),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",o),s={multiaddr:i.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:n7(),queue:new Pr({concurrency:3,maxSize:50}),type:i.type,lastVerified:i.lastVerified},this.dialResults.set(o,s)}return s}}removeOutdatedMultiaddrResults(){let e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(let t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();let n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:s})=>s.toOptions().family===6),i=this.getNetworkSegment(e.remoteAddr),o=this.getFirstUnverifiedMultiaddr(i,n);if(o==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){o.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",o.multiaddr),this.confirmAddress(o)):this.log("skipping verifying %a because we are too close to the connection limit",o.multiaddr);return}o.queue.add(async s=>{await this.askPeerToVerify(e,i,s)},{peerId:e.remotePeer,multiaddr:o.multiaddr}).catch(s=>{o?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,o?.multiaddr,s)})}async askPeerToVerify(e,t,n){let i=this.dialResults.get(n.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}let o=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);let s=await e.newStream(this.protocol,{signal:o});try{let a=ir(s).pb(Pt),[,c]=await Promise.all([a.write({type:Pt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:o}),a.read({signal:o})]);if(c.type!==Pt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}let l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==Pt.ResponseStatus.OK&&l!==Pt.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(n.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===Pt.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===Pt.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===Zj&&this.confirmAddress(i),i.failure===Jj&&this.unconfirmAddress(i)}finally{try{await s.close({signal:o})}catch(a){s.abort(a)}}}hasConnectionCapacity(){let t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){let t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}};function Bk(r={}){return e=>new hy(e,r)}var eW=ce("dns4"),tW=ce("dns6"),rW=ce("dnsaddr"),Sl=or(ce("dns"),rW,eW,tW),gy=or(ce("ip4"),ce("ip6")),qf=or(Ce(gy,ce("tcp")),Ce(Sl,ce("tcp"))),yy=Ce(gy,ce("udp")),nW=Ce(yy,ce("utp")),iW=Ce(yy,ce("quic")),oW=Ce(yy,ce("quic-v1")),m9=or(Ce(qf,ce("ws")),Ce(Sl,ce("ws"))),py=or(Ce(m9,ce("p2p")),m9),g9=or(Ce(qf,ce("wss")),Ce(Sl,ce("wss")),Ce(qf,ce("tls"),ce("ws")),Ce(Sl,ce("tls"),ce("ws"))),my=or(Ce(g9,ce("p2p")),g9),y9=or(Ce(qf,ce("http")),Ce(gy,ce("http")),Ce(Sl,ce("http"))),w9=or(Ce(qf,ce("https")),Ce(gy,ce("https")),Ce(Sl,ce("https"))),Mk=Ce(yy,ce("webrtc-direct"),ce("certhash")),$k=or(Ce(Mk,ce("p2p")),Mk),Uk=Ce(oW,ce("webtransport"),ce("certhash"),ce("certhash")),Hk=or(Ce(Uk,ce("p2p")),Uk),Vk=or(Ce(py,ce("p2p-webrtc-star"),ce("p2p")),Ce(my,ce("p2p-webrtc-star"),ce("p2p")),Ce(py,ce("p2p-webrtc-star")),Ce(my,ce("p2p-webrtc-star"))),p5e=or(Ce(py,ce("p2p-websocket-star"),ce("p2p")),Ce(my,ce("p2p-websocket-star"),ce("p2p")),Ce(py,ce("p2p-websocket-star")),Ce(my,ce("p2p-websocket-star"))),zk=or(Ce(y9,ce("p2p-webrtc-direct"),ce("p2p")),Ce(w9,ce("p2p-webrtc-direct"),ce("p2p")),Ce(y9,ce("p2p-webrtc-direct")),Ce(w9,ce("p2p-webrtc-direct"))),Al=or(m9,g9,y9,w9,Vk,zk,qf,nW,iW,Sl,$k,Hk),m5e=or(Ce(Al,ce("p2p-stardust"),ce("p2p")),Ce(Al,ce("p2p-stardust"))),Ma=or(Ce(Al,ce("p2p")),Vk,zk,$k,Hk,ce("p2p")),Fk=or(Ce(Ma,ce("p2p-circuit"),Ma),Ce(Ma,ce("p2p-circuit")),Ce(ce("p2p-circuit"),Ma),Ce(Al,ce("p2p-circuit")),Ce(ce("p2p-circuit"),Al),ce("p2p-circuit")),Kk=()=>or(Ce(Fk,Kk),Fk),El=Kk(),qk=or(Ce(El,Ma,El),Ce(Ma,El),Ce(El,Ma),El,Ma);var g5e=or(Ce(El,ce("webrtc"),ce("p2p")),Ce(El,ce("webrtc")),Ce(Al,ce("webrtc"),ce("p2p")),Ce(Al,ce("webrtc")),ce("webrtc"));function jk(r){function e(t){let n;try{n=se(t)}catch{return!1}let i=r(n.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function Ce(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(i=>(n=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:jk(e),partialMatch:e}}function or(...r){function e(n){let i=null;return r.some(o=>{let s=typeof o=="function"?o().partialMatch(n):o.partialMatch(n);return s!=null?(i=s,!0):!1}),i}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:jk(e),partialMatch:e}}function ce(r){let e=r;function t(i){let o;try{o=se(i)}catch{return!1}let s=o.protoNames();return s.length===1&&s[0]===e}function n(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var sW="bootstrap",aW=50,cW=1e3,x9=class extends Me{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??cW,this.list=[];for(let n of t.list){if(!qk.matches(n)){this.log.error("Invalid multiaddr");continue}let i=se(n),o=i.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let s={id:at(o),multiaddrs:[i]};this.list.push(s)}this._init=t}[Ic]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[tt]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??sW]:{value:this._init.tagValue??aW,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function Wk(r){return e=>new x9(e,r)}var Up;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={publicKey:Pe(0),payloadType:Pe(0),payload:Pe(0),signature:Pe(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=t.bytes();break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Up||(Up={}));var wy=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var ai=class r{static createFromProtobuf=async e=>{let t=Up.decode(e),n=tr(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(t==null)throw new Error("Missing private key");let n=e.domain,i=e.codec,o=e.marshal(),s=Gk(n,i,o),a=await t.sign(s.subarray());return new r({publicKey:t.publicKey,payloadType:i,payload:o,signature:a})};static openAndCertify=async(e,t)=>{let n=await r.createFromProtobuf(e);if(!await n.validate(t))throw new wy("Envelope signature is not valid for the given domain");return n};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:i,signature:o}=e;this.publicKey=t,this.payloadType=n,this.payload=i,this.signature=o}marshal(){return this.marshaled==null&&(this.marshaled=Up.encode({publicKey:lr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return pe(this.marshal(),e.marshal())}async validate(e){let t=Gk(e,this.payloadType,this.payload);return this.publicKey.verify(t.subarray(),this.signature)}},Gk=(r,e,t)=>{let n=O(r),i=ht(n.byteLength),o=ht(e.length),s=ht(t.length);return new oe(i,n,o,e,s,t)};function Xk(r,e){let t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}var Yk="libp2p-peer-record",Qk=Uint8Array.from([3,1]);var Fp;(function(r){let e;(function(n){let i;n.codec=()=>(i==null&&(i=Ee((o,s,a={})=>{a.lengthDelimited!==!1&&s.fork(),o.multiaddr!=null&&o.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(o.multiaddr)),a.lengthDelimited!==!1&&s.ldelim()},(o,s,a={})=>{let c={multiaddr:Pe(0)},l=s==null?o.len:o.pos+s;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:{c.multiaddr=o.bytes();break}default:{o.skipType(u&7);break}}}return c})),i),n.encode=o=>ve(o,n.codec()),n.decode=(o,s)=>be(o,n.codec(),s)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=Ee((n,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(i.uint32(10),i.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(i.uint32(16),i.uint64(n.seq)),n.addresses!=null)for(let s of n.addresses)i.uint32(26),r.AddressInfo.codec().encode(s,i);o.lengthDelimited!==!1&&i.ldelim()},(n,i,o={})=>{let s={peerId:Pe(0),seq:0n,addresses:[]},a=i==null?n.len:n.pos+i;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{s.peerId=n.bytes();break}case 2:{s.seq=n.uint64();break}case 3:{if(o.limits?.addresses!=null&&s.addresses.length===o.limits.addresses)throw new wt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:o.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return s})),t),r.encode=n=>ve(n,r.codec()),r.decode=(n,i)=>be(n,r.codec(),i)})(Fp||(Fp={}));var vn=class r{static createFromProtobuf=e=>{let t=Fp.decode(e),n=ur(Ue(t.peerId)),i=(t.addresses??[]).map(s=>se(s.multiaddr)),o=t.seq;return new r({peerId:n,multiaddrs:i,seqNumber:o})};static DOMAIN=Yk;static CODEC=Qk;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Fp.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!Xk(this.multiaddrs,e.multiaddrs))}};var b9=1e3,Zk=60*b9,Jk=290;var X5e=2*60*Zk,eP=1,xy=2e3,tP=100;var $p=`${ia}-circuit-relay`,Y5e=`${ia}-circuit-relay-source`,Q5e=2*Zk,Z5e=BigInt(1<<17),_l="/libp2p/circuit/relay/0.2.0/hop",v9="/libp2p/circuit/relay/0.2.0/stop",J5e=30*b9,e8e=30*b9,E9=300,rP=4096,nP=.001;var Ua;(function(r){let e;(function(i){i.RESERVE="RESERVE",i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.RESERVE=0]="RESERVE",i[i.CONNECT=1]="CONNECT",i[i.STATUS=2]="STATUS"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.peer!=null&&(o.uint32(18),jf.codec().encode(i.peer,o)),i.reservation!=null&&(o.uint32(26),by.codec().encode(i.reservation,o)),i.limit!=null&&(o.uint32(34),Wf.codec().encode(i.limit,o)),i.status!=null&&(o.uint32(40),Br.codec().encode(i.status,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.peer=jf.codec().decode(i,i.uint32(),{limits:s.limits?.peer});break}case 3:{a.reservation=by.codec().decode(i,i.uint32(),{limits:s.limits?.reservation});break}case 4:{a.limit=Wf.codec().decode(i,i.uint32(),{limits:s.limits?.limit});break}case 5:{a.status=Br.codec().decode(i);break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(Ua||(Ua={}));var jo;(function(r){let e;(function(i){i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.CONNECT=0]="CONNECT",i[i.STATUS=1]="STATUS"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.peer!=null&&(o.uint32(18),jf.codec().encode(i.peer,o)),i.limit!=null&&(o.uint32(26),Wf.codec().encode(i.limit,o)),i.status!=null&&(o.uint32(32),Br.codec().encode(i.status,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.peer=jf.codec().decode(i,i.uint32(),{limits:s.limits?.peer});break}case 3:{a.limit=Wf.codec().decode(i,i.uint32(),{limits:s.limits?.limit});break}case 4:{a.status=Br.codec().decode(i);break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(jo||(jo={}));var jf;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={id:Pe(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.id=t.bytes();break}case 2:{if(i.limits?.addrs!=null&&o.addrs.length===i.limits.addrs)throw new wt('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(jf||(jf={}));var by;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);t.voucher!=null&&(n.uint32(26),Ey.codec().encode(t.voucher,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.expire=t.uint64();break}case 2:{if(i.limits?.addrs!=null&&o.addrs.length===i.limits.addrs)throw new wt('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}case 3:{o.voucher=Ey.codec().decode(t,t.uint32(),{limits:i.limits?.voucher});break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(by||(by={}));var Wf;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.duration=t.uint32();break}case 2:{o.data=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Wf||(Wf={}));var Br;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Br||(Br={}));var S9;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(S9||(S9={}));(function(r){r.codec=()=>St(S9)})(Br||(Br={}));var vy;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={relay:Pe(0),peer:Pe(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.relay=t.bytes();break}case 2:{o.peer=t.bytes();break}case 3:{o.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(vy||(vy={}));var Ey;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),vy.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={publicKey:Pe(0),payloadType:Pe(0),signature:Pe(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=vy.codec().decode(t,t.uint32(),{limits:i.limits?.payload});break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Ey||(Ey={}));var Hp=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},Sy=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},Ay=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function A9(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var Vp=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},_y=gt(Ge(Jg.matchers[0],$e("p2p-circuit"))),Iy=gt($e("p2p-circuit"));function _9(r){let{stream:e,remoteAddr:t,logger:n,onDataRead:i,onDataWrite:o}=r,s=n.forComponent("libp2p:stream:converter"),a=!1,c=!1,l=e.close.bind(e);e.close=async m=>{await l(m),d(!0)};let u=e.abort.bind(e);e.abort=m=>{u(m),d(!0)};let f=e.sink.bind(e);e.sink=async m=>{try{await f(ot(m,g=>ul(g,w=>o?.(w))))}catch(g){g.type!=="aborted"&&s.error("%s error in sink",t,g)}finally{c=!0,d()}};let h={log:s,sink:e.sink,source:async function*(){try{for await(let m of e.source)i?.(m),yield m}finally{a=!0,d()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function d(m){m===!0&&(a=!0,c=!0),a&&c&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}var Ty=class extends Me{peerStore;registrar;connectionManager;randomWalk;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(_l,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.peerStore.all({filters:[n=>n.protocols.includes(_l)],orders:[()=>Math.random()<.5?1:-1,(n,i)=>{let o=iP(n),s=iP(i);return o>s?-1:s>o?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new Pr({concurrency:5});this.log("start random walk");for await(let n of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(i=>i.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(async()=>{let i=Ne([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(n.id,{signal:i})}finally{i.clear()}},{peerId:n.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p",n.id,i)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}};function iP(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date(H(e)).getTime()}var I9=class extends Me{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??xy,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(Iy.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(_y.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);let o=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(o)}}else throw new kc(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>se(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function oP(r){return new I9(r)}var sP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var aP=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=sP[t[r]&63];return e};var lW=60*1e3*10,uW=60*1e3*5,fW=30*1e3,Cy=class extends Me{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new _r,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??tP,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??xy,this.started=!1,this.relayFilter=Tn(100),this.reserveQueue=new Pr({concurrency:t?.reservationConcurrency??eP,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(o=>o.connection===n.detail.id)!=null&&this.#r(n.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",n.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has($p)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[$p]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#n()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=aP();return this.pendingReservations.push(e),this.#n(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new kc("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Ay("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new kc("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let i=Date.now();try{let o=this.reservations.get(e);if(o!=null){let m=this.connectionManager.getConnections(e),g=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(w=>w.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),g=!0),g&&A9(o.reservation.expire)>lW)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:o};await this.#r(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new Hp("Not making reservation on discovered relay because we do not need any more relays");let s=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:s});if(Rn.matches(a.remoteAddr))throw new Sy("not creating reservation over relayed connection");let c=await this.#e(a,{signal:s}),l=A9(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());let u=Math.min(Math.max(l-uW,fW),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#r(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u),h;if(t==="discovered"){let m=this.pendingReservations.pop();if(m==null)throw new Hp("Made reservation on relay but did not need any more discovered relays");h={timeout:f,reservation:c,type:t,connection:a.id,id:m}}else h={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[$p]:{value:1,ttl:l}}}),this.#n();let d={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:d}),d}catch(o){throw t==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#r(e).catch(s=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,s)}),o}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(_l,t),o=ir(n).pb(Ua);this.log.trace("send RESERVE to %p",e.remotePeer),await o.write({type:Ua.Type.RESERVE},t);let s;try{this.log.trace("reading response from %p",e.remotePeer),s=await o.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",s),s.status===Br.OK&&s.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let l of s.reservation.addrs){let u=se(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=se(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return s.reservation.addrs=[...c].map(l=>se(l).bytes),s.reservation}let a=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#r(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[$p]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#n())}#n(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Tn(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var dW=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(se)}catch{return!1}return!0},cP={maxInboundStopStreams:E9,maxOutboundStopStreams:E9,stopTimeout:3e4},ky=class{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??cP.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??cP.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new Ty(e,{filter:t.discoveryFilter??a7(rP,nP)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,i)})}),this.reservationStore=new Cy(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[tt]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Jn](){return this.discovery!=null?["@libp2p/identify"]:[]}[oa]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,await this.registrar.handle(v9,e=>{let t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await kr(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Gr(this.discovery,this.reservationStore),await this.registrar.unhandle(v9),this.started=!1}async dial(e,t){if(e.protoCodes().filter(d=>d===Jk).length!==1){let d="Invalid circuit relay address";throw this.log.error(d,e),new ms(d)}let n=e.toString().split("/p2p-circuit"),i=se(n[0]),o=se(n[n.length-1]),s=i.getPeerId(),a=o.getPeerId();if(s==null||a==null){let d=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${d}`),new ms(`C${d}`)}let c=at(s),l=at(a),f=this.connectionManager.getConnections(c)[0];f==null?(await this.peerStore.merge(c,{multiaddrs:[i]}),t.onProgress?.(new G("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new G("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new G("circuit-relay:open-hop-stream")),h=await f.newStream(_l,t);let d=ir(h),m=d.pb(Ua);t.onProgress?.(new G("circuit-relay:write-connect-message")),await m.write({type:Ua.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[se(o).bytes]}},t),t.onProgress?.(new G("circuit-relay:read-connect-response"));let g=await m.read(t);if(g.status!==Br.OK)throw new Be(`failed to connect via relay with status ${g?.status?.toString()??"undefined"}`);let w=new Vp(g.limit),x=_9({stream:d.unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:w.onData,onDataWrite:w.onData});return this.log("new outbound relayed connection %a",x.remoteAddr),await this.upgrader.upgradeOutbound(x,{...t,limits:w.getLimits()})}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,d),h?.abort(d),d}}createListener(e){return oP({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>_y.exactMatch(t)||Iy.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Rn.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}let i=ir(t).pb(jo),o=await i.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,o.type),o?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:jo.Type.STATUS,status:Br.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(o.type!==jo.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:jo.Type.STATUS,status:Br.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!dW(o)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:jo.Type.STATUS,status:Br.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}let s=ur(Ue(o.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,s)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:jo.Type.STATUS,status:Br.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:jo.Type.STATUS,status:Br.OK},{signal:n});let a=new Vp(o.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),l=this.addressManager.getAddresses()[0],u=_9({stream:i.unwrap().unwrap(),remoteAddr:c,localAddr:l,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}};function T9(r={}){return e=>new ky(e,r)}var lP=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},hW=new WeakMap;function pW({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i?.aborted)return Promise.reject(lP());let o,s,a,c=r??clearTimeout,l=()=>{c(o),a(lP())},u=()=>{i&&i.removeEventListener("abort",l)},f=new Promise((h,d)=>{s=()=>{u(),h(n)},a=d,o=(e??setTimeout)(s,t)});return i&&i.addEventListener("abort",l,{once:!0}),hW.set(f,()=>{c(o),o=null,s()}),f}}var mW=pW(),Py=mW;var yo;(function(r){let e;(function(i){i.UNUSED="UNUSED",i.CONNECT="CONNECT",i.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.UNUSED=0]="UNUSED",i[i.CONNECT=100]="CONNECT",i[i.SYNC=300]="SYNC"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.observedAddresses!=null)for(let a of i.observedAddresses)o.uint32(18),o.bytes(a);s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={observedAddresses:[]},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{if(s.limits?.observedAddresses!=null&&a.observedAddresses.length===s.limits.observedAddresses)throw new wt('Decode error - map field "observedAddresses" had too many elements');a.observedAddresses.push(i.bytes());break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(yo||(yo={}));function C9(r,e){return Rn.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:xp.matches(r)?!0:LT.matches(r)?bn(r.toOptions().host)===!1:!1}var uP=1024*4,fP=100,Ry={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},Dy=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??Ry.timeout,this.retries=t.retries??Ry.retries,this.maxInboundStreams=t.maxInboundStreams??Ry.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Ry.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[Jn]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(zp,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Rn.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(zp,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(zp),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([zp],{signal:i.signal,runOnLimitedConnection:!0});let o=ir(t,{maxDataLength:uP}).pb(yo);this.log("B sending connect to %p",e.remotePeer);let s=Date.now();await o.write({type:yo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);let a=await o.read(i);if(a.type!==yo.Type.CONNECT)throw this.log("A sent wrong message type"),new Be("DCUtR message type was incorrect");let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let l=Date.now()-s;this.log("A sending sync, rtt %dms",l),await o.write({type:yo.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await Py(l/2),this.log("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:i.signal,priority:fP,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(o){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,o),t?.abort(o),n===this.retries)throw o}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{let o=i.multiaddr;return o.getPeerId()==null?o.encapsulate(`/p2p/${e.remotePeer}`):o}).filter(i=>C9(i,this.transportManager));if(n.length>0){let i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let o=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(Rn.exactMatch(o.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,o.remoteAddr),await e.close({signal:i}),!0}catch(o){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,o)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let i=ir(e,{maxDataLength:uP}).pb(yo);this.log("A receiving connect");let o=await i.read(n);if(o.type!==yo.Type.CONNECT)throw this.log("B sent wrong message type"),new Be("DCUtR message type was incorrect");if(o.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let s=this.getDialableMultiaddrs(o.observedAddresses);if(s.length===0)throw this.log("B had no dialable multiaddrs"),new Be("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:yo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(n)).type!==yo.Type.SYNC)throw new Be("DCUtR message type was incorrect");this.log("A dialing",s);let c=await this.connectionManager.openConnection(s,{signal:n.signal,priority:fP,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let i=se(n);if(!C9(i,this.transportManager))continue;t.push(i)}catch{}return t}};var zp="/libp2p/dcutr";function dP(r={}){return e=>new Dy(e,r)}var hP="0.1.0",pP="id",mP="id/push",gP="1.0.0",yP="1.0.0";var Fa;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let o of t.listenAddrs)n.uint32(18),n.bytes(o);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let o of t.protocols)n.uint32(26),n.string(o);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 5:{o.protocolVersion=t.string();break}case 6:{o.agentVersion=t.string();break}case 1:{o.publicKey=t.bytes();break}case 2:{if(i.limits?.listenAddrs!=null&&o.listenAddrs.length===i.limits.listenAddrs)throw new wt('Decode error - map field "listenAddrs" had too many elements');o.listenAddrs.push(t.bytes());break}case 4:{o.observedAddr=t.bytes();break}case 3:{if(i.limits?.protocols!=null&&o.protocols.length===i.limits.protocols)throw new wt('Decode error - map field "protocols" had too many elements');o.protocols.push(t.string());break}case 8:{o.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Fa||(Fa={}));var On={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:32};function wP(r){if(r!=null&&r.length>0)try{return se(r)}catch{}}function wW(r,e){return e??r.userAgent}async function Ny(r,e,t,n,i){if(t("received identify from %p",n.remotePeer),i==null)throw new Be("message was null or undefined");let o={};if(i.listenAddrs.length>0&&(o.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:se(c)}))),i.protocols.length>0&&(o.protocols=i.protocols),i.publicKey!=null){let c=tr(i.publicKey);if(!zo(c).equals(n.remotePeer))throw new Be("public key did not match remote PeerId");o.publicKey=c}let s;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=i.signedPeerRecord,l=await ai.openAndCertify(c,vn.DOMAIN),u=vn.createFromProtobuf(l.payload),f=gn(l.publicKey.toCID());if(!u.peerId.equals(f))throw new Be("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new Be("signing key does not match remote PeerId");let h;try{h=await r.get(u.peerId)}catch(d){if(d.name!=="NotFoundError")throw d}if(h!=null&&(o.metadata=h.metadata,h.peerRecordEnvelope!=null)){let d=await ai.createFromProtobuf(h.peerRecordEnvelope),m=vn.createFromProtobuf(d.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=h.peerRecordEnvelope)}o.peerRecordEnvelope=c,o.addresses=u.multiaddrs.map(d=>({isCertified:!0,multiaddr:d})),s={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,o),await r.patch(n.remotePeer,o),i.agentVersion!=null||i.protocolVersion!=null){let c={};i.agentVersion!=null&&(c.AgentVersion=O(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=O(i.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>se(c)),observedAddr:i.observedAddr==null?void 0:se(i.observedAddr),protocols:i.protocols,signedPeerRecord:s,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var Gf=class{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??On.timeout,this.maxInboundStreams=t.maxInboundStreams??On.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??On.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??On.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??On.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??On.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??On.protocolPrefix}/${hP}`,agentVersion:wW(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:O(this.host.agentVersion),ProtocolVersion:O(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}};var Oy=class extends Gf{connectionManager;concurrency;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??On.protocolPrefix}/${mP}/${yP}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??On.concurrency,(t.runOnSelfUpdate??On.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(i=>{this.log.error(i)})})}[tt]=["@libp2p/identify-push"];async push(){if(!this.isStarted())return;let e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(Ie("p2p").code)),t=new vn({peerId:this.peerId,multiaddrs:e}),n=await ai.seal(t,this.privateKey),i=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),s=H(o.metadata.get("AgentVersion")??O(this.host.agentVersion)),a=H(o.metadata.get("ProtocolVersion")??O(this.host.protocolVersion)),c=this;async function*l(){for(let u of c.connectionManager.getConnections())(await c.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let h,d=AbortSignal.timeout(c.timeout);try{h=await u.newStream(c.protocol,{signal:d,runOnLimitedConnection:c.runOnLimitedConnection}),await ir(h,{maxDataLength:c.maxMessageSize}).pb(Fa).write({listenAddrs:e.map(g=>g.bytes),signedPeerRecord:n.marshal(),protocols:i,agentVersion:s,protocolVersion:a},{signal:d}),await h.close({signal:d})}catch(m){c.log.error("could not push identify update to peer",m),h?.abort(m)}})}await Sr(Or(l(),{concurrency:this.concurrency}))}async handleProtocol(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let i={signal:AbortSignal.timeout(this.timeout)},s=await ir(n,{maxDataLength:this.maxMessageSize}).pb(Fa).read(i);await n.close(i),await Ny(this.peerStore,this.events,this.log,t,s)}catch(i){this.log.error("received invalid message",i),n.abort(i);return}this.log.trace("handled push from %p",t.remotePeer)}};var xW=41,Ly=class extends Gf{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??On.protocolPrefix}/${pP}/${gP}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??On.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let i=n.detail;this.identify(i).catch(o=>{o.name!==ps.name&&this.log.error("error during identify trigged by connection:open",o)})})}[tt]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){let i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let o=await ir(n,{maxDataLength:this.maxMessageSize}).pb(Fa).read(t);return await n.close(t),o}catch(i){throw n?.abort(i),i}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:i,protocols:o,observedAddr:s}=n;if(i==null)throw new Be("public key was missing from identify message");let a=tr(i),c=gn(a.toCID());if(!e.remotePeer.equals(c))throw new Be("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new Be("identified peer is our own peer id?");return this.maybeAddObservedAddress(s),this.log("identify completed for peer %p and protocols %o",c,o),Ny(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){let t=wP(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),Di(t)){this.log.trace("our observed address was private");return}if(t.stringTuples()[0][0]===xW&&!cy(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}pl.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){let{connection:t,stream:n}=e,i=AbortSignal.timeout(this.timeout);try{let o=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map(u=>u.decapsulateCode(Ie("p2p").code)),a=o.peerRecordEnvelope;if(s.length>0&&a==null){let u=new vn({peerId:this.peerId,multiaddrs:s});a=(await ai.seal(u,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;OT.matches(t.remoteAddr)||(c=void 0),await ir(n).pb(Fa).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:lr(this.privateKey.publicKey),listenAddrs:s.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:o.protocols},{signal:i}),await n.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),n.abort(o)}}};function xP(r={}){return e=>new Ly(e,r)}function bP(r={}){return e=>new Oy(e,r)}var Xf=1e3,k9=60*Xf,By=60*k9,vP=36*By,EP="/ipfs/kad/1.0.0",SP=48*By;var AP=24*By,_P=10,IP=16384,TP=By,f7e=10*Xf;var My=20,Yf=3,CP=5*k9,kP=Xf,PP=5*Xf,RP=5*k9,DP=30*Xf,NP=180*Xf,P9=`${ia}-kad-dht`;var $a=class extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}},Uy=class extends Error{constructor(e="Query aborted"){super(e),this.name="QueryAbortedError"}},Fy=class extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}},$y=class extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}};var OP;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.key=t.bytes();break}case 2:{o.value=t.bytes();break}case 3:{o.author=t.bytes();break}case 4:{o.signature=t.bytes();break}case 5:{o.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(OP||(OP={}));var Ze;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(Ze||(Ze={}));var Hy;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Hy||(Hy={}));(function(r){r.codec=()=>St(Hy)})(Ze||(Ze={}));var Zf;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Zf||(Zf={}));var R9;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(R9||(R9={}));(function(r){r.codec=()=>St(R9)})(Zf||(Zf={}));var Qf;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let o of t.multiaddrs)n.uint32(18),n.bytes(o);t.connection!=null&&(n.uint32(24),Zf.codec().encode(t.connection,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={id:Pe(0),multiaddrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.id=t.bytes();break}case 2:{if(i.limits?.multiaddrs!=null&&o.multiaddrs.length===i.limits.multiaddrs)throw new wt('Decode error - map field "multiaddrs" had too many elements');o.multiaddrs.push(t.bytes());break}case 3:{o.connection=Zf.codec().decode(t);break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Qf||(Qf={}));var Ls;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.type!=null&&Hy[t.type]!==0&&(n.uint32(8),Ze.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let o of t.closer)n.uint32(66),Qf.codec().encode(o,n);if(t.providers!=null)for(let o of t.providers)n.uint32(74),Qf.codec().encode(o,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={type:Ze.PUT_VALUE,closer:[],providers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.type=Ze.codec().decode(t);break}case 10:{o.clusterLevel=t.int32();break}case 2:{o.key=t.bytes();break}case 3:{o.record=t.bytes();break}case 8:{if(i.limits?.closer!=null&&o.closer.length===i.limits.closer)throw new wt('Decode error - map field "closer" had too many elements');o.closer.push(Qf.codec().decode(t,t.uint32(),{limits:i.limits?.closer$}));break}case 9:{if(i.limits?.providers!=null&&o.providers.length===i.limits.providers)throw new wt('Decode error - map field "providers" had too many elements');o.providers.push(Qf.codec().decode(t,t.uint32(),{limits:i.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(Ls||(Ls={}));function D9(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Kp(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Vy(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function ci(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function N9(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function qp(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function O9(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function LP(r,e,t){if(t.length===0)throw new U("No records given");let i=H(e).split("/");if(i.length<3)throw new U("Record key does not have a selector function");let o=r[i[1].toString()];if(o==null)throw new $y(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:o(e,t)}function bW(r,e){return 0}var BP={pk:bW};async function Jf(r,e){let t=e.key,i=H(t).split("/");if(i.length<3)return;let o=r[i[1].toString()];if(o==null)throw new U(`No validator available for key type "${i[1]}"`);await o(t,e.value)}var vW=async(r,e)=>{if(!(r instanceof Uint8Array))throw new U('"key" must be a Uint8Array');if(r.byteLength<5)throw new U("Invalid public key record");if(H(r.subarray(0,4))!=="/pk/")throw new U("key was not prefixed with /pk/");let n=tr(e),i=r.slice(4);if(!pe(i,n.toMultihash().bytes))throw new U("public key does not match passed in key")},MP={pk:vW};var EW=O("/pk/");function UP(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let i=bn(n);return i==null?!0:!i})}}async function Ha(r){return(await Fe.digest(r)).digest}async function Mr(r){return Ha(r.toMultihash().bytes)}function Va(r,e){return new nt(`${r}/${H(e,"base32")}`,!1)}function FP(r){return Ve([EW,r.toMultihash().bytes])}function $P(r){return H(r.subarray(0,4))==="/pk/"}function HP(r){let e=Ue(r.subarray(4));return ur(e)}function L9(r,e){let t=new Date;return new kt(r,e,t).serialize()}var SW=290,AW=54,_W=55,IW=56,TW=4,CW=41;function VP(r){let e=r.stringTuples();for(let t of e)if(t[0]===SW)return!1;if(e[0][0]===AW||e[0][0]===_W||e[0][0]===IW)return!0;if(e[0][0]===TW||e[0][0]===CW){let t=bn(`${e[0][1]}`);return t==null||!t}return!1}function zy(r){let e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:W.createV1(vt,Ue(O(n,"base32"))),peerId:at(t)}}function Ky(r,e,t){let n=typeof e=="string"?e:H(e.multihash.bytes,"base32"),i=[r,n];return t!=null&&i.push(t.toString()),new nt(i.join("/"))}function qy(r){return new Date(Zt(r))}function Il(r,e,t){return async function*(...n){let i=e.queryTime?.timer(t),o=e.errorTime?.timer(t),s=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw s=!0,o?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||i?.()}}}function jy(r,e,t){return async function(...n){let i=e?.queryTime?.timer(t),o=e?.errorTime?.timer(t),s=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw s=!0,o?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||i?.()}}}var Wy=class{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){let{validators:n,selectors:i,peerRouting:o,queryManager:s,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=i,this.peerRouting=o,this.queryManager=s,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e){this.log("getLocal %b",e);let t=Va(this.datastorePrefix,e);this.log("fetching record for key %k",t);let n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let i=kt.deserialize(n);return await Jf(this.validators,i),i}async*sendCorrectionRecord(e,t,n,i={}){this.log("sendCorrection for %b",e);let o=L9(e,n);for(let{value:s,from:a}of t){if(pe(s,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Va(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,o.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l={type:Ze.PUT_VALUE,key:e,record:o};for await(let u of this.network.sendRequest(a,l,i))u.name==="PEER_RESPONSE"&&u.record!=null&&pe(u.record.value,kt.deserialize(o).value)&&(c=!0),yield u;c||(yield ci({from:a,error:new $a("Value not put correctly")},i)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);let i=L9(e,t),o=Va(this.datastorePrefix,e);this.log(`storing record for key ${o.toString()}`),await this.components.datastore.put(o,i.subarray()),yield*ot(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),s=>Nt(s,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:Ze.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,n))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&pe(u.record.value,kt.deserialize(i).value)||c.push(ci({from:a.peer.id,error:new $a("Value not put correctly")},n)));return c}),s=>Or(s,{ordered:!1,concurrency:Yf}),async function*(s){for await(let a of s)yield*a})}async*get(e,t={}){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;let i=n.map(a=>a.value),o=0;try{o=LP(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}let s=i[o];if(this.log("GetValue %b %b",e,s),s==null)throw new We("Best value was not found");yield*this.sendCorrectionRecord(e,n,s,t),yield n[o]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let o=await this.getLocal(e);yield qp({value:o.value,from:this.components.peerId},t)}catch(o){this.log("error getting local value for %b",e,o)}let n=this,i=async function*({peer:o,signal:s}){for await(let a of n.peerRouting.getValueOrPeers(o,e,{...t,signal:s}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield qp({from:o,value:a.record.value},t))};yield*this.queryManager.run(e,i,t)}};function zP(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function jp(r){if(r.id==null)throw new Error("Invalid peer in message");let e=Ue(r.id);return{id:ur(e),multiaddrs:(r.multiaddrs??[]).map(t=>se(t))}}var Gy=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:i,queryManager:o,routingTable:s,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=o,this.routingTable=s,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(f=>f.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);let i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);let o={type:Ze.ADD_PROVIDER,key:i,providers:[zP({id:this.components.peerId,multiaddrs:t})]},s=0,a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];let l=[];this.log("putProvider %s to %p",e,c.peer.id);try{this.log("sending provider record for %s to %p",e,c.peer.id);for await(let u of this.network.sendMessage(c.peer.id,o,n))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,c.peer.id),s++),l.push(u)}catch(u){this.log.error("error sending provide record to peer %p",c.peer.id,u),l.push(ci({from:c.peer.id,error:u},n))}return l};yield*ot(this.peerRouting.getClosestPeers(i,n),c=>Nt(c,l=>a(l)),c=>Or(c,{ordered:!1,concurrency:Yf}),async function*(c){for await(let l of c)yield*l}),this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,i=0,o=e.multihash.bytes,s=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e);if(a.length>0){let u=[];for(let f of a.slice(0,n))try{let h=await this.components.peerStore.get(f);u.push({id:f,multiaddrs:h.addresses.map(({multiaddr:d})=>d)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",f)}if(yield Kp({from:this.components.peerId,messageType:Ze.GET_PROVIDERS,providers:u},t),yield N9({from:this.components.peerId,providers:u},t),i+=u.length,i>=n)return}let c=async function*({peer:u,signal:f}){let h={type:Ze.GET_PROVIDERS,key:o};yield*s.network.sendRequest(u,h,{...t,signal:f})},l=new yn(a);for await(let u of this.queryManager.run(o,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);let f=[];for(let h of u.providers)l.has(h.id)||(l.add(h.id),f.push(h));if(f.length>0&&(yield N9({from:u.from,providers:f},t),i+=f.length,i>=n))return}}};function B9(r,e){let t=TC(r,e),n={read:async(i,o)=>{let s=await t.read(o);return i.decode(s)},write:async(i,o,s)=>{await t.write(o.encode(i),s)},writeV:async(i,o,s)=>{await t.writeV(i.map(a=>o.encode(a)),s)},pb:i=>({read:async o=>n.read(i,o),write:async(o,s)=>n.write(o,i,s),writeV:async(o,s)=>n.writeV(o,i,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var Xy=class extends Me{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new ho({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],o){return{...o,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((o,s)=>{i[`providers-${s}`]=o.id.toString()}),n.closer.length>0&&n.closer.forEach((o,s)=>{i[`closer-${s}`]=o.id.toString()})),i)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],o){return{...o,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((o,s)=>{i[`providers-${s}`]=o.id.toString()}),n.closer.length>0&&n.closer.forEach((o,s)=>{i[`closer-${s}`]=o.id.toString()})),i)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;let i=t.type;if(i==null)throw new U("Message type was missing");this.log("sending %s to %p",t.type,e),yield O9({peer:e},n),yield D9({to:e,type:i},n);let o,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[i]:!0}),o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);let c=await this._writeReadMessage(o,t,n);o.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),o?.abort(l)}),yield Kp({from:e,messageType:c.type,closer:c.closer.map(jp),providers:c.providers.map(jp),record:c.record==null?void 0:kt.deserialize(c.record)},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),o?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield ci({from:e,error:a},n)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,n={}){if(!this.running)return;let i=t.type;if(i==null)throw new U("Message type was missing");this.log("sending %s to %p",t.type,e),yield O9({peer:e},n),yield D9({to:e,type:i},n);let o,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[i]:!0}),o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),await this._writeMessage(o,t,n),o.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),o?.abort(c)}),yield Kp({from:e,messageType:i},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),o?.abort(a),yield ci({from:e,error:a},n)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,n){await B9(e).write(t,Ls,n)}async _writeReadMessage(e,t,n){let i=B9(e);await i.write(t,Ls,n);let o=await i.read(Ls,n);return o.closer.forEach(s=>{this.safeDispatchEvent("peer",{detail:jp(s)})}),o.providers.forEach(s=>{this.safeDispatchEvent("peer",{detail:jp(s)})}),o}};var za=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){let t=await Mr(e.id);this.addWithKadId(e,t)}addWithKadId(e,t){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;let n={peer:e,distance:Nn(this.originDhtKey,t)},i=!1;for(let o=0;o<this.peerDistances.length;o++){let s=Da(this.peerDistances[o].distance,n.distance);if(s===0||s===1){i=!0,this.peerDistances.splice(o,0,n);break}}i||this.peerDistances.push(n),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;let t=await Mr(e),n=Nn(t,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return Da(n,i)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}};var Yy=class{log;routingTable;network;validators;queryManager;peerStore;peerId;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e){let t,n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(i){if(i.name!=="NotFoundError")throw i}}if(t==null)try{t=await this.peerStore.get(e)}catch(i){if(i.name!=="NotFoundError")throw i}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n={}){let i={type:Ze.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){let n=FP(e);for await(let i of this._getValueSingle(e,n,t))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){let o=tr(i.record.value),s=zo(o);if(!s.equals(e))throw new hs("public key does not match id");if(s.publicKey==null)throw new hs("public key missing");yield qp({from:e,value:i.record.value},t)}throw new $a(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let i=await this.findPeerLocal(e);if(i!=null){this.log("found local"),yield Vy({from:this.peerId,peer:i},t);return}}let n=!1;if(t.useNetwork!==!1){let i=this,o=async function*({peer:s,signal:a}){let c={type:Ze.FIND_NODE,key:e.toMultihash().bytes};for await(let l of i.network.sendRequest(s,c,{...t,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){let u=l.closer.find(f=>f.id.equals(e));u!=null&&(yield Vy({from:l.from,peer:u},t))}};for await(let s of this.queryManager.run(e.toMultihash().bytes,o,t))s.name==="FINAL_PEER"&&(n=!0),yield s}n||(yield ci({from:this.peerId,error:new We("Not found")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Ha(e),i=this.routingTable.closestPeers(n),o=this,s=new za(n,this.routingTable.kBucketSize);await Promise.all(i.map(async c=>{await s.add({id:c,multiaddrs:[]})}));let a=async function*({peer:c,signal:l}){o.log("closerPeersSingle %s from %p",H(e,"base32"),c);let u={type:Ze.FIND_NODE,key:e};yield*o.network.sendRequest(c,u,{...t,signal:l})};for await(let c of this.queryManager.run(e,a,t))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await s.add(l)})),yield c;this.log("found %d peers close to %b",s.length,e);for(let c of s.peers)yield Vy({from:this.peerId,peer:c},t)}async*getValueOrPeers(e,t,n={}){for await(let i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record)}catch{let s="invalid record received, discarded";this.log(s),yield ci({from:i.from,error:new $a(s)},n);continue}yield i}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new Fy("invalid record received");await Jf(this.validators,new kt(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let n=[];try{let c=Ue(e),l=ur(c),u=await this.peerStore.get(l);n.push({id:u.id,multiaddrs:u.addresses.map(({multiaddr:f})=>f)})}catch{}let i=await Ha(e),o=this.routingTable.closestPeers(i),s=await Mr(t),a=Nn(s,i);for(let c of o){let l=await Mr(c),u=Nn(l,i);if(Da(u,a)===-1)try{let f=await this.peerStore.get(c);n.push({id:c,multiaddrs:f.addresses.map(({multiaddr:h})=>h)})}catch(f){if(f.name!=="NotFoundError")throw f}}return n.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",n.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),n}};var Qy=class{log;datastore;datastorePrefix;lock;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore,this.lock=t.lock}async addProvider(e,t){let n=await this.lock.readLock();try{this.log("%p provides %s",t,e),await this.writeProviderEntry(e,t)}finally{n()}}async removeProvider(e,t){let n=await this.lock.writeLock();try{let i=Ky(this.datastorePrefix,e,t);this.log("%p no longer provides %s",t,e),await this.datastore.delete(i)}finally{n()}}async getProviders(e){let t=await this.lock.readLock();try{this.log("get providers for %c",e);let n=await this.loadProviders(e);return this.log("got %d providers for %c",n.size,e),[...n.keys()]}finally{t()}}async writeProviderEntry(e,t,n=new Date){let i=Ky(this.datastorePrefix,e,t),o=ht(n.getTime());await this.datastore.put(i,o)}async loadProviders(e){let t=new _r,n=Ky(this.datastorePrefix,e);for await(let i of this.datastore.query({prefix:n.toString()})){let{peerId:o}=zy(i.key);t.set(o,qy(i.value))}return t}};async function*KP(r){let{key:e,startingPeer:t,ourPeerId:n,signal:i,query:o,alpha:s,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:u,peersSeen:f,connectionManager:h}=r,d=new ln({concurrency:s,sort:(w,x)=>Da(w.options.distance,x.options.distance)}),m=await Ha(e);function g(w,x){if(w==null)return;f.add(w);let v=Nn(x,m);d.add(async()=>{let b=[i];l!=null&&b.push(AbortSignal.timeout(l));let S=Ne(b);try{for await(let T of o({...r,key:e,peer:w,signal:S,pathIndex:a,numPaths:c})){if(S.aborted)return;if(T.name==="PEER_RESPONSE")for(let D of T.closer){if(f.has(D.id)){u.trace("already seen %p in query",D.id);continue}if(n.equals(D.id)){u("not querying ourselves");continue}if(!await h.isDialable(D.multiaddrs)){u("not querying undialable peer");continue}let A=await Mr(D.id),I=Nn(A,m);if(Da(I,v)!==-1){u.trace("skipping %p as they are not closer to %b than %p",D.id,e,w);continue}u.trace("querying closer peer %p",D.id),g(D.id,A)}d.safeDispatchEvent("completed",{detail:T})}}catch(T){if(!i.aborted)return ci({from:w,error:T},r)}finally{S.clear()}},{distance:v}).catch(b=>{u.error(b)})}g(t,await Mr(t));try{for await(let w of d.toGenerator({signal:i}))w!=null&&(yield w)}catch(w){throw i.aborted?new Uy("Query aborted"):w}}var Zy=class{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??My,this.alpha=t.alpha??Yf,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){let c=AbortSignal.timeout(NP);n={...n,signal:c}}let i=new AbortController,o=Ne([this.shutDownController.signal,i.signal,n.signal]);i.signal;let s=this.logger.forComponent(`${this.logPrefix}:query:`+H(e,"base58btc")),a=!1;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(s("waiting for initial query-self query before continuing"),await Dt(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),s("query:start");let c=await Ha(e),l=this.routingTable.closestPeers(c),u=l.slice(0,Math.min(this.disjointPaths,l.length));if(l.length===0){s.error("Running query with no peers");return}let f=new yn,h=u.map((d,m)=>KP({...n,key:e,startingPeer:d,ourPeerId:this.peerId,signal:o,query:t,pathIndex:m,numPaths:u.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:s,peersSeen:f,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let d of un(...h)){if(d.name==="QUERY_ERROR"&&s.error("query error",d.error),d.name==="PEER_RESPONSE")for(let m of[...d.closer,...d.providers])await this.connectionManager.isDialable(m.multiaddrs)&&await this.routingTable.add(m.id);yield d}a=!0}catch(c){if(!(!this.running&&c.name==="QueryAbortedError"))throw c}finally{a||(s("query exited early"),i.abort()),o.clear(),s("query:done")}}};var Jy=class{log;peerId;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.running=!1,this.peerRouting=t.peerRouting,this.routingTable=t.routingTable,this.count=t.count??My,this.interval=t.interval??CP,this.initialInterval=t.initialInterval??kP,this.queryTimeout=t.queryTimeout??PP,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=jy(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ye(),this.running){this.controller=new AbortController;let e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){let n=AbortSignal.timeout(this.queryTimeout);e.push(n)}let t=Ne(e);this.controller.signal;try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await CC(this.routingTable,"peer:add",{signal:t,filter:o=>!this.peerId.equals(o.detail)}),this.log("routing table has peers, continuing with query")),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),i=await ot(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>la(o,this.count),async o=>B2(o));this.log("self-query found %d peers in %dms",i,Date.now()-n)}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};var e3=class extends Me{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;lock;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new ln({concurrency:t.concurrency??_P,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new ho({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??AP,this.maxQueueSize=t.maxQueueSize??IP,this.validity=t.validity??SP,this.interval=t.interval??TP,this.contentRouting=t.contentRouting,this.lock=t.lock,this.running=!1,this.reprovide=jy(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp().catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(){let e=await this.lock.writeLock();try{this.safeDispatchEvent("reprovide:start");for await(let t of this.datastore.query({prefix:this.datastorePrefix}))try{let{cid:n,peerId:i}=zy(t.key),o=qy(t.value).getTime(),s=o+this.validity,a=Date.now(),c=a>s;this.log.trace("comparing: %d < %d = %s %s",o,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key),this.peerId.equals(i)&&a-s<this.reprovideThreshold&&this.queueReprovide(n).catch(l=>{this.log.error("could not reprovide %c - %e",n,l)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{e(),this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp().catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize);let t=this.reprovideQueue.queue.find(n=>n.options.cid.equals(e));if(t!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),t.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async n=>{if(n.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);let i=this.reprovideTimeout.getTimeoutSignal(n);try{await this.reprovide(n.cid,n)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(n=>{this.log.error("could not re-provide key %c - %e",e,n)})}async reprovide(e,t){await Sr(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}};var PW=20,RW=5e3,DW="kad-close",NW=50,t3=class{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??RW,this.peerSetSize=t.peerSetSize??PW,this.closeTagName=t.closeTagName??DW,this.closeTagValue=t.closeTagValue??NW,this.closestPeers=new yn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;let e=await Mr(this.components.peerId);this.newPeers=new za(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){let e=new yn(this.newPeers?.peers.map(i=>i.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:{value:this.closeTagValue},[P9]:{value:1}}})}),...[...n].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:void 0,[P9]:void 0}})})])}};function Wp(r){return Array.isArray(r?.peers)}var r3=class{root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e){this.prefixLength=e.prefixLength??qP,this.kBucketSize=e.kBucketSize??M9,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfOldContactsToPing??jP,this.lastPingThreshold=e.lastPingThreshold??WP,this.ping=e.ping,this.verify=e.verify,this.onAdd=e.onAdd,this.onRemove=e.onRemove,this.addingPeerMap=new _r,this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e){this.localPeer={peerId:e,kadId:await Mr(e),lastPing:Date.now()}}async add(e,t){let n={peerId:e,kadId:await Mr(e),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{let o=this._add(n,t);this.addingPeerMap.set(e,o),await o}finally{this.addingPeerMap.delete(e)}}async _add(e,t){let n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!LW(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}let i=n.peers.filter(s=>!(s.peerId.equals(this.localPeer?.peerId)||s.lastPing>Date.now()-this.lastPingThreshold)).sort((s,a)=>s.lastPing<a.lastPing?-1:s.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing),o=!1;for await(let s of this.ping(i,t))o=!0,await this.remove(s.kadId);o&&await this._add(e,t)}*closest(e,t=this.kBucketSize){let n=new za(e,t);for(let i of this.toIterable())n.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*Nt(n.peers,i=>i.id)}count(){function e(t){if(Wp(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){let t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e){let t=this._determineBucket(e),n=this._indexOf(t,e);if(n>-1){let i=t.peers.splice(n,1)[0];await this.onRemove?.(i,t)}}*toIterable(){function*e(t){if(Wp(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+H(Nn(e,t),"base16"))}_determineBucket(e){let t=H(e,"base2");function n(i,o=0){return Wp(i)?i:t[o]==="0"?n(i.left,o+1):n(i.right,o+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>pe(n.kadId,t))}async _split(e){let t={prefix:"0",depth:e.depth+1,peers:[]},n={prefix:"1",depth:e.depth+1,peers:[]};for(let i of e.peers)H(i.kadId,"base2")[e.depth]==="0"?(t.peers.push(i),await this.onMove?.(i,e,t)):(n.peers.push(i),await this.onMove?.(i,e,n));OW(e,t,n)}};function OW(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function LW(r,e){return r.lastPing<Date.now()-e}var M9=20,qP=6;var BW=20,MW=100,jP=3;var UW=20,FW=100,GP="kad-peer",$W=1,WP=6e5,HW=!0,VW=1e3,n3=class extends Me{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??M9,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??GP,this.peerTagValue=t.peerTagValue??$W,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??HW,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??VW,this.pingOldContactQueue=new Pr({concurrency:t.pingOldContactConcurrency??UW,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??FW}),this.pingOldContactTimeout=new ho({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Pr({concurrency:t.pingNewContactConcurrency??BW,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??MW}),this.pingNewContactTimeout=new ho({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new r3({kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved}),this.closestPeerTagger=new t3(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,await kr(this.closestPeerTagger),await this.kb.addSelfPeer(this.components.peerId))}async afterStart(){Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let e=0;for(let t of await this.components.peerStore.all({filters:[n=>n.protocols.includes(this.protocol)&&n.tags.has(GP)],limit:this.populateFromDatastoreLimit})){if(!this.running)return;try{await this.add(t.id),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(t.id,{tags:{[this.peerTagName]:void 0}})}}this.log("added %d peer store peers to the routing table",e)}).catch(e=>{this.log.error("error adding peer store peers to the routing table %e",e)})}async stop(){this.running=!1,await Gr(this.closestPeerTagger),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort()}async peerAdded(e,t){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}}),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}}),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;let n=[];for(let i of e){if(this.kb.get(i.kadId)==null){this.log("asked to ping contact %p that was not in routing table",i.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{let o=this.pingOldContactQueue.find(i.peerId);if(o!=null)return this.log("asked to ping contact %p was already being pinged",i.peerId),await o.join(t)?void 0:i;if(!await this.pingOldContactQueue.add(async a=>{let c=this.pingOldContactTimeout.getTimeoutSignal(),l=Ne([c,a?.signal]);try{return await this.pingContact(i,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:i.peerId,signal:t?.signal}))return i})}for await(let i of Or(n))i!=null&&(yield i)}async verifyNewContact(e,t){let n=this.pingNewContactTimeout.getTimeoutSignal(),i=Ne([n,t?.signal]);try{let o=this.pingNewContactQueue.find(e.peerId);return o!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await o.join({signal:i})):await this.pingNewContactQueue.add(async s=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,s)),{peerId:e.peerId,signal:i})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),i.clear()}}async pingContact(e,t){let n;try{this.log("pinging contact %p",e.peerId);for await(let i of this.network.sendRequest(e.peerId,{type:Ze.PING},t))if(i.type===i3.PEER_RESPONSE)return i.messageType===Ze.PING?(this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0):!1;return!1}catch(i){return this.log("error pinging old contact %p - %e",e.peerId,i),n?.abort(i),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e){let t=await Mr(e);return this.kb.get(t)?.peerId}closestPeer(e){let t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await Mr(e);await this.kb.remove(t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,i=20,o=0;function s(a){if(Wp(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<i&&(i=a.peers.length),a.peers.length>o&&(o=a.peers.length);return}s(a.left),s(a.right)}s(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(i),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(n)}};var XP=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var o3=15,s3=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:i,refreshInterval:o,refreshQueryTimeout:s,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=i,this.refreshInterval=o??RP,this.refreshQueryTimeout=s??DP,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(n.map(async(i,o)=>{try{if(await this._refreshCommonPrefixLength(o,i,e),this._numPeersForCpl(t)===0){let s=Math.min(2*(o+1),n.length-1);for(let a=o+1;a<s+1;a++)try{await this._refreshCommonPrefixLength(a,i,e)}catch(c){this.log.error(c)}}}catch(s){this.log.error(s)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let i=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);let o=AbortSignal.timeout(this.refreshQueryTimeout);let s=await B2(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:o}));this.log(`found ${s} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>o3&&(e=o3);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");let t=mn(2),n=(t[1]<<8)+t[0],i=await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),o=Ue(i);return ur(o)}async _makePeerId(e,t,n){if(n>o3)throw new Error(`Cannot generate peer ID for common prefix length greater than ${o3}`);let s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=s&a|t&~a,l=XP[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,Fe.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=Nn(this.routingTable.kb.localPeer.kadId,e),n=0;for(let i of t)if(i===0)n++;else break;yield n}}};var a3=class{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Be("Missing key");let n;try{n=W.decode(t.key)}catch{throw new Be("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async i=>{let o=Ue(i.id),s=ur(o),a=i.multiaddrs.map(c=>se(c));if(!e.equals(s)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,s),await this.peerStore.merge(s,{multiaddrs:a})}))}};var c3=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new Be("Invalid FIND_NODE message received - key was missing");let n=await this.peerRouting.getCloserPeersOffline(t.key,e);pe(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(o=>o.decapsulateCode(Ie("p2p").code))});let i={type:Ze.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:o})=>o.length).map(o=>({id:o.id.toMultihash().bytes,multiaddrs:o.multiaddrs.map(s=>s.bytes)})),providers:[]};return i.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),i}};var l3=class{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:i,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Be("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=W.decode(t.key)}catch{throw new Be("Invalid CID")}this.log("%p asking for providers for %s",e,n);let[i,o]=await Promise.all([Ps(Nt(await this.providers.getProviders(n),async a=>{let c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getCloserPeersOffline(t.key,this.peerId)]),s={type:Ze.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:o.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",s.providers.length,s.closer.length),s}async _getAddresses(e){return[]}};var u3=class{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Be("Invalid key");let i={type:Ze.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if($P(n)){this.log("is public key");let a=HP(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new We("No public key found in key book");c=lr(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new kt(n,c,new Date).serialize(),i}let[o,s]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return o!=null&&(this.log("had record for %b in local datastore",n),i.record=o.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),i.closer=s.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=Va(this.datastorePrefix,e),n;try{n=await this.datastore.get(t)}catch(o){if(o.name==="NotFoundError")return;throw o}let i=kt.deserialize(n);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>vP){await this.datastore.delete(t);return}return i}};var f3=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var d3=class{components;validators;log;datastorePrefix;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){let i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new Be(i)}try{let i=kt.deserialize(t.record);await Jf(this.validators,i),i.timeReceived=new Date;let o=Va(this.datastorePrefix,i.key);await this.components.datastore.put(o,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,o)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}};var h3=class{handlers;routingTable;log;metrics;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`)},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.routingTable=t.routingTable,this.handlers={[Ze.GET_VALUE.toString()]:new u3(e,t),[Ze.PUT_VALUE.toString()]:new d3(e,t),[Ze.FIND_NODE.toString()]:new c3(e,t),[Ze.ADD_PROVIDER.toString()]:new a3(e,t),[Ze.GET_PROVIDERS.toString()]:new l3(e,t),[Ze.PING.toString()]:new f3(e,t)}}async handleMessage(e,t){let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{let{stream:n,connection:i}=e,o=i.remotePeer,s=this;await ot(n,a=>Qi(a),async function*(a){for await(let c of a){let l=Ls.decode(c);t=l.type,s.log("incoming %s from %p",l.type,o);let u=await s.handleMessage(o,l);u!=null&&(yield Ls.encode(u))}},a=>Yi(a),n)}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};var p3=class extends Me{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:i}=t;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var U9=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await Sr(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Sr(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new We("Could not find value for key")}},F9=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new We("Peer not found")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},zW=32,KW=64,m3=class extends Me{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;constructor(e,t={}){super();let n=t.logPrefix??"libp2p:kad-dht",i=t.datastorePrefix??"/dht",o=t.metricsPrefix??"libp2p_kad_dht",s={queries:e.metrics?.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.protocol=t.protocol??EP,this.kBucketSize=t.kBucketSize??20,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??zW,this.maxOutboundStreams=t.maxOutboundStreams??KW,this.peerInfoMapper=t.peerInfoMapper??UP;let a=cl();this.providers=new Qy(e,{...t.providers,logPrefix:n,datastorePrefix:i,lock:a}),this.validators={...MP,...t.validators},this.selectors={...BP,...t.selectors},this.network=new Xy(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:o}),this.routingTable=new n3(e,{kBucketSize:t.kBucketSize,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:o,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});let c=ye();t.allowQueryWithZeroPeers===!0&&c.resolve(),this.queryManager=new Zy(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:n,metricsPrefix:o,initialQuerySelfHasRun:c,routingTable:this.routingTable}),this.peerRouting=new Yy(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new Wy(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:i}),this.contentRouting=new Gy(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new s3(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new h3(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:o,datastorePrefix:i,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new p3(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new Jy(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:c,routingTable:this.routingTable,operationMetrics:s}),this.reprovider=new e3(e,{...t.reprovide,logPrefix:n,metricsPrefix:o,datastorePrefix:i,contentRouting:this.contentRouting,lock:a,operationMetrics:s}),this.network.addEventListener("peer",l=>{let u=l.detail;this.onPeerConnect(u).catch(f=>{this.log.error("could not add %p to routing table",u.id,f)}),this.dispatchEvent(new CustomEvent("peer",{detail:u}))}),this.topologyListener.addEventListener("peer",l=>{let u=l.detail;Promise.resolve().then(async()=>{let f=await this.components.peerStore.get(u),h={id:u,multiaddrs:f.addresses.map(({multiaddr:d})=>d),protocols:f.protocols};await this.onPeerConnect(h)}).catch(f=>{this.log.error("could not add %p to routing table - %e",u,f)})}),this.dhtPeerRouting=new F9(this),this.dhtContentRouting=new U9(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",l=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let u=l.detail.peer.addresses.some(({multiaddr:h})=>VP(h)),f=this.getMode();u&&f==="client"?await this.setMode("server"):f==="server"&&!u&&await this.setMode("client")}).catch(u=>{this.log.error("error setting dht server mode",u)})}),this.get=Il(this.get.bind(this),s,"GET_VALUE"),this.findProviders=Il(this.findProviders.bind(this),s,"FIND_PROVIDERS"),this.findPeer=Il(this.findPeer.bind(this),s,"FIND_PEER"),this.getClosestPeers=Il(this.getClosestPeers.bind(this),s,"GET_CLOSEST_PEERS"),this.provide=Il(this.provide.bind(this),s,"PROVIDE"),this.put=Il(this.put.bind(this),s,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[tt]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"];[Jn]=["@libp2p/identify"];get[Ro](){return this.dhtContentRouting}get[Do](){return this.dhtPeerRouting}get[Ic](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t=!1){if(e===this.getMode()&&!t){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol),e===this.getMode()&&!t){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",!0),await kr(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await kr(this.querySelf))}async stop(){this.running=!1,await Gr(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e){await this.providers.removeProvider(e,this.components.peerId)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};var i3;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(i3||(i3={}));function YP(r={}){return e=>new m3(e,r)}var oR=it(iR(),1),Wt=oR.default;var nD=it(pR(),1);var rd={};Ft(rd,{create:()=>cG,derivedEmptyPasswordKey:()=>w3});var w3={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function cG(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,i=r?.digest??"SHA-256",o=r?.saltLength??16,s=r?.iterations??32767,a=In.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),m=a.getRandomValues(new Uint8Array(n)),g={name:e,iv:m};typeof h=="string"&&(h=O(h));let w;if(h.length===0){w=await a.subtle.importKey("jwk",w3,{name:"AES-GCM"},!0,["encrypt"]);try{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},b=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,b,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",w3,{name:"AES-GCM"},!0,["encrypt"])}}else{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},b=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,b,{name:e,length:t},!0,["encrypt"])}let x=await a.subtle.encrypt(g,w,f);return Ve([d,g.iv,new Uint8Array(x)])}async function l(f,h){let d=f.subarray(0,o),m=f.subarray(o,o+n),g=f.subarray(o+n),w={name:e,iv:m};typeof h=="string"&&(h=O(h));let x;if(h.length===0)try{let b={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},S=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(b,S,{name:e,length:t},!0,["decrypt"])}catch{x=await a.subtle.importKey("jwk",w3,{name:"AES-GCM"},!0,["decrypt"])}else{let b={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},S=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(b,S,{name:e,length:t},!0,["decrypt"])}let v=await a.subtle.decrypt(w,x,g);return new Uint8Array(v)}return{encrypt:c,decrypt:l}}var Li={};Ft(Li,{Any:()=>Go,BaseBlock:()=>dr,BaseStringBlock:()=>Qp,BitString:()=>wo,BmpString:()=>Pl,Boolean:()=>Cl,CharacterString:()=>Fl,Choice:()=>od,Constructed:()=>wr,DATE:()=>n1,DateTime:()=>o1,Duration:()=>s1,EndOfContent:()=>Zp,Enumerated:()=>kl,GeneralString:()=>Ul,GeneralizedTime:()=>$l,GraphicString:()=>Ml,HexBlock:()=>Xo,IA5String:()=>Bl,Integer:()=>li,Null:()=>Mn,NumericString:()=>Dl,ObjectIdentifier:()=>ui,OctetString:()=>sn,Primitive:()=>Fs,PrintableString:()=>Nl,RawData:()=>K9,RelativeObjectIdentifier:()=>r1,Repeated:()=>Hl,Sequence:()=>Lt,Set:()=>Un,TIME:()=>a1,TeletexString:()=>Ol,TimeOfDay:()=>i1,UTCTime:()=>Wa,UniversalString:()=>Rl,Utf8String:()=>Oi,ValueBlock:()=>Ur,VideotexString:()=>Ll,ViewWriter:()=>id,VisibleString:()=>ja,compareSchema:()=>qa,fromBER:()=>fi,verifySchema:()=>kG});var He=it(Ms());function Tl(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ka(r,e,t=-1){let n=t,i=r,o=0,s=Math.pow(2,e);for(let a=1;a<8;a++){if(r<s){let c;if(n<0)c=new ArrayBuffer(a),o=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),o=n}let l=new Uint8Array(c);for(let u=a-1;u>=0;u--){let f=Math.pow(2,u*e);l[o-u-1]=Math.floor(i/f),i-=l[o-u-1]*f}return c}s*=Math.pow(2,e)}return new ArrayBuffer(0)}function v3(...r){let e=0,t=0;for(let o of r)e+=o.length;let n=new ArrayBuffer(e),i=new Uint8Array(n);for(let o of r)i.set(o,t),t+=o.length;return i}function V9(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=Tl(t,8),i=new ArrayBuffer(this.valueHex.byteLength),o=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)o[a]=r[a];return o[0]&=127,Tl(o,8)-n}function mR(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let s=t-e,a=Ka(s,8,n),c=new Uint8Array(a);return c[0]|=128,a}let i=Ka(e,8,n),o=new Uint8Array(i);if(o[0]&128){let s=i.slice(0),a=new Uint8Array(s);i=new ArrayBuffer(i.byteLength+1),o=new Uint8Array(i);for(let c=0;c<s.byteLength;c++)o[c+1]=a[c];o[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function gR(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function Ln(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,i=new Array(n);for(let s=0;s<n;s++)i[s]="0";return i.join("").concat(t)}var yve=Math.log(2);function E3(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function q9(r){let e=0,t=0;for(let i=0;i<r.length;i++){let o=r[i];e+=o.byteLength}let n=new Uint8Array(e);for(let i=0;i<r.length;i++){let o=r[i];n.set(new Uint8Array(o),t),t+=o.byteLength}return n.buffer}function $s(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var id=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return q9(this.items)}},Gp=[new Uint8Array([1])],yR="0123456789",z9="name",wR="valueHexView",yG="isHexOnly",wG="idBlock",xG="tagClass",bG="tagNumber",vG="isConstructed",EG="fromBER",SG="toBER",AG="local",Bn="",xo=new ArrayBuffer(0),M3=new Uint8Array(0),Yp="EndOfContent",bR="OCTET STRING",vR="BIT STRING";function Xo(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var i;super(...n);let o=n[0]||{};this.isHexOnly=(i=o.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=o.valueHex?He.BufferSourceConverter.toUint8Array(o.valueHex):M3}fromBER(n,i,o){let s=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!$s(this,s,i,o))return-1;let a=i+o;return this.valueHexView=s.subarray(i,a),this.valueHexView.length?(this.blockLength=o,a):(this.warnings.push("Zero buffer length"),i)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",xo)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:He.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var Us=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Bn,warnings:n=[],valueBeforeDecode:i=M3}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=He.BufferSourceConverter.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:He.Convert.ToHex(this.valueBeforeDecodeView)}}};Us.NAME="baseBlock";var Ur=class extends Us{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};Ur.NAME="valueBlock";var S3=class extends Xo(Us){constructor({idBlock:e={}}={}){var t,n,i,o;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?He.BufferSourceConverter.toUint8Array(e.valueHex):M3,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(o=e.isConstructed)!==null&&o!==void 0?o:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",xo}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let i=new Uint8Array(1);if(!e){let o=this.tagNumber;o&=31,t|=o,i[0]=t}return i.buffer}if(!this.isHexOnly){let i=Ka(this.tagNumber,7),o=new Uint8Array(i),s=i.byteLength,a=new Uint8Array(s+1);if(a[0]=t|31,!e){for(let c=0;c<s-1;c++)a[c+1]=o[c]|128;a[s]=o[s-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let i=this.valueHexView;for(let o=0;o<i.length-1;o++)n[o+1]=i[o]|128;n[this.valueHexView.byteLength]=i[i.length-1]}return n.buffer}fromBER(e,t,n){let i=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,i,t,n))return-1;let o=i.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;switch(o[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(o[0]&32)===32,this.isHexOnly=!1;let a=o[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;o[c]&128;){if(l[c-1]=o[c]&127,c++,c>=o.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;let h=new Uint8Array(u);for(let d=0;d<l.length;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=o[c]&127;let f=new Uint8Array(c);for(let h=0;h<c;h++)f[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(f),this.blockLength<=9?this.tagNumber=Tl(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};S3.NAME="identificationBlock";var A3=class extends Us{constructor({lenBlock:e={}}={}){var t,n,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,n){let i=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,i,t,n))return-1;let o=i.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;if(o[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=o[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(o[0]&128),this.longFormUsed===!1)return this.length=o[0],this.blockLength=1,t+this.blockLength;let s=o[0]&127;if(s>8)return this.error="Too big integer",-1;if(s+1>o.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=i.subarray(a,a+s);return c[s-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Tl(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let i=Ka(this.length,8);if(i.byteLength>127)return this.error="Too big length",xo;if(t=new ArrayBuffer(i.byteLength+1),e)return t;let o=new Uint8Array(i);n=new Uint8Array(t),n[0]=i.byteLength|128;for(let s=0;s<i.byteLength;s++)n[s+1]=o[s];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};A3.NAME="lengthBlock";var ue={},dr=class extends Us{constructor({name:e=Bn,optional:t=!1,primitiveSchema:n,...i}={},o){super(i),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new S3(i),this.lenBlock=new A3(i),this.valueBlock=o?new o(i):new Ur(i)}fromBER(e,t,n){let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){let n=t||new id;t||ER(this);let i=this.idBlock.toBER(e);if(n.write(i),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let o=this.valueBlock.toBER(e);this.lenBlock.length=o.byteLength;let s=this.lenBlock.toBER(e);n.write(s),n.write(o)}return t?xo:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():He.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=He.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return gR(t,n)}};dr.NAME="BaseBlock";function ER(r){var e;if(r instanceof ue.Constructed)for(let t of r.valueBlock.value)ER(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var Qp=class extends dr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Bn,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};Qp.NAME="BaseStringBlock";var _3=class extends Xo(Ur){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};_3.NAME="PrimitiveValueBlock";var SR,Fs=class extends dr{constructor(e={}){super(e,_3),this.idBlock.isConstructed=!1}};SR=Fs;ue.Primitive=SR;Fs.NAME="PRIMITIVE";function _G(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function sd(r,e=0,t=r.length){let n=e,i=new dr({},Ur),o=new Us;if(!$s(o,r,e,t))return i.error=o.error,{offset:-1,result:i};if(!r.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(r,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(r,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=dr;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=ue.EndOfContent;break;case 1:c=ue.Boolean;break;case 2:c=ue.Integer;break;case 3:c=ue.BitString;break;case 4:c=ue.OctetString;break;case 5:c=ue.Null;break;case 6:c=ue.ObjectIdentifier;break;case 10:c=ue.Enumerated;break;case 12:c=ue.Utf8String;break;case 13:c=ue.RelativeObjectIdentifier;break;case 14:c=ue.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=ue.Sequence;break;case 17:c=ue.Set;break;case 18:c=ue.NumericString;break;case 19:c=ue.PrintableString;break;case 20:c=ue.TeletexString;break;case 21:c=ue.VideotexString;break;case 22:c=ue.IA5String;break;case 23:c=ue.UTCTime;break;case 24:c=ue.GeneralizedTime;break;case 25:c=ue.GraphicString;break;case 26:c=ue.VisibleString;break;case 27:c=ue.GeneralString;break;case 28:c=ue.UniversalString;break;case 29:c=ue.CharacterString;break;case 30:c=ue.BmpString;break;case 31:c=ue.DATE;break;case 32:c=ue.TimeOfDay;break;case 33:c=ue.DateTime;break;case 34:c=ue.Duration;break;default:{let l=i.idBlock.isConstructed?new ue.Constructed:new ue.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?ue.Constructed:ue.Primitive}return i=_G(i,c),a=i.fromBER(r,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=r.subarray(n,n+i.blockLength),{offset:a,result:i}}function fi(r){if(!r.byteLength){let e=new dr({},Ur);return e.error="Input buffer has zero length",{offset:-1,result:e}}return sd(He.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function IG(r,e){return r?1:e}var Wo=class extends Ur{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let i=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,i,t,n))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let o=t;for(;IG(this.isIndefiniteForm,n)>0;){let s=sd(i,o,n);if(s.offset===-1)return this.error=s.result.error,this.warnings.concat(s.result.warnings),-1;if(o=s.offset,this.blockLength+=s.result.blockLength,n-=s.result.blockLength,this.value.push(s.result),this.isIndefiniteForm&&s.result.constructor.NAME===Yp)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Yp?this.value.pop():this.warnings.push("No EndOfContent block encoded")),o}toBER(e,t){let n=t||new id;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,n);return t?xo:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};Wo.NAME="ConstructedValueBlock";var AR,wr=class extends dr{constructor(e={}){super(e,Wo),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};AR=wr;ue.Constructed=AR;wr.NAME="CONSTRUCTED";var I3=class extends Ur{fromBER(e,t,n){return t}toBER(e){return xo}};I3.override="EndOfContentValueBlock";var _R,Zp=class extends dr{constructor(e={}){super(e,I3),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};_R=Zp;ue.EndOfContent=_R;Zp.NAME=Yp;var IR,Mn=class extends dr{constructor(e={}){super(e,Ur),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let i=new Uint8Array(n);i[0]=5,i[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};IR=Mn;ue.Null=IR;Mn.NAME="NULL";var T3=class extends Xo(Ur){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=He.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let i=He.BufferSourceConverter.toUint8Array(e);return $s(this,i,t,n)?(this.valueHexView=i.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,V9.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};T3.NAME="BooleanValueBlock";var TR,Cl=class extends dr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,T3),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};TR=Cl;ue.Boolean=TR;Cl.NAME="BOOLEAN";var C3=class extends Xo(Wo){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=Wo.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let o=0;o<this.value.length;o++){let s=this.value[o].constructor.NAME;if(s===Yp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(s!==bR)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,n),this.blockLength=n;return i}toBER(e,t){return this.isConstructed?Wo.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};C3.NAME="OctetStringValueBlock";var j9,sn=class extends dr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,o;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},C3),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let o=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(o.byteLength){let s=sd(o,0,o.byteLength);s.offset!==-1&&s.offset===n&&(this.valueBlock.value=[s.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return wr.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=He.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof j9&&e.push(t.valueBlock.valueHexView);return He.BufferSourceConverter.concat(e)}};j9=sn;ue.OctetString=j9;sn.NAME=bR;var k3=class extends Xo(Wo){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let i=-1;if(this.isConstructed){if(i=Wo.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let a of this.value){let c=a.constructor.NAME;if(c===Yp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==vR)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}let o=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,o,t,n))return-1;let s=o.subarray(t,t+n);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=s.subarray(1);try{if(a.byteLength){let c=sd(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+n}toBER(e,t){if(this.isConstructed)return Wo.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return xo;let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};k3.NAME="BitStringValueBlock";var CR,wo=class extends dr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,o;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},k3),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return wr.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join(""),i=this.constructor.NAME,o=n.substring(0,n.length-this.valueBlock.unusedBits);return`${i} : ${o}`}}};CR=wo;ue.BitString=CR;wo.NAME=vR;var kR;function TG(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),i=new Uint8Array(e),o=n.slice(0),s=o.length-1,a=i.slice(0),c=a.length-1,l=0,u=c<s?s:c,f=0;for(let h=u;h>=0;h--,f++){switch(!0){case f<a.length:l=o[s-f]+a[c-f]+t[0];break;default:l=o[s-f]+t[0]}switch(t[0]=l/10,!0){case f>=o.length:o=v3(new Uint8Array([l%10]),o);break;default:o[s-f]=l%10}}return t[0]>0&&(o=v3(t,o)),o}function xR(r){if(r>=Gp.length)for(let e=Gp.length;e<=r;e++){let t=new Uint8Array([0]),n=Gp[e-1].slice(0);for(let i=n.length-1;i>=0;i--){let o=new Uint8Array([(n[i]<<1)+t[0]]);t[0]=o[0]/10,n[i]=o[0]%10}t[0]>0&&(n=v3(t,n)),Gp.push(n)}return Gp[r]}function CG(r,e){let t=0,n=new Uint8Array(r),i=new Uint8Array(e),o=n.slice(0),s=o.length-1,a=i.slice(0),c=a.length-1,l,u=0;for(let f=c;f>=0;f--,u++)switch(l=o[s-u]-a[c-u]-t,!0){case l<0:t=1,o[s-u]=l+10;break;default:t=0,o[s-u]=l}if(t>0)for(let f=s-c+1;f>=0;f--,u++)if(l=o[s-u]-t,l<0)t=1,o[s-u]=l+10;else{t=0,o[s-u]=l;break}return o.slice()}var Jp=class extends Xo(Ur){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=V9.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(mR(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,i=0){let o=this.fromBER(e,t,n);if(o===-1)return o;let s=this.valueHexView;return s[0]===0&&(s[1]&128)!==0?this.valueHexView=s.subarray(1):i!==0&&s.length<i&&(i-s.length>1&&(i=s.length+1),this.valueHexView=s.subarray(i-s.length)),o}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let i=super.fromBER(e,t,n);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,i,o=this.valueHexView,s="",a=!1;for(let c=o.byteLength-1;c>=0;c--){i=o[c];for(let l=0;l<8;l++){if((i&1)===1)switch(n){case e:t=CG(xR(n),t),s="-";break;default:t=TG(t,xR(n))}n++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(s+=yR.charAt(t[c]));return a===!1&&(s+=yR.charAt(0)),s}};kR=Jp;Jp.NAME="IntegerValueBlock";Object.defineProperty(kR.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Xp,li=class extends dr{constructor(e={}){super(e,Jp),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return E3(),BigInt(this.valueBlock.toString())}static fromBigInt(e){E3();let t=BigInt(e),n=new id,i=t.toString(16).replace(/^-/,""),o=new Uint8Array(He.Convert.FromHex(i));if(t<0){let a=new Uint8Array(o.length+(o[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${He.Convert.ToHex(a)}`)+t,u=He.BufferSourceConverter.toUint8Array(He.Convert.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else o[0]&128&&n.write(new Uint8Array([0])),n.write(o);return new Xp({valueHex:n.final()})}convertToDER(){let e=new Xp({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Xp({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};Xp=li;ue.Integer=Xp;li.NAME="INTEGER";var PR,kl=class extends li{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};PR=kl;ue.Enumerated=PR;kl.NAME="ENUMERATED";var e1=class extends Xo(Ur){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let i=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,i,t,n))return-1;let o=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Tl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){E3();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let i=this.valueHexView,o=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)o[s]=i[s]|128;return o[this.blockLength-1]=i[this.blockLength-1],o.buffer}let t=Ka(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",xo;let n=new Uint8Array(t.byteLength);if(!e){let i=new Uint8Array(t),o=t.byteLength-1;for(let s=0;s<o;s++)n[s]=i[s]|128;n[o]=i[o]}return n}toString(){let e="";if(this.isHexOnly)e=He.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};e1.NAME="sidBlock";var P3=class extends Ur{constructor({value:e=Bn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){let o=new e1;if(i=o.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=o.error,i;this.value.length===0&&(o.isFirstSid=!0),this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return i}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let i=this.value[n].toBER(e);if(i.byteLength===0)return this.error=this.value[n].error,xo;t.push(i)}return q9(t)}fromString(e){this.value=[];let t=0,n=0,i="",o=!1;do if(n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1,o){let s=this.value[0],a=0;switch(s.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(i,10);if(isNaN(c))return;s.valueDec=c+a,o=!1}else{let s=new e1;if(i>Number.MAX_SAFE_INTEGER){E3();let a=BigInt(i);s.valueBigInt=a}else if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return;this.value.length||(s.isFirstSid=!0,o=!0),this.value.push(s)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[n].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};P3.NAME="ObjectIdentifierValueBlock";var RR,ui=class extends dr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,P3),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};RR=ui;ue.ObjectIdentifier=RR;ui.NAME="OBJECT IDENTIFIER";var t1=class extends Xo(Us){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let i=He.BufferSourceConverter.toUint8Array(e);if(!$s(this,i,t,n))return-1;let o=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Tl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let i=this.valueHexView,o=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)o[s]=i[s]|128;return o[this.blockLength-1]=i[this.blockLength-1],o.buffer}let t=Ka(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",xo;let n=new Uint8Array(t.byteLength);if(!e){let i=new Uint8Array(t),o=t.byteLength-1;for(let s=0;s<o;s++)n[s]=i[s]|128;n[o]=i[o]}return n.buffer}toString(){let e="";return this.isHexOnly?e=He.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};t1.NAME="relativeSidBlock";var R3=class extends Ur{constructor({value:e=Bn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){let o=new t1;if(i=o.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=o.error,i;this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return i}toBER(e,t){let n=[];for(let i=0;i<this.value.length;i++){let o=this.value[i].toBER(e);if(o.byteLength===0)return this.error=this.value[i].error,xo;n.push(o)}return q9(n)}fromString(e){this.value=[];let t=0,n=0,i="";do{n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1;let o=new t1;if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return!0;this.value.push(o)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};R3.NAME="RelativeObjectIdentifierValueBlock";var DR,r1=class extends dr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,R3),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};DR=r1;ue.RelativeObjectIdentifier=DR;r1.NAME="RelativeObjectIdentifier";var NR,Lt=class extends wr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};NR=Lt;ue.Sequence=NR;Lt.NAME="SEQUENCE";var OR,Un=class extends wr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};OR=Un;ue.Set=OR;Un.NAME="SET";var D3=class extends Xo(Ur){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Bn}toJSON(){return{...super.toJSON(),value:this.value}}};D3.NAME="StringValueBlock";var N3=class extends D3{};N3.NAME="SimpleStringValueBlock";var En=class extends Qp{constructor({...e}={}){super(e,N3)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,He.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);this.valueBlock.value=e}};En.NAME="SIMPLE STRING";var O3=class extends En{fromBuffer(e){this.valueBlock.valueHexView=He.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=He.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=He.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(He.Convert.FromUtf8String(e)),this.valueBlock.value=e}};O3.NAME="Utf8StringValueBlock";var LR,Oi=class extends O3{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};LR=Oi;ue.Utf8String=LR;Oi.NAME="UTF8String";var L3=class extends En{fromBuffer(e){this.valueBlock.value=He.Convert.ToUtf16String(e),this.valueBlock.valueHexView=He.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(He.Convert.FromUtf16String(e))}};L3.NAME="BmpStringValueBlock";var BR,Pl=class extends L3{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};BR=Pl;ue.BmpString=BR;Pl.NAME="BMPString";var B3=class extends En{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let i=0;i<n.length;i+=4)n[i]=n[i+3],n[i+1]=n[i+2],n[i+2]=0,n[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){let o=Ka(e.charCodeAt(i),8),s=new Uint8Array(o);if(s.length>4)continue;let a=4-s.length;for(let c=s.length-1;c>=0;c--)n[i*4+c+a]=s[c]}this.valueBlock.value=e}};B3.NAME="UniversalStringValueBlock";var MR,Rl=class extends B3{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};MR=Rl;ue.UniversalString=MR;Rl.NAME="UniversalString";var UR,Dl=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};UR=Dl;ue.NumericString=UR;Dl.NAME="NumericString";var FR,Nl=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};FR=Nl;ue.PrintableString=FR;Nl.NAME="PrintableString";var $R,Ol=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};$R=Ol;ue.TeletexString=$R;Ol.NAME="TeletexString";var HR,Ll=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};HR=Ll;ue.VideotexString=HR;Ll.NAME="VideotexString";var VR,Bl=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};VR=Bl;ue.IA5String=VR;Bl.NAME="IA5String";var zR,Ml=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};zR=Ml;ue.GraphicString=zR;Ml.NAME="GraphicString";var KR,ja=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};KR=ja;ue.VisibleString=KR;ja.NAME="VisibleString";var qR,Ul=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};qR=Ul;ue.GeneralString=qR;Ul.NAME="GeneralString";var jR,Fl=class extends En{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};jR=Fl;ue.CharacterString=jR;Fl.NAME="CharacterString";var WR,Wa=class extends ja{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,He.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let i=parseInt(n[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=Ln(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=Ln(this.month,2),t[2]=Ln(this.day,2),t[3]=Ln(this.hour,2),t[4]=Ln(this.minute,2),t[5]=Ln(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};WR=Wa;ue.UTCTime=WR;Wa.NAME="UTCTime";var GR,$l=class extends Wa{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",i="",o=0,s,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let f=new Number(e[e.length-1]);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let f=1,h=n.indexOf("+"),d="";if(h===-1&&(h=n.indexOf("-"),f=-1),h!==-1){if(d=n.substring(h+1),n=n.substring(0,h),d.length!==2&&d.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(d.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=f*m,d.length===4){if(m=parseInt(d.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=f*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let f=new Number(`0${n.substring(l)}`);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");o=f.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case i.length===8:if(s=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.minute=Math.floor(f),f=60*(f-this.minute),this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case i.length===12:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case i.length===14:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=1e3*o;this.millisecond=Math.floor(f)}break;default:throw new Error("Wrong input string for conversion")}let u=s.exec(i);if(u===null)throw new Error("Wrong input string for conversion");for(let f=1;f<u.length;f++)switch(f){case 1:this.year=parseInt(u[f],10);break;case 2:this.month=parseInt(u[f],10);break;case 3:this.day=parseInt(u[f],10);break;case 4:this.hour=parseInt(u[f],10)+a;break;case 5:this.minute=parseInt(u[f],10)+c;break;case 6:this.second=parseInt(u[f],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let f=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=f.getUTCFullYear(),this.month=f.getUTCMonth(),this.day=f.getUTCDay(),this.hour=f.getUTCHours(),this.minute=f.getUTCMinutes(),this.second=f.getUTCSeconds(),this.millisecond=f.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(Ln(this.year,4)),t.push(Ln(this.month,2)),t.push(Ln(this.day,2)),t.push(Ln(this.hour,2)),t.push(Ln(this.minute,2)),t.push(Ln(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(Ln(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};GR=$l;ue.GeneralizedTime=GR;$l.NAME="GeneralizedTime";var XR,n1=class extends Oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};XR=n1;ue.DATE=XR;n1.NAME="DATE";var YR,i1=class extends Oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};YR=i1;ue.TimeOfDay=YR;i1.NAME="TimeOfDay";var QR,o1=class extends Oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};QR=o1;ue.DateTime=QR;o1.NAME="DateTime";var ZR,s1=class extends Oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};ZR=s1;ue.Duration=ZR;s1.NAME="Duration";var JR,a1=class extends Oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};JR=a1;ue.TIME=JR;a1.NAME="TIME";var Go=class{constructor({name:e=Bn,optional:t=!1}={}){this.name=e,this.optional=t}},od=class extends Go{constructor({value:e=[],...t}={}){super(t),this.value=e}},Hl=class extends Go{constructor({value:e=new Go,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}},K9=class{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=He.BufferSourceConverter.toUint8Array(e)}constructor({data:e=M3}={}){this.dataView=He.BufferSourceConverter.toUint8Array(e)}fromBER(e,t,n){let i=t+n;return this.dataView=He.BufferSourceConverter.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}};function qa(r,e,t){if(t instanceof od){for(let o of t.value)if(qa(r,e,o).verified)return{verified:!0,result:r};{let o={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(z9)&&(o.name=t.name),o}}if(t instanceof Go)return t.hasOwnProperty(z9)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(wG in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(EG in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(SG in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(xG)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(bG)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(vG)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(yG in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(wR in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let o=t.idBlock.valueHexView,s=e.idBlock.valueHexView;if(o.length!==s.length)return{verified:!1,result:r};for(let a=0;a<o.length;a++)if(o[a]!==s[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&(r[t.name]=e)),t instanceof ue.Constructed){let o=0,s={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Hl&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-o>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){let l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Hl){if(s=qa(r,e.valueBlock.value[c],t.valueBlock.value[0].value),s.verified===!1)if(t.valueBlock.value[0].optional)o++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&delete r[t.name]),s;if(z9 in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};AG in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(s=qa(r,e.valueBlock.value[c-o],t.valueBlock.value[c]),s.verified===!1)if(t.valueBlock.value[c].optional)o++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&delete r[t.name]),s;if(s.verified===!1){let c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&wR in e.valueBlock){let o=sd(e.valueBlock.valueHexView);if(o.offset===-1){let s={verified:!1,result:o.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Bn),t.name&&(delete r[t.name],s.name=t.name)),s}return qa(r,o.result,t.primitiveSchema)}return{verified:!0,result:r}}function kG(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};let t=sd(He.BufferSourceConverter.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:qa(t.result,t.result,e)}async function U3(r,e){let n=await rd.create().encrypt(r,e);return ar.encode(n)}async function W9(r,e,t){if(r.type==="RSA")return NG(r,e,t);if(r.type==="Ed25519")return PG(r,e,t);if(r.type==="secp256k1")return RG(r,e,t);if(r.type==="ECDSA")return DG(r,e,t);throw new Xi}async function PG(r,e,t="libp2p-key"){if(t==="libp2p-key")return U3(Jc(r),e);throw new U(`export format '${t}' is not supported`)}async function RG(r,e,t="libp2p-key"){if(t==="libp2p-key")return U3(Jc(r),e);throw new U("Export format is not supported")}async function DG(r,e,t="libp2p-key"){if(t==="libp2p-key")return U3(Jc(r),e);throw new U(`export format '${t}' is not supported`)}async function NG(r,e,t="pkcs-8"){if(t==="pkcs-8")return OG(r,e);if(t==="libp2p-key")return U3(Jc(r),e);throw new U("Export format is not supported")}async function OG(r,e){let t=In.get(),i=new Lt({value:[new li({value:0}),new Lt({value:[new ui({value:"1.2.840.113549.1.1.1"}),new Mn]}),new sn({valueHex:r.raw})]}).toBER(),o=new Uint8Array(i,0,i.byteLength),s=mn(16),a=await Q0(mf,e,s,{c:1e4,dkLen:32}),c=mn(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new Lt({value:[new sn({valueHex:s}),new li({value:1e4}),new li({value:32}),new Lt({value:[new ui({value:"1.2.840.113549.2.11"}),new Mn]})]}),h=new Lt({value:[new ui({value:"1.2.840.113549.1.5.13"}),new Lt({value:[new Lt({value:[new ui({value:"1.2.840.113549.1.5.12"}),f]}),new Lt({value:[new ui({value:"2.16.840.1.101.3.4.1.42"}),new sn({valueHex:c})]})]})]}),m=new Lt({value:[h,new sn({valueHex:u})]}).toBER(),g=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...H(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function G9(r,e){try{let t=await LG(r,e);return A_(t)}catch{}if(!r.includes("BEGIN"))throw new U("Encrypted key was not a libp2p-key or a PEM file");return BG(r,e)}async function LG(r,e){let t=ar.decode(r);return rd.create().decrypt(t,e)}async function BG(r,e){let t=In.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let o=O(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=fi(o),{iv:a,salt:c,iterations:l,keySize:u,cipherText:f}=MG(s),h=await Q0(mf,e,c,{c:l,dkLen:u}),d=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),m=c1(await t.subtle.decrypt({name:"AES-CBC",iv:a},d,f)),{result:g}=fi(m);n=rD(g)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let o=O(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=fi(o);n=rD(s)}else throw new U("Could not parse private key from PEM data");let i=__(n);if(i.type!=="RSA")throw new U("Could not parse RSA private key from PEM data");return i}function MG(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new U("Only pkcs5PBES2 encrypted private keys are supported");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new U("Only pkcs5PBKDF2 key derivation functions are supported");let o=n.valueBlock.value[1],s=c1(o.valueBlock.value[0].getValue()),a=1e4,c=32;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new U("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new U("Only AES-CBC encryption schemes are supported")}}}}let f=c1(l.valueBlock.value[1].getValue());return{cipherText:c1(r.valueBlock.value[1].getValue()),salt:s,iterations:a,keySize:c,iv:f}}function rD(r){return c1(r.valueBlock.value[2].getValue())}function c1(r){return new Uint8Array(r,0,r.byteLength)}var UG="/pkcs8/",Y9="/info/",l1=new WeakMap,Vl={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},X9={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ad(r){return r==null||typeof r!="string"?!1:r===(0,nD.default)(r.trim())&&r.length>0}async function Fr(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function zl(r){return new nt(UG+r)}function cd(r){return new nt(Y9+r)}async function FG(r){let e=Jc(r),t=await Fe.digest(e);return Le.encode(t.bytes).substring(1)}var F3=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=Wt(X9,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Vl.minKeyLength)throw new Error(`dek.keyLength must be least ${Vl.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Vl.minSaltLength)throw new Error(`dek.saltLength must be least ${Vl.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Vl.minIterationCount)throw new Error(`dek.iterationCount must be least ${Vl.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Jh(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";l1.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[tt]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},X9),t=Math.ceil(Vl.minSaltLength/3)*3;return e.dek.salt=H(mn(t),"base64"),e}static get options(){return X9}async findKeyByName(e){if(!ad(e))throw await Fr(),new U(`Invalid key name '${e}'`);let t=cd(e);try{let n=await this.components.datastore.get(t);return JSON.parse(H(n))}catch(n){throw await Fr(),this.log.error(n),new We(`Key '${e}' does not exist.`)}}async findKeyById(e){try{let t={prefix:Y9};for await(let n of this.components.datastore.query(t)){let i=JSON.parse(H(n.value));if(i.id===e)return i}throw new U(`Key with id '${e}' does not exist.`)}catch(t){throw await Fr(),t}}async importKey(e,t){if(!ad(e))throw await Fr(),new U(`Invalid key name '${e}'`);if(t==null)throw await Fr(),new U("Key is required");let n=zl(e);if(await this.components.datastore.has(n))throw await Fr(),new U(`Key '${e}' already exists`);let o,s;try{o=await FG(t);let l=l1.get(this);if(l==null)throw new U("dek missing");let u=l.dek;s=await W9(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Fr(),l}let a={name:e,id:o},c=this.components.datastore.batch();return c.put(n,O(s)),c.put(cd(e),O(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!ad(e))throw await Fr(),new U(`Invalid key name '${e}'`);let t=zl(e);try{let n=await this.components.datastore.get(t),i=H(n),o=l1.get(this);if(o==null)throw new U("dek missing");let s=o.dek;return await G9(i,s)}catch(n){throw await Fr(),n}}async removeKey(e){if(!ad(e)||e===this.self)throw await Fr(),new U(`Invalid key name '${e}'`);let t=zl(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(cd(e)),await i.commit(),n}async listKeys(){let e={prefix:Y9},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(H(n.value)));return t}async renameKey(e,t){if(!ad(e)||e===this.self)throw await Fr(),new U(`Invalid old key name '${e}'`);if(!ad(t)||t===this.self)throw await Fr(),new U(`Invalid new key name '${t}'`);let n=zl(e),i=zl(t),o=cd(e),s=cd(t);if(await this.components.datastore.has(i))throw await Fr(),new U(`Key '${t}' already exists`);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(o),u=JSON.parse(H(l));u.name=t;let f=this.components.datastore.batch();return f.put(i,c),f.put(s,O(JSON.stringify(u))),f.delete(n),f.delete(o),await f.commit(),u}catch(c){throw await Fr(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Fr(),new U(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Fr(),new U(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Fr(),new U(`Invalid pass length ${t.length}`);this.log("recreating keychain");let n=l1.get(this);if(n==null)throw new U("dek missing");let i=n.dek;this.init.pass=t;let o=t!=null&&this.init.dek?.salt!=null?Jh(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";l1.set(this,{dek:o});let s=await this.listKeys();for(let a of s){let c=await this.components.datastore.get(zl(a.name)),l=H(c),u=await G9(l,i),f=o.toString(),h=await W9(u,f,u.type==="RSA"?"pkcs-8":"libp2p-key"),d=this.components.datastore.batch(),m={name:a.name,id:a.id};d.put(zl(a.name),O(h)),d.put(cd(a.name),O(JSON.stringify(m))),await d.commit()}this.log("keychain reconstructed")}};function $3(r={}){return e=>new F3(e,r)}var ld=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new Q9}async consume(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,t,o);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(i,s.consumedPoints,this.blockDuration)),new f0("Rate limit exceeded",s);if(this.execEvenly&&s.msBeforeNext>0&&!s.isFirstInDuration){let a=Math.ceil(s.msBeforeNext/(s.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=s.consumedPoints*this.execEvenlyMinDelayMs),await Py(a)}return s}penalty(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,t,o);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,-t,o);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let n=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:i,isFirstInDuration:!1}}set(e,t,n=0){let i=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},Q9=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let i=this.storage.get(e);if(i!=null){let o=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||o>0?(i.value+=t,{remainingPoints:0,msBeforeNext:o,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let i=n*1e3,o=this.storage.get(e);o!=null&&clearTimeout(o.timeoutId);let s={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,s),i>0&&(s.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),s.timeoutId.unref!=null&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};var Xe;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(Xe||(Xe={}));var u1=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Z9=Object.freeze({NEW_STREAM:Xe.NEW_STREAM,MESSAGE:Xe.MESSAGE_INITIATOR,CLOSE:Xe.CLOSE_INITIATOR,RESET:Xe.RESET_INITIATOR}),iD=Object.freeze({MESSAGE:Xe.MESSAGE_RECEIVER,CLOSE:Xe.CLOSE_RECEIVER,RESET:Xe.RESET_RECEIVER});var J9=1<<20,$G=4<<20,H3=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=J9,t=$G){this._buffer=new oe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Be("Unprocessed message queue size too large!");let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}let{id:n,type:i,length:o,offset:s}=this._headerInfo;if(this._buffer.length-s<o)break;let c={id:n,type:i};(i===Xe.NEW_STREAM||i===Xe.MESSAGE_INITIATOR||i===Xe.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(s,s+o)),t.push(c),this._buffer.consume(s+o),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=sD(e),{value:i,offset:o}=sD(e,n),s=t&7;if(u1[s]==null)throw new Error(`Invalid type received: ${s}`);if(i>this._maxMessageSize)throw new Be("Message size too large");return{id:t>>3,type:s,offset:n+o,length:i}}},HG=128,oD=127;function sD(r,e=0){let t=0,n=0,i=e,o,s=r.length;do{if(i>=s||n>49)throw e=0,new RangeError("Could not decode varint");o=r.get(i++),t+=n<28?(o&oD)<<n:(o&oD)*Math.pow(2,n),n+=7}while(o>=HG);return e=i-e,{value:t,offset:e}}var eb=10*1024,tb=class{_pool;_poolOffset;constructor(){this._pool=$t(eb),this._poolOffset=0}write(e,t){let n=this._pool,i=this._poolOffset;ht(e.id<<3|e.type,n,i),i+=Oe(e.id<<3|e.type),(e.type===Xe.NEW_STREAM||e.type===Xe.MESSAGE_INITIATOR||e.type===Xe.MESSAGE_RECEIVER)&&e.data!=null?(ht(e.data.length,n,i),i+=Oe(e.data.length)):(ht(0,n,i),i+=Oe(0));let o=n.subarray(this._poolOffset,i);eb-i<100?(this._pool=$t(eb),this._poolOffset=0):this._poolOffset=i,t.append(o),(e.type===Xe.NEW_STREAM||e.type===Xe.MESSAGE_INITIATOR||e.type===Xe.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},VG=new tb;async function*aD(r){for await(let e of r){let t=new oe;VG.write(e,t),yield t}}var V3=class extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}};var rb=class extends Ba{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?Z9:iD,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:Z9.NEW_STREAM,data:new oe(O(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function cD(r){let{id:e,name:t,send:n,onEnd:i,type:o="initiator",maxMsgSize:s=J9}=r;return new rb({id:o==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:o==="initiator"?"outbound":"inbound",maxDataSize:s,onEnd:i,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${o}:${e}`)})}var zG=1024,KG=1024,qG=1024*1024*4,jG=5,WG=500;function lD(r){let e={...r,type:`${u1[r.type]} (${r.type})`};return r.type===Xe.NEW_STREAM&&(e.data=H(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===Xe.MESSAGE_INITIATOR||r.type===Xe.MESSAGE_RECEIVER)&&(e.data=H(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var z3=class{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??WG,this.sink=this._createSink(),this._source=Xr({objectMode:!0,onEnd:()=>{for(let n of this._streams.initiators.values())n.destroy();for(let n of this._streams.receivers.values())n.destroy()}}),this.source=ot(this._source,n=>aD(n)),this.closeController=new AbortController,this.rateLimiter=new ld({points:t.disconnectThreshold??jG,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new No("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,i=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:i})}_newStream(e){let{id:t,name:n,type:i,registry:o}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??KG))throw new ca("Too many outbound streams open");if(o.has(t))throw new Error(`${i} stream ${t} already exists!`);let c=cD({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,lD(l)),this._source.push(l)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,c.protocol),o.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return o.set(t,c),c}_createSink(){return async t=>{let n=()=>{oy(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{let i=new H3(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let o of t)for(let s of i.write(o))await this._handleIncoming(s);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",lD(e)),e.type===Xe.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??zG)){this.log("too many inbound streams open"),this._source.push({id:t,type:Xe.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:H(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let o=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(o==null){this.log("missing stream %s for message type %s",t,u1[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let s=this._init.maxStreamBufferSize??qG;try{switch(n){case Xe.MESSAGE_INITIATOR:case Xe.MESSAGE_RECEIVER:if(o.sourceReadableLength()>s)throw this._source.push({id:e.id,type:n===Xe.MESSAGE_INITIATOR?Xe.RESET_RECEIVER:Xe.RESET_INITIATOR}),new V3("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");o.sourcePush(e.data);break;case Xe.CLOSE_INITIATOR:case Xe.CLOSE_RECEIVER:o.remoteCloseWrite();break;case Xe.RESET_INITIATOR:case Xe.RESET_RECEIVER:o.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),o.abort(a)}}};var nb=class{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[tt]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new z3(this.components,{...e,...this._init})}};function uD(r={}){return e=>new nb(e,r)}var fD="1.0.0",dD="ping",hD="ipfs";var K3=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??hD}/${dD}/${fD}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[tt]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now(),i=mo(t),o=!1;Promise.resolve().then(async()=>{for(;;){let s=AbortSignal.timeout(this.timeout);s.addEventListener("abort",()=>{t?.abort(new Oo("ping timeout"))});let a=await i.read({bytes:32,signal:s});await i.write(a,{signal:s}),o=!0}}).catch(s=>{o&&s.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,s),t?.abort(s))}).finally(()=>{let s=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,s);let a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);let n=Date.now(),i=mn(32),o=await this.components.connectionManager.openConnection(e,t),s;if(t.signal==null){let a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{s=await o.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let a=mo(s),[,c]=await Promise.all([a.write(i,t),a.read({...t,bytes:32})]),l=Date.now()-n;if(!pe(i,c.subarray()))throw new a0(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",o.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",o.remotePeer,a),s?.abort(a),a}finally{s!=null&&await s.close(t)}}};function pD(r={}){return e=>new K3(e,r)}var an;(function(r){let e;(function(i){i.FIN="FIN",i.STOP_SENDING="STOP_SENDING",i.RESET="RESET",i.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(i){i[i.FIN=0]="FIN",i[i.STOP_SENDING=1]="STOP_SENDING",i[i.RESET=2]="RESET",i[i.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.flag!=null&&(o.uint32(8),r.Flag.codec().encode(i.flag,o)),i.message!=null&&(o.uint32(18),o.bytes(i.message)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.flag=r.Flag.codec().decode(i);break}case 2:{a.message=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(an||(an={}));var mD=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],ob=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),gD="libp2p+webrtc+v1/";var yD=466,wD=2*1024*1024,xD=30*1e3,ud=16*1024;function QG(r=ud){let e=Oe(r-Oe(r)),t=1+Oe(Object.keys(an.Flag).length-1),n=1,i=r-e-t-n,o=Oe(i);return e+t+n+o}var bD=QG(),vD=5e3,ED=5e3,SD=3e4,sb="/webrtc",f1="/webrtc-signaling/0.0.1",AD="/libp2p/webrtc-direct/certificate",_D="webrtc-direct-certificate-private-key";var ID=12096e5,ab=864e5;var TD=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,o;n<i;n++)(o||!(n in e))&&(o||(o=Array.prototype.slice.call(e,0,n)),o[n]=e[n]);return r.concat(o||Array.prototype.slice.call(e))},ZG=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var JG=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}();var eX=function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r}();var tX=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var rX=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var nX=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,iX=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,CD=3,oX=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",nX]],kD=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function RD(r){return r?PD(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new rX:typeof navigator<"u"?PD(navigator.userAgent):cX()}function sX(r){return r!==""&&oX.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var o=i.exec(r);return!!o&&[n,o]},!1)}function PD(r){var e=sX(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new tX;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<CD&&(i=TD(TD([],i,!0),lX(CD-i.length),!0)):i=[];var o=i.join("."),s=aX(r),a=iX.exec(r);return a&&a[1]?new eX(t,o,s,a[1]):new ZG(t,o,s)}function aX(r){for(var e=0,t=kD.length;e<t;e++){var n=kD[e],i=n[0],o=n[1],s=o.exec(r);if(s)return i}return null}function cX(){var r=typeof process<"u"&&process.version;return r?new JG(process.version.slice(1)):null}function lX(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var DD=RD(),d1=DD!=null&&DD.name==="firefox",q3=async function*(){},j3=async r=>{};function ND(r,e,t=SD,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let i=ye(),o=!1;r.bufferedAmountLowThreshold=0;let s=()=>{o||(n.log("%s drain channel closed before drain",e),i.resolve())};r.addEventListener("close",s,{once:!0}),r.addEventListener("bufferedamountlow",()=>{o=!0,r.removeEventListener("close",s),i.resolve()}),await io(i.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(i=>{n.log.error("error closing outbound stream",i)})}async function cb(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??mD.map(e=>({urls:[e]})),r}var OD=(r=32)=>gD+[...Array(r)].map(()=>ob.at(Math.floor(Math.random()*ob.length))).join("");var Kl=class{log;peerConnection;remoteAddr;timeline;metrics;source=q3();sink=j3;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let n=this.peerConnection,i=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",i),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var lb=class extends Ba{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){let t=e.onEnd;switch(e.onEnd=i=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await io(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),t?.(i)}).catch(o=>{this.log.error("error ending stream",o)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=Xr(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??xD,this.maxBufferedAmount=e.maxBufferedAmount??wD,this.maxMessageSize=(e.maxMessageSize??ud)-bD,this.receiveFinAck=ye(),this.finAckTimeout=e.closeTimeout??vD,this.openTimeout=e.openTimeout??ED,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Cc("Unknown datachannel state")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime()},this.channel.onclose=i=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=i=>{this.log.trace("received onerror event"),this.closeController.abort();let o=i.error;this.abort(o)},this.channel.onmessage=async i=>{let{data:o}=i;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};let n=this;Promise.resolve().then(async()=>{for await(let i of Qi(this.incomingData)){let o=n.processIncomingProtobuf(i);o!=null&&n.sourcePush(new oe(o))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Cc(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){let n=AbortSignal.timeout(this.openTimeout),i=Ne([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Er(this.channel,"open",i)}finally{i.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){let n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),i=Ne([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Er(this.channel,"bufferedamountlow",i)}catch(o){throw n.aborted?new Oo(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):o}finally{i.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){let t=e.byteLength;for(e=e.sublist();e.byteLength>0;){let n=Math.min(e.byteLength,this.maxMessageSize),i=e.subarray(0,n),o=an.encode({message:i}),s=Yi.single(o);this.log.trace("sending %d/%d bytes on channel",i.byteLength,t),await this._sendMessage(s),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(an.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(an.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Dt(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(an.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=an.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===an.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(an.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===an.Flag.RESET&&this.reset(),t.flag===an.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===an.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());let t=an.encode({flag:e}),n=Yi.single(t);try{return await this._sendMessage(n,!1),!0}catch(i){this.log.error("could not send flag %s - %e",e.toString(),i)}return!1}};function fd(r){let{channel:e,direction:t,handshake:n}=r;return new lb({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}var Ga=class{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??sb,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}let i={},o=fd({channel:n,direction:"inbound",onEnd:s=>{i.onEnd(s)},logger:e.logger,...this.dataChannelOptions});i.stream=o,i.channel=n,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(s=>s.stream.id!==o.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new ub(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},ub=class{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??sb,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}let i=n.id,o=fd({channel:n,direction:"inbound",onEnd:()=>{this.#e(o,n),this.log("incoming channel %s ended",i)},logger:this.logger,...this.dataChannelOptions});this.streams.push(o),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(o)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),ND(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}source=q3();sink=j3;newStream(){let e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);let n=fd({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}};var W3=globalThis.RTCPeerConnection,G3=globalThis.RTCSessionDescription,LD=globalThis.RTCIceCandidate;var Xa=class extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}},Bi=class extends Xa{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}};var X3=class extends Xa{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}};var Y3=class extends Xa{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}},Q3=class extends Xa{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}};var Fn;(function(r){let e;(function(i){i.SDP_OFFER="SDP_OFFER",i.SDP_ANSWER="SDP_ANSWER",i.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.SDP_OFFER=0]="SDP_OFFER",i[i.SDP_ANSWER=1]="SDP_ANSWER",i[i.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.data!=null&&(o.uint32(18),o.string(i.data)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.data=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(Fn||(Fn={}));var Z3=async(r,e,t)=>{try{let n=ye();for(uX(r,n);;){let i=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(i==null){t.signal?.throwIfAborted();break}if(i.type!==Fn.Type.ICE_CANDIDATE)throw new Be("ICE candidate message expected");let o=JSON.parse(i.data??"null");if(o===""||o===null){t.onProgress?.(new G("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let s=new LD(o);t.log.trace("%s received new ICE candidate %o",t.direction,o);try{t.onProgress?.(new G("webrtc:add-ice-candidate",s.candidate)),await r.addIceCandidate(s)}catch(a){t.log.error("%s bad candidate received",t.direction,o,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&J3(r)!=="connected")throw n}};function J3(r){return d1?r.iceConnectionState:r.connectionState}function uX(r,e){r[d1?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(J3(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Vu("RTCPeerConnection was closed"));break;default:break}}}async function BD({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:i,connectionManager:o,transportManager:s,log:a,logger:c,onProgress:l}){let{baseAddr:u}=MD(i);n?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);let f=u.getPeerId();if(f==null)throw new U("Relay peer was missing");let h=o.getConnections(at(f)),d,m=!1;h.length===0?(l?.(new G("webrtc:dial-relay")),d=await s.dial(u,{signal:t,onProgress:l}),m=!0):(l?.(new G("webrtc:reuse-relay-connection")),d=h[0]);try{l?.(new G("webrtc:open-signaling-stream"));let g=await d.newStream(f1,{signal:t,runOnLimitedConnection:!0}),w=ir(g).pb(Fn),x=new W3(r),v=new Ga({logger:c},{peerConnection:x,dataChannelOptions:e});try{let b=x.createDataChannel("init");x.onicecandidate=({candidate:A})=>{let I=JSON.stringify(A?.toJSON()??null);a.trace("initiator sending ICE candidate %o",A),w.write({type:Fn.Type.ICE_CANDIDATE,data:I},{signal:t}).catch(k=>{a.error("error sending ICE candidate",k)})},x.onicecandidateerror=A=>{a.error("initiator ICE candidate error",A)};let S=await x.createOffer().catch(A=>{throw a.error("could not execute createOffer",A),new Bi("Failed to set createOffer")});a.trace("initiator send SDP offer %s",S.sdp),l?.(new G("webrtc:send-sdp-offer")),await w.write({type:Fn.Type.SDP_OFFER,data:S.sdp},{signal:t}),await x.setLocalDescription(S).catch(A=>{throw a.error("could not execute setLocalDescription",A),new Bi("Failed to set localDescription")}),l?.(new G("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");let T=await w.read({signal:t});if(T.type!==Fn.Type.SDP_ANSWER)throw new Bi("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",T.data);let D=new G3({type:"answer",sdp:T.data});return await x.setRemoteDescription(D).catch(A=>{throw a.error("could not execute setRemoteDescription",A),new Bi("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new G("webrtc:read-ice-candidates")),await Z3(x,w,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),b.close(),l?.(new G("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:x,muxerFactory:v}}catch(b){throw a.error("outgoing signaling error",b),x.close(),g.abort(b),b}finally{x.onicecandidate=null,x.onicecandidateerror=null}}finally{if(m)try{await d.close({signal:t})}catch(g){d.abort(g)}}}var UD=gt(Jg.matchers[0],$e("p2p-circuit")),e4=class r extends Me{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>UD.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r)).map(e=>e.getAddrs().filter(t=>UD.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}};async function FD({peerConnection:r,stream:e,signal:t,connection:n,log:i}){i.trace("new inbound signaling stream");let o=ir(e).pb(Fn);try{r.onicecandidate=({candidate:u})=>{let f=JSON.stringify(u?.toJSON()??null);i.trace("recipient sending ICE candidate %s",f),o.write({type:Fn.Type.ICE_CANDIDATE,data:f},{signal:t}).catch(h=>{i.error("error sending ICE candidate",h)})},i.trace("recipient read SDP offer");let a=await o.read({signal:t});if(a.type!==Fn.Type.SDP_OFFER)throw new Bi(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);i.trace("recipient received SDP offer %s",a.data);let c=new G3({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw i.error("could not execute setRemoteDescription",u),new Bi("Failed to set remoteDescription")});let l=await r.createAnswer().catch(u=>{throw i.error("could not execute createAnswer",u),new Bi("Failed to create answer")});i.trace("recipient send SDP answer %s",l.sdp),await o.write({type:Fn.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw i.error("could not execute setLocalDescription",u),new Bi("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await Z3(r,o,{direction:"recipient",signal:t,log:i})}catch(a){if(J3(r)!=="connected")throw i.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}let s=se(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",s),{remoteAddress:s}}var t4=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[oa]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[tt]=["@libp2p/transport"];[Jn]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(f1,e=>{let t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(f1),this._started=!1}createListener(e){return new e4(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Ep.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:i,muxerFactory:o}=await BD({rtcConfiguration:await cb(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=new Kl(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:o,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,s),a}async _onProtocol({connection:e,stream:t},n){let i=new W3(await cb(this.init.rtcConfiguration)),o=new Ga(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s}=await FD({peerConnection:i,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});let a=new Kl(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:s,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:o,signal:n}),this._closeOnShutdown(i,a)}catch(s){throw this.log.error("incoming signaling error",s),i.close(),t.abort(s),s}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function MD(r){let e=r.toString().split("/webrtc/");if(e.length!==2)throw new U("webrtc protocol was not present in multiaddr");if(!e[0].includes("/p2p-circuit"))throw new U("p2p-circuit protocol was not present in multiaddr");let t=se(e[0]),i=se("/"+e[1]).getPeerId();if(i==null)throw new U("destination peer id was missing");let o=t.protos().pop();if(o===void 0)throw new U("invalid multiaddr");return o.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:at(i)}}var JHe=it(HD());var P;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(P||(P={}));var E;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(E||(E={}));var fb=it(Ms()),Yo=class{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(fb.BufferSourceConverter.isBufferSource(e))this.unusedBits=t,this.value=fb.BufferSourceConverter.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof wo))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new wo({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new wo({name:e})}toNumber(){let e="",t=new Uint8Array(this.value);for(let n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2),n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;let i=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let o=0;for(;o<n;)i[o]=parseInt(t.slice(o<<3,(o<<3)+8),2),o++;this.value=i.buffer}};var db=it(Ms()),Se=class{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):db.BufferSourceConverter.isBufferSource(e)?this.buffer=db.BufferSourceConverter.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof sn))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new sn({valueHex:this.buffer})}toSchema(e){return new sn({name:e})}};var fX={fromASN:r=>r instanceof Mn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Mn;let e=fi(r);if(e.result.error)throw new Error(e.result.error);return e.result}},dX={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new li({value:+r})},hX={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new kl({value:r})},Ke={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new li({valueHex:r})};var pX={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new wo({valueHex:r})},mX={fromASN:r=>r.valueBlock.toString(),toASN:r=>new ui({value:r})},gX={fromASN:r=>r.valueBlock.value,toASN:r=>new Cl({value:r})},dd={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new sn({valueHex:r})},VD={fromASN:r=>new Se(r.getValue()),toASN:r=>r.toASN()};function Mi(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}var hb=Mi(Oi),yX=Mi(Pl),wX=Mi(Rl),xX=Mi(Dl),bX=Mi(Nl),vX=Mi(Ol),EX=Mi(Ll),SX=Mi(Bl),AX=Mi(Ml),_X=Mi(ja),IX=Mi(Ul),TX=Mi(Fl),CX={fromASN:r=>r.toDate(),toASN:r=>new Wa({valueDate:r})},kX={fromASN:r=>r.toDate(),toASN:r=>new $l({valueDate:r})},PX={fromASN:()=>null,toASN:()=>new Mn};function hd(r){switch(r){case E.Any:return fX;case E.BitString:return pX;case E.BmpString:return yX;case E.Boolean:return gX;case E.CharacterString:return TX;case E.Enumerated:return hX;case E.GeneralString:return IX;case E.GeneralizedTime:return kX;case E.GraphicString:return AX;case E.IA5String:return SX;case E.Integer:return dX;case E.Null:return PX;case E.NumericString:return xX;case E.ObjectIdentifier:return mX;case E.OctetString:return dd;case E.PrintableString:return bX;case E.TeletexString:return vX;case E.UTCTime:return CX;case E.UniversalString:return wX;case E.Utf8String:return hb;case E.VideotexString:return EX;case E.VisibleString:return _X;default:return null}}function Ui(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:Ui(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function mb(r){var e;if(r){let t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:mb(t)}return!1}function zD(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}var r4=class{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){let n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){let t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){let t={type:P.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){let n=this.items.get(e)||this.createDefault(e),i=[];for(let o in n.items){let s=n.items[o],a=t?o:"",c;if(typeof s.type=="number"){let u=E[s.type],f=Li[u];if(!f)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new f({name:a})}else Ui(s.type)?c=new s.type().toSchema(a):s.optional?this.get(s.type).type===P.Choice?c=new Go({name:a}):(c=this.create(s.type,!1),c.name=a):c=new Go({name:a});let l=!!s.optional||s.defaultValue!==void 0;if(s.repeated){c.name="";let u=s.repeated==="set"?Un:Lt;c=new u({name:"",value:[new Hl({name:a,value:c})]})}if(s.context!==null&&s.context!==void 0)if(s.implicit)if(typeof s.type=="number"||Ui(s.type)){let u=s.repeated?wr:Fs;i.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:s.context}}))}else{this.cache(s.type);let u=!!s.repeated,f=u?c:this.get(s.type,!0).schema;f="valueBlock"in f?f.valueBlock.value:f.value,i.push(new wr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:f}))}else i.push(new wr({optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}));else c.optional=l,i.push(c)}switch(n.type){case P.Sequence:return new Lt({value:i,name:""});case P.Set:return new Un({value:i,name:""});case P.Choice:return new od({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){let t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}};var Sn=new r4;var B=r=>e=>{let t;Sn.has(e)?t=Sn.get(e):(t=Sn.createDefault(e),Sn.set(e,t)),Object.assign(t,r)};var y=r=>(e,t)=>{let n;Sn.has(e.constructor)?n=Sn.get(e.constructor):(n=Sn.createDefault(e.constructor),Sn.set(e.constructor,n));let i=Object.assign({},r);if(typeof i.type=="number"&&!i.converter){let o=hd(r.type);if(!o)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=o}n.items[t]=i};var h1=class extends Error{constructor(){super(...arguments),this.schemas=[]}};var p1=class{static parse(e,t){let n=fi(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){var n;try{if(Ui(t))return new t().fromASN(e);let i=Sn.get(t);Sn.cache(t);let o=i.schema;if(e.constructor===wr&&i.type!==P.Choice){o=new wr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:i.schema.valueBlock.value});for(let c in i.items)delete e[c]}let s=qa({},e,o);if(!s.verified)throw new h1(`Data does not match to ${t.name} ASN1 schema. ${s.result.error}`);let a=new t;if(mb(t)){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let c=i.itemType;if(typeof c=="number"){let l=hd(c);if(!l)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);return t.from(e.valueBlock.value,u=>l.fromASN(u))}else return t.from(e.valueBlock.value,l=>this.fromASN(l,c))}for(let c in i.items){let l=s.result[c];if(!l)continue;let u=i.items[c],f=u.type;if(typeof f=="number"||Ui(f)){let h=(n=u.converter)!==null&&n!==void 0?n:Ui(f)?new f:null;if(!h)throw new Error("Converter is empty");if(u.repeated)if(u.implicit){let d=u.repeated==="sequence"?Lt:Un,m=new d;m.valueBlock=l.valueBlock;let g=fi(m.toBER(!1));if(g.offset===-1)throw new Error(`Cannot parse the child item. ${g.result.error}`);if(!("value"in g.result.valueBlock&&Array.isArray(g.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let w=g.result.valueBlock.value;a[c]=Array.from(w,x=>h.fromASN(x))}else a[c]=Array.from(l,d=>h.fromASN(d));else{let d=l;if(u.implicit){let m;if(Ui(f))m=new f().toSchema("");else{let g=E[f],w=Li[g];if(!w)throw new Error(`Cannot get '${g}' class from asn1js module`);m=new w}m.valueBlock=d.valueBlock,d=fi(m.toBER(!1)).result}a[c]=h.fromASN(d)}}else if(u.repeated){if(!Array.isArray(l))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");a[c]=Array.from(l,h=>this.fromASN(h,f))}else a[c]=this.fromASN(l,f)}return a}catch(i){throw i instanceof h1&&i.schemas.push(t.name),i}}};var m1=class r{static serialize(e){return e instanceof dr?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Ui(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");let t=e.constructor,n=Sn.get(t);Sn.cache(t);let i=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){let s=hd(n.itemType);if(!s)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>s.toASN(a))}else i=e.map(s=>this.toAsnItem({type:n.itemType},"[]",t,s))}else for(let s in n.items){let a=n.items[s],c=e[s];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&zD(this.serialize(a.defaultValue),this.serialize(c)))continue;let l=r.toAsnItem(a,s,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Ui(a.type))){let u={};u.valueHex=l instanceof Mn?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new Fs({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else i.push(new wr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new wr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let o;switch(n.type){case P.Sequence:o=new Lt({value:i});break;case P.Set:o=new Un({value:i});break;case P.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);o=i[0];break}return o}static toAsnItem(e,t,n,i){let o;if(typeof e.type=="number"){let s=e.converter;if(!s)throw new Error(`Property '${t}' doesn't have converter for type ${E[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");let a=Array.from(i,l=>s.toASN(l)),c=e.repeated==="sequence"?Lt:Un;o=new c({value:a})}else o=s.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");let s=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?Lt:Un;o=new a({value:s})}else o=this.toASN(i);return o}};var xe=class extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(let t of e)this.push(t)}}};var gb=it(Ms());var re=class r{static serialize(e){return m1.serialize(e)}static parse(e,t){return p1.parse(e,t)}static toString(e){let t=gb.BufferSourceConverter.isBufferSource(e)?gb.BufferSourceConverter.toArrayBuffer(e):r.serialize(e),n=fi(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}};function p(r,e,t,n){var i=arguments.length,o=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(o=(i<3?s(o):i>3?s(e,t,o):s(e,t))||o);return i>3&&o&&Object.defineProperty(e,t,o),o}var KD=it(Ms()),g1=class{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){let t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{let i=parseInt(n,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){let n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((i,o)=>{let s=parseInt(o,16);if(isNaN(s)||s<0||s>65535)throw new Error("Invalid IPv6 address part");return i.push(s>>8&255),i.push(s&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;let t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");let n=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],o=8-(n.length+i.length);if(o<0)throw new Error("Invalid IPv6 address");return[...n,...Array(o).fill("0"),...i].join(":")}static formatIPv6(e){let t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){let t=e.split(":"),n=-1,i=0,o=-1,s=0;for(let a=0;a<t.length;a++)t[a]==="0"?(o===-1&&(o=a),s++):(s>i&&(n=o,i=s),o=-1,s=0);if(s>i&&(n=o,i=s),i>1){let a=t.slice(0,n).join(":"),c=t.slice(n+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){let[t,n]=e.split("/"),i=parseInt(n,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;let t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,o)=>i+ +o,0),n=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){let t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){let n=t.length/2,i=t.slice(0,n),o=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";let a=o.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(KD.Convert.ToHex(e))}static fromString(e){if(e.includes("/")){let[n,i]=this.parseCIDR(e),o=new Uint8Array(n.length),s=i;for(let c=0;c<o.length;c++)s>=8?(o[c]=255,s-=8):s>0&&(o[c]=255<<8-s,s=0);let a=new Uint8Array(n.length*2);return a.set(n,0),a.set(o,n.length),a.buffer}let t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}};var qD=it(Ms()),yb,wb,xb,hr=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};p([y({type:E.TeletexString})],hr.prototype,"teletexString",void 0);p([y({type:E.PrintableString})],hr.prototype,"printableString",void 0);p([y({type:E.UniversalString})],hr.prototype,"universalString",void 0);p([y({type:E.Utf8String})],hr.prototype,"utf8String",void 0);p([y({type:E.BmpString})],hr.prototype,"bmpString",void 0);hr=p([B({type:P.Choice})],hr);var pd=class extends hr{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?qD.Convert.ToHex(this.anyValue):super.toString())}};p([y({type:E.IA5String})],pd.prototype,"ia5String",void 0);p([y({type:E.Any})],pd.prototype,"anyValue",void 0);pd=p([B({type:P.Choice})],pd);var ql=class{constructor(e={}){this.type="",this.value=new pd,Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],ql.prototype,"type",void 0);p([y({type:pd})],ql.prototype,"value",void 0);var Ya=yb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,yb.prototype)}};Ya=yb=p([B({type:P.Set,itemType:ql})],Ya);var bb=wb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,wb.prototype)}};bb=wb=p([B({type:P.Sequence,itemType:Ya})],bb);var xt=xb=class extends bb{constructor(e){super(e),Object.setPrototypeOf(this,xb.prototype)}};xt=xb=p([B({type:P.Sequence})],xt);var RX={fromASN:r=>g1.toString(dd.fromASN(r)),toASN:r=>dd.toASN(g1.fromString(r))},Qa=class{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Qa.prototype,"typeId",void 0);p([y({type:E.Any,context:0})],Qa.prototype,"value",void 0);var y1=class{constructor(e={}){this.partyName=new hr,Object.assign(this,e)}};p([y({type:hr,optional:!0,context:0,implicit:!0})],y1.prototype,"nameAssigner",void 0);p([y({type:hr,context:1,implicit:!0})],y1.prototype,"partyName",void 0);var _e=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Qa,context:0,implicit:!0})],_e.prototype,"otherName",void 0);p([y({type:E.IA5String,context:1,implicit:!0})],_e.prototype,"rfc822Name",void 0);p([y({type:E.IA5String,context:2,implicit:!0})],_e.prototype,"dNSName",void 0);p([y({type:E.Any,context:3,implicit:!0})],_e.prototype,"x400Address",void 0);p([y({type:xt,context:4,implicit:!1})],_e.prototype,"directoryName",void 0);p([y({type:y1,context:5})],_e.prototype,"ediPartyName",void 0);p([y({type:E.IA5String,context:6,implicit:!0})],_e.prototype,"uniformResourceIdentifier",void 0);p([y({type:E.OctetString,context:7,implicit:!0,converter:RX})],_e.prototype,"iPAddress",void 0);p([y({type:E.ObjectIdentifier,context:8,implicit:!0})],_e.prototype,"registeredID",void 0);_e=p([B({type:P.Choice})],_e);var Za="1.3.6.1.5.5.7",Ja=`${Za}.1`,jD=`${Za}.2`,jl=`${Za}.3`,n4=`${Za}.48`,b_e=`${jD}.1`,v_e=`${jD}.2`,vb=`${n4}.1`,Eb=`${n4}.2`,Sb=`${n4}.3`,Ab=`${n4}.5`,Re="2.5.29";var _b,i4=`${Ja}.1`,Hs=class{constructor(e={}){this.accessMethod="",this.accessLocation=new _e,Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Hs.prototype,"accessMethod",void 0);p([y({type:_e})],Hs.prototype,"accessLocation",void 0);var Wl=_b=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,_b.prototype)}};Wl=_b=p([B({type:P.Sequence,itemType:Hs})],Wl);var o4=`${Re}.35`,Gl=class extends Se{},Qo=class{constructor(e={}){e&&Object.assign(this,e)}};p([y({type:Gl,context:0,optional:!0,implicit:!0})],Qo.prototype,"keyIdentifier",void 0);p([y({type:_e,context:1,optional:!0,implicit:!0,repeated:"sequence"})],Qo.prototype,"authorityCertIssuer",void 0);p([y({type:E.Integer,context:2,optional:!0,implicit:!0,converter:Ke})],Qo.prototype,"authorityCertSerialNumber",void 0);var s4=`${Re}.19`,Xl=class{constructor(e={}){this.cA=!1,Object.assign(this,e)}};p([y({type:E.Boolean,defaultValue:!1})],Xl.prototype,"cA",void 0);p([y({type:E.Integer,optional:!0})],Xl.prototype,"pathLenConstraint",void 0);var Ib,Bt=Ib=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Ib.prototype)}};Bt=Ib=p([B({type:P.Sequence,itemType:_e})],Bt);var Tb,DX=`${Re}.29`,WD=Tb=class extends Bt{constructor(e){super(e),Object.setPrototypeOf(this,Tb.prototype)}};WD=Tb=p([B({type:P.Sequence})],WD);var Cb,c4=`${Re}.32`,J_e=`${c4}.0`,Vs=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};p([y({type:E.IA5String})],Vs.prototype,"ia5String",void 0);p([y({type:E.VisibleString})],Vs.prototype,"visibleString",void 0);p([y({type:E.BmpString})],Vs.prototype,"bmpString",void 0);p([y({type:E.Utf8String})],Vs.prototype,"utf8String",void 0);Vs=p([B({type:P.Choice})],Vs);var w1=class{constructor(e={}){this.organization=new Vs,this.noticeNumbers=[],Object.assign(this,e)}};p([y({type:Vs})],w1.prototype,"organization",void 0);p([y({type:E.Integer,repeated:"sequence"})],w1.prototype,"noticeNumbers",void 0);var x1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:w1,optional:!0})],x1.prototype,"noticeRef",void 0);p([y({type:Vs,optional:!0})],x1.prototype,"explicitText",void 0);var a4=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.IA5String})],a4.prototype,"cPSuri",void 0);p([y({type:x1})],a4.prototype,"userNotice",void 0);a4=p([B({type:P.Choice})],a4);var b1=class{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],b1.prototype,"policyQualifierId",void 0);p([y({type:E.Any})],b1.prototype,"qualifier",void 0);var Yl=class{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Yl.prototype,"policyIdentifier",void 0);p([y({type:b1,repeated:"sequence",optional:!0})],Yl.prototype,"policyQualifiers",void 0);var v1=Cb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Cb.prototype)}};v1=Cb=p([B({type:P.Sequence,itemType:Yl})],v1);var aIe=`${Re}.20`,E1=class{constructor(e=0){this.value=e}};p([y({type:E.Integer})],E1.prototype,"value",void 0);E1=p([B({type:P.Choice})],E1);var pIe=`${Re}.27`,GD=class extends E1{};GD=p([B({type:P.Choice})],GD);var kb,l4=`${Re}.31`,bo;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(bo||(bo={}));var S1=class extends Yo{toJSON(){let e=[],t=this.toNumber();return t&bo.aACompromise&&e.push("aACompromise"),t&bo.affiliationChanged&&e.push("affiliationChanged"),t&bo.cACompromise&&e.push("cACompromise"),t&bo.certificateHold&&e.push("certificateHold"),t&bo.cessationOfOperation&&e.push("cessationOfOperation"),t&bo.keyCompromise&&e.push("keyCompromise"),t&bo.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&bo.superseded&&e.push("superseded"),t&bo.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}},zs=class{constructor(e={}){Object.assign(this,e)}};p([y({type:_e,context:0,repeated:"sequence",implicit:!0})],zs.prototype,"fullName",void 0);p([y({type:Ya,context:1,implicit:!0})],zs.prototype,"nameRelativeToCRLIssuer",void 0);zs=p([B({type:P.Choice})],zs);var Zo=class{constructor(e={}){Object.assign(this,e)}};p([y({type:zs,context:0,optional:!0})],Zo.prototype,"distributionPoint",void 0);p([y({type:S1,context:1,optional:!0,implicit:!0})],Zo.prototype,"reasons",void 0);p([y({type:_e,context:2,optional:!0,repeated:"sequence",implicit:!0})],Zo.prototype,"cRLIssuer",void 0);var ec=kb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,kb.prototype)}};ec=kb=p([B({type:P.Sequence,itemType:Zo})],ec);var Pb,kIe=`${Re}.46`,XD=Pb=class extends ec{constructor(e){super(e),Object.setPrototypeOf(this,Pb.prototype)}};XD=Pb=p([B({type:P.Sequence,itemType:Zo})],XD);var MIe=`${Re}.28`,di=class r{constructor(e={}){this.onlyContainsUserCerts=r.ONLY,this.onlyContainsCACerts=r.ONLY,this.indirectCRL=r.ONLY,this.onlyContainsAttributeCerts=r.ONLY,Object.assign(this,e)}};di.ONLY=!1;p([y({type:zs,context:0,optional:!0})],di.prototype,"distributionPoint",void 0);p([y({type:E.Boolean,context:1,defaultValue:di.ONLY,implicit:!0})],di.prototype,"onlyContainsUserCerts",void 0);p([y({type:E.Boolean,context:2,defaultValue:di.ONLY,implicit:!0})],di.prototype,"onlyContainsCACerts",void 0);p([y({type:S1,context:3,optional:!0,implicit:!0})],di.prototype,"onlySomeReasons",void 0);p([y({type:E.Boolean,context:4,defaultValue:di.ONLY,implicit:!0})],di.prototype,"indirectCRL",void 0);p([y({type:E.Boolean,context:5,defaultValue:di.ONLY,implicit:!0})],di.prototype,"onlyContainsAttributeCerts",void 0);var YD=`${Re}.21`,A1;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(A1||(A1={}));var _1=class{constructor(e=A1.unspecified){this.reason=A1.unspecified,this.reason=e}toJSON(){return A1[this.reason]}toString(){return this.toJSON()}};p([y({type:E.Enumerated})],_1.prototype,"reason",void 0);_1=p([B({type:P.Choice})],_1);var Rb,u4=`${Re}.37`,I1=Rb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Rb.prototype)}};I1=Rb=p([B({type:P.Sequence,itemType:E.ObjectIdentifier})],I1);var GIe=`${u4}.0`,QD=`${jl}.1`,ZD=`${jl}.2`,JD=`${jl}.3`,eN=`${jl}.4`,tN=`${jl}.8`,rN=`${jl}.9`;var JIe=`${Re}.54`,Db=class{constructor(e=new ArrayBuffer(0)){this.value=e}};p([y({type:E.Integer,converter:Ke})],Db.prototype,"value",void 0);Db=p([B({type:P.Choice})],Db);var nN=`${Re}.24`,T1=class{constructor(e){this.value=new Date,e&&(this.value=e)}};p([y({type:E.GeneralizedTime})],T1.prototype,"value",void 0);T1=p([B({type:P.Choice})],T1);var Nb,fTe=`${Re}.18`,iN=Nb=class extends Bt{constructor(e){super(e),Object.setPrototypeOf(this,Nb.prototype)}};iN=Nb=p([B({type:P.Sequence})],iN);var f4=`${Re}.15`,vo;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(vo||(vo={}));var md=class extends Yo{toJSON(){let e=this.toNumber(),t=[];return e&vo.cRLSign&&t.push("crlSign"),e&vo.dataEncipherment&&t.push("dataEncipherment"),e&vo.decipherOnly&&t.push("decipherOnly"),e&vo.digitalSignature&&t.push("digitalSignature"),e&vo.encipherOnly&&t.push("encipherOnly"),e&vo.keyAgreement&&t.push("keyAgreement"),e&vo.keyCertSign&&t.push("keyCertSign"),e&vo.keyEncipherment&&t.push("keyEncipherment"),e&vo.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}};var Ob,vTe=`${Re}.30`,gd=class{constructor(e={}){this.base=new _e,this.minimum=0,Object.assign(this,e)}};p([y({type:_e})],gd.prototype,"base",void 0);p([y({type:E.Integer,context:0,defaultValue:0,implicit:!0})],gd.prototype,"minimum",void 0);p([y({type:E.Integer,context:1,optional:!0,implicit:!0})],gd.prototype,"maximum",void 0);var d4=Ob=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Ob.prototype)}};d4=Ob=p([B({type:P.Sequence,itemType:gd})],d4);var h4=class{constructor(e={}){Object.assign(this,e)}};p([y({type:d4,context:0,optional:!0,implicit:!0})],h4.prototype,"permittedSubtrees",void 0);p([y({type:d4,context:1,optional:!0,implicit:!0})],h4.prototype,"excludedSubtrees",void 0);var TTe=`${Re}.36`,p4=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.Integer,context:0,implicit:!0,optional:!0,converter:Ke})],p4.prototype,"requireExplicitPolicy",void 0);p([y({type:E.Integer,context:1,implicit:!0,optional:!0,converter:Ke})],p4.prototype,"inhibitPolicyMapping",void 0);var Lb,DTe=`${Re}.33`,C1=class{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],C1.prototype,"issuerDomainPolicy",void 0);p([y({type:E.ObjectIdentifier})],C1.prototype,"subjectDomainPolicy",void 0);var oN=Lb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Lb.prototype)}};oN=Lb=p([B({type:P.Sequence,itemType:C1})],oN);var Bb,Mb=`${Re}.17`,m4=Bb=class extends Bt{constructor(e){super(e),Object.setPrototypeOf(this,Bb.prototype)}};m4=Bb=p([B({type:P.Sequence})],m4);var $r=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],$r.prototype,"type",void 0);p([y({type:E.Any,repeated:"set"})],$r.prototype,"values",void 0);var Ub,GTe=`${Re}.9`,sN=Ub=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Ub.prototype)}};sN=Ub=p([B({type:P.Sequence,itemType:$r})],sN);var Fb=`${Re}.14`,$n=class extends Gl{};var nCe=`${Re}.16`,g4=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.GeneralizedTime,context:0,implicit:!0,optional:!0})],g4.prototype,"notBefore",void 0);p([y({type:E.GeneralizedTime,context:1,implicit:!0,optional:!0})],g4.prototype,"notAfter",void 0);var k1;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(k1||(k1={}));var y4=class extends Yo{toJSON(){let e=[],t=this.toNumber();return t&k1.pKIXCertificate&&e.push("pKIXCertificate"),t&k1.newExtensions&&e.push("newExtensions"),t&k1.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}},w4=class{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new y4,Object.assign(this,e)}};p([y({type:E.GeneralString})],w4.prototype,"entrustVers",void 0);p([y({type:y4})],w4.prototype,"entrustInfoFlags",void 0);var $b,dCe=`${Ja}.11`,aN=$b=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,$b.prototype)}};aN=$b=p([B({type:P.Sequence,itemType:Hs})],aN);var cN=it(Ms()),J=class r{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof r&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&cN.isEqual(e.parameters,this.parameters)||e.parameters===this.parameters)}};p([y({type:E.ObjectIdentifier})],J.prototype,"algorithm",void 0);p([y({type:E.Any,optional:!0})],J.prototype,"parameters",void 0);var Hr=class{constructor(e={}){this.algorithm=new J,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:J})],Hr.prototype,"algorithm",void 0);p([y({type:E.BitString})],Hr.prototype,"subjectPublicKey",void 0);var Gt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){let t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){let e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};p([y({type:E.UTCTime})],Gt.prototype,"utcTime",void 0);p([y({type:E.GeneralizedTime})],Gt.prototype,"generalTime",void 0);Gt=p([B({type:P.Choice})],Gt);var Ks=class{constructor(e){this.notBefore=new Gt(new Date),this.notAfter=new Gt(new Date),e&&(this.notBefore=new Gt(e.notBefore),this.notAfter=new Gt(e.notAfter))}};p([y({type:Gt})],Ks.prototype,"notBefore",void 0);p([y({type:Gt})],Ks.prototype,"notAfter",void 0);var Hb,Vr=class r{constructor(e={}){this.extnID="",this.critical=r.CRITICAL,this.extnValue=new Se,Object.assign(this,e)}};Vr.CRITICAL=!1;p([y({type:E.ObjectIdentifier})],Vr.prototype,"extnID",void 0);p([y({type:E.Boolean,defaultValue:Vr.CRITICAL})],Vr.prototype,"critical",void 0);p([y({type:Se})],Vr.prototype,"extnValue",void 0);var hi=Hb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Hb.prototype)}};hi=Hb=p([B({type:P.Sequence,itemType:Vr})],hi);var Jo;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(Jo||(Jo={}));var zr=class{constructor(e={}){this.version=Jo.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new J,this.issuer=new xt,this.validity=new Ks,this.subject=new xt,this.subjectPublicKeyInfo=new Hr,Object.assign(this,e)}};p([y({type:E.Integer,context:0,defaultValue:Jo.v1})],zr.prototype,"version",void 0);p([y({type:E.Integer,converter:Ke})],zr.prototype,"serialNumber",void 0);p([y({type:J})],zr.prototype,"signature",void 0);p([y({type:xt})],zr.prototype,"issuer",void 0);p([y({type:Ks})],zr.prototype,"validity",void 0);p([y({type:xt})],zr.prototype,"subject",void 0);p([y({type:Hr})],zr.prototype,"subjectPublicKeyInfo",void 0);p([y({type:E.BitString,context:1,implicit:!0,optional:!0})],zr.prototype,"issuerUniqueID",void 0);p([y({type:E.BitString,context:2,implicit:!0,optional:!0})],zr.prototype,"subjectUniqueID",void 0);p([y({type:hi,context:3,optional:!0})],zr.prototype,"extensions",void 0);var Fi=class{constructor(e={}){this.tbsCertificate=new zr,this.signatureAlgorithm=new J,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:zr})],Fi.prototype,"tbsCertificate",void 0);p([y({type:J})],Fi.prototype,"signatureAlgorithm",void 0);p([y({type:E.BitString})],Fi.prototype,"signatureValue",void 0);var Ql=class{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Gt,Object.assign(this,e)}};p([y({type:E.Integer,converter:Ke})],Ql.prototype,"userCertificate",void 0);p([y({type:Gt})],Ql.prototype,"revocationDate",void 0);p([y({type:Vr,optional:!0,repeated:"sequence"})],Ql.prototype,"crlEntryExtensions",void 0);var pi=class{constructor(e={}){this.signature=new J,this.issuer=new xt,this.thisUpdate=new Gt,Object.assign(this,e)}};p([y({type:E.Integer,optional:!0})],pi.prototype,"version",void 0);p([y({type:J})],pi.prototype,"signature",void 0);p([y({type:xt})],pi.prototype,"issuer",void 0);p([y({type:Gt})],pi.prototype,"thisUpdate",void 0);p([y({type:Gt,optional:!0})],pi.prototype,"nextUpdate",void 0);p([y({type:Ql,repeated:"sequence",optional:!0})],pi.prototype,"revokedCertificates",void 0);p([y({type:Vr,optional:!0,context:0,repeated:"sequence"})],pi.prototype,"crlExtensions",void 0);var Zl=class{constructor(e={}){this.tbsCertList=new pi,this.signatureAlgorithm=new J,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:pi})],Zl.prototype,"tbsCertList",void 0);p([y({type:J})],Zl.prototype,"signatureAlgorithm",void 0);p([y({type:E.BitString})],Zl.prototype,"signature",void 0);var ee=it(Ms());var Eo=class{constructor(e={}){this.issuer=new xt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:xt})],Eo.prototype,"issuer",void 0);p([y({type:E.Integer,converter:Ke})],Eo.prototype,"serialNumber",void 0);var Jl=class{constructor(e={}){Object.assign(this,e)}};p([y({type:$n,context:0,implicit:!0})],Jl.prototype,"subjectKeyIdentifier",void 0);p([y({type:Eo})],Jl.prototype,"issuerAndSerialNumber",void 0);Jl=p([B({type:P.Choice})],Jl);var Kr;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(Kr||(Kr={}));var eu=class extends J{};eu=p([B({type:P.Sequence})],eu);var P1=class extends J{};P1=p([B({type:P.Sequence})],P1);var Hn=class extends J{};Hn=p([B({type:P.Sequence})],Hn);var R1=class extends J{};R1=p([B({type:P.Sequence})],R1);var uN=class extends J{};uN=p([B({type:P.Sequence})],uN);var x4=class extends J{};x4=p([B({type:P.Sequence})],x4);var So=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],So.prototype,"attrType",void 0);p([y({type:E.Any,repeated:"set"})],So.prototype,"attrValues",void 0);var Vb,Vn=class{constructor(e={}){this.version=Kr.v0,this.sid=new Jl,this.digestAlgorithm=new eu,this.signatureAlgorithm=new P1,this.signature=new Se,Object.assign(this,e)}};p([y({type:E.Integer})],Vn.prototype,"version",void 0);p([y({type:Jl})],Vn.prototype,"sid",void 0);p([y({type:eu})],Vn.prototype,"digestAlgorithm",void 0);p([y({type:So,repeated:"set",context:0,implicit:!0,optional:!0})],Vn.prototype,"signedAttrs",void 0);p([y({type:P1})],Vn.prototype,"signatureAlgorithm",void 0);p([y({type:Se})],Vn.prototype,"signature",void 0);p([y({type:So,repeated:"set",context:1,implicit:!0,optional:!0})],Vn.prototype,"unsignedAttrs",void 0);var D1=Vb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Vb.prototype)}};D1=Vb=p([B({type:P.Set,itemType:Vn})],D1);var fN=class extends Gt{};fN=p([B({type:P.Choice})],fN);var dN=class extends Vn{};dN=p([B({type:P.Sequence})],dN);var N1=class{constructor(e={}){this.acIssuer=new _e,this.acSerial=0,this.attrs=[],Object.assign(this,e)}};p([y({type:_e})],N1.prototype,"acIssuer",void 0);p([y({type:E.Integer})],N1.prototype,"acSerial",void 0);p([y({type:$r,repeated:"sequence"})],N1.prototype,"attrs",void 0);var zb,O1=zb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,zb.prototype)}};O1=zb=p([B({type:P.Sequence,itemType:E.ObjectIdentifier})],O1);var yd=class{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}};p([y({type:E.Integer,optional:!0})],yd.prototype,"pathLenConstraint",void 0);p([y({type:O1,implicit:!0,context:0,optional:!0})],yd.prototype,"permittedAttrs",void 0);p([y({type:O1,implicit:!0,context:1,optional:!0})],yd.prototype,"excludedAttrs",void 0);p([y({type:E.Boolean,defaultValue:!0})],yd.prototype,"permitUnSpecified",void 0);var $i=class{constructor(e={}){this.issuer=new Bt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:Bt})],$i.prototype,"issuer",void 0);p([y({type:E.Integer,converter:Ke})],$i.prototype,"serial",void 0);p([y({type:E.BitString,optional:!0})],$i.prototype,"issuerUID",void 0);var Kb;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(Kb||(Kb={}));var Hi=class{constructor(e={}){this.digestedObjectType=Kb.publicKey,this.digestAlgorithm=new J,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.Enumerated})],Hi.prototype,"digestedObjectType",void 0);p([y({type:E.ObjectIdentifier,optional:!0})],Hi.prototype,"otherObjectTypeID",void 0);p([y({type:J})],Hi.prototype,"digestAlgorithm",void 0);p([y({type:E.BitString})],Hi.prototype,"objectDigest",void 0);var tu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Bt,optional:!0})],tu.prototype,"issuerName",void 0);p([y({type:$i,context:0,implicit:!0,optional:!0})],tu.prototype,"baseCertificateID",void 0);p([y({type:Hi,context:1,implicit:!0,optional:!0})],tu.prototype,"objectDigestInfo",void 0);var ru=class{constructor(e={}){Object.assign(this,e)}};p([y({type:_e,repeated:"sequence"})],ru.prototype,"v1Form",void 0);p([y({type:tu,context:0,implicit:!0})],ru.prototype,"v2Form",void 0);ru=p([B({type:P.Choice})],ru);var nu=class{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}};p([y({type:E.GeneralizedTime})],nu.prototype,"notBeforeTime",void 0);p([y({type:E.GeneralizedTime})],nu.prototype,"notAfterTime",void 0);var tc=class{constructor(e={}){Object.assign(this,e)}};p([y({type:$i,implicit:!0,context:0,optional:!0})],tc.prototype,"baseCertificateID",void 0);p([y({type:Bt,implicit:!0,context:1,optional:!0})],tc.prototype,"entityName",void 0);p([y({type:Hi,implicit:!0,context:2,optional:!0})],tc.prototype,"objectDigestInfo",void 0);var qb;(function(r){r[r.v2=1]="v2"})(qb||(qb={}));var zn=class{constructor(e={}){this.version=qb.v2,this.holder=new tc,this.issuer=new ru,this.signature=new J,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new nu,this.attributes=[],Object.assign(this,e)}};p([y({type:E.Integer})],zn.prototype,"version",void 0);p([y({type:tc})],zn.prototype,"holder",void 0);p([y({type:ru})],zn.prototype,"issuer",void 0);p([y({type:J})],zn.prototype,"signature",void 0);p([y({type:E.Integer,converter:Ke})],zn.prototype,"serialNumber",void 0);p([y({type:nu})],zn.prototype,"attrCertValidityPeriod",void 0);p([y({type:$r,repeated:"sequence"})],zn.prototype,"attributes",void 0);p([y({type:E.BitString,optional:!0})],zn.prototype,"issuerUniqueID",void 0);p([y({type:hi,optional:!0})],zn.prototype,"extensions",void 0);var iu=class{constructor(e={}){this.acinfo=new zn,this.signatureAlgorithm=new J,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:zn})],iu.prototype,"acinfo",void 0);p([y({type:J})],iu.prototype,"signatureAlgorithm",void 0);p([y({type:E.BitString})],iu.prototype,"signatureValue",void 0);var L1;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(L1||(L1={}));var wd=class extends Yo{};var xd=class{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier,implicit:!0,context:0})],xd.prototype,"type",void 0);p([y({type:E.Any,implicit:!0,context:1})],xd.prototype,"value",void 0);var B1=class{constructor(e={}){this.policyId="",this.classList=new wd(L1.unclassified),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],B1.prototype,"policyId",void 0);p([y({type:wd,defaultValue:new wd(L1.unclassified)})],B1.prototype,"classList",void 0);p([y({type:xd,repeated:"set"})],B1.prototype,"securityCategories",void 0);var bd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se})],bd.prototype,"cotets",void 0);p([y({type:E.ObjectIdentifier})],bd.prototype,"oid",void 0);p([y({type:E.Utf8String})],bd.prototype,"string",void 0);var b4=class{constructor(e={}){this.values=[],Object.assign(this,e)}};p([y({type:Bt,implicit:!0,context:0,optional:!0})],b4.prototype,"policyAuthority",void 0);p([y({type:bd,repeated:"sequence"})],b4.prototype,"values",void 0);var jRe=`${Ja}.4`,WRe=`${Ja}.6`,GRe=`${Ja}.10`,XRe=`${Re}.55`,M1=`${Za}.10`,YRe=`${M1}.1`,QRe=`${M1}.2`,ZRe=`${M1}.3`,JRe=`${M1}.4`,eDe=`${M1}.6`,jb="2.5.4",tDe=`${jb}.72`;var Wb,vd=class{constructor(e={}){this.targetCertificate=new $i,Object.assign(this,e)}};p([y({type:$i})],vd.prototype,"targetCertificate",void 0);p([y({type:_e,optional:!0})],vd.prototype,"targetName",void 0);p([y({type:Hi,optional:!0})],vd.prototype,"certDigestInfo",void 0);var Ed=class{constructor(e={}){Object.assign(this,e)}};p([y({type:_e,context:0,implicit:!0})],Ed.prototype,"targetName",void 0);p([y({type:_e,context:1,implicit:!0})],Ed.prototype,"targetGroup",void 0);p([y({type:vd,context:2,implicit:!0})],Ed.prototype,"targetCert",void 0);Ed=p([B({type:P.Choice})],Ed);var v4=Wb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Wb.prototype)}};v4=Wb=p([B({type:P.Sequence,itemType:Ed})],v4);var Gb,hN=Gb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Gb.prototype)}};hN=Gb=p([B({type:P.Sequence,itemType:v4})],hN);var E4=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Bt,implicit:!0,context:0,optional:!0})],E4.prototype,"roleAuthority",void 0);p([y({type:_e,implicit:!0,context:1})],E4.prototype,"roleName",void 0);var U1=class{constructor(e={}){this.service=new _e,this.ident=new _e,Object.assign(this,e)}};p([y({type:_e})],U1.prototype,"service",void 0);p([y({type:_e})],U1.prototype,"ident",void 0);p([y({type:Se,optional:!0})],U1.prototype,"authInfo",void 0);var Xb,F1=class{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],F1.prototype,"otherCertFormat",void 0);p([y({type:E.Any})],F1.prototype,"otherCert",void 0);var ou=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Fi})],ou.prototype,"certificate",void 0);p([y({type:iu,context:2,implicit:!0})],ou.prototype,"v2AttrCert",void 0);p([y({type:F1,context:3,implicit:!0})],ou.prototype,"other",void 0);ou=p([B({type:P.Choice})],ou);var su=Xb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Xb.prototype)}};su=Xb=p([B({type:P.Set,itemType:ou})],su);var Vi=class{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Vi.prototype,"contentType",void 0);p([y({type:E.Any,context:0})],Vi.prototype,"content",void 0);var Sd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se})],Sd.prototype,"single",void 0);p([y({type:E.Any})],Sd.prototype,"any",void 0);Sd=p([B({type:P.Choice})],Sd);var au=class{constructor(e={}){this.eContentType="",Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],au.prototype,"eContentType",void 0);p([y({type:Sd,context:0,optional:!0})],au.prototype,"eContent",void 0);var $1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se,context:0,implicit:!0,optional:!0})],$1.prototype,"value",void 0);p([y({type:Se,converter:VD,context:0,implicit:!0,optional:!0,repeated:"sequence"})],$1.prototype,"constructedValue",void 0);$1=p([B({type:P.Choice})],$1);var rc=class{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new R1,Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],rc.prototype,"contentType",void 0);p([y({type:R1})],rc.prototype,"contentEncryptionAlgorithm",void 0);p([y({type:$1,optional:!0})],rc.prototype,"encryptedContent",void 0);var nc=class{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],nc.prototype,"keyAttrId",void 0);p([y({type:E.Any,optional:!0})],nc.prototype,"keyAttr",void 0);var Yb,Ad=class{constructor(e={}){this.subjectKeyIdentifier=new $n,Object.assign(this,e)}};p([y({type:$n})],Ad.prototype,"subjectKeyIdentifier",void 0);p([y({type:E.GeneralizedTime,optional:!0})],Ad.prototype,"date",void 0);p([y({type:nc,optional:!0})],Ad.prototype,"other",void 0);var _d=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Ad,context:0,implicit:!0,optional:!0})],_d.prototype,"rKeyId",void 0);p([y({type:Eo,optional:!0})],_d.prototype,"issuerAndSerialNumber",void 0);_d=p([B({type:P.Choice})],_d);var H1=class{constructor(e={}){this.rid=new _d,this.encryptedKey=new Se,Object.assign(this,e)}};p([y({type:_d})],H1.prototype,"rid",void 0);p([y({type:Se})],H1.prototype,"encryptedKey",void 0);var S4=Yb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Yb.prototype)}};S4=Yb=p([B({type:P.Sequence,itemType:H1})],S4);var V1=class{constructor(e={}){this.algorithm=new J,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:J})],V1.prototype,"algorithm",void 0);p([y({type:E.BitString})],V1.prototype,"publicKey",void 0);var cu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:$n,context:0,implicit:!0,optional:!0})],cu.prototype,"subjectKeyIdentifier",void 0);p([y({type:V1,context:1,implicit:!0,optional:!0})],cu.prototype,"originatorKey",void 0);p([y({type:Eo,optional:!0})],cu.prototype,"issuerAndSerialNumber",void 0);cu=p([B({type:P.Choice})],cu);var qs=class{constructor(e={}){this.version=Kr.v3,this.originator=new cu,this.keyEncryptionAlgorithm=new Hn,this.recipientEncryptedKeys=new S4,Object.assign(this,e)}};p([y({type:E.Integer})],qs.prototype,"version",void 0);p([y({type:cu,context:0})],qs.prototype,"originator",void 0);p([y({type:Se,context:1,optional:!0})],qs.prototype,"ukm",void 0);p([y({type:Hn})],qs.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:S4})],qs.prototype,"recipientEncryptedKeys",void 0);var Id=class{constructor(e={}){Object.assign(this,e)}};p([y({type:$n,context:0,implicit:!0})],Id.prototype,"subjectKeyIdentifier",void 0);p([y({type:Eo})],Id.prototype,"issuerAndSerialNumber",void 0);Id=p([B({type:P.Choice})],Id);var ic=class{constructor(e={}){this.version=Kr.v0,this.rid=new Id,this.keyEncryptionAlgorithm=new Hn,this.encryptedKey=new Se,Object.assign(this,e)}};p([y({type:E.Integer})],ic.prototype,"version",void 0);p([y({type:Id})],ic.prototype,"rid",void 0);p([y({type:Hn})],ic.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Se})],ic.prototype,"encryptedKey",void 0);var lu=class{constructor(e={}){this.keyIdentifier=new Se,Object.assign(this,e)}};p([y({type:Se})],lu.prototype,"keyIdentifier",void 0);p([y({type:E.GeneralizedTime,optional:!0})],lu.prototype,"date",void 0);p([y({type:nc,optional:!0})],lu.prototype,"other",void 0);var oc=class{constructor(e={}){this.version=Kr.v4,this.kekid=new lu,this.keyEncryptionAlgorithm=new Hn,this.encryptedKey=new Se,Object.assign(this,e)}};p([y({type:E.Integer})],oc.prototype,"version",void 0);p([y({type:lu})],oc.prototype,"kekid",void 0);p([y({type:Hn})],oc.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Se})],oc.prototype,"encryptedKey",void 0);var sc=class{constructor(e={}){this.version=Kr.v0,this.keyEncryptionAlgorithm=new Hn,this.encryptedKey=new Se,Object.assign(this,e)}};p([y({type:E.Integer})],sc.prototype,"version",void 0);p([y({type:x4,context:0,optional:!0})],sc.prototype,"keyDerivationAlgorithm",void 0);p([y({type:Hn})],sc.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Se})],sc.prototype,"encryptedKey",void 0);var z1=class{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],z1.prototype,"oriType",void 0);p([y({type:E.Any})],z1.prototype,"oriValue",void 0);var js=class{constructor(e={}){Object.assign(this,e)}};p([y({type:ic,optional:!0})],js.prototype,"ktri",void 0);p([y({type:qs,context:1,implicit:!0,optional:!0})],js.prototype,"kari",void 0);p([y({type:oc,context:2,implicit:!0,optional:!0})],js.prototype,"kekri",void 0);p([y({type:sc,context:3,implicit:!0,optional:!0})],js.prototype,"pwri",void 0);p([y({type:z1,context:4,implicit:!0,optional:!0})],js.prototype,"ori",void 0);js=p([B({type:P.Choice})],js);var Qb,K1=Qb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Qb.prototype)}};K1=Qb=p([B({type:P.Set,itemType:js})],K1);var Zb,pN=`${Za}.16`,eOe=`${pN}.2`,tOe=`${pN}.4`,Td=class{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Td.prototype,"otherRevInfoFormat",void 0);p([y({type:E.Any})],Td.prototype,"otherRevInfo",void 0);var A4=class{constructor(e={}){this.other=new Td,Object.assign(this,e)}};p([y({type:Td,context:1,implicit:!0})],A4.prototype,"other",void 0);A4=p([B({type:P.Choice})],A4);var Cd=Zb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Zb.prototype)}};Cd=Zb=p([B({type:P.Set,itemType:A4})],Cd);var kd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:su,context:0,implicit:!0,optional:!0})],kd.prototype,"certs",void 0);p([y({type:Cd,context:1,implicit:!0,optional:!0})],kd.prototype,"crls",void 0);var Jb,ev=Jb=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Jb.prototype)}};ev=Jb=p([B({type:P.Set,itemType:So})],ev);var uu=class{constructor(e={}){this.version=Kr.v0,this.recipientInfos=new K1,this.encryptedContentInfo=new rc,Object.assign(this,e)}};p([y({type:E.Integer})],uu.prototype,"version",void 0);p([y({type:kd,context:0,implicit:!0,optional:!0})],uu.prototype,"originatorInfo",void 0);p([y({type:K1})],uu.prototype,"recipientInfos",void 0);p([y({type:rc})],uu.prototype,"encryptedContentInfo",void 0);p([y({type:ev,context:1,implicit:!0,optional:!0})],uu.prototype,"unprotectedAttrs",void 0);var mN="1.2.840.113549.1.7.2";var tv,_4=tv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,tv.prototype)}};_4=tv=p([B({type:P.Set,itemType:eu})],_4);var Ws=class{constructor(e={}){this.version=Kr.v0,this.digestAlgorithms=new _4,this.encapContentInfo=new au,this.signerInfos=new D1,Object.assign(this,e)}};p([y({type:E.Integer})],Ws.prototype,"version",void 0);p([y({type:_4})],Ws.prototype,"digestAlgorithms",void 0);p([y({type:au})],Ws.prototype,"encapContentInfo",void 0);p([y({type:su,context:0,implicit:!0,optional:!0})],Ws.prototype,"certificates",void 0);p([y({type:Cd,context:1,implicit:!0,optional:!0})],Ws.prototype,"crls",void 0);p([y({type:D1})],Ws.prototype,"signerInfos",void 0);var fu="1.2.840.10045.2.1";var q1="1.2.840.10045.4.1",I4="1.2.840.10045.4.3.1",j1="1.2.840.10045.4.3.2",W1="1.2.840.10045.4.3.3",G1="1.2.840.10045.4.3.4";var rv="1.2.840.10045.3.1.7";var nv="1.3.132.0.34";var iv="1.3.132.0.35";function X1(r){return new J({algorithm:r})}var yN=X1(q1),QOe=X1(I4),wN=X1(j1),xN=X1(W1),bN=X1(G1);var Y1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Y1.prototype,"fieldType",void 0);p([y({type:E.Any})],Y1.prototype,"parameters",void 0);Y1=p([B({type:P.Sequence})],Y1);var ov=class extends Se{};var Pd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.OctetString})],Pd.prototype,"a",void 0);p([y({type:E.OctetString})],Pd.prototype,"b",void 0);p([y({type:E.BitString,optional:!0})],Pd.prototype,"seed",void 0);Pd=p([B({type:P.Sequence})],Pd);var sv;(function(r){r[r.ecpVer1=1]="ecpVer1"})(sv||(sv={}));var es=class{constructor(e={}){this.version=sv.ecpVer1,Object.assign(this,e)}};p([y({type:E.Integer})],es.prototype,"version",void 0);p([y({type:Y1})],es.prototype,"fieldID",void 0);p([y({type:Pd})],es.prototype,"curve",void 0);p([y({type:ov})],es.prototype,"base",void 0);p([y({type:E.Integer,converter:Ke})],es.prototype,"order",void 0);p([y({type:E.Integer,optional:!0})],es.prototype,"cofactor",void 0);es=p([B({type:P.Sequence})],es);var ts=class{constructor(e={}){Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],ts.prototype,"namedCurve",void 0);p([y({type:E.Null})],ts.prototype,"implicitCurve",void 0);p([y({type:es})],ts.prototype,"specifiedCurve",void 0);ts=p([B({type:P.Choice})],ts);var Rd=class{constructor(e={}){this.version=1,this.privateKey=new Se,Object.assign(this,e)}};p([y({type:E.Integer})],Rd.prototype,"version",void 0);p([y({type:Se})],Rd.prototype,"privateKey",void 0);p([y({type:ts,context:0,optional:!0})],Rd.prototype,"parameters",void 0);p([y({type:E.BitString,context:1,optional:!0})],Rd.prototype,"publicKey",void 0);var du=class{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.Integer,converter:Ke})],du.prototype,"r",void 0);p([y({type:E.Integer,converter:Ke})],du.prototype,"s",void 0);var Kn="1.2.840.113549.1.1",rs=`${Kn}.1`,vN=`${Kn}.7`,EN=`${Kn}.9`,ac=`${Kn}.10`,SN=`${Kn}.2`,AN=`${Kn}.4`,Dd=`${Kn}.5`,_N=`${Kn}.14`;var T4=`${Kn}.11`,Nd=`${Kn}.12`,Od=`${Kn}.13`,av=`${Kn}.15`,cv=`${Kn}.16`,hu="1.3.14.3.2.26",C4="2.16.840.1.101.3.4.2.4",pu="2.16.840.1.101.3.4.2.1",mu="2.16.840.1.101.3.4.2.2",gu="2.16.840.1.101.3.4.2.3",IN="2.16.840.1.101.3.4.2.5",TN="2.16.840.1.101.3.4.2.6",CN="1.2.840.113549.2.2",kN="1.2.840.113549.2.5",cc=`${Kn}.8`;function xr(r){return new J({algorithm:r,parameters:null})}var _Le=xr(CN),ILe=xr(kN),Gs=xr(hu),TLe=xr(C4),CLe=xr(pu),kLe=xr(mu),PLe=xr(gu),RLe=xr(IN),DLe=xr(TN),k4=new J({algorithm:cc,parameters:re.serialize(Gs)}),lv=new J({algorithm:EN,parameters:re.serialize(dd.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))}),NLe=xr(rs),OLe=xr(SN),LLe=xr(AN),BLe=xr(Dd),MLe=xr(av),ULe=xr(cv),FLe=xr(Nd),$Le=xr(Od),HLe=xr(av),VLe=xr(cv);var Ld=class{constructor(e={}){this.hashAlgorithm=new J(Gs),this.maskGenAlgorithm=new J({algorithm:cc,parameters:re.serialize(Gs)}),this.pSourceAlgorithm=new J(lv),Object.assign(this,e)}};p([y({type:J,context:0,defaultValue:Gs})],Ld.prototype,"hashAlgorithm",void 0);p([y({type:J,context:1,defaultValue:k4})],Ld.prototype,"maskGenAlgorithm",void 0);p([y({type:J,context:2,defaultValue:lv})],Ld.prototype,"pSourceAlgorithm",void 0);var XLe=new J({algorithm:vN,parameters:re.serialize(new Ld)});var ns=class{constructor(e={}){this.hashAlgorithm=new J(Gs),this.maskGenAlgorithm=new J({algorithm:cc,parameters:re.serialize(Gs)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}};p([y({type:J,context:0,defaultValue:Gs})],ns.prototype,"hashAlgorithm",void 0);p([y({type:J,context:1,defaultValue:k4})],ns.prototype,"maskGenAlgorithm",void 0);p([y({type:E.Integer,context:2,defaultValue:20})],ns.prototype,"saltLength",void 0);p([y({type:E.Integer,context:3,defaultValue:1})],ns.prototype,"trailerField",void 0);var rBe=new J({algorithm:ac,parameters:re.serialize(new ns)});var yu=class{constructor(e={}){this.digestAlgorithm=new J,this.digest=new Se,Object.assign(this,e)}};p([y({type:J})],yu.prototype,"digestAlgorithm",void 0);p([y({type:Se})],yu.prototype,"digest",void 0);var uv,Bd=class{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.Integer,converter:Ke})],Bd.prototype,"prime",void 0);p([y({type:E.Integer,converter:Ke})],Bd.prototype,"exponent",void 0);p([y({type:E.Integer,converter:Ke})],Bd.prototype,"coefficient",void 0);var P4=uv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,uv.prototype)}};P4=uv=p([B({type:P.Sequence,itemType:Bd})],P4);var zi=class{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.Integer})],zi.prototype,"version",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"modulus",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"publicExponent",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"privateExponent",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"prime1",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"prime2",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"exponent1",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"exponent2",void 0);p([y({type:E.Integer,converter:Ke})],zi.prototype,"coefficient",void 0);p([y({type:P4,optional:!0})],zi.prototype,"otherPrimeInfos",void 0);var Md=class{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.Integer,converter:Ke})],Md.prototype,"modulus",void 0);p([y({type:E.Integer,converter:Ke})],Md.prototype,"publicExponent",void 0);var fv;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(fv||(fv={}));var qr=fv;var QN=it(YN(),1),{__extends:Fd,__assign:NBe,__rest:UX,__decorate:OBe,__param:LBe,__metadata:BBe,__awaiter:ZN,__generator:JN,__exportStar:MBe,__createBinding:UBe,__values:Q1,__read:Z1,__spread:Ao,__spreadArrays:FBe,__await:$Be,__asyncGenerator:HBe,__asyncDelegator:VBe,__asyncValues:zBe,__makeTemplateObject:KBe,__importStar:qBe,__importDefault:jBe,__classPrivateFieldGet:WBe,__classPrivateFieldSet:GBe}=QN.default;var FX="injectionTokens";function hv(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(FX,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function J1(r){return!!r.useClass}function $d(r){return!!r.useFactory}var N4=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},i=!1,o,s=function(){return i||(o=e(t.wrap()),i=!0),o};return new Proxy(n,this.createHandler(s))},r.prototype.createHandler=function(e){var t={},n=function(i){t[i]=function(){for(var o=[],s=0;s<arguments.length;s++)o[s]=arguments[s];o[0]=e();var a=Reflect[i];return a.apply(void 0,Ao(o))}};return this.reflectMethods.forEach(n),t},r}();function lc(r){return typeof r=="string"||typeof r=="symbol"}function pv(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function O4(r){return typeof r=="object"&&"token"in r&&"transform"in r}function eO(r){return typeof r=="function"||r instanceof N4}function wu(r){return!!r.useToken}function xu(r){return r.useValue!=null}function tO(r){return J1(r)||xu(r)||wu(r)||$d(r)}var $X=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),em=$X;var HX=function(r){Fd(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(em),rO=HX;var VX=function(){function r(){this.scopedResolutions=new Map}return r}(),tm=VX;function zX(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function KX(r,e,t){return t===void 0&&(t="    "),Ao([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function mv(r,e,t){var n=Z1(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=n[1],o=i===void 0?null:i,s=zX(o,e);return KX("Cannot inject the dependency "+s+' of "'+r.name+'" constructor. Reason:',t)}function nO(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var qX=function(r){Fd(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(em);var jX=function(r){Fd(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(em);var WX=function(){function r(){this.preResolution=new qX,this.postResolution=new jX}return r}(),iO=WX;var gv=new Map,GX=function(){function r(e){this.parent=e,this._registry=new rO,this.interceptors=new iO,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:qr.Transient}),this.ensureNotDisposed();var i;if(tO(t)?i=t:i={useClass:t},wu(i))for(var o=[e],s=i;s!=null;){var a=s.useToken;if(o.includes(a))throw new Error("Token registration cycle detected! "+Ao(o,[a]).join(" -> "));o.push(a);var c=this._registry.get(a);c&&wu(c.provider)?s=c.provider:s=null}if((n.lifecycle===qr.Singleton||n.lifecycle==qr.ContainerScoped||n.lifecycle==qr.ResolutionScoped)&&(xu(i)||$d(i)))throw new Error('Cannot use lifecycle "'+qr[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),lc(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),lc(e)){if(lc(t))return this.register(e,{useToken:t},{lifecycle:qr.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:qr.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!lc(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:qr.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new tm),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&lc(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var o=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,o,"Single"),o}if(eO(e)){var o=this.construct(e,t);return this.executePostResolutionInterceptor(e,o,"Single"),o}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,i;if(this.interceptors.preResolution.has(e)){var o=[];try{for(var s=Q1(this.interceptors.preResolution.getAll(e)),a=s.next();!a.done;a=s.next()){var c=a.value;c.options.frequency!="Once"&&o.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,o)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var i,o;if(this.interceptors.postResolution.has(e)){var s=[];try{for(var a=Q1(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&s.push(l),l.callback(e,t,n)}}catch(u){i={error:u}}finally{try{c&&!c.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,s)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===qr.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===qr.Singleton,i=e.options.lifecycle===qr.ContainerScoped,o=n||i,s;return xu(e.provider)?s=e.provider.useValue:wu(e.provider)?s=o?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):J1(e.provider)?s=o?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):$d(e.provider)?s=e.provider.useFactory(this):s=this.construct(e.provider,t),e.options.lifecycle===qr.ResolutionScoped&&t.scopedResolutions.set(e,s),s},r.prototype.resolveAll=function(e,t,n){var i=this;t===void 0&&(t=new tm),n===void 0&&(n=!1),this.ensureNotDisposed();var o=this.getAllRegistrations(e);if(!o&&lc(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),o){var s=o.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,s,"All"),s}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=Q1(this._registry.entries()),i=n.next();!i.done;i=n.next()){var o=Z1(i.value,2),s=o[0],a=o[1];this._registry.setAll(s,a.filter(function(c){return!xu(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var i=Q1(this._registry.entries()),o=i.next();!o.done;o=i.next()){var s=Z1(o.value,2),a=s[0],c=s[1];c.some(function(l){var u=l.options;return u.lifecycle===qr.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===qr.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return ZN(this,void 0,void 0,function(){var e;return JN(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var i=n.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof N4)return e.createProxy(function(o){return n.resolve(o,t)});var i=function(){var o=gv.get(e);if(!o||o.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var s=o.map(n.resolveParams(t,e));return new(e.bind.apply(e,Ao([void 0],s)))}();return nO(i)&&this.disposables.add(i),i},r.prototype.resolveParams=function(e,t){var n=this;return function(i,o){var s,a,c;try{return pv(i)?O4(i)?i.multiple?(s=n.resolve(i.transform)).transform.apply(s,Ao([n.resolveAll(i.token,new tm,i.isOptional)],i.transformArgs)):(a=n.resolve(i.transform)).transform.apply(a,Ao([n.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?n.resolveAll(i.token,new tm,i.isOptional):n.resolve(i.token,e,i.isOptional):O4(i)?(c=n.resolve(i.transform,e)).transform.apply(c,Ao([n.resolve(i.token,e)],i.transformArgs)):n.resolve(i,e)}catch(l){throw new Error(mv(t,o,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),It=new GX;function XX(r){return function(e){gv.set(e,hv(e)),r&&r.token&&(Array.isArray(r.token)?r.token.forEach(function(t){It.register(t,e)}):It.register(r.token,e))}}var uc=XX;if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var wv,bu=class{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}};p([y({type:E.ObjectIdentifier})],bu.prototype,"attrId",void 0);p([y({type:E.Any,repeated:"set"})],bu.prototype,"attrValues",void 0);var oO=wv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,wv.prototype)}};oO=wv=p([B({type:P.Sequence,itemType:bu})],oO);var xv,sO=xv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,xv.prototype)}};sO=xv=p([B({type:P.Sequence,itemType:Vi})],sO);var YX="1.2.840.113549",QX=`${YX}.1`,aO=`${QX}.12`,Hd=`${aO}.1`,oFe=`${Hd}.1`,sFe=`${Hd}.2`,aFe=`${Hd}.3`,cFe=`${Hd}.4`,lFe=`${Hd}.5`,uFe=`${Hd}.6`,vu=`${aO}.10.1`;var hFe=`${vu}.1`,pFe=`${vu}.2`,mFe=`${vu}.3`,gFe=`${vu}.4`,yFe=`${vu}.5`,wFe=`${vu}.6`,L4="1.2.840.113549.1.9";var B4=class{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],B4.prototype,"certId",void 0);p([y({type:E.Any,context:0})],B4.prototype,"certValue",void 0);var cO=`${L4}.22`,SFe=`${cO}.1`,AFe=`${cO}.2`;var M4=class{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],M4.prototype,"crlId",void 0);p([y({type:E.Any,context:0})],M4.prototype,"crltValue",void 0);var ZX=`${L4}.23`,kFe=`${ZX}.1`;var U4=class extends Se{},fc=class{constructor(e={}){this.encryptionAlgorithm=new J,this.encryptedData=new U4,Object.assign(this,e)}};p([y({type:J})],fc.prototype,"encryptionAlgorithm",void 0);p([y({type:U4})],fc.prototype,"encryptedData",void 0);var bv,vv;(function(r){r[r.v1=0]="v1"})(vv||(vv={}));var F4=class extends Se{},Ev=bv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,bv.prototype)}};Ev=bv=p([B({type:P.Sequence,itemType:$r})],Ev);var dc=class{constructor(e={}){this.version=vv.v1,this.privateKeyAlgorithm=new J,this.privateKey=new F4,Object.assign(this,e)}};p([y({type:E.Integer})],dc.prototype,"version",void 0);p([y({type:J})],dc.prototype,"privateKeyAlgorithm",void 0);p([y({type:F4})],dc.prototype,"privateKey",void 0);p([y({type:Ev,implicit:!0,context:0,optional:!0})],dc.prototype,"attributes",void 0);var lO=class extends dc{};lO=p([B({type:P.Sequence})],lO);var uO=class extends fc{};uO=p([B({type:P.Sequence})],uO);var $4=class{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],$4.prototype,"secretTypeId",void 0);p([y({type:E.Any,context:0})],$4.prototype,"secretValue",void 0);var hc=class{constructor(e={}){this.mac=new yu,this.macSalt=new Se,this.iterations=1,Object.assign(this,e)}};p([y({type:yu})],hc.prototype,"mac",void 0);p([y({type:Se})],hc.prototype,"macSalt",void 0);p([y({type:E.Integer,defaultValue:1})],hc.prototype,"iterations",void 0);var Eu=class{constructor(e={}){this.version=3,this.authSafe=new Vi,this.macData=new hc,Object.assign(this,e)}};p([y({type:E.Integer})],Eu.prototype,"version",void 0);p([y({type:Vi})],Eu.prototype,"authSafe",void 0);p([y({type:hc,optional:!0})],Eu.prototype,"macData",void 0);var Sv,Vd=class{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:E.ObjectIdentifier})],Vd.prototype,"bagId",void 0);p([y({type:E.Any,context:0})],Vd.prototype,"bagValue",void 0);p([y({type:bu,repeated:"set",optional:!0})],Vd.prototype,"bagAttributes",void 0);var fO=Sv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Sv.prototype)}};fO=Sv=p([B({type:P.Sequence,itemType:Vd})],fO);var Av,_v,Iv,Xt="1.2.840.113549.1.9",R$e=`${Xt}.0`,_O=`${Xt}.24`,nm=`${Xt}.25`,IO=`${Xt}.26`,TO=`${Xt}.27`,D$e=`${_O}.1`,N$e=`${_O}.2`,O$e=`${Xt}.1`,L$e=`${Xt}.2`,B$e=`${Xt}.3`,M$e=`${Xt}.4`,U$e=`${Xt}.5`,F$e=`${Xt}.6`,Ov=`${Xt}.7`,$$e=`${Xt}.8`,H$e=`${Xt}.9`,V$e=`${Xt}.13`,im=`${Xt}.14`,z$e=`${Xt}.15`,K$e=`${Xt}.20`,q$e=`${Xt}.21`;var j$e=`${nm}.1`,W$e=`${nm}.2`,G$e=`${nm}.3`,X$e=`${nm}.4`,Y$e=`${nm}.5`,om="1.3.6.1.5.5.7.9",Q$e=`${om}.1`,Z$e=`${om}.2`,J$e=`${om}.3`,eHe=`${om}.4`,tHe=`${om}.5`,rHe=`${IO}.1`,nHe=`${IO}.2`,iHe=`${TO}.1`,oHe=`${TO}.2`,sHe=`${Xt}.16`,aHe=`${Xt}.22`,cHe=`${Xt}.23`,lHe=`${jb}.65`,H4=class extends hr{constructor(e={}){super(e)}toString(){return{}.toString(),this.ia5String||super.toString()}};p([y({type:E.IA5String})],H4.prototype,"ia5String",void 0);H4=p([B({type:P.Choice})],H4);var dO=class extends Vi{};dO=p([B({type:P.Sequence})],dO);var hO=class extends Eu{};hO=p([B({type:P.Sequence})],hO);var pO=class extends fc{};pO=p([B({type:P.Sequence})],pO);var Tv=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:E.IA5String})],Tv.prototype,"value",void 0);Tv=p([B({type:P.Choice})],Tv);var mO=class extends H4{};mO=p([B({type:P.Choice})],mO);var gO=class extends hr{};gO=p([B({type:P.Choice})],gO);var Cv=class{constructor(e=new Date){this.value=e}};p([y({type:E.GeneralizedTime})],Cv.prototype,"value",void 0);Cv=p([B({type:P.Choice})],Cv);var yO=class extends hr{};yO=p([B({type:P.Choice})],yO);var kv=class{constructor(e="M"){this.value=e}toString(){return this.value}};p([y({type:E.PrintableString})],kv.prototype,"value",void 0);kv=p([B({type:P.Choice})],kv);var V4=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:E.PrintableString})],V4.prototype,"value",void 0);V4=p([B({type:P.Choice})],V4);var wO=class extends V4{};wO=p([B({type:P.Choice})],wO);var xO=class extends hr{};xO=p([B({type:P.Choice})],xO);var Pv=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:E.ObjectIdentifier})],Pv.prototype,"value",void 0);Pv=p([B({type:P.Choice})],Pv);var bO=class extends Gt{};bO=p([B({type:P.Choice})],bO);var Rv=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};p([y({type:E.Integer})],Rv.prototype,"value",void 0);Rv=p([B({type:P.Choice})],Rv);var vO=class extends Vn{};vO=p([B({type:P.Sequence})],vO);var rm=class extends hr{};rm=p([B({type:P.Choice})],rm);var EO=Av=class extends hi{constructor(e){super(e),Object.setPrototypeOf(this,Av.prototype)}};EO=Av=p([B({type:P.Sequence})],EO);var SO=_v=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,_v.prototype)}};SO=_v=p([B({type:P.Set,itemType:So})],SO);var Dv=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:E.BmpString})],Dv.prototype,"value",void 0);Dv=p([B({type:P.Choice})],Dv);var Nv=class extends J{};Nv=p([B({type:P.Sequence})],Nv);var AO=Iv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Iv.prototype)}};AO=Iv=p([B({type:P.Sequence,itemType:Nv})],AO);var Lv,sm=Lv=class extends xe{constructor(e){super(e),Object.setPrototypeOf(this,Lv.prototype)}};sm=Lv=p([B({type:P.Sequence,itemType:$r})],sm);var is=class{constructor(e={}){this.version=0,this.subject=new xt,this.subjectPKInfo=new Hr,this.attributes=new sm,Object.assign(this,e)}};p([y({type:E.Integer})],is.prototype,"version",void 0);p([y({type:xt})],is.prototype,"subject",void 0);p([y({type:Hr})],is.prototype,"subjectPKInfo",void 0);p([y({type:sm,implicit:!0,context:0})],is.prototype,"attributes",void 0);var pc=class{constructor(e={}){this.certificationRequestInfo=new is,this.signatureAlgorithm=new J,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:is})],pc.prototype,"certificationRequestInfo",void 0);p([y({type:J})],pc.prototype,"signatureAlgorithm",void 0);p([y({type:E.BitString})],pc.prototype,"signature",void 0);var dm="crypto.algorithm",qv=class{getAlgorithms(){return It.resolveAll(dm)}toAsnAlgorithm(e){({...e});for(let t of this.getAlgorithms()){let n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){let t=new J({algorithm:e.name});if("parameters"in e){let n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(let n of this.getAlgorithms()){let i=n.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}},Su="crypto.algorithmProvider";It.registerSingleton(Su,qv);var j4,Wn="1.3.36.3.3.2.8.1.1",CO=`${Wn}.1`,kO=`${Wn}.2`,PO=`${Wn}.3`,RO=`${Wn}.4`,DO=`${Wn}.5`,NO=`${Wn}.6`,OO=`${Wn}.7`,LO=`${Wn}.8`,BO=`${Wn}.9`,MO=`${Wn}.10`,UO=`${Wn}.11`,FO=`${Wn}.12`,$O=`${Wn}.13`,HO=`${Wn}.14`,VO="brainpoolP160r1",zO="brainpoolP160t1",KO="brainpoolP192r1",qO="brainpoolP192t1",jO="brainpoolP224r1",WO="brainpoolP224t1",GO="brainpoolP256r1",XO="brainpoolP256t1",YO="brainpoolP320r1",QO="brainpoolP320t1",ZO="brainpoolP384r1",JO="brainpoolP384t1",eL="brainpoolP512r1",tL="brainpoolP512t1",Ht="ECDSA",cm=j4=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Ht.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return yN;case"sha-256":return wN;case"sha-384":return xN;case"sha-512":return bN}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=rv;break;case"K-256":t=j4.SECP256K1;break;case"P-384":t=nv;break;case"P-521":t=iv;break;case VO:t=CO;break;case zO:t=kO;break;case KO:t=PO;break;case qO:t=RO;break;case jO:t=DO;break;case WO:t=NO;break;case GO:t=OO;break;case XO:t=LO;break;case YO:t=BO;break;case QO:t=MO;break;case ZO:t=UO;break;case JO:t=FO;break;case eL:t=$O;break;case tL:t=HO;break}if(t)return new J({algorithm:fu,parameters:re.serialize(new ts({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case q1:return{name:Ht,hash:{name:"SHA-1"}};case j1:return{name:Ht,hash:{name:"SHA-256"}};case W1:return{name:Ht,hash:{name:"SHA-384"}};case G1:return{name:Ht,hash:{name:"SHA-512"}};case fu:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(re.parse(e.parameters,ts).namedCurve){case rv:return{name:Ht,namedCurve:"P-256"};case j4.SECP256K1:return{name:Ht,namedCurve:"K-256"};case nv:return{name:Ht,namedCurve:"P-384"};case iv:return{name:Ht,namedCurve:"P-521"};case CO:return{name:Ht,namedCurve:VO};case kO:return{name:Ht,namedCurve:zO};case PO:return{name:Ht,namedCurve:KO};case RO:return{name:Ht,namedCurve:qO};case DO:return{name:Ht,namedCurve:jO};case NO:return{name:Ht,namedCurve:WO};case OO:return{name:Ht,namedCurve:GO};case LO:return{name:Ht,namedCurve:XO};case BO:return{name:Ht,namedCurve:YO};case MO:return{name:Ht,namedCurve:QO};case UO:return{name:Ht,namedCurve:ZO};case FO:return{name:Ht,namedCurve:JO};case $O:return{name:Ht,namedCurve:eL};case HO:return{name:Ht,namedCurve:tL}}}}return null}};cm.SECP256K1="1.3.132.0.10";cm=j4=p([uc()],cm);It.registerSingleton(dm,cm);var dL=Symbol("name"),hL=Symbol("value"),Je=class{constructor(e,t={},n=""){this[dL]=e,this[hL]=n;for(let i in t)this[i]=t[i]}};Je.NAME=dL;Je.VALUE=hL;var jv=class{static toTextObject(e){let t=new Je("Algorithm Identifier",{},ss.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case fu:{let n=new cm().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}},ss=class{static toString(e){let t=this.items[e];return t||e}};ss.items={[hu]:"sha1",[C4]:"sha224",[pu]:"sha256",[mu]:"sha384",[gu]:"sha512",[rs]:"rsaEncryption",[Dd]:"sha1WithRSAEncryption",[_N]:"sha224WithRSAEncryption",[T4]:"sha256WithRSAEncryption",[Nd]:"sha384WithRSAEncryption",[Od]:"sha512WithRSAEncryption",[fu]:"ecPublicKey",[q1]:"ecdsaWithSHA1",[I4]:"ecdsaWithSHA224",[j1]:"ecdsaWithSHA256",[W1]:"ecdsaWithSHA384",[G1]:"ecdsaWithSHA512",[QD]:"TLS WWW server authentication",[ZD]:"TLS WWW client authentication",[JD]:"Code Signing",[eN]:"E-mail Protection",[tN]:"Time Stamping",[rN]:"OCSP Signing",[mN]:"Signed Data"};var Ys=class{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){let n=[],i=this.pad(t++),o="",s=e[Je.VALUE];s&&(o=` ${s}`),n.push(`${i}${e[Je.NAME]}:${o}`),i=this.pad(t);for(let a in e){if(typeof a=="symbol")continue;let c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${i}${l}${c}`);else if(c instanceof Date)n.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(let u of c)u[Je.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof Je)c[Je.NAME]=a,n.push(...this.serializeObj(c,t));else if(ee.BufferSourceConverter.isBufferSource(c))a?(n.push(`${i}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){let u=c.toTextObject();u[Je.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){let n=this.pad(t),i=ee.BufferSourceConverter.toUint8Array(e),o=[];for(let s=0;s<i.length;){let a=[];for(let c=0;c<16&&s<i.length;c++){c===8&&a.push("");let l=i[s++].toString(16).padStart(2,"0");a.push(l)}o.push(`${n}${a.join(" ")}`)}return o}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}};Ys.oidSerializer=ss;Ys.algorithmSerializer=jv;var mc=class r{constructor(...e){if(e.length===1){let t=e[0];this.rawData=re.serialize(t),this.onInit(t)}else{let t=re.parse(e[0],e[1]);this.rawData=ee.BufferSourceConverter.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof r?(0,ee.isEqual)(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return re.toString(this.rawData);case"text":return Ys.serialize(this.toTextObject());case"hex":return ee.Convert.ToHex(this.rawData);case"base64":return ee.Convert.ToBase64(this.rawData);case"base64url":return ee.Convert.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){let e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Je(this.getTextName(),{},e)}};mc.NAME="ASN";var qi=class r extends mc{constructor(...e){let t;ee.BufferSourceConverter.isBufferSource(e[0])?t=ee.BufferSourceConverter.toArrayBuffer(e[0]):t=re.serialize(new Vr({extnID:e[0],critical:e[1],extnValue:new Se(ee.BufferSourceConverter.toArrayBuffer(e[2]))})),super(t,Vr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Je.NAME]===r.NAME&&(e[Je.NAME]=ss.toString(this.type)),e}},pL,lm=class r{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[pL]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(r.DEFAULT,crypto):typeof globalThis<"u"&&globalThis.crypto&&globalThis.crypto.subtle&&this.set(r.DEFAULT,globalThis.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=r.DEFAULT){let t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(r.DEFAULT,e);return this}};pL=Symbol.toStringTag;lm.DEFAULT="default";var jr=new lm,rY=/^[0-2](?:\.[1-9][0-9]*)+$/;function nY(r){return new RegExp(rY).test(r)}var G4=class{constructor(e={}){this.items={};for(let t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return nY(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}},qn=new G4;qn.register("CN","2.5.4.3");qn.register("L","2.5.4.7");qn.register("ST","2.5.4.8");qn.register("O","2.5.4.10");qn.register("OU","2.5.4.11");qn.register("C","2.5.4.6");qn.register("DC","0.9.2342.19200300.100.1.25");qn.register("E","1.2.840.113549.1.9.1");qn.register("G","2.5.4.42");qn.register("I","2.5.4.43");qn.register("SN","2.5.4.4");qn.register("T","2.5.4.12");function iY(r,e){return`\\${ee.Convert.ToHex(ee.Convert.FromUtf8String(e)).toUpperCase()}`}function oY(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,iY)}var Ki=class r{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new G4,this.asn=new xt;for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let i=t[n];this.extraNames.register(n,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof xt?this.asn=e:ee.BufferSourceConverter.isBufferSource(e)?this.asn=re.parse(e,xt):this.asn=this.fromJSON(e)}getField(e){let t=this.extraNames.findId(e)||qn.findId(e),n=[];for(let i of this.asn)for(let o of i)o.type===t&&n.push(o.value.toString());return n}getName(e){return this.extraNames.get(e)||qn.get(e)}toString(){return this.asn.map(e=>e.map(t=>{let n=this.getName(t.type)||t.type,i=t.value.anyValue?`#${ee.Convert.ToHex(t.value.anyValue)}`:oY(t.value.toString());return`${n}=${i}`}).join("+")).join(", ")}toJSON(){var e;let t=[];for(let n of this.asn){let i={};for(let o of n){let s=this.getName(o.type)||o.type;(e=i[s])!==null&&e!==void 0||(i[s]=[]),i[s].push(o.value.anyValue?`#${ee.Convert.ToHex(o.value.anyValue)}`:o.value.toString())}t.push(i)}return t}fromString(e){let t=new xt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g,i=null,o=",";for(;i=n.exec(`${e},`);){let[,s,a]=i,c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);let l=i[3];s=this.getTypeOid(s);let u=this.createAttribute(s,a);o==="+"?t[t.length-1].push(u):t.push(new Ya([u])),o=l}return t}fromJSON(e){let t=new xt;for(let n of e){let i=new Ya;for(let o in n){let s=this.getTypeOid(o),a=n[o];for(let c of a){let l=this.createAttribute(s,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){let n=new ql({type:e});if(typeof t=="object")for(let i in t)switch(i){case"ia5String":n.value.ia5String=t[i];break;case"utf8String":n.value.utf8String=t[i];break;case"universalString":n.value.universalString=t[i];break;case"bmpString":n.value.bmpString=t[i];break;case"printableString":n.value.printableString=t[i];break}else if(t[0]==="#")n.value.anyValue=ee.Convert.FromHex(t.slice(1));else{let i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=i:r.isPrintableString(i)?n.value.printableString=i:n.value.utf8String=i}return n}processStringValue(e){let t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return re.serialize(this.asn)}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||jr.get()):n=e[0]||jr.get(),await n.subtle.digest(i,this.toArrayBuffer())}},mL="Cannot initialize GeneralName from ASN.1 data.",rL=`${mL} Unsupported string format in use.`,sY=`${mL} Value doesn't match to GUID regular expression.`,nL=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,iL="1.3.6.1.4.1.311.25.1",oL="1.3.6.1.4.1.311.20.2.3",Bv="dns",Mv="dn",Uv="email",Fv="ip",$v="url",Hv="guid",Vv="upn",z4="id",os=class extends mc{constructor(...e){let t;if(e.length===2)switch(e[0]){case Mv:{let n=new Ki(e[1]).toArrayBuffer(),i=re.parse(n,xt);t=new _e({directoryName:i});break}case Bv:t=new _e({dNSName:e[1]});break;case Uv:t=new _e({rfc822Name:e[1]});break;case Hv:{let n=new RegExp(nL,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");let i=n.slice(1).map((o,s)=>s<3?ee.Convert.ToHex(new Uint8Array(ee.Convert.FromHex(o)).reverse()):o).join("");t=new _e({otherName:new Qa({typeId:iL,value:re.serialize(new Se(ee.Convert.FromHex(i)))})});break}case Fv:t=new _e({iPAddress:e[1]});break;case z4:t=new _e({registeredID:e[1]});break;case Vv:{t=new _e({otherName:new Qa({typeId:oL,value:re.serialize(hb.toASN(e[1]))})});break}case $v:t=new _e({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else ee.BufferSourceConverter.isBufferSource(e[0])?t=re.parse(e[0],_e):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=Bv,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=Uv,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=Fv,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=$v,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=z4,this.value=e.registeredID;else if(e.directoryName!=null)this.type=Mv,this.value=new Ki(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===iL){this.type=Hv;let t=re.parse(e.otherName.value,Se),n=new RegExp(nL,"i").exec(ee.Convert.ToHex(t));if(!n)throw new Error(sY);this.value=n.slice(1).map((i,o)=>o<3?ee.Convert.ToHex(new Uint8Array(ee.Convert.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===oL)this.type=Vv,this.value=re.parse(e.otherName.value,hr).toString();else throw new Error(rL);else throw new Error(rL)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case Mv:case Bv:case Hv:case Fv:case z4:case Vv:case $v:e=this.type.toUpperCase();break;case Uv:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===z4&&(t=ss.toString(t)),new Je(e,void 0,t)}},Au=class extends mc{constructor(e){let t;if(e instanceof Bt)t=e;else if(Array.isArray(e)){let n=[];for(let i of e)if(i instanceof _e)n.push(i);else{let o=re.parse(new os(i.type,i.value).rawData,_e);n.push(o)}t=new Bt(n)}else if(ee.BufferSourceConverter.isBufferSource(e))t=re.parse(e,Bt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){let t=[];for(let n of e){let i=null;try{i=new os(n)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){let e=super.toTextObjectEmpty();for(let t of this.items){let n=t.toTextObject(),i=e[n[Je.NAME]];Array.isArray(i)||(i=[],e[n[Je.NAME]]=i),i.push(n)}return e}};Au.NAME="GeneralNames";var am="-{5}",um="\\n",aY=`[^${um}]+`,cY=`${am}BEGIN (${aY}(?=${am}))${am}`,lY=`${am}END \\1${am}`,zd="\\n",uY=`[^:${um}]+`,fY=`(?:[^${um}]+${zd}(?: +[^${um}]+${zd})*)`,dY="[a-zA-Z0-9=+/]+",hY=`(?:${dY}${zd})+`,sL=`${cY}${zd}(?:((?:${uY}: ${fY})+))?${zd}?(${hY})${lY}`,An=class{static isPem(e){return typeof e=="string"&&new RegExp(sL,"g").test(e)}static decodeWithHeaders(e){e=e.replace(/\r/g,"");let t=new RegExp(sL,"g"),n=[],i=null;for(;i=t.exec(e);){let o=i[3].replace(new RegExp(`[${um}]+`,"g"),""),s={type:i[1],headers:[],rawData:ee.Convert.FromBase64(o)},a=i[2];if(a){let c=a.split(new RegExp(zd,"g")),l=null;for(let u of c){let[f,h]=u.split(/:(.*)/);if(h===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=f.trim()}else l&&s.headers.push(l),l={key:f,value:h.trim()}}l&&s.headers.push(l)}n.push(s)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){let t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){let n=new Array;return t?e.forEach(i=>{if(!ee.BufferSourceConverter.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:ee.BufferSourceConverter.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(i))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:ee.BufferSourceConverter.toArrayBuffer(e)})}}static encodeStruct(e){var t;let n=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(let l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}let o=ee.Convert.ToBase64(e.rawData),s,a=0,c=Array();for(;a<o.length&&(o.length-a<64?s=o.substring(a):(s=o.substring(a,a+64),a+=64),s.length!==0);)if(c.push(s),s.length<64)break;return i.push(...c),i.push(`-----END ${n}-----`),i.join(`
`)}};An.CertificateTag="CERTIFICATE";An.CrlTag="CRL";An.CertificateRequestTag="CERTIFICATE REQUEST";An.PublicKeyTag="PUBLIC KEY";An.PrivateKeyTag="PRIVATE KEY";var gc=class r extends mc{static isAsnEncoded(e){return ee.BufferSourceConverter.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(An.isPem(e))return An.decode(e)[0];if(ee.Convert.isHex(e))return ee.Convert.FromHex(e);if(ee.Convert.isBase64(e))return ee.Convert.FromBase64(e);if(ee.Convert.isBase64Url(e))return ee.Convert.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{let t=ee.Convert.ToBinary(e);return An.isPem(t)?An.decode(t)[0]:ee.Convert.isHex(t)?ee.Convert.FromHex(t):ee.Convert.isBase64(t)?ee.Convert.FromBase64(t):ee.Convert.isBase64Url(t)?ee.Convert.FromBase64Url(t):ee.BufferSourceConverter.toArrayBuffer(e)}}constructor(...e){r.isAsnEncoded(e[0])?super(r.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return An.encode(this.rawData,this.tag);default:return super.toString(e)}}},Xs=class r extends gc{static async create(e,t=jr.get()){if(e instanceof r)return e;if(lm.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");let n=await t.subtle.exportKey("spki",e);return new r(n)}else{if(e.publicKey)return e.publicKey;if(ee.BufferSourceConverter.isBufferSource(e))return new r(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){gc.isAsnEncoded(e)?super(e,Hr):super(e),this.tag=An.PublicKeyTag}async export(...e){let t,n=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,n=e[1]||n,t=e[2]||jr.get()):t=e[0]||jr.get();let o=this.rawData,s=re.parse(this.rawData,Hr);return s.algorithm.algorithm===ac&&(o=pY(s,o)),t.subtle.importKey("spki",o,i,!0,n)}onInit(e){let t=It.resolve(Su),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case rs:{let i=re.parse(e.subjectPublicKey,Md),o=ee.BufferSourceConverter.toUint8Array(i.modulus);n.publicExponent=ee.BufferSourceConverter.toUint8Array(i.publicExponent),n.modulusLength=(o[0]?o:o.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||jr.get()):n=e[0]||jr.get(),await n.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=jr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=jr.get();let i=re.parse(this.rawData,Hr);return await t.subtle.digest(n,i.subjectPublicKey)}toTextObject(){let e=this.toTextObjectEmpty(),t=re.parse(this.rawData,Hr);switch(e.Algorithm=Ys.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case fu:e["EC Point"]=t.subjectPublicKey;break;case rs:default:e["Raw Data"]=t.subjectPublicKey}return e}};function pY(r,e){return r.algorithm=new J({algorithm:rs,parameters:null}),e=re.serialize(r),e}var X4=class r extends qi{static async create(e,t=!1,n=jr.get()){if("name"in e&&"serialNumber"in e)return new r(e,t);let o=await(await Xs.create(e,n)).getKeyIdentifier(n);return new r(ee.Convert.ToHex(o),t)}constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){let t=new Qo({keyIdentifier:new Gl(ee.Convert.FromHex(e[0]))});super(o4,e[1],re.serialize(t))}else{let t=e[0],n=t.name instanceof Au?re.parse(t.name.rawData,Bt):t.name,i=new Qo({authorityCertIssuer:n,authorityCertSerialNumber:ee.Convert.FromHex(t.serialNumber)});super(o4,e[1],re.serialize(i))}}onInit(e){super.onInit(e);let t=re.parse(e.extnValue,Qo);t.keyIdentifier&&(this.keyId=ee.Convert.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ee.Convert.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){let e=this.toTextObjectWithoutValue(),t=re.parse(this.value,Qo);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Au(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}};X4.NAME="Authority Key Identifier";var Kd=class extends qi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=re.parse(this.value,Xl);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{let t=new Xl({cA:e[0],pathLenConstraint:e[1]});super(s4,e[2],re.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}};Kd.NAME="Basic Constraints";var aL;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(aL||(aL={}));var Y4=class extends qi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=re.parse(this.value,I1);this.usages=t.map(n=>n)}else{let t=new I1(e[0]);super(u4,e[1],re.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>ss.toString(t)).join(", "),e}};Y4.NAME="Extended Key Usages";var cL;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(cL||(cL={}));var Q4=class extends qi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=re.parse(this.value,md);this.usages=t.toNumber()}else{let t=new md(e[0]);super(f4,e[1],re.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=re.parse(this.value,md);return e[""]=t.toJSON().join(", "),e}};Q4.NAME="Key Usages";var Z4=class r extends qi{static async create(e,t=!1,n=jr.get()){let o=await(await Xs.create(e,n)).getKeyIdentifier(n);return new r(ee.Convert.ToHex(o),t)}constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=re.parse(this.value,$n);this.keyId=ee.Convert.ToHex(t)}else{let t=typeof e[0]=="string"?ee.Convert.FromHex(e[0]):e[0],n=new $n(t);super(Fb,e[1],re.serialize(n)),this.keyId=ee.Convert.ToHex(t)}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=re.parse(this.value,$n);return e[""]=t,e}};Z4.NAME="Subject Key Identifier";var J4=class extends qi{constructor(...e){ee.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(Mb,e[1],new Au(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=re.parse(e.extnValue,m4);this.names=new Au(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};J4.NAME="Subject Alternative Name";var jn=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new qi(e),n=this.items.get(t.type);return n?new n(e):t}};jn.items=new Map;var e6=class extends qi{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let n=re.parse(this.value,v1);this.policies=n.map(i=>i.policyIdentifier)}else{let n=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,o=new v1(n.map(s=>new Yl({policyIdentifier:s})));super(c4,i,re.serialize(o)),this.policies=n}}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Je("",{},ss.toString(t))),e}};e6.NAME="Certificate Policies";jn.register(c4,e6);var t6=class extends qi{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){let i=e[0].map(s=>new Zo({distributionPoint:new zs({fullName:[new _e({uniformResourceIdentifier:s})]})})),o=new ec(i);super(l4,e[1],re.serialize(o))}else{let n=new ec(e[0]);super(l4,e[1],re.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);let t=re.parse(e.extnValue,ec);this.distributionPoints=t}toTextObject(){let e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;let i={};return t.distributionPoint&&(i[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(o=>new os(o).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(o=>o.toString()).join(", ")),i}),e}};t6.NAME="CRL Distribution Points";var r6=class extends qi{constructor(...e){var t,n,i,o;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof Wl){let s=new Wl(e[0]);super(i4,e[1],re.serialize(s))}else{let s=e[0],a=new Wl;q4(a,s,vb,"ocsp"),q4(a,s,Eb,"caIssuers"),q4(a,s,Sb,"timeStamping"),q4(a,s,Ab,"caRepository"),super(i4,e[1],re.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(o=this.caRepository)!==null&&o!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],re.parse(e.extnValue,Wl).forEach(n=>{switch(n.accessMethod){case vb:this.ocsp.push(new os(n.accessLocation));break;case Eb:this.caIssuers.push(new os(n.accessLocation));break;case Sb:this.timeStamping.push(new os(n.accessLocation));break;case Ab:this.caRepository.push(new os(n.accessLocation));break}})}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ocsp.length&&K4(e,"OCSP",this.ocsp),this.caIssuers.length&&K4(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&K4(e,"Time Stamping",this.timeStamping),this.caRepository.length&&K4(e,"CA Repository",this.caRepository),e}};r6.NAME="Authority Info Access";function K4(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{let n=new Je("");t.forEach((i,o)=>{let s=i.toTextObject(),a=`${s[Je.NAME]} ${o+1}`,c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(s)}),r[e]=n}}function q4(r,e,t,n){let i=e[n];i&&(Array.isArray(i)?i:[i]).forEach(s=>{typeof s=="string"&&(s=new os("url",s)),r.push(new Hs({accessMethod:t,accessLocation:re.parse(s.rawData,_e)}))})}var qd=class r extends mc{constructor(...e){let t;if(ee.BufferSourceConverter.isBufferSource(e[0]))t=ee.BufferSourceConverter.toArrayBuffer(e[0]);else{let n=e[0],i=Array.isArray(e[1])?e[1].map(o=>ee.BufferSourceConverter.toArrayBuffer(o)):[];t=re.serialize(new $r({type:n,values:i}))}super(t,$r)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Je("",{"":t})),e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty();return e[Je.NAME]===r.NAME&&(e[Je.NAME]=ss.toString(this.type)),e}};qd.NAME="Attribute";var n6=class extends qd{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=new rm({printableString:e[0]});super(Ov,[re.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){let t=re.parse(this.values[0],rm);this.password=t.toString()}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[Je.VALUE]=this.password,e}};n6.NAME="Challenge Password";var fm=class extends qd{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=e[0],i=new hi;for(let o of n)i.push(re.parse(o.rawData,Vr));super(im,[re.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){let t=re.parse(this.values[0],hi);this.items=t.map(n=>jn.create(re.serialize(n)))}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(let n of t)e[n[Je.NAME]]=n;return e}};fm.NAME="Extensions";var jd=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new qd(e),n=this.items.get(t.type);return n?new n(e):t}};jd.items=new Map;var hm="crypto.signatureFormatter",Wv=class{toAsnSignature(e,t){return ee.BufferSourceConverter.toArrayBuffer(t)}toWebSignature(e,t){return ee.BufferSourceConverter.toArrayBuffer(t)}},W4,Gv=W4=class{static createPssParams(e,t){let n=W4.getHashAlgorithm(e);return n?new ns({hashAlgorithm:n,maskGenAlgorithm:new J({algorithm:cc,parameters:re.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){let t=It.resolve(Su);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new J({algorithm:Dd,parameters:null});case"sha-256":return new J({algorithm:T4,parameters:null});case"sha-384":return new J({algorithm:Nd,parameters:null});case"sha-512":return new J({algorithm:Od,parameters:null})}}else return new J({algorithm:rs,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");let t=W4.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new J({algorithm:ac,parameters:re.serialize(t)})}else return new J({algorithm:ac,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case rs:return{name:"RSASSA-PKCS1-v1_5"};case Dd:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case T4:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Nd:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Od:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case ac:if(e.parameters){let t=re.parse(e.parameters,ns);return{name:"RSA-PSS",hash:It.resolve(Su).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};Gv=W4=p([uc()],Gv);It.registerSingleton(dm,Gv);var Xv=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new J({algorithm:hu});case"sha-256":return new J({algorithm:pu});case"sha-384":return new J({algorithm:mu});case"sha-512":return new J({algorithm:gu})}return null}toWebAlgorithm(e){switch(e.algorithm){case hu:return{name:"SHA-1"};case pu:return{name:"SHA-256"};case mu:return{name:"SHA-384"};case gu:return{name:"SHA-512"}}return null}};Xv=p([uc()],Xv);It.registerSingleton(dm,Xv);var Qs=class r{addPadding(e,t){let n=ee.BufferSourceConverter.toUint8Array(t),i=new Uint8Array(e);return i.set(n,e-n.length),i}removePadding(e,t=!1){let n=ee.BufferSourceConverter.toUint8Array(e);for(let i=0;i<n.length;i++)if(n[i]){n=n.slice(i);break}if(t&&n[0]>127){let i=new Uint8Array(n.length+1);return i.set(n,1),i.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){let n=e.namedCurve,i=r.namedCurveSize.get(n)||r.defaultNamedCurveSize,o=new du,s=ee.BufferSourceConverter.toUint8Array(t);return o.r=this.removePadding(s.slice(0,i),!0),o.s=this.removePadding(s.slice(i,i+i),!0),re.serialize(o)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){let n=re.parse(t,du),i=e.namedCurve,o=r.namedCurveSize.get(i)||r.defaultNamedCurveSize,s=this.addPadding(o,this.removePadding(n.r)),a=this.addPadding(o,this.removePadding(n.s));return(0,ee.combine)(s,a)}return null}};Qs.namedCurveSize=new Map;Qs.defaultNamedCurveSize=32;var zv="1.3.101.110",lL="1.3.101.111",Kv="1.3.101.112",uL="1.3.101.113",Yv=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Kv;break;case"x25519":t=zv;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Kv;break;case"ed448":t=uL;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=zv;break;case"x448":t=lL;break}}return t?new J({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Kv:return{name:"Ed25519"};case uL:return{name:"EdDSA",namedCurve:"Ed448"};case zv:return{name:"X25519"};case lL:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};Yv=p([uc()],Yv);It.registerSingleton(dm,Yv);var Qv=class extends gc{constructor(e){gc.isAsnEncoded(e)?super(e,pc):super(e),this.tag=An.CertificateRequestTag}onInit(e){this.tbs=re.serialize(e.certificationRequestInfo),this.publicKey=new Xs(e.certificationRequestInfo.subjectPKInfo);let t=It.resolve(Su);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(i=>jd.create(re.serialize(i)));let n=this.getAttribute(im);this.extensions=[],n instanceof fm&&(this.extensions=n.items),this.subjectName=new Ki(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(let t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(let t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=jr.get()){let t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),i=It.resolveAll(hm).reverse(),o=null;for(let a of i)if(o=a.toWebSignature(t,this.signature),o)break;if(!o)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,o,this.tbs)}toTextObject(){let e=this.toTextObjectEmpty(),t=re.parse(this.rawData,pc),n=t.certificationRequestInfo,i=new Je("",{Version:`${Jo[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){let o=new Je("");for(let s of this.attributes){let a=s.toTextObject();o[a[Je.NAME]]=a}i.Attributes=o}return e.Data=i,e.Signature=new Je("",{Algorithm:Ys.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}};Qv.NAME="PKCS#10 Certificate Request";var Wd=class extends gc{constructor(e){gc.isAsnEncoded(e)?super(e,Fi):super(e),this.tag=An.CertificateTag}onInit(e){let t=e.tbsCertificate;this.tbs=re.serialize(t),this.serialNumber=ee.Convert.ToHex(t.serialNumber),this.subjectName=new Ki(t.subject),this.subject=new Ki(t.subject).toString(),this.issuerName=new Ki(t.issuer),this.issuer=this.issuerName.toString();let n=It.resolve(Su);this.signatureAlgorithm=n.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;let i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;let o=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!o)throw new Error("Cannot get 'notAfter' value");this.notAfter=o,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(s=>jn.create(re.serialize(s)))),this.publicKey=new Xs(t.subjectPublicKeyInfo)}getExtension(e){for(let t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=jr.get()){let n,i,o=e.publicKey;try{if(!o)n={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(n,["verify"],t);else if("publicKey"in o)n={...o.publicKey.algorithm,...this.signatureAlgorithm},i=await o.publicKey.export(n,["verify"],t);else if(o instanceof Xs)n={...o.algorithm,...this.signatureAlgorithm},i=await o.export(n,["verify"],t);else if(ee.BufferSourceConverter.isBufferSource(o)){let l=new Xs(o);n={...l.algorithm,...this.signatureAlgorithm},i=await l.export(n,["verify"],t)}else n={...o.algorithm,...this.signatureAlgorithm},i=o}catch{return!1}let s=It.resolveAll(hm).reverse(),a=null;for(let l of s)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");let c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{let u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=jr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=jr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){let e=this.toTextObjectEmpty(),t=re.parse(this.rawData,Fi),n=t.tbsCertificate,i=new Je("",{Version:`${Jo[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":Ys.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new Je("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(i["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(i["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){let o=new Je("");for(let s of this.extensions){let a=s.toTextObject();o[a[Je.NAME]]=a}i.Extensions=o}return e.Data=i,e.Signature=new Je("",{Algorithm:Ys.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}};Wd.NAME="Certificate";var i6=class{static async createSelfSigned(e,t=jr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=jr.get()){var n;let i;e.publicKey instanceof Xs?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:ee.BufferSourceConverter.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);let o=e.serialNumber?ee.BufferSourceConverter.toUint8Array(ee.Convert.FromHex(e.serialNumber)):t.getRandomValues(new Uint8Array(16));o[0]>127&&(o[0]&=127),o.length>1&&o[0]===0&&(o[1]|=128);let s=e.notBefore||new Date,a=e.notAfter||new Date(s.getTime()+31536e6),c=new Fi({tbsCertificate:new zr({version:Jo.v3,serialNumber:o,validity:new Ks({notBefore:s,notAfter:a}),extensions:new hi(((n=e.extensions)===null||n===void 0?void 0:n.map(w=>re.parse(w.rawData,Vr)))||[]),subjectPublicKeyInfo:re.parse(i,Hr)})});if(e.subject){let w=e.subject instanceof Ki?e.subject:new Ki(e.subject);c.tbsCertificate.subject=re.parse(w.toArrayBuffer(),xt)}if(e.issuer){let w=e.issuer instanceof Ki?e.issuer:new Ki(e.issuer);c.tbsCertificate.issuer=re.parse(w.toArrayBuffer(),xt)}let l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},f=It.resolve(Su);c.tbsCertificate.signature=c.signatureAlgorithm=f.toAsnAlgorithm(u);let h=re.serialize(c.tbsCertificate),d="signingKey"in e?await t.subtle.sign(u,e.signingKey,h):e.signature,m=It.resolveAll(hm).reverse(),g=null;for(let w of m)if(g=w.toAsnSignature(u,d),g)break;if(!g)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=g,new Wd(re.serialize(c))}},fL;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(fL||(fL={}));jn.register(s4,Kd);jn.register(u4,Y4);jn.register(f4,Q4);jn.register(Fb,Z4);jn.register(o4,X4);jn.register(Mb,J4);jn.register(l4,t6);jn.register(i4,r6);jd.register(Ov,n6);jd.register(im,fm);It.registerSingleton(hm,Wv);It.registerSingleton(hm,Qs);Qs.namedCurveSize.set("P-256",32);Qs.namedCurveSize.set("K-256",32);Qs.namedCurveSize.set("P-384",48);Qs.namedCurveSize.set("P-521",66);var o6=class extends Me{async listen(){throw new Y3("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}};var Zv=Object.values(Bc).map(r=>r.decoder).reduce((r,e)=>r.or(e)),mY=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function gL(r){return r?.match(mY)?.groups?.fingerprint}function Jv(r){let t=r.stringTuples().filter(n=>n[0]===yD).map(n=>n[1])[0];if(t===void 0||t==="")throw new U(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function gY(r){return yt.decode(Zv.decode(r))}function yY(r){let e=gY(Jv(r)),t=wY(e.code),n=e.digest.reduce((o,s)=>o+s.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw new X3(n,r.toString());return`${t} ${i.join(":").toUpperCase()}`}function yL(r){let e=r.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),n=Zr(Fe.code,t);return se(`/certhash/${Nc.encode(n.bytes)}`)}function wY(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new Q3(r)}}function wL(r,e){let{host:t,port:n,family:i}=r.toOptions(),o=yY(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${o}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${ud}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function xL(r,e){let{host:t,port:n,family:i}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
c=IN IP${i} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${ud}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function eE(r,e){if(r.sdp===void 0)throw new U("Can't munge a missing SDP");let t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}var tE=O("libp2p-webrtc-noise:");function vL(r,e,t){let n=r.trim().toLowerCase().replaceAll(":",""),i=O(n,"hex"),o=Zr(Fe.code,i),s=Zv.decode(Jv(e)),a=tE.byteLength+o.bytes.byteLength+s.byteLength;return t==="server"?Ve([tE,s,o.bytes],a):Ve([tE,o.bytes,s],a)}var xY=d1?"iceconnectionstatechange":"connectionstatechange";async function EL(r,e,t){let n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");let f=await r.createOffer();t.log.trace("client created local offer %s",f.sdp);let h=eE(f,e);t.log.trace("client setting local offer %s",h.sdp),await r.setLocalDescription(h);let d=wL(t.remoteAddr,e);t.log.trace("client setting server description %s",d.sdp),await r.setRemoteDescription(d)}else{let f=xL(t.remoteAddr,e);t.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),t.log.trace("server creating local answer");let h=await r.createAnswer();t.log.trace("server created local answer");let d=eE(h,e);t.log.trace("server setting local description %s",h.sdp),await r.setLocalDescription(d)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await Er(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){let f=r.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(yL(f))}let i=gL(r.localDescription?.sdp);if(i==null)throw new Xa("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);let o=vL(i,t.remoteAddr,t.role),s=J2({prologueBytes:o})(t),a=fd({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),c=new Kl(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(xY,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(f=>{t.log.error("error closing connection",f),c.abort(f)});break;default:break}}),t.events?.increment({peer_connection:!0});let l=new Ga(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await s.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);let u=await s.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(i){throw n.close(),i}}async function SL(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));let i=typeof t=="function"?await t():t;return new RTCPeerConnection({...i??{},certificates:[n]})}async function AL(r){let e=await X0(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...H(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var s6=class{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new Me,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new U("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[oa]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[tt]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n,i=e.getPeerId();i!=null&&(n=at(i));let o=OD(),s=await SL("client",o,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await EL(s,o,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(a){throw s.close(),a}}createListener(e){if(this.certificate==null)throw new Zn;return new o6(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(vp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(bY(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;let t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await AL(t),pem:n,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;let e=this.init.certificateKeychainName??_D,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new We;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await pf("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n,i=new nt(this.init.certificateDatastoreKey??AD),o=await X0(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new We;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(i,o)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(i,o)}let s=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??ab)-Date.now();return s<0&&(s=100),this.log("will renew TLS certificate after %d ms",s),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},s),{pem:n.toString("pem"),certhash:Nc.encode((await Fe.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){let n=await this.components.datastore.get(e),i=new Wd(n),o=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??ab);if(Date.now()>o)throw this.log("stored TLS certificate has expired"),new We;this.log("loaded certificate, expires in %d ms",o);let s=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",s),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!pe(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new We;return this.log("loaded certificate, expiry time is %o",o),i}async createCertificate(e,t){let n=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??ID));n.setMilliseconds(0),i.setMilliseconds(0);let o=await i6.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:i,keys:t,extensions:[new Kd(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,O(o.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),o}getKeychain(){try{return this.components.keychain}catch{}}};function bY(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function a6(r){return e=>new s6(e,r)}function _L(r){return e=>new t4(e,r)}var IL=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",i),r.removeEventListener("error",o)}function i(){n(),e()}function o(s){n(),t(s.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",i),r.addEventListener("error",o)})};var TL=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let i of n){try{await IL(r)}catch(o){if(o.message==="socket closed")break;throw o}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(i)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((i,o)=>{r.addEventListener("close",s=>{if(s.wasClean||s.code===1006)i();else{let a=Object.assign(new Error("ws error"),{event:s});o(a)}}),setTimeout(()=>{r.close()})})});var RL=it(kL(),1);function PL(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var DL=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((o,s)=>{if(n){o();return}if(i!=null){s(i);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(o)},l=u=>{a(()=>{s(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let o=new RL.EventIterator(({push:s,stop:a,fail:c})=>{let l=f=>{let h=null;typeof f.data=="string"&&(h=O(f.data)),PL(f.data)&&(h=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(h=f.data),h!=null&&s(h)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let s of o)yield PL(s)?new Uint8Array(s):s}(),n=r.readyState===1,i;return r.addEventListener("open",()=>{n=!0,i=null}),r.addEventListener("close",()=>{n=!1,i=null}),r.addEventListener("error",o=>{n||(i=o.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var NL=(r,e)=>{e=e??{};let t=DL(r),n=e.remoteAddress,i=e.remotePort;if(r.url!=null)try{let s=new URL(r.url);n=s.hostname,i=parseInt(s.port,10)}catch{}if(n==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:TL(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(s=>{r.addEventListener("close",()=>{s()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:i,socket:r}};var OL=WebSocket;var EY={"http:":"ws:","https:":"wss:"},LL="ws:",BL=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??LL}${r}`),r.startsWith("/")&&e!=null){let n=e.protocol??LL,i=e.host,o=e.port!=null&&i?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${i}${o}${r}`}let t=new URL(r);for(let[n,i]of Object.entries(EY))t.protocol===n&&(t.protocol=i);return t};function ML(r,e){let t=typeof window>"u"?void 0:window.location;e=e??{};let n=BL(r,t),i=new OL(n.toString(),e.websocket);return NL(i,e)}function UL(r){return r.filter(e=>ml.exactMatch(e)||Cs.exactMatch(e))}function FL(){throw new Error("WebSocket Servers can not be created in the browser!")}function $L(r,e,t){let n=t.logger.forComponent("libp2p:websockets:maconn"),i=t.metrics,o=t.metricPrefix??"",s={log:n,async sink(a){try{await r.sink(async function*(){for await(let c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){let c=Date.now();if(a.signal==null){let u=AbortSignal.timeout(500);a={...a,signal:u}}let l=()=>{let{host:u,port:f}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",u,f,Date.now()-c),this.abort(new Cr("Socket close timeout"))};a.signal?.addEventListener("abort",l);try{await r.close()}catch(u){n.error("error closing WebSocket gracefully",u),this.abort(u)}finally{a.signal?.removeEventListener("abort",l),s.timeline.close=Date.now()}},abort(a){let{host:c,port:l}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),s.timeline.close=Date.now(),i?.increment({[`${o}error`]:!0})}};return r.socket.addEventListener("close",()=>{i?.increment({[`${o}close`]:!0}),s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}var iE=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[oa]=!0;[Symbol.toStringTag]="@libp2p/websockets";[tt]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let n=await this._connect(e,t),i=$L(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);let o=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),o}async _connect(e,t){t?.signal?.throwIfAborted();let n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);let i=ye(),o=ML(n2(e),this.init);o.socket.addEventListener("error",()=>{let s=new Vu(`Could not connect to ${e.toString()}`);this.log.error("connection error:",s),this.metrics?.dialerEvents.increment({error:!0}),i.reject(s)});try{t.onProgress?.(new G("websockets:open-connection")),await Dt(Promise.race([o.connected(),i.promise]),t.signal)}catch(s){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),o.close().catch(a=>{this.log.error("error closing raw socket",a)}),s}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),o}createListener(e){return FL({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):UL(e)}dialFilter(e){return this.listenFilter(e)}};function u6(r={}){return e=>new iE(e,r)}var f6="2.8.5",d6="js-libp2p";function h6(r,e){return`${r??d6}/${e??f6} browser/${globalThis.navigator.userAgent}`}var VL="5.3.0",zL="helia";var KL={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function mm(r={}){let e=`${zL}/${VL} ${h6()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[T9(),_L(),a6(),u6()],connectionEncrypters:[J2()],streamMuxers:[Pk(),uD()],peerDiscovery:[Wk(KL)],services:{autoNAT:Bk(),dcutr:dP(),delegatedRouting:()=>S2("https://delegated-ipfs.dev",Mx()),dht:YP({clientMode:!0,validators:{ipns:Ra},selectors:{ipns:A2}}),identify:xP(),identifyPush:bP(),keychain:$3(r.keychain),ping:pD()}}}async function oE(r,e={}){let t=e.selfKey??"self",n=$3(e)({datastore:r,logger:Ea()}),i;return await r.has(new nt(`/pkcs8/${t}`))?i=await n.exportKey(t):(i=await pf(e.keyType??"Ed25519"),await n.importKey(t,i)),i}var AY=32,{code:_Y}=Ie("dnsaddr"),sE=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}},_u=async function(e,t={}){let n=t.maxRecursiveDepth??AY;if(n===0)throw new sE("Max recursive depth reached");let[,i]=e.stringTuples().find(([l])=>l===_Y)??[],s=await(t?.dns??nl()).query(`_dnsaddr.${i}`,{signal:t?.signal,types:[rn.TXT]}),a=e.getPeerId(),c=[];for(let l of s.Answer){let u=l.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;let f=se(u);if(u.startsWith("/dnsaddr")){let h=await f.resolve({...t,maxRecursiveDepth:n-1});c.push(...h.map(d=>d.toString()))}else c.push(f.toString())}return c};var IY={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:_u}},transportManager:{faultTolerance:Tc.FATAL_ALL}};async function qL(r){let e=Wt(IY,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new U("Private network is enforced, but no protector was provided");return e}var Zs;(function(r){let e;(function(i){let o;i.codec=()=>(o==null&&(o=Ee((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&s.value.byteLength>0&&(a.uint32(18),a.bytes(s.value)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:"",value:Pe(0)},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(f&7);break}}}return l})),o),i.encode=s=>ve(s,i.codec()),i.decode=(s,a)=>be(s,i.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(i){let o;i.codec=()=>(o==null&&(o=Ee((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&(a.uint32(18),m6.codec().encode(s.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:""},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=m6.codec().decode(s,s.uint32(),{limits:c.limits?.value});break}default:{s.skipType(f&7);break}}}return l})),o),i.encode=s=>ve(s,i.codec()),i.decode=(s,a)=>be(s,i.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.addresses!=null)for(let a of i.addresses)o.uint32(10),p6.codec().encode(a,o);if(i.protocols!=null)for(let a of i.protocols)o.uint32(18),o.string(a);if(i.publicKey!=null&&(o.uint32(34),o.bytes(i.publicKey)),i.peerRecordEnvelope!=null&&(o.uint32(42),o.bytes(i.peerRecordEnvelope)),i.metadata!=null&&i.metadata.size!==0)for(let[a,c]of i.metadata.entries())o.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},o);if(i.tags!=null&&i.tags.size!==0)for(let[a,c]of i.tags.entries())o.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},o);i.updated!=null&&(o.uint32(64),o.uint64Number(i.updated)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&a.addresses.length===s.limits.addresses)throw new wt('Decode error - map field "addresses" had too many elements');a.addresses.push(p6.codec().decode(i,i.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&a.protocols.length===s.limits.protocols)throw new wt('Decode error - map field "protocols" had too many elements');a.protocols.push(i.string());break}case 4:{a.publicKey=i.bytes();break}case 5:{a.peerRecordEnvelope=i.bytes();break}case 6:{if(s.limits?.metadata!=null&&a.metadata.size===s.limits.metadata)throw new Ih('Decode error - map field "metadata" had too many elements');let u=r.Peer$metadataEntry.codec().decode(i,i.uint32());a.metadata.set(u.key,u.value);break}case 7:{if(s.limits?.tags!=null&&a.tags.size===s.limits.tags)throw new Ih('Decode error - map field "tags" had too many elements');let u=r.Peer$tagsEntry.codec().decode(i,i.uint32(),{limits:{value:s.limits?.tags$value}});a.tags.set(u.key,u.value);break}case 8:{a.updated=i.uint64Number();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ve(i,r.codec()),r.decode=(i,o)=>be(i,r.codec(),o)})(Zs||(Zs={}));var p6;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={multiaddr:Pe(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.multiaddr=t.bytes();break}case 2:{o.isCertified=t.bool();break}case 3:{o.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(p6||(p6={}));var m6;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.value=t.uint32();break}case 2:{o.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>ve(t,r.codec()),r.decode=(t,n)=>be(t,r.codec(),n)})(m6||(m6={}));function TY(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;if(r.type==="RSA"){let i=Le.decode(`z${r}`);t=Ue(i)}let n=tr(e.publicKey,t);return zo(n)}function g6(r,e,t){let n=Zs.decode(e);return y6(r,n,t)}function y6(r,e,t){let n=new Map,i=BigInt(Date.now());for(let[o,s]of e.tags.entries())s.expiry!=null&&s.expiry<i||n.set(o,s);return{...e,id:TY(r,e),addresses:e.addresses.filter(({observed:o})=>o!=null&&o>Date.now()-t).map(({multiaddr:o,isCertified:s})=>({multiaddr:se(o),isCertified:s??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function jL(r,e){return CY(r.addresses,e.addresses)&&kY(r.protocols,e.protocols)&&PY(r.publicKey,e.publicKey)&&RY(r.peerRecordEnvelope,e.peerRecordEnvelope)&&DY(r.metadata,e.metadata)&&NY(r.tags,e.tags)}function CY(r,e){return GL(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!pe(t.multiaddr,n.multiaddr)))}function kY(r,e){return GL(r,e,(t,n)=>t===n)}function PY(r,e){return WL(r,e)}function RY(r,e){return WL(r,e)}function DY(r,e){return XL(r,e,(t,n)=>pe(t,n))}function NY(r,e){return XL(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function WL(r,e){return r==null&&e==null?!0:r!=null&&e!=null?pe(r,e):!1}function GL(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function XL(r,e,t){if(r.size!==e.size)return!1;for(let[n,i]of r.entries()){let o=e.get(n);if(o==null||!t(i,o))return!1}return!0}var aE="/peers/";function gm(r){if(!t0(r)||r.type==null)throw new U("Invalid PeerId");let e=r.toCID().toString();return new nt(`${aE}${e}`)}async function YL(r,e,t,n){let i=new Map;for(let o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=se(o.multiaddr)),!ka(o.multiaddr))throw new U("Multiaddr was invalid");if(!await e(r,o.multiaddr))continue;let s=o.isCertified??!1,a=o.multiaddr.toString(),c=i.get(a);c!=null?o.isCertified=c.isCertified||s:i.set(a,{multiaddr:o.multiaddr,isCertified:s})}return[...i.values()].sort((o,s)=>o.multiaddr.toString().localeCompare(s.multiaddr.toString())).map(({isCertified:o,multiaddr:s})=>({isCertified:o,multiaddr:s.bytes}))}async function x6(r,e,t,n){if(e==null)throw new U("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new U("publicKey bytes do not match peer id publicKey bytes");let i=n.existingPeer?.peer;if(i!=null&&!r.equals(i.id))throw new U("peer id did not match existing peer id");let o=i?.addresses??[],s=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,l=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(o=[],e.multiaddrs!=null&&o.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&o.push(...e.addresses)),e.protocols!=null&&(s=new Set(e.protocols)),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=w6(h,{validate:QL})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=w6(h,{validate:ZL,map:JL})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&o.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&o.push(...e.addresses),e.protocols!=null&&(s=new Set([...s,...e.protocols])),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[d,m]of h)m==null?a.delete(d):a.set(d,m);a=w6([...a.entries()],{validate:QL})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),d=new Map(c);for(let[m,g]of h)g==null?d.delete(m):d.set(m,g);c=w6([...d.entries()],{validate:ZL,map:JL})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;i?.id.publicKey!=null?u=lr(i.id.publicKey):e.publicKey!=null?u=lr(e.publicKey):r.publicKey!=null&&(u=lr(r.publicKey));let f={addresses:await YL(r,n.addressFilter??(async()=>!0),o,n.existingPeer?.peerPB.addresses),protocols:[...s.values()].sort((h,d)=>h.localeCompare(d)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return f.addresses.forEach(h=>{h.observed=n.existingPeer?.peerPB.addresses?.find(d=>pe(d.multiaddr,d.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function w6(r,e){let t=new Map;for(let[n,i]of r)i!=null&&e.validate(n,i);for(let[n,i]of r.sort(([o],[s])=>o.localeCompare(s)))i!=null&&t.set(n,e.map?.(n,i)??i);return t}function QL(r,e){if(typeof r!="string")throw new U("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new U("Metadata value must be a Uint8Array")}function ZL(r,e){if(typeof r!="string")throw new U("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new U("Tag value must be an integer");if(e.value<0||e.value>100)throw new U("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new U("Tag ttl must be an integer");if(e.ttl<0)throw new U("Tag ttl must be between greater than 0")}}function JL(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function eB(r){let e=r.toString().split("/")[2],t=W.parse(e,Jt);return gn(t)}function cE(r,e,t){let n=eB(r);return g6(n,e,t)}function OY(r,e){return{prefix:aE,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(cE(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(cE(n.key,n.value,e),cE(i.key,i.value,e)))}}var b6=class{peerId;datastore;lock;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=cl({name:"peer-store",singleProcess:!0}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}async has(e){try{return await this.load(e),!0}catch(t){if(t.name!=="NotFoundError")throw t}return!1}async delete(e){this.peerId.equals(e)||await this.datastore.delete(gm(e))}async load(e){let t=gm(e),n=await this.datastore.get(t),i=Zs.decode(n);if(this.#n(e,i))throw await this.datastore.delete(t),new We;return y6(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t){let n=await this.#e(e),i=await x6(e,t,"patch",{addressFilter:this.addressFilter});return this.#r(e,i,n)}async patch(e,t){let n=await this.#e(e),i=await x6(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:n});return this.#r(e,i,n)}async merge(e,t){let n=await this.#e(e),i=await x6(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:n});return this.#r(e,i,n)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(OY(e??{},this.maxAddressAge))){let i=eB(t);if(i.equals(this.peerId))continue;let o=Zs.decode(n);if(this.#n(i,o)){await this.datastore.delete(t);continue}yield y6(i,o,this.peerId.equals(i)?1/0:this.maxAddressAge)}}async#e(e){try{let t=gm(e),n=await this.datastore.get(t),i=Zs.decode(n);if(this.#n(e,i))throw await this.datastore.delete(t),new We;return{peerPB:i,peer:g6(e,n,this.maxAddressAge)}}catch(t){t.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",t)}}async#r(e,t,n){t.updated=Date.now();let i=Zs.encode(t);return await this.datastore.put(gm(e),i),{peer:g6(e,i,this.maxAddressAge),previous:n?.peer,updated:n==null||!jL(t,n.peerPB)}}#n(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,o=t.addresses.filter(s=>s.observed!=null&&s.observed>i);return n&&o.length===0}};var lE=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new b6(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){this.log.trace("forEach await read lock");let n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(let i of this.store.all(t))e(i)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");let t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await Ps(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");let t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");let t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");let t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");let n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{let i=await this.store.save(e,t);return this.#e(e,i),i.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");let n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{let i=await this.store.patch(e,t);return this.#e(e,i),i.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");let n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{let i=await this.store.merge(e,t);return this.#e(e,i),i.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){let n=await ai.openAndCertify(e,vn.DOMAIN),i=gn(n.publicKey.toCID());if(t?.equals(i)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,i),!1;let o=vn.createFromProtobuf(n.payload),s;try{s=await this.get(i)}catch(a){if(a.name!=="NotFoundError")throw a}if(s?.peerRecordEnvelope!=null){let a=await ai.createFromProtobuf(s.peerRecordEnvelope),c=vn.createFromProtobuf(a.payload);if(c.seqNumber>=o.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,o.seqNumber),!1}return await this.patch(o.peerId,{peerRecordEnvelope:e,addresses:o.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function tB(r,e={}){return new lE(r,e)}function rB(r,e){let t,n=function(){let i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var nB=864e13;var LY=448,uE=449,BY=53,MY=54,UY=55,FY=56,v6=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(e){let t=this.findHost(e);for(let n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let i=bn(n)===!0;this.mappings.set(n,{domain:e,verified:i,expires:i?nB-Date.now():0,lastVerified:i?nB-Date.now():void 0})})}remove(e){let t=this.findHost(e),n=!1;for(let[i,o]of this.mappings.entries())o.domain===t&&(this.log("removing %s to %s DNS mapping %e",i,o.domain,new Error("where")),this.mappings.delete(i),n=n||o.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let o=e[n].multiaddr.stringTuples(),s=o[0][1];if(s!=null)for(let[a,c]of this.mappings.entries()){if(s!==a)continue;this.maybeAddSNITuple(o,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:se(`/${o.map(u=>[Ie(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===LY&&e[n+1]?.[0]!==uE)return e.splice(n+1,0,[uE,t]),!0;return!1}confirm(e,t){let n=this.findHost(e),i=!1;for(let[o,s]of this.mappings.entries())s.domain===n&&(this.log("marking %s to %s DNS mapping as verified",o,s.domain),i=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return i}unconfirm(e,t){let n=this.findHost(e),i=!1;for(let[o,s]of this.mappings.entries())s.domain===n&&(this.log("removing verification of %s to %s DNS mapping",o,s.domain),i=i||s.verified,s.verified=!1,s.expires=Date.now()+t);return i}findHost(e){for(let t of e.stringTuples())if(t[0]===uE||t[0]===BY||t[0]===MY||t[0]===UY||t[0]===FY)return t[1]}};var fE=4,dE=41,hE=6,$Y=273,E6=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(e){let t=e.stringTuples();for(let n of this.mappings.values())for(let i of n)if(i.externalIp===t[0][1])return!0;return!1}add(e,t,n,i=t,o="tcp"){let s=`${e}-${t}-${o}`,a=this.mappings.get(s)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:i,externalFamily:co(n)?4:6,protocol:o,verified:!1,expires:0};a.push(c),this.mappings.set(s,a)}remove(e){let t=e.stringTuples(),n=t[0][1]??"",i=t[1][0]===hE?"tcp":"udp",o=parseInt(t[1][1]??"0"),s=!1;for(let[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===n&&u.externalPort===o&&u.protocol===i&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,o,i),s=s||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return s}getAll(e){let t=[];for(let{multiaddr:n}of e){let i=n.stringTuples(),o;if((i[0][0]===fE||i[0][0]===dE)&&i[1][0]===hE?o=`${i[0][1]}-${i[1][1]}-tcp`:(i[0][0]===fE||i[0][0]===dE)&&i[1][0]===$Y&&(o=`${i[0][1]}-${i[1][1]}-udp`),o==null)continue;let s=this.mappings.get(o);if(s!=null)for(let a of s)i[0][0]=a.externalFamily===4?fE:dE,i[0][1]=a.externalIp,i[1][1]=`${a.externalPort}`,t.push({multiaddr:se(`/${i.map(c=>[Ie(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){let i=e.stringTuples()[0][1],o=!1;for(let s of this.mappings.values())for(let a of s)a.externalIp===i&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),o=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return o}unconfirm(e,t){let n=e.stringTuples(),i=n[0][1]??"",o=n[1][0]===hE?"tcp":"udp",s=parseInt(n[1][1]??"0"),a=!1;for(let c of this.mappings.values())for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===i&&u.externalPort===s&&u.protocol===o&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,i,s,o),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}};function iB(r){try{let[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===4)return t.startsWith("169.254.");if(e===41)return t.toLowerCase().startsWith("fe80")}catch{}return!1}var HY={maxObservedAddresses:10},S6=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??HY.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Di(e)||iB(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:se(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),i=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},o=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,i),o}};var VY=[4,41,53,54,55,56];function pE(r){try{let[[e]]=r.stringTuples();return VY.includes(e)}catch{}return!1}var zY={maxObservedAddresses:10},A6=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??zY.maxObservedAddresses}get(e,t){if(Di(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),i=this.addresses.get(n);return i==null&&(i={verified:!pE(e),expires:0},this.addresses.set(n,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},o=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(n,i),o}unconfirm(e,t){let n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0},o=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(n,i),o}toKey(e){if(pE(e)){let t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}};var oB=6e4,sB={maxObservedAddresses:10,addressVerificationTTL:oB*10,addressVerificationRetry:oB*5},KY=r=>r;function mE(r,e){let t=r.getPeerId();return t!=null&&at(t).equals(e)&&(r=r.decapsulate(se(`/p2p/${e.toString()}`))),r}var _6=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){let{listen:n=[],announce:i=[],appendAnnounce:o=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(s=>s.toString()),this.announce=new Set(i.map(s=>s.toString())),this.appendAnnounce=new Set(o.map(s=>s.toString())),this.observed=new S6(e,t),this.dnsMappings=new v6(e,t),this.ipMappings=new E6(e,t),this.transportAddresses=new A6(e,t),this.announceFilter=t.announceFilter??KY,this.observedAddressFilter=Tn(1024),this.addressVerificationTTL=t.addressVerificationTTL??sB.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??sB.addressVerificationRetry,this._updatePeerStoreAddresses=rB(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>se(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>se(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>se(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=mE(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=mE(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=mE(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let i=n.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let i=se(n);return i.protos().pop()?.path===!0||i.getPeerId()===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(n)}),t=t.concat(n.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(se(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,i=t,o="tcp"){this.ipMappings.add(e,t,n,i,o),this.observed.removePrefixed(`/ip${co(n)?4:6}/${n}/${o}/${i}`)}removePublicAddressMapping(e,t,n,i=t,o="tcp"){this.ipMappings.remove(se(`/ip${co(n)?4:6}/${n}/${o}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;let t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||bn(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),i=[o=>Cs.exactMatch(o)||ml.exactMatch(o),o=>pl.exactMatch(o),o=>BT.exactMatch(o)];for(let o of i){if(!o(e))continue;let s=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&o(u)).length>0);if(s.length!==1)continue;let a=s[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;let c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}};var aB;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(aB||(aB={}));var I6=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},T6=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},Gd=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},ym=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},C6=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},k6=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},P6=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},wm=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},R6=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},D6=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},N6=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},O6=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},L6=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},Iu=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},Tu=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},B6=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}};var gE=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Ea())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>l0(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},jY=["metrics","connectionProtector","dns"],WY=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function cB(r={}){let e=new gE(r);return new Proxy(e,{get(n,i,o){if(typeof i=="string"&&!WY.includes(i)){let s=e.components[i];if(s==null&&!jY.includes(i))throw new I6(`${i} not set`);return s}return Reflect.get(n,i,o)},set(n,i,o){return typeof i=="string"?e.components[i]=o:Reflect.set(n,i,o),!0}})}function lB(r){let e={};for(let t of Object.values(r.components))for(let n of GY(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of XY(t))if(e[n]!==!0)throw new T6(`Service "${YY(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function GY(r){return Array.isArray(r?.[tt])?r[tt]:[]}function XY(r){return Array.isArray(r?.[Jn])?r[Jn]:[]}function YY(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}var QY=4,ZY=41;function uB(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Cs.matches(e))return!1;let t=e.stringTuples();return t[0][0]===QY||t[0][0]===ZY?!!bn(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}function M6(r){if(t0(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getPeerId();t=n==null?void 0:at(n),e.forEach(i=>{if(!ka(i))throw new sa("Invalid multiaddr");let o=i.getPeerId();if(o==null){if(t!=null)throw new U("Multiaddrs must all have the same peer id or have no peer id")}else{let s=at(o);if(t?.equals(s)!==!0)throw new U("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!RT.exactMatch(n)),{peerId:t,multiaddrs:e}}var JY=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function fB(r,e){let t=r?.streams?.map(i=>i.protocol)??[],n=e?.closableProtocols??JY;if(!(t.filter(i=>i!=null&&!n.includes(i)).length>0))try{await r?.close(e)}catch(i){r?.abort(i)}}var dB="last-dial-failure",hB="last-dial-success";var U6=100,F6=50;async function pB(r,e){let t=!1;for(let i of Nf.keys())if(t=r.protoNames().includes(i),t)break;if(!t)return[r];let n=await r.resolve(e);return e.log("resolved %s to",r,n.map(i=>i.toString())),n}function xm(r){try{let e;if(typeof r=="string"?e=se(r):e=r,!e.protoNames().includes("ipcidr")){let n=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(n)}return bx(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}var eQ={maxConnections:U6,allow:[]},$6=class{maxConnections;connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??eQ.maxConnections,this.allow=(t.allow??[]).map(n=>xm(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;let n=new _r;for(let a of e){let c=a.remotePeer;if(!n.has(c)){n.set(c,0);try{let l=await this.peerStore.get(c);n.set(c,[...l.tags.values()].reduce((u,f)=>u+f.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}let i=this.sortConnections(e,n),o=Math.max(t-this.maxConnections,0),s=[];for(let a of i)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>l.contains(a.remoteAddr.nodeAddress().address))||s.push(a),s.length===o)break;await Promise.all(s.map(async a=>{await fB(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:s})}sortConnections(e,t){return e.sort((n,i)=>{let o=n.timeline.open,s=i.timeline.open;return o<s?1:o>s?-1:0}).sort((n,i)=>n.direction==="outbound"&&i.direction==="inbound"?1:n.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((n,i)=>n.streams.length>i.streams.length?1:n.streams.length<i.streams.length?-1:0).sort((n,i)=>{let o=t.get(n.remotePeer)??0,s=t.get(i.remotePeer)??0;return o>s?1:o<s?-1:0})}};var H6=class extends ln{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};function mB(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function yE(r){if(!ly(r))return!1;let{address:e}=r.nodeAddress();return mB(e)}function tQ(r,e){let t=pl.exactMatch(r.multiaddr),n=pl.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let i=ml.exactMatch(r.multiaddr),o=ml.exactMatch(e.multiaddr);if(i&&!o)return-1;if(!i&&o)return 1;let s=Cs.exactMatch(r.multiaddr),a=Cs.exactMatch(e.multiaddr);if(s&&!a)return-1;if(!s&&a)return 1;let c=Ep.exactMatch(r.multiaddr),l=Ep.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let u=vp.exactMatch(r.multiaddr),f=vp.exactMatch(e.multiaddr);if(u&&!f)return-1;if(!u&&f)return 1;let h=lx.exactMatch(r.multiaddr),d=lx.exactMatch(e.multiaddr);return h&&!d?-1:!h&&d?1:0}function rQ(r,e){let t=yE(r.multiaddr),n=yE(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function nQ(r,e){let t=Di(r.multiaddr),n=Di(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function iQ(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function oQ(r,e){let t=Rn.exactMatch(r.multiaddr),n=Rn.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function gB(r){return r.sort(tQ).sort(iQ).sort(oQ).sort(nQ).sort(rQ)}var V6={maxParallelDials:F6,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:_u}},z6=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??V6.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??V6.maxDialQueueLength,this.dialTimeout=t.dialTimeout??V6.dialTimeout,this.connections=t.connections??new _r,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(let[n,i]of Object.entries(t.resolvers??{}))Nf.set(n,i);this.queue=new H6({concurrency:t.maxParallelDials??V6.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==Cr.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:i}=M6(e),o=Array.from(this.connections.values()).flat().find(a=>t.force===!0?!1:a.remotePeer.equals(n)?!0:i.find(c=>c.equals(a.remoteAddr)));if(o?.status==="open")return this.log("already connected to %a",o.remoteAddr),t.onProgress?.(new G("dial-queue:already-connected")),o;let s=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let l of i)if(c.has(l.toString()))return!0;return!1});if(s!=null){this.log("joining existing dial target for %p",n);for(let a of i)s.options.multiaddrs.add(a.toString());return t.onProgress?.(new G("dial-queue:already-in-dial-queue")),s.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ms("Dial queue is full");return this.log("creating dial target for %p",n,i.map(a=>a.toString())),t.onProgress?.(new G("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new G("dial-queue:start-dial"));let c=Ne([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??vE,multiaddrs:new Set(i.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,i=e.multiaddrs,o=new Set,s=e.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);s||i.size>0;){c++,s=!1;let u=[],f=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let h=await this.calculateMultiaddrs(n,f,{...e,signal:t});for(let d of h){if(o.has(d.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",d.multiaddr,n);continue}u.push(d)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(d=>d.multiaddr.toString())),e?.onProgress?.(new G("dial-queue:calculated-addresses",u));for(let d of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new ms("Peer had more than maxPeerAddrsToDial");a++;try{let m=await this.components.transportManager.dial(d.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",d.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[hB]:O(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}return m}catch(m){if(this.log.error("dial failed to %a",d.multiaddr,m),o.add(d.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[dB]:O(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}if(t.aborted)throw new Oo(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let i=[...t].map(f=>({multiaddr:se(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ms("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new wm("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{let f=await this.components.peerStore.get(e);i.push(...f.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:h})=>h.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let f=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:h})=>h.toString())),i.push(...f.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,f)}}}let o=(await Promise.all(i.map(async f=>{let h=await pB(f.multiaddr,{dns:this.components.dns,...n,log:this.log});return h.length===1&&h[0].equals(f.multiaddr)?f:h.map(d=>({multiaddr:d,isCertified:!1}))}))).flat();if(e!=null){let f=`/p2p/${e.toString()}`;o=o.map(h=>h.multiaddr.protos().pop()?.path===!0?h:h.multiaddr.getPeerId()==null?{multiaddr:h.multiaddr.encapsulate(f),isCertified:h.isCertified}:h)}let s=o.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let h=f.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(let f of s){let h=f.multiaddr.toString(),d=a.get(h);if(d!=null){d.isCertified=d.isCertified||f.isCertified||!1;continue}a.set(h,f)}let c=[...a.values()];if(c.length===0)throw new N6("The dial request has no valid addresses");let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=this.addressSorter==null?gB(l):l.sort(this.addressSorter);if(u.length===0)throw new wm("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",o.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?n.find(i=>!Rn.matches(i.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}};var SB=it(vB(),1);var aQ=Object.prototype.toString,cQ=r=>aQ.call(r)==="[object Error]",lQ=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function EE(r){return r&&cQ(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:lQ.has(r.message):!1}var SE=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},EB=(r,e,t)=>{let n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function AE(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;let i=SB.default.operation(e),o=()=>{i.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",o,{once:!0});let s=()=>{e.signal?.removeEventListener("abort",o),i.stop()};i.attempt(async a=>{try{let c=await r(a);s(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof SE)throw c.originalError;if(c instanceof TypeError&&!EE(c))throw c;if(EB(c,a,e),await e.shouldRetry(c)||(i.stop(),n(c)),await e.onFailedAttempt(c),!i.retry(c))throw i.mainError()}catch(l){EB(l,a,e),s(),n(l)}}})})}var K6=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Pr({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,i)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);AB(t)&&(this.queue.has(e)||this.queue.add(async n=>{await AE(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(o){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,o),o}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let i={};[...t.tags.keys()].forEach(o=>{o.startsWith(ia)&&(i[o]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>AB(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}};function AB(r){for(let e of r.tags.keys())if(e.startsWith(ia))return!0;return!1}var vE=50,_E={maxConnections:U6,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},q6=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??_E.maxConnections,this.maxConnections<1)throw new U("Connection Manager maxConnections must be greater than 0");this.connections=new _r,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>xm(n)),this.deny=(t.deny??[]).map(n=>xm(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??_E.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new ld({points:t.inboundConnectionThreshold??_E.inboundConnectionThreshold,duration:1}),this.connectionPruner=new $6({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:t.allow?.map(n=>se(n))}),this.dialQueue=new z6(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??F6,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:_u},connections:this.connections}),this.reconnectQueue=new K6({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let i of n.streams){let o=`${i.direction} ${i.protocol??"unnegotiated"}`;e[o]=(e[o]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let i of n){let o={};for(let s of i.streams){let a=`${s.direction} ${s.protocol??"unnegotiated"}`;o[a]=(o[a]??0)+1}for(let[s,a]of Object.entries(o))e[s]=e[s]??[],e[s].push(a)}let t={};for(let[n,i]of Object.entries(e)){i=i.sort((s,a)=>s-a);let o=Math.floor(i.length*.9);t[n]=i[o]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await kr(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Gr(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,i=!this.connections.has(n),o=this.connections.get(n)??[];o.push(t),this.connections.set(n,o),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,o=(this.connections.get(n)??[]).filter(s=>s.id!==t.id);this.connections.set(n,o),o.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Zn("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n}=M6(e);if(this.peerId.equals(n))throw new zu("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new G("dial-queue:already-connected")),a}let i=await this.dialQueue.dial(e,{...t,priority:t.priority??vE});if(i.status!=="open")throw new Hu("Remote closed connection during opening");let o=this.connections.get(i.remotePeer);o==null&&(o=[],this.connections.set(i.remotePeer,o));let s=!1;for(let a of o)if(a.id===i.id&&(s=!0),t.force!==!0&&a.id!==i.id&&a.remoteAddr.equals(i.remoteAddr))return i.abort(new sa("Duplicate multiaddr connection")),a;return s||o.push(i),i}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await i.close(t)}catch(o){i.abort(o)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>se(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var dQ=1e4,hQ="1.0.0",pQ="ping",mQ="ipfs",_B=32,gQ=!0,j6=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??mQ}/${pQ}/${hQ}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??dQ,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??gQ,this.timeout=new ho({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[tt]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),i=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),o=mo(i);t=Date.now(),await Promise.all([o.write(mn(_B),{signal:n}),o.read({bytes:_B,signal:n})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var W6=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()}),getAttributesFromYieldedValue:(n,i)=>({...i,providers:[...Array.isArray(i.providers)?i.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:H(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:H(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Gd("No content routers available");let n=this,i=new yn;for await(let o of un(...n.routers.map(s=>s.findProviders(e,t))))o!=null&&(o.multiaddrs.length>0&&await this.components.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),!i.has(o.id)&&(i.add(o.id),yield o))}async provide(e,t={}){if(this.routers.length===0)throw new Gd("No content routers available");await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Gd("No content routers available");await Promise.all(this.routers.map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Zn;await Promise.all(this.routers.map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Zn;return Promise.any(this.routers.map(async n=>n.get(e,t)))}};var G6=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,key:H(n,"base36")}),getAttributesFromYieldedValue:(n,i)=>({...i,peers:[...Array.isArray(i.peers)?i.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new ym("No peer routers available");if(e.toString()===this.peerId.toString())throw new C6("Should not try to find self");let n=this,i=un(...this.routers.map(o=>async function*(){try{yield await o.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let o of i)if(o!=null)return o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),o;throw new We}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new ym("No peer routers available");let n=this,i=Tn(1024);for await(let o of Or(async function*(){let s=un(...n.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of s)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))o!=null&&(o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs}),!i.has(o.id.toMultihash().bytes)&&(i.add(o.id.toMultihash().bytes),yield o))}};var X6=class extends Me{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=Ne([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=ye(),yield(await Er(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=Ne([this.walkController.signal,this.shutdownController.signal]);let t=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let i=mn(32),o=Date.now();for await(let s of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-o,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Dt(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,n)}catch(i){this.log.error("random walk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}};var IE=32,TE=64,Y6=class{log;topologies;handlers;components;constructor(e){this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new k6(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new P6(`Handler already registered for protocol ${e}`);let i=Wt.bind({ignoreUndefined:!0})({maxInboundStreams:IE,maxOutboundStreams:TE},n);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new U("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail;this.components.peerStore.get(t).then(n=>{for(let i of n.protocols){let o=this.topologies.get(i);if(o!=null)for(let s of o.values())s.filter?.has(t)!==!1&&(s.filter?.remove(t),s.onDisconnect?.(t))}}).catch(n=>{n.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,n)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,i=(n?.protocols??[]).filter(o=>!t.protocols.includes(o));for(let o of i){let s=this.topologies.get(o);if(s!=null)for(let a of s.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;for(let o of t){let s=this.topologies.get(o);if(s!=null)for(let a of s.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(i)!==!0&&(a.filter?.add(i),a.onConnect?.(i,n))}}};var Q6=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Hg({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Tc.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(t==null)throw new U("Transport must have a valid tag");if(this.transports.has(t))throw new U(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new B6(`No transport available for address ${String(e)}`);return t?.onProgress?.(new G("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Zn("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(o=>{t.errors.set(o.toString(),new R6)});let n=[];for(let[o,s]of this.transports.entries()){let a=s.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",o,c);let l=s.createListener({upgrader:this.components.upgrader}),u=this.listeners.get(o)??[];u==null&&(u=[],this.listeners.set(o,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let f=u.findIndex(h=>h===l);u.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),ox.matches(c)?t.ipv4.attempts++:sx.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),ox.matches(c)&&t.ipv4.success++,sx.matches(c)&&t.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",o,c,f),t.errors.set(c.toString(),f),f}))}}let i=await Promise.allSettled(n);if(!(i.length>0&&i.every(o=>o.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Tc.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new D6(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([o,s])=>`
  ${o}: ${`${s.stack??s}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var Wr="/multistream/1.0.0";var Z6=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},J6=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},e5=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function bm(r,e={}){let t=mo(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Oe(e.maxDataLength));let n=e?.lengthDecoder??Zt,i=e?.lengthEncoder??ht;return{read:async s=>{let a=-1,c=new oe;for(;;){c.append(await t.read({...s,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new Z6("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new e5("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new J6("message length too long");return t.read({...s,bytes:a})},write:async(s,a)=>{await t.write(new oe(i(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new oe(...s.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}var yQ=O(`
`);async function ku(r,e,t){await r.write(e,t)}async function IB(r,e,t){await r.writeV(e,t)}async function wQ(r,e){let t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==yQ[0])throw e.log.error("Invalid mss message - missing newline",t),new Be("Missing newline");return t.sublist(0,-1)}async function yc(r,e){let t=await wQ(r,e);return H(t.subarray())}async function vm(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return xQ(r,e[0],t);let n=bm(r,{...t,maxDataLength:1024}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Wr,i);let o=O(`${Wr}
`),s=O(`${i}
`);await IB(n,[o,s],t),t.log.trace("select: reading multistream-select header");let a=await yc(n,t);if(t.log.trace('select: read "%s"',a),a===Wr&&(t.log.trace("select: reading protocol response"),a=await yc(n,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:n.unwrap(),protocol:i};for(let c of e){t.log.trace('select: write "%s"',c),await ku(n,O(`${c}
`),t),t.log.trace("select: reading protocol response");let l=await yc(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new ps("protocol selection failed")}function xQ(r,e,t){let n=r.sink.bind(r),i=r.source,o=!1,s=!1,a=ye(),c=!1,l=!1,u=ye(),f=!1,h=!1,d=ye(),m=bm({sink:n,source:i},{...t,maxDataLength:1024});r.sink=async v=>{let{sink:b}=m.unwrap();await b(async function*(){let S=!1;for await(let T of v){if(l&&await u.promise,c)yield T;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Wr,e,T.byteLength);let D=`${e}
`;yield new oe(Uint8Array.from([19]),O(`${Wr}
`),ht(D.length),O(D),T).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Wr,e,T.byteLength),c=!0,l=!1,u.resolve(),g().catch(A=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,A)})}S=!0}S||await g()}())};async function g(){if(s){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}s=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await w()),f||(t.log.trace("optimistic: doing read protocol for %s stream",e),await x())}finally{s=!1,o=!0,a.resolve()}}async function w(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Wr,e),await m.writeV([O(`${Wr}
`),O(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Wr,e)}finally{c=!0,l=!1,u.resolve()}}async function x(){if(h){await d.promise;return}h=!0;try{t.log.trace("optimistic: reading multistream select header");let v=await yc(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',v),v===Wr&&(v=await yc(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',v,e),v!==e)throw new ps("protocol selection failed")}finally{f=!0,h=!1,d.resolve()}}if(r.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source}(),r.closeRead!=null){let v=r.closeRead.bind(r);r.closeRead=async b=>{o||await g().catch(S=>{t.log.error("could not negotiate protocol before close read",S)}),await v(b)}}if(r.closeWrite!=null){let v=r.closeWrite.bind(r);r.closeWrite=async b=>{o||await g().catch(S=>{t.log.error("could not negotiate protocol before close write",S)}),await v(b)}}if(r.close!=null){let v=r.close.bind(r);r.close=async b=>{let S=[];l&&S.push(u.promise),h&&S.push(d.promise),S.length>0?await Dt(Promise.all(S),b?.signal):(o=!0,s=!1,a.resolve()),await v(b)}}return{stream:r,protocol:e}}async function Em(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);let n=bm(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");let i=await yc(n,t);if(t.log.trace('handle: read "%s"',i),i===Wr){t.log.trace('handle: respond with "%s" for "%s"',Wr,i),await ku(n,O(`${Wr}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Wr,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await ku(n,O(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:n.unwrap(),protocol:i};if(i==="ls"){let o=new oe(...e.map(s=>Yi.single(O(`${s}
`))),O(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await ku(n,o,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log.trace('handle: respond with "na" for "%s"',i),await ku(n,O(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}var vQ=500,kE=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:i,close:o,abort:s,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=i,this._close=o,this._abort=s,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[xS]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new i0("the connection is being closed");if(this.status==="closed")throw new Hu("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new Ku("Cannot open protocol stream on limited connection");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){let t=AbortSignal.timeout(vQ);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}};function CB(r){return new kE(r)}function SQ(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return IE}function AQ(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??TE}function kB(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}var t5=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=new Map,t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=new Map,t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new O6(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=Ne([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,i=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await this.components.connectionManager.acceptIncomingConnection(e),!n)throw new L6("Connection denied");await this.shouldBlockConnection("denyInboundConnection",e),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(o){throw this.metrics.errors?.increment({inbound:!0}),o}finally{i.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getPeerId(),i;n!=null&&(i=at(n),await this.shouldBlockConnection("denyOutboundConnection",i,e));let o="outbound";return t.initiator===!1&&(o="inbound"),await this._performUpgrade(e,o,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),n}}async _performUpgrade(e,t,n){let i,o,s,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if(n?.skipProtection!==!0){let u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),l=await u.protect(e,n))}try{if(i=l,n?.skipEncryption!==!0){n?.onProgress?.(new G(`upgrader:encrypt-${t}-connection`)),{conn:i,remotePeer:o,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));let u={...l,...i};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",o,u)}else{let u=e.remoteAddr.getPeerId();if(u==null)throw new sa(`${t} connection that skipped encryption must have a peer id`);let f=at(u);c="native",o=f}if(o.equals(this.components.peerId)){let u=new zu("Can not dial self");throw e.abort(u),u}if(s=i,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new G(`upgrader:multiplex-${t}-connection`));let u=await(t==="inbound"?this._multiplexInbound({...l,...i},this.streamMuxers,n):this._multiplexOutbound({...l,...i},this.streamMuxers,n));a=u.muxerFactory,s=u.stream}}catch(u){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,u),u}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",o,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:s,muxerFactory:a,remotePeer:o,limits:n?.limits})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:i,upgradedConn:o,remotePeer:s,muxerFactory:a,limits:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:m=>{f!=null&&Promise.resolve().then(async()=>{let g=this.components.registrar.getProtocols(),w=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);let{stream:x,protocol:v}=await Em(m,g,{signal:w,log:m.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",v);let b=SQ(v,this.components.registrar);if(kB(v,"inbound",f)===b){let T=new c0(`Too many inbound protocol streams for protocol "${v}" - limit ${b}`);throw m.abort(T),T}m.source=x.source,m.sink=x.sink,m.protocol=v,x.closeWrite!=null&&(m.closeWrite=x.closeWrite),x.closeRead!=null&&(m.closeRead=x.closeRead),x.close!=null&&(m.close=x.close),await this.components.peerStore.merge(s,{protocols:[v]}),this.components.metrics?.trackProtocolStream(m,f),this._onStream({connection:f,stream:m,protocol:v})}).catch(async g=>{f.log.error("error handling incoming stream id %s - %e",m.id,g),m.timeline.close==null&&await m.close()})}}),u=async(m,g={})=>{if(l==null)throw new Iu("Connection is not multiplexed");f.log.trace("starting new stream for protocols %s",m);let w=await l.newStream();f.log.trace("started new stream %s for protocols %s",w.id,m);try{if(g.signal==null){w.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",m);let T=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:T}}w.log.trace("selecting protocol from protocols %s",m);let{stream:x,protocol:v}=await vm(w,m,{...g,log:w.log,yieldBytes:!0});w.log.trace("selected protocol %s",v);let b=AQ(v,this.components.registrar,g),S=kB(v,"outbound",f);if(S>=b){let T=new ca(`Too many outbound protocol streams for protocol "${v}" - ${S}/${b}`);throw w.abort(T),T}return await this.components.peerStore.merge(s,{protocols:[v]}),w.source=x.source,w.sink=x.sink,w.protocol=v,x.closeWrite!=null&&(w.closeWrite=x.closeWrite),x.closeRead!=null&&(w.closeRead=x.closeRead),x.close!=null&&(w.close=x.close),this.components.metrics?.trackProtocolStream(w,f),w}catch(x){throw f.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,m,x),w.timeline.close==null&&w.abort(x),x}},Promise.all([l.sink(o.source),o.sink(l.source)]).catch(m=>{f.log.error("error piping data through muxer - %e",m)}));let h=i.timeline;i.timeline=new Proxy(h,{set:(...m)=>(m[1]==="close"&&m[2]!=null&&h.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(g){f.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(g=>{f.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...m))}),i.timeline.upgraded=Date.now();let d=()=>{throw new Iu("Connection is not multiplexed")};return f=CB({remoteAddr:i.remoteAddr,remotePeer:s,status:"open",direction:n,timeline:i.timeline,multiplexer:l?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??d,getStreams:()=>l?.streams??[],close:async m=>{await l?.close(m),await i.close(m)},abort:m=>{i.abort(m),l?.abort(m)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f.__maConnTimeline=h,f}_onStream(e){let{connection:t,stream:n,protocol:i}=e,{handler:o,options:s}=this.components.registrar.getHandler(i);if(t.limits!=null&&s.runOnLimitedConnection!==!0)throw new Ku("Cannot open protocol stream on limited connection");o({connection:t,stream:n})}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let{stream:i,protocol:o}=await Em(e,n,{...t,log:e.log}),s=this.connectionEncrypters.get(o);if(s==null)throw new Tu(`no crypto module found for ${o}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,o),{...await s.secureInbound(i,t),protocol:o}}catch(i){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,i),new Tu(i.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let{stream:i,protocol:o}=await vm(e,n,{...t,log:e.log,yieldBytes:!0}),s=this.connectionEncrypters.get(o);if(s==null)throw new Tu(`no crypto module found for ${o}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,o),{...await s.secureOutbound(i,t),protocol:o}}catch(i){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,i),new Tu(i.message)}}async _multiplexOutbound(e,t,n){let i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);let{stream:o,protocol:s}=await vm(e,i,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",s);let a=t.get(s);return{stream:o,muxerFactory:a}}catch(o){throw e.log.error("error multiplexing outbound connection",o),new Iu(String(o))}}async _multiplexInbound(e,t,n){let i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{let{stream:o,protocol:s}=await Em(e,i,{...n,log:e.log}),a=t.get(s);return{stream:o,muxerFactory:a}}catch(o){throw e.log.error("error multiplexing inbound connection",o),new Iu(String(o))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};var r5=class extends Me{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new Me,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{let u=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||f},this.peerId=e.peerId,this.logger=e.logger??Ea(),this.log=this.logger.forComponent("libp2p"),this.services={};let i=e.nodeInfo?.name??d6,o=e.nodeInfo?.version??f6,s=this.components=cB({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:o,userAgent:e.nodeInfo?.userAgent??h6(i,o)},logger:this.logger,events:t,datastore:e.datastore??new bl,connectionGater:uB(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",tB(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),s.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new t5(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new Q6(this.components,e.transportManager)),this.configureComponent("connectionManager",new q6(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new j6(this.components,e.connectionMonitor)),this.configureComponent("registrar",new Y6(this.components)),this.configureComponent("addressManager",new _6(this.components,e.addresses));let a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new G6(this.components,{routers:a}));let c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new W6(this.components,{routers:c})),this.configureComponent("randomWalk",new X6(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(let l of Object.keys(e.services)){let u=e.services[l],f=u(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[Ro]!=null&&(this.log("registering service %s for content routing",l),c.push(f[Ro])),f[Do]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[Do])),f[Ic]!=null&&(this.log("registering service %s for peer discovery",l),f[Ic].addEventListener?.("peer",h=>{this.#e(h)}))}lB(s)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new yn;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new U("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new U("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){ka(e)&&(e=at(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let s=await this.peerStore.get(e);if(s.id.publicKey!=null)return s.id.publicKey}catch(s){if(s.name!=="NotFoundError")throw s}let n=Ve([O("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(n,t),o=tr(i);return await this.peerStore.patch(e,{publicKey:o}),o}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}};async function n5(r={}){r.privateKey??=await pf("Ed25519");let e=new r5({...await qL(r),peerId:C_(r.privateKey)});return r.start!==!1&&await e.start(),e}async function PB(r){let e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await oE(r.datastore,r.keychain));let t=mm(e);return t.datastore=t.datastore??r.datastore,await n5({...t,...e,start:!1})}async function RB(r={}){let e=r.datastore??new bl,t=r.blockstore??new Dp,n;_Q(r.libp2p)?n=r.libp2p:n=await PB({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e});let i=new $2({...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[Ap(),mp()],routers:r.routers??[Rp(n),Pp()],metrics:n.metrics});return r.start!==!1&&await i.start(),i}function _Q(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}function DB(){let r=mm();r.start=!1,r.addresses={listen:[]},r.transports=[a6(),u6()],r.peerDiscovery=[];let e={dcutr:r.services.dcutr,identify:r.services.identify,keychain:r.services.keychain,ping:r.services.ping};return{...r,start:!1,services:e}}var Xd=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,OB=new Set,PE=typeof process=="object"&&process?process:{},LB=(r,e,t,n)=>{typeof PE.emitWarning=="function"?PE.emitWarning(r,e,t,n):console.error(`[${t}] ${e}: ${r}`)},i5=globalThis.AbortController,NB=globalThis.AbortSignal;if(typeof i5>"u"){NB=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(n,i){this._onabort.push(i)}},i5=class{constructor(){e()}signal=new NB;abort(n){if(!this.signal.aborted){this.signal.reason=n,this.signal.aborted=!0;for(let i of this.signal._onabort)i(n);this.signal.onabort?.(n)}}};let r=PE.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{r&&(r=!1,LB("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var IQ=r=>!OB.has(r),gXe=Symbol("type"),wc=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),BB=r=>wc(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?Yd:null:null,Yd=class extends Array{constructor(e){super(e),this.fill(0)}},RE=class r{heap;length;static#e=!1;static create(e){let t=BB(e);if(!t)return[];r.#e=!0;let n=new r(e,t);return r.#e=!1,n}constructor(e,t){if(!r.#e)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},o5=class r{#e;#r;#n;#m;#u;#A;#y;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#a;#s;#c;#i;#t;#l;#w;#p;#f;#b;#d;#v;#E;#g;#x;#_;#h;#R;static unsafeExposeInternals(e){return{starts:e.#E,ttls:e.#g,sizes:e.#v,keyMap:e.#c,keyList:e.#i,valList:e.#t,next:e.#l,prev:e.#w,get head(){return e.#p},get tail(){return e.#f},free:e.#b,isBackgroundFetch:t=>e.#o(t),backgroundFetch:(t,n,i,o)=>e.#M(t,n,i,o),moveToTail:t=>e.#O(t),indexes:t=>e.#I(t),rindexes:t=>e.#T(t),isStale:t=>e.#S(t)}}get max(){return this.#e}get maxSize(){return this.#r}get calculatedSize(){return this.#s}get size(){return this.#a}get fetchMethod(){return this.#A}get memoMethod(){return this.#y}get dispose(){return this.#n}get onInsert(){return this.#m}get disposeAfter(){return this.#u}constructor(e){let{max:t=0,ttl:n,ttlResolution:i=1,ttlAutopurge:o,updateAgeOnGet:s,updateAgeOnHas:a,allowStale:c,dispose:l,onInsert:u,disposeAfter:f,noDisposeOnSet:h,noUpdateTTL:d,maxSize:m=0,maxEntrySize:g=0,sizeCalculation:w,fetchMethod:x,memoMethod:v,noDeleteOnFetchRejection:b,noDeleteOnStaleGet:S,allowStaleOnFetchRejection:T,allowStaleOnFetchAbort:D,ignoreFetchAbort:A}=e;if(t!==0&&!wc(t))throw new TypeError("max option must be a nonnegative integer");let I=t?BB(t):Array;if(!I)throw new Error("invalid max value: "+t);if(this.#e=t,this.#r=m,this.maxEntrySize=g||this.#r,this.sizeCalculation=w,this.sizeCalculation){if(!this.#r&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(v!==void 0&&typeof v!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#y=v,x!==void 0&&typeof x!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#A=x,this.#_=!!x,this.#c=new Map,this.#i=new Array(t).fill(void 0),this.#t=new Array(t).fill(void 0),this.#l=new I(t),this.#w=new I(t),this.#p=0,this.#f=0,this.#b=RE.create(t),this.#a=0,this.#s=0,typeof l=="function"&&(this.#n=l),typeof u=="function"&&(this.#m=u),typeof f=="function"?(this.#u=f,this.#d=[]):(this.#u=void 0,this.#d=void 0),this.#x=!!this.#n,this.#R=!!this.#m,this.#h=!!this.#u,this.noDisposeOnSet=!!h,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!b,this.allowStaleOnFetchRejection=!!T,this.allowStaleOnFetchAbort=!!D,this.ignoreFetchAbort=!!A,this.maxEntrySize!==0){if(this.#r!==0&&!wc(this.#r))throw new TypeError("maxSize must be a positive integer if specified");if(!wc(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#z()}if(this.allowStale=!!c,this.noDeleteOnStaleGet=!!S,this.updateAgeOnGet=!!s,this.updateAgeOnHas=!!a,this.ttlResolution=wc(i)||i===0?i:1,this.ttlAutopurge=!!o,this.ttl=n||0,this.ttl){if(!wc(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#k()}if(this.#e===0&&this.ttl===0&&this.#r===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#e&&!this.#r){let k="LRU_CACHE_UNBOUNDED";IQ(k)&&(OB.add(k),LB("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",k,r))}}getRemainingTTL(e){return this.#c.has(e)?1/0:0}#k(){let e=new Yd(this.#e),t=new Yd(this.#e);this.#g=e,this.#E=t,this.#U=(o,s,a=Xd.now())=>{if(t[o]=s!==0?a:0,e[o]=s,s!==0&&this.ttlAutopurge){let c=setTimeout(()=>{this.#S(o)&&this.#C(this.#i[o],"expire")},s+1);c.unref&&c.unref()}},this.#D=o=>{t[o]=e[o]!==0?Xd.now():0},this.#P=(o,s)=>{if(e[s]){let a=e[s],c=t[s];if(!a||!c)return;o.ttl=a,o.start=c,o.now=n||i();let l=o.now-c;o.remainingTTL=a-l}};let n=0,i=()=>{let o=Xd.now();if(this.ttlResolution>0){n=o;let s=setTimeout(()=>n=0,this.ttlResolution);s.unref&&s.unref()}return o};this.getRemainingTTL=o=>{let s=this.#c.get(o);if(s===void 0)return 0;let a=e[s],c=t[s];if(!a||!c)return 1/0;let l=(n||i())-c;return a-l},this.#S=o=>{let s=t[o],a=e[o];return!!a&&!!s&&(n||i())-s>a}}#D=()=>{};#P=()=>{};#U=()=>{};#S=()=>!1;#z(){let e=new Yd(this.#e);this.#s=0,this.#v=e,this.#N=t=>{this.#s-=e[t],e[t]=0},this.#F=(t,n,i,o)=>{if(this.#o(n))return 0;if(!wc(i))if(o){if(typeof o!="function")throw new TypeError("sizeCalculation must be a function");if(i=o(n,t),!wc(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i},this.#L=(t,n,i)=>{if(e[t]=n,this.#r){let o=this.#r-e[t];for(;this.#s>o;)this.#B(!0)}this.#s+=e[t],i&&(i.entrySize=n,i.totalCalculatedSize=this.#s)}}#N=e=>{};#L=(e,t,n)=>{};#F=(e,t,n,i)=>{if(n||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#I({allowStale:e=this.allowStale}={}){if(this.#a)for(let t=this.#f;!(!this.#$(t)||((e||!this.#S(t))&&(yield t),t===this.#p));)t=this.#w[t]}*#T({allowStale:e=this.allowStale}={}){if(this.#a)for(let t=this.#p;!(!this.#$(t)||((e||!this.#S(t))&&(yield t),t===this.#f));)t=this.#l[t]}#$(e){return e!==void 0&&this.#c.get(this.#i[e])===e}*entries(){for(let e of this.#I())this.#t[e]!==void 0&&this.#i[e]!==void 0&&!this.#o(this.#t[e])&&(yield[this.#i[e],this.#t[e]])}*rentries(){for(let e of this.#T())this.#t[e]!==void 0&&this.#i[e]!==void 0&&!this.#o(this.#t[e])&&(yield[this.#i[e],this.#t[e]])}*keys(){for(let e of this.#I()){let t=this.#i[e];t!==void 0&&!this.#o(this.#t[e])&&(yield t)}}*rkeys(){for(let e of this.#T()){let t=this.#i[e];t!==void 0&&!this.#o(this.#t[e])&&(yield t)}}*values(){for(let e of this.#I())this.#t[e]!==void 0&&!this.#o(this.#t[e])&&(yield this.#t[e])}*rvalues(){for(let e of this.#T())this.#t[e]!==void 0&&!this.#o(this.#t[e])&&(yield this.#t[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let n of this.#I()){let i=this.#t[n],o=this.#o(i)?i.__staleWhileFetching:i;if(o!==void 0&&e(o,this.#i[n],this))return this.get(this.#i[n],t)}}forEach(e,t=this){for(let n of this.#I()){let i=this.#t[n],o=this.#o(i)?i.__staleWhileFetching:i;o!==void 0&&e.call(t,o,this.#i[n],this)}}rforEach(e,t=this){for(let n of this.#T()){let i=this.#t[n],o=this.#o(i)?i.__staleWhileFetching:i;o!==void 0&&e.call(t,o,this.#i[n],this)}}purgeStale(){let e=!1;for(let t of this.#T({allowStale:!0}))this.#S(t)&&(this.#C(this.#i[t],"expire"),e=!0);return e}info(e){let t=this.#c.get(e);if(t===void 0)return;let n=this.#t[t],i=this.#o(n)?n.__staleWhileFetching:n;if(i===void 0)return;let o={value:i};if(this.#g&&this.#E){let s=this.#g[t],a=this.#E[t];if(s&&a){let c=s-(Xd.now()-a);o.ttl=c,o.start=Date.now()}}return this.#v&&(o.size=this.#v[t]),o}dump(){let e=[];for(let t of this.#I({allowStale:!0})){let n=this.#i[t],i=this.#t[t],o=this.#o(i)?i.__staleWhileFetching:i;if(o===void 0||n===void 0)continue;let s={value:o};if(this.#g&&this.#E){s.ttl=this.#g[t];let a=Xd.now()-this.#E[t];s.start=Math.floor(Date.now()-a)}this.#v&&(s.size=this.#v[t]),e.unshift([n,s])}return e}load(e){this.clear();for(let[t,n]of e){if(n.start){let i=Date.now()-n.start;n.start=Xd.now()-i}this.set(t,n.value,n)}}set(e,t,n={}){if(t===void 0)return this.delete(e),this;let{ttl:i=this.ttl,start:o,noDisposeOnSet:s=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:c}=n,{noUpdateTTL:l=this.noUpdateTTL}=n,u=this.#F(e,t,n.size||0,a);if(this.maxEntrySize&&u>this.maxEntrySize)return c&&(c.set="miss",c.maxEntrySizeExceeded=!0),this.#C(e,"set"),this;let f=this.#a===0?void 0:this.#c.get(e);if(f===void 0)f=this.#a===0?this.#f:this.#b.length!==0?this.#b.pop():this.#a===this.#e?this.#B(!1):this.#a,this.#i[f]=e,this.#t[f]=t,this.#c.set(e,f),this.#l[this.#f]=f,this.#w[f]=this.#f,this.#f=f,this.#a++,this.#L(f,u,c),c&&(c.set="add"),l=!1,this.#R&&this.#m?.(t,e,"add");else{this.#O(f);let h=this.#t[f];if(t!==h){if(this.#_&&this.#o(h)){h.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:d}=h;d!==void 0&&!s&&(this.#x&&this.#n?.(d,e,"set"),this.#h&&this.#d?.push([d,e,"set"]))}else s||(this.#x&&this.#n?.(h,e,"set"),this.#h&&this.#d?.push([h,e,"set"]));if(this.#N(f),this.#L(f,u,c),this.#t[f]=t,c){c.set="replace";let d=h&&this.#o(h)?h.__staleWhileFetching:h;d!==void 0&&(c.oldValue=d)}}else c&&(c.set="update");this.#R&&this.onInsert?.(t,e,t===h?"update":"replace")}if(i!==0&&!this.#g&&this.#k(),this.#g&&(l||this.#U(f,i,o),c&&this.#P(c,f)),!s&&this.#h&&this.#d){let h=this.#d,d;for(;d=h?.shift();)this.#u?.(...d)}return this}pop(){try{for(;this.#a;){let e=this.#t[this.#p];if(this.#B(!0),this.#o(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#h&&this.#d){let e=this.#d,t;for(;t=e?.shift();)this.#u?.(...t)}}}#B(e){let t=this.#p,n=this.#i[t],i=this.#t[t];return this.#_&&this.#o(i)?i.__abortController.abort(new Error("evicted")):(this.#x||this.#h)&&(this.#x&&this.#n?.(i,n,"evict"),this.#h&&this.#d?.push([i,n,"evict"])),this.#N(t),e&&(this.#i[t]=void 0,this.#t[t]=void 0,this.#b.push(t)),this.#a===1?(this.#p=this.#f=0,this.#b.length=0):this.#p=this.#l[t],this.#c.delete(n),this.#a--,t}has(e,t={}){let{updateAgeOnHas:n=this.updateAgeOnHas,status:i}=t,o=this.#c.get(e);if(o!==void 0){let s=this.#t[o];if(this.#o(s)&&s.__staleWhileFetching===void 0)return!1;if(this.#S(o))i&&(i.has="stale",this.#P(i,o));else return n&&this.#D(o),i&&(i.has="hit",this.#P(i,o)),!0}else i&&(i.has="miss");return!1}peek(e,t={}){let{allowStale:n=this.allowStale}=t,i=this.#c.get(e);if(i===void 0||!n&&this.#S(i))return;let o=this.#t[i];return this.#o(o)?o.__staleWhileFetching:o}#M(e,t,n,i){let o=t===void 0?void 0:this.#t[t];if(this.#o(o))return o;let s=new i5,{signal:a}=n;a?.addEventListener("abort",()=>s.abort(a.reason),{signal:s.signal});let c={signal:s.signal,options:n,context:i},l=(g,w=!1)=>{let{aborted:x}=s.signal,v=n.ignoreFetchAbort&&g!==void 0;if(n.status&&(x&&!w?(n.status.fetchAborted=!0,n.status.fetchError=s.signal.reason,v&&(n.status.fetchAbortIgnored=!0)):n.status.fetchResolved=!0),x&&!v&&!w)return f(s.signal.reason);let b=d;return this.#t[t]===d&&(g===void 0?b.__staleWhileFetching?this.#t[t]=b.__staleWhileFetching:this.#C(e,"fetch"):(n.status&&(n.status.fetchUpdated=!0),this.set(e,g,c.options))),g},u=g=>(n.status&&(n.status.fetchRejected=!0,n.status.fetchError=g),f(g)),f=g=>{let{aborted:w}=s.signal,x=w&&n.allowStaleOnFetchAbort,v=x||n.allowStaleOnFetchRejection,b=v||n.noDeleteOnFetchRejection,S=d;if(this.#t[t]===d&&(!b||S.__staleWhileFetching===void 0?this.#C(e,"fetch"):x||(this.#t[t]=S.__staleWhileFetching)),v)return n.status&&S.__staleWhileFetching!==void 0&&(n.status.returnedStale=!0),S.__staleWhileFetching;if(S.__returned===S)throw g},h=(g,w)=>{let x=this.#A?.(e,o,c);x&&x instanceof Promise&&x.then(v=>g(v===void 0?void 0:v),w),s.signal.addEventListener("abort",()=>{(!n.ignoreFetchAbort||n.allowStaleOnFetchAbort)&&(g(void 0),n.allowStaleOnFetchAbort&&(g=v=>l(v,!0)))})};n.status&&(n.status.fetchDispatched=!0);let d=new Promise(h).then(l,u),m=Object.assign(d,{__abortController:s,__staleWhileFetching:o,__returned:void 0});return t===void 0?(this.set(e,m,{...c.options,status:void 0}),t=this.#c.get(e)):this.#t[t]=m,m}#o(e){if(!this.#_)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof i5}async fetch(e,t={}){let{allowStale:n=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:o=this.noDeleteOnStaleGet,ttl:s=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:c=0,sizeCalculation:l=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:f=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:h=this.allowStaleOnFetchRejection,ignoreFetchAbort:d=this.ignoreFetchAbort,allowStaleOnFetchAbort:m=this.allowStaleOnFetchAbort,context:g,forceRefresh:w=!1,status:x,signal:v}=t;if(!this.#_)return x&&(x.fetch="get"),this.get(e,{allowStale:n,updateAgeOnGet:i,noDeleteOnStaleGet:o,status:x});let b={allowStale:n,updateAgeOnGet:i,noDeleteOnStaleGet:o,ttl:s,noDisposeOnSet:a,size:c,sizeCalculation:l,noUpdateTTL:u,noDeleteOnFetchRejection:f,allowStaleOnFetchRejection:h,allowStaleOnFetchAbort:m,ignoreFetchAbort:d,status:x,signal:v},S=this.#c.get(e);if(S===void 0){x&&(x.fetch="miss");let T=this.#M(e,S,b,g);return T.__returned=T}else{let T=this.#t[S];if(this.#o(T)){let Q=n&&T.__staleWhileFetching!==void 0;return x&&(x.fetch="inflight",Q&&(x.returnedStale=!0)),Q?T.__staleWhileFetching:T.__returned=T}let D=this.#S(S);if(!w&&!D)return x&&(x.fetch="hit"),this.#O(S),i&&this.#D(S),x&&this.#P(x,S),T;let A=this.#M(e,S,b,g),k=A.__staleWhileFetching!==void 0&&n;return x&&(x.fetch=D?"stale":"refresh",k&&D&&(x.returnedStale=!0)),k?A.__staleWhileFetching:A.__returned=A}}async forceFetch(e,t={}){let n=await this.fetch(e,t);if(n===void 0)throw new Error("fetch() returned undefined");return n}memo(e,t={}){let n=this.#y;if(!n)throw new Error("no memoMethod provided to constructor");let{context:i,forceRefresh:o,...s}=t,a=this.get(e,s);if(!o&&a!==void 0)return a;let c=n(e,a,{options:s,context:i});return this.set(e,c,s),c}get(e,t={}){let{allowStale:n=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:o=this.noDeleteOnStaleGet,status:s}=t,a=this.#c.get(e);if(a!==void 0){let c=this.#t[a],l=this.#o(c);return s&&this.#P(s,a),this.#S(a)?(s&&(s.get="stale"),l?(s&&n&&c.__staleWhileFetching!==void 0&&(s.returnedStale=!0),n?c.__staleWhileFetching:void 0):(o||this.#C(e,"expire"),s&&n&&(s.returnedStale=!0),n?c:void 0)):(s&&(s.get="hit"),l?c.__staleWhileFetching:(this.#O(a),i&&this.#D(a),c))}else s&&(s.get="miss")}#H(e,t){this.#w[t]=e,this.#l[e]=t}#O(e){e!==this.#f&&(e===this.#p?this.#p=this.#l[e]:this.#H(this.#w[e],this.#l[e]),this.#H(this.#f,e),this.#f=e)}delete(e){return this.#C(e,"delete")}#C(e,t){let n=!1;if(this.#a!==0){let i=this.#c.get(e);if(i!==void 0)if(n=!0,this.#a===1)this.#V(t);else{this.#N(i);let o=this.#t[i];if(this.#o(o)?o.__abortController.abort(new Error("deleted")):(this.#x||this.#h)&&(this.#x&&this.#n?.(o,e,t),this.#h&&this.#d?.push([o,e,t])),this.#c.delete(e),this.#i[i]=void 0,this.#t[i]=void 0,i===this.#f)this.#f=this.#w[i];else if(i===this.#p)this.#p=this.#l[i];else{let s=this.#w[i];this.#l[s]=this.#l[i];let a=this.#l[i];this.#w[a]=this.#w[i]}this.#a--,this.#b.push(i)}}if(this.#h&&this.#d?.length){let i=this.#d,o;for(;o=i?.shift();)this.#u?.(...o)}return n}clear(){return this.#V("delete")}#V(e){for(let t of this.#T({allowStale:!0})){let n=this.#t[t];if(this.#o(n))n.__abortController.abort(new Error("deleted"));else{let i=this.#i[t];this.#x&&this.#n?.(n,i,e),this.#h&&this.#d?.push([n,i,e])}}if(this.#c.clear(),this.#t.fill(void 0),this.#i.fill(void 0),this.#g&&this.#E&&(this.#g.fill(0),this.#E.fill(0)),this.#v&&this.#v.fill(0),this.#p=0,this.#f=0,this.#b.length=0,this.#s=0,this.#a=0,this.#h&&this.#d){let t=this.#d,n;for(;n=t?.shift();)this.#u?.(...n)}}};var mi=class extends Error{static name="InvalidRangeError";constructor(e="Invalid range request"){super(e),this.name="InvalidRangeError"}},s5=class extends Error{static name="NoContentError";constructor(e="No content found"){super(e),this.name="NoContentError"}},a5=class extends Error{static name="SubdomainNotSupportedError";constructor(e="Subdomain not supported"){super(e),this.name="SubdomainNotSupportedError"}};function MB(r,e){if(r==null)return;if(r instanceof Headers)return r.get(e)??void 0;if(Array.isArray(r))return r.find(([i])=>i.toLowerCase()===e.toLowerCase())?.[1];let t=Object.keys(r).find(n=>n.toLowerCase()===e.toLowerCase());if(t!=null)return r[t]}function UB(r,e,t){if((r??0)>(e??1/0))throw new mi("Invalid range: Range-start index is greater than range-end index.");if(r!=null&&(e??0)>=(t??1/0))throw new mi("Invalid range: Range-end index is greater than or equal to the size of the file.");if(r==null&&(e??0)>(t??1/0))throw new mi("Invalid range: Range-end index is greater than the size of the file.");if(r!=null&&r<0)throw new mi("Invalid range: Range-start index cannot be negative.");if(r!=null&&e!=null)return{byteSize:e-r+1,start:r,end:e};if(r==null&&e!=null)return t==null?{end:e}:e===t?{byteSize:t,start:0,end:t-1}:{byteSize:e,start:t-e,end:t-1};if(r!=null&&e==null){if(t==null)return{start:r};let n=t-1;return{byteSize:t-r,start:r,end:n}}return{byteSize:t,start:0,end:t!=null?t-1:0}}function FB({ttl:r,protocol:e,response:t}){if(t.headers.has("cache-control"))return;let n;e==="ipfs"?n="public, max-age=29030400, immutable":r==null?n="public, max-age=300":n=`public, max-age=${r}`,t.headers.set("cache-control",n)}function $B({byteStart:r,byteEnd:e,byteSize:t}){let n=t??"*";if((e??0)>=(t??1/0))throw new mi("Invalid range: Range-end index is greater than or equal to the size of the file.");if((r??0)>=(t??1/0))throw new mi("Invalid range: Range-start index is greater than or equal to the size of the file.");if(r!=null&&e==null)return t==null?`bytes */${n}`:`bytes ${r}-${t-1}/${t}`;if(r==null&&e!=null){if(t==null)return`bytes */${n}`;let i=t-1;return`bytes ${i-e+1}-${i}/${t}`}return r==null&&e==null?`bytes */${n}`:`bytes ${r}-${e}/${n}`}function c5(r,e){e!=null&&r.headers.set("X-Ipfs-Roots",DE(e))}function DE(r){return r.map(e=>e.toV1().toString()).join(",")}function TQ(r){return typeof r=="string"?r.length:r instanceof ArrayBuffer||r instanceof Uint8Array?r.byteLength:r instanceof Blob?r.size:(r instanceof ReadableStream,null)}function CQ(r){let e=r.match(/^bytes=(?<start>\d+)?-(?<end>\d+)?$/);if(e?.groups==null)throw new mi("Invalid range request");let{start:t,end:n}=e.groups;return{start:t,end:n}}var l5=class{headers;isRangeRequest;_fileSize;_body=null;rangeRequestHeader;log;requestRangeStart;requestRangeEnd;byteStart;byteEnd;byteSize;constructor(e,t){if(this.headers=t,this.log=e.forComponent("helia:verified-fetch:byte-range-context"),this.rangeRequestHeader=MB(this.headers,"Range"),this.rangeRequestHeader!=null){this.isRangeRequest=!0,this.log.trace("range request detected");try{let{start:n,end:i}=CQ(this.rangeRequestHeader);this.requestRangeStart=n!=null?parseInt(n):null,this.requestRangeEnd=i!=null?parseInt(i):null}catch(n){this.log.error("error parsing range request header: %o",n),this.requestRangeStart=null,this.requestRangeEnd=null}this.setOffsetDetails()}else this.log.trace("no range request detected"),this.isRangeRequest=!1,this.requestRangeStart=null,this.requestRangeEnd=null}setBody(e){this._body=e,this.setFileSize(this._fileSize??TQ(e)),this.log.trace("set request body with fileSize %o",this._fileSize)}getBody(){let e=this._body;if(e==null)return this.log.trace("body is null"),e;if(!this.isRangeRequest||!this.isValidRangeRequest)return this.log.trace("returning body unmodified for non-range, or invalid range, request"),e;let t=this.byteStart,n=this.byteEnd,i=this.byteSize;return t!=null||n!=null?(this.log.trace("returning body with byteStart=%o, byteEnd=%o, byteSize=%o",t,n,i),e instanceof ReadableStream?e:this.getSlicedBody(e)):(this.log.error("returning unmodified body for valid range request"),e)}getSlicedBody(e){let t=this.byteStart??0,n;return this.byteEnd!=null&&this.byteStart!=null?n=this.byteEnd-this.byteStart+1:n=void 0,this.log.trace("slicing body with offset=%o and length=%o",t,n),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(t,n!==void 0?t+n:void 0):e}setFileSize(e){this._fileSize=e!=null?Number(e):null,this.log.trace("set _fileSize to %o",this._fileSize),this.setOffsetDetails()}getFileSize(){return this._fileSize}isValidByteStart(){return!(this.byteStart!=null&&(this.byteStart<0||this._fileSize!=null&&this.byteStart>=this._fileSize||this.byteEnd!=null&&this.byteStart>this.byteEnd))}isValidByteEnd(){return!(this.byteEnd!=null&&(this.byteEnd<0||this._fileSize!=null&&this.byteEnd>=this._fileSize||this.byteStart!=null&&this.byteEnd<this.byteStart))}get isValidRangeRequest(){if(!this.isRangeRequest)return!1;if(this.requestRangeStart==null&&this.requestRangeEnd==null)return this.log.trace("invalid range request, range request values not provided"),!1;if(!this.isValidByteStart())return this.log.trace("invalid range request, byteStart is less than 0 or greater than fileSize"),!1;if(!this.isValidByteEnd())return this.log.trace("invalid range request, byteEnd is less than 0 or greater than fileSize"),!1;if(this.requestRangeEnd!=null&&this.requestRangeStart!=null){if(this.requestRangeStart>this.requestRangeEnd)return this.log.trace("invalid range request, start is greater than end"),!1;if(this.requestRangeStart<0)return this.log.trace("invalid range request, start is less than 0"),!1;if(this.requestRangeEnd<0)return this.log.trace("invalid range request, end is less than 0"),!1}return this.byteEnd==null&&this.byteStart==null&&this.byteSize==null?(this.log.trace("invalid range request, could not calculate byteStart, byteEnd, or byteSize"),!1):!0}get offset(){return this.byteStart??0}get length(){return this.byteEnd!=null&&this.byteStart!=null?this.byteEnd-this.byteStart+1:this.byteEnd!=null?this.byteEnd+1:this.byteSize}setOffsetDetails(){if(this.requestRangeStart==null&&this.requestRangeEnd==null){this.log.trace("requestRangeStart and requestRangeEnd are null");return}try{let{start:e,end:t,byteSize:n}=UB(this.requestRangeStart??void 0,this.requestRangeEnd??void 0,this._fileSize??void 0);this.log.trace("set byteStart to %o, byteEnd to %o, byteSize to %o",e,t,n),this.byteStart=e,this.byteEnd=t,this.byteSize=n}catch(e){this.log.error("error setting offset details: %o",e),this.byteStart=void 0,this.byteEnd=void 0,this.byteSize=void 0}}get contentRangeHeaderValue(){if(!this.isValidRangeRequest)throw this.log.error("cannot get contentRangeHeaderValue for invalid range request"),new mi("Invalid range request");return $B({byteStart:this.byteStart,byteEnd:this.byteEnd,byteSize:this._fileSize??void 0})}};var Mt=class{codes=[];log;pluginOptions;constructor(e){let t=this.constructor.name.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();this.log=e.logger.forComponent(t),this.pluginOptions=e}canHandle(e){throw new Error("Not implemented")}async handle(e){throw new Error("Not implemented")}};var u5=class extends Mt{canHandle(e){return e.byteRangeContext==null}async handle(e){return e.byteRangeContext=new l5(this.pluginOptions.logger,e.options?.headers),e.modified++,null}};var LE=it(f5(),1);var BE=40;function ME(r,e){if(!r.length)throw new Error("Unexpected end of data");let t=LE.default.decode(r);return e.seek(LE.default.decode.bytes),t}function UE(r){let e=new DataView(r.buffer,r.byteOffset,r.byteLength),t=0;return{version:2,characteristics:[e.getBigUint64(t,!0),e.getBigUint64(t+=8,!0)],dataOffset:Number(e.getBigUint64(t+=8,!0)),dataSize:Number(e.getBigUint64(t+=8,!0)),indexOffset:Number(e.getBigUint64(t+=8,!0))}}var xc={Null:r=>r===null?r:void 0,Int:r=>Number.isInteger(r)?r:void 0,Float:r=>typeof r=="number"&&Number.isFinite(r)?r:void 0,String:r=>typeof r=="string"?r:void 0,Bool:r=>typeof r=="boolean"?r:void 0,Bytes:r=>r instanceof Uint8Array?r:void 0,Link:r=>r!==null&&typeof r=="object"&&r.asCID===r?r:void 0,List:r=>Array.isArray(r)?r:void 0,Map:r=>r!==null&&typeof r=="object"&&r.asCID!==r&&!Array.isArray(r)&&!(r instanceof Uint8Array)?r:void 0},Sm={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":xc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(xc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=Sm["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let i=e;i<r.length;i++){let o=r[i];if(o=Sm["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;n.push(o)}return n}}return r}},Int:xc.Int,CarV1HeaderOrV2Pragma:r=>{if(xc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let i=0;i<e.length;i++){let[o,s]=e[i];switch(o){case"roots":{let a=Sm["CarV1HeaderOrV2Pragma > roots (anon)"](r[o]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=Sm.Int(r[o]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},Am={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":xc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(xc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=Am["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let i=e;i<r.length;i++){let o=r[i];if(o=Am["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;n.push(o)}return n}}return r}},Int:xc.Int,CarV1HeaderOrV2Pragma:r=>{if(xc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let i=0;i<e.length;i++){let[o,s]=e[i];switch(o){case"roots":{let a=Am["CarV1HeaderOrV2Pragma > roots (anon)"](s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=Am.Int(s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},FE={toTyped:Sm.CarV1HeaderOrV2Pragma,toRepresentation:Am.CarV1HeaderOrV2Pragma};var qXe=I7();var qQ=it(f5(),1);var YXe=[new Y(_.map,2),new Y(_.string,"version"),new Y(_.uint,1),new Y(_.string,"roots")],QXe=new Y(_.tag,42);async function $E(r,e){let t=ME(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR header (zero length)");let n=await r.exactly(t,!0),i=Ta(n);if(FE.toTyped(i)===void 0)throw new Error("Invalid CAR header format");if(i.version!==1&&i.version!==2||e!==void 0&&i.version!==e)throw new Error(`Invalid CAR version: ${i.version}${e!==void 0?` (expected ${e})`:""}`);if(i.version===1){if(!Array.isArray(i.roots))throw new Error("Invalid CAR header format");return i}if(i.roots!==void 0)throw new Error("Invalid CAR header format");let o=UE(await r.exactly(BE,!0));r.seek(o.dataOffset-r.pos);let s=await $E(r,1);return Object.assign(s,o)}function _m(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t,n=!1){if(t>r.length-e)throw new Error("Unexpected end of data");let i=r.subarray(e,e+t);return n&&(e+=t),i},seek(t){e+=t},get pos(){return e}}}var HE=it(f5(),1),ZB=1;function VE(r){let e=Af({version:ZB,roots:r}),t=HE.default.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function JB(r){return{async setRoots(e){let t=VE(e);await r.write(t)},async writeBlock(e){let{cid:t,bytes:n}=e;await r.write(new Uint8Array(HE.default.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()},version(){return ZB}}}function d5(){}function eM(){let r=[],e=null,t=d5,n=!1,i=null,o=d5,s=()=>(e||(e=new Promise(l=>{t=()=>{e=null,t=d5,l()}})),e),a={write(l){r.push(l);let u=s();return o(),u},async end(){n=!0;let l=s();o(),await l}},c={async next(){let l=r.shift();return l?(r.length===0&&t(),{done:!1,value:l}):n?(t(),{done:!0,value:void 0}):(i||(i=new Promise(u=>{o=()=>(i=null,o=d5,u(c.next()))})),i)}};return{writer:a,iterator:c}}var Im=class r{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");let t=W.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}version(){return this._encoder.version()}static create(e){e=XQ(e);let{encoder:t,iterator:n}=tM(),i=new r(e,t),o=new h5(n);return{writer:i,out:o}}static createAppender(){let{encoder:e,iterator:t}=tM();e.setRoots=()=>Promise.resolve();let n=new r([],e),i=new h5(t);return{writer:n,out:i}}static async updateRootsInBytes(e,t){let n=_m(e);await $E(n);let i=VE(t);if(Number(n.pos)!==i.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${i.length} bytes)`);return e.set(i,0),e}},h5=class{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}};function tM(){let r=eM(),{writer:e,iterator:t}=r;return{encoder:JB(e),iterator:t}}function XQ(r){if(r===void 0)return[];if(!Array.isArray(r)){let t=W.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}let e=[];for(let t of r){let n=W.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}var YQ=1,zE=class{components;constructor(e,t){this.components=e}async import(e,t){await Sr(this.components.blockstore.putMany(Nt(e.blocks(),({cid:n,bytes:i})=>({cid:n,block:i})),t))}async export(e,t,n){let i=ye(),o=Array.isArray(e)?e:[e],s=new kn({concurrency:YQ});s.on("idle",()=>{i.resolve()}),s.on("error",a=>{s.clear(),i.reject(a)});for(let a of o)s.add(async()=>{await this.#e(a,s,async(c,l)=>{n?.blockFilter?.has(c.multihash.bytes)!==!0&&(n?.blockFilter?.add(c.multihash.bytes),await t.put({cid:c,bytes:l}))},n)}).catch(()=>{});try{await i.promise}finally{await t.close()}}async*stream(e,t){let{writer:n,out:i}=Im.create(e);this.export(e,n,t).catch(()=>{});for await(let o of i)yield o}async#e(e,t,n,i){let o=await this.components.getCodec(e.code),s=await this.components.blockstore.get(e,i);await n(e,s);let a=Sg({bytes:s,cid:e,codec:o});for await(let[,c]of a.links())t.add(async()=>{await this.#e(c,t,n,i)})}};function rM(r,e={}){return new zE(r,e)}function Tm(r,e={}){let t=Oa(r),n={_cancelled:!1,async start(){this._cancelled=!1},async pull(i){try{let{value:o,done:s}=await t.next();if(this._cancelled)return;if(s===!0){i.close();return}i.enqueue(o)}catch(o){i.error(o)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(n,e)}function KE(r,e,t){Object.defineProperty(r,e,{enumerable:!0,configurable:!1,set:()=>{},get:()=>t})}function Js(r,e){KE(r,"type",e)}function ea(r,e){KE(r,"url",e)}function nM(r){KE(r,"redirected",!0)}function QQ(r,e,t){let n=new Response(e,{...t??{},status:200,statusText:"OK"});return t?.redirected===!0&&nM(n),Js(n,"basic"),ea(n,r),n}function Qd(r,e,t){let n=new Response(e,{...t??{},status:502,statusText:"Bad Gateway"});return Js(n,"basic"),ea(n,r),n}function m5(r,e,t){let n=new Response(e,{...t??{},status:501,statusText:"Not Implemented"});return n.headers.set("X-Content-Type-Options","nosniff"),Js(n,"basic"),ea(n,r),n}function ta(r,e,t){let n=new Response(e,{...t??{},status:406,statusText:"Not Acceptable"});return Js(n,"basic"),ea(n,r),n}function g5(r,e,t){let n=new Response(e,{...t??{},status:404,statusText:"Not Found"});return Js(n,"basic"),ea(n,r),n}function ZQ(r){return Array.isArray(r)&&r.every(e=>e instanceof Error)}function Cm(r,e,t){let n,i;ZQ(e)?(n=e[e.length-1].stack,i=e.map(a=>({message:a.message,stack:a.stack??""}))):e instanceof Error&&(n=e.stack,i=[{message:e.message,stack:e.stack??""}]);let o=JSON.stringify({stack:n,errors:i}),s=new Response(o,{status:400,statusText:"Bad Request",...t??{},headers:{...t?.headers??{},"Content-Type":"application/json"}});return Js(s,"basic"),ea(s,r),s}function km(r,e,t){let n=new Response(null,{...t??{},status:301,statusText:"Moved Permanently",headers:{...t?.headers??{},location:e}});return Js(n,"basic"),ea(n,r),n}function cn(r,e,{byteRangeContext:t,log:n},i){if(!t.isRangeRequest)return QQ(r,e,i);if(!t.isValidRangeRequest)return p5(r,e,i);let o;try{o=new Response(e,{...i??{},status:206,statusText:"Partial Content",headers:{...i?.headers??{},"content-range":t.contentRangeHeaderValue}})}catch(s){return n?.error("failed to create range response",s),p5(r,e,i)}return i?.redirected===!0&&nM(o),Js(o,"basic"),ea(o,r),o}function p5(r,e,t){let n=new Response(e,{...t??{},status:416,statusText:"Requested Range Not Satisfiable"});return Js(n,"basic"),ea(n,r),n}function JQ({cid:r,ipfsPath:e,query:t}){return t.filename!=null?t.filename:`${e.replace(/\/ipfs\//,"").replace(/\/ipns\//,"").replace(/\//g,"_")}.car`}var y5=class extends Mt{canHandle(e){return this.log("checking if we can handle %c with accept %s",e.cid,e.accept),e.byteRangeContext==null?!1:e.accept?.startsWith("application/vnd.ipld.car")===!0||e.query.format==="car"}async handle(e){let{options:t,pathDetails:n,cid:i}=e,{getBlockstore:o,helia:s}=this.pluginOptions;e.reqFormat="car",e.query.download=!0,e.query.filename=JQ(e);let a=o(i,e.resource,t?.session??!0,t),c=rM({blockstore:a,getCodec:s.getCodec}),l=Tm(c.stream(n?.terminalElement.cid??i,t));e.byteRangeContext.setBody(l);let u=cn(e.resource,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log});return u.headers.set("content-type","application/vnd.ipld.car; version=1"),u}};function iM(r){let e=xn(r,{allowIndefinite:!1,coerceUndefinedToNull:!1,allowNaN:!1,allowInfinity:!1,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,allowBigInt:!1});return new TextDecoder().decode(hp(e))}var _o=class extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}},gi=class extends _o{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}},Gn=class extends _o{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}},bc=class extends _o{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}},Pm=class extends _o{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}},Zd=class extends _o{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}},Jd=class extends _o{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}},w5=class extends _o{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}},vc=class extends _o{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}},br=class extends _o{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};var Rm=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR",this.name=n??"AbortError"}};function oM(r,e,t){let n=t??{},i=Oa(r);async function*o(){let s,a=()=>{s?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){let{abortMessage:u,abortCode:f,abortName:h}=n;throw new Rm(u,f,h)}let l=new Promise((u,f)=>{s=()=>{let{abortMessage:h,abortCode:d,abortName:m}=n;f(new Rm(h,d,m))}});c=await Promise.race([l,i.next()]),s=null}catch(l){e.removeEventListener("abort",a);let u=l.type==="aborted"&&e.aborted;if(u&&n.onAbort!=null&&n.onAbort(r),typeof i.return=="function")try{let f=i.return();f instanceof Promise&&f.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(f){n.onReturnError!=null&&n.onReturnError(f)}if(u&&n.returnOnAbort===!0)return;throw l}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return o()}function eZ(r){return r[Symbol.asyncIterator]!=null}function tZ(r){if(eZ(r))return(async()=>{let t;for await(let n of r)t=n;return t})();let e;for(let t of r)e=t;return e}var Io=tZ;var x5=class r extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=r.name;code=r.code;constructor(e="Bad path"){super(e)}},Wi=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not found"){super(e)}},b5=class r extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=r.name;code=r.code;constructor(e="No resolver"){super(e)}},vr=class r extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=r.name;code=r.code;constructor(e="Not UnixFS"){super(e)}},v5=class r extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=r.name;code=r.code;constructor(e="Over read"){super(e)}},E5=class r extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=r.name;code=r.code;constructor(e="Under read"){super(e)}},S5=class r extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=r.name;code=r.code;constructor(e="No Property found"){super(e)}},Pu=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};function eh(r,e,t,n,i,o,s){let a=r,c=i;for(;o.length>0;){let l=o[0];if(l in a){o.shift(),c=`${c}/${l}`;let u=W.asCID(a[l]);if(u!=null)return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}},next:{cid:u,name:l,path:c,toResolve:o}};a=a[l]}else throw new S5(`No property named ${l} found in node ${t}`)}return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}}}}var rZ=async(r,e,t,n,i,o,s,a)=>{let c=await s.get(r,a),l=Ta(c);return eh(l,c,r,e,t,n,o)},sM=rZ;var nZ=async(r,e,t,n,i,o,s,a)=>{let c=await s.get(r,a),l=If(c);return eh(l,c,r,e,t,n,o)},aM=nZ;function iZ(r,e,t,n){let i=BigInt(r.length),o=BigInt(e+i);return t>=o||n<e?new Uint8Array(0):(n>=e&&n<o&&(r=r.subarray(0,Number(n-e))),t>=e&&t<o&&(r=r.subarray(Number(t-e))),r)}var Ru=iZ;var oZ=(r,e=0,t=r)=>{let n=BigInt(r),i=BigInt(e??0),o=BigInt(t);if(o!==n&&(o=i+o),o>n&&(o=n),i<0n)throw new Pu("Offset must be greater than or equal to 0");if(i>n)throw new Pu("Offset must be less than the file size");if(o<0n)throw new Pu("Length must be greater than or equal to 0");if(o>n)throw new Pu("Length must be less than the file size");return{start:i,end:o}},th=oZ;var sZ=r=>{async function*e(t={}){let{start:n,end:i}=th(r.length,t.offset,t.length),o=Ru(r,0n,n,i);t.onProgress?.(new G("unixfs:exporter:progress:identity",{bytesRead:BigInt(o.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield o}return e},aZ=async(r,e,t,n,i,o,s,a)=>{if(n.length>0)throw new Wi(`No link named ${t} found in raw node ${r}`);let c=Ue(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:sZ(c.digest),depth:o,size:BigInt(c.digest.length),node:c.digest}}},cM=aZ;var cZ=async(r,e,t,n,i,o,s,a)=>{let c=await s.get(r,a),l=Q8(c);return eh(l,c,r,e,t,n,o)},lM=cZ;var lZ=r=>{async function*e(t={}){let{start:n,end:i}=th(r.length,t.offset,t.length),o=Ru(r,0n,n,i);t.onProgress?.(new G("unixfs:exporter:progress:raw",{bytesRead:BigInt(o.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield o}return e},uZ=async(r,e,t,n,i,o,s,a)=>{if(n.length>0)throw new Wi(`No link named ${t} found in raw node ${r}`);let c=await s.get(r,a);return{entry:{type:"raw",name:e,path:t,cid:r,content:lZ(c),depth:o,size:BigInt(c.length),node:c}}},uM=uZ;var Dm=class r extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=r.name;code=r.code;constructor(e="Invalid type"){super(e)}};var To;(function(r){let e;(function(i){i.Raw="Raw",i.Directory="Directory",i.File="File",i.Metadata="Metadata",i.Symlink="Symlink",i.HAMTShard="HAMTShard"})(e=r.DataType||(r.DataType={}));let t;(function(i){i[i.Raw=0]="Raw",i[i.Directory=1]="Directory",i[i.File=2]="File",i[i.Metadata=3]="Metadata",i[i.Symlink=4]="Symlink",i[i.HAMTShard=5]="HAMTShard"})(t||(t={})),function(i){i.codec=()=>St(t)}(e=r.DataType||(r.DataType={}));let n;r.codec=()=>(n==null&&(n=Ee((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.Type!=null&&(o.uint32(8),r.DataType.codec().encode(i.Type,o)),i.Data!=null&&(o.uint32(18),o.bytes(i.Data)),i.filesize!=null&&(o.uint32(24),o.uint64(i.filesize)),i.blocksizes!=null)for(let a of i.blocksizes)o.uint32(32),o.uint64(a);i.hashType!=null&&(o.uint32(40),o.uint64(i.hashType)),i.fanout!=null&&(o.uint32(48),o.uint64(i.fanout)),i.mode!=null&&(o.uint32(56),o.uint32(i.mode)),i.mtime!=null&&(o.uint32(66),A5.codec().encode(i.mtime,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o)=>{let s={blocksizes:[]},a=o==null?i.len:i.pos+o;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:s.Type=r.DataType.codec().decode(i);break;case 2:s.Data=i.bytes();break;case 3:s.filesize=i.uint64();break;case 4:s.blocksizes.push(i.uint64());break;case 5:s.hashType=i.uint64();break;case 6:s.fanout=i.uint64();break;case 7:s.mode=i.uint32();break;case 8:s.mtime=A5.codec().decode(i,i.uint32());break;default:i.skipType(c&7);break}}return s})),n),r.encode=i=>ve(i,r.codec()),r.decode=i=>be(i,r.codec())})(To||(To={}));var A5;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Seconds!=null&&(n.uint32(8),n.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(n.uint32(21),n.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let s=t.uint32();switch(s>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(s&7);break}}return i})),e),r.encode=t=>ve(t,r.codec()),r.decode=t=>be(t,r.codec())})(A5||(A5={}));var fM;(function(r){let e;r.codec=()=>(e==null&&(e=Ee((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.MimeType!=null&&(n.uint32(10),n.string(t.MimeType)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let s=t.uint32();switch(s>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(s&7);break}}return i})),e),r.encode=t=>ve(t,r.codec()),r.decode=t=>be(t,r.codec())})(fM||(fM={}));var dM={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},fZ=["directory","hamt-sharded-directory"],hM=parseInt("0644",8),pM=parseInt("0755",8),Te=class r{static unmarshal(e){let t=To.decode(e),n=new r({type:dM[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){let{type:t,data:n,blockSizes:i,hashType:o,fanout:s,mtime:a,mode:c}=e;if(t!=null&&!Object.values(dM).includes(t))throw new Dm("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=o,this.fanout=s,this.blockSizes=i??[],this._originalMode=0,this.mode=c,this.mtime=a}set mode(e){e==null?this._mode=this.isDirectory()?pM:hM:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return fZ.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=To.DataType.Raw;break;case"directory":e=To.DataType.Directory;break;case"file":e=To.DataType.File;break;case"metadata":e=To.DataType.Metadata;break;case"symlink":e=To.DataType.Symlink;break;case"hamt-sharded-directory":e=To.DataType.HAMTShard;break;default:throw new Dm(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(this.mode??0),n===hM&&!this.isDirectory()&&(n=void 0),n===pM&&this.isDirectory()&&(n=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),To.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:i})}};var I5=it(yM(),1);function dZ(r){let e=new Array(4);for(let t=0;t<4;t++)e[t]=r&255,r=r>>8;return new Uint8Array(e)}var LQe=Lc({name:"murmur3-32",code:35,encode:r=>dZ(I5.default.x86.hash32(r))}),Du=Lc({name:"murmur3-128",code:34,encode:r=>Dc.fromHex(I5.default.x64.hash128(r))}),BQe=Lc({name:"murmur3-x64-64",code:34,encode:r=>Dc.fromHex(I5.default.x64.hash128(r)).subarray(0,8)});var bM=it(T5(),1);var yi=class r{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new bM.default,this.key=null}async put(e,t){let n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){let t=await this._findChild(e);if(t!=null)return t.value}async del(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof r?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){let e=this._children.compactArray();for(let t of e)t instanceof r?yield*t.eachLeafSeries():yield t}serialize(e,t){let n=[];return t(this._children.reduce((i,o,s)=>(o!=null&&(o instanceof r?i.push(o.serialize(e,t)):i.push(e(o,s))),i),n))}async asyncTransform(e,t){return vM(this,e,t)}toJSON(){return this.serialize(yZ,wZ)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof r)&&n!=null&&n.key===e)return n}async _findPlace(e){let t=this._options.hash(typeof e=="string"?O(e):e),n=await t.take(this._options.bits),i=this._children.get(n);return i instanceof r?i._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:i}}async _findNewBucketAndPos(e){let t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){let n=new r(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);let i=await n._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){let e=this._children.find(gZ);if(e!=null&&!(e instanceof r)){let t=e.hash;t.untake(this._options.bits);let n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}};function gZ(r){return!!r}function yZ(r,e){return r.key}function wZ(r){return r}async function vM(r,e,t){let n=[];for(let i of r._children.compactArray())if(i instanceof yi)await vM(i,e,t);else{let o=await e(i);n.push({bitField:r._children.bitField(),children:o})}return t(n)}var xZ=[255,254,252,248,240,224,192,128],bZ=[1,3,7,15,31,63,127,255],C5=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let i=this._value[this._currentBytePos],o=this._currentBitPos+1,s=Math.min(o,t),a=vZ(i,o-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function vZ(r,e,t){let n=EZ(e,t);return(r&n)>>>e}function EZ(r,e){return xZ[r]&bZ[Math.min(e+r-1,7)]}function EM(r){function e(t){return t instanceof k5?t:new k5(t,r)}return e}var k5=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let i=this._buffers[this._currentBufferIndex],o=Math.min(i.availableBits(),t),s=i.take(o);n=(n<<o)+s,t-=o,this._availableBits-=o,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?Ve([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new C5(t);this._buffers.push(n),this._availableBits+=n.availableBits()}};function rh(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");let e={bits:r.bits??8,hash:EM(r.hashFn)};return new yi(e)}var SZ=async function(r){return(await Du.encode(r)).slice(0,8).reverse()},AZ=async(r,e,t)=>{let n=(e.tableSize()-1).toString(16).length;await Promise.all(r.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===n){let o=parseInt(i.Name,16);e._putObjectAt(o,new yi({hash:t._options.hash,bits:t._options.bits},e,o));return}await t.put(i.Name.substring(2),!0)}))},SM=(r,e)=>r.toString(16).toUpperCase().padStart(e,"0").substring(0,e),_Z=r=>{let e=r.bucket,t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},AM=async(r,e,t,n,i)=>{if(n==null){if(r.Data==null)throw new vr("no data in PBNode");let f;try{f=Te.unmarshal(r.Data)}catch(d){throw new vr(d.message)}if(f.type!=="hamt-sharded-directory")throw new vr("not a HAMT");if(f.fanout==null)throw new vr("missing fanout");let h=rh({hashFn:SZ,bits:Math.log2(Number(f.fanout))});n={rootBucket:h,hamtDepth:1,lastBucket:h}}let o=(n.lastBucket.tableSize()-1).toString(16).length;await AZ(r.Links,n.lastBucket,n.rootBucket);let s=await n.rootBucket._findNewBucketAndPos(e),a=SM(s.pos,o),c=_Z(s);c.length>n.hamtDepth&&(n.lastBucket=c[n.hamtDepth],a=SM(n.lastBucket._posAtParent,o));let l=r.Links.find(f=>{if(f.Name==null)return!1;let h=f.Name.substring(0,o),d=f.Name.substring(o);return!(h!==a||d!==""&&d!==e)});if(l==null)return;if(l.Name!=null&&l.Name.substring(o)===e)return l.Hash;n.hamtDepth++;let u=await t.get(l.Hash,i);return r=rr(u),AM(r,e,t,n,i)},_M=AM;var IZ=(r,e,t,n,i,o,s)=>{async function*a(c={}){let l=c.offset??0,u=c.length??e.Links.length,f=e.Links.slice(l,u);c.onProgress?.(new G("unixfs:exporter:walk:directory",{cid:r})),yield*ot(f,h=>Nt(h,d=>async()=>{let m=d.Name??"",g=`${n}/${m}`;return(await i(d.Hash,m,g,[],o+1,s,c)).entry}),h=>Or(h,{ordered:!0,concurrency:c.blockReadConcurrency}),h=>si(h,d=>d!=null))}return a},IM=IZ;async function TM(r,e,t,n,i,o,s){if(e instanceof Uint8Array){let l=Ru(e,n,i,o);t.push(l);return}if(e.Data==null)throw new vr("no data in PBNode");let a;try{a=Te.unmarshal(e.Data)}catch(l){throw new vr(l.message)}if(a.data!=null){let l=a.data,u=Ru(l,n,i,o);t.push(u),n+=BigInt(u.byteLength)}let c=[];if(e.Links.length!==a.blockSizes.length)throw new vr("Inconsistent block sizes and dag links");for(let l=0;l<e.Links.length;l++){let u=e.Links[l],f=n,h=f+a.blockSizes[l];if((i>=f&&i<h||o>=f&&o<=h||i<f&&o>h)&&c.push({link:u,blockStart:n}),n=h,n>o)break}await ot(c,l=>Nt(l,u=>async()=>{let f=await r.get(u.link.Hash,s);return{...u,block:f}}),l=>Or(l,{ordered:!0,concurrency:s.blockReadConcurrency}),async l=>{for await(let{link:u,block:f,blockStart:h}of l){let d;switch(u.Hash.code){case ct:d=rr(f);break;case vt:d=f;break;default:t.end(new vr(`Unsupported codec: ${u.Hash.code}`));return}let m=new kn({concurrency:1});m.on("error",g=>{t.end(g)}),m.add(async()=>{s.onProgress?.(new G("unixfs:exporter:walk:file",{cid:u.Hash})),await TM(r,d,t,h,i,o,s)}),await m.onIdle()}}),n>=o&&t.end()}var TZ=(r,e,t,n,i,o,s)=>{async function*a(c={}){let l=t.fileSize();if(l===void 0)throw new Error("File was a directory");let{start:u,end:f}=th(l,c.offset,c.length);if(f===0n)return;let h=0n,d=f-u,m=Xr();c.onProgress?.(new G("unixfs:exporter:walk:file",{cid:r})),TM(s,e,m,0n,u,f,c).catch(g=>{m.end(g)});for await(let g of m)if(g!=null){if(h+=BigInt(g.byteLength),h>d)throw m.end(),new v5("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");h===d&&m.end(),c.onProgress?.(new G("unixfs:exporter:progress:unixfs:file",{bytesRead:h,totalBytes:d,fileSize:l})),yield g}if(h<d)throw new E5("Traversed entire DAG but did not read enough bytes")}return a},qE=TZ;var CZ=(r,e,t,n,i,o,s)=>{function a(c={}){return c.onProgress?.(new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:r})),CM(e,n,i,o,s,c)}return a};async function*CM(r,e,t,n,i,o){let s=r.Links;if(r.Data==null)throw new vr("no data in PBNode");let a;try{a=Te.unmarshal(r.Data)}catch(u){throw new vr(u.message)}if(a.fanout==null)throw new vr("missing fanout");let c=(a.fanout-1n).toString(16).length,l=ot(s,u=>Nt(u,f=>async()=>{let h=f.Name!=null?f.Name.substring(c):null;if(h!=null&&h!==""){let d=await t(f.Hash,h,`${e}/${h}`,[],n+1,i,o);return{entries:d.entry==null?[]:[d.entry]}}else{let d=await i.get(f.Hash,o);return r=rr(d),o.onProgress?.(new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:f.Hash})),{entries:CM(r,e,t,n,i,o)}}}),u=>Or(u,{ordered:!0,concurrency:o.blockReadConcurrency}));for await(let{entries:u}of l)yield*u}var kM=CZ;var kZ=(r,e)=>r.Links.find(n=>n.Name===e)?.Hash,PZ={raw:qE,file:qE,directory:IM,"hamt-sharded-directory":kM,metadata:(r,e,t,n,i,o,s)=>()=>[],symlink:(r,e,t,n,i,o,s)=>()=>[]},RZ=async(r,e,t,n,i,o,s,a)=>{let c=await s.get(r,a),l=rr(c),u,f;if(e==null&&(e=r.toString()),l.Data==null)throw new vr("no data in PBNode");try{u=Te.unmarshal(l.Data)}catch(d){throw new vr(d.message)}if(t==null&&(t=e),n.length>0){let d;if(u?.type==="hamt-sharded-directory"?d=await _M(l,n[0],s):d=kZ(l,n[0]),d==null)throw new Wi("file does not exist");let m=n.shift(),g=`${t}/${m}`;f={cid:d,toResolve:n,name:m??"",path:g}}let h=PZ[u.type](r,l,u,t,i,o,s);if(h==null)throw new Wi("could not find content exporter");return u.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:r,content:h,unixfs:u,depth:o,node:l,size:u.fileSize()},next:f}:{entry:{type:"file",name:e,path:t,cid:r,content:h,unixfs:u,depth:o,node:l,size:u.fileSize()},next:f}},PM=RZ;var DZ={[ct]:PM,[vt]:uM,[Pn]:sM,[qo]:aM,[cr.code]:cM,[Lo]:lM},RM=async(r,e,t,n,i,o,s)=>{let a=DZ[r.code];if(a==null)throw new b5(`No resolver for code ${r.code}`);return a(r,e,t,n,RM,i,o,s)},DM=RM;var NZ=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),OZ=r=>{if(r instanceof Uint8Array)return{cid:W.decode(r),toResolve:[]};let e=W.asCID(r);if(e!=null)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));let t=NZ(r);return{cid:W.parse(t[0]),toResolve:t.slice(1)}}throw new x5(`Unknown path type ${r}`)};async function*nh(r,e,t={}){let{cid:n,toResolve:i}=OZ(r),o=n.toString(),s=o,a=i.length;for(;;){let c=await DM(n,o,s,i,a,e,t);if(c.entry==null&&c.next==null)throw new Wi(`Could not resolve ${r}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,n=c.next.cid,o=c.next.name,s=c.next.path}}async function pr(r,e,t={}){let n=await Io(nh(r,e,t));if(n==null)throw new Wi(`Could not resolve ${r}`);return n}async function*ih(r,e,t={}){let n=await pr(r,e,t);if(n==null)return;if(yield n,n.type==="directory")for await(let o of i(n,t))yield o;async function*i(o,s){for await(let a of o.content(s))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,s))}}async function LZ(r,e,t){let n=[],i,o=t?.signal!=null?oM(nh(e,r,t),t.signal):nh(e,r,t);for await(let s of o)n.push(s.cid),i=s;if(i==null)throw new Zd("No terminal element found");return{ipfsRoots:n,terminalElement:i}}function jE(r){return r.type==="object"}async function NM({cid:r,path:e,resource:t,options:n,blockstore:i,log:o}){try{return await LZ(i,`${r.toString()}/${e}`,n)}catch(s){return n?.signal?.throwIfAborted(),["ERR_NO_PROP","ERR_NO_TERMINAL_ELEMENT","ERR_NOT_FOUND"].includes(s.code)?g5(t):(o.error("error walking path %s",e,s),Qd(t,"Error walking path"))}}var P5=class extends Mt{codes=[Pn];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),n==null||!jE(n.terminalElement)||e.code!==Pn||i==null?!1:jE(n.terminalElement)}async handle(e){let{cid:t,path:n,resource:i,accept:o,pathDetails:s}=e;this.log.trace("fetching %c/%s",t,n);let a=s.ipfsRoots,l=s.terminalElement.node,u;if(o==="application/octet-stream"||o==="application/vnd.ipld.dag-cbor"||o==="application/cbor")u=l;else if(o==="application/vnd.ipld.dag-json")try{let d=Ta(l);u=Ng(d)}catch(d){return this.log.error("could not transform %c to application/vnd.ipld.dag-json",d),ta(i)}else try{u=iM(l)}catch(d){if(o==="application/json")return this.log('could not decode DAG-CBOR as JSON-safe, but the client sent "Accept: application/json"',d),ta(i);this.log("could not decode DAG-CBOR as JSON-safe, falling back to `application/octet-stream`",d),u=l}e.byteRangeContext.setBody(u);let f=cn(i,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log}),h=o??(u instanceof Uint8Array?"application/octet-stream":"application/json");return f.headers.set("content-type",h),c5(f,a),f}};function BZ(r){return r[Symbol.asyncIterator]!=null}function MZ(r,e=1){return e=Number(e),BZ(r)?async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}():function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}()}var R5=MZ;async function*Om(r,e=1){for await(let t of R5(r,e)){let n=t.map(async i=>i().then(o=>({ok:!0,value:o}),o=>({ok:!1,err:o})));for(let i=0;i<n.length;i++){let o=await n[i];if(o.ok)yield o.value;else throw o.err}}}var UZ=262144,Lm=(r={})=>{let e=r.chunkSize??UZ;return async function*(n){let i=new oe,o=0,s=!1;for await(let a of n)for(i.append(a),o+=a.length;o>=e;)if(yield i.slice(0,e),s=!0,e===i.length)i=new oe,o=0;else{let c=new oe;c.append(i.sublist(e)),i=c,o-=e}(!s||o>0)&&(yield i.subarray(0,o))}};var Co=async(r,e,t)=>{t.codec==null&&(t.codec=nr);let n=await Fe.digest(r),i=W.create(t.cidVersion,t.codec.code,n);return await e.put(i,r,t),i};function OM(r){return async function*(t,n){let i=0n;for await(let o of t.content)yield async()=>{let s,a={codec:nr,cidVersion:r.cidVersion,onProgress:r.onProgress};r.rawLeaves?(a.codec=_n,a.cidVersion=1):(s=new Te({type:r.leafType,data:o}),o=Qe({Data:s.marshal(),Links:[]}));let c=await Co(o,n,a);return i+=BigInt(o.byteLength),r.onProgress?.(new G("unixfs:importer:progress:file:write",{bytesWritten:i,cid:c,path:t.path})),{cid:c,unixfs:s,size:BigInt(o.length),block:o}}}}var D5=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};var Ec=class r extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=r.name;code=r.code;constructor(e="Invalid content"){super(e)}};var LM=async(r,e,t)=>{let n=new Te({type:"directory",mtime:r.mtime,mode:r.mode}),i=Qe(qt({Data:n.marshal()})),o=await Co(i,e,t),s=r.path;return{cid:o,path:s,unixfs:n,size:BigInt(i.length),originalPath:r.originalPath,block:i}};async function*FZ(r,e,t){let n=-1,i;for await(let o of Om(t.bufferImporter(r,e),t.blockWriteConcurrency)){if(n++,n===0){i={...o,single:!0};continue}else n===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...o,block:void 0}}i!=null&&(yield i)}function BM(r){return r.single===!0}var $Z=(r,e,t)=>async function(i){if(i.length===1&&BM(i[0])&&t.reduceSingleLeafToSelf){let u=i[0],f=u.block;return BM(u)&&(r.mtime!==void 0||r.mode!==void 0)&&(u.unixfs=new Te({type:"file",mtime:r.mtime,mode:r.mode,data:u.block}),f={Data:u.unixfs.marshal(),Links:[]},u.block=Qe(qt(f)),u.cid=await Co(u.block,e,{...t,cidVersion:t.cidVersion}),u.size=BigInt(u.block.length)),t.onProgress?.(new G("unixfs:importer:progress:file:layout",{cid:u.cid,path:u.originalPath})),{cid:u.cid,path:r.path,unixfs:u.unixfs,size:u.size,originalPath:u.originalPath}}let o=new Te({type:"file",mtime:r.mtime,mode:r.mode}),s=i.filter(u=>u.cid.code===vt&&u.size>0||u.unixfs!=null&&u.unixfs.data==null&&u.unixfs.fileSize()>0n?!0:!!u.unixfs?.data?.length).map(u=>u.cid.code===vt?(o.addBlockSize(u.size),{Name:"",Tsize:Number(u.size),Hash:u.cid}):(u.unixfs?.data==null?o.addBlockSize(u.unixfs?.fileSize()??0n):o.addBlockSize(BigInt(u.unixfs.data.length)),{Name:"",Tsize:Number(u.size),Hash:u.cid})),a={Data:o.marshal(),Links:s},c=Qe(qt(a)),l=await Co(c,e,t);return t.onProgress?.(new G("unixfs:importer:progress:file:layout",{cid:l,path:r.originalPath})),{cid:l,path:r.path,unixfs:o,size:BigInt(c.length+a.Links.reduce((u,f)=>u+(f.Tsize??0),0)),originalPath:r.originalPath,block:c}},MM=async(r,e,t)=>t.layout(FZ(r,e,t),$Z(r,e,t));function HZ(r){return Symbol.iterator in r}function VZ(r){return Symbol.asyncIterator in r}function zZ(r){try{if(r instanceof Uint8Array)return async function*(){yield r}();if(HZ(r))return async function*(){yield*r}();if(VZ(r))return r}catch{throw new Ec("Content was invalid")}throw new Ec("Content was invalid")}function UM(r){return async function*(t,n){for await(let i of t){let o;if(i.path!=null&&(o=i.path,i.path=i.path.split("/").filter(s=>s!=null&&s!==".").join("/")),KZ(i)){let s={path:i.path,mtime:i.mtime,mode:i.mode,content:async function*(){let a=0n;for await(let c of r.chunker(r.chunkValidator(zZ(i.content)))){let l=BigInt(c.byteLength);a+=l,r.onProgress?.(new G("unixfs:importer:progress:file:read",{bytesRead:a,chunkSize:l,path:i.path})),yield c}}(),originalPath:o};yield async()=>MM(s,n,r)}else if(i.path!=null){let s={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:o};yield async()=>LM(s,n,r)}else throw new Error("Import candidate must have content or path or both")}}}function KZ(r){return r.content!=null}var FM=()=>async function*(e){for await(let t of e){if(t.length===void 0)throw new Ec("Content was invalid");if(typeof t=="string"||t instanceof String)yield O(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new Ec("Content was invalid")}};var qZ=174;function Bm(r){let e=r?.maxChildrenPerNode??qZ;return async function t(n,i){let o=[];for await(let s of R5(n,e))o.push(await i(s));return o.length>1?t(o,i):o[0]}}var as=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},Mm=W.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Um=W.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var Nu=class extends as{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}async*eachChildSeries(){for(let[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(let[e,t]of this._children.entries())t.size!=null&&t.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?Um.bytes.byteLength:Mm.bytes.byteLength));return this.nodeSize}async*flush(e){let t=[];for(let[c,l]of this._children.entries()){let u=l;if(l instanceof as)for await(let f of l.flush(e))u=f,yield f;u.size!=null&&u.cid!=null&&t.push({Name:c,Tsize:Number(u.size),Hash:u.cid})}let n=new Te({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:n.marshal(),Links:t},o=Qe(qt(i)),s=await Co(o,e,this.options),a=o.length+i.Links.reduce((c,l)=>c+(l.Tsize??0),0);this.cid=s,this.size=a,yield{cid:s,unixfs:n,path:this.path,size:BigInt(a)}}};async function jZ(r){return(await Du.encode(r)).slice(0,8).reverse()}var $M=BigInt(34),WZ=8,WE=class extends as{_bucket;constructor(e,t){super(e,t),this._bucket=rh({hashFn:jZ,bits:t.shardFanoutBits??WZ})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=zM(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of VM(this._bucket,e,this,this.options))yield{...t,path:this.path}}},HM=WE;async function*VM(r,e,t,n){let i=r._children,o=(r.tableSize()-1).toString(16).length,s=[],a=0n;for(let m=0;m<i.length;m++){let g=i.get(m);if(g==null)continue;let w=m.toString(16).toUpperCase().padStart(o,"0");if(g instanceof yi){let x;for await(let v of VM(g,e,null,n))x=v;if(x==null)throw new Error("Could not flush sharded directory, no subshard found");s.push({Name:w,Tsize:Number(x.size),Hash:x.cid}),a+=x.size}else if(GZ(g.value)){let x=g.value,v;for await(let S of x.flush(e))v=S,yield v;if(v==null)throw new Error("Did not flush dir");let b=w+g.key;s.push({Name:b,Tsize:Number(v.size),Hash:v.cid}),a+=v.size}else{let x=g.value;if(x.cid==null)continue;let v=w+g.key,b=x.size;s.push({Name:v,Tsize:Number(b),Hash:x.cid}),a+=BigInt(b??0)}}let c=Uint8Array.from(i.bitField().reverse()),l=new Te({type:"hamt-sharded-directory",data:c,fanout:BigInt(r.tableSize()),hashType:$M,mtime:t?.mtime,mode:t?.mode}),u={Data:l.marshal(),Links:s},f=Qe(qt(u)),h=await Co(f,e,n),d=BigInt(f.byteLength)+a;yield{cid:h,unixfs:l,size:d}}function GZ(r){return typeof r.flush=="function"}function zM(r,e,t){let n=r._children,i=(r.tableSize()-1).toString(16).length,o=[];for(let l=0;l<n.length;l++){let u=n.get(l);if(u==null)continue;let f=l.toString(16).toUpperCase().padStart(i,"0");if(u instanceof yi){let h=zM(u,null,t);o.push({Name:f,Tsize:Number(h),Hash:t.cidVersion===0?Mm:Um})}else if(typeof u.value.flush=="function"){let d=u.value.nodeSize();o.push({Name:f+u.key,Tsize:Number(d),Hash:t.cidVersion===0?Mm:Um})}else{let h=u.value;if(h.cid==null)continue;let d=f+u.key,m=h.size;o.push({Name:d,Tsize:Number(m),Hash:h.cid})}}let s=Uint8Array.from(n.bitField().reverse()),a=new Te({type:"hamt-sharded-directory",data:s,fanout:BigInt(r.tableSize()),hashType:$M,mtime:e?.mtime,mode:e?.mode});return Qe(qt({Data:a.marshal(),Links:o})).length}async function GE(r,e,t,n){let i=e;e instanceof Nu&&e.estimateNodeSize()>t&&(i=await XZ(e,n));let o=i.parent;if(o!=null){if(i!==e){if(r!=null&&(r.parent=i),i.parentKey==null)throw new Error("No parent key found");await o.put(i.parentKey,i)}return GE(i,o,t,n)}return i}async function XZ(r,e){let t=new HM({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for await(let{key:n,child:i}of r.eachChildSeries())await t.put(n,i);return t}var KM=(r="")=>r.split(/(?<!\\)\//).filter(Boolean);async function YZ(r,e,t){let n=KM(r.path??""),i=n.length-1,o=e,s="";for(let a=0;a<n.length;a++){let c=n[a];s+=`${s!==""?"/":""}${c}`;let l=a===i;if(o.dirty=!0,o.cid=void 0,o.size=void 0,l)await o.put(c,r),e=await GE(null,o,t.shardSplitThresholdBytes,t);else{let u=await o.get(c);(u==null||!(u instanceof as))&&(u=new Nu({root:!1,dir:!0,parent:o,parentKey:c,path:s,dirty:!0,flat:!0,mtime:u?.unixfs?.mtime,mode:u?.unixfs?.mode},t)),await o.put(c,u),o=u}}return e}async function*qM(r,e){if(!(r instanceof as)){r.unixfs?.isDirectory()===!0&&(yield r);return}yield*r.flush(e)}function jM(r){return async function*(t,n){let i=new Nu({root:!0,dir:!0,path:"",dirty:!0,flat:!0},r),o,s=!1;for await(let a of t){if(a==null)continue;let c=`${a.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(o==null?(o=c,s=!0):o!==c&&(s=!1)),i=await YZ(a,i,r),a.unixfs?.isDirectory()!==!0&&(yield a)}if(r.wrapWithDirectory||s&&i.childCount()>1)yield*qM(i,n);else for await(let a of i.eachChildSeries())a!=null&&(yield*qM(a.child,n))}}async function*Ou(r,e,t={}){let n;Symbol.asyncIterator in r||Symbol.iterator in r?n=r:n=[r];let i=t.wrapWithDirectory??!1,o=t.shardSplitThresholdBytes??262144,s=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,l=t.leafType??"file",u=t.fileImportConcurrency??50,f=t.blockWriteConcurrency??10,h=t.reduceSingleLeafToSelf??!0,d=t.chunker??Lm(),m=t.chunkValidator??FM(),g=t.dagBuilder??UM({chunker:d,chunkValidator:m,wrapWithDirectory:i,layout:t.layout??Bm(),bufferImporter:t.bufferImporter??OM({cidVersion:a,rawLeaves:c,leafType:l,onProgress:t.onProgress}),blockWriteConcurrency:f,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:t.onProgress}),w=t.treeBuilder??jM({wrapWithDirectory:i,shardSplitThresholdBytes:o,shardFanoutBits:s,cidVersion:a,onProgress:t.onProgress});for await(let x of w(Om(g(n,e),u),e))yield{cid:x.cid,path:x.path,unixfs:x.unixfs,size:x.size}}async function WM(r,e,t={}){let n=await Bf(Ou([r],e,t));if(n==null)throw new D5("Nothing imported");return n}async function GM(r,e,t={}){return WM({content:r},e,t)}async function XM(r,e,t={}){return WM({content:r},e,t)}var Fm={cidVersion:1,rawLeaves:!0,layout:Bm({maxChildrenPerNode:1024}),chunker:Lm({chunkSize:1048576})};async function*N5(r,e,t={}){yield*Ou(r,e,{...Fm,...t})}async function YM(r,e,t={}){let{cid:n}=await GM(r,e,{...Fm,...t});return n}async function QM(r,e,t={}){let{cid:n}=await XM(r,e,{...Fm,...t});return n}async function ZM(r,e,t={}){if(r.path==null)throw new br("path is required");if(r.content==null)throw new br("content is required");let n=await Io(N5([r],e,{...Fm,...t,wrapWithDirectory:!0}));if(n==null)throw new br("Nothing imported");return n.cid}async function JM(r,e,t={}){if(r.content!=null)throw new br("Directories cannot have content, use addFile instead");let i=await(r.path==null?Bf:Io)(N5([{...r,path:r.path??"-"}],e,{...Fm,...t,wrapWithDirectory:r.path!=null}));if(i==null)throw new br("Nothing imported");return i.cid}var ZE=it(T5(),1);function L5(r){function e(t){return t instanceof O5?t:new O5(t,r)}return e}var O5=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let i=this._buffers[this._currentBufferIndex],o=Math.min(i.availableBits(),t),s=i.take(o);n=(n<<o)+s,t-=o,this._availableBits-=o,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?Ve([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new XE(t);this._buffers.push(n),this._availableBits+=n.availableBits()}},QZ=[255,254,252,248,240,224,192,128],ZZ=[1,3,7,15,31,63,127,255],XE=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let i=this._value[this._currentBytePos],o=this._currentBitPos+1,s=Math.min(o,t),a=JZ(i,o-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function JZ(r,e,t){let n=eJ(e,t);return(r&n)>>>e}function eJ(r,e){return QZ[r]&ZZ[Math.min(e+r-1,7)]}var $m=BigInt(Du.code),Lu=8;async function oh(r){return(await Du.encode(r)).subarray(0,8).reverse()}var rU=it(T5(),1);var ko=async(r,e,t)=>{t.codec==null&&(t.codec=nr);let n=await Fe.digest(r),i=W.create(t.cidVersion,t.codec.code,n);return await e.put(i,r,{...t,signal:t.signal}),i};var YE=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},B5=class extends YE{_bucket;constructor(e,t){super(e,t),this._bucket=rh({hashFn:oh,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=tU(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of eU(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*eU(r,e,t,n){let i=r._children,o=[],s=0n;for(let d=0;d<i.length;d++){let m=i.get(d);if(m==null)continue;let g=d.toString(16).toUpperCase().padStart(2,"0");if(m instanceof yi){let w;for await(let x of eU(m,e,null,n))w=x;if(w==null)throw new Error("Could not flush sharded directory, no sub-shard found");o.push({Name:g,Tsize:Number(w.size),Hash:w.cid}),s+=w.size}else if(tJ(m.value)){let w=m.value,x;for await(let b of w.flush(e))x=b,yield x;if(x==null)throw new Error("Did not flush dir");let v=g+m.key;o.push({Name:v,Tsize:Number(x.size),Hash:x.cid}),s+=x.size}else{let w=m.value;if(w.cid==null)continue;let x=g+m.key,v=w.size;o.push({Name:x,Tsize:Number(v),Hash:w.cid}),s+=BigInt(v??0)}}let a=Uint8Array.from(i.bitField().reverse()),c=new Te({type:"hamt-sharded-directory",data:a,fanout:BigInt(r.tableSize()),hashType:$m,mtime:t?.mtime,mode:t?.mode}),l={Data:c.marshal(),Links:o},u=Qe(qt(l)),f=await ko(u,e,n),h=BigInt(u.byteLength)+s;yield{cid:f,unixfs:c,size:h}}function tJ(r){return typeof r.flush=="function"}function tU(r,e,t){let n=r._children,i=[];for(let c=0;c<n.length;c++){let l=n.get(c);if(l==null)continue;let u=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof yi){let f=tU(l,null,t);i.push({Name:u,Tsize:Number(f),Hash:t.cidVersion===0?M5:U5})}else if(typeof l.value.flush=="function"){let h=l.value.nodeSize();i.push({Name:u+l.key,Tsize:Number(h),Hash:t.cidVersion===0?M5:U5})}else{let f=l.value;if(f.cid==null)continue;let h=u+l.key,d=f.size;i.push({Name:h,Tsize:Number(d),Hash:f.cid})}}let o=Uint8Array.from(n.bitField().reverse()),s=new Te({type:"hamt-sharded-directory",data:o,fanout:BigInt(r.tableSize()),hashType:$m,mtime:e?.mtime,mode:e?.mode});return Qe(qt({Data:s.marshal(),Links:i})).length}var M5=W.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),U5=W.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var QE=ze("helia:unixfs:commands:utils:hamt-utils"),F5=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),nU=async(r,e,t)=>{let n=new B5({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let o=0;o<e.length;o++)await n._bucket.put(e[o].name,{size:e[o].size,cid:e[o].cid});let i=await Io(n.flush(r));if(i==null)throw new Error("Flushing shard yielded no result");return i},$5=async(r,e,t)=>{let n=Te.unmarshal(r[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,Lu));r.reverse();let o,s;for(let a=0;a<r.length;a++){let c=a===r.length-1,l=r[a],u=Uint8Array.from(l.children.bitField().reverse()),f=new Te({type:"hamt-sharded-directory",data:u,fanout:i,hashType:$m});c&&(f.mtime=n.mtime,f.mode=n.mode),s={Data:f.marshal(),Links:l.node.Links};let h=Qe(qt(s));if(o=await ko(h,e,t),!c){let d=r[a+1];if(d==null)throw new Error("Was not operating on shard root but also had no parent?");QE("updating link in parent sub-shard with prefix %s",d.prefix),d.node.Links=d.node.Links.filter(m=>m.Name!==d.prefix),d.node.Links.push({Name:d.prefix,Hash:o,Tsize:l.node.Links.reduce((m,g)=>m+(g.Tsize??0),h.byteLength)})}}if(o==null||s==null)throw new Error("Noting persisted");return{cid:o,node:s}},H5=async(r,e,t,n)=>{let o=L5(oh)(O(e)),s=[];for(;;){let a=await t.get(r,n),c=rr(a),l=new rU.default,u=await o.take(Lu),f=F5(u);s.push({prefix:f,children:l,node:c});let h;for(let m of c.Links){let g=m.Name??"";if(g.length<2)throw new Error("Invalid HAMT - link name was too short");let w=parseInt(g.substring(0,2),16);l.set(w,!0),g.startsWith(f)&&(h=m)}if(h==null){QE("no link found with prefix %s for %s",f,e);break}let d=h.Name??"";if(d.length<2)throw new Error("Invalid HAMT - link name was too short");if(d.length===2){r=h.Hash,QE("descend into sub-shard with prefix %s",d);continue}break}return{path:s,hash:o}};async function V5(r,e,t,n){if(r.Data==null)throw new Error("DagPB node had no data");let i=Te.unmarshal(r.Data),o;if(i.type==="directory")o=rJ(r);else if(i.type==="hamt-sharded-directory")o=await iU(r,0,t,e,n);else throw new Error("Can only estimate the size of directories or shards");return o>t}function rJ(r){let e=0;for(let t of r.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?U5.bytes.byteLength:M5.bytes.byteLength;return e}async function iU(r,e,t,n,i){if(e>t)return t;if(r.Data==null||!Te.unmarshal(r.Data).isDirectory())return e;for(let s of r.Links){let a=s.Name??"";if(a=a.substring(2),e+=a.length,e+=s.Hash.bytes.byteLength,s.Hash.code===ct){let c=await n.get(s.Hash,i),l=rr(c);e+=await iU(l,e,t,n,i)}}return e}var cs=ze("helia:unixfs:components:utils:add-link");async function sh(r,e,t,n){if(r.node.Data==null)throw new br("Invalid parent passed to addLink");if(Te.unmarshal(r.node.Data).type==="hamt-sharded-directory")return cs("adding link to sharded directory"),oJ(r,e,t,n);cs(`adding ${e.Name} (${e.Hash}) to regular directory`);let o=await iJ(r,e,t,n);if(await V5(o.node,t,n.shardSplitThresholdBytes,n)){cs("converting directory to sharded directory");let s=await nJ(o,t);o.cid=s.cid,o.node=rr(await t.get(s.cid,n))}return o}var nJ=async(r,e)=>{if(r.node.Data==null)throw new br("Invalid parent passed to convertToShardedDirectory");let t=Te.unmarshal(r.node.Data),n=await nU(e,r.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:r.cid.version});return cs(`converted directory to sharded directory ${n.cid}`),n},iJ=async(r,e,t,n)=>{let i=r.node.Links.filter(u=>{let f=u.Name===e.Name;if(f&&!n.allowOverwriting)throw new Pm;return!f});if(i.push(e),r.node.Data==null)throw new Gn("Parent node with no data passed to addToDirectory");let o=Te.unmarshal(r.node.Data),s;if(o.mtime!=null){let u=Date.now(),f=Math.floor(u/1e3);o.mtime={secs:BigInt(f),nsecs:(u-f*1e3)*1e3},s=o.marshal()}else s=r.node.Data;r.node=qt({Data:s,Links:i});let a=Qe(r.node),c=await Fe.digest(a),l=W.create(r.cid.version,ct,c);return await t.put(l,a),{node:r.node,cid:l}},oJ=async(r,e,t,n)=>{let{path:i,hash:o}=await H5(r.cid,e.Name,t,n),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");let a=s.prefix,c=parseInt(a,16);cs("next prefix for %s is %s",e.Name,a);let l=`${a}${e.Name}`,u=s.node.Links.find(f=>(f.Name??"").startsWith(a));if(u!=null)if(cs("link %s was present in shard",l),u.Name===l){if(!n.allowOverwriting)throw new Pm;cs("overwriting %s in sub-shard",e.Name),s.node.Links=s.node.Links.filter(f=>f.Name!==l),s.node.Links.push({Name:l,Hash:e.Hash,Tsize:e.Tsize})}else{if(u.Name?.length===2)throw new Error("Existing link was sub-shard?!");{cs("prefix %s already exists, creating new sub-shard",a);let f=s.node.Links.findIndex(w=>w.Name?.startsWith(a)),h=s.node.Links.splice(f,1)[0],d=(h.Name??"").substring(2),g=L5(oh)(O(d));for(let w=0;w<i.length;w++)await g.take(Lu);for(;;){let w=await g.take(Lu),x=F5(w);h.Name=`${x}${d}`;let v=await o.take(Lu),b=F5(v);if(x===b){let T=new ZE.default;T.set(v,!0),i.push({prefix:b,children:T,node:{Links:[]}});continue}let S=new ZE.default;S.set(v,!0),S.set(w,!0),i.push({prefix:a,children:S,node:{Links:[h,{Name:`${b}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else cs("link %s was not present in sub-shard",l),e.Name=l,s.node.Links.push(e),s.children.set(c,!0),cs("adding %s to existing sub-shard",l);return $5(i,t,n)};async function Sc(r,e,t={}){let n=await pr(r,e,t);if(n.type!=="directory")throw new vc(`${r.toString()} was not a UnixFS directory`);return{cid:r,node:n.node}}async function ah(r,e,t,n){let i=await pr(r,t,n);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new gi(`${r.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:sJ(i.node),Hash:r}}function sJ(r){let e=r.Links.reduce((t,n)=>t+(n.Tsize??0),0);return Qe(r).byteLength+e}var aJ=ze("helia:unixfs:components:utils:resolve");async function ls(r,e,t,n){if(e==null||e==="")return{cid:r};let i=`/ipfs/${r}${e==null?"":`/${e}`}`,o=await Ps(nh(i,t,n));if(o.length===0)throw new Zd("Could not find path in directory");return aJ("resolved %s to %c",e,r),{cid:o[o.length-1].cid,path:e,segments:o}}async function ch(r,e,t,n){if(e.segments==null||e.segments.length===0)return r;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=r,e.segments.reverse();for(let o of e.segments){let[s,a]=await Promise.all([Sc(o.cid,t,n),ah(i.cid,i.name,t,n)]);r=(await sh(s,a,t,{...n,allowOverwriting:!0,cidVersion:r.version})).cid,o.cid=r,i=o}return r}var cJ=Wt.bind({ignoreUndefined:!0}),lJ={};async function*oU(r,e,t={}){let n=cJ(lJ,t),i=await ls(r,n.path,e,n),o=await pr(i.cid,e,n);if(o.type!=="file"&&o.type!=="raw")throw new w5;if(o.content==null)throw new Jd;yield*o.content(n)}var uJ=Wt.bind({ignoreUndefined:!0}),fJ=ze("helia:unixfs:chmod"),dJ={recursive:!1,shardSplitThresholdBytes:262144};async function sU(r,e,t,n={}){let i=uJ(dJ,n),o=await ls(r,i.path,t,n);if(fJ("chmod %c %d",o.cid,e),i.recursive){let h=await ot(async function*(){for await(let d of ih(o.cid,t,n)){let m,g=[];if(d.type==="raw")m=new Te({type:"file",data:d.node});else if(d.type==="file"||d.type==="directory")m=d.unixfs,g=d.node.Links;else throw new gi;m.mode=e;let w={Data:m.marshal(),Links:g};yield{path:d.path,content:w}}},d=>Ou(d,t,{...i,dagBuilder:async function*(m,g){for await(let w of m)yield async function(){let x=w.content,v=Qe(x),b=await ko(v,g,{...i,cidVersion:r.version});if(x.Data==null)throw new Gn(`${b} had no data`);let S=Te.unmarshal(x.Data);return{cid:b,size:BigInt(v.length),path:w.path,unixfs:S}}}}),async d=>Io(d));if(h==null)throw new bc(`Could not chmod ${o.cid.toString()}`);return ch(h.cid,o,t,i)}let s=await t.get(o.cid,n),a,c=[];if(o.cid.code===vt)a=new Te({type:"file",data:s});else{let h=rr(s);if(h.Data==null)throw new Gn(`${o.cid.toString()} had no data`);c=h.Links,a=Te.unmarshal(h.Data)}a.mode=e;let l=Qe({Data:a.marshal(),Links:c}),u=await Fe.digest(l),f=W.create(o.cid.version,ct,u);return await t.put(f,l),ch(f,o,t,i)}var hJ=Wt.bind({ignoreUndefined:!0}),pJ=ze("helia:unixfs:cp"),mJ={force:!1,shardSplitThresholdBytes:262144};async function aU(r,e,t,n,i={}){let o=hJ(mJ,i);if(t.includes("/"))throw new br("Name must not have slashes");let[s,a]=await Promise.all([Sc(e,n,o),ah(r,t,n,o)]);return pJ('Adding %c as "%s" to %c',r,t,e),(await sh(s,a,n,{allowOverwriting:o.force,cidVersion:e.version,...o})).cid}var gJ=Wt.bind({ignoreUndefined:!0}),yJ={};async function*cU(r,e,t={}){let n=gJ(yJ,t),i=await ls(r,n.path,e,n),o=await pr(i.cid,e);if(o.type==="file"||o.type==="raw"){yield o;return}if(o.content==null)throw new Jd;if(o.type!=="directory")throw new vc;yield*o.content({offset:t.offset,length:t.length})}var wJ=Wt.bind({ignoreUndefined:!0}),lU=ze("helia:unixfs:mkdir"),xJ={cidVersion:1,force:!1,shardSplitThresholdBytes:262144};async function uU(r,e,t,n={}){let i=wJ(xJ,n);if(e.includes("/"))throw new br("Path must not have slashes");if((await pr(r,t,n)).type!=="directory")throw new vc(`${r.toString()} was not a UnixFS directory`);lU("creating %s",e);let a={Data:new Te({type:"directory",mode:i.mode,mtime:i.mtime}).marshal(),Links:[]},c=Qe(a),l=await Fe.digest(c),u=W.create(i.cidVersion,ct,l);await t.put(u,c);let[f,h]=await Promise.all([Sc(r,t,i),ah(u,e,t,i)]);return lU("adding empty dir called %s to %c",e,r),(await sh(f,h,t,{...i,allowOverwriting:i.force})).cid}var K5=ze("helia:unixfs:utils:remove-link");async function fU(r,e,t,n){if(r.node.Data==null)throw new Gn("Parent node had no data");if(Te.unmarshal(r.node.Data).type==="hamt-sharded-directory"){K5(`removing ${e} from sharded directory`);let o=await vJ(r,e,t,n);return await V5(o.node,t,n.shardSplitThresholdBytes,n)?o:(K5("converting shard to flat directory %c",r.cid),EJ(o,t,n))}return K5(`removing link ${e} regular directory`),bJ(r,e,t,n)}var bJ=async(r,e,t,n)=>{r.node.Links=r.node.Links.filter(s=>s.Name!==e);let i=Qe(r.node),o=await ko(i,t,{...n,cidVersion:r.cid.version});return K5(`Updated regular directory ${o}`),{node:r.node,cid:o}},vJ=async(r,e,t,n)=>{let{path:i}=await H5(r.cid,e,t,n),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");let s=o.node.Links.filter(l=>(l.Name??"").substring(2)===e).map(l=>l.Name).pop();if(s==null)throw new Error("File not found");let a=s.substring(0,2),c=parseInt(a,16);if(o.node.Links=o.node.Links.filter(l=>l.Name!==s),o.children.unset(c),o.node.Links.length===1)for(;i.length!==1;){let l=i[i.length-1];if(l==null||l.node.Links.length>1)break;i.pop();let u=i[i.length-1];if(u==null)break;let f=l.node.Links[0];u.node.Links=u.node.Links.filter(h=>!(h.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:f.Hash,Name:`${u.prefix}${(f.Name??"").substring(2)}`,Tsize:f.Tsize})}return $5(i,t,n)},EJ=async(r,e,t)=>{if(r.node.Data==null)throw new br("Invalid parent passed to convertToFlatDirectory");let n={Links:[]},i=await pr(r.cid,e);if(i.type!=="directory")throw new Error("Unexpected node type");for await(let c of i.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=Qe(c.node).length,n.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}let o=Te.unmarshal(r.node.Data);n.Data=new Te({type:"directory",mode:o.mode,mtime:o.mtime}).marshal();let s=Qe(qt(n));return{cid:await ko(s,e,{codec:nr,cidVersion:r.cid.version,signal:t.signal}),node:n}};var SJ=Wt.bind({ignoreUndefined:!0}),AJ=ze("helia:unixfs:rm"),_J={shardSplitThresholdBytes:262144};async function dU(r,e,t,n={}){let i=SJ(_J,n);if(e.includes("/"))throw new br("Name must not have slashes");let o=await Sc(r,t,i);return AJ("Removing %s from %c",e,r),(await fU(o,e,t,{...i,cidVersion:r.version})).cid}var hU=1877,q5=1604,IJ=Wt.bind({ignoreUndefined:!0}),TJ=ze("helia:unixfs:stat"),CJ={};async function pU(r,e,t={}){let n=IJ(CJ,t),i=await ls(r,t.path,e,n);TJ("stat %c",i.cid);let o=await pr(i.cid,e,n);if(o.type==="raw")return t.extended===!0?DJ(o):RJ(o);if(o.type==="file"||o.type==="directory")return t.extended===!0?PJ(o,e,t.filter??new gf({filterSize:1024}),t):kJ(o);throw new gi}function kJ(r){return{type:r.type,cid:r.cid,unixfs:r.unixfs,mode:r.unixfs.mode??(r.unixfs.isDirectory()?hU:q5),mtime:r.unixfs.mtime,size:r.unixfs.fileSize()}}async function PJ(r,e,t,n){let i=await mU(r.cid,e,!1,t,n);return{type:r.type,cid:r.cid,unixfs:r.unixfs,size:r.unixfs.isDirectory()?i.dirSize:r.unixfs.fileSize(),mode:r.unixfs.mode??(r.unixfs.isDirectory()?hU:q5),mtime:r.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function RJ(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:q5,mtime:void 0,size:BigInt(r.node.byteLength)}}function DJ(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:q5,mtime:void 0,size:BigInt(r.node.byteLength),localSize:BigInt(r.node.byteLength),dagSize:BigInt(r.node.byteLength),deduplicatedDagSize:BigInt(r.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function mU(r,e,t,n,i){let o={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{let s=n.has(r.bytes);n.add(r.bytes);let a=await e.get(r,i);if(o.blocks++,o.dagSize+=BigInt(a.byteLength),s||(o.uniqueBlocks++,o.deduplicatedDagSize+=BigInt(a.byteLength)),r.code===vt)o.localSize+=BigInt(a.byteLength),t&&(o.dirSize+=BigInt(a.byteLength));else if(r.code===ct){let c=rr(a),l;if(c.Data!=null&&(l=Te.unmarshal(c.Data)),c.Links.length>0){for(let u of c.Links){let f=await mU(u.Hash,e,NJ(u,l),n,i);o.localSize+=f.localSize,o.dagSize+=f.dagSize,o.deduplicatedDagSize+=f.deduplicatedDagSize,o.blocks+=f.blocks,o.uniqueBlocks+=f.uniqueBlocks,o.dirSize+=f.dirSize}t&&l!=null&&(o.dirSize+=l.fileSize())}else{if(l==null)throw new Gn(`PBNode ${r.toString()} had no data`);l.data!=null&&(o.localSize+=BigInt(l.data.byteLength??0)),t&&(o.dirSize+=l.fileSize())}}else throw new bc(`${r.toString()} was neither DAG_PB nor RAW`)}catch(s){if(s.name!=="NotFoundError"||i.offline!==!0)throw s}return o}function NJ(r,e){if(e==null)return!1;let t=r.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}var OJ=Wt.bind({ignoreUndefined:!0}),LJ=ze("helia:unixfs:touch"),BJ={recursive:!1,shardSplitThresholdBytes:262144};async function gU(r,e,t={}){let n=OJ(BJ,t),i=await ls(r,n.path,e,n),o=n.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(LJ("touch %c %o",i.cid,o),n.recursive){let h=await ot(async function*(){for await(let d of ih(i.cid,e)){let m,g;if(d.type==="raw")m=new Te({data:d.node}),g=[];else if(d.type==="file"||d.type==="directory")m=d.unixfs,g=d.node.Links;else throw new gi;m.mtime=o;let w={Data:m.marshal(),Links:g};yield{path:d.path,content:w}}},d=>Ou(d,e,{...n,dagBuilder:async function*(m,g){for await(let w of m)yield async function(){let x=w.content,v=Qe(x),b=await ko(v,g,{...n,cidVersion:r.version});if(x.Data==null)throw new Gn(`${b} had no data`);let S=Te.unmarshal(x.Data);return{cid:b,size:BigInt(v.length),path:w.path,unixfs:S}}}}),async d=>Io(d));if(h==null)throw new bc(`Could not chmod ${i.cid.toString()}`);return ch(h.cid,i,e,n)}let s=await e.get(i.cid,t),a,c=[];if(i.cid.code===vt)a=new Te({data:s});else{let h=rr(s);if(c=h.Links,h.Data==null)throw new Gn(`${i.cid.toString()} had no data`);a=Te.unmarshal(h.Data)}a.mtime=o;let l=Qe({Data:a.marshal(),Links:c}),u=await Fe.digest(l),f=W.create(i.cid.version,ct,u);return await e.put(f,l),ch(f,i,e,n)}var j5=class{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*N5(e,this.components.blockstore,t)}async addBytes(e,t={}){return YM(e,this.components.blockstore,t)}async addByteStream(e,t={}){return QM(e,this.components.blockstore,t)}async addFile(e,t={}){return ZM(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return JM(e,this.components.blockstore,t)}async*cat(e,t={}){yield*oU(e,this.components.blockstore,t)}async chmod(e,t,n={}){return sU(e,t,this.components.blockstore,n)}async cp(e,t,n,i={}){return aU(e,t,n,this.components.blockstore,i)}async*ls(e,t={}){yield*cU(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return uU(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return dU(e,t,this.components.blockstore,n)}async stat(e,t={}){return pU(e,this.components.blockstore,t)}async touch(e,t={}){return gU(e,this.components.blockstore,t)}};function yU(r){return new j5(r)}async function wU(r,e,t,n){let i=t.forComponent("helia:verified-fetch:get-stream-from-async-iterable"),o=r[Symbol.asyncIterator](),{value:s,done:a}=await o.next();if(a===!0)throw i.error("no content found for path",e),new s5;return{stream:new ReadableStream({async start(l){n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(s)},async pull(l){let{value:u,done:f}=await o.next();if(n?.signal?.aborted===!0){l.error(new Cr(n.signal.reason??"signal aborted by user")),l.close();return}if(f===!0){u!=null&&(n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(u)),l.close();return}n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(u)}}),firstChunk:s}}var bU=it(xU(),1);function Xn(r){return new DataView(r.buffer,r.byteOffset)}var vU={len:1,get(r,e){return Xn(r).getUint8(e)},put(r,e,t){return Xn(r).setUint8(e,t),e+1}},Ut={len:2,get(r,e){return Xn(r).getUint16(e,!0)},put(r,e,t){return Xn(r).setUint16(e,t,!0),e+2}},lh={len:2,get(r,e){return Xn(r).getUint16(e)},put(r,e,t){return Xn(r).setUint16(e,t),e+2}};var sr={len:4,get(r,e){return Xn(r).getUint32(e,!0)},put(r,e,t){return Xn(r).setUint32(e,t,!0),e+4}},EU={len:4,get(r,e){return Xn(r).getUint32(e)},put(r,e,t){return Xn(r).setUint32(e,t),e+4}};var SU={len:4,get(r,e){return Xn(r).getInt32(e)},put(r,e,t){return Xn(r).setInt32(e,t),e+4}};var AU={len:8,get(r,e){return Xn(r).getBigUint64(e,!0)},put(r,e,t){return Xn(r).setBigUint64(e,t,!0),e+8}};var Yn=class{constructor(e,t){this.len=e,this.encoding=t,this.textDecoder=new TextDecoder(t)}get(e,t){return this.textDecoder.decode(e.subarray(t,t+this.len))}};var UJ="End-Of-Stream",Vt=class extends Error{constructor(){super(UJ),this.name="EndOfStreamError"}},Bu=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var Mu=class{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}async peek(e,t=!1){let n=await this.read(e,t);return this.peekQueue.push(e.subarray(0,n)),n}async read(e,t=!1){if(e.length===0)return 0;let n=this.readFromPeekBuffer(e);if(this.endOfStream||(n+=await this.readRemainderFromStream(e.subarray(n),t)),n===0)throw new Vt;return n}readFromPeekBuffer(e){let t=e.length,n=0;for(;this.peekQueue.length>0&&t>0;){let i=this.peekQueue.pop();if(!i)throw new Error("peekData should be defined");let o=Math.min(i.length,t);e.set(i.subarray(0,o),n),n+=o,t-=o,o<i.length&&this.peekQueue.push(i.subarray(o))}return n}async readRemainderFromStream(e,t){let n=0;for(;n<e.length&&!this.endOfStream;){if(this.interrupted)throw new Bu;let i=await this.readFromStream(e.subarray(n),t);if(i===0)break;n+=i}if(!t&&n<e.length)throw new Vt;return n}};var W5=class extends Mu{constructor(e){super(),this.reader=e}async abort(){return this.close()}async close(){this.reader.releaseLock()}};var Hm=class extends W5{async readFromStream(e,t){if(e.length===0)return 0;let n=await this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return n.done&&(this.endOfStream=n.done),n.value?(e.set(n.value),n.value.length):0}};var uh=class extends Mu{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){let n=Math.min(t.length,e.length);return e.set(t.subarray(0,n)),n<t.length?this.buffer=t.subarray(n):this.buffer=null,n}async readFromStream(e,t){if(e.length===0)return 0;let n=0;for(this.buffer&&(n+=this.writeChunk(e,this.buffer));n<e.length&&!this.endOfStream;){let i=await this.reader.read();if(i.done){this.endOfStream=!0;break}i.value&&(n+=this.writeChunk(e.subarray(n),i.value))}if(n===0&&this.endOfStream)throw new Vt;return n}abort(){return this.interrupted=!0,this.reader.cancel()}async close(){await this.abort(),this.reader.releaseLock()}};function eS(r){try{let e=r.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new uh(e):new Hm(e)}catch(e){if(e instanceof TypeError)return new uh(r.getReader());throw e}}var Uu=class{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e?.onClose,e?.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}async readToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.readBuffer(n,{position:t})<e.len)throw new Vt;return e.get(n,0)}async peekToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.peekBuffer(n,{position:t})<e.len)throw new Vt;return e.get(n,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new Vt;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new Vt;return e.get(this.numBuffer,0)}async ignore(e){if(this.fileInfo.size!==void 0){let t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){await this.abort(),await this.onClose?.()}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return{mayBeLess:!1,offset:0,length:e.length,position:this.position,...t}}abort(){return Promise.resolve()}};var $J=256e3,G5=class extends Uu{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=t?.fileInfo??{}}async readBuffer(e,t){let n=this.normalizeOptions(e,t),i=n.position-this.position;if(i>0)return await this.ignore(i),this.readBuffer(e,t);if(i<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(n.length===0)return 0;let o=await this.streamReader.read(e.subarray(0,n.length),n.mayBeLess);if(this.position+=o,(!t||!t.mayBeLess)&&o<n.length)throw new Vt;return o}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),i=0;if(n.position){let o=n.position-this.position;if(o>0){let s=new Uint8Array(n.length+o);return i=await this.peekBuffer(s,{mayBeLess:n.mayBeLess}),e.set(s.subarray(o)),i-o}if(o<0)throw new Error("Cannot peek from a negative offset in a stream")}if(n.length>0){try{i=await this.streamReader.peek(e.subarray(0,n.length),n.mayBeLess)}catch(o){if(t?.mayBeLess&&o instanceof Vt)return 0;throw o}if(!n.mayBeLess&&i<n.length)throw new Vt}return i}async ignore(e){let t=Math.min($J,e),n=new Uint8Array(t),i=0;for(;i<e;){let o=e-i,s=await this.readBuffer(n,{length:Math.min(t,o)});if(s<0)return s;i+=s}return i}abort(){return this.streamReader.abort()}async close(){return this.streamReader.close()}supportsRandomAccess(){return!1}};var X5=class extends Uu{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo={...t?.fileInfo??{},size:e.length}}async readBuffer(e,t){t?.position&&(this.position=t.position);let n=await this.peekBuffer(e,t);return this.position+=n,n}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),i=Math.min(this.uint8Array.length-n.position,n.length);if(!n.mayBeLess&&i<n.length)throw new Vt;return e.set(this.uint8Array.subarray(n.position,n.position+i)),i}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}};function _U(r,e){let t=eS(r),n=e??{},i=n.onClose;return n.onClose=async()=>{if(await t.close(),i)return i()},new G5(t,n)}function IU(r,e){return new X5(r,e)}var xi=Uint8Array,fh=Uint16Array,VJ=Int32Array,TU=new xi([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),CU=new xi([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),zJ=new xi([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),kU=function(r,e){for(var t=new fh(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var i=new VJ(t[30]),n=1;n<30;++n)for(var o=t[n];o<t[n+1];++o)i[o]=o-t[n]<<5|n;return{b:t,r:i}},PU=kU(TU,2),RU=PU.b,KJ=PU.r;RU[28]=258,KJ[258]=28;var DU=kU(CU,0),qJ=DU.b,Jnt=DU.r,nS=new fh(32768);for(ut=0;ut<32768;++ut)ra=(ut&43690)>>1|(ut&21845)<<1,ra=(ra&52428)>>2|(ra&13107)<<2,ra=(ra&61680)>>4|(ra&3855)<<4,nS[ut]=((ra&65280)>>8|(ra&255)<<8)>>1;var ra,ut,Vm=function(r,e,t){for(var n=r.length,i=0,o=new fh(e);i<n;++i)r[i]&&++o[r[i]-1];var s=new fh(e);for(i=1;i<e;++i)s[i]=s[i-1]+o[i-1]<<1;var a;if(t){a=new fh(1<<e);var c=15-e;for(i=0;i<n;++i)if(r[i])for(var l=i<<4|r[i],u=e-r[i],f=s[r[i]-1]++<<u,h=f|(1<<u)-1;f<=h;++f)a[nS[f]>>c]=l}else for(a=new fh(n),i=0;i<n;++i)r[i]&&(a[i]=nS[s[r[i]-1]++]>>15-r[i]);return a},zm=new xi(288);for(ut=0;ut<144;++ut)zm[ut]=8;var ut;for(ut=144;ut<256;++ut)zm[ut]=9;var ut;for(ut=256;ut<280;++ut)zm[ut]=7;var ut;for(ut=280;ut<288;++ut)zm[ut]=8;var ut,NU=new xi(32);for(ut=0;ut<32;++ut)NU[ut]=5;var ut;var jJ=Vm(zm,9,1);var WJ=Vm(NU,5,1),tS=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},Po=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},rS=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},GJ=function(r){return(r+7)/8|0},XJ=function(r,e,t){return(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length),new xi(r.subarray(e,t))};var YJ=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],wi=function(r,e,t){var n=new Error(e||YJ[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,wi),!t)throw n;return n},iS=function(r,e,t,n){var i=r.length,o=n?n.length:0;if(!i||e.f&&!e.l)return t||new xi(0);var s=!t,a=s||e.i!=2,c=e.i;s&&(t=new xi(i*3));var l=function(Rt){var Et=t.length;if(Rt>Et){var mr=new xi(Math.max(Et*2,Rt));mr.set(t),t=mr}},u=e.f||0,f=e.p||0,h=e.b||0,d=e.l,m=e.d,g=e.m,w=e.n,x=i*8;do{if(!d){u=Po(r,f,1);var v=Po(r,f+1,3);if(f+=3,v)if(v==1)d=jJ,m=WJ,g=9,w=5;else if(v==2){var D=Po(r,f,31)+257,A=Po(r,f+10,15)+4,I=D+Po(r,f+5,31)+1;f+=14;for(var k=new xi(I),Q=new xi(19),K=0;K<A;++K)Q[zJ[K]]=Po(r,f+K*3,7);f+=A*3;for(var V=tS(Q),X=(1<<V)-1,$=Vm(Q,V,1),K=0;K<I;){var F=$[Po(r,f,X)];f+=F&15;var b=F>>4;if(b<16)k[K++]=b;else{var z=0,M=0;for(b==16?(M=3+Po(r,f,3),f+=2,z=k[K-1]):b==17?(M=3+Po(r,f,7),f+=3):b==18&&(M=11+Po(r,f,127),f+=7);M--;)k[K++]=z}}var R=k.subarray(0,D),N=k.subarray(D);g=tS(R),w=tS(N),d=Vm(R,g,1),m=Vm(N,w,1)}else wi(1);else{var b=GJ(f)+4,S=r[b-4]|r[b-3]<<8,T=b+S;if(T>i){c&&wi(0);break}a&&l(h+S),t.set(r.subarray(b,T),h),e.b=h+=S,e.p=f=T*8,e.f=u;continue}if(f>x){c&&wi(0);break}}a&&l(h+131072);for(var Z=(1<<g)-1,ne=(1<<w)-1,q=f;;q=f){var z=d[rS(r,f)&Z],ge=z>>4;if(f+=z&15,f>x){c&&wi(0);break}if(z||wi(2),ge<256)t[h++]=ge;else if(ge==256){q=f,d=null;break}else{var ke=ge-254;if(ge>264){var K=ge-257,le=TU[K];ke=Po(r,f,(1<<le)-1)+RU[K],f+=le}var De=m[rS(r,f)&ne],et=De>>4;De||wi(3),f+=De&15;var N=qJ[et];if(et>3){var le=CU[et];N+=rS(r,f)&(1<<le)-1,f+=le}if(f>x){c&&wi(0);break}a&&l(h+131072);var Ye=h+ke;if(h<N){var pt=o-N,bt=Math.min(N,Ye);for(pt+h<0&&wi(3);h<bt;++h)t[h]=n[pt+h]}for(;h<Ye;++h)t[h]=t[h-N]}}e.l=d,e.p=q,e.b=h,e.f=u,d&&(u=1,e.m=g,e.d=m,e.n=w)}while(!u);return h!=t.length&&s?XJ(t,0,h):t.subarray(0,h)};var QJ=new xi(0);var ZJ=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&wi(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!r[t++]);return t+(e&2)},JJ=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0};var eee=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&wi(6,"invalid zlib data"),(r[1]>>5&1)==+!e&&wi(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function tee(r,e){return iS(r,{i:2},e&&e.out,e&&e.dictionary)}function ree(r,e){var t=ZJ(r);return t+8>r.length&&wi(6,"invalid gzip data"),iS(r.subarray(t,-8),{i:2},e&&e.out||new xi(JJ(r)),e&&e.dictionary)}function nee(r,e){return iS(r.subarray(eee(r,e&&e.dictionary),-4),{i:2},e&&e.out,e&&e.dictionary)}function OU(r,e){return r[0]==31&&r[1]==139&&r[2]==8?ree(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?tee(r,e):nee(r,e)}var iee=typeof TextDecoder<"u"&&new TextDecoder,oee=0;try{iee.decode(QJ,{stream:!0}),oee=1}catch{}var zU=it(FU(),1);var $u={LocalFileHeader:67324752,DataDescriptor:134695760,CentralFileHeader:33639248,EndOfCentralDirectory:101010256},oS={get(r){let e=Ut.get(r,6);return{signature:sr.get(r,0),compressedSize:sr.get(r,8),uncompressedSize:sr.get(r,12)}},len:16},$U={get(r){let e=Ut.get(r,6);return{signature:sr.get(r,0),minVersion:Ut.get(r,4),dataDescriptor:!!(e&8),compressedMethod:Ut.get(r,8),compressedSize:sr.get(r,18),uncompressedSize:sr.get(r,22),filenameLength:Ut.get(r,26),extraFieldLength:Ut.get(r,28),filename:null}},len:30},HU={get(r){return{signature:sr.get(r,0),nrOfThisDisk:Ut.get(r,4),nrOfThisDiskWithTheStart:Ut.get(r,6),nrOfEntriesOnThisDisk:Ut.get(r,8),nrOfEntriesOfSize:Ut.get(r,10),sizeOfCd:sr.get(r,12),offsetOfStartOfCd:sr.get(r,16),zipFileCommentLength:Ut.get(r,20)}},len:22},VU={get(r){let e=Ut.get(r,8);return{signature:sr.get(r,0),minVersion:Ut.get(r,6),dataDescriptor:!!(e&8),compressedMethod:Ut.get(r,10),compressedSize:sr.get(r,20),uncompressedSize:sr.get(r,24),filenameLength:Ut.get(r,28),extraFieldLength:Ut.get(r,30),fileCommentLength:Ut.get(r,32),relativeOffsetOfLocalHeader:sr.get(r,42),filename:null}},len:46};function KU(r){let e=new Uint8Array(sr.len);return sr.put(e,0,r),e}var us=(0,zU.default)("tokenizer:inflate"),sS=256*1024,wee=KU($u.DataDescriptor),Z5=KU($u.EndOfCentralDirectory),J5=class{constructor(e){this.tokenizer=e,this.syncBuffer=new Uint8Array(sS)}async isZip(){return await this.peekSignature()===$u.LocalFileHeader}peekSignature(){return this.tokenizer.peekToken(sr)}async findEndOfCentralDirectoryLocator(){let e=this.tokenizer,t=Math.min(16*1024,e.fileInfo.size),n=this.syncBuffer.subarray(0,t);await this.tokenizer.readBuffer(n,{position:e.fileInfo.size-t});for(let i=n.length-4;i>=0;i--)if(n[i]===Z5[0]&&n[i+1]===Z5[1]&&n[i+2]===Z5[2]&&n[i+3]===Z5[3])return e.fileInfo.size-t+i;return-1}async readCentralDirectory(){if(!this.tokenizer.supportsRandomAccess()){us("Cannot reading central-directory without random-read support");return}us("Reading central-directory...");let e=this.tokenizer.position,t=await this.findEndOfCentralDirectoryLocator();if(t>0){us("Central-directory 32-bit signature found");let n=await this.tokenizer.readToken(HU,t),i=[];this.tokenizer.setPosition(n.offsetOfStartOfCd);for(let o=0;o<n.nrOfEntriesOfSize;++o){let s=await this.tokenizer.readToken(VU);if(s.signature!==$u.CentralFileHeader)throw new Error("Expected Central-File-Header signature");s.filename=await this.tokenizer.readToken(new Yn(s.filenameLength,"utf-8")),await this.tokenizer.ignore(s.extraFieldLength),await this.tokenizer.ignore(s.fileCommentLength),i.push(s),us(`Add central-directory file-entry: n=${o+1}/${i.length}: filename=${i[o].filename}`)}return this.tokenizer.setPosition(e),i}this.tokenizer.setPosition(e)}async unzip(e){let t=await this.readCentralDirectory();if(t)return this.iterateOverCentralDirectory(t,e);let n=!1;do{let i=await this.readLocalFileHeader();if(!i)break;let o=e(i);n=!!o.stop;let s;if(await this.tokenizer.ignore(i.extraFieldLength),i.dataDescriptor&&i.compressedSize===0){let a=[],c=sS;us("Compressed-file-size unknown, scanning for next data-descriptor-signature....");let l=-1;for(;l<0&&c===sS;){c=await this.tokenizer.peekBuffer(this.syncBuffer,{mayBeLess:!0}),l=xee(this.syncBuffer.subarray(0,c),wee);let u=l>=0?l:c;if(o.handler){let f=new Uint8Array(u);await this.tokenizer.readBuffer(f),a.push(f)}else await this.tokenizer.ignore(u)}us(`Found data-descriptor-signature at pos=${this.tokenizer.position}`),o.handler&&await this.inflate(i,bee(a),o.handler)}else o.handler?(us(`Reading compressed-file-data: ${i.compressedSize} bytes`),s=new Uint8Array(i.compressedSize),await this.tokenizer.readBuffer(s),await this.inflate(i,s,o.handler)):(us(`Ignoring compressed-file-data: ${i.compressedSize} bytes`),await this.tokenizer.ignore(i.compressedSize));if(us(`Reading data-descriptor at pos=${this.tokenizer.position}`),i.dataDescriptor&&(await this.tokenizer.readToken(oS)).signature!==134695760)throw new Error(`Expected data-descriptor-signature at position ${this.tokenizer.position-oS.len}`)}while(!n)}async iterateOverCentralDirectory(e,t){for(let n of e){let i=t(n);if(i.handler){this.tokenizer.setPosition(n.relativeOffsetOfLocalHeader);let o=await this.readLocalFileHeader();if(o){await this.tokenizer.ignore(o.extraFieldLength);let s=new Uint8Array(n.compressedSize);await this.tokenizer.readBuffer(s),await this.inflate(o,s,i.handler)}}if(i.stop)break}}inflate(e,t,n){if(e.compressedMethod===0)return n(t);us(`Decompress filename=${e.filename}, compressed-size=${t.length}`);let i=OU(t);return n(i)}async readLocalFileHeader(){let e=await this.tokenizer.peekToken(sr);if(e===$u.LocalFileHeader){let t=await this.tokenizer.readToken($U);return t.filename=await this.tokenizer.readToken(new Yn(t.filenameLength,"utf-8")),t}if(e===$u.CentralFileHeader)return!1;throw e===3759263696?new Error("Encrypted ZIP"):new Error("Unexpected signature")}};function xee(r,e){let t=r.length,n=e.length;if(n>t)return-1;for(let i=0;i<=t-n;i++){let o=!0;for(let s=0;s<n;s++)if(r[i+s]!==e[s]){o=!1;break}if(o)return i}return-1}function bee(r){let e=r.reduce((i,o)=>i+o.length,0),t=new Uint8Array(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}var lit={utf8:new globalThis.TextDecoder("utf8")};var uit=new globalThis.TextEncoder;var fit=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function aS(r){let{byteLength:e}=r;if(e===6)return r.getUint16(0)*2**32+r.getUint32(2);if(e===5)return r.getUint8(0)*2**32+r.getUint32(1);if(e===4)return r.getUint32(0);if(e===3)return r.getUint8(0)*2**16+r.getUint16(1);if(e===2)return r.getUint16(0);if(e===1)return r.getUint8(0)}function vee(r,e){let t=r.length,n=e.length;if(n===0||n>t)return-1;let i=t-n;for(let o=0;o<=i;o++){let s=!0;for(let a=0;a<n;a++)if(r[o+a]!==e[a]){s=!1;break}if(s)return o}return-1}function qU(r,e){return vee(r,e)!==-1}function jU(r){return[...r].map(e=>e.charCodeAt(0))}function WU(r,e=0){let t=Number.parseInt(new Yn(6).get(r,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(t))return!1;let n=8*32;for(let i=e;i<e+148;i++)n+=r[i];for(let i=e+156;i<e+512;i++)n+=r[i];return t===n}var GU={get:(r,e)=>r[e+3]&127|r[e+2]<<7|r[e+1]<<14|r[e]<<21,len:4};var XU=["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ttc","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","ai","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx","vtt","apk","drc","lz4","potx","xltx","dotx","xltm","ott","ots","otp","odg","otg","xlsm","docm","dotm","potm","pptm","jar","rm"],YU=["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/x-apache-arrow","video/mp4","audio/midi","video/x-matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","video/ogg","audio/ogg","audio/ogg; codecs=opus","application/ogg","audio/x-flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","font/collection","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","text/vtt","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/x-parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio","application/vnd.android.package-archive","application/vnd.google.draco","application/x-lz4","application/vnd.openxmlformats-officedocument.presentationml.template","application/vnd.openxmlformats-officedocument.spreadsheetml.template","application/vnd.openxmlformats-officedocument.wordprocessingml.template","application/vnd.ms-excel.template.macroenabled.12","application/vnd.oasis.opendocument.text-template","application/vnd.oasis.opendocument.spreadsheet-template","application/vnd.oasis.opendocument.presentation-template","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.graphics-template","application/vnd.ms-excel.sheet.macroEnabled.12","application/vnd.ms-word.document.macroEnabled.12","application/vnd.ms-word.template.macroEnabled.12","application/vnd.ms-powerpoint.template.macroEnabled.12","application/vnd.ms-powerpoint.presentation.macroEnabled.12","application/java-archive","application/vnd.rn-realmedia"];var cS=4100;async function QU(r){return new uS().fromBuffer(r)}function lS(r){switch(r){case"application/epub+zip":return{ext:"epub",mime:"application/epub+zip"};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};case"application/vnd.oasis.opendocument.text-template":return{ext:"ott",mime:"application/vnd.oasis.opendocument.text-template"};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};case"application/vnd.oasis.opendocument.spreadsheet-template":return{ext:"ots",mime:"application/vnd.oasis.opendocument.spreadsheet-template"};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};case"application/vnd.oasis.opendocument.presentation-template":return{ext:"otp",mime:"application/vnd.oasis.opendocument.presentation-template"};case"application/vnd.oasis.opendocument.graphics":return{ext:"odg",mime:"application/vnd.oasis.opendocument.graphics"};case"application/vnd.oasis.opendocument.graphics-template":return{ext:"otg",mime:"application/vnd.oasis.opendocument.graphics-template"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};case"application/vnd.ms-excel.sheet.macroEnabled":return{ext:"xlsm",mime:"application/vnd.ms-excel.sheet.macroEnabled.12"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.template":return{ext:"xltx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.template"};case"application/vnd.ms-excel.template.macroEnabled":return{ext:"xltm",mime:"application/vnd.ms-excel.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};case"application/vnd.ms-word.document.macroEnabled":return{ext:"docm",mime:"application/vnd.ms-word.document.macroEnabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.template":return{ext:"dotx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.template"};case"application/vnd.ms-word.template.macroEnabledTemplate":return{ext:"dotm",mime:"application/vnd.ms-word.template.macroEnabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.template":return{ext:"potx",mime:"application/vnd.openxmlformats-officedocument.presentationml.template"};case"application/vnd.ms-powerpoint.template.macroEnabled":return{ext:"potm",mime:"application/vnd.ms-powerpoint.template.macroEnabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.presentation":return{ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"};case"application/vnd.ms-powerpoint.presentation.macroEnabled":return{ext:"pptm",mime:"application/vnd.ms-powerpoint.presentation.macroEnabled.12"};case"application/vnd.ms-visio.drawing":return{ext:"vsdx",mime:"application/vnd.visio"};case"application/vnd.ms-package.3dmanufacturing-3dmodel+xml":return{ext:"3mf",mime:"model/3mf"};default:}}function fs(r,e,t){t={offset:0,...t};for(let[n,i]of e.entries())if(t.mask){if(i!==(t.mask[n]&r[n+t.offset]))return!1}else if(i!==r[n+t.offset])return!1;return!0}var uS=class{constructor(e){this.detectors=[...e?.customDetectors??[],{id:"core",detect:this.detectConfident},{id:"core.imprecise",detect:this.detectImprecise}],this.tokenizerOptions={abortSignal:e?.signal}}async fromTokenizer(e){let t=e.position;for(let n of this.detectors){let i=await n.detect(e);if(i)return i;if(t!==e.position)return}}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);let t=e instanceof Uint8Array?e:new Uint8Array(e);if(t?.length>1)return this.fromTokenizer(IU(t,this.tokenizerOptions))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){let t=await _U(e,this.tokenizerOptions);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){let{sampleSize:n=cS}=t,i,o,s=e.getReader({mode:"byob"});try{let{value:l,done:u}=await s.read(new Uint8Array(n));if(o=l,!u&&l)try{i=await this.fromBuffer(l.slice(0,n))}catch(f){if(!(f instanceof Vt))throw f;i=void 0}o=l}finally{s.releaseLock()}let a=new TransformStream({async start(l){l.enqueue(o)},transform(l,u){u.enqueue(l)}}),c=e.pipeThrough(a);return c.fileType=i,c}check(e,t){return fs(this.buffer,e,t)}checkString(e,t){return this.check(jU(e),t)}detectConfident=async e=>{if(this.buffer=new Uint8Array(cS),e.fileInfo.size===void 0&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.detectConfident(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);let t=await e.readToken(GU);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((this.buffer[0]===67||this.buffer[0]===70)&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){let t;return await new J5(e).unzip(n=>{switch(n.filename){case"META-INF/mozilla.rsa":return t={ext:"xpi",mime:"application/x-xpinstall"},{stop:!0};case"META-INF/MANIFEST.MF":return t={ext:"jar",mime:"application/java-archive"},{stop:!0};case"mimetype":return{async handler(i){let o=new TextDecoder("utf-8").decode(i).trim();t=lS(o)},stop:!0};case"[Content_Types].xml":return{async handler(i){let o=new TextDecoder("utf-8").decode(i),s=o.indexOf('.main+xml"');if(s===-1){let a="application/vnd.ms-package.3dmanufacturing-3dmodel+xml";o.includes(`ContentType="${a}"`)&&(t=lS(a))}else{o=o.slice(0,Math.max(0,s));let a=o.lastIndexOf('"'),c=o.slice(Math.max(0,a+1));t=lS(c)}},stop:!0};default:return/classes\d*\.dex/.test(n.filename)?(t={ext:"apk",mime:"application/vnd.android.package-archive"},{stop:!0}):{}}}),t??{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);let t=new Uint8Array(8);return await e.readBuffer(t),fs(t,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/ogg; codecs=opus"}:fs(t,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:fs(t,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:fs(t,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:fs(t,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:fs(t,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(this.buffer[2]===3||this.buffer[2]===5||this.buffer[2]===7)&&(this.buffer[3]===4||this.buffer[3]===6||this.buffer[3]===8))return{ext:"zip",mime:"application/zip"};if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/x-flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF")){try{if(await e.ignore(1350)===1350){let i=new Uint8Array(Math.min(10485760,e.fileInfo.size-1350));if(await e.readBuffer(i,{mayBeLess:!0}),qU(i,new TextEncoder().encode("AIPrivateData")))return{ext:"ai",mime:"application/postscript"}}}catch(t){if(!(t instanceof Vt))throw t}return{ext:"pdf",mime:"application/pdf"}}if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){let t=await this.readTiffHeader(!1);if(t)return t}if(this.check([77,77])){let t=await this.readTiffHeader(!0);if(t)return t}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function t(){let a=await e.peekNumber(vU),c=128,l=0;for(;(a&c)===0&&c!==0;)++l,c>>=1;let u=new Uint8Array(l+1);return await e.readBuffer(u),u}async function n(){let a=await t(),c=await t();c[0]^=128>>c.length-1;let l=Math.min(6,c.length),u=new DataView(a.buffer),f=new DataView(c.buffer,c.length-l,l);return{id:aS(u),len:aS(f)}}async function i(a){for(;a>0;){let c=await n();if(c.id===17026)return(await e.readToken(new Yn(c.len))).replaceAll(/\00.*$/g,"");await e.ignore(c.len),--a}}let o=await n();switch(await i(o.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/x-matroska"};default:return}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1"))return{ext:"parquet",mime:"application/x-parquet"};if(this.checkString("ttcf"))return{ext:"ttc",mime:"font/collection"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([4,34,77,24]))return{ext:"lz4",mime:"application/x-lz4"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.checkString(".RMF"))return{ext:"rm",mime:"application/vnd.rn-realmedia"};if(this.checkString("DRACO"))return{ext:"drc",mime:"application/vnd.google.draco"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(this.buffer[6]===0||this.buffer[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){let t=new Yn(4,"latin1").get(this.buffer,2);if(t.match("^d*")&&t>=1e3&&t<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),await e.readToken(new Yn(13,"ascii"))==="debian-binary"?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("WEBVTT")&&[`
`,"\r","	"," ","\0"].some(t=>this.checkString(t,{offset:6})))return{ext:"vtt",mime:"text/vtt"};if(this.check([137,80,78,71,13,10,26,10])){await e.ignore(8);async function t(){return{length:await e.readToken(SU),type:await e.readToken(new Yn(4,"latin1"))}}do{let n=await t();if(n.length<0)return;switch(n.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(n.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/x-apache-arrow"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.checkString("ftyp",{offset:4})&&(this.buffer[8]&96)!==0){let t=new Yn(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(t){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return t.startsWith("3g")?t.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.check([82,73,70,70])){if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function t(){let n=new Uint8Array(16);return await e.readBuffer(n),{id:n,size:Number(await e.readToken(AU))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){let n=await t(),i=n.size-24;if(fs(n.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){let o=new Uint8Array(16);if(i-=await e.readBuffer(o),fs(o,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(fs(o,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(i)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new Yn(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("**ACE",{offset:7})&&this.checkString("**",{offset:12}))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){let t=new DataView(this.buffer.buffer).getUint32(12,!0);if(t>12&&this.buffer.length>=t+16)try{let n=new TextDecoder().decode(this.buffer.slice(16,t+16));if(JSON.parse(n).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),WU(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"}};detectImprecise=async e=>{if(this.buffer=new Uint8Array(cS),await e.peekBuffer(this.buffer,{length:Math.min(8,e.fileInfo.size),mayBeLess:!0}),this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(this.buffer.length>=2&&this.check([255,224],{offset:0,mask:[255,224]})){if(this.check([16],{offset:1,mask:[22]}))return this.check([8],{offset:1,mask:[8]})?{ext:"aac",mime:"audio/aac"}:{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}};async readTiffTag(e){let t=await this.tokenizer.readToken(e?lh:Ut);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"};default:}}async readTiffIFD(e){let t=await this.tokenizer.readToken(e?lh:Ut);for(let n=0;n<t;++n){let i=await this.readTiffTag(e);if(i)return i}}async readTiffHeader(e){let t=(e?lh:Ut).get(this.buffer,2),n=(e?EU:sr).get(this.buffer,4);if(t===42){if(n>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(n>=8){let o=(e?lh:Ut).get(this.buffer,8),s=(e?lh:Ut).get(this.buffer,10);if(o===28&&s===254||o===31&&s===11)return{ext:"nef",mime:"image/x-nikon-nef"}}}return await this.tokenizer.ignore(n),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(t===43)return{ext:"tif",mime:"image/tiff"}}},bit=new Set(XU),vit=new Set(YU);var Ac=ze("helia:verified-fetch:content-type-parser"),e8="application/octet-stream";function Eee(r){return Ac("checking for svg"),/^(<\?xml[^>]+>)?[^<^\w]+<svg/ig.test(r)}async function See(r){Ac("checking for json");try{return JSON.parse(r),!0}catch(e){return Ac("failed to parse as json",e),!1}}function Aee(r){Ac("checking for text");let e=new TextDecoder("utf-8",{fatal:!0});try{return e.decode(r)}catch{return null}}async function _ee(r){return Ac("checking for html"),/^\s*<(?:!doctype\s+html|html|head|body)\b/i.test(r)}async function ZU(r,e){Ac("contentTypeParser called for fileName: %s, byte size=%s",e,r.length);let t=(await QU(r))?.mime;if(t!=null)return Ac("detectedType: %s",t),t;if(Ac("no detectedType"),e==null){let n=Aee(r);return n!=null?Eee(n)?"image/svg+xml":await See(n)?"application/json":await _ee(n)?"text/html; charset=utf-8":"text/plain; charset=utf-8":e8}switch(e.split(".").pop()){case"css":return"text/css";case"html":return"text/html; charset=utf-8";case"js":return"application/javascript";case"json":return"application/json";case"txt":return"text/plain";case"woff2":return"font/woff2";case"svg":return"image/svg+xml";case"csv":return"text/csv";case"doc":return"application/msword";case"xls":return"application/vnd.ms-excel";case"ppt":return"application/vnd.ms-powerpoint";case"msi":return"application/x-msdownload";default:return e8}}function JU(r){return r?.then!=null}async function t8({bytes:r,path:e,response:t,contentTypeParser:n,log:i,defaultContentType:o="application/octet-stream"}){let s;if(n!=null)try{let a=e.split("/").pop()?.trim();a=a===""?void 0:a;let c=n(r,a);if(JU(c)){let l=await c;l!=null&&(s=l)}else c!=null&&(s=c);i.trace("contentTypeParser returned %s",s)}catch(a){i.error("error parsing content type",a)}s===e8&&(s=o),i.trace('setting content type to "%s"',s??o),t.headers.set("content-type",s??o)}var r8=class extends Mt{codes=[ct];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),n==null||i==null?!1:e.code===ct}getRedirectUrl(e){let{resource:t,path:n}=e;if(n===""?!t.toString().endsWith("/"):!n.endsWith("/"))try{let o=new URL(t.toString());return o.pathname.endsWith("/")?null:(o.pathname=`${o.pathname}/`,o.toString())}catch{return`${t.toString()}/`}return null}async handle(e){let{cid:t,options:n,withServerTiming:i=!1,pathDetails:o}=e,{handleServerTiming:s,contentTypeParser:a,helia:c,getBlockstore:l}=this.pluginOptions,u=this.log,f=e.resource,h=e.path,d=!1,m=e.byteRangeContext,g=o.ipfsRoots,w=o.terminalElement,x=w.cid;if(w?.type==="directory"){let S=w.cid,T=this.getRedirectUrl(e);if(T!=null){if(u.trace("directory url normalization spec requires redirect..."),n?.redirect==="error")throw u('could not redirect to %s as redirect option was set to "error"',T),new TypeError("Failed to fetch");if(n?.redirect==="manual")return u("returning 301 permanent redirect to %s",T),km(f,T);u("following redirect to %s",T),f=T,d=!0}let D="index.html";try{u.trace("found directory at %c/%s, looking for index.html",t,h);let A=await s("exporter-dir","",async()=>pr(`/ipfs/${S}/${D}`,c.blockstore,{signal:n?.signal,onProgress:n?.onProgress}),i);u.trace("found root file at %c/%s with cid %c",S,D,A.cid),h=D,x=A.cid}catch(A){this.log.error("error loading path %c/%s",S,D,A),n?.signal?.throwIfAborted(),e.isDirectory=!0,e.directoryEntries=[],e.modified++,this.log.trace("attempting to get directory entries because index.html was not found");let I=yU({...c,blockstore:l(e.cid,e.resource,n?.session??!0,n)});try{for await(let k of I.ls(S,{signal:n?.signal,onProgress:n?.onProgress}))e.directoryEntries.push(k);return null}catch(k){return u.error("error listing directory %c",S,k),m5("Unable to get directory contents")}}finally{n?.onProgress?.(new G("verified-fetch:request:end",{cid:S,path:D}))}}m.isRangeRequest&&m.isValidRangeRequest&&w.type==="file"&&(m.setFileSize(w.unixfs.fileSize()),u.trace("fileSize for rangeRequest %d",m.getFileSize()));let v=m.offset,b=m.length;u.trace("calling exporter for %c/%s with offset=%o & length=%o",x,h,v,b);try{let T=(await s("exporter-file","",async()=>pr(x,c.blockstore,{signal:n?.signal,onProgress:n?.onProgress}),i)).content({signal:n?.signal,onProgress:n?.onProgress,offset:v,length:b});u("got async iterator for %c/%s",t,h);let{stream:D,firstChunk:A}=await s("stream-and-chunk","",async()=>wU(T,h??"",this.pluginOptions.logger,{onProgress:n?.onProgress,signal:n?.signal}),i);m.setBody(D);let I=cn(f,m.getBody(),{byteRangeContext:m,log:u},{redirected:d});return await s("set-content-type","",async()=>t8({bytes:A,path:h,response:I,contentTypeParser:a,log:u}),i),c5(I,g),I}catch(S){return n?.signal?.throwIfAborted(),u.error("error streaming %c/%s",t,h,S),m.isRangeRequest&&S.code==="ERR_INVALID_PARAMS"?p5(f):Qd(f.toString(),"Unable to stream content")}}};var n8=class extends Mt{canHandle(e){this.log("checking if we can handle %c with accept %s",e.cid,e.accept);let{pathDetails:t,cid:n}=e;return t!=null?!1:n.code===ct||n.code===Pn}async handle(e){let{cid:t,resource:n,options:i,withServerTiming:o=!1}=e,{getBlockstore:s,handleServerTiming:a}=this.pluginOptions,c=s(t,n,i?.session??!0,i),l=await a("path-walking","",async()=>NM({...e,blockstore:c,log:this.log}),o);return e.modified++,l instanceof Response?(this.log.trace("path walking failed"),l.status===404?l:null):(e.pathDetails=l,null)}};var eF;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(eF||(eF={}));function i8(r){return r.charAt(0)==="1"||r.charAt(0)==="Q"?at(r):gn(W.parse(r))}var Km=class extends Error{name="PluginError";code;fatal;details;response;constructor(e,t,n){super(t),this.code=e,this.fatal=n?.fatal??!1,this.details=n?.details,this.response=n?.response}},na=class extends Km{name="PluginFatalError";constructor(e,t,n){super(e,t,{...n,fatal:!0}),this.name="PluginFatalError"}};var o8=class extends Mt{codes=[];canHandle({cid:e,accept:t,query:n,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/vnd.ipfs.ipns-record"||n.format==="ipns-record"}async handle(e){let{resource:t,path:n,options:i}=e,{helia:o}=this.pluginOptions;if(e.reqFormat="ipns-record",n!==""||!(t.startsWith("ipns://")||t.includes(".ipns.")||t.includes("/ipns/")))throw this.log.error('invalid request for IPNS name "%s" and path "%s"',t,n),new na("ERR_INVALID_IPNS_NAME","Invalid IPNS name",{response:Cm(t,new Error("Invalid IPNS name"))});let s;try{let h;t.startsWith("ipns://")?h=t.replace("ipns://",""):t.includes("/ipns/")?h=t.split("/ipns/")[1].split("/")[0].split("?")[0]:h=t.split(".ipns.")[0].split("://")[1],this.log.trace('trying to parse peer id from "%s"',h),s=i8(h)}catch(h){throw this.log.error("could not parse peer id from IPNS url %s",t,h),new na("ERR_NO_PEER_ID_FOUND","could not parse peer id from url",{response:Cm(t,h)})}let a=Ve([O("/ipns/"),s.toMultihash().bytes]),c=new nt("/dht/record/"+H(a,"base32"),!1),l=await o.datastore.get(c,i),u=kt.deserialize(l);e.byteRangeContext.setBody(u.value);let f=cn(t,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type","application/vnd.ipfs.ipns-record"),f}};var s8=class extends Mt{codes=[qo,Lo];canHandle({cid:e,accept:t,byteRangeContext:n}){return this.log("checking if we can handle %c with accept %s",e,t),n==null?!1:t==="application/vnd.ipld.dag-json"&&e.code!==Pn?!0:qo===e.code||Lo===e.code}async handle(e){let{path:t,resource:n,cid:i,accept:o,options:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.session??!0;this.log.trace("fetching %c/%s",i,t);let l=e.pathDetails?.terminalElement.cid??e.cid,f=await a(l,n,c,s).get(l,s),h;if(o==="application/vnd.ipld.dag-cbor"||o==="application/cbor")try{let m=If(f);h=Af(m)}catch(m){return this.log.error("could not transform %c to application/vnd.ipld.dag-cbor",m),ta(n)}else h=f;e.byteRangeContext.setBody(h);let d=cn(n,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log});return d.headers.set("content-type",o??"application/json"),d}};var Iee=["application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/octet-stream"];function Tee({headers:r,accept:e}){let n=(e??new Headers(r).get("accept")??"").split(",").map(i=>i.split(";")[0]).map(i=>i.trim());for(let i of n){if(i==="*/*")return;if(Iee.includes(i??""))return i}}var a8=class extends Mt{codes=[vt,cr.code];canHandle({cid:e,accept:t,query:n,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/vnd.ipld.raw"||n.format==="raw"}async handle(e){let{path:t,resource:n,cid:i,accept:o,query:s,options:a}=e,{getBlockstore:c,contentTypeParser:l}=this.pluginOptions,u=a?.session??!0,f=this.log;if(o==="application/vnd.ipld.raw"||s.format==="raw"?(e.reqFormat="raw",e.query.download=!0,e.query.filename=e.query.filename??`${i.toString()}.bin`,f.trace("Set content disposition...")):f.trace("Did NOT set content disposition..."),t!==""&&i.code===vt)throw f.trace("404-ing raw codec request for %c/%s",i,t),new na("ERR_RAW_PATHS_NOT_SUPPORTED","Raw codec does not support paths",{response:g5(n,"Raw codec does not support paths")});let h=e.pathDetails?.terminalElement.cid??e.cid,m=await c(h,n,u,a).get(h,a);e.byteRangeContext.setBody(m);let g=cn(n,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:f},{redirected:!1});return await t8({bytes:m,path:t,response:g,defaultContentType:Tee({headers:a?.headers,accept:o}),contentTypeParser:l,log:f}),g}};var Cee=({weak:r,reqFormat:e})=>e==="tar"||e==="car"||e==="ipns-record"||r===!0?"W/":"",kee=({reqFormat:r})=>r==null?"":r==="tar"?".x-tar":`.${r}`;function mh({cid:r,reqFormat:e,weak:t,rangeStart:n,rangeEnd:i,contentPrefix:o}){let s=Cee({weak:t,reqFormat:e}),a=kee({reqFormat:e});return(n!=null||i!=null)&&(a+=`.${n??"0"}-${i??"N"}`),`${s}"${o??""}${r.toString()}${a}"`}var Sot=O("ustar\0","binary"),Aot=O("ustar ","binary"),_ot=O(" \0","binary");var oF=it(rF(),1);function Ree(r){return r[Symbol.asyncIterator]!=null}function Dee(r){if(Ree(r))return(async()=>{let n=new Uint8Array(0);for await(let i of r)n=Ve([n,i],n.length+i.length);return n})();let e=[],t=0;for(let n of r)e.push(n),t+=n.byteLength;return Ve(e,t)}var nF=Dee;var Nee="0000000000000000000",Oee="7777777777777777777",Lee=48,Bee=O("ustar\0","binary"),Mee=O("00","binary"),Uee=parseInt("7777",8),Fee=257,$ee=263,Hee=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},Vee=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},_c=function(r,e){let t=r.toString(8);return t.length>e?O(Oee.slice(0,e)+" "):O(Nee.slice(0,e-t.length)+t+" ")},fS=function(r){let e=O(r).byteLength,t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function iF(r){let e="";r.name!=null&&(e+=fS(" path="+r.name+`
`)),r.linkname!=null&&(e+=fS(" linkpath="+r.linkname+`
`));let t=r.pax;if(t!=null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=fS(" "+n+"="+t[n]+`
`));return O(e)}function c8(r){let e=new Uint8Array(512),t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),O(t).byteLength!==t.length)return null;for(;O(t).byteLength>100;){let i=t.indexOf("/");if(i===-1)return null;n+=n!==""?"/"+t.slice(0,i):t.slice(0,i),t=t.slice(i+1)}return O(t).byteLength>100||O(n).byteLength>155||r.linkname!=null&&O(r.linkname).byteLength>100?null:(e.set(O(t),0),e.set(_c(r.mode&Uee,6),100),e.set(_c(r.uid,6),108),e.set(_c(r.gid,6),116),e.set(_c(r.size,11),124),e.set(_c(r.mtime.getTime()/1e3|0,11),136),e[156]=Lee+Hee(r.type),r.linkname!=null&&e.set(O(r.linkname),157),e.set(Bee,Fee),e.set(Mee,$ee),r.uname!=null&&e.set(O(r.uname),265),r.gname!=null&&e.set(O(r.gname),297),e.set(_c(r.devmajor??0,6),329),e.set(_c(r.devminor??0,6),337),n!=null&&e.set(O(n),345),e.set(_c(Vee(e),6),148),e)}var{S_IFMT:Kee,S_IFBLK:qee,S_IFCHR:jee,S_IFDIR:Wee,S_IFIFO:Gee,S_IFLNK:Xee}=oF.default,Yee=parseInt("755",8),Qee=parseInt("644",8),sF=new Uint8Array(1024);function Zee(r=0){switch(r&Kee){case qee:return"block-device";case jee:return"character-device";case Wee:return"directory";case Gee:return"fifo";case Xee:return"symlink";default:return"file"}}function hS(r){return r&=511,r!==0?sF.subarray(0,512-r):new Uint8Array(0)}function dS(r){if(r.pax==null){let e=c8(r);if(e!=null)return e}return Jee(r)}function Jee(r){let e=iF(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new oe(c8(t)??new Uint8Array(0),e,hS(e.length),c8({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function l8(){return async function*(r){for await(let{header:e,body:t}of r){let n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??Zee(e.mode),mode:e.mode??(e.type==="directory"?Yee:Qee),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=O(t)),t instanceof Uint8Array||vi(t)){n.size=t.length,yield dS(n),yield vi(t)?t.subarray():t,yield hS(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=H(await nF(t)),yield dS(n);continue}if(yield dS(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let i=0;for await(let o of t??[])i+=o.length,yield vi(o)?o.subarray():o;if(i!==n.size)throw new Error(`size mismatch, wrote ${i} of ${n.size} bytes`);yield hS(n.size)}yield sF}}var ete=["file","raw","directory"];function tte(r){let e,t;return(r.type==="file"||r.type==="directory")&&(e=r.unixfs.mode,t=r.unixfs.mtime!=null?new Date(Number(r.unixfs.mtime.secs*1000n)):void 0),{name:r.path,mode:e,mtime:t,size:Number(r.size),type:r.type==="directory"?"directory":"file"}}function aF(r){if(!ete.includes(r.type))throw new gi(`${r.type} is not a UnixFS node`);let e={header:tte(r)};return(r.type==="file"||r.type==="raw")&&(e.body=r.content()),e}async function*cF(r,e,t){let n=await pr(r,e,t);if(n.type==="file"||n.type==="raw"){yield*ot([aF(n)],l8());return}if(n.type==="directory"){yield*ot(ih(r,e,t),i=>Nt(i,o=>aF(o)),l8());return}throw new gi("Not a UnixFS node")}var u8=class extends Mt{codes=[];canHandle({cid:e,accept:t,query:n,byteRangeContext:i}){return this.log("checking if we can handle %c with accept %s",e,t),i==null?!1:t==="application/x-tar"||n.format==="tar"}async handle(e){let{cid:t,path:n,resource:i,options:o,pathDetails:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.terminalElement.cid??t;if(c.code!==ct&&c.code!==vt)return ta("only UnixFS data can be returned in a TAR file");e.reqFormat="tar",e.query.download=!0,e.query.filename=e.query.filename??`${c.toString()}.tar`;let l=a(c,i,o?.session,o),u=Tm(cF(`/ipfs/${t}/${n}`,l,o));e.byteRangeContext.setBody(u);let f=cn(i,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type","application/x-tar"),f.headers.set("etag",mh({cid:c,reqFormat:e.reqFormat,weak:!0})),f}};function lF(r){let e=rte(r);return e===r?`filename="${r}"`:`filename="${e}"; filename*=UTF-8''${encodeURIComponent(r)}`}function rte(r){return r.replace(/[^\x00-\x7F]/g,"_")}var nte={[Pn]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[qo]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[Lo]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[ct]:["application/octet-stream","application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","application/x-tar"],[vt]:["application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.dag-json","application/vnd.ipld.car","application/x-tar"]};function uF(r,e){let t=nte[r.code];if(e!=null)return ite(e,t)}function ite(r,e){let t=r.split(",").map(n=>{let i=n.trim().split(";");return{mimeType:`${i[0]}`.trim(),weight:ote(i[1])}}).sort((n,i)=>n.weight===i.weight?0:n.weight>i.weight?-1:1).map(n=>n.mimeType);for(let n of t)for(let i of e)if(n.includes(i)||n==="*/*"||n.startsWith("*/")&&i.split("/")[1]===n.split("/")[1]||n.endsWith("/*")&&i.split("/")[0]===n.split("/")[0])return i}function ote(r){if(r!=null&&(r=r.trim()),r?.startsWith("q=")!==!0)return 1;let e=parseFloat(r.replace("q=",""));return isNaN(e)?0:e}var f8={raw:"application/vnd.ipld.raw",car:"application/vnd.ipld.car","dag-json":"application/vnd.ipld.dag-json","dag-cbor":"application/vnd.ipld.dag-cbor",json:"application/json",cbor:"application/cbor","ipns-record":"application/vnd.ipfs.ipns-record",tar:"application/x-tar"};function fF(r){if(r!=null)return f8[r]}function pS(r){let e=r.get("accept");return!!(e!=null&&Object.values(f8).includes(e))}function mS(r){let e=r?.format;return!!(e!=null&&Object.keys(f8).includes(e))}function dF({query:r,headers:e}){return pS(e)||mS(r)}function hF({query:r,headers:e,logger:t}){let n=t.forComponent("helia:verified-fetch:get-resolved-accept-header"),i=new Headers(e),o=i.get("accept")??void 0;if(o!=null&&n('incoming accept header "%s"',o),!dF({query:r,headers:i}))return n("no explicit IPLD content-type requested, returning incoming accept header %s",o),o;let s=fF(r?.format);r?.format!=null&&n('incoming query format "%s", mapped to %s',r.format,s);let a=o;return!pS(i)&&mS(r)&&(n("accept header not recognized, but query format provided, setting accept header to %s",s),a=s),n('resolved accept header to "%s"',a),a}async function qm(r,e,t){let n=performance.now();try{let i=await t(),s=(performance.now()-n).toFixed(1),a=`${r};dur=${s};desc="${e}"`;return{result:i,header:a,error:null}}catch(i){let s=(performance.now()-n).toFixed(1),a=`${r};dur=${s};desc="${e}"`;return{result:null,error:i,header:a}}}var pF=it(y7(),1),d8=class{lru;constructor(e){this.lru=(0,pF.default)(e)}get(e){let t=this.lru.get(e);if(t!=null){if(t.expire!=null&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return this.get(e)!=null}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}};var mF=new d8(1e3),ste=/^(?<protocol>ip[fn]s):\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,ate=/^\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,cte=/^https?:\/\/(.*[^/])\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,lte=/^https?:\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\.(?<protocol>ip[fn]s)\.([^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/;function ute(r){let e=r?.protocol;if(e==null)return!1;let t=r?.cidOrPeerIdOrDnsLink;if(t==null)return!1;let n=r?.path,i=r?.queryString;return["ipns","ipfs"].includes(e)&&typeof t=="string"&&(n==null||typeof n=="string")&&(i==null||typeof i=="string")}function jm(r){for(let e of[lte,ste,cte,ate]){let t=r.match(e);if(ute(t?.groups))return t.groups}throw new TypeError(`Invalid URL: ${r}, please use ipfs://, ipns://, or gateway URLs only`)}function fte(r){if(r==null)return;let e=r.answer?.TTL,t=r.record?.ttl,n=t!=null?Number(t/BigInt(1e9)):void 0;return e??n}var dte=/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;function hte(r){return dte.test(r)&&r.includes("-")&&!r.includes(".")}function pte(r){return r.replace(/--/g,"%").replace(/-/g,".").replace(/%/g,"-")}async function gF({urlString:r,ipns:e,logger:t,withServerTiming:n=!1},i){let o=t.forComponent("helia:verified-fetch:parse-url-string"),{protocol:s,cidOrPeerIdOrDnsLink:a,path:c,queryString:l}=jm(r),u,f,h=[],d,m=[];if(s==="ipfs")try{u=W.parse(a)}catch(x){o.error(x),h.push(new TypeError("Invalid CID for ipfs://<cid> URL"))}else if(d=mF.get(a),d!=null)u=d.cid,f=d.path,o.trace("resolved %s to %c from cache",a,u);else{o.trace("Attempting to resolve PeerId for %s",a);let x;try{x=i8(a);let v=x?.publicKey;if(v==null)throw new TypeError("cidOrPeerIdOrDnsLink contains no public key");if(n){let b=async()=>e.resolve(v,i),S=await qm("ipns.resolve",`Resolve IPNS name ${a}`,b);if(m.push(S),S.error!=null)throw S.error;d=S.result}else d=await e.resolve(v,i);u=d?.cid,f=d?.path,o.trace("resolved %s to %c",a,u)}catch(v){i?.signal?.throwIfAborted(),x==null?(o.error('could not parse PeerId string "%s"',a,v),h.push(new TypeError(`Could not parse PeerId in ipns url "${a}", ${v.message}`))):(o.error("could not resolve PeerId %c",x,v),h.push(new TypeError(`Could not resolve PeerId "${a}": ${v.message}`)))}if(u==null){let v=a;hte(a)&&(v=pte(a),o.trace('decoded dnslink from "%s" to "%s"',a,v)),o.trace("Attempting to resolve DNSLink for %s",v);try{if(n){let b=await qm("ipns.resolveDNSLink",`Resolve DNSLink ${v}`,e.resolveDNSLink.bind(e,v,i));if(m.push(b),b.error!=null)throw b.error;d=b.result}else d=await e.resolveDNSLink(v,i);u=d?.cid,f=d?.path,o.trace("resolved %s to %c",v,u)}catch(b){i?.signal?.throwIfAborted(),o.error('could not resolve DnsLink for "%s"',a,b),h.push(b)}}}if(u==null)throw h.length===1?h[0]:(h.push(new Error(`Invalid resource. Cannot determine CID from URL "${r}".`)),h);let g=fte(d);d!=null&&(g=g??60*2,o.trace("caching %s resolved to %s with TTL: %s",a,u,g),mF.set(a,d,g*1e3));let w={};if(l!=null&&l.length>0){let x=l.split("&");for(let v of x){let[b,S]=v.split("=");w[b]=decodeURIComponent(S)}w.download!=null&&(w.download=w.download==="true"),w.filename!=null&&(w.filename=w.filename.toString())}return{protocol:s,cid:u,path:mte(f,c??""),query:w,ttl:g,ipfsPath:`/${s}/${a}${c!=null&&c!==""?`/${c}`:""}`,serverTimings:m}}function mte(r,e){let t="";return r!=null&&(t+=r),e.length>0&&(t=`${t.length>0?`${t}/`:t}${e}`),t=t.replace(/\/(\/)+/g,"/"),t.startsWith("/")&&(t=t.substring(1)),t.split("/").map(decodeURIComponent).join("/")}function yF(r){return r.match(/\.[a-zA-Z0-9]{1,4}$/)!=null||r.endsWith("/")?r:`${r}/`}async function wF({resource:r,options:e,logger:t,cid:n,fetch:i=globalThis.fetch}){let o=t.forComponent("helia:verified-fetch:get-redirect-response");if(typeof r!="string"||e==null||["ipfs://","ipns://"].some(u=>r.startsWith(u)))return null;let s=new Headers(e?.headers),a=s.get("x-forwarded-host"),c=s.get("host");if(s.get("x-forwarded-for")==null&&a==null&&c==null)return o.trace("no redirect info found in headers"),null;o.trace("checking for redirect info");try{let u=jm(r),f=new URL(r),h=a??f.host,d=new URL(f);if(u.protocol==="ipfs"&&n.version===0?d.host=`${n.toV1()}.ipfs.${h}`:d.host=`${u.cidOrPeerIdOrDnsLink}.${u.protocol}.${h}`,c?.includes(u.protocol)===!0&&d.host.includes(c))return o.trace("request was for a subdomain already, not setting location header"),null;if(c!=null&&!d.host.includes(c))return o.trace("host header is not the same as the subdomain url host, not setting location header"),null;if(f.host===d.host)return o.trace("req url is the same as the subdomain url, not setting location header"),null;d.pathname=yF(f.pathname.replace(`/${u.cidOrPeerIdOrDnsLink}`,"").replace(`/${u.protocol}`,"")),o.trace("subdomain url %s",d.href);let m=new URL(f,`${f.protocol}//${h}`);m.pathname=yF(f.pathname),o.trace("path url %s",m.href);try{let g=await i(d,{method:"HEAD"});if(g.ok)return o("subdomain supported, redirecting to subdomain"),km(r.toString(),d.href);throw o("subdomain not supported, subdomain failed with status %s %s",g.status,g.statusText),new a5("subdomain not supported")}catch(g){return o("subdomain not supported",g),m.href===f.href?(o("path url is the same as the request url, not setting location header"),null):km(r.toString(),m.href)}}catch(u){o.error("error setting location header for x-forwarded-host",u)}return null}async function xF(r,{ipns:e,logger:t},{withServerTiming:n=!1,...i}={withServerTiming:!1}){if(typeof r=="string")return gF({urlString:r,ipns:e,logger:t,withServerTiming:n},i);let o=W.asCID(r);if(o!=null)return{cid:o,protocol:"ipfs",path:"",query:{},ipfsPath:`/ipfs/${o.toString()}`,ttl:29030400,serverTimings:[]};throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${r}`)}function bF(r){let e=W.asCID(r);if(e!=null)return`ipfs://${e}`;try{return`ipfs://${W.parse(r.toString())}`}catch{}let{protocol:t,cidOrPeerIdOrDnsLink:n}=jm(r.toString());return`${t}://${n}`}var gte=100,yte=60*1e3;function wte(r){if(r==null)return;let e;return r?.signal===null?e=void 0:e=r?.signal,{...r,signal:e}}var h8=class{helia;ipns;log;contentTypeParser;blockstoreSessions;serverTimingHeaders=[];withServerTiming;plugins=[];constructor({helia:e,ipns:t},n){this.helia=e,this.log=e.logger.forComponent("helia:verified-fetch"),this.ipns=t??LC(e),this.contentTypeParser=n?.contentTypeParser??ZU,this.blockstoreSessions=new o5({max:n?.sessionCacheSize??gte,ttl:n?.sessionTTLms??yte,dispose:a=>{a.close()}}),this.withServerTiming=n?.withServerTiming??!1;let i={...n,logger:H_("helia:verified-fetch"),getBlockstore:(a,c,l,u)=>this.getBlockstore(a,c,l,u),handleServerTiming:async(a,c,l)=>this.handleServerTiming(a,c,l,this.withServerTiming),helia:e,contentTypeParser:this.contentTypeParser},o=[new n8(i),new u5(i),new o8(i),new y5(i),new a8(i),new u8(i),new s8(i),new P5(i),new r8(i)],s=n?.plugins?.map(a=>a(i))??[];if(s.length>0){let a=new Map(o.map(l=>[l.constructor.name,l])),c=new Map(s.map(l=>[l.constructor.name,l]));this.plugins=o.map(l=>c.get(l.constructor.name)??l),this.plugins.push(...s.filter(l=>!a.has(l.constructor.name)))}else this.plugins=o;this.log.trace("created VerifiedFetch instance")}getBlockstore(e,t,n=!0,i={}){let o=bF(t);if(!n)return this.helia.blockstore;let s=this.blockstoreSessions.get(o);return s==null&&(s=this.helia.blockstore.createSession(e,i),this.blockstoreSessions.set(o,s)),s}async handleServerTiming(e,t,n,i){if(!i)return n();let{error:o,result:s,header:a}=await qm(e,t,n);if(this.serverTimingHeaders.push(a),o!=null)throw o;return s}handleFinalResponse(e,{query:t,cid:n,reqFormat:i,ttl:o,protocol:s,ipfsPath:a,pathDetails:c,byteRangeContext:l}={}){if(this.serverTimingHeaders.length>0){let f=this.serverTimingHeaders.join(", ");e.headers.set("Server-Timing",f),this.serverTimingHeaders=[]}if(e.headers.get("Transfer-Encoding")!=="chunked"&&l!=null){let f=l.length;f!=null&&(this.log.trace("Setting Content-Length from byteRangeContext: %d",f),e.headers.set("Content-Length",f.toString()))}let u;return this.log.trace("checking for content disposition"),t?.download===!0?u="attachment":this.log.trace("download not requested"),t?.filename!=null?(u==null&&(u="inline"),u=`${u}; ${lF(t.filename)}`):this.log.trace("no filename specified in query"),u!=null?e.headers.set("Content-Disposition",u):this.log.trace("no content disposition specified"),n!=null&&e.headers.get("etag")==null&&e.headers.set("etag",mh({cid:c?.terminalElement.cid??n,reqFormat:i,weak:!1})),s!=null&&FB({response:e,ttl:o,protocol:s}),a!=null&&e.headers.set("X-Ipfs-Path",a),e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, HEAD, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Range, X-Requested-With"),e.headers.set("Access-Control-Expose-Headers","Content-Range, Content-Length, X-Ipfs-Path, X-Stream-Output"),i!=="car"?e.headers.set("Accept-Ranges","bytes"):e.headers.set("Accept-Ranges","none"),e}async runPluginPipeline(e,t=3){let n,i=0,o=new Set,s=e.modified;for(;i<t;){this.log(`Starting pipeline pass #${i+1}`),i++;let a=this.plugins.filter(u=>!o.has(u.constructor.name)).filter(u=>u.canHandle(e));if(a.length===0){this.log.trace("No plugins can handle the current context.. checking by CID code");let u=this.plugins.filter(f=>f.codes.includes(e.cid.code));if(u.length>0)a.push(...u);else{this.log.trace("No plugins found that can handle request by CID code; exiting pipeline.");break}}this.log.trace("Plugins ready to handle request: ",a.map(u=>u.constructor.name).join(", "));let c=!1,l=!1;for(let u of a){try{this.log.trace("Invoking plugin:",u.constructor.name),o.add(u.constructor.name);let f=await u.handle(e);if(f!=null){n=f,l=!0;break}}catch(f){if(e.options?.signal?.throwIfAborted(),this.log.error("Error in plugin:",u.constructor.name,f),f.name==="PluginFatalError")return f.response??Qd(e.resource,"Failed to fetch")}finally{let f=e.modified;c=f!==s,c&&(s=f)}if(n!=null){this.log.trace("Plugin produced final response:",u.constructor.name);break}}if(l&&n!=null)break;if(!c){this.log.trace("No context changes and no final response; exiting pipeline.");break}}return n}async fetch(e,t){if(this.log("fetch %s",e),t?.method==="OPTIONS")return this.handleFinalResponse(new Response(null,{status:200}));let n=wte(t),i=n?.withServerTiming??this.withServerTiming;n?.onProgress?.(new G("verified-fetch:request:start",{resource:e}));let o;try{o=await this.handleServerTiming("parse-resource","",async()=>xF(e,{ipns:this.ipns,logger:this.helia.logger},{withServerTiming:i,...n}),i),this.serverTimingHeaders.push(...o.serverTimings.map(({header:h})=>h))}catch(h){return n?.signal?.throwIfAborted(),this.log.error("error parsing resource %s",e,h),this.handleFinalResponse(Cm(e.toString(),h))}n?.onProgress?.(new G("verified-fetch:request:resolve",{cid:o.cid,path:o.path}));let s=hF({query:o.query,headers:n?.headers,logger:this.helia.logger}),a=uF(o.cid,s);if(this.log("output type %s",a),s!=null&&a==null)return this.handleFinalResponse(ta(e.toString()));let c=a?.split(";")[0]??"application/octet-stream",l=await wF({resource:e,options:n,logger:this.helia.logger,cid:o.cid});if(l!=null)return this.handleFinalResponse(l);let u={...o,resource:e.toString(),accept:a,options:n,withServerTiming:i,onProgress:n?.onProgress,modified:0};this.log.trace('finding handler for cid code "%s" and response content type "%s"',o.cid.code,c);let f=await this.runPluginPipeline(u);return n?.onProgress?.(new G("verified-fetch:request:end",{cid:o.cid,path:o.path})),this.handleFinalResponse(f??m5(e.toString()),u)}async start(){await this.helia.start()}async stop(){await this.helia.stop()}};var Wm,p8=async function(e,t){return Wm==null&&(Wm=await gS()),Wm(e,t)};p8.start=async function(){await Wm?.start()};p8.stop=async function(){await Wm?.stop()};function xte(r){return"ipfs-_blank"}function bte(r,e){let t=e.globalData.gatewayURLWithoutSubdomain.host;return`<a class="ipfs-hash" translate="no" href="${e.globalData.gatewayURLWithoutSubdomain.protocol}//${t}/ipfs/${r.hash}?filename=${r.name}">${r.shortHash}</a>`}function vte(r){let e=r.split("."),t=[];for(let n=e.length-1;n>=0;n--){let i=e[n];if(i==="ipfs"||i==="ipns")break;t.push(i)}return t.reverse(),t.join(".")}function Ete(r){let e;try{e=new URL(r)}catch{e=new URL("https://inbrowser.link")}return e.host=vte(e.host),e}function Ste(r){return r.path!=null?`Index of <a href="${`${r.globalData.gatewayURL}/${r.path}`}">${r.name}</a>`:`Index of ${r.name} ${r.path}`}function Ate(r){return r.listing.map(e=>`<div class="type-icon">
      <div class="${xte(e.name)}">&nbsp;</div>
    </div>
    <div>
      <a href="${e.path}">${e.name}</a>
    </div>
    <div class="nowrap">
      ${bte(e,r)}
    </div>
    <div class="nowrap" title="Cumulative size of IPFS DAG (data + metadata)">${e.size}</div>`).join(" ")}function _te(r){return r.path.split("/").pop()??r.path}function Ite(r){return r.length<=11?r:`${r.slice(0,4)}...${r.slice(-4)}`}var vF=(r,e,{gatewayURL:t,dnsLink:n,log:i})=>{i("loading directory html for %s",r.path);let o={globalData:{gatewayURL:t,gatewayURLWithoutSubdomain:Ete(t),dnsLink:n??!1},listing:e.map(s=>({size:s.size.toString(),name:s.name,path:_te(s),hash:s.cid.toString(),shortHash:Ite(s.cid.toString())})),name:r.name,size:r.size.toString(),path:r.path,breadcrumbs:[],backLink:"",hash:r.cid.toString()};return`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="A directory of content-addressed files hosted on IPFS.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlo89/56ZQ/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjDu1lo89/6mhTP+zrVP/nplD/5+aRK8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHNiIS6Wjz3/ubFY/761W/+vp1D/urRZ/8vDZf/GvmH/nplD/1BNIm8AAAAAAAAAAAAAAAAAAAAAAAAAAJaPPf+knEj/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf+tpk7/nplD/wAAAAAAAAAAAAAAAJaPPf+2rVX/vrVb/761W/++tVv/vrVb/6+nUP+6tFn/y8Nl/8vDZf/Lw2X/y8Nl/8G6Xv+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/761W/+vp1D/urRZ/8vDZf/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf++tVv/vrVb/761W/++tVv/vbRa/5aPPf+emUP/y8Nl/8vDZf/Lw2X/y8Nl/8vDZf+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/5qTQP+inkb/op5G/6KdRv/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/sqlS/56ZQ//LxWb/0Mlp/9DJaf/Kw2X/oJtE/7+3XP/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf+9tFr/mJE+/7GsUv/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+xrFL/nplD/8vDZf+emUP/AAAAAAAAAACWjz3/op5G/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+inkb/nplD/wAAAAAAAAAAAAAAAKKeRv+3slb/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+1sFX/op5G/wAAAAAAAAAAAAAAAAAAAAAAAAAAop5GUKKeRv/Nxmf/0cpq/9HKav/Rymr/0cpq/83GZ/+inkb/op5GSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G16KeRv/LxWb/y8Vm/6KeRv+inkaPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G/6KeRtcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/n8AAPgfAADwDwAAwAMAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAwAMAAPAPAAD4HwAA/n8AAA==">
    <title>${o.path}</title>
    <style>${Tte}</style>
  </head>
  <body>
    <!--
    # Some JSON content for debugging:

    ## dirData
    ${JSON.stringify(o,null,2)}
    -->
    <header id="header">
      <div class="ipfs-logo">&nbsp;</div>
      <!--
      <nav>
        <a href="https://ipfs.tech" target="_blank" rel="noopener noreferrer">About<span class="dn-mobile"> IPFS</span></a>
        <a href="https://docs.ipfs.tech/install/" target="_blank" rel="noopener noreferrer">Install<span class="dn-mobile"> IPFS</span></a>
      </nav>
      -->
    </header>
    <main id="main">
      <header class="flex flex-wrap">
        <div>
          <strong>${Ste(o)}</strong>
          ${o.hash==null?"":`<div class="ipfs-hash" translate="no">
                ${o.hash}
              </div>`}
        </div>
        ${o.size==null?"":`<div class="nowrap flex-shrink ml-auto">
              <strong title="Cumulative size of IPFS DAG (data + metadata)">&nbsp;${o.size}</strong>
            </div>`}
      </header>
      <div>
        <div class="grid dir">
          <!--{{ if .BackLink }}
            <div class="type-icon">
              <div class="ipfs-_blank">&nbsp;</div>
            </div>
            <div>
              <a href="{{.BackLink | urlEscape}}">..</a>
            </div>
            <div></div>
            <div></div>
          </tr>
          {{ end }}-->
          ${Ate(o)}
        </div>
      </div>
    </main>
  </body>
</html>`},Tte=`

    .ipfs-_blank {
        background-image: url("data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 72 100'%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='36' y1='1' x2='36' y2='99' gradientTransform='matrix(1 0 0 -1 0 100)'%3E%3Cstop offset='0' stop-color='%23c8d4db'/%3E%3Cstop offset='.139' stop-color='%23d8e1e6'/%3E%3Cstop offset='.359' stop-color='%23ebf0f3'/%3E%3Cstop offset='.617' stop-color='%23f9fafb'/%3E%3Cstop offset='1' stop-color='%23fff'/%3E%3C/linearGradient%3E%3Cpath d='M45 1l27 26.7V99H0V1h45z' fill='url(%23a)'/%3E%3Cpath d='M45 1l27 26.7V99H0V1h45z' fill-opacity='0' stroke='%237191a1' stroke-width='2'/%3E%3ClinearGradient id='b' gradientUnits='userSpaceOnUse' x1='45.068' y1='72.204' x2='58.568' y2='85.705' gradientTransform='matrix(1 0 0 -1 0 100)'%3E%3Cstop offset='0' stop-color='%23fff'/%3E%3Cstop offset='.35' stop-color='%23fafbfb'/%3E%3Cstop offset='.532' stop-color='%23edf1f4'/%3E%3Cstop offset='.675' stop-color='%23dde5e9'/%3E%3Cstop offset='.799' stop-color='%23c7d3da'/%3E%3Cstop offset='.908' stop-color='%23adbdc7'/%3E%3Cstop offset='1' stop-color='%2392a5b0'/%3E%3C/linearGradient%3E%3Cpath d='M45 1l27 26.7H45V1z' fill='url(%23b)'/%3E%3Cpath d='M45 1l27 26.7H45V1z' fill-opacity='0' stroke='%237191a1' stroke-width='2' stroke-linejoin='bevel'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-size: contain
    }

    :root {
        --sans-serif: "Plex",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        --monospace: Consolas, monaco, monospace;
        --navy: #073a53;
        --teal: #6bc4ce;
        --turquoise: #47AFB4;
        --steel-gray: #3f5667;
        --dark-white: #d9dbe2;
        --light-white: #edf0f4;
        --near-white: #f7f8fa;
        --radius: 4px;
    }

    body {
        color: #34373f;
        font-family: var(--sans-serif);
        line-height: 1.43;
        margin: 0;
        word-break: break-all;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
    }

    pre, code {
        font-family: var(--monospace);
    }

    a {
        color: #117eb3;
        text-decoration: none;
    }

    a:hover {
        color: #00b0e9;
        text-decoration: underline;
    }

    a:active,a:visited {
        color: #00b0e9;
    }

    .flex {
        display: flex;
    }

    .flex-wrap {
        flex-flow: wrap;
    }

    .flex-shrink {
        flex-shrink: 1;
    }

    .ml-auto {
        margin-left: auto;
    }

    .nowrap {
        white-space: nowrap
    }

    .ipfs-hash {
        color: #7f8491;
        font-family: var(--monospace);
    }

    #header {
        align-items: center;
        background: var(--navy);
        border-bottom: 4px solid var(--teal);
        color: #fff;
        display: flex;
        font-weight: 500;
        justify-content: space-between;
        padding: 0 1em;
    }

    #header a {
        color: var(--teal);
    }

    #header a:active {
        color: #9ad4db;
    }

    #header a:hover {
        color: #fff;
    }

    #header .ipfs-logo {
        height: 2.25em;
        margin: .7em .7em .7em 0;
        width: 7.15em
    }

    #header nav {
        align-items: center;
        display: flex;
        margin: .65em 0;
    }

    #header nav a {
        margin: 0 .6em;
    }

    #header nav a:last-child {
        margin: 0 0 0 .6em;
    }

    #header nav svg {
        fill: var(--teal);
        height: 1.8em;
        margin-top: .125em;
    }

    #header nav svg:hover {
        fill: #fff;
    }

    main {
        border: 1px solid var(--dark-white);
        border-radius: var(--radius);
        overflow: hidden;
        margin: 1em;
        font-size: .875em;
    }

    main header,main .container {
        padding-left: 1em;
        padding-right: 1em;
    }

    main header {
        padding-top: .7em;
        padding-bottom: .7em;
        background-color: var(--light-white);
    }

    main header,main section:not(:last-child) {
        border-bottom: 1px solid var(--dark-white);
    }

    main section header {
        background-color: var(--near-white);
    }

    .grid {
        display: grid;
        overflow-x: auto;
    }

    .grid .grid {
        overflow-x: visible;
    }

    .grid > div {
        padding: .7em;
        border-bottom: 1px solid var(--dark-white);
    }

    .grid.dir {
        grid-template-columns: min-content 1fr min-content min-content;
    }

    .grid.dir > div:nth-of-type(4n+1) {
        padding-left: 1em;
    }

    .grid.dir > div:nth-of-type(4n+4) {
        padding-right: 1em;
    }

    .grid.dir > div:nth-last-child(-n+4) {
        border-bottom: 0;
    }

    .grid.dir > div:nth-of-type(8n+5),.grid.dir > div:nth-of-type(8n+6),.grid.dir > div:nth-of-type(8n+7),.grid.dir > div:nth-of-type(8n+8) {
        background-color: var(--near-white);
    }

    .grid.dag {
        grid-template-columns: max-content 1fr;
    }

    .grid.dag pre {
        margin: 0;
    }

    .grid.dag .grid {
        padding: 0;
    }

    .grid.dag > div:nth-last-child(-n+2) {
        border-bottom: 0;
    }

    .grid.dag > div {
        background: white
    }

    .grid.dag > div:nth-child(4n),.grid.dag > div:nth-child(4n+3) {
        background-color: var(--near-white);
    }

    section > .grid.dag > div:nth-of-type(2n+1) {
        padding-left: 1em;
    }

    .type-icon,.type-icon > * {
        width: 1.15em
    }

    .terminal {
        background: var(--steel-gray);
        color: white;
        padding: .7em;
        border-radius: var(--radius);
        word-wrap: break-word;
        white-space: break-spaces;
    }

    @media print {
        #header {
            display: none;
        }

        #main header,.ipfs-hash,body {
            color: #000;
        }

        #main,#main header {
            border-color: #000;
        }

        a,a:visited {
            color: #000;
            text-decoration: underline;
        }

        a[href]:after {
            content: " (" attr(href) ")"
        }
    }

    @media only screen and (max-width: 500px) {
        .dn-mobile {
            display: none;
        }
    }`;async function Cte(r){let e=r.reduce((n,i)=>`${n}${i.name}${i.cid.toString()}`,""),t=await Fe.encode(new TextEncoder().encode(e));return Jt.encode(t)}var Gm=class extends Mt{codes=[ct];canHandle(e){let{cid:t,pathDetails:n,directoryEntries:i}=e;return n==null||n.terminalElement?.type!=="directory"||i==null||i.length===0?!1:t.code===ct}async handle(e){let{resource:t,pathDetails:n,directoryEntries:i}=e,{terminalElement:o,ipfsRoots:s}=n,c=vF(o,i,{gatewayURL:t,log:this.log});e.byteRangeContext.setBody(c);let l=`DirIndex-${await Cte(i)}_CID-`;return cn(t,e.byteRangeContext.getBody(),{byteRangeContext:e.byteRangeContext,log:this.log},{headers:{"Content-Type":"text/html","Cache-Control":"public, max-age=604800, stale-while-revalidate=2678400","X-Ipfs-Roots":DE(s),Etag:mh({cid:o.cid,reqFormat:e.reqFormat,contentPrefix:l})}})}},EF=r=>new Gm(r);async function gS(r,e){let t;if(!kte(r)){let o=Pte(r?.dnsResolvers),s=DB();s.dns=o;let a=r?.routers??["https://delegated-ipfs.dev"];for(let u=0;u<a.length;u++){let f=a[u];s.services[`delegatedRouting${u}`]=()=>S2(f)}r?.libp2pConfig!=null&&Object.assign(s,r.libp2pConfig),t=await n5(s);let c=[mp()],l=[Rp(t)];(r?.gateways==null||r.gateways.length>0)&&(c.push(Ap({allowInsecure:r?.allowInsecure,allowLocal:r?.allowLocal})),l.push(Pp({gateways:r?.gateways??["https://trustless-gateway.link"]}))),r=await RB({libp2p:t,blockBrokers:c,dns:o,routers:l,hashers:r?.hashers}),r.logger.forComponent("helia:verified-fetch").trace("created verified-fetch with libp2p config: %j",s)}let n=new h8({helia:r},e);async function i(o,s){return n.fetch(o,s)}return i.start=n.start.bind(n),i.stop=n.stop.bind(n),i}function kte(r){return r?.blockstore!=null&&r?.datastore!=null&&r?.gc!=null&&r?.stop!=null&&r?.start!=null}function Pte(r){if(r!=null)return Array.isArray(r)?nl({resolvers:{".":r}}):nl({resolvers:r})}return MF(Rte);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

tslib/tslib.js:
  (*! *****************************************************************************
  Copyright (c) Microsoft Corporation.
  
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.
  
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** *)

ieee754/index.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
@noble/curves/esm/abstract/modular.js:
@noble/curves/esm/abstract/curve.js:
@noble/curves/esm/abstract/edwards.js:
@noble/curves/esm/abstract/montgomery.js:
@noble/curves/esm/ed25519.js:
@noble/curves/esm/abstract/weierstrass.js:
@noble/curves/esm/_shortw_utils.js:
@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@peculiar/x509/build/x509.es.js:
  (*!
   * MIT License
   * 
   * Copyright (c) Peculiar Ventures. All rights reserved.
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)
*/
return HeliaVerifiedFetch}));
//# sourceMappingURL=index.min.js.map
