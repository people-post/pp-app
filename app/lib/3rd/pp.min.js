var pp=(()=>{var H$=Object.create;var mg=Object.defineProperty;var V$=Object.getOwnPropertyDescriptor;var z$=Object.getOwnPropertyNames;var K$=Object.getPrototypeOf,q$=Object.prototype.hasOwnProperty;var Mt=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Ut=(r,e)=>{for(var t in e)mg(r,t,{get:e[t],enumerable:!0})},r_=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of z$(e))!q$.call(r,i)&&i!==t&&mg(r,i,{get:()=>e[i],enumerable:!(n=V$(e,i))||n.enumerable});return r};var bt=(r,e,t)=>(t=r!=null?H$(K$(r)):{},r_(e||!r||!r.__esModule?mg(t,"default",{value:r,enumerable:!0}):t,r)),j$=r=>r_(mg({},"__esModule",{value:!0}),r);var Xg=Mt((sce,k7)=>{var oce=(function(){typeof k7<"u"&&(k7.exports=y);var r=86400,e=3200,t=146097*e/400,n=r*t,i=1e3*n,o=864e13,s=4294967296,a=1e6,c="000000000",l=Math.trunc||function(C){var I=C-C%1;return I==0&&(C<0||C===0&&1/C!=1/0)?-0:I},u=y.prototype,f=(y.fromDate=function(C){return new y(+C)},y.fromInt64BE=_(0,1,2,3,0,4),y.fromInt64LE=_(3,2,1,0,4,0),y.fromString=function(z){var I,W=new y,z=(z+="").replace(/^\s*[+\-]?\d+/,function(S){var S=+S,k=1970+(S-1970)%400;return W.year=S-k,k}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function($,S,k){return S<0&&(k*=-1),I=6e4*(60*+S+ +k),""}).replace(/\.\d+$/,function($){return W.nano=+($+c).substr(1,9),""}).split(/\D+/);if(1<z.length?z[1]--:z[1]=0,W.time=I=Date.UTC.apply(Date,z)-(I||0),isNaN(I))throw new TypeError("Invalid Date");return w(W)},y.fromTimeT=function(C){return v(C,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(C){return this.nano+=+C||0,this},u.getNano=function(){var C=w(this);return(C.time%1e3*a+ +C.nano+1e9)%1e9},u.getTimeT=function(){var I=w(this),C=Math.floor(I.time/1e3),I=I.year;return I&&(C+=I*t*r/e),C},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return x(w(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(C){var I=this,W=I.toDate(),z={H:function(){return H(W.getUTCHours())},L:function(){return U(W.getUTCMilliseconds(),3)},M:function(){return H(W.getUTCMinutes())},N:function(){return U(I.getNano(),9)},S:function(){return H(W.getUTCSeconds())},Y:function(){var $=I.getYear();return 999999<$?"+"+$:9999<$?"+"+U($,6):0<=$?U($,4):-999999<=$?"-"+U(-$,6):$},a:function(){return d[W.getUTCDay()]},b:function(){return h[W.getUTCMonth()]},d:function(){return H(W.getUTCDate())},e:function(){return(function($){return(9<$?"":" ")+(0|$)})(W.getUTCDate())},m:function(){return H(W.getUTCMonth()+1)}};return(function $(S){return S.replace(/%./g,function(k){var M=k[1],T=m[M],M=z[M];return T?$(T):M?M():k})})(C||f)},u.writeInt64BE=E(0,1,2,3,0,4),u.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return y;function y(C,I,W){var z=this;if(!(z instanceof y))return new y(C,I,W);z.time=+C||0,z.nano=+I||0,z.year=+W||0,w(z)}function w(C){var I,W,z,$=C.year,S=C.time,k=C.nano,T=((k<0||a<=k)&&(k-=(W=Math.floor(k/a))*a,S+=W,W=1),$%e);return(S<-o||o<S||T)&&((I=l(S/i))&&($+=I*e,S-=I*i),(z=x(S)).setUTCFullYear(T+z.getUTCFullYear()),z=(S=+z)+(I=l(($-=T)/e))*i,I&&-o<=z&&z<=o&&($-=I*e,S=z),W=1),W&&(C.year=$,C.time=S,C.nano=k),C}function x(C){var I=new Date(0);return I.setTime(C),I}function v($,z){$=+$||0;var W=l((z=(z|0)*s)/n)+l($/n),z=z%n+$%n,$=l(z/n);return $&&(W+=$,z-=$*n),new y(1e3*z,0,W*e)}function E(C,I,W,z,$,S){return function(T,M){var Y=w(this);T=T||new Array(8),B(T,M|=0);var F=Math.floor(Y.time/1e3),Y=Y.year*(t*r/e),X=l(Y/s)+l(F/s),Y=Y%s+F%s,F=Math.floor(Y/s);return F&&(X+=F,Y-=F*s),k(T,M+$,X),k(T,M+S,Y),T};function k(T,M,X){T[M+C]=X>>24&255,T[M+I]=X>>16&255,T[M+W]=X>>8&255,T[M+z]=255&X}}function _(C,I,W,z,$,S){return function(T,M){B(T,M|=0);var X=k(T,M+$);return v(k(T,M+S),X)};function k(T,M){return 16777216*T[M+C]+(T[M+I]<<16|T[M+W]<<8|T[M+z])}}function B(C,I){if(C=C&&C.length,C==null)throw new TypeError("Invalid Buffer");if(C<I+8)throw new RangeError("Out of range")}function H(C){return(9<C?"":"0")+(0|C)}function U(C,I){return(c+(0|C)).substr(-I)}})()});var GI=Mt(Hp=>{(function(){var r,e,t,n,i,o,s,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},s=function(c){var l,u,f,h,d,m;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),d=m[0],u=m[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),o=t("a"),i=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-o)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-i)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=(function(){function c(l,u){var f,h,d,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(m=l.split("/",2),l=m[0],u=m[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=s(u)}catch(y){throw f=y,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(s(l)&this.maskLong)>>>0}catch(y){throw f=y,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(s(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=s(this.first),f=s(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),Hp.ip2long=s,Hp.long2ip=a,Hp.Netmask=r}).call(Hp)});var xP=Mt((a3e,e9)=>{"use strict";var tW=Object.prototype.hasOwnProperty,_n="~";function hm(){}Object.create&&(hm.prototype=Object.create(null),new hm().__proto__||(_n=!1));function rW(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function wP(r,e,t,n,i){if(typeof t!="function")throw new TypeError("The listener must be a function");var o=new rW(t,n||r,i),s=_n?_n+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],o]:r._events[s].push(o):(r._events[s]=o,r._eventsCount++),r}function e3(r,e){--r._eventsCount===0?r._events=new hm:delete r._events[e]}function fn(){this._events=new hm,this._eventsCount=0}fn.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)tW.call(t,n)&&e.push(_n?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};fn.prototype.listeners=function(e){var t=_n?_n+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,s=new Array(o);i<o;i++)s[i]=n[i].fn;return s};fn.prototype.listenerCount=function(e){var t=_n?_n+e:e,n=this._events[t];return n?n.fn?1:n.length:0};fn.prototype.emit=function(e,t,n,i,o,s){var a=_n?_n+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,i),!0;case 5:return c.fn.call(c.context,t,n,i,o),!0;case 6:return c.fn.call(c.context,t,n,i,o,s),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,i);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};fn.prototype.on=function(e,t,n){return wP(this,e,t,n,!1)};fn.prototype.once=function(e,t,n){return wP(this,e,t,n,!0)};fn.prototype.removeListener=function(e,t,n,i){var o=_n?_n+e:e;if(!this._events[o])return this;if(!t)return e3(this,o),this;var s=this._events[o];if(s.fn)s.fn===t&&(!i||s.once)&&(!n||s.context===n)&&e3(this,o);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||i&&!s[a].once||n&&s[a].context!==n)&&c.push(s[a]);c.length?this._events[o]=c.length===1?c[0]:c:e3(this,o)}return this};fn.prototype.removeAllListeners=function(e){var t;return e?(t=_n?_n+e:e,this._events[t]&&e3(this,t)):(this._events=new hm,this._eventsCount=0),this};fn.prototype.off=fn.prototype.removeListener;fn.prototype.addListener=fn.prototype.on;fn.prefixed=_n;fn.EventEmitter=fn;typeof e9<"u"&&(e9.exports=fn)});var SP=Mt((P3e,EP)=>{EP.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(o,s){t[o]=s,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(o){return t[o]!==void 0||n[o]!==void 0},remove:function(o){t[o]!==void 0&&(t[o]=void 0),n[o]!==void 0&&(n[o]=void 0)},get:function(o){var s=t[o];if(s!==void 0)return s;if((s=n[o])!==void 0)return i(o,s),s},set:function(o,s){t[o]!==void 0?t[o]=s:i(o,s)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var sD=Mt((dSe,oD)=>{"use strict";function dX(r){return r>=55296&&r<=56319}function hX(r){return r>=56320&&r<=57343}oD.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,o=0,s,a,c=0;c<i;c+=1){if(s=t.charCodeAt(c),a=t[c],dX(s)&&hX(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),o+=e(a),o===n)return t.slice(0,c+1);if(o>n)return t.slice(0,c-a.length+1)}return t}});var cD=Mt((hSe,aD)=>{"use strict";function pX(r){return r>=55296&&r<=56319}function mX(r){return r>=56320&&r<=57343}aD.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,o=null,s=0;s<t;s++)i=e.charCodeAt(s),mX(i)?o!=null&&pX(o)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),o=i;return n}});var uD=Mt((pSe,lD)=>{"use strict";var gX=sD(),yX=cD();lD.exports=gX.bind(null,yX)});var hD=Mt((mSe,dD)=>{"use strict";var wX=uD(),xX=/[\/\?<>\\:\*\|"]/g,bX=/[\x00-\x1f\x80-\x9f]/g,vX=/^\.+$/,EX=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,SX=/[\. ]+$/;function fD(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(xX,e).replace(bX,e).replace(vX,e).replace(EX,e).replace(SX,e);return wX(t,255)}dD.exports=function(r,e){var t=e&&e.replacement||"",n=fD(r,t);return t===""?n:fD(n,"")}});var Xs=Mt(wd=>{"use strict";var _X="[object ArrayBuffer]",Gs=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===_X}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),i=r.toUint8Array(t);if(n.length!==i.byteLength)return!1;for(let o=0;o<n.length;o++)if(n[o]!==i[o])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let s of t)n+=s.byteLength;let i=new Uint8Array(n),o=0;for(let s of t){let a=this.toUint8Array(s);i.set(a,o),o+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}},fv="string",CX=/^[0-9a-f\s]+$/i,TX=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,IX=/^[a-zA-Z0-9-_]+$/,G4=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}static toString(e){let t=Gs.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return decodeURIComponent(escape(n))}},Li=class{static toString(e,t=!1){let n=Gs.toArrayBuffer(e),i=new DataView(n),o="";for(let s=0;s<n.byteLength;s+=2){let a=i.getUint16(s,t);o+=String.fromCharCode(a)}return o}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),i=new DataView(n);for(let o=0;o<e.length;o++)i.setUint16(o*2,e.charCodeAt(o),t);return n}},X4=class r{static isHex(e){return typeof e===fv&&CX.test(e)}static isBase64(e){return typeof e===fv&&TX.test(e)}static isBase64Url(e){return typeof e===fv&&IX.test(e)}static ToString(e,t="utf8"){let n=Gs.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Li.toString(n,!0);case"utf16":case"utf16be":return Li.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Li.fromString(e,!0);case"utf16":case"utf16be":return Li.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=Gs.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return G4.fromString(e);case"utf16":case"utf16be":return Li.fromString(e);case"utf16le":case"usc2":return Li.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return G4.toString(e);case"utf16":case"utf16be":return Li.toString(e);case"utf16le":case"usc2":return Li.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n.buffer}static ToBinary(e){let t=Gs.toUint8Array(e),n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return n}static ToHex(e){let t=Gs.toUint8Array(e),n="",i=t.length;for(let o=0;o<i;o++){let s=t[o];s<16&&(n+="0"),n+=s.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){let o=t.slice(i,i+2);n[i/2]=parseInt(o,16)}return n.buffer}static ToUtf16String(e,t=!1){return Li.toString(e,t)}static FromUtf16String(e,t=!1){return Li.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};X4.DEFAULT_UTF8_ENCODING="utf8";function kX(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let i=arguments[n];for(let o in i)t[o]=i[o]}return t}function PX(...r){let e=r.map(i=>i.byteLength).reduce((i,o)=>i+o),t=new Uint8Array(e),n=0;return r.map(i=>new Uint8Array(i)).forEach(i=>{for(let o of i)t[n++]=o}),t.buffer}function RX(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}wd.BufferSourceConverter=Gs;wd.Convert=X4;wd.assign=kX;wd.combine=PX;wd.isEqual=RX});var TN=Mt(r5=>{"use strict";Object.defineProperty(r5,"__esModule",{value:!0});r5.parse=cQ;r5.serialize=lQ;var rQ=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,nQ=/^[\u0021-\u003A\u003C-\u007E]*$/,iQ=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,oQ=/^[\u0020-\u003A\u003D-\u007E]*$/,sQ=Object.prototype.toString,aQ=(()=>{let r=function(){};return r.prototype=Object.create(null),r})();function cQ(r,e){let t=new aQ,n=r.length;if(n<2)return t;let i=e?.decode||uQ,o=0;do{let s=r.indexOf("=",o);if(s===-1)break;let a=r.indexOf(";",o),c=a===-1?n:a;if(s>c){o=r.lastIndexOf(";",s-1)+1;continue}let l=_N(r,o,s),u=CN(r,s,l),f=r.slice(l,u);if(t[f]===void 0){let h=_N(r,s+1,c),d=CN(r,c,h),m=i(r.slice(h,d));t[f]=m}o=c+1}while(o<n);return t}function _N(r,e,t){do{let n=r.charCodeAt(e);if(n!==32&&n!==9)return e}while(++e<t);return t}function CN(r,e,t){for(;e>t;){let n=r.charCodeAt(--e);if(n!==32&&n!==9)return e+1}return t}function lQ(r,e,t){let n=t?.encode||encodeURIComponent;if(!rQ.test(r))throw new TypeError(`argument name is invalid: ${r}`);let i=n(e);if(!nQ.test(i))throw new TypeError(`argument val is invalid: ${e}`);let o=r+"="+i;if(!t)return o;if(t.maxAge!==void 0){if(!Number.isInteger(t.maxAge))throw new TypeError(`option maxAge is invalid: ${t.maxAge}`);o+="; Max-Age="+t.maxAge}if(t.domain){if(!iQ.test(t.domain))throw new TypeError(`option domain is invalid: ${t.domain}`);o+="; Domain="+t.domain}if(t.path){if(!oQ.test(t.path))throw new TypeError(`option path is invalid: ${t.path}`);o+="; Path="+t.path}if(t.expires){if(!fQ(t.expires)||!Number.isFinite(t.expires.valueOf()))throw new TypeError(`option expires is invalid: ${t.expires}`);o+="; Expires="+t.expires.toUTCString()}if(t.httpOnly&&(o+="; HttpOnly"),t.secure&&(o+="; Secure"),t.partitioned&&(o+="; Partitioned"),t.priority)switch(typeof t.priority=="string"?t.priority.toLowerCase():void 0){case"low":o+="; Priority=Low";break;case"medium":o+="; Priority=Medium";break;case"high":o+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${t.priority}`)}if(t.sameSite)switch(typeof t.sameSite=="string"?t.sameSite.toLowerCase():t.sameSite){case!0:case"strict":o+="; SameSite=Strict";break;case"lax":o+="; SameSite=Lax";break;case"none":o+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${t.sameSite}`)}return o}function uQ(r){if(r.indexOf("%")===-1)return r;try{return decodeURIComponent(r)}catch{return r}}function fQ(r){return sQ.call(r)==="[object Date]"}});var xL=Mt(()=>{var wL;(function(r){(function(e){var t=typeof globalThis=="object"?globalThis:typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:a(),n=i(r);typeof t.Reflect<"u"&&(n=i(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function i(c,l){return function(u,f){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:f}),l&&l(u,f)}}function o(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return o()||s()}})(function(e,t){var n=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",o=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return Xw(Object.create(null))}:c?function(){return Xw({__proto__:null})}:function(){return Xw({})},has:l?function(P,N){return n.call(P,N)}:function(P,N){return N in P},get:l?function(P,N){return n.call(P,N)?P[N]:void 0}:function(P,N){return P[N]}},f=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:B$(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:M$(),m=typeof WeakMap=="function"?WeakMap:U$(),y=i?Symbol.for("@reflect-metadata:registry"):void 0,w=O$(),x=N$(w);function v(P,N,q,re){if(V(q)){if(!Ci(P))throw new TypeError;if(!Wi(N))throw new TypeError;return $(P,N)}else{if(!Ci(P))throw new TypeError;if(!ce(N))throw new TypeError;if(!ce(re)&&!V(re)&&!Pe(re))throw new TypeError;return Pe(re)&&(re=void 0),q=rt(q),S(P,N,q,re)}}e("decorate",v);function E(P,N){function q(re,Ae){if(!ce(re))throw new TypeError;if(!V(Ae)&&!pg(Ae))throw new TypeError;Y(P,N,re,Ae)}return q}e("metadata",E);function _(P,N,q,re){if(!ce(q))throw new TypeError;return V(re)||(re=rt(re)),Y(P,N,q,re)}e("defineMetadata",_);function B(P,N,q){if(!ce(N))throw new TypeError;return V(q)||(q=rt(q)),k(P,N,q)}e("hasMetadata",B);function H(P,N,q){if(!ce(N))throw new TypeError;return V(q)||(q=rt(q)),T(P,N,q)}e("hasOwnMetadata",H);function U(P,N,q){if(!ce(N))throw new TypeError;return V(q)||(q=rt(q)),M(P,N,q)}e("getMetadata",U);function C(P,N,q){if(!ce(N))throw new TypeError;return V(q)||(q=rt(q)),X(P,N,q)}e("getOwnMetadata",C);function I(P,N){if(!ce(P))throw new TypeError;return V(N)||(N=rt(N)),F(P,N)}e("getMetadataKeys",I);function W(P,N){if(!ce(P))throw new TypeError;return V(N)||(N=rt(N)),Z(P,N)}e("getOwnMetadataKeys",W);function z(P,N,q){if(!ce(N))throw new TypeError;if(V(q)||(q=rt(q)),!ce(N))throw new TypeError;V(q)||(q=rt(q));var re=Kh(N,q,!1);return V(re)?!1:re.OrdinaryDeleteMetadata(P,N,q)}e("deleteMetadata",z);function $(P,N){for(var q=P.length-1;q>=0;--q){var re=P[q],Ae=re(N);if(!V(Ae)&&!Pe(Ae)){if(!Wi(Ae))throw new TypeError;N=Ae}}return N}function S(P,N,q,re){for(var Ae=P.length-1;Ae>=0;--Ae){var Zt=P[Ae],yr=Zt(N,q,re);if(!V(yr)&&!Pe(yr)){if(!ce(yr))throw new TypeError;re=yr}}return re}function k(P,N,q){var re=T(P,N,q);if(re)return!0;var Ae=Gw(N);return Pe(Ae)?!1:k(P,Ae,q)}function T(P,N,q){var re=Kh(N,q,!1);return V(re)?!1:xt(re.OrdinaryHasOwnMetadata(P,N,q))}function M(P,N,q){var re=T(P,N,q);if(re)return X(P,N,q);var Ae=Gw(N);if(!Pe(Ae))return M(P,Ae,q)}function X(P,N,q){var re=Kh(N,q,!1);if(!V(re))return re.OrdinaryGetOwnMetadata(P,N,q)}function Y(P,N,q,re){var Ae=Kh(q,re,!0);Ae.OrdinaryDefineOwnMetadata(P,N,q,re)}function F(P,N){var q=Z(P,N),re=Gw(P);if(re===null)return q;var Ae=F(re,N);if(Ae.length<=0)return q;if(q.length<=0)return Ae;for(var Zt=new d,yr=[],Ve=0,ae=q;Ve<ae.length;Ve++){var de=ae[Ve],pe=Zt.has(de);pe||(Zt.add(de),yr.push(de))}for(var ye=0,qe=Ae;ye<qe.length;ye++){var de=qe[ye],pe=Zt.has(de);pe||(Zt.add(de),yr.push(de))}return yr}function Z(P,N){var q=Kh(P,N,!1);return q?q.OrdinaryOwnMetadataKeys(P,N):[]}function te(P){if(P===null)return 1;switch(typeof P){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return P===null?1:6;default:return 6}}function V(P){return P===void 0}function Pe(P){return P===null}function Be(P){return typeof P=="symbol"}function ce(P){return typeof P=="object"?P!==null:typeof P=="function"}function Me(P,N){switch(te(P)){case 0:return P;case 1:return P;case 2:return P;case 3:return P;case 4:return P;case 5:return P}var q=N===3?"string":N===5?"number":"default",re=zh(P,o);if(re!==void 0){var Ae=re.call(P,q);if(ce(Ae))throw new TypeError;return Ae}return Qe(P,q==="default"?"number":q)}function Qe(P,N){if(N==="string"){var q=P.toString;if(On(q)){var re=q.call(P);if(!ce(re))return re}var Ae=P.valueOf;if(On(Ae)){var re=Ae.call(P);if(!ce(re))return re}}else{var Ae=P.valueOf;if(On(Ae)){var re=Ae.call(P);if(!ce(re))return re}var Zt=P.toString;if(On(Zt)){var re=Zt.call(P);if(!ce(re))return re}}throw new TypeError}function xt(P){return!!P}function He(P){return""+P}function rt(P){var N=Me(P,3);return Be(N)?N:He(N)}function Ci(P){return Array.isArray?Array.isArray(P):P instanceof Object?P instanceof Array:Object.prototype.toString.call(P)==="[object Array]"}function On(P){return typeof P=="function"}function Wi(P){return typeof P=="function"}function pg(P){switch(te(P)){case 3:return!0;case 4:return!0;default:return!1}}function Ju(P,N){return P===N||P!==P&&N!==N}function zh(P,N){var q=P[N];if(q!=null){if(!On(q))throw new TypeError;return q}}function QA(P){var N=zh(P,s);if(!On(N))throw new TypeError;var q=N.call(P);if(!ce(q))throw new TypeError;return q}function ZA(P){return P.value}function JA(P){var N=P.next();return N.done?!1:N}function e_(P){var N=P.return;N&&N.call(P)}function Gw(P){var N=Object.getPrototypeOf(P);if(typeof P!="function"||P===f||N!==f)return N;var q=P.prototype,re=q&&Object.getPrototypeOf(q);if(re==null||re===Object.prototype)return N;var Ae=re.constructor;return typeof Ae!="function"||Ae===P?N:Ae}function D$(){var P;!V(y)&&typeof t.Reflect<"u"&&!(y in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(P=L$(t.Reflect));var N,q,re,Ae=new m,Zt={registerProvider:yr,getProvider:ae,setProvider:pe};return Zt;function yr(ye){if(!Object.isExtensible(Zt))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case P===ye:break;case V(N):N=ye;break;case N===ye:break;case V(q):q=ye;break;case q===ye:break;default:re===void 0&&(re=new d),re.add(ye);break}}function Ve(ye,qe){if(!V(N)){if(N.isProviderFor(ye,qe))return N;if(!V(q)){if(q.isProviderFor(ye,qe))return N;if(!V(re))for(var Pt=QA(re);;){var Jt=JA(Pt);if(!Jt)return;var Gi=ZA(Jt);if(Gi.isProviderFor(ye,qe))return e_(Pt),Gi}}}if(!V(P)&&P.isProviderFor(ye,qe))return P}function ae(ye,qe){var Pt=Ae.get(ye),Jt;return V(Pt)||(Jt=Pt.get(qe)),V(Jt)&&(Jt=Ve(ye,qe),V(Jt)||(V(Pt)&&(Pt=new h,Ae.set(ye,Pt)),Pt.set(qe,Jt))),Jt}function de(ye){if(V(ye))throw new TypeError;return N===ye||q===ye||!V(re)&&re.has(ye)}function pe(ye,qe,Pt){if(!de(Pt))throw new Error("Metadata provider not registered.");var Jt=ae(ye,qe);if(Jt!==Pt){if(!V(Jt))return!1;var Gi=Ae.get(ye);V(Gi)&&(Gi=new h,Ae.set(ye,Gi)),Gi.set(qe,Pt)}return!0}}function O$(){var P;return!V(y)&&ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&(P=t.Reflect[y]),V(P)&&(P=D$()),!V(y)&&ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,y,{enumerable:!1,configurable:!1,writable:!1,value:P}),P}function N$(P){var N=new m,q={isProviderFor:function(de,pe){var ye=N.get(de);return V(ye)?!1:ye.has(pe)},OrdinaryDefineOwnMetadata:yr,OrdinaryHasOwnMetadata:Ae,OrdinaryGetOwnMetadata:Zt,OrdinaryOwnMetadataKeys:Ve,OrdinaryDeleteMetadata:ae};return w.registerProvider(q),q;function re(de,pe,ye){var qe=N.get(de),Pt=!1;if(V(qe)){if(!ye)return;qe=new h,N.set(de,qe),Pt=!0}var Jt=qe.get(pe);if(V(Jt)){if(!ye)return;if(Jt=new h,qe.set(pe,Jt),!P.setProvider(de,pe,q))throw qe.delete(pe),Pt&&N.delete(de),new Error("Wrong provider for target.")}return Jt}function Ae(de,pe,ye){var qe=re(pe,ye,!1);return V(qe)?!1:xt(qe.has(de))}function Zt(de,pe,ye){var qe=re(pe,ye,!1);if(!V(qe))return qe.get(de)}function yr(de,pe,ye,qe){var Pt=re(ye,qe,!0);Pt.set(de,pe)}function Ve(de,pe){var ye=[],qe=re(de,pe,!1);if(V(qe))return ye;for(var Pt=qe.keys(),Jt=QA(Pt),Gi=0;;){var t_=JA(Jt);if(!t_)return ye.length=Gi,ye;var F$=ZA(t_);try{ye[Gi]=F$}catch($$){try{e_(Jt)}finally{throw $$}}Gi++}}function ae(de,pe,ye){var qe=re(pe,ye,!1);if(V(qe)||!qe.delete(de))return!1;if(qe.size===0){var Pt=N.get(pe);V(Pt)||(Pt.delete(ye),Pt.size===0&&N.delete(Pt))}return!0}}function L$(P){var N=P.defineMetadata,q=P.hasOwnMetadata,re=P.getOwnMetadata,Ae=P.getOwnMetadataKeys,Zt=P.deleteMetadata,yr=new m,Ve={isProviderFor:function(ae,de){var pe=yr.get(ae);return!V(pe)&&pe.has(de)?!0:Ae(ae,de).length?(V(pe)&&(pe=new d,yr.set(ae,pe)),pe.add(de),!0):!1},OrdinaryDefineOwnMetadata:N,OrdinaryHasOwnMetadata:q,OrdinaryGetOwnMetadata:re,OrdinaryOwnMetadataKeys:Ae,OrdinaryDeleteMetadata:Zt};return Ve}function Kh(P,N,q){var re=w.getProvider(P,N);if(!V(re))return re;if(q){if(w.setProvider(P,N,x))return x;throw new Error("Illegal state.")}}function B$(){var P={},N=[],q=(function(){function Ve(ae,de,pe){this._index=0,this._keys=ae,this._values=de,this._selector=pe}return Ve.prototype["@@iterator"]=function(){return this},Ve.prototype[s]=function(){return this},Ve.prototype.next=function(){var ae=this._index;if(ae>=0&&ae<this._keys.length){var de=this._selector(this._keys[ae],this._values[ae]);return ae+1>=this._keys.length?(this._index=-1,this._keys=N,this._values=N):this._index++,{value:de,done:!1}}return{value:void 0,done:!0}},Ve.prototype.throw=function(ae){throw this._index>=0&&(this._index=-1,this._keys=N,this._values=N),ae},Ve.prototype.return=function(ae){return this._index>=0&&(this._index=-1,this._keys=N,this._values=N),{value:ae,done:!0}},Ve})(),re=(function(){function Ve(){this._keys=[],this._values=[],this._cacheKey=P,this._cacheIndex=-2}return Object.defineProperty(Ve.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Ve.prototype.has=function(ae){return this._find(ae,!1)>=0},Ve.prototype.get=function(ae){var de=this._find(ae,!1);return de>=0?this._values[de]:void 0},Ve.prototype.set=function(ae,de){var pe=this._find(ae,!0);return this._values[pe]=de,this},Ve.prototype.delete=function(ae){var de=this._find(ae,!1);if(de>=0){for(var pe=this._keys.length,ye=de+1;ye<pe;ye++)this._keys[ye-1]=this._keys[ye],this._values[ye-1]=this._values[ye];return this._keys.length--,this._values.length--,Ju(ae,this._cacheKey)&&(this._cacheKey=P,this._cacheIndex=-2),!0}return!1},Ve.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=P,this._cacheIndex=-2},Ve.prototype.keys=function(){return new q(this._keys,this._values,Ae)},Ve.prototype.values=function(){return new q(this._keys,this._values,Zt)},Ve.prototype.entries=function(){return new q(this._keys,this._values,yr)},Ve.prototype["@@iterator"]=function(){return this.entries()},Ve.prototype[s]=function(){return this.entries()},Ve.prototype._find=function(ae,de){if(!Ju(this._cacheKey,ae)){this._cacheIndex=-1;for(var pe=0;pe<this._keys.length;pe++)if(Ju(this._keys[pe],ae)){this._cacheIndex=pe;break}}return this._cacheIndex<0&&de&&(this._cacheIndex=this._keys.length,this._keys.push(ae),this._values.push(void 0)),this._cacheIndex},Ve})();return re;function Ae(Ve,ae){return Ve}function Zt(Ve,ae){return ae}function yr(Ve,ae){return[Ve,ae]}}function M$(){var P=(function(){function N(){this._map=new h}return Object.defineProperty(N.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),N.prototype.has=function(q){return this._map.has(q)},N.prototype.add=function(q){return this._map.set(q,q),this},N.prototype.delete=function(q){return this._map.delete(q)},N.prototype.clear=function(){this._map.clear()},N.prototype.keys=function(){return this._map.keys()},N.prototype.values=function(){return this._map.keys()},N.prototype.entries=function(){return this._map.entries()},N.prototype["@@iterator"]=function(){return this.keys()},N.prototype[s]=function(){return this.keys()},N})();return P}function U$(){var P=16,N=u.create(),q=re();return(function(){function ae(){this._key=re()}return ae.prototype.has=function(de){var pe=Ae(de,!1);return pe!==void 0?u.has(pe,this._key):!1},ae.prototype.get=function(de){var pe=Ae(de,!1);return pe!==void 0?u.get(pe,this._key):void 0},ae.prototype.set=function(de,pe){var ye=Ae(de,!0);return ye[this._key]=pe,this},ae.prototype.delete=function(de){var pe=Ae(de,!1);return pe!==void 0?delete pe[this._key]:!1},ae.prototype.clear=function(){this._key=re()},ae})();function re(){var ae;do ae="@@WeakMap@@"+Ve();while(u.has(N,ae));return N[ae]=!0,ae}function Ae(ae,de){if(!n.call(ae,q)){if(!de)return;Object.defineProperty(ae,q,{value:u.create()})}return ae[q]}function Zt(ae,de){for(var pe=0;pe<de;++pe)ae[pe]=Math.random()*255|0;return ae}function yr(ae){if(typeof Uint8Array=="function"){var de=new Uint8Array(ae);return typeof crypto<"u"?crypto.getRandomValues(de):typeof msCrypto<"u"?msCrypto.getRandomValues(de):Zt(de,ae),de}return Zt(new Array(ae),ae)}function Ve(){var ae=yr(P);ae[6]=ae[6]&79|64,ae[8]=ae[8]&191|128;for(var de="",pe=0;pe<P;++pe){var ye=ae[pe];(pe===4||pe===6||pe===8)&&(de+="-"),ye<16&&(de+="0"),de+=ye.toString(16).toLowerCase()}return de}}function Xw(P){return P.__=void 0,delete P.__,P}})})(wL||(wL={}))});var tU=Mt((DJe,eU)=>{eU.exports=hA;var JM=128,yJ=127,wJ=~yJ,xJ=Math.pow(2,31);function hA(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw hA.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=xJ;)e[t++]=r&255|JM,r/=128;for(;r&wJ;)e[t++]=r&255|JM,r>>>=7;return e[t]=r|0,hA.bytes=t-n+1,e}});var iU=Mt((OJe,nU)=>{nU.exports=pA;var bJ=128,rU=127;function pA(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a||i>49)throw pA.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&rU)<<i:(s&rU)*Math.pow(2,i),i+=7}while(s>=bJ);return pA.bytes=o-n,t}});var sU=Mt((NJe,oU)=>{var vJ=Math.pow(2,7),EJ=Math.pow(2,14),SJ=Math.pow(2,21),AJ=Math.pow(2,28),_J=Math.pow(2,35),CJ=Math.pow(2,42),TJ=Math.pow(2,49),IJ=Math.pow(2,56),kJ=Math.pow(2,63);oU.exports=function(r){return r<vJ?1:r<EJ?2:r<SJ?3:r<AJ?4:r<_J?5:r<CJ?6:r<TJ?7:r<IJ?8:r<kJ?9:10}});var z8=Mt((LJe,aU)=>{aU.exports={encode:tU(),decode:iU(),encodingLength:sU()}});var _U=Mt((X0,nw)=>{(function(r,e){"use strict";var t={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function n(d){if(!Array.isArray(d)&&!ArrayBuffer.isView(d))return!1;for(var m=0;m<d.length;m++)if(!Number.isInteger(d[m])||d[m]<0||d[m]>255)return!1;return!0}function i(d,m){return(d&65535)*m+(((d>>>16)*m&65535)<<16)}function o(d,m){return d<<m|d>>>32-m}function s(d){return d^=d>>>16,d=i(d,2246822507),d^=d>>>13,d=i(d,3266489909),d^=d>>>16,d}function a(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var y=[0,0,0,0];return y[3]+=d[3]+m[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=d[2]+m[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=d[1]+m[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=d[0]+m[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function c(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var y=[0,0,0,0];return y[3]+=d[3]*m[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=d[2]*m[3],y[1]+=y[2]>>>16,y[2]&=65535,y[2]+=d[3]*m[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=d[1]*m[3],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=d[2]*m[2],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=d[3]*m[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=d[0]*m[3]+d[1]*m[2]+d[2]*m[1]+d[3]*m[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function l(d,m){return m%=64,m===32?[d[1],d[0]]:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m|d[0]>>>32-m]:(m-=32,[d[1]<<m|d[0]>>>32-m,d[0]<<m|d[1]>>>32-m])}function u(d,m){return m%=64,m===0?d:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m]:[d[1]<<m-32,0]}function f(d,m){return[d[0]^m[0],d[1]^m[1]]}function h(d){return d=f(d,[0,d[0]>>>1]),d=c(d,[4283543511,3981806797]),d=f(d,[0,d[0]>>>1]),d=c(d,[3301882366,444984403]),d=f(d,[0,d[0]>>>1]),d}t.x86.hash32=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var y=d.length%4,w=d.length-y,x=m,v=0,E=3432918353,_=461845907,B=0;B<w;B=B+4)v=d[B]|d[B+1]<<8|d[B+2]<<16|d[B+3]<<24,v=i(v,E),v=o(v,15),v=i(v,_),x^=v,x=o(x,13),x=i(x,5)+3864292196;switch(v=0,y){case 3:v^=d[B+2]<<16;case 2:v^=d[B+1]<<8;case 1:v^=d[B],v=i(v,E),v=o(v,15),v=i(v,_),x^=v}return x^=d.length,x=s(x),x>>>0},t.x86.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var y=d.length%16,w=d.length-y,x=m,v=m,E=m,_=m,B=0,H=0,U=0,C=0,I=597399067,W=2869860233,z=951274213,$=2716044179,S=0;S<w;S=S+16)B=d[S]|d[S+1]<<8|d[S+2]<<16|d[S+3]<<24,H=d[S+4]|d[S+5]<<8|d[S+6]<<16|d[S+7]<<24,U=d[S+8]|d[S+9]<<8|d[S+10]<<16|d[S+11]<<24,C=d[S+12]|d[S+13]<<8|d[S+14]<<16|d[S+15]<<24,B=i(B,I),B=o(B,15),B=i(B,W),x^=B,x=o(x,19),x+=v,x=i(x,5)+1444728091,H=i(H,W),H=o(H,16),H=i(H,z),v^=H,v=o(v,17),v+=E,v=i(v,5)+197830471,U=i(U,z),U=o(U,17),U=i(U,$),E^=U,E=o(E,15),E+=_,E=i(E,5)+2530024501,C=i(C,$),C=o(C,18),C=i(C,I),_^=C,_=o(_,13),_+=x,_=i(_,5)+850148119;switch(B=0,H=0,U=0,C=0,y){case 15:C^=d[S+14]<<16;case 14:C^=d[S+13]<<8;case 13:C^=d[S+12],C=i(C,$),C=o(C,18),C=i(C,I),_^=C;case 12:U^=d[S+11]<<24;case 11:U^=d[S+10]<<16;case 10:U^=d[S+9]<<8;case 9:U^=d[S+8],U=i(U,z),U=o(U,17),U=i(U,$),E^=U;case 8:H^=d[S+7]<<24;case 7:H^=d[S+6]<<16;case 6:H^=d[S+5]<<8;case 5:H^=d[S+4],H=i(H,W),H=o(H,16),H=i(H,z),v^=H;case 4:B^=d[S+3]<<24;case 3:B^=d[S+2]<<16;case 2:B^=d[S+1]<<8;case 1:B^=d[S],B=i(B,I),B=o(B,15),B=i(B,W),x^=B}return x^=d.length,v^=d.length,E^=d.length,_^=d.length,x+=v,x+=E,x+=_,v+=x,E+=x,_+=x,x=s(x),v=s(v),E=s(E),_=s(_),x+=v,x+=E,x+=_,v+=x,E+=x,_+=x,("00000000"+(x>>>0).toString(16)).slice(-8)+("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(E>>>0).toString(16)).slice(-8)+("00000000"+(_>>>0).toString(16)).slice(-8)},t.x64.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var y=d.length%16,w=d.length-y,x=[0,m],v=[0,m],E=[0,0],_=[0,0],B=[2277735313,289559509],H=[1291169091,658871167],U=0;U<w;U=U+16)E=[d[U+4]|d[U+5]<<8|d[U+6]<<16|d[U+7]<<24,d[U]|d[U+1]<<8|d[U+2]<<16|d[U+3]<<24],_=[d[U+12]|d[U+13]<<8|d[U+14]<<16|d[U+15]<<24,d[U+8]|d[U+9]<<8|d[U+10]<<16|d[U+11]<<24],E=c(E,B),E=l(E,31),E=c(E,H),x=f(x,E),x=l(x,27),x=a(x,v),x=a(c(x,[0,5]),[0,1390208809]),_=c(_,H),_=l(_,33),_=c(_,B),v=f(v,_),v=l(v,31),v=a(v,x),v=a(c(v,[0,5]),[0,944331445]);switch(E=[0,0],_=[0,0],y){case 15:_=f(_,u([0,d[U+14]],48));case 14:_=f(_,u([0,d[U+13]],40));case 13:_=f(_,u([0,d[U+12]],32));case 12:_=f(_,u([0,d[U+11]],24));case 11:_=f(_,u([0,d[U+10]],16));case 10:_=f(_,u([0,d[U+9]],8));case 9:_=f(_,[0,d[U+8]]),_=c(_,H),_=l(_,33),_=c(_,B),v=f(v,_);case 8:E=f(E,u([0,d[U+7]],56));case 7:E=f(E,u([0,d[U+6]],48));case 6:E=f(E,u([0,d[U+5]],40));case 5:E=f(E,u([0,d[U+4]],32));case 4:E=f(E,u([0,d[U+3]],24));case 3:E=f(E,u([0,d[U+2]],16));case 2:E=f(E,u([0,d[U+1]],8));case 1:E=f(E,[0,d[U]]),E=c(E,B),E=l(E,31),E=c(E,H),x=f(x,E)}return x=f(x,[0,d.length]),v=f(v,[0,d.length]),x=a(x,v),v=a(v,x),x=h(x),v=h(v),x=a(x,v),v=a(v,x),("00000000"+(x[0]>>>0).toString(16)).slice(-8)+("00000000"+(x[1]>>>0).toString(16)).slice(-8)+("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)},typeof X0<"u"?(typeof nw<"u"&&nw.exports&&(X0=nw.exports=t),X0.murmurHash3=t):typeof define=="function"&&define.amd?define([],function(){return t}):(t._murmurHash3=r.murmurHash3,t.noConflict=function(){return r.murmurHash3=t._murmurHash3,t._murmurHash3=e,t.noConflict=e,t},r.murmurHash3=t)})(X0)});var TU=Mt((Ftt,CU)=>{CU.exports=_U()});var ow=Mt((jtt,kU)=>{"use strict";kU.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let i=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):i=!0,this._setInternalPos(n,e,t,i),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();let t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){let e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,i=t;for(;n<this.length;){let o=this.get(n);i=e(i,o,n),n++}return i}find(e){let t=0,n,i;for(;t<this.length&&!n;)i=this.get(t),n=e(i),t++;return n?i:void 0}_internalPositionFor(e,t){let n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;let i=this._bitArrays[n],o=e-n*7;if(!((i&1<<o)>0))return-1;let a=this._bitArrays.slice(0,n).reduce(ree,0),c=~(4294967295<<o+1),l=IU(i&c);return a+l-1}_bytePosFor(e,t){let n=Math.floor(e/7),i=n+1;for(;!t&&this._bitArrays.length<i;)this._bitArrays.push(0);return n}_setBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*7}_unsetBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*7)}_setInternalPos(e,t,n,i){let o=this._data,s=[t,n];if(i)this._sortData(),o[e]=s;else{if(o.length)if(o[o.length-1][0]>=t)o.push(s);else if(o[0][0]<=t)o.unshift(s);else{let a=Math.round(o.length/2);this._data=o.slice(0,a).concat(s).concat(o.slice(a))}else this._data.push(s);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(nee),this._changedData=!1}bitField(){let e=[],t=8,n=0,i=0,o,s=this._bitArrays.slice();for(;s.length||n;){n===0&&(o=s.shift(),n=7);let c=Math.min(n,t),l=~(255<<c),u=o&l;i|=u<<8-t,o=o>>>c,n-=c,t-=c,(!t||!n&&!s.length)&&(e.push(i),i=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(iee)}};function ree(r,e){return r+IU(e)}function IU(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function nee(r,e){return r[0]-e[0]}function iee(r){return r[1]}});var RF=Mt(RA=>{RA.read=function(r,e,t,n,i){var o,s,a=i*8-n-1,c=(1<<a)-1,l=c>>1,u=-7,f=t?i-1:0,h=t?-1:1,d=r[e+f];for(f+=h,o=d&(1<<-u)-1,d>>=-u,u+=a;u>0;o=o*256+r[e+f],f+=h,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=n;u>0;s=s*256+r[e+f],f+=h,u-=8);if(o===0)o=1-l;else{if(o===c)return s?NaN:(d?-1:1)*(1/0);s=s+Math.pow(2,n),o=o-l}return(d?-1:1)*s*Math.pow(2,o-n)};RA.write=function(r,e,t,n,i,o){var s,a,c,l=o*8-i-1,u=(1<<l)-1,f=u>>1,h=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,m=n?1:-1,y=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=u):(s=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-s))<1&&(s--,c*=2),s+f>=1?e+=h/c:e+=h*Math.pow(2,1-f),e*c>=2&&(s++,c/=2),s+f>=u?(a=0,s=u):s+f>=1?(a=(e*c-1)*Math.pow(2,i),s=s+f):(a=e*Math.pow(2,f-1)*Math.pow(2,i),s=0));i>=8;r[t+d]=a&255,d+=m,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;r[t+d]=s&255,d+=m,s/=256,l-=8);r[t+d-m]|=y*128}});var XF=Mt((Rct,GF)=>{var Fh=1e3,$h=Fh*60,Hh=$h*60,Yu=Hh*24,zte=Yu*7,Kte=Yu*365.25;GF.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return qte(r);if(t==="number"&&isFinite(r))return e.long?Wte(r):jte(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function qte(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*Kte;case"weeks":case"week":case"w":return t*zte;case"days":case"day":case"d":return t*Yu;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Hh;case"minutes":case"minute":case"mins":case"min":case"m":return t*$h;case"seconds":case"second":case"secs":case"sec":case"s":return t*Fh;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function jte(r){var e=Math.abs(r);return e>=Yu?Math.round(r/Yu)+"d":e>=Hh?Math.round(r/Hh)+"h":e>=$h?Math.round(r/$h)+"m":e>=Fh?Math.round(r/Fh)+"s":r+"ms"}function Wte(r){var e=Math.abs(r);return e>=Yu?kw(r,e,Yu,"day"):e>=Hh?kw(r,e,Hh,"hour"):e>=$h?kw(r,e,$h,"minute"):e>=Fh?kw(r,e,Fh,"second"):r+" ms"}function kw(r,e,t,n){var i=e>=t*1.5;return Math.round(r/t)+" "+n+(i?"s":"")}});var QF=Mt((Dct,YF)=>{function Gte(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=a,t.humanize=XF(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,m;function y(...w){if(!y.enabled)return;let x=y,v=Number(new Date),E=v-(f||v);x.diff=E,x.prev=f,x.curr=v,f=v,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let _=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(H,U)=>{if(H==="%%")return"%";_++;let C=t.formatters[U];if(typeof C=="function"){let I=w[_];H=C.call(x,I),w.splice(_,1),_--}return H}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return y.namespace=u,y.useColors=t.useColors(),y.color=t.selectColor(u),y.extend=n,y.destroy=t.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(u)),m),set:w=>{h=w}}),typeof t.init=="function"&&t.init(y),y}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f=(typeof u=="string"?u:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let h of f)h[0]==="-"?t.skips.push(h.slice(1)):t.names.push(h)}function o(u,f){let h=0,d=0,m=-1,y=0;for(;h<u.length;)if(d<f.length&&(f[d]===u[h]||f[d]==="*"))f[d]==="*"?(m=d,y=h,d++):(h++,d++);else if(m!==-1)d=m+1,y++,h=y;else return!1;for(;d<f.length&&f[d]==="*";)d++;return d===f.length}function s(){let u=[...t.names,...t.skips.map(f=>"-"+f)].join(",");return t.enable(""),u}function a(u){for(let f of t.skips)if(o(u,f))return!1;for(let f of t.names)if(o(u,f))return!0;return!1}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}YF.exports=Gte});var ZF=Mt((ti,Pw)=>{ti.formatArgs=Yte;ti.save=Qte;ti.load=Zte;ti.useColors=Xte;ti.storage=Jte();ti.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();ti.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Xte(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Yte(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Pw.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}ti.log=console.debug||console.log||(()=>{});function Qte(r){try{r?ti.storage.setItem("debug",r):ti.storage.removeItem("debug")}catch{}}function Zte(){let r;try{r=ti.storage.getItem("debug")||ti.storage.getItem("DEBUG")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Jte(){try{return localStorage}catch{}}Pw.exports=QF()(ti);var{formatters:ere}=Pw.exports;ere.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var p$=Mt((dut,h$)=>{"use strict";h$.exports={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,EXTENSIONLESS_FORMAT_JAVASCRIPT:0,EXTENSIONLESS_FORMAT_WASM:1,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:805306624,SSL_OP_ALL:2147485776,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,RSA_PKCS1_PADDING:1,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}});var ene={};Ut(ene,{Ipfs:()=>wa,Owner:()=>ug,RemoteServer:()=>fg,StorageAgent:()=>hg,User:()=>Zu,asInit:()=>Jre,sys:()=>Vc});var n_=Symbol.for("@libp2p/connection");var Do=Symbol.for("@libp2p/content-routing");var St=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},gg=class extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}},yg=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},O=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},vs=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},qh=class extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}},jh=class extends Error{static name="UnsupportedOperationError";constructor(e="Unsupported operation"){super(e),this.name="UnsupportedOperationError"}};var zc=class extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}},ef=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},Xi=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},tf=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}};var Oo=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},Wh=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},je=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}},rf=class extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}},No=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},wg=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},xa=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},nf=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}},Ue=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},Kc=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Lo=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},ri=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var ba=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},qc=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}},Gh=class extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}},xg=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}},of=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},Yi=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var bg=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},va=class extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}},vg=class extends va{constructor(e,t){super(!0,e,t)}},Eg=class extends va{constructor(e,t){super(!1,e,t)}};function i_(r){return r==null?!1:(r.type==="RSA"||r.type==="Ed25519"||r.type==="secp256k1"||r.type==="ECDSA")&&r.raw instanceof Uint8Array&&typeof r.equals=="function"&&typeof r.toMultihash=="function"&&typeof r.toCID=="function"&&typeof r.verify=="function"}var jc=Symbol.for("@libp2p/peer-discovery");var Sg=Symbol.for("@libp2p/peer-id");function _r(r){return!!r?.[Sg]}var Bo=Symbol.for("@libp2p/peer-routing");var Wc="keep-alive";function Ag(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function wr(...r){let e=[];for(let t of r)Ag(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Cr(...r){let e=[];for(let t of r)Ag(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Ea=Symbol.for("@libp2p/transport");var Xh;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Xh||(Xh={}));var Ce=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:o})=>o!==t),this.#e.set(e,i))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:i})=>!i),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var Ge=Symbol.for("@libp2p/service-capabilities"),ni=Symbol.for("@libp2p/service-dependencies");var nx={};Ut(nx,{base58btc:()=>nt,base58flickr:()=>rH});var Gc={};Ut(Gc,{coerce:()=>Ti,empty:()=>o_,equals:()=>Yw,fromHex:()=>G$,fromString:()=>Qw,isBinary:()=>X$,toHex:()=>W$,toString:()=>Zw});var o_=new Uint8Array(0);function W$(r){return r.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")}function G$(r){let e=r.match(/../g);return e!=null?new Uint8Array(e.map(t=>parseInt(t,16))):o_}function Yw(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Ti(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function X$(r){return r instanceof ArrayBuffer||ArrayBuffer.isView(r)}function Qw(r){return new TextEncoder().encode(r)}function Zw(r){return new TextDecoder().decode(r)}function Y$(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var o=r.charAt(i),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var y=0,w=0,x=0,v=m.length;x!==v&&m[x]===0;)x++,y++;for(var E=(v-x)*u+1>>>0,_=new Uint8Array(E);x!==v;){for(var B=m[x],H=0,U=E-1;(B!==0||H<w)&&U!==-1;U--,H++)B+=256*_[U]>>>0,_[U]=B%a>>>0,B=B/a>>>0;if(B!==0)throw new Error("Non-zero carry");w=H,x++}for(var C=E-w;C!==E&&_[C]===0;)C++;for(var I=c.repeat(y);C<E;++C)I+=r.charAt(_[C]);return I}function h(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var y=0;if(m[y]!==" "){for(var w=0,x=0;m[y]===c;)w++,y++;for(var v=(m.length-y)*l+1>>>0,E=new Uint8Array(v);m[y];){var _=t[m.charCodeAt(y)];if(_===255)return;for(var B=0,H=v-1;(_!==0||B<x)&&H!==-1;H--,B++)_+=a*E[H]>>>0,E[H]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");x=B,y++}if(m[y]!==" "){for(var U=v-x;U!==v&&E[U]===0;)U++;for(var C=new Uint8Array(w+(v-U)),I=w;U!==v;)C[I++]=E[U++];return C}}}function d(m){var y=h(m);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var Q$=Y$,Z$=Q$,s_=Z$;var Jw=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ex=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return a_(this,e)}},tx=class{decoders;constructor(e){this.decoders=e}or(e){return a_(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function a_(r,e){return new tx({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var rx=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Jw(e,t,n),this.decoder=new ex(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function sf({name:r,prefix:e,encode:t,decode:n}){return new rx(r,e,t,n)}function Sa({name:r,prefix:e,alphabet:t}){let{encode:n,decode:i}=s_(t,r);return sf({prefix:e,name:r,encode:n,decode:o=>Ti(i(o))})}function J$(r,e,t,n){let i=r.length;for(;r[i-1]==="=";)--i;let o=new Uint8Array(i*t/8|0),s=0,a=0,c=0;for(let l=0;l<i;++l){let u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,s+=t,s>=8&&(s-=8,o[c++]=255&a>>s)}if(s>=t||(255&a<<8-s)!==0)throw new SyntaxError("Unexpected end of data");return o}function eH(r,e,t){let n=e[e.length-1]==="=",i=(1<<t)-1,o="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,o+=e[i&a>>s];if(s!==0&&(o+=e[i&a<<t-s]),n)for(;(o.length*t&7)!==0;)o+="=";return o}function tH(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Kt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let i=tH(n);return sf({prefix:e,name:r,encode(o){return eH(o,n,t)},decode(o){return J$(o,i,t,r)}})}var nt=Sa({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),rH=Sa({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var ix={};Ut(ix,{base32:()=>Tr,base32hex:()=>sH,base32hexpad:()=>cH,base32hexpadupper:()=>lH,base32hexupper:()=>aH,base32pad:()=>iH,base32padupper:()=>oH,base32upper:()=>nH,base32z:()=>uH});var Tr=Kt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),nH=Kt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),iH=Kt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),oH=Kt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),sH=Kt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),aH=Kt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),cH=Kt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),lH=Kt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),uH=Kt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ox={};Ut(ox,{base36:()=>Mr,base36upper:()=>fH});var Mr=Sa({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),fH=Sa({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var At={};Ut(At,{Digest:()=>Xc,create:()=>mn,decode:()=>Xe,equals:()=>ax,hasCode:()=>PH});var dH=u_,c_=128,hH=127,pH=~hH,mH=Math.pow(2,31);function u_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mH;)e[t++]=r&255|c_,r/=128;for(;r&pH;)e[t++]=r&255|c_,r>>>=7;return e[t]=r|0,u_.bytes=t-n+1,e}var gH=sx,yH=128,l_=127;function sx(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a)throw sx.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&l_)<<i:(s&l_)*Math.pow(2,i),i+=7}while(s>=yH);return sx.bytes=o-n,t}var wH=Math.pow(2,7),xH=Math.pow(2,14),bH=Math.pow(2,21),vH=Math.pow(2,28),EH=Math.pow(2,35),SH=Math.pow(2,42),AH=Math.pow(2,49),_H=Math.pow(2,56),CH=Math.pow(2,63),TH=function(r){return r<wH?1:r<xH?2:r<bH?3:r<vH?4:r<EH?5:r<SH?6:r<AH?7:r<_H?8:r<CH?9:10},IH={encode:dH,decode:gH,encodingLength:TH},kH=IH,Yh=kH;function Qh(r,e=0){return[Yh.decode(r,e),Yh.decode.bytes]}function af(r,e,t=0){return Yh.encode(r,e,t),e}function cf(r){return Yh.encodingLength(r)}function mn(r,e){let t=e.byteLength,n=cf(r),i=n+cf(t),o=new Uint8Array(i+t);return af(r,o,0),af(t,o,n),o.set(e,i),new Xc(r,t,e,o)}function Xe(r){let e=Ti(r),[t,n]=Qh(e),[i,o]=Qh(e.subarray(n)),s=e.subarray(n+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new Xc(t,i,s,e)}function ax(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Yw(r.bytes,t.bytes)}}var Xc=class{code;size;digest;bytes;constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}};function PH(r,e){return r.code===e}function f_(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return DH(t,cx(r),e??nt.encoder);default:return OH(t,cx(r),e??Tr.encoder)}}var d_=new WeakMap;function cx(r){let e=d_.get(r);if(e==null){let t=new Map;return d_.set(r,t),t}return e}var j=class r{code;version;multihash;bytes;"/";constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Zh)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==NH)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=mn(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&ax(e.multihash,n.multihash)}toString(e){return f_(this,e)}toJSON(){return{"/":f_(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:i,multihash:o,bytes:s}=t;return new r(n,i,o,s??h_(n,i,o.bytes))}else if(t[LH]===!0){let{version:n,multihash:i,code:o}=t,s=Xe(i);return r.create(n,o,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Zh)throw new Error(`Version 0 CID must use dag-pb (code: ${Zh}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let i=h_(e,t,n.bytes);return new r(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Zh,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,i=Ti(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=i.subarray(t.multihashSize-t.digestSize),s=new Xc(t.multihashCode,t.digestSize,o,i);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Qh(e.subarray(t));return t+=h,f},i=n(),o=Zh;if(i===18?(i=0,t=0):o=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);let s=t,a=n(),c=n(),l=t+c,u=l-s;return{version:i,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,i]=RH(e,t),o=r.decode(i);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return cx(o).set(n,e),o}};function RH(r,e){switch(r[0]){case"Q":{let t=e??nt;return[nt.prefix,t.decode(`${nt.prefix}${r}`)]}case nt.prefix:{let t=e??nt;return[nt.prefix,t.decode(r)]}case Tr.prefix:{let t=e??Tr;return[Tr.prefix,t.decode(r)]}case Mr.prefix:{let t=e??Mr;return[Mr.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function DH(r,e,t){let{prefix:n}=t;if(n!==nt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let i=e.get(n);if(i==null){let o=t.encode(r).slice(1);return e.set(n,o),o}else return i}function OH(r,e,t){let{prefix:n}=t,i=e.get(n);if(i==null){let o=t.encode(r);return e.set(n,o),o}else return i}var Zh=112,NH=18;function h_(r,e,t){let n=cf(r),i=n+cf(e),o=new Uint8Array(i+t.byteLength);return af(r,o,0),af(e,o,n),o.set(t,i),o}var LH=Symbol.for("@ipld/js-cid/CID");var lx={};Ut(lx,{identity:()=>or});var p_=0,BH="identity",m_=Ti;function MH(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return mn(p_,m_(r))}var or={code:p_,name:BH,encode:m_,digest:MH};function me(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function ke(r=0){return new Uint8Array(r)}function Ft(r=0){return new Uint8Array(r)}function it(r,e){e==null&&(e=r.reduce((i,o)=>i+o.length,0));let t=Ft(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}var y_=Symbol.for("@achingbrain/uint8arraylist");function g_(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function Ii(r){return!!r?.[y_]}var oe=class r{bufs;length;[y_]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Ii(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Ii(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=g_(this.bufs,e);return t.buf[t.index]}set(e,t){let n=g_(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Ii(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:i}=this._subList(e,t);return it(n,i)}subarray(e,t){let{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:it(n,i)}sublist(e,t){let{bufs:n,length:i}=this._subList(e,t),o=new r;return o.length=i,o.bufs=[...n],o}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],i=0;for(let o=0;o<this.bufs.length;o++){let s=this.bufs[o],a=i,c=a+s.byteLength;if(i=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(s);break}let f=e-a;n.push(s.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(s);continue}n.push(s.subarray(e-a));continue}if(u){if(t===c){n.push(s);break}n.push(s.subarray(0,t-a));break}n.push(s)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Ii(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");let o=256,s=new Int32Array(o);for(let f=0;f<o;f++)s[f]=-1;for(let f=0;f<i;f++)s[n[f]]=f;let a=s,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Ft(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let i=ke(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let i=ke(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let i=ke(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Ft(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let i=ke(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let i=ke(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let i=ke(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let i=ke(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let i=ke(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!me(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((i,o)=>i+o.byteLength,0)),n.length=t,n}};var ux={};Ut(ux,{base10:()=>FH});var FH=Sa({prefix:"9",name:"base10",alphabet:"0123456789"});var fx={};Ut(fx,{base16:()=>$H,base16upper:()=>HH});var $H=Kt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),HH=Kt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var dx={};Ut(dx,{base2:()=>VH});var VH=Kt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var hx={};Ut(hx,{base256emoji:()=>WH});var w_=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),zH=w_.reduce((r,e,t)=>(r[t]=e,r),[]),KH=w_.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function qH(r){return r.reduce((e,t)=>(e+=zH[t],e),"")}function jH(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let i=KH[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}var WH=sf({prefix:"\u{1F680}",name:"base256emoji",encode:qH,decode:jH});var px={};Ut(px,{base64:()=>sr,base64pad:()=>Jh,base64url:()=>Yc,base64urlpad:()=>GH});var sr=Kt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Jh=Kt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Yc=Kt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),GH=Kt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var mx={};Ut(mx,{base8:()=>XH});var XH=Kt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var gx={};Ut(gx,{identity:()=>YH});var YH=sf({prefix:"\0",name:"identity",encode:r=>Zw(r),decode:r=>Qw(r)});var lf={};Ut(lf,{code:()=>Mo,decode:()=>yx,encode:()=>eV,name:()=>JH});var QH=new TextEncoder,ZH=new TextDecoder,JH="json",Mo=512;function eV(r){return QH.encode(JSON.stringify(r))}function yx(r){return JSON.parse(ZH.decode(r))}var Nn={};Ut(Nn,{code:()=>vt,decode:()=>nV,encode:()=>rV,name:()=>tV});var tV="raw",vt=85;function rV(r){return Ti(r)}function nV(r){return Ti(r)}var xx={};Ut(xx,{sha256:()=>ze,sha512:()=>Cg});var iV=20;function Es({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:i}){return new wx(r,e,t,n,i)}var wx=class{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,i,o){this.name=e,this.code=t,this.encode=n,this.minDigestLength=i??iV,this.maxDigestLength=o}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){let n=this.encode(e);return n instanceof Uint8Array?x_(n,this.code,t?.truncate):n.then(i=>x_(i,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}};function x_(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return mn(e,r)}function v_(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var ze=Es({name:"sha2-256",code:18,encode:v_("SHA-256")}),Cg=Es({name:"sha2-512",code:19,encode:v_("SHA-512")});var Qc={...gx,...dx,...mx,...ux,...fx,...ix,...ox,...nx,...px,...hx},Rie={...xx,...lx};function S_(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var E_=S_("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),bx=S_("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Ft(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),oV={utf8:E_,"utf-8":E_,hex:Qc.base16,latin1:bx,ascii:bx,binary:bx,...Qc},Tg=oV;function R(r,e="utf8"){let t=Tg[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function K(r,e="utf8"){let t=Tg[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var sV=parseInt("11111",2),vx=parseInt("10000000",2),aV=parseInt("01111111",2),A_={0:ep,1:ep,2:cV,3:fV,4:dV,5:uV,6:lV,16:ep,22:ep,48:ep};function ki(r,e={offset:0}){let t=r[e.offset]&sV;if(e.offset++,A_[t]!=null)return A_[t](r,e);throw new Error("No decoder for tag "+t)}function tp(r,e){let t=0;if((r[e.offset]&vx)===vx){let n=r[e.offset]&aV,i="0x";e.offset++;for(let o=0;o<n;o++,e.offset++)i+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=r[e.offset],e.offset++;return t}function ep(r,e){tp(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=ki(r,e);if(n===null)break;t.push(n)}return t}function cV(r,e){let t=tp(r,e),n=e.offset,i=e.offset+t,o=[];for(let s=n;s<i;s++)s===n&&r[s]===0||o.push(r[s]);return e.offset+=t,Uint8Array.from(o)}function lV(r,e){let t=tp(r,e),n=e.offset+t,i=r[e.offset];e.offset++;let o=0,s=0;i<40?(o=0,s=i):i<80?(o=1,s=i-40):(o=2,s=i-80);let a=`${o}.${s}`,c=[];for(;e.offset<n;){let l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let f=0;f<c.length;f++)u+=c[f]<<f*7;a+=`.${u}`,c=[]}}return a}function uV(r,e){return e.offset++,null}function fV(r,e){let t=tp(r,e),n=r[e.offset];e.offset++;let i=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function dV(r,e){let t=tp(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function hV(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new oe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Ig(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=hV(r.byteLength);return new oe(Uint8Array.from([e.byteLength|vx]),e)}function gn(r){let e=new oe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new oe(Uint8Array.from([2]),Ig(e),e)}function rp(r){let e=Uint8Array.from([0]),t=new oe(e,r);return new oe(Uint8Array.from([3]),Ig(t),t)}function __(r){return new oe(Uint8Array.from([4]),Ig(r),r)}function Qi(r,e=48){let t=new oe;for(let n of r)t.append(n);return new oe(Uint8Array.from([e]),Ig(t),t)}var C_="1.2.840.10045.3.1.7",T_="1.3.132.0.34",I_="1.3.132.0.35";async function k_(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function P_(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();let i=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function R_(r,e,t,n){let i=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,e,t.subarray());return n?.signal?.throwIfAborted(),o}var pV=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),mV=Uint8Array.from([6,5,43,129,4,0,34]),gV=Uint8Array.from([6,5,43,129,4,0,35]),D_={ext:!0,kty:"EC",crv:"P-256"},O_={ext:!0,kty:"EC",crv:"P-384"},N_={ext:!0,kty:"EC",crv:"P-521"},uf=32,ff=48,df=66;function L_(r){let e=ki(r);return Ex(e)}function Ex(r){let e=r[1],t=K(e,"base64url"),n=r[2][1][0],i=1,o,s;if(e.byteLength===uf)return o=K(n.subarray(i,i+uf),"base64url"),s=K(n.subarray(i+uf),"base64url"),new Jc({...D_,key_ops:["sign"],d:t,x:o,y:s});if(e.byteLength===ff)return o=K(n.subarray(i,i+ff),"base64url"),s=K(n.subarray(i+ff),"base64url"),new Jc({...O_,key_ops:["sign"],d:t,x:o,y:s});if(e.byteLength===df)return o=K(n.subarray(i,i+df),"base64url"),s=K(n.subarray(i+df),"base64url"),new Jc({...N_,key_ops:["sign"],d:t,x:o,y:s});throw new O(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function Sx(r){let e=ki(r);return B_(e)}function B_(r){let e=r[1][1][0],t=1,n,i;if(e.byteLength===uf*2+1)return n=K(e.subarray(t,t+uf),"base64url"),i=K(e.subarray(t+uf),"base64url"),new Zc({...D_,key_ops:["verify"],x:n,y:i});if(e.byteLength===ff*2+1)return n=K(e.subarray(t,t+ff),"base64url"),i=K(e.subarray(t+ff),"base64url"),new Zc({...O_,key_ops:["verify"],x:n,y:i});if(e.byteLength===df*2+1)return n=K(e.subarray(t,t+df),"base64url"),i=K(e.subarray(t+df),"base64url"),new Zc({...N_,key_ops:["verify"],x:n,y:i});throw new O(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function M_(r){return Qi([gn(Uint8Array.from([1])),__(R(r.d??"","base64url")),Qi([F_(r.crv)],160),Qi([rp(new oe(Uint8Array.from([4]),R(r.x??"","base64url"),R(r.y??"","base64url")))],161)]).subarray()}function U_(r){return Qi([gn(Uint8Array.from([1])),Qi([F_(r.crv)],160),Qi([rp(new oe(Uint8Array.from([4]),R(r.x??"","base64url"),R(r.y??"","base64url")))],161)]).subarray()}function F_(r){if(r==="P-256")return pV;if(r==="P-384")return mV;if(r==="P-521")return gV;throw new O(`Invalid curve ${r}`)}async function $_(r="P-256"){let e=await k_(r);return new Jc(e.privateKey)}var Zc=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=U_(this.jwk)),this._raw}toMultihash(){return or.digest(ar(this))}toCID(){return j.createV1(114,this.toMultihash())}toString(){return nt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}async verify(e,t,n){return R_(this.jwk,t,e,n)}},Jc=class{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Zc({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=M_(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}async sign(e,t){return P_(this.jwk,e,t)}};function el(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function rn(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Re(r,e,t=""){let n=el(r),i=r?.length,o=e!==void 0;if(!n||o&&i!==e){let s=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${i}`:`type=${typeof r}`;throw new Error(s+"expected Uint8Array"+a+", got "+c)}return r}function As(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");rn(r.outputLen),rn(r.blockLen)}function hf(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function V_(r,e){Re(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function nn(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function tl(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Zi(r,e){return r<<32-e|r>>>e}function kg(r,e){return r<<e|r>>>32-e>>>0}var z_=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",yV=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function _s(r){if(Re(r),z_)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=yV[r[t]];return e}var Ss={_0:48,_9:57,A:65,F:70,a:97,f:102};function H_(r){if(r>=Ss._0&&r<=Ss._9)return r-Ss._0;if(r>=Ss.A&&r<=Ss.F)return r-(Ss.A-10);if(r>=Ss.a&&r<=Ss.f)return r-(Ss.a-10)}function Cs(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(z_)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let i=0,o=0;i<t;i++,o+=2){let s=H_(r.charCodeAt(o)),a=H_(r.charCodeAt(o+1));if(s===void 0||a===void 0){let c=r[o]+r[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[i]=s*16+a}return n}var wV=async()=>{};async function K_(r,e,t){let n=Date.now();for(let i=0;i<r;i++){t(i);let o=Date.now()-n;o>=0&&o<e||(await wV(),n+=o)}}function xV(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Ax(r,e=""){return typeof r=="string"?xV(r):Re(r,void 0,e)}function Ln(...r){let e=0;for(let n=0;n<r.length;n++){let i=r[n];Re(i),e+=i.length}let t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){let o=r[n];t.set(o,i),i+=o.length}return t}function q_(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function np(r,e={}){let t=(i,o)=>r(o).update(i).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=i=>r(i),Object.assign(t,e),Object.freeze(t)}function Uo(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var _x=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function Pg(r,e,t){return r&e^~r&t}function Rg(r,e,t){return r&e^r&t^e&t}var rl=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,i){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=tl(this.buffer)}update(e){hf(this),Re(e);let{view:t,buffer:n,blockLen:i}=this,o=e.length;for(let s=0;s<o;){let a=Math.min(i-this.pos,o-s);if(a===i){let c=tl(e);for(;i<=o-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){hf(this),V_(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;t[s++]=128,nn(this.buffer.subarray(s)),this.padOffset>i-s&&(this.process(n,0),s=0);for(let f=s;f<i;f++)t[f]=0;n.setBigUint64(i-8,BigInt(this.length*8),o),this.process(n,0);let a=tl(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:s,pos:a}=this;return e.destroyed=s,e.finished=o,e.length=i,e.pos=a,i%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Ts=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var Ur=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var Dg=BigInt(4294967295),j_=BigInt(32);function bV(r,e=!1){return e?{h:Number(r&Dg),l:Number(r>>j_&Dg)}:{h:Number(r>>j_&Dg)|0,l:Number(r&Dg)|0}}function W_(r,e=!1){let t=r.length,n=new Uint32Array(t),i=new Uint32Array(t);for(let o=0;o<t;o++){let{h:s,l:a}=bV(r[o],e);[n[o],i[o]]=[s,a]}return[n,i]}var Cx=(r,e,t)=>r>>>t,Tx=(r,e,t)=>r<<32-t|e>>>t,nl=(r,e,t)=>r>>>t|e<<32-t,il=(r,e,t)=>r<<32-t|e>>>t,ip=(r,e,t)=>r<<64-t|e>>>t-32,op=(r,e,t)=>r>>>t-32|e<<64-t;function Fo(r,e,t,n){let i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}var G_=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),X_=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,Y_=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),Q_=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,Z_=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),J_=(r,e,t,n,i,o)=>e+t+n+i+o+(r/2**32|0)|0;var EV=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Aa=new Uint32Array(64),Ix=class extends rl{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:i,E:o,F:s,G:a,H:c}=this;return[e,t,n,i,o,s,a,c]}set(e,t,n,i,o,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Aa[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=Aa[f-15],d=Aa[f-2],m=Zi(h,7)^Zi(h,18)^h>>>3,y=Zi(d,17)^Zi(d,19)^d>>>10;Aa[f]=y+Aa[f-7]+m+Aa[f-16]|0}let{A:n,B:i,C:o,D:s,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=Zi(a,6)^Zi(a,11)^Zi(a,25),d=u+h+Pg(a,c,l)+EV[f]+Aa[f]|0,y=(Zi(n,2)^Zi(n,13)^Zi(n,22))+Rg(n,i,o)|0;u=l,l=c,c=a,a=s+d|0,s=o,o=i,i=n,n=d+y|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,i,o,s,a,c,l,u)}roundClean(){nn(Aa)}destroy(){this.set(0,0,0,0,0,0,0,0),nn(this.buffer)}},kx=class extends Ix{A=Ts[0]|0;B=Ts[1]|0;C=Ts[2]|0;D=Ts[3]|0;E=Ts[4]|0;F=Ts[5]|0;G=Ts[6]|0;H=Ts[7]|0;constructor(){super(32)}};var eC=W_(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),SV=eC[0],AV=eC[1],_a=new Uint32Array(80),Ca=new Uint32Array(80),Px=class extends rl{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:i,Ch:o,Cl:s,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:m,Hh:y,Hl:w}=this;return[e,t,n,i,o,s,a,c,l,u,f,h,d,m,y,w]}set(e,t,n,i,o,s,a,c,l,u,f,h,d,m,y,w){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=o|0,this.Cl=s|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=m|0,this.Hh=y|0,this.Hl=w|0}process(e,t){for(let E=0;E<16;E++,t+=4)_a[E]=e.getUint32(t),Ca[E]=e.getUint32(t+=4);for(let E=16;E<80;E++){let _=_a[E-15]|0,B=Ca[E-15]|0,H=nl(_,B,1)^nl(_,B,8)^Cx(_,B,7),U=il(_,B,1)^il(_,B,8)^Tx(_,B,7),C=_a[E-2]|0,I=Ca[E-2]|0,W=nl(C,I,19)^ip(C,I,61)^Cx(C,I,6),z=il(C,I,19)^op(C,I,61)^Tx(C,I,6),$=Y_(U,z,Ca[E-7],Ca[E-16]),S=Q_($,H,W,_a[E-7],_a[E-16]);_a[E]=S|0,Ca[E]=$|0}let{Ah:n,Al:i,Bh:o,Bl:s,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:m,Gh:y,Gl:w,Hh:x,Hl:v}=this;for(let E=0;E<80;E++){let _=nl(f,h,14)^nl(f,h,18)^ip(f,h,41),B=il(f,h,14)^il(f,h,18)^op(f,h,41),H=f&d^~f&y,U=h&m^~h&w,C=Z_(v,B,U,AV[E],Ca[E]),I=J_(C,x,_,H,SV[E],_a[E]),W=C|0,z=nl(n,i,28)^ip(n,i,34)^ip(n,i,39),$=il(n,i,28)^op(n,i,34)^op(n,i,39),S=n&o^n&a^o&a,k=i&s^i&c^s&c;x=y|0,v=w|0,y=d|0,w=m|0,d=f|0,m=h|0,{h:f,l:h}=Fo(l|0,u|0,I|0,W|0),l=a|0,u=c|0,a=o|0,c=s|0,o=n|0,s=i|0;let T=G_(W,$,k);n=X_(T,I,z,S),i=T|0}({h:n,l:i}=Fo(this.Ah|0,this.Al|0,n|0,i|0)),{h:o,l:s}=Fo(this.Bh|0,this.Bl|0,o|0,s|0),{h:a,l:c}=Fo(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Fo(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Fo(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:m}=Fo(this.Fh|0,this.Fl|0,d|0,m|0),{h:y,l:w}=Fo(this.Gh|0,this.Gl|0,y|0,w|0),{h:x,l:v}=Fo(this.Hh|0,this.Hl|0,x|0,v|0),this.set(n,i,o,s,a,c,l,u,f,h,d,m,y,w,x,v)}roundClean(){nn(_a,Ca)}destroy(){nn(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Rx=class extends Px{Ah=Ur[0]|0;Al=Ur[1]|0;Bh=Ur[2]|0;Bl=Ur[3]|0;Ch=Ur[4]|0;Cl=Ur[5]|0;Dh=Ur[6]|0;Dl=Ur[7]|0;Eh=Ur[8]|0;El=Ur[9]|0;Fh=Ur[10]|0;Fl=Ur[11]|0;Gh=Ur[12]|0;Gl=Ur[13]|0;Hh=Ur[14]|0;Hl=Ur[15]|0;constructor(){super(64)}};var Pi=np(()=>new kx,_x(1));var Ta=np(()=>new Rx,_x(3));var Ox=BigInt(0),Dx=BigInt(1);function Is(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function tC(r){if(typeof r=="bigint"){if(!Og(r))throw new Error("positive bigint expected, got "+r)}else rn(r);return r}function sp(r){let e=tC(r).toString(16);return e.length&1?"0"+e:e}function rC(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Ox:BigInt("0x"+r)}function pf(r){return rC(_s(r))}function $o(r){return rC(_s(ol(Re(r)).reverse()))}function Ng(r,e){rn(e),r=tC(r);let t=Cs(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function ap(r,e){return Ng(r,e).reverse()}function ol(r){return Uint8Array.from(r)}var Og=r=>typeof r=="bigint"&&Ox<=r;function _V(r,e,t){return Og(r)&&Og(e)&&Og(t)&&e<=r&&r<t}function Ia(r,e,t,n){if(!_V(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function Nx(r){let e;for(e=0;r>Ox;r>>=Dx,e+=1);return e}var cp=r=>(Dx<<BigInt(r))-Dx;function nC(r,e,t){if(rn(r,"hashLen"),rn(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=w=>new Uint8Array(w),i=Uint8Array.of(),o=Uint8Array.of(0),s=Uint8Array.of(1),a=1e3,c=n(r),l=n(r),u=0,f=()=>{c.fill(1),l.fill(0),u=0},h=(...w)=>t(l,Ln(c,...w)),d=(w=i)=>{l=h(o,w),c=h(),w.length!==0&&(l=h(s,w),c=h())},m=()=>{if(u++>=a)throw new Error("drbg: tried max amount of iterations");let w=0,x=[];for(;w<e;){c=h();let v=c.slice();x.push(v),w+=c.length}return Ln(...x)};return(w,x)=>{f(),d(w);let v;for(;!(v=x(m()));)d();return f(),v}}function Ho(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,s,a){let c=r[o];if(a&&c===void 0)return;let l=typeof c;if(l!==s||c===null)throw new Error(`param "${o}" is invalid: expected ${s}, got ${l}`)}let i=(o,s)=>Object.entries(o).forEach(([a,c])=>n(a,c,s));i(e,!1),i(t,!0)}function mf(r){let e=new WeakMap;return(t,...n)=>{let i=e.get(t);if(i!==void 0)return i;let o=r(t,...n);return e.set(t,o),o}}var yn=BigInt(0),Ir=BigInt(1),sl=BigInt(2),sC=BigInt(3),aC=BigInt(4),cC=BigInt(5),CV=BigInt(7),lC=BigInt(8),TV=BigInt(9),uC=BigInt(16);function Lt(r,e){let t=r%e;return t>=yn?t:e+t}function Rt(r,e,t){let n=r;for(;e-- >yn;)n*=n,n%=t;return n}function iC(r,e){if(r===yn)throw new Error("invert: expected non-zero number");if(e<=yn)throw new Error("invert: expected positive modulus, got "+e);let t=Lt(r,e),n=e,i=yn,o=Ir,s=Ir,a=yn;for(;t!==yn;){let l=n/t,u=n%t,f=i-s*l,h=o-a*l;n=t,t=u,i=s,o=a,s=f,a=h}if(n!==Ir)throw new Error("invert: does not exist");return Lt(i,e)}function Bx(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function fC(r,e){let t=(r.ORDER+Ir)/aC,n=r.pow(e,t);return Bx(r,n,e),n}function IV(r,e){let t=(r.ORDER-cC)/lC,n=r.mul(e,sl),i=r.pow(n,t),o=r.mul(e,i),s=r.mul(r.mul(o,sl),i),a=r.mul(o,r.sub(s,r.ONE));return Bx(r,a,e),a}function kV(r){let e=gf(r),t=dC(r),n=t(e,e.neg(e.ONE)),i=t(e,n),o=t(e,e.neg(n)),s=(r+CV)/uC;return(a,c)=>{let l=a.pow(c,s),u=a.mul(l,n),f=a.mul(l,i),h=a.mul(l,o),d=a.eql(a.sqr(u),c),m=a.eql(a.sqr(f),c);l=a.cmov(l,u,d),u=a.cmov(h,f,m);let y=a.eql(a.sqr(u),c),w=a.cmov(l,u,y);return Bx(a,w,c),w}}function dC(r){if(r<sC)throw new Error("sqrt is not defined for small field");let e=r-Ir,t=0;for(;e%sl===yn;)e/=sl,t++;let n=sl,i=gf(r);for(;oC(i,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return fC;let o=i.pow(n,e),s=(e+Ir)/sl;return function(c,l){if(c.is0(l))return l;if(oC(c,l)!==1)throw new Error("Cannot find square root");let u=t,f=c.mul(c.ONE,o),h=c.pow(l,e),d=c.pow(l,s);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let m=1,y=c.sqr(h);for(;!c.eql(y,c.ONE);)if(m++,y=c.sqr(y),m===u)throw new Error("Cannot find square root");let w=Ir<<BigInt(u-m-1),x=c.pow(f,w);u=m,f=c.sqr(x),h=c.mul(h,f),d=c.mul(d,x)}return d}}function PV(r){return r%aC===sC?fC:r%lC===cC?IV:r%uC===TV?kV(r):dC(r)}var hC=(r,e)=>(Lt(r,e)&Ir)===Ir,RV=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Mx(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=RV.reduce((n,i)=>(n[i]="function",n),e);return Ho(r,t),r}function DV(r,e,t){if(t<yn)throw new Error("invalid exponent, negatives unsupported");if(t===yn)return r.ONE;if(t===Ir)return e;let n=r.ONE,i=e;for(;t>yn;)t&Ir&&(n=r.mul(n,i)),i=r.sqr(i),t>>=Ir;return n}function lp(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),i=e.reduce((s,a,c)=>r.is0(a)?s:(n[c]=s,r.mul(s,a)),r.ONE),o=r.inv(i);return e.reduceRight((s,a,c)=>r.is0(a)?s:(n[c]=r.mul(s,n[c]),r.mul(s,a)),o),n}function oC(r,e){let t=(r.ORDER-Ir)/sl,n=r.pow(e,t),i=r.eql(n,r.ONE),o=r.eql(n,r.ZERO),s=r.eql(n,r.neg(r.ONE));if(!i&&!o&&!s)throw new Error("invalid Legendre symbol result");return i?1:o?0:-1}function OV(r,e){e!==void 0&&rn(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var Lx=class{ORDER;BITS;BYTES;isLE;ZERO=yn;ONE=Ir;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=yn)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:i,nByteLength:o}=OV(e,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=i,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Lt(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return yn<=e&&e<this.ORDER}is0(e){return e===yn}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Ir)===Ir}neg(e){return Lt(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Lt(e*e,this.ORDER)}add(e,t){return Lt(e+t,this.ORDER)}sub(e,t){return Lt(e-t,this.ORDER)}mul(e,t){return Lt(e*t,this.ORDER)}pow(e,t){return DV(this,e,t)}div(e,t){return Lt(e*iC(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return iC(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=PV(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?ap(e,this.BYTES):Ng(e,this.BYTES)}fromBytes(e,t=!1){Re(e);let{_lengths:n,BYTES:i,isLE:o,ORDER:s,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>i)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let l=new Uint8Array(i);l.set(e,o?0:l.length-e.length),e=l}if(e.length!==i)throw new Error("Field.fromBytes: expected "+i+" bytes, got "+e.length);let c=o?$o(e):pf(e);if(a&&(c=Lt(c,s)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return lp(this,e)}cmov(e,t,n){return n?t:e}};function gf(r,e={}){return new Lx(r,e)}function pC(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function Ux(r){let e=pC(r);return e+Math.ceil(e/2)}function Fx(r,e,t=!1){Re(r);let n=r.length,i=pC(e),o=Ux(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let s=t?$o(r):pf(r),a=Lt(s,e-Ir)+Ir;return t?ap(a,i):Ng(a,i)}var yf=BigInt(0),al=BigInt(1);function up(r,e){let t=e.negate();return r?t:e}function cl(r,e){let t=lp(r.Fp,e.map(n=>n.Z));return e.map((n,i)=>r.fromAffine(n.toAffine(t[i])))}function wC(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function $x(r,e){wC(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),i=2**r,o=cp(r),s=BigInt(r);return{windows:t,windowSize:n,mask:o,maxNumber:i,shiftBy:s}}function mC(r,e,t){let{windowSize:n,mask:i,maxNumber:o,shiftBy:s}=t,a=Number(r&i),c=r>>s;a>n&&(a-=o,c+=al);let l=e*n,u=l+Math.abs(a)-1,f=a===0,h=a<0,d=e%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:l}}var Hx=new WeakMap,xC=new WeakMap;function Vx(r){return xC.get(r)||1}function gC(r){if(r!==yf)throw new Error("invalid wNAF")}var wf=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let i=e;for(;t>yf;)t&al&&(n=n.add(i)),i=i.double(),t>>=al;return n}precomputeWindow(e,t){let{windows:n,windowSize:i}=$x(t,this.bits),o=[],s=e,a=s;for(let c=0;c<n;c++){a=s,o.push(a);for(let l=1;l<i;l++)a=a.add(s),o.push(a);s=a.double()}return o}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let i=this.ZERO,o=this.BASE,s=$x(e,this.bits);for(let a=0;a<s.windows;a++){let{nextN:c,offset:l,isZero:u,isNeg:f,isNegF:h,offsetF:d}=mC(n,a,s);n=c,u?o=o.add(up(h,t[d])):i=i.add(up(f,t[l]))}return gC(n),{p:i,f:o}}wNAFUnsafe(e,t,n,i=this.ZERO){let o=$x(e,this.bits);for(let s=0;s<o.windows&&n!==yf;s++){let{nextN:a,offset:c,isZero:l,isNeg:u}=mC(n,s,o);if(n=a,!l){let f=t[c];i=i.add(u?f.negate():f)}}return gC(n),i}getPrecomputes(e,t,n){let i=Hx.get(t);return i||(i=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(i=n(i)),Hx.set(t,i))),i}cached(e,t,n){let i=Vx(e);return this.wNAF(i,this.getPrecomputes(i,e,n),t)}unsafe(e,t,n,i){let o=Vx(e);return o===1?this._unsafeLadder(e,t,i):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),t,i)}createCache(e,t){wC(t,this.bits),xC.set(e,t),Hx.delete(e)}hasCache(e){return Vx(e)!==1}};function bC(r,e,t,n){let i=e,o=r.ZERO,s=r.ZERO;for(;t>yf||n>yf;)t&al&&(o=o.add(i)),n&al&&(s=s.add(i)),i=i.double(),t>>=al,n>>=al;return{p1:o,p2:s}}function yC(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Mx(e),e}else return gf(r,{isLE:t})}function Lg(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let l=e[c];if(!(typeof l=="bigint"&&l>yf))throw new Error(`CURVE.${c} must be positive bigint`)}let i=yC(e.p,t.Fp,n),o=yC(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!i.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:i,Fn:o}}function xf(r,e){return function(n){let i=r(n);return{secretKey:i,publicKey:e(i)}}}var ka=BigInt(0),kr=BigInt(1),zx=BigInt(2),NV=BigInt(8);function LV(r,e,t,n){let i=r.sqr(t),o=r.sqr(n),s=r.add(r.mul(e.a,i),o),a=r.add(r.ONE,r.mul(e.d,r.mul(i,o)));return r.eql(s,a)}function vC(r,e={}){let t=Lg("edwards",r,e,e.FpFnLE),{Fp:n,Fn:i}=t,o=t.CURVE,{h:s}=o;Ho(e,{},{uvRatio:"function"});let a=zx<<BigInt(i.BYTES*8)-kr,c=w=>n.create(w),l=e.uvRatio||((w,x)=>{try{return{isValid:!0,value:n.sqrt(n.div(w,x))}}catch{return{isValid:!1,value:ka}}});if(!LV(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function u(w,x,v=!1){let E=v?kr:ka;return Ia("coordinate "+w,x,E,a),x}function f(w){if(!(w instanceof m))throw new Error("EdwardsPoint expected")}let h=mf((w,x)=>{let{X:v,Y:E,Z:_}=w,B=w.is0();x==null&&(x=B?NV:n.inv(_));let H=c(v*x),U=c(E*x),C=n.mul(_,x);if(B)return{x:ka,y:kr};if(C!==kr)throw new Error("invZ was invalid");return{x:H,y:U}}),d=mf(w=>{let{a:x,d:v}=o;if(w.is0())throw new Error("bad point: ZERO");let{X:E,Y:_,Z:B,T:H}=w,U=c(E*E),C=c(_*_),I=c(B*B),W=c(I*I),z=c(U*x),$=c(I*c(z+C)),S=c(W+c(v*c(U*C)));if($!==S)throw new Error("bad point: equation left != right (1)");let k=c(E*_),T=c(B*H);if(k!==T)throw new Error("bad point: equation left != right (2)");return!0});class m{static BASE=new m(o.Gx,o.Gy,kr,c(o.Gx*o.Gy));static ZERO=new m(ka,kr,kr,ka);static Fp=n;static Fn=i;X;Y;Z;T;constructor(x,v,E,_){this.X=u("x",x),this.Y=u("y",v),this.Z=u("z",E,!0),this.T=u("t",_),Object.freeze(this)}static CURVE(){return o}static fromAffine(x){if(x instanceof m)throw new Error("extended point not allowed");let{x:v,y:E}=x||{};return u("x",v),u("y",E),new m(v,E,kr,c(v*E))}static fromBytes(x,v=!1){let E=n.BYTES,{a:_,d:B}=o;x=ol(Re(x,E,"point")),Is(v,"zip215");let H=ol(x),U=x[E-1];H[E-1]=U&-129;let C=$o(H),I=v?a:n.ORDER;Ia("point.y",C,ka,I);let W=c(C*C),z=c(W-kr),$=c(B*W-_),{isValid:S,value:k}=l(z,$);if(!S)throw new Error("bad point: invalid y coordinate");let T=(k&kr)===kr,M=(U&128)!==0;if(!v&&k===ka&&M)throw new Error("bad point: x=0 and x_0=1");return M!==T&&(k=c(-k)),m.fromAffine({x:k,y:C})}static fromHex(x,v=!1){return m.fromBytes(Cs(x),v)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(x=8,v=!0){return y.createCache(this,x),v||this.multiply(zx),this}assertValidity(){d(this)}equals(x){f(x);let{X:v,Y:E,Z:_}=this,{X:B,Y:H,Z:U}=x,C=c(v*U),I=c(B*_),W=c(E*U),z=c(H*_);return C===I&&W===z}is0(){return this.equals(m.ZERO)}negate(){return new m(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:x}=o,{X:v,Y:E,Z:_}=this,B=c(v*v),H=c(E*E),U=c(zx*c(_*_)),C=c(x*B),I=v+E,W=c(c(I*I)-B-H),z=C+H,$=z-U,S=C-H,k=c(W*$),T=c(z*S),M=c(W*S),X=c($*z);return new m(k,T,X,M)}add(x){f(x);let{a:v,d:E}=o,{X:_,Y:B,Z:H,T:U}=this,{X:C,Y:I,Z:W,T:z}=x,$=c(_*C),S=c(B*I),k=c(U*E*z),T=c(H*W),M=c((_+B)*(C+I)-$-S),X=T-k,Y=T+k,F=c(S-v*$),Z=c(M*X),te=c(Y*F),V=c(M*F),Pe=c(X*Y);return new m(Z,te,Pe,V)}subtract(x){return this.add(x.negate())}multiply(x){if(!i.isValidNot0(x))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:v,f:E}=y.cached(this,x,_=>cl(m,_));return cl(m,[v,E])[0]}multiplyUnsafe(x,v=m.ZERO){if(!i.isValid(x))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return x===ka?m.ZERO:this.is0()||x===kr?this:y.unsafe(this,x,E=>cl(m,E),v)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return y.unsafe(this,o.n).is0()}toAffine(x){return h(this,x)}clearCofactor(){return s===kr?this:this.multiplyUnsafe(s)}toBytes(){let{x,y:v}=this.toAffine(),E=n.toBytes(v);return E[E.length-1]|=x&kr?128:0,E}toHex(){return _s(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let y=new wf(m,i.BITS);return m.BASE.precompute(8),m}function EC(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Ho(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:i,Fp:o,Fn:s}=r,a=t.randomBytes||Uo,c=t.adjustScalarBytes||(C=>C),l=t.domain||((C,I,W)=>{if(Is(W,"phflag"),I.length||W)throw new Error("Contexts/pre-hash are not supported");return C});function u(C){return s.create($o(C))}function f(C){let I=E.secretKey;Re(C,E.secretKey,"secretKey");let W=Re(e(C),2*I,"hashedSecretKey"),z=c(W.slice(0,I)),$=W.slice(I,2*I),S=u(z);return{head:z,prefix:$,scalar:S}}function h(C){let{head:I,prefix:W,scalar:z}=f(C),$=i.multiply(z),S=$.toBytes();return{head:I,prefix:W,scalar:z,point:$,pointBytes:S}}function d(C){return h(C).pointBytes}function m(C=Uint8Array.of(),...I){let W=Ln(...I);return u(e(l(W,Re(C,void 0,"context"),!!n)))}function y(C,I,W={}){C=Re(C,void 0,"message"),n&&(C=n(C));let{prefix:z,scalar:$,pointBytes:S}=h(I),k=m(W.context,z,C),T=i.multiply(k).toBytes(),M=m(W.context,T,S,C),X=s.create(k+M*$);if(!s.isValid(X))throw new Error("sign failed: invalid s");let Y=Ln(T,s.toBytes(X));return Re(Y,E.signature,"result")}let w={zip215:!0};function x(C,I,W,z=w){let{context:$,zip215:S}=z,k=E.signature;C=Re(C,k,"signature"),I=Re(I,void 0,"message"),W=Re(W,E.publicKey,"publicKey"),S!==void 0&&Is(S,"zip215"),n&&(I=n(I));let T=k/2,M=C.subarray(0,T),X=$o(C.subarray(T,k)),Y,F,Z;try{Y=r.fromBytes(W,S),F=r.fromBytes(M,S),Z=i.multiplyUnsafe(X)}catch{return!1}if(!S&&Y.isSmallOrder())return!1;let te=m($,F.toBytes(),Y.toBytes(),I);return F.add(Y.multiplyUnsafe(te)).subtract(Z).clearCofactor().is0()}let v=o.BYTES,E={secretKey:v,publicKey:v,signature:2*v,seed:v};function _(C=a(E.seed)){return Re(C,E.seed,"seed")}function B(C){return el(C)&&C.length===s.BYTES}function H(C,I){try{return!!r.fromBytes(C,I)}catch{return!1}}let U={getExtendedPublicKey:h,randomSecretKey:_,isValidSecretKey:B,isValidPublicKey:H,toMontgomery(C){let{y:I}=r.fromBytes(C),W=E.publicKey,z=W===32;if(!z&&W!==57)throw new Error("only defined for 25519 and 448");let $=z?o.div(kr+I,kr-I):o.div(I-kr,I+kr);return o.toBytes($)},toMontgomerySecret(C){let I=E.secretKey;Re(C,I);let W=e(C.subarray(0,I));return c(W).subarray(0,I)}};return Object.freeze({keygen:xf(_,d),getPublicKey:d,sign:y,verify:x,utils:U,Point:r,lengths:E})}var fp=BigInt(0),bf=BigInt(1),Bg=BigInt(2);function BV(r){return Ho(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function SC(r){let e=BV(r),{P:t,type:n,adjustScalarBytes:i,powPminus2:o,randomBytes:s}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=s||Uo,l=a?255:448,u=a?32:56,f=BigInt(a?9:5),h=BigInt(a?121665:39081),d=a?Bg**BigInt(254):Bg**BigInt(447),m=a?BigInt(8)*Bg**BigInt(251)-bf:BigInt(4)*Bg**BigInt(445)-bf,y=d+m+bf,w=k=>Lt(k,t),x=v(f);function v(k){return ap(w(k),u)}function E(k){let T=ol(Re(k,u,"uCoordinate"));return a&&(T[31]&=127),w($o(T))}function _(k){return $o(i(ol(Re(k,u,"scalar"))))}function B(k,T){let M=W(E(T),_(k));if(M===fp)throw new Error("invalid private or public key received");return v(M)}function H(k){return B(k,x)}let U=H,C=B;function I(k,T,M){let X=w(k*(T-M));return T=w(T-X),M=w(M+X),{x_2:T,x_3:M}}function W(k,T){Ia("u",k,fp,t),Ia("scalar",T,d,y);let M=T,X=k,Y=bf,F=fp,Z=k,te=bf,V=fp;for(let Be=BigInt(l-1);Be>=fp;Be--){let ce=M>>Be&bf;V^=ce,{x_2:Y,x_3:Z}=I(V,Y,Z),{x_2:F,x_3:te}=I(V,F,te),V=ce;let Me=Y+F,Qe=w(Me*Me),xt=Y-F,He=w(xt*xt),rt=Qe-He,Ci=Z+te,On=Z-te,Wi=w(On*Me),pg=w(Ci*xt),Ju=Wi+pg,zh=Wi-pg;Z=w(Ju*Ju),te=w(X*w(zh*zh)),Y=w(Qe*He),F=w(rt*(Qe+w(h*rt)))}({x_2:Y,x_3:Z}=I(V,Y,Z)),{x_2:F,x_3:te}=I(V,F,te);let Pe=o(F);return w(Y*Pe)}let z={secretKey:u,publicKey:u,seed:u},$=(k=c(u))=>(Re(k,z.seed,"seed"),k),S={randomSecretKey:$};return Object.freeze({keygen:xf($,U),getSharedSecret:C,getPublicKey:U,scalarMult:B,scalarMultBase:H,utils:S,GuBytes:x.slice(),lengths:z})}var MV=BigInt(1),AC=BigInt(2),UV=BigInt(3),FV=BigInt(5),$V=BigInt(8),Mg=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),HV={p:Mg,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:$V,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function CC(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),i=BigInt(80),o=Mg,a=r*r%o*r%o,c=Rt(a,AC,o)*a%o,l=Rt(c,MV,o)*r%o,u=Rt(l,FV,o)*l%o,f=Rt(u,e,o)*u%o,h=Rt(f,t,o)*f%o,d=Rt(h,n,o)*h%o,m=Rt(d,i,o)*d%o,y=Rt(m,i,o)*d%o,w=Rt(y,e,o)*u%o;return{pow_p_5_8:Rt(w,AC,o)*r%o,b2:a}}function TC(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var _C=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function VV(r,e){let t=Mg,n=Lt(e*e*e,t),i=Lt(n*n*e,t),o=CC(r*i).pow_p_5_8,s=Lt(r*n*o,t),a=Lt(e*s*s,t),c=s,l=Lt(s*_C,t),u=a===r,f=a===Lt(-r,t),h=a===Lt(-r*_C,t);return u&&(s=c),(f||h)&&(s=l),hC(s,t)&&(s=Lt(-s,t)),{isValid:u||f,value:s}}var zV=vC(HV,{uvRatio:VV});function KV(r){return EC(zV,Ta,Object.assign({adjustScalarBytes:TC},r))}var dp=KV({});var hp=(()=>{let r=Mg;return SC({P:r,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:n}=CC(e);return Lt(Rt(t,UV,r)*n,r)},adjustScalarBytes:TC})})();var pp=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},mp=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},Ug=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var IC={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new Ug("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var cr=IC;var ll=32,ii=64,Kx=32;var vf,kC=(async()=>{try{return await cr.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function PC(){let r=dp.utils.randomSecretKey(),e=dp.getPublicKey(r);return{privateKey:XV(r,e),publicKey:e}}async function qV(r,e){let t;r.length===ii?t=r.subarray(0,32):t=r;let n={crv:"Ed25519",kty:"OKP",x:K(r.subarray(32),"base64url"),d:K(t,"base64url"),ext:!0,key_ops:["sign"]},i=await cr.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),o=await cr.get().subtle.sign({name:"Ed25519"},i,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(o,0,o.byteLength)}function jV(r,e){let t=r.subarray(0,Kx);return dp.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function RC(r,e){return vf==null&&(vf=await kC),vf?qV(r,e):jV(r,e)}async function WV(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await cr.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await cr.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function GV(r,e,t){return dp.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function DC(r,e,t){return vf==null&&(vf=await kC),vf?WV(r,e,t):GV(r,e,t)}function XV(r,e){let t=new Uint8Array(ii);for(let n=0;n<Kx;n++)t[n]=r[n],t[Kx+n]=e[n];return t}function Ef(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var gp=class{type="Ed25519";raw;constructor(e){this.raw=Af(e,ll)}toMultihash(){return or.digest(ar(this))}toCID(){return j.createV1(114,this.toMultihash())}toString(){return nt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let i=DC(this.raw,t,e);return Ef(i)?i.then(o=>(n?.signal?.throwIfAborted(),o)):i}},Sf=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=Af(e,ii),this.publicKey=new gp(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();let n=RC(this.raw,e);return Ef(n)?n.then(i=>(t?.signal?.throwIfAborted(),i)):(t?.signal?.throwIfAborted(),n)}};function qx(r){if(r.length>ii){r=Af(r,ii+ll);let n=r.subarray(0,ii),i=r.subarray(ii,r.length);return new Sf(n,i)}r=Af(r,ii);let e=r.subarray(0,ii),t=r.subarray(ll);return new Sf(e,t)}function jx(r){return r=Af(r,ll),new gp(r)}async function NC(){let{privateKey:r,publicKey:e}=PC();return new Sf(r,e)}function Af(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new O(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var YV=Math.pow(2,7),QV=Math.pow(2,14),ZV=Math.pow(2,21),Wx=Math.pow(2,28),Gx=Math.pow(2,35),Xx=Math.pow(2,42),Yx=Math.pow(2,49),ht=128,on=127;function Ke(r){if(r<YV)return 1;if(r<QV)return 2;if(r<ZV)return 3;if(r<Wx)return 4;if(r<Gx)return 5;if(r<Xx)return 6;if(r<Yx)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function _f(r,e,t=0){switch(Ke(r)){case 8:e[t++]=r&255|ht,r/=128;case 7:e[t++]=r&255|ht,r/=128;case 6:e[t++]=r&255|ht,r/=128;case 5:e[t++]=r&255|ht,r/=128;case 4:e[t++]=r&255|ht,r>>>=7;case 3:e[t++]=r&255|ht,r>>>=7;case 2:e[t++]=r&255|ht,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function JV(r,e,t=0){switch(Ke(r)){case 8:e.set(t++,r&255|ht),r/=128;case 7:e.set(t++,r&255|ht),r/=128;case 6:e.set(t++,r&255|ht),r/=128;case 5:e.set(t++,r&255|ht),r/=128;case 4:e.set(t++,r&255|ht),r>>>=7;case 3:e.set(t++,r&255|ht),r>>>=7;case 2:e.set(t++,r&255|ht),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Qx(r,e){let t=r[e],n=0;if(n+=t&on,t<ht||(t=r[e+1],n+=(t&on)<<7,t<ht)||(t=r[e+2],n+=(t&on)<<14,t<ht)||(t=r[e+3],n+=(t&on)<<21,t<ht)||(t=r[e+4],n+=(t&on)*Wx,t<ht)||(t=r[e+5],n+=(t&on)*Gx,t<ht)||(t=r[e+6],n+=(t&on)*Xx,t<ht)||(t=r[e+7],n+=(t&on)*Yx,t<ht))return n;throw new RangeError("Could not decode varint")}function ez(r,e){let t=r.get(e),n=0;if(n+=t&on,t<ht||(t=r.get(e+1),n+=(t&on)<<7,t<ht)||(t=r.get(e+2),n+=(t&on)<<14,t<ht)||(t=r.get(e+3),n+=(t&on)<<21,t<ht)||(t=r.get(e+4),n+=(t&on)*Wx,t<ht)||(t=r.get(e+5),n+=(t&on)*Gx,t<ht)||(t=r.get(e+6),n+=(t&on)*Xx,t<ht)||(t=r.get(e+7),n+=(t&on)*Yx,t<ht))return n;throw new RangeError("Could not decode varint")}function sn(r,e,t=0){return e==null&&(e=Ft(Ke(r))),e instanceof Uint8Array?_f(r,e,t):JV(r,e,t)}function oi(r,e=0){return r instanceof Uint8Array?Qx(r,e):ez(r,e)}var Zx=new Float32Array([-0]),Pa=new Uint8Array(Zx.buffer);function LC(r,e,t){Zx[0]=r,e[t]=Pa[0],e[t+1]=Pa[1],e[t+2]=Pa[2],e[t+3]=Pa[3]}function BC(r,e){return Pa[0]=r[e],Pa[1]=r[e+1],Pa[2]=r[e+2],Pa[3]=r[e+3],Zx[0]}var Jx=new Float64Array([-0]),an=new Uint8Array(Jx.buffer);function MC(r,e,t){Jx[0]=r,e[t]=an[0],e[t+1]=an[1],e[t+2]=an[2],e[t+3]=an[3],e[t+4]=an[4],e[t+5]=an[5],e[t+6]=an[6],e[t+7]=an[7]}function UC(r,e){return an[0]=r[e],an[1]=r[e+1],an[2]=r[e+2],an[3]=r[e+3],an[4]=r[e+4],an[5]=r[e+5],an[6]=r[e+6],an[7]=r[e+7],Jx[0]}var tz=BigInt(Number.MAX_SAFE_INTEGER),rz=BigInt(Number.MIN_SAFE_INTEGER),si=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return ul;if(e<tz&&e>rz)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>FC&&(i=0n,++n>FC&&(n=0n))),new r(Number(i),Number(n))}static fromNumber(e){if(e===0)return ul;let t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new r(n,i)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):ul}},ul=new si(0,0);ul.toBigInt=function(){return 0n};ul.zzEncode=ul.zzDecode=function(){return this};ul.length=function(){return 1};var FC=4294967296n;function $C(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function HC(r,e,t){if(t-e<1)return"";let i,o=[],s=0,a;for(;e<t;)a=r[e++],a<128?o[s++]=a:a>191&&a<224?o[s++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,o[s++]=55296+(a>>10),o[s++]=56320+(a&1023)):o[s++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,s>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,o)),s=0);return i!=null?(s>0&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))}function e7(r,e,t){let n=t,i,o;for(let s=0;s<r.length;++s)i=r.charCodeAt(s),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((o=r.charCodeAt(s+1))&64512)===56320?(i=65536+((i&1023)<<10)+(o&1023),++s,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function Ji(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Fg(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var t7=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Ji(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Ji(this,4);return Fg(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Ji(this,4);return Fg(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Ji(this,4);let e=BC(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Ji(this,4);let e=UC(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Ji(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return HC(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Ji(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Ji(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new si(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Ji(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Ji(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Ji(this,8);let e=Fg(this.buf,this.pos+=4),t=Fg(this.buf,this.pos+=4);return new si(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=Qx(this.buf,this.pos);return this.pos+=Ke(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function r7(r){return new t7(r instanceof Uint8Array?r:r.subarray())}function xe(r,e,t){let n=r7(r);return e.decode(n,void 0,t)}function n7(r){let e=r??8192,t=e>>>1,n,i=e;return function(s){if(s<1||s>t)return Ft(s);i+s>e&&(n=Ft(e),i=0);let a=n.subarray(i,i+=s);return(i&7)!==0&&(i=(i|7)+1),a}}var fl=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function i7(){}var s7=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},nz=n7();function iz(r){return globalThis.Buffer!=null?Ft(r):nz(r)}var wp=class{len;head;tail;states;constructor(){this.len=0,this.head=new fl(i7,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new fl(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new a7((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push($g,10,si.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=si.fromBigInt(e);return this._push($g,t.length(),t)}uint64Number(e){return this._push(_f,Ke(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=si.fromBigInt(e).zzEncode();return this._push($g,t.length(),t)}sint64Number(e){let t=si.fromNumber(e).zzEncode();return this._push($g,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(o7,1,e?1:0)}fixed32(e){return this._push(yp,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=si.fromBigInt(e);return this._push(yp,4,t.lo)._push(yp,4,t.hi)}fixed64Number(e){let t=si.fromNumber(e);return this._push(yp,4,t.lo)._push(yp,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(LC,4,e)}double(e){return this._push(MC,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(o7,1,0):this.uint32(t)._push(sz,t,e)}string(e){let t=$C(e);return t!==0?this.uint32(t)._push(e7,t,e):this._push(o7,1,0)}fork(){return this.states=new s7(this),this.head=this.tail=new fl(i7,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new fl(i7,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=iz(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function o7(r,e,t){e[t]=r&255}function oz(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var a7=class extends fl{next;constructor(e,t){super(oz,e,t),this.next=void 0}};function $g(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function yp(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function sz(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(wp.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(az,e,r),this},wp.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(cz,e,r),this});function az(r,e,t){e.set(r,t)}function cz(r,e,t){r.length<40?e7(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(R(r),t)}function c7(){return new wp}function be(r,e){let t=c7();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Cf;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Cf||(Cf={}));function Hg(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function _t(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}let t=function(o,s){let a=e(o);s.int32(a)},n=function(o){let s=o.int32();return e(s)};return Hg("enum",Cf.VARINT,t,n)}function ve(r,e){return Hg("message",Cf.LENGTH_DELIMITED,r,e)}var yt=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},xp=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var Ct;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Ct||(Ct={}));var l7;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(l7||(l7={}));(function(r){r.codec=()=>_t(l7)})(Ct||(Ct={}));var Vo;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Ct.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Ct.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Vo||(Vo={}));var bp;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Ct.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.Type=Ct.codec().decode(t);break}case 2:{o.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(bp||(bp={}));function wn(r){if(isNaN(r)||r<=0)throw new O("random bytes length must be a Number bigger than 0");return Uo(r)}var Ep={};Ut(Ep,{MAX_RSA_KEY_SIZE:()=>u7,generateRSAKeyPair:()=>x7,jwkToJWKKeyPair:()=>jC,jwkToPkcs1:()=>dz,jwkToPkix:()=>p7,jwkToRSAPrivateKey:()=>w7,pkcs1MessageToJwk:()=>d7,pkcs1MessageToRSAPrivateKey:()=>Vg,pkcs1ToJwk:()=>fz,pkcs1ToRSAPrivateKey:()=>m7,pkixMessageToJwk:()=>h7,pkixMessageToRSAPublicKey:()=>y7,pkixToJwk:()=>hz,pkixToRSAPublicKey:()=>g7});var Tf=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Ep.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return j.createV1(114,this._multihash)}toString(){return nt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){return qC(this.jwk,t,e,n)}},vp=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Ep.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){return KC(this.jwk,e,t)}};var u7=8192,f7=18,lz=1062,uz=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function fz(r){let e=ki(r);return d7(e)}function d7(r){return{n:K(r[1],"base64url"),e:K(r[2],"base64url"),d:K(r[3],"base64url"),p:K(r[4],"base64url"),q:K(r[5],"base64url"),dp:K(r[6],"base64url"),dq:K(r[7],"base64url"),qi:K(r[8],"base64url"),kty:"RSA"}}function dz(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new O("JWK was missing components");return Qi([gn(Uint8Array.from([0])),gn(R(r.n,"base64url")),gn(R(r.e,"base64url")),gn(R(r.d,"base64url")),gn(R(r.p,"base64url")),gn(R(r.q,"base64url")),gn(R(r.dp,"base64url")),gn(R(r.dq,"base64url")),gn(R(r.qi,"base64url"))]).subarray()}function hz(r){let e=ki(r,{offset:0});return h7(e)}function h7(r){let e=ki(r[1],{offset:0});return{kty:"RSA",n:K(e[0],"base64url"),e:K(e[1],"base64url")}}function p7(r){if(r.n==null||r.e==null)throw new O("JWK was missing components");return Qi([uz,rp(Qi([gn(R(r.n,"base64url")),gn(R(r.e,"base64url"))]))]).subarray()}function m7(r){let e=ki(r);return Vg(e)}function Vg(r){let e=d7(r);return w7(e)}function g7(r,e){if(r.byteLength>=lz)throw new vs("Key size is too large");let t=ki(r,{offset:0});return y7(t,r,e)}function y7(r,e,t){let n=h7(r);if(t==null){let i=Pi(Vo.encode({Type:Ct.RSA,Data:e}));t=mn(f7,i)}return new Tf(n,t)}function w7(r){if(GC(r)>u7)throw new O("Key size is too large");let e=jC(r),t=Pi(Vo.encode({Type:Ct.RSA,Data:p7(e.publicKey)})),n=mn(f7,t);return new vp(e.privateKey,new Tf(e.publicKey,n))}async function x7(r){if(r>u7)throw new O("Key size is too large");let e=await WC(r),t=Pi(Vo.encode({Type:Ct.RSA,Data:p7(e.publicKey)})),n=mn(f7,t);return new vp(e.privateKey,new Tf(e.publicKey,n))}function jC(r){if(r==null)throw new O("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function WC(r,e){let t=await cr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await pz(t,e);return{privateKey:n[0],publicKey:n[1]}}async function KC(r,e,t){let n=await cr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let i=await cr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function qC(r,e,t,n){let i=await cr.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let o=await cr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},i,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),o}async function pz(r,e){if(r.privateKey==null||r.publicKey==null)throw new O("Private and public key are required");let t=await Promise.all([cr.get().subtle.exportKey("jwk",r.privateKey),cr.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function GC(r){if(r.kty!=="RSA")throw new O("invalid key type");if(r.n==null)throw new O("invalid key modulus");return R(r.n,"base64url").length*8}var zg=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(As(e),Re(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,i=new Uint8Array(n);i.set(t.length>n?e.create().update(t).digest():t);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),nn(i)}update(e){return hf(this),this.iHash.update(e),this}digestInto(e){hf(this),Re(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});let{oHash:t,iHash:n,finished:i,destroyed:o,blockLen:s,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=o,e.blockLen=s,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ra=(r,e,t)=>new zg(r,e).update(t).digest();Ra.create=(r,e)=>new zg(r,e);var XC=(r,e)=>(r+(r>=0?e:-e)/YC)/e;function mz(r,e,t){let[[n,i],[o,s]]=e,a=XC(s*r,t),c=XC(-i*r,t),l=r-a*n-c*o,u=-a*i-c*s,f=l<Ps,h=u<Ps;f&&(l=-l),h&&(u=-u);let d=cp(Math.ceil(Nx(t)/2))+If;if(l<Ps||l>=d||u<Ps||u>=d)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}function v7(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function b7(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Is(t.lowS,"lowS"),Is(t.prehash,"prehash"),t.format!==void 0&&v7(t.format),t}var E7=class extends Error{constructor(e=""){super(e)}},Da={Err:E7,_tlv:{encode:(r,e)=>{let{Err:t}=Da;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,i=sp(n);if(i.length/2&128)throw new t("tlv.encode: long form length too big");let o=n>127?sp(i.length/2|128):"";return sp(r)+o+i+e},decode(r,e){let{Err:t}=Da,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let i=e[n++],o=!!(i&128),s=0;if(!o)s=i;else{let c=i&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let u of l)s=s<<8|u;if(n+=c,s<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+s);if(a.length!==s)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+s)}}},_int:{encode(r){let{Err:e}=Da;if(r<Ps)throw new e("integer: negative integers are not allowed");let t=sp(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=Da;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return pf(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=Da,i=Re(r,void 0,"signature"),{v:o,l:s}=n.decode(48,i);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){let{_tlv:e,_int:t}=Da,n=e.encode(2,t.encode(r.r)),i=e.encode(2,t.encode(r.s)),o=n+i;return e.encode(48,o)}},Ps=BigInt(0),If=BigInt(1),YC=BigInt(2),Kg=BigInt(3),gz=BigInt(4);function QC(r,e={}){let t=Lg("weierstrass",r,e),{Fp:n,Fn:i}=t,o=t.CURVE,{h:s,n:a}=o;Ho(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=JC(n,i);function u(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f($,S,k){let{x:T,y:M}=S.toAffine(),X=n.toBytes(T);if(Is(k,"isCompressed"),k){u();let Y=!n.isOdd(M);return Ln(ZC(Y),X)}else return Ln(Uint8Array.of(4),X,n.toBytes(M))}function h($){Re($,void 0,"Point");let{publicKey:S,publicKeyUncompressed:k}=l,T=$.length,M=$[0],X=$.subarray(1);if(T===S&&(M===2||M===3)){let Y=n.fromBytes(X);if(!n.isValid(Y))throw new Error("bad point: is not on curve, wrong x");let F=y(Y),Z;try{Z=n.sqrt(F)}catch(Pe){let Be=Pe instanceof Error?": "+Pe.message:"";throw new Error("bad point: is not on curve, sqrt error"+Be)}u();let te=n.isOdd(Z);return(M&1)===1!==te&&(Z=n.neg(Z)),{x:Y,y:Z}}else if(T===k&&M===4){let Y=n.BYTES,F=n.fromBytes(X.subarray(0,Y)),Z=n.fromBytes(X.subarray(Y,Y*2));if(!w(F,Z))throw new Error("bad point: is not on curve");return{x:F,y:Z}}else throw new Error(`bad point: got length ${T}, expected compressed=${S} or uncompressed=${k}`)}let d=e.toBytes||f,m=e.fromBytes||h;function y($){let S=n.sqr($),k=n.mul(S,$);return n.add(n.add(k,n.mul($,o.a)),o.b)}function w($,S){let k=n.sqr(S),T=y($);return n.eql(k,T)}if(!w(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let x=n.mul(n.pow(o.a,Kg),gz),v=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(x,v)))throw new Error("bad curve params: a or b");function E($,S,k=!1){if(!n.isValid(S)||k&&n.is0(S))throw new Error(`bad point coordinate ${$}`);return S}function _($){if(!($ instanceof I))throw new Error("Weierstrass Point expected")}function B($){if(!c||!c.basises)throw new Error("no endo");return mz($,c.basises,i.ORDER)}let H=mf(($,S)=>{let{X:k,Y:T,Z:M}=$;if(n.eql(M,n.ONE))return{x:k,y:T};let X=$.is0();S==null&&(S=X?n.ONE:n.inv(M));let Y=n.mul(k,S),F=n.mul(T,S),Z=n.mul(M,S);if(X)return{x:n.ZERO,y:n.ZERO};if(!n.eql(Z,n.ONE))throw new Error("invZ was invalid");return{x:Y,y:F}}),U=mf($=>{if($.is0()){if(e.allowInfinityPoint&&!n.is0($.Y))return;throw new Error("bad point: ZERO")}let{x:S,y:k}=$.toAffine();if(!n.isValid(S)||!n.isValid(k))throw new Error("bad point: x or y not field elements");if(!w(S,k))throw new Error("bad point: equation left != right");if(!$.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function C($,S,k,T,M){return k=new I(n.mul(k.X,$),k.Y,k.Z),S=up(T,S),k=up(M,k),S.add(k)}class I{static BASE=new I(o.Gx,o.Gy,n.ONE);static ZERO=new I(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=i;X;Y;Z;constructor(S,k,T){this.X=E("x",S),this.Y=E("y",k,!0),this.Z=E("z",T),Object.freeze(this)}static CURVE(){return o}static fromAffine(S){let{x:k,y:T}=S||{};if(!S||!n.isValid(k)||!n.isValid(T))throw new Error("invalid affine point");if(S instanceof I)throw new Error("projective point not allowed");return n.is0(k)&&n.is0(T)?I.ZERO:new I(k,T,n.ONE)}static fromBytes(S){let k=I.fromAffine(m(Re(S,void 0,"point")));return k.assertValidity(),k}static fromHex(S){return I.fromBytes(Cs(S))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(S=8,k=!0){return z.createCache(this,S),k||this.multiply(Kg),this}assertValidity(){U(this)}hasEvenY(){let{y:S}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(S)}equals(S){_(S);let{X:k,Y:T,Z:M}=this,{X,Y,Z:F}=S,Z=n.eql(n.mul(k,F),n.mul(X,M)),te=n.eql(n.mul(T,F),n.mul(Y,M));return Z&&te}negate(){return new I(this.X,n.neg(this.Y),this.Z)}double(){let{a:S,b:k}=o,T=n.mul(k,Kg),{X:M,Y:X,Z:Y}=this,F=n.ZERO,Z=n.ZERO,te=n.ZERO,V=n.mul(M,M),Pe=n.mul(X,X),Be=n.mul(Y,Y),ce=n.mul(M,X);return ce=n.add(ce,ce),te=n.mul(M,Y),te=n.add(te,te),F=n.mul(S,te),Z=n.mul(T,Be),Z=n.add(F,Z),F=n.sub(Pe,Z),Z=n.add(Pe,Z),Z=n.mul(F,Z),F=n.mul(ce,F),te=n.mul(T,te),Be=n.mul(S,Be),ce=n.sub(V,Be),ce=n.mul(S,ce),ce=n.add(ce,te),te=n.add(V,V),V=n.add(te,V),V=n.add(V,Be),V=n.mul(V,ce),Z=n.add(Z,V),Be=n.mul(X,Y),Be=n.add(Be,Be),V=n.mul(Be,ce),F=n.sub(F,V),te=n.mul(Be,Pe),te=n.add(te,te),te=n.add(te,te),new I(F,Z,te)}add(S){_(S);let{X:k,Y:T,Z:M}=this,{X,Y,Z:F}=S,Z=n.ZERO,te=n.ZERO,V=n.ZERO,Pe=o.a,Be=n.mul(o.b,Kg),ce=n.mul(k,X),Me=n.mul(T,Y),Qe=n.mul(M,F),xt=n.add(k,T),He=n.add(X,Y);xt=n.mul(xt,He),He=n.add(ce,Me),xt=n.sub(xt,He),He=n.add(k,M);let rt=n.add(X,F);return He=n.mul(He,rt),rt=n.add(ce,Qe),He=n.sub(He,rt),rt=n.add(T,M),Z=n.add(Y,F),rt=n.mul(rt,Z),Z=n.add(Me,Qe),rt=n.sub(rt,Z),V=n.mul(Pe,He),Z=n.mul(Be,Qe),V=n.add(Z,V),Z=n.sub(Me,V),V=n.add(Me,V),te=n.mul(Z,V),Me=n.add(ce,ce),Me=n.add(Me,ce),Qe=n.mul(Pe,Qe),He=n.mul(Be,He),Me=n.add(Me,Qe),Qe=n.sub(ce,Qe),Qe=n.mul(Pe,Qe),He=n.add(He,Qe),ce=n.mul(Me,He),te=n.add(te,ce),ce=n.mul(rt,He),Z=n.mul(xt,Z),Z=n.sub(Z,ce),ce=n.mul(xt,Me),V=n.mul(rt,V),V=n.add(V,ce),new I(Z,te,V)}subtract(S){return this.add(S.negate())}is0(){return this.equals(I.ZERO)}multiply(S){let{endo:k}=e;if(!i.isValidNot0(S))throw new Error("invalid scalar: out of range");let T,M,X=Y=>z.cached(this,Y,F=>cl(I,F));if(k){let{k1neg:Y,k1:F,k2neg:Z,k2:te}=B(S),{p:V,f:Pe}=X(F),{p:Be,f:ce}=X(te);M=Pe.add(ce),T=C(k.beta,V,Be,Y,Z)}else{let{p:Y,f:F}=X(S);T=Y,M=F}return cl(I,[T,M])[0]}multiplyUnsafe(S){let{endo:k}=e,T=this;if(!i.isValid(S))throw new Error("invalid scalar: out of range");if(S===Ps||T.is0())return I.ZERO;if(S===If)return T;if(z.hasCache(this))return this.multiply(S);if(k){let{k1neg:M,k1:X,k2neg:Y,k2:F}=B(S),{p1:Z,p2:te}=bC(I,T,X,F);return C(k.beta,Z,te,M,Y)}else return z.unsafe(T,S)}toAffine(S){return H(this,S)}isTorsionFree(){let{isTorsionFree:S}=e;return s===If?!0:S?S(I,this):z.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:S}=e;return s===If?this:S?S(I,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(S=!0){return Is(S,"isCompressed"),this.assertValidity(),d(I,this,S)}toHex(S=!0){return _s(this.toBytes(S))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let W=i.BITS,z=new wf(I,e.endo?Math.ceil(W/2):W);return I.BASE.precompute(8),I}function ZC(r){return Uint8Array.of(r?2:3)}function JC(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function yz(r,e={}){let{Fn:t}=r,n=e.randomBytes||Uo,i=Object.assign(JC(r.Fp,t),{seed:Ux(t.ORDER)});function o(d){try{let m=t.fromBytes(d);return t.isValidNot0(m)}catch{return!1}}function s(d,m){let{publicKey:y,publicKeyUncompressed:w}=i;try{let x=d.length;return m===!0&&x!==y||m===!1&&x!==w?!1:!!r.fromBytes(d)}catch{return!1}}function a(d=n(i.seed)){return Fx(Re(d,i.seed,"seed"),t.ORDER)}function c(d,m=!0){return r.BASE.multiply(t.fromBytes(d)).toBytes(m)}function l(d){let{secretKey:m,publicKey:y,publicKeyUncompressed:w}=i;if(!el(d)||"_lengths"in t&&t._lengths||m===y)return;let x=Re(d,void 0,"key").length;return x===y||x===w}function u(d,m,y=!0){if(l(d)===!0)throw new Error("first arg must be private key");if(l(m)===!1)throw new Error("second arg must be public key");let w=t.fromBytes(d);return r.fromBytes(m).multiply(w).toBytes(y)}let f={isValidSecretKey:o,isValidPublicKey:s,randomSecretKey:a},h=xf(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:h,Point:r,utils:f,lengths:i})}function eT(r,e,t={}){As(e),Ho(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||Uo,i=t.hmac||((k,T)=>Ra(e,k,T)),{Fp:o,Fn:s}=r,{ORDER:a,BITS:c}=s,{keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d}=yz(r,t),m={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},y=a*YC<o.ORDER;function w(k){let T=a>>If;return k>T}function x(k,T){if(!s.isValidNot0(T))throw new Error(`invalid signature ${k}: out of range 1..Point.Fn.ORDER`);return T}function v(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function E(k,T){v7(T);let M=d.signature,X=T==="compact"?M:T==="recovered"?M+1:void 0;return Re(k,X)}class _{r;s;recovery;constructor(T,M,X){if(this.r=x("r",T),this.s=x("s",M),X!=null){if(v(),![0,1,2,3].includes(X))throw new Error("invalid recovery id");this.recovery=X}Object.freeze(this)}static fromBytes(T,M=m.format){E(T,M);let X;if(M==="der"){let{r:te,s:V}=Da.toSig(Re(T));return new _(te,V)}M==="recovered"&&(X=T[0],M="compact",T=T.subarray(1));let Y=d.signature/2,F=T.subarray(0,Y),Z=T.subarray(Y,Y*2);return new _(s.fromBytes(F),s.fromBytes(Z),X)}static fromHex(T,M){return this.fromBytes(Cs(T),M)}assertRecovery(){let{recovery:T}=this;if(T==null)throw new Error("invalid recovery id: must be present");return T}addRecoveryBit(T){return new _(this.r,this.s,T)}recoverPublicKey(T){let{r:M,s:X}=this,Y=this.assertRecovery(),F=Y===2||Y===3?M+a:M;if(!o.isValid(F))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let Z=o.toBytes(F),te=r.fromBytes(Ln(ZC((Y&1)===0),Z)),V=s.inv(F),Pe=H(Re(T,void 0,"msgHash")),Be=s.create(-Pe*V),ce=s.create(X*V),Me=r.BASE.multiplyUnsafe(Be).add(te.multiplyUnsafe(ce));if(Me.is0())throw new Error("invalid recovery: point at infinify");return Me.assertValidity(),Me}hasHighS(){return w(this.s)}toBytes(T=m.format){if(v7(T),T==="der")return Cs(Da.hexFromSig(this));let{r:M,s:X}=this,Y=s.toBytes(M),F=s.toBytes(X);return T==="recovered"?(v(),Ln(Uint8Array.of(this.assertRecovery()),Y,F)):Ln(Y,F)}toHex(T){return _s(this.toBytes(T))}}let B=t.bits2int||function(T){if(T.length>8192)throw new Error("input is too large");let M=pf(T),X=T.length*8-c;return X>0?M>>BigInt(X):M},H=t.bits2int_modN||function(T){return s.create(B(T))},U=cp(c);function C(k){return Ia("num < 2^"+c,k,Ps,U),s.toBytes(k)}function I(k,T){return Re(k,void 0,"message"),T?Re(e(k),void 0,"prehashed message"):k}function W(k,T,M){let{lowS:X,prehash:Y,extraEntropy:F}=b7(M,m);k=I(k,Y);let Z=H(k),te=s.fromBytes(T);if(!s.isValidNot0(te))throw new Error("invalid private key");let V=[C(te),C(Z)];if(F!=null&&F!==!1){let Me=F===!0?n(d.secretKey):F;V.push(Re(Me,void 0,"extraEntropy"))}let Pe=Ln(...V),Be=Z;function ce(Me){let Qe=B(Me);if(!s.isValidNot0(Qe))return;let xt=s.inv(Qe),He=r.BASE.multiply(Qe).toAffine(),rt=s.create(He.x);if(rt===Ps)return;let Ci=s.create(xt*s.create(Be+rt*te));if(Ci===Ps)return;let On=(He.x===rt?0:2)|Number(He.y&If),Wi=Ci;return X&&w(Ci)&&(Wi=s.neg(Ci),On^=1),new _(rt,Wi,y?void 0:On)}return{seed:Pe,k2sig:ce}}function z(k,T,M={}){let{seed:X,k2sig:Y}=W(k,T,M);return nC(e.outputLen,s.BYTES,i)(X,Y).toBytes(M.format)}function $(k,T,M,X={}){let{lowS:Y,prehash:F,format:Z}=b7(X,m);if(M=Re(M,void 0,"publicKey"),T=I(T,F),!el(k)){let te=k instanceof _?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+te)}E(k,Z);try{let te=_.fromBytes(k,Z),V=r.fromBytes(M);if(Y&&te.hasHighS())return!1;let{r:Pe,s:Be}=te,ce=H(T),Me=s.inv(Be),Qe=s.create(ce*Me),xt=s.create(Pe*Me),He=r.BASE.multiplyUnsafe(Qe).add(V.multiplyUnsafe(xt));return He.is0()?!1:s.create(He.x)===Pe}catch{return!1}}function S(k,T,M={}){let{prehash:X}=b7(M,m);return T=I(T,X),_.fromBytes(k,"recovered").recoverPublicKey(T).toBytes()}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:f,utils:h,lengths:d,Point:r,sign:z,verify:$,recoverPublicKey:S,Signature:_,hash:e})}var A7={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},wz={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var tT=BigInt(2);function xz(r){let e=A7.p,t=BigInt(3),n=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=Rt(u,t,e)*u%e,h=Rt(f,t,e)*u%e,d=Rt(h,tT,e)*l%e,m=Rt(d,i,e)*d%e,y=Rt(m,o,e)*m%e,w=Rt(y,a,e)*y%e,x=Rt(w,c,e)*w%e,v=Rt(x,a,e)*y%e,E=Rt(v,t,e)*u%e,_=Rt(E,s,e)*m%e,B=Rt(_,n,e)*l%e,H=Rt(B,tT,e);if(!S7.eql(S7.sqr(H),r))throw new Error("Cannot find square root");return H}var S7=gf(A7.p,{sqrt:xz}),bz=QC(A7,{Fp:S7,endo:wz}),eo=eT(bz,Pi);var rT=32;function nT(r,e,t){let n=ze.digest(e instanceof Uint8Array?e:e.subarray());if(Ef(n))return n.then(({digest:i})=>(t?.signal?.throwIfAborted(),eo.sign(i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new pp(String(i))});try{return eo.sign(n.digest,r,{prehash:!1,format:"der"})}catch(i){throw new pp(String(i))}}function iT(r,e,t,n){let i=ze.digest(t instanceof Uint8Array?t:t.subarray());if(Ef(i))return i.then(({digest:o})=>(n?.signal?.throwIfAborted(),eo.verify(e,o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new mp(String(o))});try{return n?.signal?.throwIfAborted(),eo.verify(e,i.digest,r,{prehash:!1,format:"der"})}catch(o){throw new mp(String(o))}}var Sp=class{type="secp256k1";raw;_key;constructor(e){this._key=aT(e),this.raw=oT(this._key)}toMultihash(){return or.digest(ar(this))}toCID(){return j.createV1(114,this.toMultihash())}toString(){return nt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}verify(e,t,n){return iT(this._key,t,e,n)}},Ap=class{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=sT(e),this.publicKey=new Sp(t??cT(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:me(this.raw,e.raw)}sign(e,t){return nT(this.raw,e,t)}};function _7(r){return new Ap(r)}function C7(r){return new Sp(r)}async function lT(){let r=vz();return new Ap(r)}function oT(r){return eo.Point.fromBytes(r).toBytes()}function sT(r){try{return eo.getPublicKey(r,!0),r}catch(e){throw new qh(String(e))}}function aT(r){try{return eo.Point.fromBytes(r),r}catch(e){throw new vs(String(e))}}function cT(r){try{return eo.getPublicKey(r,!0)}catch(e){throw new qh(String(e))}}function vz(){return eo.utils.randomSecretKey()}async function Oa(r,e){if(r==="Ed25519")return NC();if(r==="secp256k1")return lT();if(r==="RSA")return x7(Ez(e));if(r==="ECDSA")return $_(Sz(e));throw new Yi}function er(r,e){let{Type:t,Data:n}=Vo.decode(r),i=n??new Uint8Array;switch(t){case Ct.RSA:return g7(i,e);case Ct.Ed25519:return jx(i);case Ct.secp256k1:return C7(i);case Ct.ECDSA:return Sx(i);default:throw new Yi}}function qg(r){let{Type:e,Data:t}=Vo.decode(r.digest),n=t??new Uint8Array;switch(e){case Ct.Ed25519:return jx(n);case Ct.secp256k1:return C7(n);case Ct.ECDSA:return Sx(n);default:throw new Yi}}function ar(r){return Vo.encode({Type:Ct[r.type],Data:r.raw})}function uT(r){let e=bp.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Ct.RSA:return m7(t);case Ct.Ed25519:return qx(t);case Ct.secp256k1:return _7(t);case Ct.ECDSA:return L_(t);default:throw new Yi}}function fT(r){if(r.byteLength===ii)return qx(r);if(r.byteLength===rT)return _7(r);let e=ki(r),t=e[2]?.[0];if(t===C_||t===T_||t===I_)return Ex(e);if(e.length>8)return Vg(e);throw new O("Could not extract private key from raw bytes")}function dl(r){return bp.encode({Type:Ct[r.type],Data:r.raw})}function Ez(r){return r==null?2048:parseInt(r,10)}function Sz(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new O("Unsupported curve, should be P-256, P-384 or P-521")}async function jg(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new O("Only RSA and ECDSA keys are supported")}function Az(r,e){if(typeof r=="string")return _z(r);if(typeof r=="number")return Iz(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var Wg=Az;function _z(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,i=parseFloat(t),o=n.toLowerCase();switch(o){case"years":case"year":case"yrs":case"yr":case"y":return i*315576e5;case"months":case"month":case"mo":return i*26298e5;case"weeks":case"week":case"w":return i*6048e5;case"days":case"day":case"d":return i*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return i*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return i*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return i*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:throw Error(`Unknown unit "${o}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function Cz(r){let e=Math.abs(r);return e>=315576e5?`${Math.round(r/315576e5)}y`:e>=26298e5?`${Math.round(r/26298e5)}mo`:e>=6048e5?`${Math.round(r/6048e5)}w`:e>=864e5?`${Math.round(r/864e5)}d`:e>=36e5?`${Math.round(r/36e5)}h`:e>=6e4?`${Math.round(r/6e4)}m`:e>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function Tz(r){let e=Math.abs(r);return e>=315576e5?hl(r,e,315576e5,"year"):e>=26298e5?hl(r,e,26298e5,"month"):e>=6048e5?hl(r,e,6048e5,"week"):e>=864e5?hl(r,e,864e5,"day"):e>=36e5?hl(r,e,36e5,"hour"):e>=6e4?hl(r,e,6e4,"minute"):e>=1e3?hl(r,e,1e3,"second"):`${r} ms`}function Iz(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?Tz(r):Cz(r)}function hl(r,e,t,n){let i=e>=t*1.5;return`${Math.round(r/t)} ${n}${i?"s":""}`}function T7(r){t.debug=t,t.default=t,t.coerce=c,t.disable=o,t.enable=i,t.enabled=s,t.humanize=Wg,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u,f){let h,d=null,m,y;function w(...x){if(!w.enabled)return;let v=w,E=Number(new Date),_=E-(h||E);v.diff=_,v.prev=h,v.curr=E,h=E,x[0]=t.coerce(x[0]),typeof x[0]!="string"&&x.unshift("%O");let B=0;x[0]=x[0].replace(/%([a-zA-Z%])/g,(U,C)=>{if(U==="%%")return"%";B++;let I=t.formatters[C];if(typeof I=="function"){let W=x[B];U=I.call(v,W),x.splice(B,1),B--}return U}),t.formatArgs.call(v,x),f?.onLog!=null&&f.onLog(...x),(v.log||t.log).apply(v,x)}return w.namespace=u,w.useColors=t.useColors(),w.color=t.selectColor(u),w.extend=n,w.destroy=t.destroy,Object.defineProperty(w,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(m!==t.namespaces&&(m=t.namespaces,y=t.enabled(u)),y),set:x=>{d=x}}),typeof t.init=="function"&&t.init(w),w}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function o(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function s(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var Gg=Lz(),kz=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Pz(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function Rz(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Wg(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}var Dz=console.debug??console.log??(()=>{});function Oz(r){try{r?Gg?.setItem("debug",r):Gg?.removeItem("debug")}catch{}}function Nz(){let r;try{r=Gg?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function Lz(){try{return localStorage}catch{}}function Bz(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var dT=T7({formatArgs:Rz,save:Oz,load:Nz,useColors:Pz,setupFormatters:Bz,colors:kz,storage:Gg,log:Dz});var Bn=dT;Bn.formatters.b=r=>r==null?"undefined":nt.baseEncode(r);Bn.formatters.t=r=>r==null?"undefined":Tr.baseEncode(r);Bn.formatters.m=r=>r==null?"undefined":sr.baseEncode(r);Bn.formatters.p=r=>r==null?"undefined":r.toString();Bn.formatters.c=r=>r==null?"undefined":r.toString();Bn.formatters.k=r=>r==null?"undefined":r.toString();Bn.formatters.a=r=>r==null?"undefined":r.toString();function I7(r){let e=hT(r.message),t=hT(r.stack);return e!=null&&t!=null?t.includes(e)?t:`${e}
${t}`:t??e??r.toString()}function Mz(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}Bn.formatters.e=r=>{if(r==null)return"undefined";if(Mz(r)){let e="      ",t=I7(r);return r.errors.length>0?t+=`
${e}${r.errors.map(n=>`  ${I7(n).split(`
`).join(`
${e}`)}`).join(`
${e}`)}`:t+=`
${e}[Error list was empty]`,t.trim()}return I7(r)};function Uz(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Na(r){return{forComponent(e){return Ze(e,r)}}}function Ze(r,e){let t=Uz(`${r}:trace`);return Bn.enabled(`${r}:trace`)&&Bn.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=Bn(`${r}:trace`,e)),Object.assign(Bn(r,e),{error:Bn(`${r}:error`,e),trace:t,newScope:n=>Ze(`${r}:${n}`,e)})}function hT(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}var EI=bt(Xg(),1);var Yg=class extends Error{static name="SignatureCreationError";constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}},to=class extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}},Qg=class extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}},pl=class extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}},Zg=class extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}},_p=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},Jg=class extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}},Cp=class extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}};var Fr;(function(r){let e;(function(i){i.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(i){i[i.EOL=0]="EOL"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.value!=null&&(o.uint32(10),o.bytes(i.value)),i.signatureV1!=null&&(o.uint32(18),o.bytes(i.signatureV1)),i.validityType!=null&&(o.uint32(24),r.ValidityType.codec().encode(i.validityType,o)),i.validity!=null&&(o.uint32(34),o.bytes(i.validity)),i.sequence!=null&&(o.uint32(40),o.uint64(i.sequence)),i.ttl!=null&&(o.uint32(48),o.uint64(i.ttl)),i.pubKey!=null&&(o.uint32(58),o.bytes(i.pubKey)),i.signatureV2!=null&&(o.uint32(66),o.bytes(i.signatureV2)),i.data!=null&&(o.uint32(74),o.bytes(i.data)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.value=i.bytes();break}case 2:{a.signatureV1=i.bytes();break}case 3:{a.validityType=r.ValidityType.codec().decode(i);break}case 4:{a.validity=i.bytes();break}case 5:{a.sequence=i.uint64();break}case 6:{a.ttl=i.uint64();break}case 7:{a.pubKey=i.bytes();break}case 8:{a.signatureV2=i.bytes();break}case 9:{a.data=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(Fr||(Fr={}));var Fz=["string","number","bigint","symbol"],$z=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function pT(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(Fz.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(Hz(r))return"Buffer";let t=Vz(r);return t||"Object"}function Hz(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function Vz(r){let e=Object.prototype.toString.call(r).slice(8,-1);if($z.includes(e))return e}var A=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};A.uint=new A(0,"uint",!0);A.negint=new A(1,"negint",!0);A.bytes=new A(2,"bytes",!0);A.string=new A(3,"string",!0);A.array=new A(4,"array",!1);A.map=new A(5,"map",!1);A.tag=new A(6,"tag",!1);A.float=new A(7,"float",!0);A.false=new A(7,"false",!0);A.true=new A(7,"true",!0);A.null=new A(7,"null",!0);A.undefined=new A(7,"undefined",!0);A.break=new A(7,"break",!0);var Q=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var kf=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",zz=new TextDecoder,Kz=new TextEncoder;function e2(r){return kf&&globalThis.Buffer.isBuffer(r)}function Tp(r){return r instanceof Uint8Array?e2(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var wT=kf?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):gT(r,e,t):(r,e,t)=>t-e>64?zz.decode(r.subarray(e,t)):gT(r,e,t),t2=kf?r=>r.length>64?globalThis.Buffer.from(r):mT(r):r=>r.length>64?Kz.encode(r):mT(r),zo=r=>Uint8Array.from(r),Pf=kf?(r,e,t)=>e2(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),xT=kf?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Tp(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},bT=kf?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function vT(r,e){if(e2(r)&&e2(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function mT(r){let e=[],t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function gT(r,e,t){let n=[];for(;e<t;){let i=r[e],o=null,s=i>239?4:i>223?3:i>191?2:1;if(e+s<=t){let a,c,l,u;switch(s){case 1:i<128&&(o=i);break;case 2:a=r[e+1],(a&192)===128&&(u=(i&31)<<6|a&63,u>127&&(o=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(i&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(o=u))}}o===null?(o=65533,s=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|o&1023),n.push(o),e+=s}return P7(n)}var yT=4096;function P7(r){let e=r.length;if(e<=yT)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=yT));return t}var qz=256,Ip=class{constructor(e=qz){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){let i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=bT(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Pf(n,0,this.cursor)}else t=xT(this.chunks,this.cursor);return e&&this.reset(),t}};var ge="CBOR decode error:",Rs="CBOR encode error:",kp=[];kp[23]=1;kp[24]=2;kp[25]=3;kp[26]=5;kp[27]=9;function Ds(r,e,t){if(r.length-e<t)throw new Error(`${ge} not enough data for type`)}var Pr=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ai(r,e,t){Ds(r,e,1);let n=r[e];if(t.strict===!0&&n<Pr[0])throw new Error(`${ge} integer encoded in more bytes than necessary (strict decode)`);return n}function ci(r,e,t){Ds(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Pr[1])throw new Error(`${ge} integer encoded in more bytes than necessary (strict decode)`);return n}function li(r,e,t){Ds(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Pr[2])throw new Error(`${ge} integer encoded in more bytes than necessary (strict decode)`);return n}function ui(r,e,t){Ds(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],o=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&o<Pr[3])throw new Error(`${ge} integer encoded in more bytes than necessary (strict decode)`);if(o<=Number.MAX_SAFE_INTEGER)return Number(o);if(t.allowBigInt===!0)return o;throw new Error(`${ge} integers outside of the safe integer range are not supported`)}function ET(r,e,t,n){return new Q(A.uint,ai(r,e+1,n),2)}function ST(r,e,t,n){return new Q(A.uint,ci(r,e+1,n),3)}function AT(r,e,t,n){return new Q(A.uint,li(r,e+1,n),5)}function _T(r,e,t,n){return new Q(A.uint,ui(r,e+1,n),9)}function Ri(r,e){return $r(r,0,e.value)}function $r(r,e,t){if(t<Pr[0]){let n=Number(t);r.push([e|n])}else if(t<Pr[1]){let n=Number(t);r.push([e|24,n])}else if(t<Pr[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Pr[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<Pr[4]){let i=[e|27,0,0,0,0,0,0,0],o=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=o&255,o=o>>8,i[7]=o&255,o=o>>8,i[6]=o&255,o=o>>8,i[5]=o&255,i[4]=s&255,s=s>>8,i[3]=s&255,s=s>>8,i[2]=s&255,s=s>>8,i[1]=s&255,r.push(i)}else throw new Error(`${ge} encountered BigInt larger than allowable range`)}}Ri.encodedSize=function(e){return $r.encodedSize(e.value)};$r.encodedSize=function(e){return e<Pr[0]?1:e<Pr[1]?2:e<Pr[2]?3:e<Pr[3]?5:9};Ri.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function CT(r,e,t,n){return new Q(A.negint,-1-ai(r,e+1,n),2)}function TT(r,e,t,n){return new Q(A.negint,-1-ci(r,e+1,n),3)}function IT(r,e,t,n){return new Q(A.negint,-1-li(r,e+1,n),5)}var R7=BigInt(-1),kT=BigInt(1);function PT(r,e,t,n){let i=ui(r,e+1,n);if(typeof i!="bigint"){let o=-1-i;if(o>=Number.MIN_SAFE_INTEGER)return new Q(A.negint,o,9)}if(n.allowBigInt!==!0)throw new Error(`${ge} integers outside of the safe integer range are not supported`);return new Q(A.negint,R7-BigInt(i),9)}function r2(r,e){let t=e.value,n=typeof t=="bigint"?t*R7-kT:t*-1-1;$r(r,e.type.majorEncoded,n)}r2.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*R7-kT:t*-1-1;return n<Pr[0]?1:n<Pr[1]?2:n<Pr[2]?3:n<Pr[3]?5:9};r2.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Pp(r,e,t,n){Ds(r,e,t+n);let i=Pf(r,e+t,e+t+n);return new Q(A.bytes,i,t+n)}function RT(r,e,t,n){return Pp(r,e,1,t)}function DT(r,e,t,n){return Pp(r,e,2,ai(r,e+1,n))}function OT(r,e,t,n){return Pp(r,e,3,ci(r,e+1,n))}function NT(r,e,t,n){return Pp(r,e,5,li(r,e+1,n))}function LT(r,e,t,n){let i=ui(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ge} 64-bit integer bytes lengths not supported`);return Pp(r,e,9,i)}function n2(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===A.string?t2(r.value):r.value),r.encodedBytes}function Rf(r,e){let t=n2(e);$r(r,e.type.majorEncoded,t.length),r.push(t)}Rf.encodedSize=function(e){let t=n2(e);return $r.encodedSize(t.length)+t.length};Rf.compareTokens=function(e,t){return Wz(n2(e),n2(t))};function Wz(r,e){return r.length<e.length?-1:r.length>e.length?1:vT(r,e)}function Rp(r,e,t,n,i){let o=t+n;Ds(r,e,o);let s=new Q(A.string,wT(r,e+t,e+o),o);return i.retainStringBytes===!0&&(s.byteValue=Pf(r,e+t,e+o)),s}function BT(r,e,t,n){return Rp(r,e,1,t,n)}function MT(r,e,t,n){return Rp(r,e,2,ai(r,e+1,n),n)}function UT(r,e,t,n){return Rp(r,e,3,ci(r,e+1,n),n)}function FT(r,e,t,n){return Rp(r,e,5,li(r,e+1,n),n)}function $T(r,e,t,n){let i=ui(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ge} 64-bit integer string lengths not supported`);return Rp(r,e,9,i,n)}var HT=Rf;function Df(r,e,t,n){return new Q(A.array,n,t)}function VT(r,e,t,n){return Df(r,e,1,t)}function zT(r,e,t,n){return Df(r,e,2,ai(r,e+1,n))}function KT(r,e,t,n){return Df(r,e,3,ci(r,e+1,n))}function qT(r,e,t,n){return Df(r,e,5,li(r,e+1,n))}function jT(r,e,t,n){let i=ui(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ge} 64-bit integer array lengths not supported`);return Df(r,e,9,i)}function WT(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ge} indefinite length items not allowed`);return Df(r,e,1,1/0)}function i2(r,e){$r(r,A.array.majorEncoded,e.value)}i2.compareTokens=Ri.compareTokens;i2.encodedSize=function(e){return $r.encodedSize(e.value)};function Of(r,e,t,n){return new Q(A.map,n,t)}function GT(r,e,t,n){return Of(r,e,1,t)}function XT(r,e,t,n){return Of(r,e,2,ai(r,e+1,n))}function YT(r,e,t,n){return Of(r,e,3,ci(r,e+1,n))}function QT(r,e,t,n){return Of(r,e,5,li(r,e+1,n))}function ZT(r,e,t,n){let i=ui(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ge} 64-bit integer map lengths not supported`);return Of(r,e,9,i)}function JT(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ge} indefinite length items not allowed`);return Of(r,e,1,1/0)}function o2(r,e){$r(r,A.map.majorEncoded,e.value)}o2.compareTokens=Ri.compareTokens;o2.encodedSize=function(e){return $r.encodedSize(e.value)};function eI(r,e,t,n){return new Q(A.tag,t,1)}function tI(r,e,t,n){return new Q(A.tag,ai(r,e+1,n),2)}function rI(r,e,t,n){return new Q(A.tag,ci(r,e+1,n),3)}function nI(r,e,t,n){return new Q(A.tag,li(r,e+1,n),5)}function iI(r,e,t,n){return new Q(A.tag,ui(r,e+1,n),9)}function s2(r,e){$r(r,A.tag.majorEncoded,e.value)}s2.compareTokens=Ri.compareTokens;s2.encodedSize=function(e){return $r.encodedSize(e.value)};var Jz=20,eK=21,tK=22,rK=23;function oI(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ge} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new Q(A.null,null,1):new Q(A.undefined,void 0,1)}function sI(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ge} indefinite length items not allowed`);return new Q(A.break,void 0,1)}function D7(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ge} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ge} Infinity values are not supported`)}return new Q(A.float,r,e)}function aI(r,e,t,n){return D7(O7(r,e+1),3,n)}function cI(r,e,t,n){return D7(N7(r,e+1),5,n)}function lI(r,e,t,n){return D7(hI(r,e+1),9,n)}function a2(r,e,t){let n=e.value;if(n===!1)r.push([A.float.majorEncoded|Jz]);else if(n===!0)r.push([A.float.majorEncoded|eK]);else if(n===null)r.push([A.float.majorEncoded|tK]);else if(n===void 0)r.push([A.float.majorEncoded|rK]);else{let i,o=!1;(!t||t.float64!==!0)&&(fI(n),i=O7(ro,1),n===i||Number.isNaN(n)?(ro[0]=249,r.push(ro.slice(0,3)),o=!0):(dI(n),i=N7(ro,1),n===i&&(ro[0]=250,r.push(ro.slice(0,5)),o=!0))),o||(nK(n),i=hI(ro,1),ro[0]=251,r.push(ro.slice(0,9)))}}a2.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){fI(n);let i=O7(ro,1);if(n===i||Number.isNaN(n))return 3;if(dI(n),i=N7(ro,1),n===i)return 5}return 9};var uI=new ArrayBuffer(9),Di=new DataView(uI,1),ro=new Uint8Array(uI,0);function fI(r){if(r===1/0)Di.setUint16(0,31744,!1);else if(r===-1/0)Di.setUint16(0,64512,!1);else if(Number.isNaN(r))Di.setUint16(0,32256,!1);else{Di.setFloat32(0,r);let e=Di.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Di.setUint16(0,31744,!1);else if(t===0)Di.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let i=t-127;i<-24?Di.setUint16(0,0):i<-14?Di.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):Di.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function O7(r,e){if(r.length-e<2)throw new Error(`${ge} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,i=t&1023,o;return n===0?o=i*2**-24:n!==31?o=(i+1024)*2**(n-25):o=i===0?1/0:NaN,t&32768?-o:o}function dI(r){Di.setFloat32(0,r,!1)}function N7(r,e){if(r.length-e<4)throw new Error(`${ge} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function nK(r){Di.setFloat64(0,r,!1)}function hI(r,e){if(r.length-e<8)throw new Error(`${ge} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}a2.compareTokens=Ri.compareTokens;function ot(r,e,t){throw new Error(`${ge} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function c2(r){return()=>{throw new Error(`${ge} ${r}`)}}var ie=[];for(let r=0;r<=23;r++)ie[r]=ot;ie[24]=ET;ie[25]=ST;ie[26]=AT;ie[27]=_T;ie[28]=ot;ie[29]=ot;ie[30]=ot;ie[31]=ot;for(let r=32;r<=55;r++)ie[r]=ot;ie[56]=CT;ie[57]=TT;ie[58]=IT;ie[59]=PT;ie[60]=ot;ie[61]=ot;ie[62]=ot;ie[63]=ot;for(let r=64;r<=87;r++)ie[r]=RT;ie[88]=DT;ie[89]=OT;ie[90]=NT;ie[91]=LT;ie[92]=ot;ie[93]=ot;ie[94]=ot;ie[95]=c2("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ie[r]=BT;ie[120]=MT;ie[121]=UT;ie[122]=FT;ie[123]=$T;ie[124]=ot;ie[125]=ot;ie[126]=ot;ie[127]=c2("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ie[r]=VT;ie[152]=zT;ie[153]=KT;ie[154]=qT;ie[155]=jT;ie[156]=ot;ie[157]=ot;ie[158]=ot;ie[159]=WT;for(let r=160;r<=183;r++)ie[r]=GT;ie[184]=XT;ie[185]=YT;ie[186]=QT;ie[187]=ZT;ie[188]=ot;ie[189]=ot;ie[190]=ot;ie[191]=JT;for(let r=192;r<=215;r++)ie[r]=eI;ie[216]=tI;ie[217]=rI;ie[218]=nI;ie[219]=iI;ie[220]=ot;ie[221]=ot;ie[222]=ot;ie[223]=ot;for(let r=224;r<=243;r++)ie[r]=c2("simple values are not supported");ie[244]=ot;ie[245]=ot;ie[246]=ot;ie[247]=oI;ie[248]=c2("simple values are not supported");ie[249]=aI;ie[250]=cI;ie[251]=lI;ie[252]=ot;ie[253]=ot;ie[254]=ot;ie[255]=sI;var no=[];for(let r=0;r<24;r++)no[r]=new Q(A.uint,r,1);for(let r=-1;r>=-24;r--)no[31-r]=new Q(A.negint,r,1);no[64]=new Q(A.bytes,new Uint8Array(0),1);no[96]=new Q(A.string,"",1);no[128]=new Q(A.array,0,1);no[160]=new Q(A.map,0,1);no[244]=new Q(A.false,!1,1);no[245]=new Q(A.true,!0,1);no[246]=new Q(A.null,null,1);function L7(r){switch(r.type){case A.false:return zo([244]);case A.true:return zo([245]);case A.null:return zo([246]);case A.bytes:return r.value.length?void 0:zo([64]);case A.string:return r.value===""?zo([96]):void 0;case A.array:return r.value===0?zo([128]):void 0;case A.map:return r.value===0?zo([160]):void 0;case A.uint:return r.value<24?zo([Number(r.value)]):void 0;case A.negint:if(r.value>=-24)return zo([31-Number(r.value)])}}var oK={float64:!1,mapSorter:aK,quickEncodeToken:L7};function M7(){let r=[];return r[A.uint.major]=Ri,r[A.negint.major]=r2,r[A.bytes.major]=Rf,r[A.string.major]=HT,r[A.array.major]=i2,r[A.map.major]=o2,r[A.tag.major]=s2,r[A.float.major]=a2,r}var pI=M7(),B7=new Ip,l2=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Rs} object contains circular references`);return new r(t,e)}},La={null:new Q(A.null,null),undefined:new Q(A.undefined,void 0),true:new Q(A.true,!0),false:new Q(A.false,!1),emptyArray:new Q(A.array,0),emptyMap:new Q(A.map,0)},Ba={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new Q(A.float,r):r>=0?new Q(A.uint,r):new Q(A.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new Q(A.uint,r):new Q(A.negint,r)},Uint8Array(r,e,t,n){return new Q(A.bytes,r)},string(r,e,t,n){return new Q(A.string,r)},boolean(r,e,t,n){return r?La.true:La.false},null(r,e,t,n){return La.null},undefined(r,e,t,n){return La.undefined},ArrayBuffer(r,e,t,n){return new Q(A.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new Q(A.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[La.emptyArray,new Q(A.break)]:La.emptyArray;n=l2.createCheck(n,r);let i=[],o=0;for(let s of r)i[o++]=Dp(s,t,n);return t.addBreakTokens?[new Q(A.array,r.length),i,new Q(A.break)]:[new Q(A.array,r.length),i]},Object(r,e,t,n){let i=e!=="Object",o=i?r.keys():Object.keys(r),s=i?r.size:o.length;if(!s)return t.addBreakTokens===!0?[La.emptyMap,new Q(A.break)]:La.emptyMap;n=l2.createCheck(n,r);let a=[],c=0;for(let l of o)a[c++]=[Dp(l,t,n),Dp(i?r.get(l):r[l],t,n)];return sK(a,t),t.addBreakTokens?[new Q(A.map,s),a,new Q(A.break)]:[new Q(A.map,s),a]}};Ba.Map=Ba.Object;Ba.Buffer=Ba.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Ba[`${r}Array`]=Ba.DataView;function Dp(r,e={},t){let n=pT(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||Ba[n];if(typeof i=="function"){let s=i(r,n,e,t);if(s!=null)return s}let o=Ba[n];if(!o)throw new Error(`${Rs} unsupported type: ${n}`);return o(r,n,e,t)}function sK(r,e){e.mapSorter&&r.sort(e.mapSorter)}function aK(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let i=t.type.major,o=pI[i].compareTokens(t,n);return o===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),o}function mI(r,e,t,n){if(Array.isArray(e))for(let i of e)mI(r,i,t,n);else t[e.type.major](r,e,n)}function U7(r,e,t){let n=Dp(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let i=t.quickEncodeToken(n);if(i)return i;let o=e[n.type.major];if(o.encodedSize){let s=o.encodedSize(n,t),a=new Ip(s);if(o(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Tp(a.chunks[0])}}return B7.reset(),mI(B7,n,e,t),B7.toBytes(!0)}function Os(r,e){return e=Object.assign({},oK,e),U7(r,pI,e)}var cK={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},u2=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=no[e];if(t===void 0){let n=ie[e];if(!n)throw new Error(`${ge} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}},Op=Symbol.for("DONE"),f2=Symbol.for("BREAK");function lK(r,e,t){let n=[];for(let i=0;i<r.value;i++){let o=Nf(e,t);if(o===f2){if(r.value===1/0)break;throw new Error(`${ge} got unexpected break to lengthed array`)}if(o===Op)throw new Error(`${ge} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=o}return n}function uK(r,e,t){let n=t.useMaps===!0,i=n?void 0:{},o=n?new Map:void 0;for(let s=0;s<r.value;s++){let a=Nf(e,t);if(a===f2){if(r.value===1/0)break;throw new Error(`${ge} got unexpected break to lengthed map`)}if(a===Op)throw new Error(`${ge} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ge} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&o.has(a)||!n&&a in i))throw new Error(`${ge} found repeat map key "${a}"`);let c=Nf(e,t);if(c===Op)throw new Error(`${ge} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?o.set(a,c):i[a]=c}return n?o:i}function Nf(r,e){if(r.done())return Op;let t=r.next();if(t.type===A.break)return f2;if(t.type.terminal)return t.value;if(t.type===A.array)return lK(t,r,e);if(t.type===A.map)return uK(t,r,e);if(t.type===A.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Nf(r,e);return e.tags[t.value](n)}throw new Error(`${ge} tag not supported (${t.value})`)}throw new Error("unsupported")}function F7(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ge} data to decode must be a Uint8Array`);e=Object.assign({},cK,e);let t=e.tokenizer||new u2(r,e),n=Nf(t,e);if(n===Op)throw new Error(`${ge} did not find any content to decode`);if(n===f2)throw new Error(`${ge} got unexpected break`);return[n,r.subarray(t.pos())]}function xn(r,e){let[t,n]=F7(r,e);if(n.length>0)throw new Error(`${ge} too many terminals, data makes no sense`);return t}var fK=Ze("ipns:utils"),gI=R("/ipns/"),dK=114,hK=0,pK=18;function yI(r){let e;if(r.pubKey!=null)try{e=er(r.pubKey)}catch(t){throw fK.error(t),t}if(e!=null)return e}function wI(r,e,t){let n=R(e);return it([r,t,n])}function h2(r){let e=R("ipns-signature:");return it([e,r])}function io(r){return"signatureV1"in r?Fr.encode({value:R(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:R(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):Fr.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function Hr(r){let e=Fr.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new to("Missing data or signatureV2");let t=bI(e.data),n=mK(t.Value),i=K(t.Validity);if(e.value!=null&&e.signatureV1!=null)return gK(e),{value:n,validityType:Fr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Fr.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function Ko(r){return it([gI,r.bytes])}function Lf(r){let e=Xe(r.slice(gI.length));if(!d2(e,hK)&&!d2(e,pK))throw new xa("Multihash in IPNS key was not identity or sha2-256");return e}function xI(r,e,t,n,i){let o;if(e===Fr.ValidityType.EOL)o=0;else throw new pl("The validity type is unsupported");return Os({Value:r,Validity:t,ValidityType:o,Sequence:n,TTL:i})}function bI(r){let e=xn(r);if(e.ValidityType===0)e.ValidityType=Fr.ValidityType.EOL;else throw new pl("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function mK(r){let e=K(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${j.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${j.parse(e).toV1().toString()}`}catch{}throw new _p("Value must be a valid content path starting with /")}function vI(r){if(r!=null){let e=xK(r);if(e!=null)return e.code===dK?`/ipns/${e.toString(Mr)}`:`/ipfs/${e.toV1().toString()}`;if(yK(r))return`/ipns/${Mr.encode(r.bytes)}`;let t=r.toString().trim();if(t.startsWith("/")&&t.length>1)return t}throw new _p("Value must be a valid content path starting with /")}function gK(r){if(r.data==null)throw new Jg("Record data is missing");let e=bI(r.data);if(!me(e.Value,r.value??new Uint8Array(0)))throw new to('Field "value" did not match between protobuf and CBOR');if(!me(e.Validity,r.validity??new Uint8Array(0)))throw new to('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new to('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new to('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new to('Field "ttl" did not match between protobuf and CBOR')}function yK(r){return r.bytes instanceof Uint8Array}function wK(r){return typeof r?.toCID=="function"}function xK(r){if(wK(r))return r.toCID();try{return j.parse(r)}catch{}return j.asCID(r)}function d2(r,e){return r.code===e}var p2=Ze("ipns:validator"),bK=1024*10;async function vK(r,e){let t=Hr(e),n;try{let i=h2(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw p2.error("record signature verification failed"),new to("Record signature verification failed");if(t.validityType===Fr.ValidityType.EOL){if(EI.default.fromString(t.validity).toDate().getTime()<Date.now())throw p2.error("record has expired"),new Qg("record has expired")}else if(t.validityType!=null)throw p2.error("the validity type is unsupported"),new pl("The validity type is unsupported");p2("ipns record for %s is valid",t.value)}async function gl(r,e){if(e.byteLength>bK)throw new Zg("The record is too large");let t=Lf(r),n;d2(t,0)&&(n=qg(t));let i=Hr(e),o=yI(i)??n;if(o==null)throw new Cp("Could not extract public key from IPNS record or routing key");let s=Ko(o.toMultihash());if(!me(s,r))throw new Cp("Embedded public key did not match routing key");await vK(o,e)}var SI=bt(Xg(),1);var EK=Ze("ipns"),AI=300*1e9,SK="/ipns/",Dle=SK.length,_I={v1Compatible:!0,ttlNs:AI};async function m2(r,e,t,n,i=_I){let o=new SI.default(Date.now()+Number(n)),s=Fr.ValidityType.EOL,a=BigInt(i.ttlNs??AI);return AK(r,e,t,s,o.toString(),a,i)}var AK=async(r,e,t,n,i,o,s=_I)=>{t=BigInt(t);let a=R(i),c=vI(e),l=R(c),u=xI(l,n,a,t,o),f=h2(u),h=await r.sign(f),d;if(r.type==="RSA"&&(d=ar(r.publicKey)),s.v1Compatible===!0){let m=await _K(r,l,n,a),y={value:c,signatureV1:m,validity:i,validityType:n,sequence:t,ttl:o,signatureV2:h,data:u};return d!=null&&(y.pubKey=d),y}else{let m={value:c,validity:i,validityType:n,sequence:t,ttl:o,signatureV2:h,data:u};return d!=null&&(m.pubKey=d),m}},_K=async(r,e,t,n)=>{try{let i=wI(e,t,n);return await r.sign(i)}catch(i){throw EK.error("record signature creation failed",i),new Yg("Record signature creation failed")}};var H7=bt(Xg(),1);function g2(r,e){let t=e.map((n,i)=>({record:Hr(n),index:i}));return t.sort((n,i)=>{let o=n.record.sequence,s=i.record.sequence;if(o>s)return-1;if(o<s)return 1;if(n.record.validityType===Fr.ValidityType.EOL&&i.record.validityType===Fr.ValidityType.EOL){let a=H7.default.fromString(n.record.validity).toDate(),c=H7.default.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}var Bf=BigInt(6e4)*5000000n,CI=5;var y2=class extends Error{static name="RecordsFailedValidationError";constructor(e="Records failed validation"){super(e),this.name="RecordsFailedValidationError"}},w2=class extends Error{static name="UnsupportedMultibasePrefixError";constructor(e="Unsupported multibase prefix"){super(e),this.name="UnsupportedMultibasePrefixError"}},x2=class extends Error{static name="UnsupportedMultihashCodecError";constructor(e="Unsupported multihash codec"){super(e),this.name="UnsupportedMultihashCodecError"}},b2=class extends Error{static name="InvalidValueError";constructor(e="Invalid value"){super(e),this.name="InvalidValueError"}};var Ns="/",TI=new TextEncoder().encode(Ns),v2=TI[0],lt=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=R(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==v2)throw new Error("Invalid key")}toString(e="utf8"){return K(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Ns))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=TI),this._buf[0]!==v2){let e=new Uint8Array(this._buf.byteLength+1);e.fill(v2,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===v2;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;let o=t[i],s=n[i];if(o<s)return!0;if(o>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ns).slice(1)}type(){return CK(this.baseNamespace())}name(){return TK(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ns)||(e+=Ns),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Ns):new r(e.slice(0,-1).join(Ns))}child(e){return this.toString()===Ns?e:e.toString()===Ns?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...IK(e.map(t=>t.namespaces()))])}};function CK(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function TK(r){let e=r.split(":");return e[e.length-1]}function IK(r){return[].concat(...r)}var PK=114,V7=0,z7=18;function K7(r,e){return r.code===e}var E2="/dht/record/",RK="/ipns/metadata/";function Np(r){return new lt(E2+K(r,"base32"),!1)}function S2(r){return new lt(RK+K(r,"base32"),!1)}function II(r,e){let t=Date.now(),n=e.getTime()+1728e5,i=new Date(r.validity).getTime();return n-t<864e5||i-t<864e5}function DK(r){return r?.asCID===r}function kI(r){if(!DK(r))return!1;if(r.code!==PK)throw new O(`CID codec ${r.code} was not libp2p-key`);if(r.multihash.code!==V7&&r.multihash.code!==z7)throw new O(`Multihash algorithm codec ${r.multihash.code} was not Identity or SHA256 hash`);return!0}var PI={[Mr.prefix]:Mr,[nt.prefix]:nt},Mf=class{routers;localStore;log;constructor(e,t){this.log=e.logger.forComponent("helia:ipns"),this.localStore=t.localStore,this.routers=t.routers}async resolve(e,t={}){let n=i_(e)||_r(e)?e.toMultihash():kI(e)?e.multihash:e,i=Ko(n),o=await this.#t(i,t);return{...await this.#e(o.value,t),record:o}}async#e(e,t={}){let n=e.split("/");try{let i=n[1];if(i==="ipns"){let o=n[2],s=o.substring(0,1),a;if(s==="1"||s==="Q")a=nt.decode(`z${o}`);else if(PI[s]!=null)a=PI[s].decode(o);else throw new w2(`Unsupported multibase prefix "${s}"`);let c;try{c=Xe(a)}catch{c=j.decode(a).multihash}if(!K7(c,V7)&&!K7(c,z7))throw new x2(`Unsupported multihash codec "${c.code}"`);let{cid:l}=await this.resolve(c,t),u=n.slice(3).join("/");return{cid:l,path:u===""?void 0:u}}else if(i==="ipfs"){let o=j.parse(n[2]),s=n.slice(3).join("/");return{cid:o,path:s===""?void 0:s}}}catch(i){this.log.error("error parsing ipfs path - %e",i)}throw this.log.error("invalid ipfs path %s",e),new b2("Invalid value")}async#t(e,t={}){let n=[];if(await this.localStore.has(e,t))if(this.log("record is present in the cache"),t.nocache!==!0)try{let{record:a,created:c}=await this.localStore.get(e,t);this.log("record retrieved from cache"),await gl(e,a),this.log("record was valid");let l=Hr(a),u=Number((l.ttl??Bf)/1000000n);if(c.getTime()+u>Date.now())return this.log("record TTL was valid"),l;if(t.offline===!0)return this.log("record TTL has been reached but we are resolving offline-only, returning record"),l;this.log("record TTL has been reached, searching routing for updates"),n.push(a)}catch(a){this.log("cached record was invalid - %e",a),await this.localStore.delete(e,t)}else this.log("ignoring local cache due to nocache=true option");if(t.offline===!0)throw new je("Record was not present in the cache or has expired");this.log("did not have record locally");let o=0;if(await Promise.all(this.routers.map(async a=>{let c;try{c=await a.get(e,{...t,validate:!1})}catch(l){this.log.error("error finding IPNS record - %e",l);return}try{await gl(e,c),n.push(c)}catch(l){o++,this.log.error("error finding IPNS record - %e",l)}})),n.length===0)throw o>0?new y2(`${o>1?`${o} records`:"Record"} found for routing key ${o>1?"were":"was"} invalid`):new je("Could not find record for routing key");let s=n[g2(e,n)];return await this.localStore.put(e,s,t),Hr(s)}};var G=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var A2=class{routers;localStore;keychain;constructor(e,t){this.keychain=e.libp2p.services.keychain,this.localStore=t.localStore,this.routers=t.routers}async publish(e,t,n={}){try{let i=await this.#e(e),o=1n,s=Ko(i.publicKey.toMultihash());if(await this.localStore.has(s,n)){let{record:f}=await this.localStore.get(s,n);o=Hr(f).sequence+1n}_r(t)&&(t=t.toCID());let a=n.ttl!=null?BigInt(n.ttl)*1000000n:Bf,c=n.lifetime??1728e5,l=await m2(i,t,o,c,{...n,ttlNs:a}),u=io(l);return n.offline===!0?await this.localStore.put(s,u,{...n,metadata:{keyName:e,lifetime:c}}):await Promise.all(this.routers.map(async f=>{await f.put(s,u,{...n,metadata:{keyName:e,lifetime:c}})})),{record:l,publicKey:i.publicKey}}catch(i){throw n.onProgress?.(new G("ipns:publish:error",i)),i}}async#e(e){try{return await this.keychain.exportKey(e)}catch{let n=await Oa("Ed25519");return await this.keychain.importKey(e,n),n}}async unpublish(e,t){let{publicKey:n}=await this.keychain.exportKey(e),i=n.toMultihash(),o=Ko(i);await this.localStore.delete(o,t)}};var Lp=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Ma=new Uint32Array(80),q7=class extends rl{A=Lp[0]|0;B=Lp[1]|0;C=Lp[2]|0;D=Lp[3]|0;E=Lp[4]|0;constructor(){super(64,20,8,!1)}get(){let{A:e,B:t,C:n,D:i,E:o}=this;return[e,t,n,i,o]}set(e,t,n,i,o){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0}process(e,t){for(let c=0;c<16;c++,t+=4)Ma[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Ma[c]=kg(Ma[c-3]^Ma[c-8]^Ma[c-14]^Ma[c-16],1);let{A:n,B:i,C:o,D:s,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=Pg(i,o,s),u=1518500249):c<40?(l=i^o^s,u=1859775393):c<60?(l=Rg(i,o,s),u=2400959708):(l=i^o^s,u=3395469782);let f=kg(n,5)+l+a+u+Ma[c]|0;a=s,s=o,o=kg(i,30),i=n,n=f}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,this.set(n,i,o,s,a)}roundClean(){nn(Ma)}destroy(){this.set(0,0,0,0,0),nn(this.buffer)}},RI=np(()=>new q7);function DI(r,e,t,n){As(r);let i=q_({dkLen:32,asyncTick:10},n),{c:o,dkLen:s,asyncTick:a}=i;if(rn(o,"c"),rn(s,"dkLen"),rn(a,"asyncTick"),o<1)throw new Error("iterations (c) must be >= 1");let c=Ax(e,"password"),l=Ax(t,"salt"),u=new Uint8Array(s),f=Ra.create(r,c),h=f._cloneInto().update(l);return{c:o,dkLen:s,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function OI(r,e,t,n,i){return r.destroy(),e.destroy(),n&&n.destroy(),nn(i),t}function NI(r,e,t,n){let{c:i,dkLen:o,DK:s,PRF:a,PRFSalt:c}=DI(r,e,t,n),l,u=new Uint8Array(4),f=tl(u),h=new Uint8Array(a.outputLen);for(let d=1,m=0;m<o;d++,m+=a.outputLen){let y=s.subarray(m,m+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),y.set(h.subarray(0,y.length));for(let w=1;w<i;w++){a._cloneInto(l).update(h).digestInto(h);for(let x=0;x<y.length;x++)y[x]^=h[x]}}return OI(a,c,s,l,h)}async function _2(r,e,t,n){let{c:i,dkLen:o,asyncTick:s,DK:a,PRF:c,PRFSalt:l}=DI(r,e,t,n),u,f=new Uint8Array(4),h=tl(f),d=new Uint8Array(c.outputLen);for(let m=1,y=0;y<o;m++,y+=c.outputLen){let w=a.subarray(y,y+c.outputLen);h.setInt32(0,m,!1),(u=l._cloneInto(u)).update(f).digestInto(d),w.set(d.subarray(0,w.length)),await K_(i-1,s,()=>{c._cloneInto(u).update(d).digestInto(d);for(let x=0;x<w.length;x++)w[x]^=d[x]})}return OI(c,l,a,u,d)}var LI={sha1:RI,"sha2-256":Pi,"sha2-512":Ta};function Bp(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){let a=Object.keys(LI).join(" / ");throw new O(`Hash '${i}' is unknown or not supported. Must be ${a}`)}let o=LI[i],s=NI(o,r,e,{c:t,dkLen:n});return sr.encode(s).substring(1)}var j7={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},BI={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},MI=new globalThis.TextEncoder;function NK(r,e){let t=j7[e],n=BI[e];for(let i=0;i<r.length;i++)n^=BigInt(r[i]),n=BigInt.asUintN(e,n*t);return n}function LK(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=j7[e],i=BI[e],o=r;for(;o.length>0;){let s=MI.encodeInto(o,t);o=o.slice(s.read);for(let a=0;a<s.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*n)}return i}function W7(r,{size:e=32,utf8Buffer:t}={}){if(!j7[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return LK(r,e,t);r=MI.encode(r)}return NK(r,e)}var Mp={hash:r=>Number(W7(r,{size:32})),hashV:(r,e)=>BK(Mp.hash(r,e))};function BK(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),R(e,"base16")}var G7=64,oo=class{fp;h;seed;constructor(e,t,n,i=2){if(i>G7)throw new TypeError("Invalid Fingerprint Size");let o=t.hashV(e,n),s=ke(i);for(let a=0;a<s.length;a++)s[a]=o[a];s.length===0&&(s[0]=7),this.fp=s,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?me(this.fp,e.fp):!1}};function yl(r,e){return Math.floor(Math.random()*(e-r))+r}var wl=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof oo))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof oo))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof oo))throw new TypeError("Invalid Fingerprint");let t=yl(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof oo))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var MK=500,Up=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Mp,this.seed=e.seed??yl(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=R(e));let t=new oo(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new wl(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new wl(this.bucketSize)),this.buckets[n].add(t)||this.buckets[i].add(t))return this.count++,!0;let o=[n,i],s=o[yl(0,o.length-1)];this.buckets[s]==null&&(this.buckets[s]=new wl(this.bucketSize));for(let a=0;a<MK;a++){let c=this.buckets[s].swap(t);if(c!=null&&(s=(s^c.hash())%this.filterSize,this.buckets[s]==null&&(this.buckets[s]=new wl(this.bucketSize)),this.buckets[s].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=R(e));let t=new oo(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.has(t)??!1;if(i)return i;let o=(n^t.hash())%this.filterSize;return this.buckets[o]?.has(t)??!1}remove(e){typeof e=="string"&&(e=R(e));let t=new oo(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.remove(t)??!1;if(i)return this.count--,i;let o=(n^t.hash())%this.filterSize,s=this.buckets[o]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},UK={1:.5,2:.84,4:.95,8:.98};function FK(r=.001){return r>.002?2:r>1e-5?4:8}function UI(r,e=.001){let t=FK(e),n=UK[t],i=Math.round(r/n),o=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),G7);return{filterSize:i,bucketSize:t,fingerprintSize:o}}var Uf=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Mp,this.seed=e.seed??yl(0,Math.pow(2,10)),this.filterSeries=[new Up({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=R(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Up({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=R(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=R(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Rr(r,e=.001,t){return new Uf({...UI(r,e),...t??{}})}function Te(r){let e=r.getComponents(),t={},n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new O(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}var C2=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let o=0,s=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*i)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(o*=e,o+=u,o>l||(s+=1,t!==void 0&&s>t))return}if(s!==0)return!n&&c&&s>1?void 0:o})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let i=n*2;if(n<t.length-3){let s=this.readSeparator(":",n,()=>this.readIPv4Addr());if(s!==void 0)return t[i]=s[0],t[i+1]=s[1],t[i+2]=s[2],t[i+3]=s[3],[i+4,!0]}let o=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(o===void 0)return[i,!1];t[i]=o>>8,t[i+1]=o&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let o=new Uint8Array(14),s=16-(n+2),[a]=e(o.subarray(0,s));return t.set(o.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var FI=45,$K=15,Ff=new C2;function T2(r){if(!(r.length>$K))return Ff.new(r).parseWith(()=>Ff.readIPv4Addr())}function I2(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>FI))return Ff.new(r).parseWith(()=>Ff.readIPv6Addr())}function $f(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>FI)return;let t=Ff.new(r).parseWith(()=>Ff.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function $I(r,e,t){let n=0;for(let i of r)if(!(n<e)){if(n>t)break;if(i!==255)return!1;n++}return!0}function HI(r,e,t,n){let i=0;for(let o of r)if(!(i<t)){if(i>n)break;if(o!==e[i])return!1;i++}return!0}function X7(r){switch(r.length){case xl:return r.join(".");case bl:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function VI(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let i=t+1;i<r.length;i++)if(r[i]!=0)return-1;break}return e}function zI(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var xl=4,bl=16,hfe=parseInt("0xFFFF",16),HK=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Fp(r,e){e.length===bl&&r.length===xl&&$I(e,0,11)&&(e=e.slice(12)),e.length===xl&&r.length===bl&&HI(r,HK,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=r[i]&e[i];return n}function KI(r,e){if(typeof e=="string"&&(e=$f(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function Y7(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=xl,i=T2(e);if(i==null&&(n=bl,i=I2(e),i==null))throw new Error("Failed to parse given CIDR: "+r);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n*8)throw new Error("Failed to parse given CIDR: "+r);let s=Q7(o,8*n);return{network:Fp(i,s),mask:s}}function Q7(r,e){if(e!==8*xl&&e!==8*bl)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let i=0;i<t;i++){if(r>=8){n[i]=255,r-=8;continue}n[i]=255-(255>>r),r=0}return n}var vl=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=Y7(e));else{let n=$f(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n.length*8){let o=$f(t);if(o==null)throw new Error("Failed to parse mask");this.mask=o}else this.mask=Q7(i,8*n.length);this.network=Fp(n,this.mask)}}contains(e){return KI({network:this.network,mask:this.mask},e)}toString(){let e=VI(this.mask),t=e!==-1?String(e):zI(this.mask);return X7(this.network)+"/"+t}};function qI(r,e){return new vl(r).contains(e)}function k2(r){try{let e=Te(r);switch(e.type){case"ip6":return qI("2000::/3",e.host);default:return!1}}catch{return!1}}function jI(r){try{let e=Te(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function WI(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function $p(r){try{let e=Te(r);switch(e.type){case"ip4":case"ip6":return WI(e.host);default:return!1}}catch{return!1}}function Vr(r){try{return Te(r),!0}catch{return!1}}function so(r){return!!T2(r)}function P2(r){return!!I2(r)}var XI=bt(GI(),1),VK=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],zK=VK.map(r=>new XI.Netmask(r));function Z7(r){for(let e of zK)if(e.contains(r))return!0;return!1}function KK(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function qK(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),i=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Z7(i)}function jK(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function WK(r){let e=r.split(":"),t=e[e.length-1];return Z7(t)}function GK(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Hf(r){if(so(r))return Z7(r);if(KK(r))return qK(r);if(jK(r))return WK(r);if(P2(r))return GK(r)}function qt(r){try{let e=Te(r);switch(e.type){case"ip4":case"ip6":return Hf(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}function We(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var R2=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Vf=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new R2(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new R2(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var J7=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function xr(r={}){return XK(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function XK(r,e){e=e??{};let t=e.onEnd,n=new Vf,i,o,s,a=We(),c=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((w,x)=>{o=v=>{o=null,n.push(v);try{w(r(n))}catch(E){x(E)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=We()})}},l=w=>o!=null?o(w):(n.push(w),i),u=w=>(n=new Vf,o!=null?o({error:w}):(n.push({error:w}),i)),f=w=>{if(s)return i;if(e?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},h=w=>s?i:(s=!0,w!=null?u(w):l({done:!0})),d=()=>(n=new Vf,h(),{done:!0}),m=w=>(h(w),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:d,throw:m,push:f,end:h,get readableLength(){return n.size},onEmpty:async w=>{let x=w?.signal;if(x?.throwIfAborted(),n.isEmpty())return;let v,E;x!=null&&(v=new Promise((_,B)=>{E=()=>{B(new J7)},x.addEventListener("abort",E)}));try{await Promise.race([a.promise,v])}finally{E!=null&&x!=null&&x?.removeEventListener("abort",E)}}},t==null)return i;let y=i;return i={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(w){return y.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return y.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(w){return y.end(w),t!=null&&(t(w),t=void 0),i},get readableLength(){return y.readableLength},onEmpty:w=>y.onEmpty(w)},i}var eb=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},tb=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},YI=r=>globalThis.DOMException===void 0?new tb(r):new DOMException(r),QI=r=>{let e=r.reason===void 0?YI("This operation was aborted."):r.reason;return e instanceof Error?e:YI(e)};function rb(r,e){let{milliseconds:t,fallback:n,message:i,customTimers:o={setTimeout,clearTimeout}}=e,s,a,l=new Promise((u,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:d}=e;d.aborted&&f(QI(d)),a=()=>{f(QI(d))},d.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,f);return}let h=new eb;s=o.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(d){f(d)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?u():i instanceof Error?f(i):(h.message=i??`Promise timed out after ${t} milliseconds`,f(h))},t),(async()=>{try{u(await r)}catch(d){f(d)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{o.clearTimeout.call(void 0,s),s=void 0},l}var YK=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function QK(r,e,t){let n,i=new Promise((o,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=YK(r),f=async(...d)=>{let m=t.multiArgs?d:d[0];if(t.filter)try{if(!await t.filter(m))return}catch(y){n(),s(y);return}c.push(m),t.count===c.length&&(n(),o(c))},h=(...d)=>{n(),s(t.rejectionMultiArgs?d:d[0])};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)a.includes(d)||u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)a.includes(d)||l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&o(c)});if(i.cancel=n,typeof t.timeout=="number"){let o=rb(i,{milliseconds:t.timeout});return o.cancel=()=>{n(),o.clear()},o}return i}function st(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=QK(r,e,t),i=n.then(o=>o[0]);return i.cancel=n.cancel,i}function Ls(r,e){let t,n=function(){let i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var D2=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}},O2=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},El=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},N2=class extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"},L2=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function ZK(r){return r.reason}async function Et(r,e,t){if(e==null)return r;let n=t?.translateError??ZK;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let i;try{return await Promise.race([r,new Promise((o,s)=>{i=()=>{s(n(e))},e.addEventListener("abort",i)})])}finally{i!=null&&e.removeEventListener("abort",i)}}var B2=class{deferred;signal;constructor(e){this.signal=e,this.deferred=We(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new St)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function JK(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var M2=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=JK(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new St),this.cleanup())}async join(e={}){let t=new B2(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await Et(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var jt=class extends Ce{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Ls(this.emitEmpty.bind(this),1),this.emitIdle=Ls(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new O2;let n=new M2(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:n,result:i}}),i)).catch(i=>{if(n.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===n){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new St)}),this.clear()}async onEmpty(e){this.size!==0&&await st(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await st(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await st(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=xr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail)},o=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new St("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("failure",o),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",i),this.removeEventListener("failure",o),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var eq=Math.pow(2,20)*4,Ua=class extends Ce{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??eq,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new oe,this.writeBuffer=new oe,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);let t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);let n=i=>{this.onDrainPromise?.reject(i.error??new L2)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),Et(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;let e=xr(),t=o=>{e.push(o.data)};this.addEventListener("message",t);let n=o=>{e.end(o.error)};this.addEventListener("close",n);let i=()=>{e.end()};this.addEventListener("remoteCloseWrite",i);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",i)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Oo(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new vg(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Oo("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Oo("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Oo(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Oo(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");let e=new tf;this.dispatchEvent(new Eg(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new va))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0,t=this.writeBuffer.byteLength,n=0;for(;this.writeBuffer.byteLength>0;){let i=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(i===0){e=!1;break}let o=this.writeBuffer.sublist(0,i),s=new oe(o);this.writeBuffer.consume(o.byteLength);let a=this.sendData(o);if(e=a.canSendMore,n+=a.sentBytes,a.sentBytes!==s.byteLength&&(s.consume(a.sentBytes),this.writeBuffer.prepend(s)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}let e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new bg(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new Wh(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new Wh(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};var Fa=class extends Ua{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await st(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await st(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};function U2(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var $a=class extends Ce{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;let n=s=>{try{this.onData(s.data)}catch(a){this.abort(a),this.maConn.abort(a)}};this.maConn.addEventListener("message",n);let i=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(s=>{s.onMuxerDrain()})};this.maConn.addEventListener("drain",i);let o=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",o)}send(e){let t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await Et(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new Xi;let t=this.onCreateStream({...this.streamOptions,...e});return U2(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new N2(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){let t=n=>{let i=this.streams.findIndex(o=>o===e);i!==-1&&this.streams.splice(i,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}};var Ha=class extends Ua{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await st(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await st(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}};function Oe(r){let e=new globalThis.AbortController;function t(){e.abort();for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(let o of r){if(o?.aborted===!0){t();break}o?.addEventListener!=null&&o.addEventListener("abort",t)}function n(){for(let o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}let i=e.signal;return i.clear=n,i}var zf=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),i=e-this.movingAverage,o=n*i;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+i*o),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*i}else this.movingAverage=e;this.previousTime=t}};var tq=1.2,rq=2,nq=5e3,iq=6e4,oq=5e3,ao=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){let t=e.interval??oq;this.success=new zf(t),this.failure=new zf(t),this.next=new zf(t),this.failureMultiplier=e.failureMultiplier??rq,this.timeoutMultiplier=e.timeoutMultiplier??tq,this.minTimeout=e.minTimeout??nq,this.maxTimeout=e.maxTimeout??iq,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);let n=AbortSignal.timeout(t),i=Oe([e.signal,n]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var zr=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Bs=class extends Error{static name="ValidationError";name="ValidationError"},F2=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},$2=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function ib(r){return e=>K(e,r)}function ob(r){return e=>R(e,r)}function Kf(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Sl(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function ZI(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=R(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=Sl(n);return it([t,i],t.length+i.length)}function JI(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=Tr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let i=Sl(n);return it([t,i],t.length+i.length)}function sb(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=K(e,"base32"),i=Kf(t);return`${n}:${i}`}var ab=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let i=parseInt(t,10);if(isNaN(i)||i<0||i>255)throw new zr("Invalid byte value in IP address");e[n]=i}),e},ek=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let o=so(t[n]),s;o&&(s=ab(t[n]),t[n]=K(s.subarray(0,2),"base16")),s!=null&&++n<8&&t.splice(n,0,K(s.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let o=[n,1];for(n=9-t.length;n>0;n--)o.push("0");t.splice.apply(t,o)}let i=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let o=parseInt(t[n],16);if(isNaN(o)||o<0||o>65535)throw new zr("Invalid byte value in IP address");i[e++]=o>>8&255,i[e++]=o&255}return i},tk=function(r){if(r.byteLength!==4)throw new zr("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},rk=function(r){if(r.byteLength!==16)throw new zr("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let i=r[n],o=r[n+1],s=`${i.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;e.push(s)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new zr(`Invalid IPv6 address "${t}"`)}};function nk(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new zr(`Invalid IPv6 address "${r}"`)}}var nb=Object.values(Qc).map(r=>r.decoder),sq=(function(){let r=nb[0].or(nb[1]);return nb.slice(2).forEach(e=>r=r.or(e)),r})();function ik(r){return sq.decode(r)}function ok(r){return e=>r.encoder.encode(e)}function aq(r){if(parseInt(r).toString()!==r)throw new Bs("Value must be an integer")}function cq(r){if(r<0)throw new Bs("Value must be a positive integer, or zero")}function lq(r){return e=>{if(e>r)throw new Bs(`Value must be smaller than or equal to ${r}`)}}function uq(...r){return e=>{for(let t of r)t(e)}}var Vp=uq(aq,cq,lq(65535));var Dr=-1,cb=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new $2(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},Fs=new cb,_q=[{code:4,name:"ip4",size:32,valueToBytes:ab,bytesToValue:tk,validate:r=>{if(!so(r))throw new Bs(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Sl,bytesToValue:Kf,validate:Vp},{code:273,name:"udp",size:16,valueToBytes:Sl,bytesToValue:Kf,validate:Vp},{code:33,name:"dccp",size:16,valueToBytes:Sl,bytesToValue:Kf,validate:Vp},{code:41,name:"ip6",size:128,valueToBytes:ek,bytesToValue:rk,stringToValue:nk,validate:r=>{if(!P2(r))throw new Bs(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:Dr},{code:43,name:"ipcidr",size:8,bytesToValue:ib("base10"),valueToBytes:ob("base10")},{code:53,name:"dns",size:Dr},{code:54,name:"dns4",size:Dr},{code:55,name:"dns6",size:Dr},{code:56,name:"dnsaddr",size:Dr},{code:132,name:"sctp",size:16,valueToBytes:Sl,bytesToValue:Kf,validate:Vp},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Dr,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:Dr,bytesToValue:ib("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?ob("base58btc")(r):j.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:sb,valueToBytes:ZI},{code:445,name:"onion3",size:296,bytesToValue:sb,valueToBytes:JI},{code:446,name:"garlic64",size:Dr},{code:447,name:"garlic32",size:Dr},{code:448,name:"tls"},{code:449,name:"sni",size:Dr},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Dr,bytesToValue:ok(Yc),valueToBytes:ik},{code:480,name:"http"},{code:481,name:"http-path",size:Dr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Dr}];_q.forEach(r=>{Fs.addProtocol(r)});function sk(r){let e=[],t=0;for(;t<r.length;){let n=oi(r,t),i=Fs.getProtocol(n),o=Ke(n),s=Cq(i,r,t+o),a=0;s>0&&i.size===Dr&&(a=Ke(s));let c=o+a+s,l={code:n,name:i.name,bytes:r.subarray(t,t+c)};if(s>0){let u=t+o+a,f=r.subarray(u,u+s);l.value=i.bytesToValue?.(f)??K(f)}e.push(l),t+=c}return e}function ak(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let i=Fs.getProtocol(n.code),o=Ke(n.code),s,a=0,c=0;n.value!=null&&(s=i.valueToBytes?.(n.value)??R(n.value),a=s.byteLength,i.size===Dr&&(c=Ke(a)));let l=new Uint8Array(o+c+a),u=0;_f(n.code,l,u),u+=o,s!=null&&(i.size===Dr&&(_f(a,l,u),u+=c),l.set(s,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return it(t,e)}function ck(r){if(r.charAt(0)!=="/")throw new zr('String multiaddr must start with "/"');let e=[],t="protocol",n="",i="";for(let o=1;o<r.length;o++){let s=r.charAt(o);s!=="/"&&(t==="protocol"?i+=r.charAt(o):n+=r.charAt(o));let a=o===r.length-1;if(s==="/"||a){let c=Fs.getProtocol(i);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",i="",t="protocol";continue}else if(a)throw new zr(`Component ${i} was missing value`);t="value"}else if(t==="value"){let l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new zr(`Component ${i} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",i="",t="protocol"}}}if(i!==""&&n!=="")throw new zr("Incomplete multiaddr");return e}function lk(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=Fs.getProtocol(e.code);if(t==null)throw new zr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function Cq(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:oi(e,t)}var Tq=Symbol.for("nodejs.util.inspect.custom"),yb=Symbol.for("@multiformats/multiaddr");function Iq(r){if(r==null&&(r="/"),jo(r))return r.getComponents();if(r instanceof Uint8Array)return sk(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),ck(r);if(Array.isArray(r))return r;throw new zr("Must be a string, Uint8Array, Component[], or another Multiaddr")}var K2=class r{[yb]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=Iq(e),t.validate!==!1&&kq(this)}get bytes(){return this.#r==null&&(this.#r=ak(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=lk(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new F2(`Address ${this.toString()} does not contain subaddress: ${t}`);return new r(n.slice(0,i),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}equals(e){return me(this.bytes,e.bytes)}[Tq](){return`Multiaddr(${this.toString()})`}};function kq(r){r.getComponents().forEach(e=>{let t=Fs.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function jo(r){return!!r?.[yb]}function se(r){return new K2(r)}var q2=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function uk(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new q2(t?.errorMessage,t?.errorCode,t?.errorName));let n,i=new q2(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((o,s)=>{n=()=>{s(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var wb=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=We(),this.haveNext=We()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=We(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=We(),await uk(this.readNext.promise,t?.signal,t)}};function fk(){return new wb}function Pq(r){return r[Symbol.asyncIterator]!=null}async function Rq(r,e,t){try{await Promise.all(r.map(async n=>{for await(let i of n)await e.push(i,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*Dq(r){let e=new AbortController,t=fk();Rq(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*Oq(r){for(let e of r)yield*e}function Nq(...r){let e=[];for(let t of r)Pq(t)||e.push(t);return e.length===r.length?Oq(e):Dq(r)}var bn=Nq;function br(r,...e){if(r==null)throw new Error("Empty pipeline");if(xb(r)){let n=r;r=()=>n.source}else if(hk(r)||dk(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&xb(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)xb(t[n])&&(t[n]=Bq(t[n]));return Lq(...t)}var Lq=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},dk=r=>r?.[Symbol.asyncIterator]!=null,hk=r=>r?.[Symbol.iterator]!=null,xb=r=>r==null?!1:r.sink!=null&&r.source!=null,Bq=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=xr({objectMode:!0});t.then(()=>{n.end()},s=>{n.end(s)});let i,o=r.source;if(dk(o))i=async function*(){yield*o,n.end()};else if(hk(o))i=function*(){yield*o,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return bn(n,i())}return r.source};var Mq=4194304,j2=class extends Error{static name="UnwrappedError";name="UnwrappedError"},Gp=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},vb=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Eb=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Uq(r){return typeof r?.closeRead=="function"}function Fq(r){return typeof r?.close=="function"}function bb(r){return Uq(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:Fq(r)?r.status!=="open":!1}function $q(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function W2(r,e){let t=e?.maxBufferSize??Mq,n=new oe,i,o=!1;if(!$q(r))throw new O("Argument should be a Stream or a Multiaddr");let s=u=>{if(n.append(u.data),n.byteLength>t){let f=n.byteLength;n.consume(n.byteLength),i?.reject(new Error(`Read buffer overflow - ${f} > ${t}`))}i?.resolve()};r.addEventListener("message",s);let a=u=>{u.error!=null?i?.reject(u.error):i?.resolve()};r.addEventListener("close",a);let c=()=>{i?.resolve()};r.addEventListener("remoteCloseWrite",c);let l={readBuffer:n,async read(u){if(o===!0)throw new j2("Stream was unwrapped");if(bb(r)){if(u?.bytes==null)return null;if(n.byteLength<u.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,u.bytes),new El(`Unexpected EOF - stream closed after reading ${n.byteLength}/${u.bytes} bytes`)}let f=u?.bytes??1;for(i=Promise.withResolvers();;){if(n.byteLength>=f){i.resolve();break}if(await Et(i.promise,u?.signal),bb(r)){if(n.byteLength===0&&u?.bytes==null)return null;break}i=Promise.withResolvers()}let h=u?.bytes??n.byteLength;if(n.byteLength<h){if(bb(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,h),new El(`Unexpected EOF - stream closed while reading ${n.byteLength}/${h} bytes`);return l.read(u)}let d=n.sublist(0,h);return n.consume(h),d},async write(u,f){if(o===!0)throw new j2("Stream was unwrapped");r.send(u)||await st(r,"drain",{signal:f?.signal,rejectionEvents:["close"]})},unwrap(){return o||(o=!0,r.removeEventListener("message",s),r.removeEventListener("close",a),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return l}function za(r,e={}){let t=W2(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ke(e.maxDataLength));let n=e?.lengthDecoder??oi,i=e?.lengthEncoder??sn;return{async read(s){let a=-1,c=new oe;for(;;){let u=await t.read({...s,bytes:1});if(u==null)break;c.append(u);try{a=n(c)}catch(f){if(f instanceof RangeError)continue;throw f}if(a<0)throw new Gp("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new Eb(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new vb(`Message length too long - ${a} > ${e.maxDataLength}`);let l=await t.read({...s,bytes:a});if(l==null)throw r.log.error("tried to read %d bytes but the stream closed",a),new El(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(l.byteLength!==a)throw r.log.error("read %d/%d bytes before the stream closed",l.byteLength,a),new El(`Unexpected EOF - read ${l.byteLength}/${a} bytes before the stream closed`);return l},async write(s,a){await t.write(new oe(i(s.byteLength),s),a)},async writeV(s,a){let c=new oe(...s.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap(){return t.unwrap()}}}function Tt(r,e){let t=za(r,e),n={read:async(i,o)=>{let s=await t.read(o);return i.decode(s)},write:async(i,o,s)=>{await t.write(o.encode(i),s)},writeV:async(i,o,s)=>{await t.writeV(i.map(a=>o.encode(a)),s)},pb:i=>({read:async o=>n.read(i,o),write:async(o,s)=>n.write(o,i,s),writeV:async(o,s)=>n.writeV(o,i,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var Hq=1024*1024*4,Vq=1024*1024*4,G2=class{buffer;maxBufferSize;lengthDecoder;maxDataLength;encodingLength;constructor(e={}){this.buffer=new oe,this.maxBufferSize=e.maxBufferSize??Hq,this.maxDataLength=e.maxDataLength??Vq,this.lengthDecoder=e.lengthDecoder??oi,this.encodingLength=e.encodingLength??Ke}*decode(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxBufferSize)throw new O(`Buffer length limit exceeded - ${this.buffer.byteLength}/${this.maxBufferSize}`);for(;;){let t;try{t=this.lengthDecoder(this.buffer)}catch(o){if(o instanceof RangeError)break;throw o}if(t<0||t>this.maxDataLength)throw new Gp("Invalid message length");let n=this.encodingLength(t),i=n+t;if(this.buffer.byteLength>=i){let o=this.buffer.sublist(n,i);this.buffer.consume(i),o.byteLength>0&&(yield o)}else break}}};var X2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Gf=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Y2=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Xp=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Q2(r){return r[Symbol.asyncIterator]!=null}function pk(r,e){if(r.byteLength>e)throw new Gf("Message length too long")}var J2=r=>{let e=Ke(r),t=Ft(e);return sn(r,t),J2.bytes=e,t};J2.bytes=0;function $s(r,e){e=e??{};let t=e.lengthEncoder??J2,n=e?.maxDataLength??4194304;function*i(o){pk(o,n);let s=t(o.byteLength);s instanceof Uint8Array?yield s:yield*s,o instanceof Uint8Array?yield o:yield*o}return Q2(r)?(async function*(){for await(let o of r)yield*i(o)})():(function*(){for(let o of r)yield*i(o)})()}$s.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??J2,n=e?.maxDataLength??4194304;return pk(r,n),new oe(t(r.byteLength),r)};var _l;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(_l||(_l={}));var Sb=r=>{let e=oi(r);return Sb.bytes=Ke(e),e};Sb.bytes=0;function Cl(r,e){let t=new oe,n=_l.LENGTH,i=-1,o=e?.lengthDecoder??Sb,s=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===_l.LENGTH)try{if(i=o(t),i<0)throw new X2("Invalid message length");if(i>a)throw new Gf("Message length too long");let l=o.bytes;t.consume(l),e?.onLength!=null&&e.onLength(i),n=_l.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>s)throw new Y2("Message length length too long");break}throw l}if(n===_l.DATA){if(t.byteLength<i)break;let l=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(l),yield l,n=_l.LENGTH}}}return Q2(r)?(async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Xp("Unexpected end of input")})():(function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Xp("Unexpected end of input")})()}Cl.fromReader=(r,e)=>{let t=1,n=(async function*(){for(;;)try{let{done:o,value:s}=await r.next(t);if(o===!0)return;s!=null&&(yield s)}catch(o){if(o.code==="ERR_UNDER_READ")return{done:!0,value:null};throw o}finally{t=1}})();return Cl(n,{...e??{},onLength:o=>{t=o}})};var gk=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},Kq=new WeakMap;function qq({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i?.aborted)return Promise.reject(gk());let o,s,a,c=r??clearTimeout,l=()=>{c(o),a(gk())},u=()=>{i&&i.removeEventListener("abort",l)},f=new Promise((h,d)=>{s=()=>{u(),h(n)},a=d,o=(e??setTimeout)(s,t)});return i&&i.addEventListener("abort",l,{once:!0}),Kq.set(f,()=>{c(o),o=null,s()}),f}}var jq=qq(),yk=jq;var Kr=class extends jt{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var ey=class extends jt{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};var Xf=class{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new Ab}consume(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,t,o);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(i,s.consumedPoints,this.blockDuration)),new D2("Rate limit exceeded",s);return s}penalty(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,t,o);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,n={}){let i=this.getKey(e),o=this._getKeySecDuration(n),s=this.memoryStorage.incrby(i,-t,o);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let n=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:i,isFirstInDuration:!1}}set(e,t,n=0){let i=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},Ab=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let i=this.storage.get(e);if(i!=null){let o=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||o>0?(i.value+=t,{remainingPoints:0,msBeforeNext:o,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let i=n*1e3,o=this.storage.get(e);o!=null&&clearTimeout(o.timeoutId);let s={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,s),i>0&&(s.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),s.timeoutId.unref!=null&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function Ka(r,e,t){let n,i,o=!1;function s(){let l={signal:i.signal};if(t?.timeout!=null){let u=Oe([i.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}o=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{o=!1,!i.signal.aborted&&(n=setTimeout(s,e))})}let a=Ls(s,t?.debounce??100),c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(s,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{o||(clearTimeout(n),a())},start:()=>{c||(c=!0,i=new AbortController,i.signal,t?.runImmediately===!0?queueMicrotask(()=>{s()}):n=setTimeout(s,e))},stop:()=>{clearTimeout(n),i?.abort(),c=!1}}}var _b=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function lr(r){let{name:e,metrics:t}=r,n;return t!=null?n=new _b({name:e,metrics:t}):n=new Map,n}var ty=class{routers;localStore;republishTask;log;keychain;started=!1;republishConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:ipns"),this.localStore=t.localStore,this.keychain=e.libp2p.services.keychain,this.republishConcurrency=t.republishConcurrency||CI,this.started=e.libp2p.status==="started",this.routers=t.routers??[],this.republishTask=Ka(this.#e.bind(this),t.republishInterval??36e5,{runImmediately:!0}),this.started&&this.republishTask.start()}start(){this.started||(this.started=!0,this.republishTask.start())}stop(){this.started&&(this.started=!1,this.republishTask.stop())}async#e(e={}){if(!this.started)return;this.log("starting ipns republish records loop");let t=new jt({concurrency:this.republishConcurrency});try{let n=[];for await(let{routingKey:i,record:o,metadata:s,created:a}of this.localStore.list(e)){if(s==null){this.log(`no metadata found for record ${i.toString()}, skipping`);continue}let c;try{c=Hr(o)}catch(h){this.log.error("error unmarshaling record - %e",h);continue}if(!II(c,a)){this.log.trace(`skipping record ${i.toString()}within republish threshold`);continue}let l=c.sequence+1n,u=c.ttl??Bf,f;try{f=await this.keychain.exportKey(s.keyName)}catch(h){this.log.error("missing key %s, skipping republishing record - %e",s.keyName,h);continue}try{let h=await m2(f,c.value,l,s.lifetime,{...e,ttlNs:u});n.push({routingKey:i,record:h})}catch(h){this.log.error("error creating updated IPNS record for %s - %e",i,h);continue}}this.log(`found ${n.length} records to republish`);for(let{routingKey:i,record:o}of n)t.add(async()=>{try{let s=io(o);await Promise.all(this.routers.map(a=>a.put(i,s,e)))}catch(s){this.log.error("error republishing record - %e",s)}},e)}catch(n){this.log.error("error during republish - %e",n)}await t.onIdle(e)}};var pt=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),Ie=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),wk=r=>({match:e=>r.match(e)===!1?e:!1}),Ye=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),cn=(...r)=>({match:e=>{let t;for(let n of r){let i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1}}),at=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function mt(...r){function e(i){if(i==null)return!1;let o=i.getComponents();for(let s of r){let a=s.match(o);if(a===!1)return!1;o=a}return o}function t(i){return e(i)!==!1}function n(i){let o=e(i);return o===!1?!1:o.length===0}return{matchers:r,matches:t,exactMatch:n}}var Gq=Ie(421),xk=mt(Gq),ny=Ie(54),iy=Ie(55),oy=Ie(56),Tb=Ie(53),Rpe=mt(ny,Ye(Ie(421))),Dpe=mt(iy,Ye(Ie(421))),Ope=mt(oy,Ye(Ie(421))),sy=mt(cn(Tb,oy,ny,iy),Ye(Ie(421))),bk=at(Ie(4),Ye(Ie(43))),vk=at(Ye(Ie(42)),Ie(41),Ye(Ie(43))),Ib=cn(bk,vk),Tl=cn(Ib,Tb,ny,iy,oy),Ek=mt(cn(Ib,at(cn(Tb,oy,ny,iy),Ye(Ie(421))))),kb=mt(bk),Pb=mt(vk),Sk=mt(Ib),Rb=at(Tl,Ie(6)),Yp=at(Tl,Ie(273)),Il=mt(at(Rb,Ye(Ie(421)))),Npe=mt(Yp),Db=at(Yp,pt(460),Ye(Ie(421))),ay=at(Yp,pt(461),Ye(Ie(421))),Xq=cn(Db,ay),Lpe=mt(Db),Ak=mt(ay),Cb=cn(Tl,Rb,Yp,Db,ay),_k=cn(at(Cb,pt(477),Ye(Ie(421)))),Hs=mt(_k),Ck=cn(at(Cb,pt(478),Ye(Ie(421))),at(Cb,pt(448),Ye(Ie(449)),pt(477),Ye(Ie(421)))),kl=mt(Ck),Tk=at(Yp,pt(280),Ye(Ie(466)),Ye(Ie(466)),Ye(Ie(421))),Qp=mt(Tk),Ik=at(ay,pt(465),Ye(Ie(466)),Ye(Ie(466)),Ye(Ie(421))),Ob=mt(Ik),ry=cn(_k,Ck,at(Rb,Ye(Ie(421))),at(Xq,Ye(Ie(421))),at(Tl,Ye(Ie(421))),Tk,Ik,Ie(421)),Yf=mt(ry),Yq=at(Ye(ry),pt(290),wk(pt(281)),Ye(Ie(421))),Or=mt(Yq),Qq=cn(at(ry,pt(290),pt(281),Ye(Ie(421))),at(ry,pt(281),Ye(Ie(421))),at(pt(281),Ye(Ie(421)))),Zp=mt(Qq),Zq=cn(at(Tl,Ie(6),pt(480),Ye(Ie(421))),at(Tl,pt(480),Ye(Ie(421)))),kk=mt(Zq),Jq=at(Tl,cn(at(Ie(6,"443"),pt(480)),at(Ie(6),pt(443)),at(Ie(6),pt(448),pt(480)),at(pt(448),pt(480)),pt(448),pt(443)),Ye(Ie(421))),Pk=mt(Jq),ej=cn(at(Ie(777),Ye(Ie(421)))),Bpe=mt(ej),tj=cn(at(Ie(400),Ye(Ie(421)))),Mpe=mt(tj);function rj(r){return r[Symbol.asyncIterator]!=null}function nj(r){if(rj(r))return(async()=>{for await(let e of r);})();for(let e of r);}var ln=nj;var Pl=1e3,Nb=60*Pl,cy=60*Nb,Rk="/ipfs/kad/1.0.0",ly=48*cy;var Dk=24*cy,Ok=10,Nk=16384,Lk=cy,Lb=cy,Hpe=10*Pl,Bk=10*Pl;var uy=20,qa=10,Mk=5*Nb,Uk=Pl,Fk=5*Pl,$k=5*Nb,Hk=30*Pl,Vk=180*Pl,Bb=`${Wc}-kad-dht`;var Jp;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={key:ke(0),value:ke(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.key=t.bytes();break}case 2:{o.value=t.bytes();break}case 5:{o.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Jp||(Jp={}));function zk(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),o=String(r.getUTCMinutes()).padStart(2,"0"),s=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${o}:${s}.${c}Z`}function Kk(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),i=parseInt(t[2],10)-1,o=parseInt(t[3],10),s=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,o,s,a,c,l))}var $t=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Jp.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:zk(this.timeReceived)}}static deserialize(e){let t=Jp.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=Kk(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};function oj(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Qf=oj;function sj(r){return r[Symbol.asyncIterator]!=null}function aj(r,e){let t=0;if(sj(r))return(async function*(){for await(let c of r)yield e(c,t++)})();let n=Qf(r),{value:i,done:o}=n.next();if(o===!0)return(function*(){})();let s=e(i,t++);if(typeof s.then=="function")return(async function*(){yield await s;for(let c of n)yield e(c,t++)})();let a=e;return(function*(){yield s;for(let c of n)yield a(c,t++)})()}var Wt=aj;var fy=globalThis.CustomEvent??Event;async function*vn(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,i=new EventTarget,o=[],s=We(),a=We(),c=!1,l,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let m of r){if(o.length===t&&(s=We(),await s.promise),u)break;let y={done:!1};o.push(y),m().then(w=>{y.done=!0,y.ok=!0,y.value=w,i.dispatchEvent(new fy("task-complete"))},w=>{y.done=!0,y.err=w,i.dispatchEvent(new fy("task-complete"))})}c=!0,i.dispatchEvent(new fy("task-complete"))}catch(m){l=m,i.dispatchEvent(new fy("task-complete"))}});function f(){return n?o[0]?.done:!!o.find(m=>m.done)}function*h(){for(;o.length>0&&o[0].done;){let m=o[0];if(o.shift(),m.ok)yield m.value;else throw u=!0,s.resolve(),m.err;s.resolve()}}function*d(){for(;f();)for(let m=0;m<o.length;m++)if(o[m].done){let y=o[m];if(o.splice(m,1),m--,y.ok)yield y.value;else throw u=!0,s.resolve(),y.err;s.resolve()}}for(;;){if(f()||(a=We(),await a.promise),l!=null||(n?yield*h():yield*d(),l!=null))throw l;if(c&&o.length===0)break}}var ja=class extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}},dy=class extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}},hy=class extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}};var qk;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.key=t.bytes();break}case 2:{o.value=t.bytes();break}case 3:{o.author=t.bytes();break}case 4:{o.signature=t.bytes();break}case 5:{o.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(qk||(qk={}));var ut;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(ut||(ut={}));var py;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(py||(py={}));(function(r){r.codec=()=>_t(py)})(ut||(ut={}));var Jf;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Jf||(Jf={}));var Mb;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(Mb||(Mb={}));(function(r){r.codec=()=>_t(Mb)})(Jf||(Jf={}));var Zf;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let o of t.multiaddrs)n.uint32(18),n.bytes(o);t.connection!=null&&(n.uint32(24),Jf.codec().encode(t.connection,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={id:ke(0),multiaddrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.id=t.bytes();break}case 2:{if(i.limits?.multiaddrs!=null&&o.multiaddrs.length===i.limits.multiaddrs)throw new yt('Decode error - map field "multiaddrs" had too many elements');o.multiaddrs.push(t.bytes());break}case 3:{o.connection=Jf.codec().decode(t);break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Zf||(Zf={}));var Wa;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.type!=null&&py[t.type]!==0&&(n.uint32(8),ut.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let o of t.closer)n.uint32(66),Zf.codec().encode(o,n);if(t.providers!=null)for(let o of t.providers)n.uint32(74),Zf.codec().encode(o,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={type:ut.PUT_VALUE,closer:[],providers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.type=ut.codec().decode(t);break}case 10:{o.clusterLevel=t.int32();break}case 2:{o.key=t.bytes();break}case 3:{o.record=t.bytes();break}case 8:{if(i.limits?.closer!=null&&o.closer.length===i.limits.closer)throw new yt('Decode error - map field "closer" had too many elements');o.closer.push(Zf.codec().decode(t,t.uint32(),{limits:i.limits?.closer$}));break}case 9:{if(i.limits?.providers!=null&&o.providers.length===i.limits.providers)throw new yt('Decode error - map field "providers" had too many elements');o.providers.push(Zf.codec().decode(t,t.uint32(),{limits:i.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Wa||(Wa={}));function Ub(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function em(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function my(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function lo(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function Fb(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function tm(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function $b(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function jk(r,e={}){let t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function Wk(r,e,t){if(t.length===0)throw new O("No records given");let i=K(e).split("/");if(i.length<3)throw new O("Record key does not have a selector function");let o=r[i[1].toString()];if(o==null)throw new hy(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:o(e,t)}function cj(r,e){return 0}var Gk={pk:cj};async function ed(r,e,t){let n=e.key,o=K(n).split("/");if(o.length<3)return;let s=r[o[1].toString()];if(s==null)throw new O(`No validator available for key type "${o[1]}"`);await s(n,e.value,t)}var lj=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new O('"key" must be a Uint8Array');if(r.byteLength<5)throw new O("Invalid public key record");if(K(r.subarray(0,4))!=="/pk/")throw new O("key was not prefixed with /pk/");let i=er(e),o=r.slice(4);if(!me(o,i.toMultihash().bytes))throw new O("public key does not match passed in key")},Xk={pk:lj};var Yk=Symbol.for("nodejs.util.inspect.custom"),uj=114,rm=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Sg]=!0;toString(){return this.string==null&&(this.string=nt.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return j.createV1(uj,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return me(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return me(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Yk](){return`PeerId(${this.toString()})`}},nm=class extends rm{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},im=class extends rm{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},om=class extends rm{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},fj=2336,sm=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=or.digest(R(this.url))}[Yk](){return`PeerId(${this.url})`}[Sg]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return j.createV1(fj,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=K(e)),e.toString()===this.toString())}};var dj=114,Qk=2336;function tt(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=Xe(nt.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return En(j.parse(r));if(e==null)throw new O('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=Xe(e.decode(r))}return ur(t)}function Wo(r){if(r.type==="Ed25519")return new im({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new om({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new nm({multihash:r.toCID().multihash,publicKey:r});throw new Yi}function Zk(r){return Wo(r.publicKey)}function ur(r){if(pj(r))return new nm({multihash:r});if(hj(r))try{let e=qg(r);if(e.type==="Ed25519")return new im({multihash:r,publicKey:e});if(e.type==="secp256k1")return new om({multihash:r,publicKey:e})}catch{let t=K(r.digest);return new sm(new URL(t))}throw new xa("Supplied PeerID Multihash is invalid")}function En(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==dj&&r.code!==Qk)throw new wg("Supplied PeerID CID is invalid");if(r.code===Qk){let e=K(r.multihash.digest);return new sm(new URL(e))}return ur(r.multihash)}function hj(r){return r.code===or.code}function pj(r){return r.code===ze.code}var mj=R("/pk/");function Jk(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>!qt(e))}}async function Ga(r,e){let t=await ze.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function Mn(r,e){return Ga(r.toMultihash().bytes,e)}function Xa(r,e){return new lt(`${r}/${K(e,"base32")}`,!1)}function eP(r){return it([mj,r.toMultihash().bytes])}function tP(r){return K(r.subarray(0,4))==="/pk/"}function rP(r){let e=Xe(r.subarray(4));return ur(e)}function Hb(r,e){let t=new Date;return new $t(r,e,t).serialize()}function gy(r){let e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:j.createV1(vt,Xe(R(n,"base32"))),peerId:tt(t)}}function yy(r,e,t){let n=typeof e=="string"?e:K(e.multihash.bytes,"base32"),i=[r,n];return t!=null&&i.push(t.toString()),new lt(i.join("/"))}function wy(r){return new Date(oi(r))}function Rl(r,e,t){return async function*(...n){let i=e.queryTime?.timer(t),o=e.errorTime?.timer(t),s=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw s=!0,o?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||i?.()}}}function xy(r,e,t){return async function(...n){let i=e?.queryTime?.timer(t),o=e?.errorTime?.timer(t),s=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw s=!0,o?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||i?.()}}}var by=class{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){let{validators:n,selectors:i,peerRouting:o,queryManager:s,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=i,this.peerRouting=o,this.queryManager=s,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);let n=Xa(this.datastorePrefix,e);this.log("fetching record for key %k",n);let i=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);let o=$t.deserialize(i);return await ed(this.validators,o,t),o}async*sendCorrectionRecord(e,t,n,i){this.log("sendCorrection for %b",e);let o=Hb(e,n);for(let{value:s,from:a}of t){if(me(s,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Xa(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,o.subarray(),i)}catch(u){this.log.error("failed error correcting self - %e",u)}continue}let c=!1,l={type:ut.PUT_VALUE,key:e,record:o};for await(let u of this.network.sendRequest(a,l,i))u.name==="PEER_RESPONSE"&&u.record!=null&&me(u.record.value,$t.deserialize(o).value)&&(c=!0),yield u;if(!c)throw new ja("Could not send correction");this.log.error("failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);let i=Hb(e,t),o=Xa(this.datastorePrefix,e);this.log(`storing record for key ${o.toString()}`),await this.components.datastore.put(o,i.subarray(),n),yield*br(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),s=>Wt(s,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:ut.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&me(u.record.value,$t.deserialize(i).value)||c.push(lo({from:a.peer.id,error:new ja("Value not put correctly"),path:u.path},n)));return c}),s=>vn(s,{ordered:!1,concurrency:qa}),async function*(s){for await(let a of s)yield*a})}async*get(e,t){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;let i=n.map(a=>a.value),o=0;try{o=Wk(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}let s=i[o];if(this.log("GetValue %b %b",e,s),s==null)throw new je("Best value was not found");yield*this.sendCorrectionRecord(e,n,s,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[o]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let o=await this.getLocal(e,t);yield tm({value:o.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(o){this.log("error getting local value for %b",e,o)}let n=this,i=async function*({peer:o,signal:s,path:a}){for await(let c of n.peerRouting.getValueOrPeers(o.id,e,{...t,signal:s,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield tm({from:o.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,i,t)}};function Dl(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function vy(r){let e=Xe(nt.decode(`z${r}`));return ur(e)}var un=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Dl(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Dl(this.map.values(),e=>e.key)}values(){return Dl(this.map.values(),e=>e.value)}get size(){return this.map.size}};var fi=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Dl(this.set.entries(),e=>{let t=vy(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=vy(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Dl(this.set.values(),e=>vy(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function Vb(){return new fi}var Ey=class{filter;constructor(e,t){this.filter=Rr(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function zb(r,e=.001){return new Ey(r,e)}var Kb=class extends un{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Vs(r){let{name:e,metrics:t}=r,n;return t!=null?n=new Kb({name:e,metrics:t}):n=new un,n}function nP(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function am(r){if(r.id==null)throw new Error("Invalid peer in message");let e=Xe(r.id);return{id:ur(e),multiaddrs:(r.multiaddrs??[]).map(t=>se(t))}}var Sy=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:i,queryManager:o,routingTable:s,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=o,this.routingTable=s,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(f=>f.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);let i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);let o={type:ut.ADD_PROVIDER,key:i,providers:[nP({id:this.components.peerId,multiaddrs:t})]},s=0,a=this;async function*c(f){try{a.log("sending provider record for %s to %p",e,f.peer.id);for await(let h of a.network.sendMessage(f.peer.id,o,{...n,path:f.path}))h.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,f.peer.id),s++),yield h}catch(h){a.log.error("error sending provide record to peer %p - %e",f.peer.id,h),yield lo({from:f.peer.id,error:h,path:f.path},n)}}let l=xr({objectMode:!0}),u=new jt({concurrency:qa});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("failure",f=>{this.log.error("error publishing provider record to peer - %e",f.detail.error)}),u.add(async()=>{let f=[];for await(let h of this.peerRouting.getClosestPeers(i,n))l.push(h),h.name==="FINAL_PEER"&&f.push(h);f.forEach(h=>{u.add(async()=>{for await(let d of c(h))l.push(d)}).catch(d=>{this.log.error("error publishing provider record to peer - %e",d)})})}).catch(f=>{l.end(f)}),yield*l,this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,i=0,o=e.multihash.bytes,s=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e,t);if(a.length>0){let u=[];for(let f of a.slice(0,n))try{let h=await this.components.peerStore.get(f,t);u.push({id:f,multiaddrs:h.addresses.map(({multiaddr:d})=>d)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",f)}if(yield em({from:this.components.peerId,messageType:ut.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield Fb({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),i+=u.length,i>=n)return}let c=async function*({peer:u,signal:f,path:h}){let d={type:ut.GET_PROVIDERS,key:o};yield*s.network.sendRequest(u.id,d,{...t,signal:f,path:h})},l=new fi(a);for await(let u of this.queryManager.run(o,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);let f=[];for(let h of u.providers)l.has(h.id)||(l.add(h.id),f.push(h));if(f.length>0&&(yield Fb({from:u.from,providers:f,path:u.path},t),i+=f.length,i>=n))return}}};var Ay=class extends Ce{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new ao({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],o){return{...o,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((o,s)=>{i[`providers-${s}`]=o.id.toString()}),n.closer.length>0&&n.closer.forEach((o,s)=>{i[`closer-${s}`]=o.id.toString()})),i)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],o){return{...o,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((o,s)=>{i[`providers-${s}`]=o.id.toString()}),n.closer.length>0&&n.closer.forEach((o,s)=>{i[`closer-${s}`]=o.id.toString()})),i)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;let i=t.type;if(i==null)throw new O("Message type was missing");let o,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield $b({peer:e,path:n.path},n),o=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield Ub({to:e,type:i,path:n.path},n);let a=await this._writeReadMessage(o,t,n);o.close(n).catch(c=>{this.log.error("error closing stream to %p - %e",e,c),o?.abort(c)}),yield em({from:e,messageType:a.type,closer:a.closer.map(am),providers:a.providers.map(am),record:a.record==null?void 0:$t.deserialize(a.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),o?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield lo({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,n){if(!this.running)return;let i=t.type;if(i==null)throw new O("Message type was missing");let o,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield $b({peer:e,path:n.path},n),o=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield Ub({to:e,type:i,path:n.path},n),await this._writeMessage(o,t,n),o.close(n).catch(a=>{this.log.error("error closing stream to %p - %e",e,a),o?.abort(a)}),yield em({from:e,messageType:i,path:n.path},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),o?.abort(a),yield lo({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,n){await Tt(e).write(t,Wa,n)}async _writeReadMessage(e,t,n){let i=Tt(e);await i.write(t,Wa,n);let o=await i.read(Wa,n);return o.closer.forEach(s=>{this.safeDispatchEvent("peer",{detail:am(s)})}),o.providers.forEach(s=>{this.safeDispatchEvent("peer",{detail:am(s)})}),o}};function uo(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=Ft(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}function Ol(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}var Ya=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){let i=await Mn(e.id,n);this.addWithKadId(e,i,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;let i={peer:e,distance:uo(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){let s=this.peerDistances[this.peerDistances.length-1];if(s!=null&&Ol(i.distance,s.distance)!==-1)return}let o=!1;for(let s=0;s<this.peerDistances.length;s++){let a=Ol(this.peerDistances[s].distance,i.distance);if(a===0||a===1){o=!0,this.peerDistances.splice(s,0,i);break}}o||this.peerDistances.push(i),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;let n=await Mn(e,t),i=uo(n,this.originDhtKey),o=this.peerDistances[this.peerDistances.length-1].distance;return Ol(i,o)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}};var _y=class{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n,i=await this.routingTable.find(e,t);if(i!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(i,t)}catch(o){if(o.name!=="NotFoundError")throw o}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(o){if(o.name!=="NotFoundError")throw o}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(o=>o.multiaddr)}}async*_getValueSingle(e,t,n){let i={type:ut.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){let n=eP(e),i={index:-1,queued:0,running:0,total:0};for await(let o of this._getValueSingle(e,n,{...t,path:i}))if(yield o,o.name==="PEER_RESPONSE"&&o.record!=null){let s=er(o.record.value),a=Wo(s);if(!a.equals(e))throw new vs("public key does not match id");if(a.publicKey==null)throw new vs("public key missing");yield tm({from:e,value:o.record.value,path:i},t)}throw new ja(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let i=await this.findPeerLocal(e,t);if(i!=null){this.log("found local"),yield my({from:this.components.peerId,peer:i,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){let i=this,o=async function*({peer:s,signal:a,path:c}){let l={type:ut.FIND_NODE,key:e.toMultihash().bytes};for await(let u of i.network.sendRequest(s.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(h=>h.id.equals(e));f!=null&&(yield my({from:u.from,peer:f,path:u.path},t))}};for await(let s of this.queryManager.run(e.toMultihash().bytes,o,t))s.name==="FINAL_PEER"&&(n=!0),yield s}if(!n)throw new je("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Ga(e,t),i=new Ya(n,this.routingTable.kBucketSize),o=this,s=async function*({peer:a,path:c,peerKadId:l,signal:u}){o.log("getClosestPeers asking %p",a.id);let f={type:ut.FIND_NODE,key:e};yield*o.network.sendRequest(a.id,f,{...t,signal:u,path:c}),i.addWithKadId(a,l,c)};yield*this.queryManager.run(e,s,t),this.log("found %d peers close to %b",i.length,e);for(let{peer:a,path:c}of i.peers)try{if(a.multiaddrs.length===0&&(a=await o.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield my({from:this.components.peerId,peer:await o.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(let i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record,n)}catch{let s="invalid record received, discarded";this.log(s),yield lo({from:i.from,error:new ja(s),path:n.path},n);continue}yield i}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new dy("invalid record received");await ed(this.validators,new $t(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){let n=[];try{let s=Xe(e),a=ur(s),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}let i=await Ga(e,t),o=this.routingTable.closestPeers(i,t);for(let s of o)try{n.push(await this.components.peerStore.getInfo(s,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) we know to %b",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}};var Cy=class{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){let i=yy(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(i,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);let n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){let i=yy(this.datastorePrefix,e,t),o=sn(n?.time?.getTime()??Date.now());await this.datastore.put(i,o,n)}async loadProviders(e,t){let n=new un,i=yy(this.datastorePrefix,e);for await(let o of this.datastore.query({prefix:i.toString()},t)){let{peerId:s}=gy(o.key);n.set(s,wy(o.value))}return n}};async function*iP(r){let{key:e,startingPeers:t,ourPeerId:n,query:i,alpha:o,path:s,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:f}=r,h=xr({objectMode:!0}),d=new jt({concurrency:o,sort:(y,w)=>Ol(y.options.distance,w.options.distance)});d.addEventListener("idle",()=>{h.push(jk({path:{index:s,queued:d.queued,running:d.running,total:d.size}},r)),h.end()}),d.addEventListener("failure",y=>{c.error("error during query - %e",y.detail.error)});let m=()=>{d.abort(),h.end(new St)};f.addEventListener("abort",m);try{let w=function(x,v){if(x==null)return;l.add(x.id.toMultihash().bytes);let E=uo(v,y);d.add(async()=>{try{for await(let _ of i({...r,key:e,peer:x,path:{index:s,queued:d.queued,running:d.running,total:d.size},numPaths:a,peerKadId:v,signal:f})){if(_.name==="PEER_RESPONSE")for(let B of _.closer){if(l.has(B.id.toMultihash().bytes)){c("already seen %p in query",B.id);continue}if(n.equals(B.id)){c("not querying ourselves");continue}if(!await u.isDialable(B.multiaddrs)){c("not querying undialable peer");continue}let H=await Mn(B.id,{signal:f}),U=uo(H,y);if(Ol(U,E)!==-1){c("skipping %p as they are not closer to %b than %p",B.id,e,x.id);continue}c("querying closer peer %p",B.id),w(B,H)}h.push({..._,path:{index:s,queued:d.queued,running:d.running,total:d.size}})}}catch(_){h.push(lo({from:x.id,error:_,path:{index:s,queued:d.queued,running:d.running-1,total:d.size-1}},r))}},{distance:E}).catch(_=>{c.error("error during query - %e",_)})},y=await Ga(e,{signal:f});await Promise.all(t.map(async x=>{w({id:x,multiaddrs:[]},await Mn(x,{signal:f}))})),yield*h}finally{f.removeEventListener("abort",m)}}var Ty=class{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??uy,this.alpha=t.alpha??qa,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){let c=AbortSignal.timeout(Vk);n={...n,signal:c}}let i=new AbortController,o=Oe([this.shutDownController.signal,i.signal,n.signal]);i.signal;let s=this.logger.forComponent(`${this.logPrefix}:query:`+K(e,"base58btc")),a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(s("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await st(this.routingTable,"peer:add",{signal:o,filter:d=>!this.peerId.equals(d.detail)}),s("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(s("waiting for initial self query before continuing"),await Et(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),s("query:start");let c=await Ga(e,{signal:o}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((d,m,y)=>(d[y%this.disjointPaths].push(m),d),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(d=>d.length>0);if(l.length===0){s.error("running query with no peers");return}let f=Rr(1024),h=u.map((d,m)=>iP({...n,key:e,startingPeers:d,ourPeerId:this.peerId,signal:o,query:t,path:m,numPaths:u.length,alpha:this.alpha,log:s,peersSeen:f,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let d of bn(...h)){if(d.name==="QUERY_ERROR"&&s.error("query error - %e",d.error),d.name==="PEER_RESPONSE")for(let m of[...d.closer,...d.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:o})&&await this.routingTable.add(m.id,{signal:o});o.throwIfAborted(),yield d}a=!0}catch(c){if(this.running)throw c}finally{a||(s("query exited early"),i.abort()),o.clear(),s("query finished")}}};function yj(r){return r[Symbol.asyncIterator]!=null}function wj(r){if(yj(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var Iy=wj;function xj(r){return r[Symbol.asyncIterator]!=null}function bj(r,e){return xj(r)?(async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}})()}var Qa=bj;var ky=class{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??uy,this.interval=t.interval??Mk,this.initialInterval=t.initialInterval??Uk,this.queryTimeout=t.queryTimeout??Fk,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=xy(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=We(),this.running){this.controller=new AbortController;let e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){let n=AbortSignal.timeout(this.queryTimeout);e.push(n)}let t=Oe(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),i=await br(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>Qa(s,this.count),async s=>Iy(s));t?.throwIfAborted();let o=Date.now()-n;this.log("self-query found %d peers in %dms",i,o),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:i,duration:o}}))}catch(n){this.log.error("self-query error - %e",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.interval))}};var Py=class extends Ce{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new jt({concurrency:t.concurrency??Ok,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new ao({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??Dk,this.maxQueueSize=t.maxQueueSize??Nk,this.validity=t.validity??ly,this.interval=t.interval??Lk,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=xy(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Lb)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(let t of this.datastore.query({prefix:this.datastorePrefix},e))try{let{cid:n,peerId:i}=gy(t.key),s=wy(t.value).getTime()+this.validity,a=Date.now(),c=a>s,l=this.peerId.equals(i);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",a,s,c,c?"(expired)":"(valid)"),c&&!l&&await this.datastore.delete(t.key,e),this.shouldReprovide(l,s)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",n,this.reprovideThreshold),this.queueReprovide(n).catch(u=>{this.log.error("could not reprovide %c - %e",n,u)}))}catch(n){this.log.error("error processing datastore key %s - %s",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Lb)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;let n=Date.now();return t<n?!0:t-n<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);let n=this.reprovideQueue.queue.find(i=>i.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async i=>{if(i.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);let o=this.reprovideTimeout.getTimeoutSignal(i);try{await this.reprovide(i.cid,i)}finally{this.reprovideTimeout.cleanUp(o)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(i=>{this.log.error("could not re-provide key %c - %e",e,i)})}async reprovide(e,t){await ln(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}};var vj=20,Ej=5e3,Sj="kad-close",Aj=50,Ry=class{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??Ej,this.peerSetSize=t.peerSetSize??vj,this.closeTagName=t.closeTagName??Sj,this.closeTagValue=t.closeTagValue??Aj,this.closestPeers=new fi,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;let e=await Mn(this.components.peerId);this.newPeers=new Ya(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){let e=new fi(this.newPeers?.peers.map(({peer:i})=>i.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:{value:this.closeTagValue},[Bb]:{value:1}}})}),...[...n].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:void 0,[Bb]:void 0}})})])}};function cm(r){return Array.isArray(r?.peers)}var Dy=class{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??oP,this.kBucketSize=t.kBucketSize??lm,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??sP,this.lastPingThreshold=t.lastPingThreshold??aP,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Vs({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Mn(e,t),lastPing:Date.now()}}async add(e,t){let n={peerId:e,kadId:await Mn(e,t),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{let o=this._add(n,t);this.addingPeerMap.set(e,o),await o}finally{this.addingPeerMap.delete(e)}}async _add(e,t){let n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!Cj(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}let i=n.peers.filter(s=>!(s.peerId.equals(this.localPeer?.peerId)||s.lastPing>Date.now()-this.lastPingThreshold)).sort((s,a)=>s.lastPing<a.lastPing?-1:s.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing),o=!1;for await(let s of this.ping(i,t))o=!0,await this.remove(s.kadId,t);o&&await this._add(e,t)}*closest(e,t){let n=new Ya(e,t?.count??this.kBucketSize);for(let i of this.toIterable())t?.exclude?.some(o=>o.equals(i.peerId))!==!0&&n.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*Wt(n.peers,({peer:i})=>i.id)}count(){function e(t){if(cm(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){let t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){let n=this._determineBucket(e),i=this._indexOf(n,e);if(i>-1){let o=n.peers.splice(i,1)[0];await this.onRemove?.(o,n,t)}}*toIterable(){function*e(t){if(cm(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+K(uo(e,t),"base16"))}_determineBucket(e){let t=K(e,"base2");function n(i,o=0){return cm(i)?i:t[o]==="0"?n(i.left,o+1):n(i.right,o+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>me(n.kadId,t))}async _split(e,t){let n={prefix:"0",depth:e.depth+1,peers:[]},i={prefix:"1",depth:e.depth+1,peers:[]};for(let o of e.peers)K(o.kadId,"base2")[e.depth]==="0"?(n.peers.push(o),await this.onMove?.(o,e,n,t)):(i.peers.push(o),await this.onMove?.(o,e,i,t));_j(e,n,i)}};function _j(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function Cj(r,e){return r.lastPing<Date.now()-e}var lm=20,oP=6;var Tj=20,Ij=100,sP=3;var kj=20,Pj=100,cP="kad-peer",Rj=1,aP=6e5,Dj=!0,Oj=1e3,Oy=class extends Ce{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??lm,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??cP,this.peerTagValue=t.peerTagValue??Rj,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??Dj,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??Oj,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new Kr({concurrency:t.pingOldContactConcurrency??kj,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??Pj}),this.pingOldContactTimeout=new ao({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Kr({concurrency:t.pingNewContactConcurrency??Tj,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??Ij}),this.pingNewContactTimeout=new ao({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new Dy(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new Ry(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await wr(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=Oe([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(let n of await this.components.peerStore.all({filters:[i=>i.protocols.includes(this.protocol)&&i.tags.has(cP)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await Cr(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;let n=[];for(let i of e){if(this.kb.get(i.kadId)==null){this.log("asked to ping contact %p that was not in routing table",i.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{let o=this.pingOldContactQueue.find(i.peerId);if(o!=null)return this.log("asked to ping contact %p was already being pinged",i.peerId),await o.join(t)?void 0:i;if(!await this.pingOldContactQueue.add(async a=>{let c=this.pingOldContactTimeout.getTimeoutSignal(),l=Oe([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(i,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:i.peerId,signal:t?.signal}))return i})}for await(let i of vn(n))i!=null&&(yield i)}async verifyNewContact(e,t){let n=this.pingNewContactTimeout.getTimeoutSignal(),i=Oe([n,this.shutdownController.signal,t?.signal]);try{let o=this.pingNewContactQueue.find(e.peerId);return o!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await o.join({signal:i})):await this.pingNewContactQueue.add(async s=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,s)),{peerId:e.peerId,signal:i})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),i.clear()}}async pingContact(e,t){let n;try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(i){return this.log("error pinging old contact %p - %e",e.peerId,i),n?.abort(i),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){let n=await Mn(e,t);return this.kb.get(n)?.peerId}closestPeer(e){let t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await Mn(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,i=20,o=0;function s(a){if(cm(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<i&&(i=a.peers.length),a.peers.length>o&&(o=a.peers.length);return}s(a.left),s(a.right)}s(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(i),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(n)}};var lP=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var Ny=15,Ly=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:i,refreshInterval:o,refreshQueryTimeout:s,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=i,this.refreshInterval=o??$k,this.refreshQueryTimeout=s??Hk,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");let n=this._maxCommonPrefix(),i=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${i.map(o=>o.toISOString()).join(", ")} ]`),Promise.all(i.map(async(o,s)=>{try{if(await this._refreshCommonPrefixLength(s,o,e,t),this._numPeersForCpl(n)===0){let a=Math.min(2*(s+1),i.length-1);for(let c=s+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,o,e,t)}catch(l){this.log.error("failed to refresh entries with common prefix length %d - %e",c,l)}}}catch(a){this.log.error("failed to refresh entries with common prefix length - %e",a)}})).catch(o=>{this.log.error("failed to refresh table - %e",o)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(o=>{this.log.error("failed to set refresh timeout - %e",o)})}async _refreshCommonPrefixLength(e,t,n,i){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let o=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,o,this.routingTable.size);let s=Oe([i?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{let a=await Iy(this.peerRouting.getClosestPeers(o.toMultihash().bytes,{signal:s}));this.log(`found ${a} peers that were close to imaginary peer %p`,o),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,o,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Ny&&(e=Ny);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");let t=wn(2),n=(t[1]<<8)+t[0],i=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),o=Xe(i);return ur(o)}_makePeerId(e,t,n){if(n>Ny)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Ny}`);let s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=s&a|t&~a,l=lP[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,ze.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=uo(this.routingTable.kb.localPeer.kadId,e),n=0;for(let i of t)if(i===0)n++;else break;yield n}}};var By=class{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Ue("Missing key");let n;try{n=j.decode(t.key)}catch{throw new Ue("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async i=>{let o=Xe(i.id),s=ur(o),a=i.multiaddrs.map(c=>se(c));if(!e.equals(s)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,s),await this.peerStore.merge(s,{multiaddrs:a})}))}};var My=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Ue("Invalid FIND_NODE message received - key was missing");let n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});me(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(o=>o.decapsulateCode(421))});let i={type:ut.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:o})=>o.length).map(o=>({id:o.id.toMultihash().bytes,multiaddrs:o.multiaddrs.map(s=>s.bytes)})),providers:[]};return i.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",i.closer.length,t.key,e),i}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}};function Lj(r){return r[Symbol.asyncIterator]!=null}function Bj(r){if(Lj(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var fo=Bj;var Uy=class{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:i,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Ue("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=j.decode(t.key)}catch{throw new Ue("Invalid CID")}this.log("%p asking for providers for %s",e,n);let[i,o]=await Promise.all([fo(Wt(await this.providers.getProviders(n),async a=>{let c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),s={type:ut.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:o.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",s.providers.length,s.closer.length),s}async _getAddresses(e){return[]}};var Fy=class{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Ue("Invalid key");let i={type:ut.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(tP(n)){this.log("is public key");let a=rP(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new je("No public key found in key book");c=ar(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new $t(n,c,new Date).serialize(),i}let[o,s]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return o!=null&&(this.log("had record for %b in local datastore",n),i.record=o.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),i.closer=s.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=Xa(this.datastorePrefix,e),n;try{n=await this.datastore.get(t)}catch(o){if(o.name==="NotFoundError")return;throw o}let i=$t.deserialize(n);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>ly){await this.datastore.delete(t);return}return i}};var $y=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var Hy=class{components;validators;log;datastorePrefix;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null)throw this.log.error("empty record from %p",e),new Ue(`Empty record from: ${e}`);try{let i=$t.deserialize(t.record);await ed(this.validators,i),i.timeReceived=new Date;let o=Xa(this.datastorePrefix,i.key);await this.components.datastore.put(o,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,o)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}};var Vy=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[ut.GET_VALUE.toString()]:new Fy(e,t),[ut.PUT_VALUE.toString()]:new Hy(e,t),[ut.FIND_NODE.toString()]:new My(e,t),[ut.ADD_PROVIDER.toString()]:new By(e,t),[ut.GET_PROVIDERS.toString()]:new Uy(e,t),[ut.PING.toString()]:new $y(e,t)}}async handleMessage(e,t){let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}async onIncomingStream(e,t){let n=()=>{e.abort(new Lo)},i=AbortSignal.timeout(this.incomingMessageTimeout);i.addEventListener("abort",n);let o=Tt(e).pb(Wa);for(;;){if(e.readStatus!=="readable"){await e.close({signal:i});break}let s=await o.read({signal:i}),a=this.metrics?.rpcTime?.timer(s.type.toString()),c=this.metrics?.rpcTime?.timer(s.type.toString()),l=!1;try{this.log("incoming %s from %p",s.type,t.remotePeer);let u=await this.handleMessage(t.remotePeer,s);u!=null&&await o.write(u,{signal:i})}catch(u){throw l=!0,c?.(),u}finally{l||a?.()}i.removeEventListener("abort",n),i=AbortSignal.timeout(this.incomingMessageTimeout),i.addEventListener("abort",n)}}};var zy=class extends Ce{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:i}=t;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var qb=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await ln(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers.map(i=>({...i,routing:"kad-dht"})))}async put(e,t,n){await ln(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new je("Could not find value for key")}},jb=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new je("Peer not found")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},Mj=32,Uj=64,Ky=class extends Ce{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();let n=t.logPrefix??"libp2p:kad-dht",i=t.datastorePrefix??"/dht",o=t.metricsPrefix??"libp2p_kad_dht",s={queries:e.metrics?.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??lm,this.a=t.alpha??qa,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??Rk,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??Mj,this.maxOutboundStreams=t.maxOutboundStreams??Uj,this.peerInfoMapper=t.peerInfoMapper??Jk,this.onPeerConnectTimeout=t.onPeerConnectTimeout??Bk,this.providers=new Cy(e,{...t.providers,logPrefix:n,datastorePrefix:i}),this.validators={...Xk,...t.validators},this.selectors={...Gk,...t.selectors},this.network=new Ay(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:o}),this.routingTable=new Oy(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:o,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});let a=We();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new Ty(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:o,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new _y(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new by(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:i}),this.contentRouting=new Sy(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new Ly(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new Vy(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:o,datastorePrefix:i,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new zy(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new ky(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:s}),this.reprovider=new Py(e,{...t.reprovide,logPrefix:n,metricsPrefix:o,datastorePrefix:i,contentRouting:this.contentRouting,operationMetrics:s}),this.network.addEventListener("peer",c=>{let l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table - %e",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{let l=c.detail;Promise.resolve().then(async()=>{let u=await this.components.peerStore.get(l),f={id:l,multiaddrs:u.addresses.map(({multiaddr:h})=>h),protocols:u.protocols};await this.onPeerConnect(f)}).catch(u=>{this.log.error("could not add %p to routing table - %e",l,u)})}),this.dhtPeerRouting=new jb(this),this.dhtContentRouting=new qb(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let l=c.detail.peer.addresses.some(({multiaddr:f})=>!qt(f)&&!Or.exactMatch(f)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode - %e",l)})}),this.get=Rl(this.get.bind(this),s,"GET_VALUE"),this.findProviders=Rl(this.findProviders.bind(this),s,"FIND_PROVIDERS"),this.findPeer=Rl(this.findPeer.bind(this),s,"FIND_PEER"),this.getClosestPeers=Rl(this.getClosestPeers.bind(this),s,"GET_CLOSEST_PEERS"),this.provide=Rl(this.provide.bind(this),s,"PROVIDE"),this.put=Rl(this.put.bind(this),s,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[Ge]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[ni]=["@libp2p/identify","@libp2p/ping"];get[Do](){return this.dhtContentRouting}get[Bo](){return this.dhtPeerRouting}get[jc](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id,e.multiaddrs),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}let t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table - %e",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await wr(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await wr(this.querySelf))}async stop(){this.running=!1,await Cr(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}};var uP;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(uP||(uP={}));function fP(r={}){return e=>new Ky(e,r)}var um;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.keyName!=null&&t.keyName!==""&&(n.uint32(10),n.string(t.keyName)),t.lifetime!=null&&t.lifetime!==0&&(n.uint32(16),n.uint32(t.lifetime)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={keyName:"",lifetime:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.keyName=t.string();break}case 2:{o.lifetime=t.uint32();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(um||(um={}));function qy(r,e){return{async put(t,n,i={}){try{let o=Np(t);try{let c=await r.get(o),l=$t.deserialize(c);if(me(l.value,n))return}catch(c){if(c.name!=="NotFoundError")throw c}let s=new $t(t,n,new Date);i.onProgress?.(new G("ipns:routing:datastore:put"));let a=r.batch();a.put(o,s.serialize()),i.metadata!=null&&a.put(S2(t),um.encode(i.metadata)),await a.commit(i)}catch(o){throw i.onProgress?.(new G("ipns:routing:datastore:error",o)),o}},async get(t,n={}){try{let i=Np(t);n.onProgress?.(new G("ipns:routing:datastore:get"));let o=await r.get(i,n),s=$t.deserialize(o);return{record:s.value,created:s.timeReceived}}catch(i){throw n.onProgress?.(new G("ipns:routing:datastore:error",i)),i}},async has(t,n={}){let i=Np(t);return r.has(i,n)},async delete(t,n){let i=Np(t),o=r.batch();o.delete(i),o.delete(S2(t)),await o.commit(n)},async*list(t={}){try{t.onProgress?.(new G("ipns:routing:datastore:list"));for await(let{key:n,value:i}of r.query({prefix:E2},t))try{let o=$t.deserialize(i),a=n.toString().substring(E2.length),c=R(a,"base32"),l=S2(c),u;try{let f=await r.get(l,t);u=um.decode(f)}catch(f){e.error("Error deserializing metadata for %s - %e",a,f)}yield{routingKey:c,metadata:u,record:o.value,created:o.timeReceived}}catch(o){e.error("Error deserializing record - %e",o)}}catch(n){throw t.onProgress?.(new G("ipns:routing:datastore:error",n)),n}}}}var Wb=class{routing;constructor(e){this.routing=e}async put(e,t,n={}){try{await this.routing.put(e,t,n)}catch(i){throw n.onProgress?.(new G("ipns:routing:helia:error",i)),i}}async get(e,t={}){try{return await this.routing.get(e,t)}catch(n){throw t.onProgress?.(new G("ipns:routing:helia:error",n)),n}}};function fm(r){return new Wb(r)}function jy(r){return{async put(e,t,n){await r.put(e,t,n)},async get(e,t){let{record:n}=await r.get(e,t);return n}}}var Wy=class{routers;publisher;republisher;resolver;localStore;started;constructor(e,t={}){this.localStore=qy(e.datastore,e.logger.forComponent("helia:ipns:local-store")),this.started=e.libp2p.status==="started",this.routers=[jy(this.localStore),fm(e.routing),...t.routers??[]],this.publisher=new A2(e,{...t,routers:this.routers,localStore:this.localStore}),this.republisher=new ty(e,{...t,routers:this.routers,localStore:this.localStore}),this.resolver=new Mf(e,{...t,routers:this.routers,localStore:this.localStore}),e.events.addEventListener("start",this.start.bind(this)),e.events.addEventListener("stop",this.stop.bind(this)),this.started&&this.republisher.start()}start(){this.started||(this.started=!0,this.republisher.start())}stop(){this.started&&(this.started=!1,this.republisher.stop())}async publish(e,t,n={}){return this.publisher.publish(e,t,n)}async resolve(e,t={}){return this.resolver.resolve(e,t)}async unpublish(e,t){return this.publisher.unpublish(e,t)}};function dP(r,e={}){return new Wy(r,e)}function hP(r,e={}){let t=qy(r.datastore,r.logger.forComponent("helia:ipns:local-store")),n=[jy(t),fm(r.routing),...e.routers??[]];return new Mf(r,{routers:n,localStore:t})}var di=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function An(r,e,t,n){let i=new di(n?.errorMessage);n?.errorCode!=null&&(i.code=n.errorCode);let o=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(i):new Promise((s,a)=>{function c(){Xb(t,"abort",f),Xb(r,e,l),Xb(r,o,u)}let l=h=>{try{if(n?.filter?.(h)===!1)return}catch(d){c(),a(d);return}c(),s(h)},u=h=>{if(c(),h instanceof Error){a(h);return}a(h.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},f=()=>{c(),a(i)};Gb(t,"abort",f),Gb(r,e,l),Gb(r,o,u)})}function Gb(r,e,t){r!=null&&(pP(r)?r.addEventListener(e,t):r.addListener(e,t))}function Xb(r,e,t){r!=null&&(pP(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function pP(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}var dm="/ipfs/bitswap/1.2.0";var tr;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(tr||(tr={}));var Yb;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(Yb||(Yb={}));(function(r){r.codec=()=>_t(Yb)})(tr||(tr={}));var td;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),tr.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={cid:ke(0),priority:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.cid=t.bytes();break}case 2:{o.priority=t.int32();break}case 3:{o.cancel=t.bool();break}case 4:{o.wantType=tr.codec().decode(t);break}case 5:{o.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(td||(td={}));var Gy;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(let o of t.entries)n.uint32(10),td.codec().encode(o,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={entries:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.entries!=null&&o.entries.length===i.limits.entries)throw new yt('Decode error - map field "entries" had too many elements');o.entries.push(td.codec().decode(t,t.uint32(),{limits:i.limits?.entries$}));break}case 2:{o.full=t.bool();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Gy||(Gy={}));var rd;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={prefix:ke(0),data:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.prefix=t.bytes();break}case 2:{o.data=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(rd||(rd={}));var Oi;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Oi||(Oi={}));var Xy;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(Xy||(Xy={}));(function(r){r.codec=()=>_t(Xy)})(Oi||(Oi={}));var nd;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&Xy[t.type]!==0&&(n.uint32(16),Oi.codec().encode(t.type,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={cid:ke(0),type:Oi.HaveBlock},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.cid=t.bytes();break}case 2:{o.type=Oi.codec().decode(t);break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(nd||(nd={}));var Nl;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),Gy.codec().encode(t.wantlist,n)),t.blocks!=null)for(let o of t.blocks)n.uint32(26),rd.codec().encode(o,n);if(t.blockPresences!=null)for(let o of t.blockPresences)n.uint32(34),nd.codec().encode(o,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={blocks:[],blockPresences:[],pendingBytes:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.wantlist=Gy.codec().decode(t,t.uint32(),{limits:i.limits?.wantlist});break}case 3:{if(i.limits?.blocks!=null&&o.blocks.length===i.limits.blocks)throw new yt('Decode error - map field "blocks" had too many elements');o.blocks.push(rd.codec().decode(t,t.uint32(),{limits:i.limits?.blocks$}));break}case 4:{if(i.limits?.blockPresences!=null&&o.blockPresences.length===i.limits.blockPresences)throw new yt('Decode error - map field "blockPresences" had too many elements');o.blockPresences.push(nd.codec().decode(t,t.uint32(),{limits:i.limits?.blockPresences$}));break}case 5:{o.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Nl||(Nl={}));function mP(r,e){for(let[t,n]of e.wantlist.entries()){let i=r.wantlist.get(t);i!=null&&(i.priority>n.priority&&(n.priority=i.priority),n.cancel=n.cancel??i.cancel,n.wantType=n.wantType??i.wantType,n.sendDontHave=n.sendDontHave??i.sendDontHave),r.wantlist.set(t,n)}for(let[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(let[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}var Yy=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var Fj=4193648,$j=Fj+16;function*gP(r,e){let t=[...r.wantlist.values()],n=[...r.blockPresences.values()],i=[...r.blocks.values()],o=0,s=0,a=0,c=!1;for(;;){let l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},u=Nl.encode(l).byteLength,{added:f,hasMore:h,newSize:d}=Qb(i,l.blocks,a,e,u,Hj);a+=f,u=d;let m=h;({added:f,hasMore:h,newSize:d}=Qb(n,l.blockPresences,s,e,u,Vj)),s+=f,u=d;let y=h;if({added:f,hasMore:h,newSize:d}=Qb(t,l.wantlist.entries,o,e,u,zj),o+=f,u=d,c=!m&&!y&&!h,c||(l.wantlist.full=!1),yield Nl.encode(l),c)break}}function Qb(r,e,t,n,i,o){let s=0,a=!1;for(let c=t;c<r.length;c++){let l=r[c],u=o(l);if(u>$j)throw new Yy("Cannot send block as after encoding it is over the max message size");let f=i+u;if(f>n){a=!0;break}e.push(l),s++,i=f}return{hasMore:a,added:s,newSize:i}}function Hj(r){return Zb(3,rd.encode(r))}function Vj(r){return Zb(4,nd.encode(r))}function zj(r){return Zb(1,td.encode(r))}function Zb(r,e){let t=Ke(r),n=Ke(e.byteLength);return t+n+e.byteLength}var Qy=class extends Ce{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[dm],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Kr({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e,t){this.running&&Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",e.protocol,t.remotePeer);let n=()=>{e.status==="open"?e.abort(new Lo(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",e.status)},i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",n),await e.close({signal:i});let o=xr();e.addEventListener("message",s=>{o.push(s.data)}),e.addEventListener("remoteCloseWrite",()=>{o.end()}),e.addEventListener("close",s=>{s.error!=null&&o.end(s.error)});for await(let s of Cl(o,{maxDataLength:this.maxIncomingMessageSize}))try{let a=Nl.decode(s);this.log("incoming new bitswap %s message from %p on stream",e.protocol,t.remotePeer,e.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:t.remotePeer,message:a}}),i.removeEventListener("abort",n),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",n)}catch(a){this.log.error("error reading incoming bitswap message from %p on stream - %e",t.remotePeer,e.id,a),e.abort(a);break}}).catch(n=>{this.log.error("error handling incoming stream from %p - %e",t.remotePeer,n),e.abort(n)})}async*findProviders(e,t){t?.onProgress?.(new G("bitswap:find-providers",e));for await(let n of this.routing.findProviders(e,t)){if(!await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})){this.log("skipping peer %p as they are not dialable - %a[]",n.id,n.multiaddrs);continue}t?.onProgress?.(new G("bitswap:found-provider",{type:"bitswap",cid:e,provider:n,routing:n.routing})),yield n}}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(i=>{this.log.error("could not connect to supplied provider - %e",i)}))),await ln(Wt(Qa(this.findProviders(e,t),t?.maxProviders??3),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");let i=this.sendQueue.queue.find(o=>e.equals(o.options.peerId)&&o.status==="queued");if(i!=null){i.options.message=mP(i.options.message,t),await i.join({signal:n?.signal});return}await this.sendQueue.add(async o=>{let s=o?.message;if(s==null)throw new O("No message to send");this.log("sendMessage to %p",e),o?.onProgress?.(new G("bitswap:network:send-wantlist",e));let a=await this.libp2p.dialProtocol(e,dm,o);await a.closeRead();try{for(let c of gP(s,this.maxOutgoingMessageSize))a.send($s.single(c))||await a.onDrain(o);await a.close(o)}catch(c){o?.onProgress?.(new G("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p - %e",e,c),a.abort(c)}this._updateSentStats(s.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new ri("Network isn't running");t?.onProgress?.(new G("bitswap:network:dial",e));let[n]=await Promise.all([this.libp2p.dial(e,t),An(this.libp2p,"peer:identify",t?.signal,{filter:i=>{if(!i.detail.peerId.equals(e))return!1;if(i.detail.protocols.includes(dm))return!0;throw new nf(`${e} did not support ${dm}`)}})]);return n}_updateSentStats(e){let t=0;for(let n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};function Zj(r){return r[Symbol.asyncIterator]!=null}function Jj(r){if(Zj(r))return(async()=>{let n=new Uint8Array(0);for await(let i of r)n=it([n,i],n.length+i.length);return n})();let e=[],t=0;for(let n of r)e.push(n),t+=n.byteLength;return it(e,t)}var Ne=Jj;var zs=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let n=sr.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){let n=sr.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){let n=sr.encode(e.multihash.bytes);this.blocks.set(n,t)}};function eW(r){let e=new Uint8Array(r.reduce((n,i)=>n+Ke(i),0)),t=0;for(let n of r)e=sn(n,e,t),t+=Ke(n);return e}var yP=eW;function Jb(r){return yP([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}var Zy=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new zs,n=new Set;for(let[i,o]of this.wants.entries())try{let s=await Ne(this.blockstore.get(o.cid,e));o.wantType===tr.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",o.cid),n.add(i),t.addBlock(o.cid,{data:s,prefix:Jb(o.cid)})):(this.log("sending have for %c",o.cid),t.addBlockPresence(o.cid,{cid:o.cid.bytes,type:Oi.HaveBlock})):(this.log("sending block for %c",o.cid),n.add(i),t.addBlock(o.cid,{data:s,prefix:Jb(o.cid)}))}catch(s){if(s.name!=="NotFoundError")throw s;if(this.log("do not have block for %c",o.cid),!o.sendDontHave||o.sentDoNotHave===!0)continue;o.sentDoNotHave=!0,t.addBlockPresence(o.cid,{cid:o.cid.bytes,type:Oi.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,o)=>i+o.data.byteLength,0));for(let i of n)this.wants.delete(i)}}};var Jy=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Vs({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new Zy({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((i,o)=>i+o.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(let i of t.wantlist.entries){let o=j.decode(i.cid),s=K(o.multihash.bytes,"base64");i.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),n.wants.delete(s)):(i.wantType===tr.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),n.wants.set(s,{cid:o,priority:i.priority,wantType:i.wantType??tr.WantBlock,sendDontHave:i.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){let n=K(e.multihash.bytes,"base64"),i=[];for(let o of this.ledgerMap.values())o.wants.has(n)&&i.push(o);await Promise.all(i.map(async o=>o.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};var t9=bt(xP(),1);var r9=class r extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,r)}},bP=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function n9(r,e){let{milliseconds:t,fallback:n,message:i,customTimers:o={setTimeout,clearTimeout},signal:s}=e,a,c,u=new Promise((f,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(s?.aborted){h(bP(s));return}if(s&&(c=()=>{h(bP(s))},s.addEventListener("abort",c,{once:!0})),r.then(f,h),t===Number.POSITIVE_INFINITY)return;let d=new r9;a=o.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(m){h(m)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?f():i instanceof Error?h(i):(d.message=i??`Promise timed out after ${t} milliseconds`,h(d))},t)}).finally(()=>{u.clear(),c&&s&&s.removeEventListener("abort",c)});return u.clear=()=>{o.clearTimeout.call(void 0,a),a=void 0},u}function i9(r,e,t){let n=0,i=r.length;for(;i>0;){let o=Math.trunc(i/2),s=n+o;t(r[s],e)<=0?(n=++s,i-=o+1):i=o}return n}var pm=class{#e=[];enqueue(e,t){let{priority:n=0,id:i}=t??{},o={priority:n,id:i,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(o);return}let s=i9(this.#e,o,(a,c)=>c.priority-a.priority);this.#e.splice(s,0,o)}setPriority(e,t){let n=this.#e.findIndex(o=>o.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[i]=this.#e.splice(n,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var Ks=class extends t9.default{#e;#t;#r=0;#n;#i=!1;#o=!1;#c;#a=0;#d=0;#u;#f;#s;#m;#l=0;#g;#h;#C=1n;#y=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:pm,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#n=e.intervalCap,this.#c=e.interval,this.#s=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#h=e.autoStart===!1,this.#N()}get#T(){return this.#t||this.#r<this.#n}get#I(){return this.#l<this.#g}#k(){this.#l--,this.#l===0&&this.emit("pendingZero"),this.#x(),this.emit("next")}#P(){this.#A(),this.#S(),this.#f=void 0}get#R(){let e=Date.now();if(this.#u===void 0){let t=this.#a-e;if(t<0){if(this.#d>0){let n=e-this.#d;if(n<this.#c)return this.#v(this.#c-n),!0}this.#r=this.#e?this.#l:0}else return this.#v(t),!0}return!1}#v(e){this.#f===void 0&&(this.#f=setTimeout(()=>{this.#P()},e))}#E(){this.#u&&(clearInterval(this.#u),this.#u=void 0)}#D(){this.#f&&(clearTimeout(this.#f),this.#f=void 0)}#x(){if(this.#s.size===0)return this.#E(),this.emit("empty"),this.#l===0&&(this.#D(),this.emit("idle")),!1;let e=!1;if(!this.#h){let t=!this.#R;if(this.#T&&this.#I){let n=this.#s.dequeue();this.#t||(this.#r++,this.#w()),this.emit("active"),this.#d=Date.now(),n(),t&&this.#S(),e=!0}}return e}#S(){this.#t||this.#u!==void 0||(this.#u=setInterval(()=>{this.#A()},this.#c),this.#a=Date.now()+this.#c)}#A(){this.#r===0&&this.#l===0&&this.#u&&this.#E(),this.#r=this.#e?this.#l:0,this.#b(),this.#w()}#b(){for(;this.#x(););}get concurrency(){return this.#g}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#g=e,this.#b()}async#O(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#s.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#C++).toString(),t={timeout:this.timeout,...t},new Promise((n,i)=>{let o=Symbol(`task-${t.id}`);this.#s.enqueue(async()=>{this.#l++,this.#y.set(o,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});try{try{t.signal?.throwIfAborted()}catch(c){throw this.#t||this.#r--,this.#y.delete(o),c}let s=e({signal:t.signal});t.timeout&&(s=n9(Promise.resolve(s),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#l} running, ${this.#s.size} waiting)`})),t.signal&&(s=Promise.race([s,this.#O(t.signal)]));let a=await s;n(a),this.emit("completed",a)}catch(s){i(s),this.emit("error",s)}finally{this.#y.delete(o),queueMicrotask(()=>{this.#k()})}},t),this.emit("add"),this.#x()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#h?(this.#h=!1,this.#b(),this):this}pause(){this.#h=!0}clear(){this.#s=new this.#m,this.#_()}async onEmpty(){this.#s.size!==0&&await this.#p("empty")}async onSizeLessThan(e){this.#s.size<e||await this.#p("next",()=>this.#s.size<e)}async onIdle(){this.#l===0&&this.#s.size===0||await this.#p("idle")}async onPendingZero(){this.#l!==0&&await this.#p("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#p("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#p("rateLimitCleared")}async onError(){return new Promise((e,t)=>{let n=i=>{this.off("error",n),t(i)};this.on("error",n)})}async#p(e,t){return new Promise(n=>{let i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})}get size(){return this.#s.size}sizeBy(e){return this.#s.filter(e).length}get pending(){return this.#l}get isPaused(){return this.#h}#N(){this.#t||(this.on("add",()=>{this.#s.size>0&&this.#w()}),this.on("next",()=>{this.#w()}))}#w(){this.#t||this.#o||(this.#o=!0,queueMicrotask(()=>{this.#o=!1,this.#_()}))}#_(){let e=this.#i,t=!this.#t&&this.#r>=this.#n&&this.#s.size>0;t!==e&&(this.#i=t,this.emit(t?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#i}get isSaturated(){return this.#l===this.#g&&this.#s.size>0||this.isRateLimited&&this.#s.size>0}get runningTasks(){return[...this.#y.values()].map(e=>({...e}))}};function t3(r){let e=[dn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var o9=60;function r3(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:dn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:dn[e.type],TTL:e.TTL??e.ttl??o9,data:e.data instanceof Uint8Array?K(e.data):e.data}))}}var nW=4;function s9(r,e={}){let t=new Ks({concurrency:e.queryConcurrency??nW});return async(n,i={})=>{let o=new URLSearchParams;o.set("name",n),t3(i.types).forEach(a=>{o.append("type",dn[a])}),i.onProgress?.(new G("dns:query",n));let s=await t.add(async()=>{let a=await fetch(`${r}?${o}`,{headers:{accept:"application/dns-json"},signal:i?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=r3(await a.json());return i.onProgress?.(new G("dns:response",c)),c},{signal:i.signal});if(s==null)throw new Error("No DNS response received");return s}}function vP(){return[s9("https://cloudflare-dns.com/dns-query"),s9("https://dns.google/resolve")]}var AP=bt(SP(),1);var a9=class{lru;constructor(e){this.lru=(0,AP.default)(e)}get(e,t){let n=!0,i=[];for(let o of t){let s=this.getAnswers(e,o);if(s.length===0){n=!1;break}i.push(...s)}if(n)return r3({answers:i})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,i=this.lru.get(n);if(i!=null){let o=i.filter(s=>s.expires>Date.now()).map(({expires:s,value:a})=>({...a,TTL:Math.round((s-Date.now())/1e3),type:dn[a.type]}));return o.length===0&&this.lru.remove(n),o}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(n)??[];i.push({expires:Date.now()+(t.TTL??o9)*1e3,value:t}),this.lru.set(n,i)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function _P(r){return new a9(r)}var iW=1e3,n3=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=_P(e.cacheSize??iW),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=vP())}async query(e,t={}){let n=t3(t.types),i=t.cached!==!1?this.cache.get(e,n):void 0;if(i!=null)return t.onProgress?.(new G("dns:cache",i)),i;let o=`${e.split(".").pop()}.`,s=(this.resolvers[o]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of s){if(t.signal?.aborted===!0)break;try{let l=await c(e,{...t,types:n});for(let u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new G("dns:error",l))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var dn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(dn||(dn={}));var CP=32;function Ll(r={}){return new n3(r)}function i3({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*oW(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(let[t,n]of e.entries()){let i=[...r,t],o=j.asCID(n);o!=null?yield[i.join("/"),o]:typeof n=="object"&&(yield*c9(n,i))}else{let t=j.asCID(e);t!=null?yield[r.join("/"),t]:yield*c9(e,r)}}function*c9(r,e){if(r==null||r instanceof Uint8Array)return;let t=j.asCID(r);t!=null&&(yield[e.join("/"),t]);for(let[n,i]of Object.entries(r)){let o=[...e,n];yield*oW(o,i)}}function*sW(r,e){if(Array.isArray(e))for(let[t,n]of e.entries()){let i=[...r,t];yield i.join("/"),typeof n=="object"&&j.asCID(n)==null&&(yield*l9(n,i))}else yield*l9(e,r)}function*l9(r,e){if(!(r==null||typeof r!="object"))for(let[t,n]of Object.entries(r)){let i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&j.asCID(n)==null&&(yield*sW(i,n))}}function aW(r,e){let t=r;for(let[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(s=>`[${JSON.stringify(s)}]`).join("")}`);let o=j.asCID(t);if(o!=null)return{value:o,remaining:e.slice(n+1).join("/")}}return{value:t}}var u9=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:i3(),bytes:i3(),value:i3(),asBlock:i3()})}links(){return c9(this.value,[])}tree(){return l9(this.value,[])}get(e="/"){return aW(this.value,e.split("/").filter(Boolean))}};function Za({bytes:r,cid:e,value:t,codec:n}){let i=t!==void 0?t:n?.decode(r);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new u9({cid:e,bytes:r,value:i})}var o3=class extends Error{static name="AlreadyPinnedError";name="AlreadyPinnedError"},mm=class extends Error{static name="BlockPinnedError";name="BlockPinnedError"},s3=class extends Error{static name="InvalidDatastoreVersionError";name="InvalidDatastoreVersionError"},a3=class extends Error{static name="InvalidConfigurationError";name="InvalidConfigurationError"};var kP="/pin/",TP="/pinned-block/",f9=Mr,IP=1;function c3(r){return r.version===0&&(r=r.toV1()),new lt(`${kP}${r.toString(f9)}`)}var l3=class{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){let n=c3(e);if(await this.datastore.has(n))throw new o3("Already pinned");let i=Math.round(t.depth??1/0);if(i<0)throw new O("Depth must be greater than or equal to 0");let o=new jt({concurrency:IP});for await(let a of this.#e(e,o,{...t,depth:i}))await this.#t(a,c=>c.pinnedBy.find(l=>me(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let s={depth:i,metadata:t.metadata??{}};await this.datastore.put(n,Os(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let i=await this.getCodec(e.code),o=await Ne(this.blockstore.get(e,n)),s=Za({bytes:o,cid:e,codec:i});yield e;for(let[,a]of s.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){let i=new lt(`${TP}${f9.encode(e.multihash.bytes)}`),o={pinCount:0,pinnedBy:[]};try{o=xn(await this.datastore.get(i,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(o)){if(o.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,Os(o),n),n.onProgress?.(new G("helia:pin:add",e))}}async*rm(e,t={}){let n=c3(e),i=await this.datastore.get(n,t),o=xn(i);await this.datastore.delete(n,t);let s=new jt({concurrency:IP});for await(let a of this.#e(e,s,{...t,depth:o.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>me(l,e.bytes)),!0),{...t,depth:o.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:kP+(e.cid!=null?`${e.cid.toString(Mr)}`:"")},e)){let i=j.parse(t.toString().substring(5),Mr),o=xn(n);yield{cid:i,...o}}}async isPinned(e,t={}){let n=new lt(`${TP}${f9.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){let n=c3(e),i=await this.datastore.get(n,t);return xn(i)}async setMetadata(e,t,n){let i=c3(e),o=await this.datastore.get(i,n),s=xn(o);s.metadata=t??{},await this.datastore.put(i,Os(s),n)}};var u3=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}},Bl=class extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}},f3=class extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}},d3=class extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}};var cW=5,h3=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??cW,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await wr(...this.routers)}async stop(){await Cr(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Bl("No content routers available");let n=new Kr({concurrency:this.providerLookupConcurrency});for await(let i of bn(n.toGenerator(),...Ml(this.routers,"findProviders").map(o=>o.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(n.find(i.id)!=null)continue;n.add(async()=>{try{let o=await this.findPeer(i.id,t);return o.multiaddrs.length===0?null:{...o,protocols:i.protocols,routing:i.routing}}catch(o){return this.log.error("could not load multiaddrs for peer %p - %e",i.id,o),null}},{peerId:i.id,signal:t.signal}).catch(o=>{this.log.error("could not load multiaddrs for peer %p - %e",i.id,o)});continue}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new Bl("No content routers available");await Promise.all(Ml(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Ml(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Ml(this.routers,"put").map(async i=>{await i.put(e,t,n)}))}async get(e,t){return Promise.any(Ml(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new Bl("No peer routers available");let n=this,i=bn(...Ml(this.routers,"findPeer").map(o=>(async function*(){try{yield await o.findPeer(e,t)}catch(s){n.log.error(s)}})()));for await(let o of i)if(o!=null)return o;throw new je("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Bl("No peer routers available");for await(let n of bn(...Ml(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))n!=null&&(yield n)}};function Ml(r,e){return r.filter(t=>t[e]!=null)}var p3=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var m3=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function PP(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new m3(t?.errorMessage,t?.errorCode,t?.errorName));let n,i=new m3(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((o,s)=>{n=()=>{s(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var g3=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new di)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function lW(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var y3=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=lW(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new di),this.cleanup())}async join(e={}){let t=new g3(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await PP(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function d9(r,e){let t,n=function(){let i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var gm=class extends Ce{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=d9(this.emitEmpty.bind(this),1),this.emitIdle=d9(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new p3;let n=new y3(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(i=>(this.safeDispatchEvent("success",{detail:{job:n,result:i}}),i)).catch(i=>{if(n.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===n){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new di)}),this.clear()}async onEmpty(e){this.size!==0&&await An(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await An(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await An(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=xr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail.result)},o=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new di("Queue aborted"))};this.addEventListener("success",i),this.addEventListener("failure",o),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",i),this.removeEventListener("failure",o),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var w3="lock:worker:request-read",x3="lock:worker:abort-read-request",b3="lock:worker:release-read",v3="lock:master:grant-read",E3="lock:master:error-read",S3="lock:worker:request-write",A3="lock:worker:abort-write-request",_3="lock:worker:release-write",C3="lock:master:grant-write",T3="lock:master:error-write",I3="lock:worker:finalize",k3="mortice",RP={singleProcess:!1};var h9=(r,e,t,n,i,o,s,a,c)=>l=>{if(l.data==null)return;let u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===i&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(f=>{let h=d=>{if(d?.data==null)return;let m={type:d.data.type,name:d.data.name,identifier:d.data.identifier};m.type===a&&m.identifier===u.identifier&&(e.removeEventListener("message",h),f())};e.addEventListener("message",h)})},onError:f=>{e.postMessage({type:s,name:u.name,identifier:u.identifier,error:{message:f.message,name:f.name,stack:f.stack}})}}}),u.type===o&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===I3&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})};var DP=(r=10)=>Math.random().toString().substring(2,r+2);var P3=class{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(k3)}readLock(e){return this.sendRequest(w3,x3,v3,E3,b3,e)}writeLock(e){return this.sendRequest(S3,A3,C3,T3,_3,e)}finalize(){this.channel.postMessage({type:I3,name:this.name}),this.channel.close()}async sendRequest(e,t,n,i,o,s){s?.signal?.throwIfAborted();let a=DP();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{let u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};s?.signal?.addEventListener("abort",u,{once:!0});let f=h=>{if(h.data?.identifier===a&&(h.data?.type===n&&(this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:o,identifier:a,name:this.name})})),h.data.type===i)){this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u);let d=new Error;h.data.error!=null&&(d.message=h.data.error.message,d.name=h.data.error.name,d.stack=h.data.error.stack),l(d)}};this.channel.addEventListener("message",f)})}};var OP=r=>{if(r=Object.assign({},RP,r),!!globalThis.document||r.singleProcess){let t=new BroadcastChannel(k3),n=new Ce;return t.addEventListener("message",h9(n,t,"requestReadLock","abortReadLockRequest",w3,x3,E3,b3,v3)),t.addEventListener("message",h9(n,t,"requestWriteLock","abortWriteLockRequest",S3,A3,T3,_3,C3)),n}return new P3(r.name)};var Ul=new Map,ym;function NP(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function uW(r){if(ym==null&&(ym=OP(r),!NP(ym))){let e=ym;e.addEventListener("requestReadLock",t=>{let n=t.detail.name,i=t.detail.identifier,o=Ul.get(n);if(o==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==i||s.abort()};e.addEventListener("abortReadLockRequest",a),o.readLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{let n=t.detail.name,i=t.detail.identifier,o=Ul.get(n);if(o==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==i||s.abort()};e.addEventListener("abortWriteLockRequest",a),o.writeLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{let n=t.detail.name,i=Ul.get(n);i?.finalize()})}return ym}async function p9(r,e){let t,n,i=new Promise((s,a)=>{t=s,n=a}),o=()=>{n(new di)};return e?.signal?.addEventListener("abort",o,{once:!0}),r.add(async()=>{await new Promise(s=>{t(()=>{e?.signal?.removeEventListener("abort",o),s()})})},{signal:e?.signal}).catch(s=>{n(s)}),i}var LP=(r,e)=>{let t=Ul.get(r);if(t!=null)return t;let n=uW(e);if(NP(n))return t=n,Ul.set(r,t),t;let i=new gm({concurrency:1}),o;return t={async readLock(s){if(o!=null)return p9(o,s);o=new gm({concurrency:e.concurrency,autoStart:!1});let a=o,c=p9(o,s);return i.add(async()=>{a.start(),await a.onIdle().then(()=>{o===a&&(o=null)})}),c},async writeLock(s){return o=null,p9(i,s)},finalize:()=>{Ul.delete(r)},queue:i},Ul.set(r,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var fW={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function wm(r){let e=Object.assign({},fW,r);return LP(e.name,e)}var R3=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=wm({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await wr(this.child),this.started=!0}async stop(){await Cr(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();let i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async*get(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new mm("Block was pinned - please unpin and try again");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{let i=this;yield*this.child.deleteMany((async function*(){for await(let o of e){if(await i.pins.isPinned(o))throw new mm("Block was pinned - please unpin and try again");yield o}})(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}};var m9=new lt("/version"),BP=1;async function MP(r){if(!await r.has(m9)){await r.put(m9,R(`${BP}`));return}let e=await r.get(m9),t=K(e);if(parseInt(t,10)!==BP)throw new s3("Invalid datastore version, a datastore migration may be required")}var ec={};Ut(ec,{code:()=>Un,decode:()=>Ja,decodeOptions:()=>wW,encode:()=>id,encodeOptions:()=>gW,name:()=>xW,toByteView:()=>FP});var UP=42;function FP(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function dW(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=j.asCID(r);if(!e)return null;let t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new Q(A.tag,UP),new Q(A.bytes,t)]}function hW(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function pW(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}function mW(r){for(let e of r.keys())if(typeof e!="string"||e.length===0)throw new Error("Non-string Map keys are not supported by the IPLD Data Model and cannot be encoded");return null}var g9={float64:!0,typeEncoders:{Map:mW,Object:dW,undefined:hW,number:pW}},gW={...g9,typeEncoders:{...g9.typeEncoders}};function yW(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return j.decode(r.subarray(1))}var D3={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};D3.tags[UP]=yW;var wW={...D3,tags:D3.tags.slice()},xW="dag-cbor",Un=113,id=r=>Os(r,g9),Ja=r=>xn(FP(r),D3);var Fl={};Ut(Fl,{code:()=>po,decode:()=>sd,encode:()=>N3,format:()=>PW,name:()=>kW,parse:()=>DW,stringify:()=>PW});var y9=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===A.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===A.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[A.uint.major](e,t){this.prefix(e);let n=String(t.value),i=[];for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o);e.push(i)}[A.negint.major](e,t){this[A.uint.major](e,t)}[A.bytes.major](e,t){throw new Error(`${Rs} unsupported type: Uint8Array`)}[A.string.major](e,t){this.prefix(e);let n=t2(JSON.stringify(t.value));e.push(n.length>32?Tp(n):n)}[A.array.major](e,t){this.prefix(e),this.inRecursive.push({type:A.array,elements:0}),e.push([91])}[A.map.major](e,t){this.prefix(e),this.inRecursive.push({type:A.map,elements:0}),e.push([123])}[A.tag.major](e,t){}[A.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===A.array)e.push([93]);else if(s.type===A.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Rs} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),i=[],o=!1;for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s),!o&&(i[s]===46||i[s]===101||i[s]===69)&&(o=!0);o||(i.push(46),i.push(48)),e.push(i)}};function bW(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Rs} complex map keys are not supported`);let t=r[0],n=e[0];if(t.type!==A.string||n.type!==A.string)throw new Error(`${Rs} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Rs} unexpected duplicate map keys, this is not supported`)}var vW={addBreakTokens:!0,mapSorter:bW};function xm(r,e){return e=Object.assign({},vW,e),U7(r,new y9,e)}var od=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${ge} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${ge} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,i=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new Q(A.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${ge} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ge} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));let o=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(o);return n?new Q(A.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new Q(s>=0?A.uint:A.negint,s,this._pos-e):new Q(s>=0?A.uint:A.negint,BigInt(o),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ge} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let o=this._pos,s=0;o<this.data.length&&s<65536;o++,s++){let a=this.data[o];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,o));return this._pos=o+1,new Q(A.string,c,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${ge} unexpected end of unicode escape sequence at position ${this._pos}`);let o=0;for(let s=0;s<4;s++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ge} unexpected unicode escape character at position ${this._pos}`);o=o*16+a,this._pos++}return o},i=()=>{let o=this.ch(),s=null,a=o>239?4:o>223?3:o>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${ge} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:o<128&&(s=o);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(o&31)<<6|c&63,f>127&&(s=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(o&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(s=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(o&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(s=f))}s===null?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=a};for(;!this.done();){let o=this.ch(),s;switch(o){case 92:if(this._pos++,this.done())throw new Error(`${ge} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ge} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new Q(A.string,P7(t),this._pos-e);default:if(o<32)throw new Error(`${ge} invalid control character at position ${this._pos}`);o<128?(t.push(o),this._pos++):i()}}throw new Error(`${ge} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new Q(A.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new Q(A.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Q(A.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Q(A.false,!1,5);case 116:return this.expect([116,114,117,101]),new Q(A.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ge} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new Q(A.break,void 0,1);if(this.ch()!==44)throw new Error(`${ge} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new Q(A.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new Q(A.break,void 0,1);if(this.ch()!==44)throw new Error(`${ge} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new Q(A.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ge} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ge} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function w9(r,e){return e=Object.assign({tokenizer:new od(r,e)},e),xn(r,e)}function SW(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function AW(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=j.asCID(r);if(!e)return null;let t=e.toString();return[new Q(A.map,1/0,1),new Q(A.string,"/",1),new Q(A.string,t,t.length),new Q(A.break,void 0,1)]}function O3(r){let e=sr.encode(r).slice(1);return[new Q(A.map,1/0,1),new Q(A.string,"/",1),new Q(A.map,1/0,1),new Q(A.string,"bytes",5),new Q(A.string,e,e.length),new Q(A.break,void 0,1),new Q(A.break,void 0,1)]}function ho(r){return O3(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function _W(r){return O3(new Uint8Array(r))}function CW(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function TW(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var IW={typeEncoders:{Object:AW,Buffer:O3,Uint8Array:O3,Int8Array:ho,Uint16Array:ho,Int16Array:ho,Uint32Array:ho,Int32Array:ho,Float32Array:ho,Float64Array:ho,Uint8ClampedArray:ho,BigInt64Array:ho,BigUint64Array:ho,DataView:ho,ArrayBuffer:_W,undefined:CW,number:TW}},x9=class extends od{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===A.map){let t=this._next();if(t.type===A.string&&t.value==="/"){let n=this._next();if(n.type===A.string){if(this._next().type!==A.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new Q(A.tag,42,0)}if(n.type===A.map){let i=this._next();if(i.type===A.string&&i.value==="bytes"){let o=this._next();if(o.type===A.string){for(let a=0;a<2;a++)if(this._next().type!==A.break)throw new Error("Invalid encoded Bytes form");let s=sr.decode(`m${o.value}`);return new Q(A.bytes,s,o.value.length)}this.tokenBuffer.push(o)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},b9={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};b9.tags[42]=j.parse;var kW="dag-json",po=297,N3=r=>xm(r,IW),sd=r=>{let e=SW(r),t=Object.assign(b9,{tokenizer:new x9(e,b9)});return w9(e,t)},PW=r=>RW.decode(N3(r));var RW=new TextDecoder,DW=r=>sd(OW.encode(r)),OW=new TextEncoder;var nr={};Ut(nr,{code:()=>gt,createLink:()=>XP,createNode:()=>GP,decode:()=>rr,encode:()=>Je,name:()=>KW,prepare:()=>Gt,validate:()=>S9});var NW=new TextDecoder;function v9(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function L3(r,e){let t;[t,e]=v9(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function $P(r,e){let t;return[t,e]=v9(r,e),[t&7,t>>3,e]}function LW(r){let e={},t=r.length,n=0;for(;n<t;){let i,o;if([i,o,n]=$P(r,n),o===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=L3(r,n)}else if(o===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=L3(r,n),e.Name=NW.decode(s)}else if(o===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=v9(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${o}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function HP(r){let e=r.length,t=0,n,i=!1,o;for(;t<e;){let a,c;if([a,c,t]=$P(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(o)throw new Error("protobuf: (PBNode) duplicate Data section");[o,t]=L3(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=L3(r,t),n.push(LW(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return o&&(s.Data=o),s.Links=n||[],s}var zP=new TextEncoder,VP=2**32,BW=2**31;function MW(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=bm(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){let n=zP.encode(r.Name);t-=n.length,e.set(n,t),t=bm(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=bm(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function KP(r){let e=FW(r),t=new Uint8Array(e),n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=bm(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let i=r.Links.length-1;i>=0;i--){let o=MW(r.Links[i],t.subarray(0,n));n-=o,n=bm(t,n,o)-1,t[n]=18}return t}function UW(r){let e=0;if(r.Hash){let t=r.Hash.length;e+=1+t+ad(t)}if(typeof r.Name=="string"){let t=zP.encode(r.Name).length;e+=1+t+ad(t)}return typeof r.Tsize=="number"&&(e+=1+ad(r.Tsize)),e}function FW(r){let e=0;if(r.Data){let t=r.Data.length;e+=1+t+ad(t)}if(r.Links)for(let t of r.Links){let n=UW(t);e+=1+n+ad(n)}return e}function bm(r,e,t){e-=ad(t);let n=e;for(;t>=BW;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function ad(r){return r%2===0&&r++,Math.floor(($W(r)+6)/7)}function $W(r){let e=0;return r>=VP&&(r=Math.floor(r/VP),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+HW[r]}var HW=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var VW=["Data","Links"],zW=["Hash","Name","Tsize"],E9=new TextEncoder;function jP(r,e){if(r===e)return 0;let t=r.Name?E9.encode(r.Name):[],n=e.Name?E9.encode(e.Name):[],i=t.length,o=n.length;for(let s=0,a=Math.min(i,o);s<a;++s)if(t[s]!==n[s]){i=t[s],o=n[s];break}return i<o?-1:o<i?1:0}function qP(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function WP(r){if(typeof r.asCID=="object"){let t=j.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Hash){let t=j.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=j.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=j.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function Gt(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=E9.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(WP),e.Links.sort(jP);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function S9(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!qP(r,VW))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){let t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!qP(t,zW))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&jP(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function GP(r,e=[]){return Gt({Data:r,Links:e})}function XP(r,e,t){return WP({Hash:t,Name:r,Tsize:e})}function YP(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}var KW="dag-pb",gt=112;function Je(r){S9(r);let e={};return r.Links&&(e.Links=r.Links.map(t=>{let n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),KP(e)}function rr(r){let e=YP(r),t=HP(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(i=>{let o={};try{o.Hash=j.decode(i.Hash)}catch{}if(!o.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(o.Name=i.Name),i.Tsize!==void 0&&(o.Tsize=i.Tsize),o})),n}function cd(r){return r?.then!=null}function QP(r=[],e){let t={[gt]:nr,[vt]:Nn,[Un]:ec,[po]:Fl,[Mo]:lf};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){let o=e(n);cd(o)?i=await o:i=o,t[i.code]=i}if(i!=null)return i;throw new d3(`Could not load codec for ${n}`)}}function ZP(r=[],e){let t={[ze.code]:ze,[Cg.code]:Cg,[or.code]:or};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){let o=e(n);cd(o)?i=await o:i=o,t[i.code]=i}if(i!=null)return i;throw new f3(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}var Ni=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not Found"){super(e)}};var qs=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,bytes:i}of e)await this.put(n,i,t),yield n}get(e,t){throw new Error(".get is not implemented")}async*getMany(e,t){for await(let n of e)yield{cid:n,bytes:this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var B3=0,ld=class extends Error{static name="IdentityHashDigestTooLongError";name="IdentityHashDigestTooLongError"},M3=class extends qs{child;maxDigestLength;constructor(e,t){super(),this.child=e,this.maxDigestLength=t?.maxDigestLength}put(e,t,n){if(e.multihash.code===B3){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new ld(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return n?.signal?.throwIfAborted(),e}return this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}*get(e,t){if(e.multihash.code===B3){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new ld(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted(),yield e.multihash.digest;return}if(this.child==null)throw t?.signal?.throwIfAborted(),new Ni;yield*this.child.get(e,t)}has(e,t){if(e.multihash.code===B3){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new ld(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return t?.signal?.throwIfAborted(),!0}return this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===B3){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new ld(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}*getAll(e){this.child!=null&&(yield*this.child.getAll(e)),e?.signal?.throwIfAborted()}};function qW(r){return r[Symbol.asyncIterator]!=null}function jW(r,e){let t=0;if(qW(r))return(async function*(){for await(let c of r)await e(c,t++)&&(yield c)})();let n=Qf(r),{value:i,done:o}=n.next();if(o===!0)return(function*(){})();let s=e(i,t++);if(typeof s.then=="function")return(async function*(){await s&&(yield i);for(let c of n)await e(c,t++)&&(yield c)})();let a=e;return(function*(){s===!0&&(yield i);for(let c of n)a(c,t++)&&(yield c)})()}var Cn=jW;function WW(r){return r[Symbol.asyncIterator]!=null}function JP(r){return r?.then!=null}function GW(r,e){let t=0;if(WW(r))return(async function*(){for await(let c of r){let l=e(c,t++);JP(l)&&await l,yield c}})();let n=Qf(r),{value:i,done:o}=n.next();if(o===!0)return(function*(){})();if(typeof e(i,t++)?.then=="function")return(async function*(){yield i;for(let c of n){let l=e(c,t++);JP(l)&&await l,yield c}})();let a=e;return(function*(){yield i;for(let c of n)a(c,t++),yield c})()}var A9=GW;var XW=128,U3=class{child;getHasher;log;logger;components;constructor(e,t={}){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new M3(e.blockstore,{maxDigestLength:t.maxIdentityHashDigestLength??XW}),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new G("blocks:put:duplicate",e)),e):(n.onProgress?.(new G("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,n))),n.onProgress?.(new G("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=Cn(e,async({cid:o})=>{let s=await this.child.has(o,t);return s&&t.onProgress?.(new G("blocks:put-many:duplicate",o)),!s}),i=A9(n,async({cid:o})=>{t.onProgress?.(new G("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(o,t)))});t.onProgress?.(new G("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async*get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){let n=await this.getHasher(e.multihash.code);t.onProgress?.(new G("blocks:get:providers:get",e));let i=await eR(e,this.components.blockBrokers,n,{...t,log:this.log});t.onProgress?.(new G("blocks:get:blockstore:put",e)),await this.child.put(e,i,t),t.onProgress?.(new G("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(e,t))),yield i;return}t.onProgress?.(new G("blocks:get:blockstore:get",e)),yield*this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new G("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(A9(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){let i=await this.getHasher(n.multihash.code);t.onProgress?.(new G("blocks:get-many:providers:get",n));let o=await eR(n,this.components.blockBrokers,i,{...t,log:this.log});t.onProgress?.(new G("blocks:get-many:blockstore:put",n)),await this.child.put(n,o,t),t.onProgress?.(new G("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(n,t)))}}))}async delete(e,t={}){t.onProgress?.(new G("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new G("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany((async function*(){for await(let n of e)yield n})(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new G("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},F3=class extends U3{started;constructor(e,t={}){super(e,t),this.started=!1}isStarted(){return this.started}async start(){await wr(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Cr(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let n=this.components.blockBrokers.map(i=>i.createSession==null?i:i.createSession(t));return new _9({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}},_9=class extends U3{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){let i=Oe([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:i})}finally{i.clear()}}async*putMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async*get(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){let n=Oe([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){let t=Oe([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function YW(r){return typeof r.retrieve=="function"}var QW=(r,e)=>{if(e==null)throw new O(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n,i=e.digest(t);if(cd(i)?n=await i:n=i,!me(n.digest,r.multihash.digest))throw new xa("Hash of downloaded block did not match multihash from passed CID")}};async function eR(r,e,t,n){let i=QW(r,t),o=new AbortController,s=Oe([o.signal,n.signal]);o.signal;let a=[];for(let c of e)YW(c)&&a.push(c);if(a.length===0)throw new a3(`No block brokers capable of retrieving blocks are configured, the CID ${r} cannot be fetched from the network`);try{return await Promise.any(a.map(async c=>{try{let l=!1,u=await c.retrieve(r,{...n,signal:s,validateFn:async f=>{await i(f),n.signal?.throwIfAborted(),l=!0}});return l||(await i(u),n.signal?.throwIfAborted()),u}catch(l){throw n.log.error("could not retrieve verified block for %c - %e",r,l),l}}))}finally{o.abort(),s.clear()}}var $l=class extends Ce{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=Rr(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){let n=sr.encode(e.multihash.bytes),i=this.requests.get(n);if(i!=null)return this.log("join existing request for %c",e),i;let o=We();if(this.requests.set(n,o.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t));try{await Et(this.initialPeerSearchComplete,t.signal),u&&this.log("found initial session peers for %c",e)}catch(f){throw u&&this.log("failed to find initial session peers for %c - %e",e,f),this.requests.delete(n),o.reject(f),f}}let s=!1,a=new jt({concurrency:this.maxProviders});a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{s=!0,o.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(s){this.log.trace("session idle, found block");return}if(t.signal?.aborted===!0){this.log.trace("session idle, signal aborted");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){let f=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(f)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),o.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c - %e",e,u),o.reject(u)})});let c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(f=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,f)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,u)});let l=()=>{o.reject(new St(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await Et(o.promise,t.signal)}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){let i=We(),o=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;o<t&&this.initialProviders.length>0;){let s=this.initialProviders.pop();if(s==null)break;let a=await this.convertToProvider(s,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),o++,o===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(o<this.maxProviders)for await(let s of this.findNewProviders(e,n)){if(o===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),o++,o===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<t)throw new u3(`Found ${o} of ${t} ${this.name} providers for ${e}`)}).catch(s=>{this.log.error("error searching routing for potential session peers for %c - %e",e,s),i.reject(s)}),i.promise}};function I9(r,e={}){return new C9(r,e)}function k9(r,e={}){return new T9(r,e)}var $3=class{components;constructor(e,t){this.components=e}async*walk(e,t){let n=this.getQueue(),i=Cn(n.toGenerator(t),a=>a!=null),o=!1,s=async a=>{let c=a.cid,l=await Ne(this.components.blockstore.get(c,a)),u=Za({cid:c,bytes:l,codec:await this.components.getCodec(c.code)});for(let[,f]of u.links())t?.includeChild?.(f,u)!==!1&&n.add(s,{...a,cid:f,depth:a.depth+1,path:[...a.path,f]}).catch(h=>{o||i.throw(h)});return{block:u,depth:a.depth,path:a.path}};n.add(s,{...t,cid:e,depth:0,path:[e]}).catch(a=>{o||i.throw(a)});try{yield*i}finally{o=!0,n.abort()}}},C9=class extends $3{getQueue(){return new jt({concurrency:1,sort:(e,t)=>e.options.depth===t.options.depth?0:e.options.depth<t.options.depth?1:-1})}},T9=class extends $3{getQueue(){return new jt({concurrency:1,sort:(e,t)=>e.options.depth===t.options.depth?0:e.options.depth<t.options.depth?-1:1})}};var H3=class{libp2p;blockstore;datastore;events;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??Na(),this.log=this.logger.forComponent("helia"),this.getHasher=ZP(e.hashers,e.loadHasher),this.getCodec=QP(e.codecs,e.loadCodec),this.dns=e.dns??Ll(),this.metrics=e.metrics,this.libp2p=e.libp2p,this.events=new Ce;let t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new h3(t,{routers:(e.routers??[]).flatMap(i=>{let o=[i];return i[Do]!=null&&o.push(i[Do]),i[Bo]!=null&&o.push(i[Bo]),o}),providerLookupConcurrency:e.providerLookupConcurrency});let n=new F3(t,e);this.pins=new l3(e.datastore,n,this.getCodec),this.blockstore=new R3(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await MP(this.datastore),await wr(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("start",{detail:this}))}async stop(){await Cr(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("stop",{detail:this}))}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,i=this.blockstore.unwrap();this.log("gc start"),await ln(i.deleteMany((async function*(){for await(let{cid:o}of i.getAll())try{if(await n.pins.isPinned(o,e))continue;yield o,e.onProgress?.(new G("helia:gc:deleted",o))}catch(s){n.log.error("error during gc - %e",s),e.onProgress?.(new G("helia:gc:error",s))}})()))}finally{t()}this.log("gc finished")}};var P9=class extends $l{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);let i=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,i.has?"has":"does not have",e),i.has&&i.block!=null)return i.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return _r(e)?e:(await this.libp2p.dial(e,t)).remotePeer}};function tR(r,e){return new P9(r,e)}var V3=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}};function eG(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=oi(r);e.push(t),r=r.slice(Ke(t))}return e}var rR=eG;var z3=class extends Ce{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Vs({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=lr({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,i)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(i=>{this.log.error("error processing newly connected bitswap peer %p - %e",n.detail,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){let n=K(e.multihash.bytes,"base64"),i=this.wants.get(n);i==null&&(i={cid:e,priority:t.priority??1,wantType:t.wantType??tr.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,i)),i.wantType===tr.WantHave&&t.wantType===tr.WantBlock&&(i.wantType=tr.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===tr.WantBlock?(await An(this,"block",t?.signal,{filter:a=>me(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await An(this,"presence",t?.signal,{filter:s=>me(e.multihash.digest,s.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),i.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers - %e",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=We(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let n=new Set,i=new zs;for(let[o,s]of this.wants.entries())t.has(o)||s.cancel||(n.add(o),i.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(i.wantlist.size!==0)try{await this.network.sendMessage(e,i);for(let o of n)t.add(o)}catch(o){this.log.error("error sending full wantlist to new peer - %e",o)}})).catch(e=>{this.log.error("error sending messages - %e",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){let t=K(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){let i=new zs;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:tr.WantHave,priority:1}),await this.network.sendMessage(t,i),(await An(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&me(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:tr.WantBlock})}async wantSessionBlock(e,t,n={}){let i=new zs;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:tr.WantBlock,priority:1}),await this.network.sendMessage(t,i),(await An(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&me(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let n=K(e.multihash.bytes,"base64"),i=this.wants.get(n);i!=null&&(i.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(let i of t.blocks){if(i.prefix==null||i.data==null)continue;let o=rR(i.prefix),s=o[0],a=o[1],c=o[2],l=c===ze.code?ze:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(i.data);u.then!=null&&(u=await u);let f=j.create(s===0?0:1,a,u);this.log("received block from %p for %c",e,f),this.safeDispatchEvent("block",{detail:{sender:e,cid:f,block:i.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:f,has:!0,block:i.data}});let h=K(f.multihash.bytes,"base64"),d=this.wants.get(h);d!=null&&(d.cancel=!0,n=!0)}for(let{cid:i,type:o}of t.blockPresences){let s=j.decode(i);this.log("received %s from %p for %c",o,e,s),this.safeDispatchEvent("presence",{detail:{sender:e,cid:s,has:o===Oi.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,n=new zs(!0);for(let[i,o]of this.wants.entries())o.cancel||(t.add(i),n.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:tr.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(i){this.log.error("error sending full wantlist to new peer %p - %e",e,i)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var K3=class{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new V3(e),this.network=new Qy(e,t),this.peerWantLists=new Jy({...e,network:this.network},t),this.wantList=new z3({...e,network:this.network},t)}createSession(e={}){return tR({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){let n=new AbortController,i=Oe([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(o=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c - %e",e,o)});try{let o=await this.wantList.wantBlock(e,{...t,signal:i});return t.onProgress?.(new G("bitswap:block",{cid:e,sender:o.sender})),o.block}finally{n.abort(),i.clear()}}async notify(e,t={}){await Promise.all([this.peerWantLists.receivedBlock(e,t),this.wantList.receivedBlock(e,t)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var nR=(r,e={})=>new K3(r,e);var R9=class{bitswap;started;constructor(e,t={}){let{getHasher:n}=e;this.bitswap=nR(e,{hashLoader:{getHasher:async i=>n(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t){await this.bitswap.notify(e,t)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(n,i)=>{await this.bitswap.notify(n,i)},retrieve:async(n,i)=>t.retrieve(n,i)}}};function vm(r={}){return e=>new R9(e,r)}var tG=[6,53,56,54,55];function iR(r){return aR("sni",r)?.value}function oR(r){let e=aR("tcp",r)?.value;return e==null?"":`:${e}`}function aR(r,e){return e.find(t=>t.name===r)}function sR(r){return r.some(({code:e})=>e===448)}function mo(r,e){let t=cR[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);let n=t(r,e);return r.code===41?`[${n}]`:n}var cR={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${mo(t,e)}:${r.value}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${mo(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${mo(t,e)}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${mo(t,e)}`},http:(r,e)=>{let t=sR(e),n=iR(e),i=oR(e);if(t&&n!=null)return`https://${n}${i}`;let o=t?"https://":"http://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=mo(s,e);return a=a?.replace("tcp://",""),`${o}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=mo(t,e),i=decodeURIComponent(r.value??"");return`${n}${i}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return mo(t,e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return mo(t,e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=mo(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=sR(e),n=iR(e),i=oR(e);if(t&&n!=null)return`wss://${n}${i}`;let o=t?"wss://":"ws://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=mo(s,e);return a=a?.replace("tcp://",""),`${o}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=mo(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function tc(r,e){let n=se(r).getComponents(),i=n.pop();if(i==null)throw new Error("Unexpected end of multiaddr");let o=cR[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let s=o(i,n)??"";return e?.assumeHttp!==!1&&tG.includes(i.code)&&(s=s.replace(/^.*:\/\//,""),i.value==="443"?s=`https://${s}`:s=`http://${s}`),(s.startsWith("http://")||s.startsWith("https://")||s.startsWith("ws://")||s.startsWith("wss://"))&&(s=new URL(s).toString(),s.endsWith("/")&&(s=s.substring(0,s.length-1))),s}function D9(r,e,t){return r.filter(n=>{if(Pk.matches(n)||e&&kk.matches(n))return t||sy.matches(n)?!0:qt(n)===!1;if(!e&&t){let{host:i}=Te(n);if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*q3(r,e,t,n,i,o={}){for await(let s of e.findProviders(r,o)){let a=D9(s.multiaddrs,n,i);if(a.length===0)continue;let c=tc(a[0]),l={type:"trustless-gateway",cid:r,url:c.toString(),routing:s.routing};o?.onProgress?.(new G("trustless-gateway:found-provider",l)),yield new ud(c,{logger:t,transformRequestInit:o.transformRequestInit})}}async function lR(r,e,t){let{signal:n,log:i}=t??{},o=r.headers.get("content-length");if(o!=null){let c=parseInt(o,10);if(c>e)throw i?.error("content-length header (%d) is greater than the limit (%d)",c,e),r.body!=null&&await r.body.cancel().catch(l=>{i?.error("error cancelling response body after content-length check - %e",l)}),new Error(`Content-Length header (${c}) is greater than the limit (${e}).`)}let s=r.body?.getReader();if(s==null)throw new Error("Response body is not readable");let a=new oe;try{for(;;){if(n?.aborted===!0)throw new Error("Response body read was aborted.");let{done:c,value:l}=await s.read();if(c)break;if(a.append(l),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{s.cancel().catch(c=>{i?.error("error cancelling reader - %e",c)}).finally(()=>{s.releaseLock()})}return a.subarray()}var ud=class{url;#e=0;#t=0;#r=0;#n=0;#i=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#o(e){let t=e.multihash.bytes;return sr.encode(t)}async getRawBlock(e,{signal:t,maxSize:n=uR}={}){let i=new URL(this.url.toString());if(i.pathname=`/ipfs/${e.toString()}`,i.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let o=this.#o(e),s=new AbortController,a=()=>{s.abort()};t?.addEventListener("abort",a);try{let c=this.#i.get(o);if(c==null){this.#e++;let l={signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},u=this.transformRequestInit!=null?await this.transformRequestInit(l):l;c=fetch(i.toString(),u).then(async f=>{if(this.log("GET %s %d",i,f.status),!f.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);let h=await lR(f,n,{signal:s.signal,log:this.log});return this.#n++,h}),this.#i.set(o,c)}return await c}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",a),this.#i.delete(o)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#n/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#n,pendingResponses:this.#i.size}}};var O9=class extends $l{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??j3,this.allowLocal=t.allowLocal??W3,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);let i=await t.getRawBlock(e,n);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(i),i}async*findNewProviders(e,t={}){yield*q3(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(_r(e))return;let n=D9(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;let i=tc(n[0]);return new ud(i,{logger:this.logger,transformRequestInit:this.transformRequestInit})}};function fR(r,e){return new O9(r,e)}var G3=class{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??j3,this.allowLocal=t.allowLocal??W3,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){let n=[];for await(let i of q3(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,i.url);try{let o=await i.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,i.url);try{await t.validateFn?.(o)}catch(s){this.log.error("failed to validate block for %c from %s - %e",e,i.url,s);continue}return o}catch(o){if(this.log.error("failed to get block for %c from %s - %e",e,i.url,o),o instanceof Error?n.push(o):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${i.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,i.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return fR({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}};var j3=!1,W3=!1,uR=2097152;function Em(r={}){return e=>new G3(e,r)}async function*X3(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var Y3=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*Sm(r,e={}){let t=/\r?\n/,n=new TextDecoder("utf8"),i="";for await(let o of r){if(typeof o=="string"&&(o=new TextEncoder().encode(o)),Ii(o)&&(o=o.subarray()),i+=n.decode(o,{stream:!0}),i.length>(e?.maxMessageLength??i.length))throw new Y3("Incoming message too long");let s=i.split(t);i=s.pop()??"";for(let a=0;a<s.length;a++)yield JSON.parse(s[a])}i+=n.decode(),i!==""&&(yield JSON.parse(i))}var fd=class extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}},go=class extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}};function rG(r){return r[Symbol.asyncIterator]!=null}function nG(r){if(rG(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var dd=nG;var dR=R("/ipns/");function hR(r){return me(r.subarray(0,dR.byteLength),dR)}var Q3=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){try{yield*Wt(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[],routing:"delegated-http-routing-v1"}))}catch(n){if(n instanceof je)return;throw n}}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!hR(e))return;let i=Lf(e),o=j.createV1(114,i),s=Hr(t);await this.client.putIPNS(o,s,n)}async get(e,t){if(!hR(e))throw new je("Not found");let n=Lf(e),i=j.createV1(114,n);try{let o=await this.client.getIPNS(i,t);return io(o)}catch(o){throw o.name==="BadResponseError"?new je("Not found"):o}}},Z3=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await dd(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new je("Not found")}async*getClosestPeers(e,t={}){}};var qr=Ze("delegated-routing-v1-http-api-client"),J3={concurrentRequests:4,timeout:3e4,cacheTTL:300*1e3,cacheName:"delegated-routing-v1-cache"},e4=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Ks({concurrency:t.concurrentRequests??J3.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??J3.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new Q3(this),this.peerRouting=new Z3(this),this.cacheName=t.cacheName??J3.cacheName,this.cacheTTL=t.cacheTTL??J3.cacheTTL}get[Do](){return this.contentRouting}get[Bo](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&qr("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){qr("getProviders starts: %c",e);let n=AbortSignal.timeout(this.timeout),i=Oe([this.shutDownController.signal,n,t.signal]);let o=We(),s=We();this.httpQueue.add(async()=>(o.resolve(),s.promise));try{await o.promise;let a=new URL(`${this.clientUrl}routing/v1/providers/${e}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#r(a.toString(),c);if(!l.ok){if(l.status===404)return;throw l.status===422?new fd("Request does not conform to schema or semantic constraints"):new go(`Unexpected status code: ${l.status}`)}if(l.body==null)throw new go("Routing response had no body");let u=l.headers.get("Content-Type");if(u==null)throw new go("No Content-Type header received");if(u.startsWith("application/json")){let h=(await l.json()).Providers??[];for(let d of h){let m=this.#e(d);m!=null&&(yield m)}}else if(u.includes("application/x-ndjson"))for await(let f of Sm(X3(l.body))){let h=this.#e(f);h!=null&&(yield h)}else throw new go(`Unsupported Content-Type: ${u}`)}finally{i.clear(),s.resolve(),qr("getProviders finished: %c",e)}}async*getPeers(e,t={}){qr("getPeers starts: %c",e);let n=AbortSignal.timeout(this.timeout),i=Oe([this.shutDownController.signal,n,t.signal]);let o=We(),s=We();this.httpQueue.add(async()=>(o.resolve(),s.promise));try{await o.promise;let a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#r(a.toString(),c);if(l.status===404)return;if(l.status===422)throw new fd("Request does not conform to schema or semantic constraints");if(l.body==null)throw new go("Routing response had no body");if(l.headers.get("Content-Type")?.startsWith("application/json")){let h=(await l.json()).Peers??[];for(let d of h){let m=this.#e(d);m!=null&&(yield m)}}else for await(let f of Sm(X3(l.body))){let h=this.#e(f);h!=null&&(yield h)}}catch(a){qr.error("getPeers errored:",a)}finally{i.clear(),s.resolve(),qr("getPeers finished: %c",e)}}async getIPNS(e,t={}){qr("getIPNS starts: %s",e);let n=AbortSignal.timeout(this.timeout),i=Oe([this.shutDownController.signal,n,t.signal]);let o=We(),s=We();this.httpQueue.add(async()=>(o.resolve(),s.promise));let a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;let c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await this.#r(a,c);if(qr("getIPNS GET %s %d",a,l.status),l.status===404)throw new je("No matching records found");if(l.status===422)throw new fd("Request does not conform to schema or semantic constraints");if(!l.ok)throw new go(`Unexpected status code: ${l.status}`);let u=l.headers.get("Content-Type");if(u==null||!u.includes("application/vnd.ipfs.ipns-record"))throw new je("No matching records found");if(l.body==null)throw new go("GET ipns response had no body");let f=await l.arrayBuffer(),h=new Uint8Array(f,0,f.byteLength);return t.validate!==!1&&await gl(Ko(e.multihash),h),Hr(h)}catch(c){throw qr.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),s.resolve(),qr("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){qr("putIPNS starts: %c",e);let i=AbortSignal.timeout(this.timeout),o=Oe([this.shutDownController.signal,i,n.signal]);let s=We(),a=We();this.httpQueue.add(async()=>(s.resolve(),a.promise));let c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;let l=io(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:o},f=await this.#r(c,u);if(qr("putIPNS PUT %s %d",c,f.status),f.status!==200)throw new go("PUT ipns response had status other than 200")}catch(l){throw qr.error("putIPNS PUT %s error:",c,l.stack),l}finally{o.clear(),a.resolve(),qr("putIPNS finished: %c",e)}}#e(e){try{let t=[],n=e.Addrs?.map(se)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:tt(e.ID),Addrs:n,Protocols:t}}catch(t){qr.error("could not conform record to peer schema",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){let i=t?.join(",")??this.filterAddrs?.join(",")??"";i!==""&&e.searchParams.set("filter-addrs",i)}if(n!=null||this.filterProtocols!=null){let i=n?.join(",")??this.filterProtocols?.join(",")??"";i!==""&&e.searchParams.set("filter-protocols",i)}}async#r(e,t){let n=t.method??"GET",i=`${n}-${e}`;if(n==="GET"){let c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return qr("returning cached response for %s",i),c;await this.cache?.delete(e)}}let o=this.inFlightRequests.get(i);if(o!=null){let c=await o;return qr("deduplicating outgoing request for %s",i),c.clone()}let s=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){let l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());let f=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,f)}return c}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,s),await s}};function t4(r,e={}){return new e4(new URL(r),e)}function N9(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}var pR="[a-fA-F\\d:]",rc=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${pR})|(?<=${pR})(?=\\s|$))`:"",yo="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",fr="[a-fA-F\\d]{1,4}",r4=`
(?:
(?:${fr}:){7}(?:${fr}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${fr}:){6}(?:${yo}|:${fr}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${fr}:){5}(?::${yo}|(?::${fr}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${fr}:){4}(?:(?::${fr}){0,1}:${yo}|(?::${fr}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${fr}:){3}(?:(?::${fr}){0,2}:${yo}|(?::${fr}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${fr}:){2}(?:(?::${fr}){0,3}:${yo}|(?::${fr}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${fr}:){1}(?:(?::${fr}){0,4}:${yo}|(?::${fr}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${fr}){0,5}:${yo}|(?::${fr}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),iG=new RegExp(`(?:^${yo}$)|(?:^${r4}$)`),oG=new RegExp(`^${yo}$`),sG=new RegExp(`^${r4}$`),L9=r=>r&&r.exact?iG:new RegExp(`(?:${rc(r)}${yo}${rc(r)})|(?:${rc(r)}${r4}${rc(r)})`,"g");L9.v4=r=>r&&r.exact?oG:new RegExp(`${rc(r)}${yo}${rc(r)}`,"g");L9.v6=r=>r&&r.exact?sG:new RegExp(`${rc(r)}${r4}${rc(r)}`,"g");var B9=L9;function M9(r){let e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}function mR(){return!1}var{toString:aG}=Object.prototype;function U9(r){return aG.call(r)==="[object RegExp]"}var gR={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function F9(r,e={}){if(!U9(r))throw new TypeError("Expected a RegExp instance");let t=Object.keys(gR).map(i=>(typeof e[i]=="boolean"?e[i]:r[i])?gR[i]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function $9(r,e,{timeout:t}={}){try{return M9(()=>F9(r).test(e),{timeout:t})()}catch(n){if(mR(n))return!1;throw n}}var cG=15,lG=45,yR={timeout:400};function H9(r){return r.length>lG?!1:$9(B9.v6({exact:!0}),r,yR)}function wR(r){return r.length>cG?!1:$9(B9.v4({exact:!0}),r,yR)}var xR={http:"80",https:"443",ws:"80",wss:"443"},uG=["http","https","ws","wss"];function n4(r,e){e=e??{};let t=e.defaultDnsType??"dns",{scheme:n,hostname:i,port:o,path:s}=fG(r),a=[dG(i,t),hG(o,n),pG(n)];s!=null&&a.push(mG(s));let c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return se(c)}function fG(r){let[e]=r.split(":");uG.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:i,pathname:o,search:s}=new URL(r);if(i==null||i===""){let c=gG(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return o!=null&&o!==""&&o!=="/"&&(o.startsWith("/")&&(o=o.substring(1)),a=o),s!=null&&s!==""&&(a=a??"",a+=s),{scheme:e,hostname:n,port:i,path:a}}function dG(r,e){if(!(r==null||r==="")){if(wR(r))return["ip4",r];if(H9(r))return["ip6",r];if(r[0]==="["){let t=r.substring(1,r.length-1);if(H9(t))return["ip6",t]}return[e,r]}}function hG(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function pG(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function mG(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function gG(r){if(!(r==null||r===""||xR[r]==null))return xR[r]}var yG=["https://trustless-gateway.link","https://4everland.io"],wG=2336;function xG(r){return r=r.toString(),{id:En(j.createV1(wG,or.digest(R(r)))),multiaddrs:[n4(r)]}}var V9=class{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??yG).map(t=>xG(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"],routing:"http-gateway-routing"}))}};function Am(r={}){return new V9(r)}var z9=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}};function _m(r){return new z9(r)}function bG(r){return typeof r?.then=="function"}var Cm=class extends qs{data;constructor(){super(),this.data=new Map}put(e,t,n){n?.signal?.throwIfAborted();let i;if(t instanceof Uint8Array)i=[t];else{let o=fo(t);if(bG(o))return o.then(s=>this._put(e,s,n));i=o}return this._put(e,i,n)}_put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(Tr.encode(e.multihash.bytes),t),e}*get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(Tr.encode(e.multihash.bytes));if(n==null)throw new Ni;yield*n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(Tr.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(Tr.encode(e.multihash.bytes))}*getAll(e){e?.signal?.throwIfAborted();for(let[t,n]of this.data.entries())yield{cid:j.createV1(vt,Xe(Tr.decode(t))),bytes:(async function*(){yield*n})()},e?.signal?.throwIfAborted()}};var oxe=Ze("blockstore:core:tiered");var bR="SHARDING";function EG(r){return r[Symbol.asyncIterator]!=null}function SG(r,e){return EG(r)?(async function*(){yield*(await fo(r)).sort(e)})():(function*(){yield*fo(r).sort(e)})()}var i4=SG;var js=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await ln(this.putMany(e,n)),e=[],await ln(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let i=e.prefix;n=Cn(n,o=>o.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,o)=>Cn(i,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,o)=>i4(i,o),n)),e.offset!=null){let i=0,o=e.offset;n=Cn(n,()=>i++>=o)}return e.limit!=null&&(n=Qa(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let i=e.prefix;n=Cn(n,o=>o.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,o)=>Cn(i,o),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,o)=>i4(i,o),n)),e.offset!=null){let i=e.offset,o=0;n=Cn(n,()=>o++>=i)}return e.limit!=null&&(n=Qa(n,e.limit)),n}};var Hl=class extends js{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(e.toString());if(n==null)throw new Ni;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(let[n,i]of this.data.entries())yield{key:new lt(n),value:i},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(let n of this.data.keys())yield new lt(n),t?.signal?.throwIfAborted()}};var Mxe=new lt(bR);var Qxe=Ze("datastore:core:tiered");async function ER(r){if(r.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new O("Private network is enforced, but no protector was provided");return r}var Tm;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={publicKey:ke(0),payloadType:ke(0),payload:ke(0),signature:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=t.bytes();break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Tm||(Tm={}));var o4=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var hi=class r{static createFromProtobuf=e=>{let t=Tm.decode(e),n=er(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let i=e.domain,o=e.codec,s=e.marshal(),a=SR(i,o,s),c=await t.sign(a.subarray(),n);return new r({publicKey:t.publicKey,payloadType:o,payload:s,signature:c})};static openAndCertify=async(e,t,n)=>{let i=r.createFromProtobuf(e);if(!await i.validate(t,n))throw new o4("Envelope signature is not valid for the given domain");return i};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:i,signature:o}=e;this.publicKey=t,this.payloadType=n,this.payload=i,this.signature=o}marshal(){return this.marshaled==null&&(this.marshaled=Tm.encode({publicKey:ar(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:me(this.marshal(),e.marshal())}async validate(e,t){let n=SR(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}},SR=(r,e,t)=>{let n=R(r),i=sn(n.byteLength),o=sn(e.length),s=sn(t.length);return new oe(i,n,o,e,s,t)};var AR="libp2p-peer-record",_R=Uint8Array.from([3,1]);var Im;(function(r){let e;(function(n){let i;n.codec=()=>(i==null&&(i=ve((o,s,a={})=>{a.lengthDelimited!==!1&&s.fork(),o.multiaddr!=null&&o.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(o.multiaddr)),a.lengthDelimited!==!1&&s.ldelim()},(o,s,a={})=>{let c={multiaddr:ke(0)},l=s==null?o.len:o.pos+s;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:{c.multiaddr=o.bytes();break}default:{o.skipType(u&7);break}}}return c})),i),n.encode=o=>be(o,n.codec()),n.decode=(o,s)=>xe(o,n.codec(),s)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=ve((n,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(i.uint32(10),i.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(i.uint32(16),i.uint64(n.seq)),n.addresses!=null)for(let s of n.addresses)i.uint32(26),r.AddressInfo.codec().encode(s,i);o.lengthDelimited!==!1&&i.ldelim()},(n,i,o={})=>{let s={peerId:ke(0),seq:0n,addresses:[]},a=i==null?n.len:n.pos+i;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{s.peerId=n.bytes();break}case 2:{s.seq=n.uint64();break}case 3:{if(o.limits?.addresses!=null&&s.addresses.length===o.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:o.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return s})),t),r.encode=n=>be(n,r.codec()),r.decode=(n,i)=>xe(n,r.codec(),i)})(Im||(Im={}));function CR(r,e){let t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}var Tn=class r{static createFromProtobuf=e=>{let t=Im.decode(e),n=ur(Xe(t.peerId)),i=(t.addresses??[]).map(s=>se(s.multiaddr)),o=t.seq;return new r({peerId:n,multiaddrs:i,seqNumber:o})};static DOMAIN=AR;static CODEC=_R;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Im.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!CR(this.multiaddrs,e.multiaddrs))}};var Ws;(function(r){let e;(function(i){let o;i.codec=()=>(o==null&&(o=ve((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&s.value.byteLength>0&&(a.uint32(18),a.bytes(s.value)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:"",value:ke(0)},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(f&7);break}}}return l})),o),i.encode=s=>be(s,i.codec()),i.decode=(s,a)=>xe(s,i.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(i){let o;i.codec=()=>(o==null&&(o=ve((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&(a.uint32(18),a4.codec().encode(s.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:""},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=a4.codec().decode(s,s.uint32(),{limits:c.limits?.value});break}default:{s.skipType(f&7);break}}}return l})),o),i.encode=s=>be(s,i.codec()),i.decode=(s,a)=>xe(s,i.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.addresses!=null)for(let a of i.addresses)o.uint32(10),s4.codec().encode(a,o);if(i.protocols!=null)for(let a of i.protocols)o.uint32(18),o.string(a);if(i.publicKey!=null&&(o.uint32(34),o.bytes(i.publicKey)),i.peerRecordEnvelope!=null&&(o.uint32(42),o.bytes(i.peerRecordEnvelope)),i.metadata!=null&&i.metadata.size!==0)for(let[a,c]of i.metadata.entries())o.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},o);if(i.tags!=null&&i.tags.size!==0)for(let[a,c]of i.tags.entries())o.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},o);i.updated!=null&&(o.uint32(64),o.uint64Number(i.updated)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&a.addresses.length===s.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');a.addresses.push(s4.codec().decode(i,i.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&a.protocols.length===s.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');a.protocols.push(i.string());break}case 4:{a.publicKey=i.bytes();break}case 5:{a.peerRecordEnvelope=i.bytes();break}case 6:{if(s.limits?.metadata!=null&&a.metadata.size===s.limits.metadata)throw new xp('Decode error - map field "metadata" had too many elements');let u=r.Peer$metadataEntry.codec().decode(i,i.uint32());a.metadata.set(u.key,u.value);break}case 7:{if(s.limits?.tags!=null&&a.tags.size===s.limits.tags)throw new xp('Decode error - map field "tags" had too many elements');let u=r.Peer$tagsEntry.codec().decode(i,i.uint32(),{limits:{value:s.limits?.tags$value}});a.tags.set(u.key,u.value);break}case 8:{a.updated=i.uint64Number();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(Ws||(Ws={}));var s4;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={multiaddr:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.multiaddr=t.bytes();break}case 2:{o.isCertified=t.bool();break}case 3:{o.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(s4||(s4={}));var a4;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.value=t.uint32();break}case 2:{o.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(a4||(a4={}));function AG(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());let n=er(e.publicKey,t);return Wo(n)}function TR(r,e,t){let n=Ws.decode(e);return hd(r,n,t)}function hd(r,e,t){let n=new Map,i=BigInt(Date.now());for(let[o,s]of e.tags.entries())s.expiry!=null&&s.expiry<i||n.set(o,s);return{...e,id:AG(r,e),addresses:e.addresses.filter(({observed:o})=>o!=null&&o>Date.now()-t).map(({multiaddr:o,isCertified:s})=>({multiaddr:se(o),isCertified:s??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function IR(r,e){return _G(r.addresses,e.addresses)&&CG(r.protocols,e.protocols)&&TG(r.publicKey,e.publicKey)&&IG(r.peerRecordEnvelope,e.peerRecordEnvelope)&&kG(r.metadata,e.metadata)&&PG(r.tags,e.tags)}function _G(r,e){return PR(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!me(t.multiaddr,n.multiaddr)))}function CG(r,e){return PR(r,e,(t,n)=>t===n)}function TG(r,e){return kR(r,e)}function IG(r,e){return kR(r,e)}function kG(r,e){return RR(r,e,(t,n)=>me(t,n))}function PG(r,e){return RR(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function kR(r,e){return r==null&&e==null?!0:r!=null&&e!=null?me(r,e):!1}function PR(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function RR(r,e,t){if(r.size!==e.size)return!1;for(let[n,i]of r.entries()){let o=e.get(n);if(o==null||!t(i,o))return!1}return!0}var K9="/peers/";function km(r){if(!_r(r)||r.type==null)throw new O("Invalid PeerId");let e=r.toCID().toString();return new lt(`${K9}${e}`)}async function DR(r,e,t,n,i){let o=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=se(s.multiaddr)),!jo(s.multiaddr))throw new O("Multiaddr was invalid");if(!await e(r,s.multiaddr,i))continue;let a=s.isCertified??!1,c=s.multiaddr.toString(),l=o.get(c);l!=null?s.isCertified=l.isCertified||a:o.set(c,{multiaddr:s.multiaddr,isCertified:a})}return[...o.values()].sort((s,a)=>s.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:s,multiaddr:a})=>{let c=a.getComponents().find(l=>l.code===421)?.value;return r.equals(c)&&(a=a.decapsulate(se(`/p2p/${r}`))),{isCertified:s,multiaddr:a.bytes}})}async function l4(r,e,t,n){if(e==null)throw new O("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new O("publicKey bytes do not match peer id publicKey bytes");let i=n.existingPeer?.peer;if(i!=null&&!r.equals(i.id))throw new O("peer id did not match existing peer id");let o=i?.addresses??[],s=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,l=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(o=[],e.multiaddrs!=null&&o.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&o.push(...e.addresses)),e.protocols!=null&&(s=new Set(e.protocols)),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=c4(h,{validate:OR})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=c4(h,{validate:NR,map:LR})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&o.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&o.push(...e.addresses),e.protocols!=null&&(s=new Set([...s,...e.protocols])),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[d,m]of h)m==null?a.delete(d):a.set(d,m);a=c4([...a.entries()],{validate:OR})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),d=new Map(c);for(let[m,y]of h)y==null?d.delete(m):d.set(m,y);c=c4([...d.entries()],{validate:NR,map:LR})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;i?.id.publicKey!=null?u=ar(i.id.publicKey):e.publicKey!=null?u=ar(e.publicKey):r.publicKey!=null&&(u=ar(r.publicKey));let f={addresses:await DR(r,n.addressFilter??(async()=>!0),o,n.existingPeer?.peerPB.addresses,n),protocols:[...s.values()].sort((h,d)=>h.localeCompare(d)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return f.addresses.forEach(h=>{h.observed=n.existingPeer?.peerPB.addresses?.find(d=>me(d.multiaddr,d.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function c4(r,e){let t=new Map;for(let[n,i]of r)i!=null&&e.validate(n,i);for(let[n,i]of r.sort(([o],[s])=>o.localeCompare(s)))i!=null&&t.set(n,e.map?.(n,i)??i);return t}function OR(r,e){if(typeof r!="string")throw new O("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new O("Metadata value must be a Uint8Array")}function NR(r,e){if(typeof r!="string")throw new O("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new O("Tag value must be an integer");if(e.value<0||e.value>100)throw new O("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new O("Tag ttl must be an integer");if(e.ttl<0)throw new O("Tag ttl must be between greater than 0")}}function LR(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));let n={value:e.value??0};return t!=null&&(n.expiry=t),n}function BR(r){let e=r.toString().split("/")[2],t=j.parse(e,Tr);return En(t)}function q9(r,e,t){let n=BR(r);return TR(n,e,t)}function RG(r,e){return{prefix:K9,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(q9(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(q9(n.key,n.value,e),q9(i.key,i.value,e)))}}var u4=class{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Vs({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:wm({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){let n=this.getLock(e);try{let i=await n.lock.readLock(t);return()=>{i(),this.maybeRemoveLock(e,n)}}catch(i){throw this.maybeRemoveLock(e,n),i}}async getWriteLock(e,t){let n=this.getLock(e);try{let i=await n.lock.writeLock(t);return()=>{i(),this.maybeRemoveLock(e,n)}}catch(i){throw this.maybeRemoveLock(e,n),i}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(km(e),t)}async load(e,t){let n=km(e),i=await this.datastore.get(n,t),o=Ws.decode(i);if(this.#r(e,o))throw await this.datastore.delete(n,t),new je;return hd(e,o,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){let i=await this.#e(e,n),o=await l4(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,o,i)}async patch(e,t,n){let i=await this.#e(e,n),o=await l4(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,o,i)}async merge(e,t,n){let i=await this.#e(e,n),o=await l4(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,o,i)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(RG(e??{},this.maxAddressAge),e)){let i=BR(t);if(i.equals(this.peerId))continue;let o=Ws.decode(n);if(this.#r(i,o)){await this.datastore.delete(t,e);continue}yield hd(i,o,this.peerId.equals(i)?1/0:this.maxAddressAge)}}async#e(e,t){try{let n=km(e),i=await this.datastore.get(n,t),o=Ws.decode(i);if(this.#r(e,o))throw await this.datastore.delete(n,t),new je;return{peerPB:o,peer:hd(e,o,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,i){t.updated=Date.now();let o=Ws.encode(t);return await this.datastore.put(km(e),o,i),{peer:hd(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!IR(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,o=t.addresses.filter(s=>s.observed!=null&&s.observed>i);return n&&o.length===0}};var j9=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new u4(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(let n of this.store.all(t))e(n)}async all(e){return fo(this.store.all(e))}async delete(e,t){let n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){let n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:i})=>i)}}async save(e,t,n){let i=await this.store.getWriteLock(e,n);try{let o=await this.store.save(e,t,n);return this.#e(e,o),o.peer}finally{i?.()}}async patch(e,t,n){let i=await this.store.getWriteLock(e,n);try{let o=await this.store.patch(e,t,n);return this.#e(e,o),o.peer}finally{i?.()}}async merge(e,t,n){let i=await this.store.getWriteLock(e,n);try{let o=await this.store.merge(e,t,n);return this.#e(e,o),o.peer}finally{i?.()}}async consumePeerRecord(e,t,n){let i=_r(t)?t:_r(t?.expectedPeer)?t.expectedPeer:void 0,o=_r(t)||t===void 0?n:t,s=await hi.openAndCertify(e,Tn.DOMAIN,o),a=En(s.publicKey.toCID());if(i?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",i,a),!1;let c=Tn.createFromProtobuf(s.payload),l;try{l=await this.get(a,o)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){let u=hi.createFromProtobuf(l.peerRecordEnvelope),f=Tn.createFromProtobuf(u.payload);if(f.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},o),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function MR(r,e={}){return new j9(r,e)}var UR=864e13;var f4=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=lr({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){let t=Te(e),n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(let i of this.mappings.values())if(i.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let i=Hf(n)===!0;this.mappings.set(n,{domain:e,verified:i,expires:i?UR-Date.now():0,lastVerified:i?UR-Date.now():void 0})})}remove(e){let t=Te(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[i,o]of this.mappings.entries())o.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",i,o.domain),this.mappings.delete(i),n=n||o.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let i=e[n].multiaddr;if(!Vr(i))continue;let o=Te(i);for(let[s,a]of this.mappings.entries()){if(o.host!==s)continue;let c=this.maybeAddSNIComponent(i,a.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:a.verified,type:"dns-mapping",expires:a.expires,lastVerified:a.lastVerified}))}}return t}maybeAddSNIComponent(e,t){let n=e.getComponents();for(let i=0;i<n.length;i++)if(n[i].code===448&&n[i+1]?.code!==449)return n.splice(i+1,0,{name:"sni",code:449,value:t}),se(n)}confirm(e,t){let n=Te(e),i=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(i=n.sni);let o=!1;for(let[s,a]of this.mappings.entries())a.domain===i&&(this.log("marking %s to %s DNS mapping as verified",s,a.domain),o=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return o}unconfirm(e,t){let n=Te(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;let i=n.sni??n.host,o=!1;for(let[s,a]of this.mappings.entries())a.domain===i&&(this.log("removing verification of %s to %s DNS mapping",s,a.domain),o=o||a.verified,a.verified=!1,a.expires=Date.now()+t);return o}};var d4=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=lr({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){let t=Te(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(let n of this.mappings.values())for(let i of n)if(i.externalIp===t.host)return!0;return!1}add(e,t,n,i=t,o="tcp"){let s=`${e}-${t}-${o}`,a=this.mappings.get(s)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:i,externalFamily:so(n)?4:6,protocol:o,verified:!1,expires:0};a.push(c),this.mappings.set(s,a)}remove(e){let t=Te(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[i,o]of this.mappings.entries()){for(let s=0;s<o.length;s++){let a=o[s];a.externalIp===t.host&&a.externalPort===t.port&&a.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,t.host,t.port,t.protocol),n=n||a.verified,o.splice(s,1),s--)}o.length===0&&this.mappings.delete(i)}return n}getAll(e){let t=[];for(let{multiaddr:n}of e){if(!Vr(n))continue;let i=Te(n);if(i.type!=="ip4"&&i.type!=="ip6")continue;let o;if(i.protocol==="tcp"?o=`${i.host}-${i.port}-tcp`:i.protocol==="udp"&&(o=`${i.host}-${i.port}-udp`),o==null)continue;let s=this.mappings.get(o);if(s!=null)for(let a of s)t.push({multiaddr:this.maybeOverrideIp(n,a.externalIp,a.externalFamily,a.protocol,a.externalPort),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}maybeOverrideIp(e,t,n,i,o){let s=e.getComponents(),a=s.findIndex(l=>l.code===4||l.code===41),c=s.findIndex(l=>l.name===i);return a>-1&&c>-1?(s[a].value=t,s[a].code=n===4?4:41,s[c].value=`${o}`,se(s)):e}confirm(e,t){if(!Vr(e))return!1;let n=Te(e),i=!1;for(let o of this.mappings.values())for(let s of o)s.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",s.internalIp,s.externalIp),i=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return i}unconfirm(e,t){if(!Vr(e))return!1;let n=Te(e),i=!1;for(let o of this.mappings.values())for(let s=0;s<o.length;s++){let a=o[s];a.externalIp===n.host&&a.externalPort===n.port&&a.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,n.host,n.port,n.protocol),i=i||a.verified,a.verified=!1,a.expires=Date.now()+t)}return i}};var DG={maxObservedAddresses:10},h4=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=lr({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??DG.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(qt(e)||jI(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:se(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),i=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},o=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,i),o}};var OG={maxObservedAddresses:10},p4=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=lr({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??OG.maxObservedAddresses}get(e,t){if(qt(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),i=this.addresses.get(n);return i==null&&(i={verified:!Vr(e),expires:0},this.addresses.set(n,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},o=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(n,i),o}unconfirm(e,t){let n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0},o=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(n,i),o}toKey(e){if(!Vr(e))return e.toString();let t=Te(e);return`${t.host}-${t.port}-${t.protocol}`}};var FR=6e4,$R={maxObservedAddresses:10,addressVerificationTTL:FR*10,addressVerificationRetry:FR*5},NG=r=>r;function W9(r,e){let t=r.getComponents().findLast(n=>n.code===421)?.value;return t!=null&&tt(t).equals(e)&&(r=r.decapsulate(se(`/p2p/${e.toString()}`))),r}var m4=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){let{listen:n=[],announce:i=[],appendAnnounce:o=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(s=>s.toString()),this.announce=new Set(i.map(s=>s.toString())),this.appendAnnounce=new Set(o.map(s=>s.toString())),this.observed=new h4(e,t),this.dnsMappings=new f4(e,t),this.ipMappings=new d4(e,t),this.transportAddresses=new p4(e,t),this.announceFilter=t.announceFilter??NG,this.observedAddressFilter=Rr(1024),this.addressVerificationTTL=t.addressVerificationTTL??$R.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??$R.addressVerificationRetry,this._updatePeerStoreAddresses=Ls(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===421)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>se(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>se(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>se(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=Te(e),n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=W9(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=W9(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=W9(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let i=n.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let i=se(n);return i.getComponents().pop()?.value===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(n)}),t=t.concat(n.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(se(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,i=t,o="tcp"){this.ipMappings.add(e,t,n,i,o),this.observed.removePrefixed(`/ip${so(n)?4:6}/${n}/${o}/${i}`)}removePublicAddressMapping(e,t,n,i=t,o="tcp"){this.ipMappings.remove(se(`/ip${so(n)?4:6}/${n}/${o}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!Vr(e))return!1;let t=Te(e);if(t.type!=="ip4"||Hf(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),i=[o=>Hs.exactMatch(o)||kl.exactMatch(o),o=>Il.exactMatch(o),o=>Ak.exactMatch(o)];for(let o of i){if(!o(e))continue;let s=n.filter(l=>l.getAddrs().filter(u=>Te(u).type==="ip4"&&o(u)).length>0);if(s.length!==1)continue;let a=s[0].getAddrs().filter(l=>!$p(l)).pop();if(a==null)continue;let c=Te(a);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}};var HR;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(HR||(HR={}));var g4=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},y4=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},pd=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},Pm=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},w4=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},x4=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},b4=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},Rm=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},v4=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},E4=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},S4=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},A4=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},_4=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},nc=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},Vl=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},C4=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}},T4=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}};var G9=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Na())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>Ag(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},LG=["metrics","connectionProtector","dns"],BG=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function VR(r={}){let e=new G9(r);return new Proxy(e,{get(n,i,o){if(typeof i=="string"&&!BG.includes(i)){let s=e.components[i];if(s==null&&!LG.includes(i))throw new g4(`${i} not set`);return s}return Reflect.get(n,i,o)},set(n,i,o){return typeof i=="string"?e.components[i]=o:Reflect.set(n,i,o),!0}})}function zR(r){let e={};for(let t of Object.values(r.components))for(let n of MG(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of UG(t))if(e[n]!==!0)throw new y4(`Service "${FG(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function MG(r){return Array.isArray(r?.[Ge])?r[Ge]:[]}function UG(r){return Array.isArray(r?.[ni])?r[ni]:[]}function FG(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function KR(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>Hs.matches(e)?!0:qt(e)),r}function I4(r){if(_r(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getComponents().findLast(i=>i.code===421)?.value;t=n==null?void 0:tt(n),e.forEach(i=>{if(!jo(i))throw new No("Invalid multiaddr");let o=i.getComponents().findLast(s=>s.code===421)?.value;if(o==null){if(t!=null)throw new O("Multiaddrs must all have the same peer id or have no peer id")}else{let s=tt(o);if(t?.equals(s)!==!0)throw new O("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!xk.exactMatch(n)),{peerId:t,multiaddrs:e}}var $G=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function qR(r,e){let t=r?.streams?.map(i=>i.protocol)??[],n=e?.closableProtocols??$G;if(!(t.filter(i=>i!=null&&!n.includes(i)).length>0))try{await r?.close(e)}catch(i){r?.abort(i)}}function Dm(r){let e=Te(r),t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new O(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new O(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new vl(e.host,t)}function X9(r){return!Or.exactMatch(r)}function k4(r,e,t){if(r==null||e==null)return;let n=e.sort((o,s)=>o.direct?-1:s.direct?1:0).find(o=>o.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(o=>X9(o)))return n}var P4=class{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Dm(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;let i=new un;for(let c of e){let l=c.remotePeer;if(!i.has(l)){i.set(l,0);try{let u=await this.peerStore.get(l);i.set(l,[...u.tags.values()].reduce((f,h)=>f+h.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",u)}}}let o=this.sortConnections(e,i),s=Math.max(t-n,0),a=[];for(let c of o)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>{if(Vr(c.remoteAddr)){let f=Te(c.remoteAddr);return u.contains(f.host)}return!0})||a.push(c),a.length===s)break;await Promise.all(a.map(async c=>{await qR(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,i)=>{let o=n.timeline.open,s=i.timeline.open;return o<s?1:o>s?-1:0}).sort((n,i)=>n.direction==="outbound"&&i.direction==="inbound"?1:n.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((n,i)=>n.streams.length>i.streams.length?1:n.streams.length<i.streams.length?-1:0).sort((n,i)=>{let o=t.get(n.remotePeer)??0,s=t.get(i.remotePeer)??0;return o>s?1:o<s?-1:0})}};var jR="last-dial-failure",WR="last-dial-success";var GR=100,R4=50;function HG(r,e){let t=Il.exactMatch(r.multiaddr),n=Il.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let i=kl.exactMatch(r.multiaddr),o=kl.exactMatch(e.multiaddr);if(i&&!o)return-1;if(!i&&o)return 1;let s=Hs.exactMatch(r.multiaddr),a=Hs.exactMatch(e.multiaddr);if(s&&!a)return-1;if(!s&&a)return 1;let c=Zp.exactMatch(r.multiaddr),l=Zp.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let u=Qp.exactMatch(r.multiaddr),f=Qp.exactMatch(e.multiaddr);if(u&&!f)return-1;if(!u&&f)return 1;let h=Ob.exactMatch(r.multiaddr),d=Ob.exactMatch(e.multiaddr);return h&&!d?-1:!h&&d?1:0}function VG(r,e){let t=$p(r.multiaddr),n=$p(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function zG(r,e){let t=qt(r.multiaddr),n=qt(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function KG(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function qG(r,e){let t=Or.exactMatch(r.multiaddr),n=Or.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function XR(r){return r.sort(HG).sort(KG).sort(qG).sort(zG).sort(VG)}var Y9=class{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){let n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];let o=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[dn.TXT]}),s=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(let c of o.Answer){let l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(s!=null&&!l.includes(s)||a.push(se(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=Ll()),this.dns)}},Om=new Y9;async function Q9(r,e,t){let n=t.depth??0;if(n>(t.maxRecursiveDepth??32))throw new T4("Max recursive depth reached");let i=!1,o=[];for(let s of Object.values(e))if(s.canResolve(r)){i=!0;let a=await s.resolve(r,t);for(let c of a)o.push(...await Q9(c,e,{...t,depth:n+1}))}return i===!1&&o.push(r),o}var Nm={maxParallelDials:R4,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:Om}},D4=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Nm.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Nm.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Nm.dialTimeout,this.connections=t.connections??new un,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Nm.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new ey({concurrency:t.maxParallelDials??Nm.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==St.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:i}=I4(e);if(n!=null&&t.force!==!0){let s=k4(n,this.connections.get(n),i);if(s!=null)return this.log("already connected to %a",s.remoteAddr),t.onProgress?.(new G("dial-queue:already-connected")),s}let o=this.queue.queue.find(s=>{if(n?.equals(s.options.peerId)===!0)return!0;let a=s.options.multiaddrs;if(a==null)return!1;for(let c of i)if(a.has(c.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(let s of i)o.options.multiaddrs.add(s.toString());return t.onProgress?.(new G("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ba("Dial queue is full");return this.log("creating dial target for %p",n,i.map(s=>s.toString())),t.onProgress?.(new G("dial-queue:add-to-dial-queue")),this.queue.add(async s=>{s.onProgress?.(new G("dial-queue:start-dial"));let a=Oe([this.shutDownController.signal,s.signal]);try{return await this.dialPeer(s,a)}finally{a.clear()}},{peerId:n,priority:t.priority??tv,multiaddrs:new Set(i.map(s=>s.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,i=e.multiaddrs,o=new Set,s=e.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);s||i.size>0;){c++,s=!1;let u=[],f=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let h=await this.calculateMultiaddrs(n,f,{...e,signal:t});for(let d of h){if(o.has(d.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",d.multiaddr,n);continue}u.push(d)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(d=>d.multiaddr.toString())),e?.onProgress?.(new G("dial-queue:calculated-addresses",u));for(let d of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new ba("Peer had more than maxPeerAddrsToDial");a++;try{let m=await this.components.transportManager.dial(d.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",d.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[WR]:R(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}return m}catch(m){if(this.log.error("dial failed to %a - %e",d.multiaddr,m),o.add(d.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[jR]:R(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}if(t.aborted)throw new Lo(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let i=[...t].map(f=>({multiaddr:se(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ba("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Rm("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{let f=await this.components.peerStore.get(e);i.push(...f.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:h})=>h.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let f=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:h})=>h.toString())),i.push(...f.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,f)}}}let o=(await Promise.all(i.map(async f=>{let h=await Q9(f.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return h.length===1&&h[0].equals(f.multiaddr)?f:h.map(d=>({multiaddr:d,isCertified:!1}))}))).flat();if(e!=null){let f=`/p2p/${e.toString()}`;o=o.map(h=>h.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:h.multiaddr.encapsulate(f),isCertified:h.isCertified}:h)}let s=o.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let h=f.multiaddr.getComponents().findLast(d=>d.code===421)?.value;return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(let f of s){let h=f.multiaddr.toString(),d=a.get(h);if(d!=null){d.isCertified=d.isCertified||f.isCertified||!1;continue}a.set(h,f)}let c=[...a.values()];if(c.length===0)throw new S4("The dial request has no valid addresses");let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=this.addressSorter==null?XR(l):l.sort(this.addressSorter);if(u.length===0)throw new Rm("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",o.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?n.find(i=>!Or.matches(i.multiaddr))!=null:!0}catch{}return!1}};var jG=Object.prototype.toString,WG=r=>jG.call(r)==="[object Error]",GG=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function rv(r){if(!(r&&WG(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;let{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:GG.has(t)}function XG(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function O4(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be \u2265 ${t}.`)}}var nv=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function YG(r,e){let t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1,i=Math.round(n*e.minTimeout*e.factor**(t-1));return i=Math.min(i,e.maxTimeout),i}function YR(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function QG({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:i}){let o=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(o instanceof nv)throw o.originalError;let s=Number.isFinite(i.retries)?Math.max(0,i.retries-t):i.retries,a=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:o,attemptNumber:e,retriesLeft:s,retriesConsumed:t});if(await i.onFailedAttempt(c),YR(n,a)<=0)throw o;let l=await i.shouldConsumeRetry(c),u=YR(n,a);if(u<=0||s<=0)throw o;if(o instanceof TypeError&&!rv(o)){if(l)throw o;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw o;if(!l)return i.signal?.throwIfAborted(),!1;let f=YG(t,i),h=Math.min(f,u);return h>0&&await new Promise((d,m)=>{let y=()=>{clearTimeout(w),i.signal?.removeEventListener("abort",y),m(i.signal.reason)},w=setTimeout(()=>{i.signal?.removeEventListener("abort",y),d()},h);i.unref&&w.unref?.(),i.signal?.addEventListener("abort",y,{once:!0})}),i.signal?.throwIfAborted(),!0}async function iv(r,e={}){if(e={...e},XG(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,O4("factor",e.factor,{min:0,allowInfinity:!1}),O4("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),O4("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),O4("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0,i=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();let o=await r(t);return e.signal?.throwIfAborted(),o}catch(o){await QG({error:o,attemptNumber:t,retriesConsumed:n,startTime:i,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var N4=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Kr({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,i)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);QR(t)&&(this.queue.has(e)||this.queue.add(async n=>{await iv(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(o){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,o),o}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let i={};[...t.tags.keys()].forEach(o=>{o.startsWith(Wc)&&(i[o]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>QR(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}};function QR(r){for(let e of r.tags.keys())if(e.startsWith(Wc))return!0;return!1}var tv=50,ov={maxConnections:GR,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},L4=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??ov.maxConnections,this.maxConnections<1)throw new O("Connection Manager maxConnections must be greater than 0");this.connections=new un,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Dm(se(n))),this.deny=(t.deny??[]).map(n=>Dm(se(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??ov.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new Xf({points:t.inboundConnectionThreshold??ov.inboundConnectionThreshold,duration:1}),this.connectionPruner=new P4({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>se(n))}),this.dialQueue=new D4(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??R4,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:Om},connections:this.connections}),this.reconnectQueue=new N4({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let i of n.streams){let o=`${i.direction} ${i.protocol??"unnegotiated"}`;e[o]=(e[o]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let i of n){let o={};for(let s of i.streams){let a=`${s.direction} ${s.protocol??"unnegotiated"}`;o[a]=(o[a]??0)+1}for(let[s,a]of Object.entries(o))e[s]=e[s]??[],e[s].push(a)}let t={};for(let[n,i]of Object.entries(e)){i=i.sort((s,a)=>s-a);let o=Math.floor(i.length*.9);t[n]=i[o]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await wr(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Cr(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push(Promise.all([st(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(i=>{n.abort(i)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new O("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,i=!this.connections.has(n),o=this.connections.get(n)??[];o.push(t),this.connections.set(n,o),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,o=(this.connections.get(n)??[]).filter(s=>s.id!==t.id);this.connections.set(n,o),o.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new ri("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n,multiaddrs:i}=I4(e);if(this.peerId.equals(n))throw new rf("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let c=k4(n,this.getConnections(n),i);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new G("dial-queue:already-connected")),c}let o=await this.dialQueue.dial(e,{...t,priority:t.priority??tv});if(o.status!=="open")throw new zc("Remote closed connection during opening");let s=this.connections.get(o.remotePeer);s==null&&(s=[],this.connections.set(o.remotePeer,s));let a=!1;for(let c of s)if(c.id===o.id&&(a=!0),t.force!==!0&&c.id!==o.id&&c.remoteAddr.equals(o.remoteAddr))return o.abort(new No("Duplicate multiaddr connection")),c;return a||s.push(o),o}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await Promise.all([st(i,"close",t),i.close(t)])}catch(o){i.abort(o)}}))}acceptIncomingConnection(e){if(this.deny.some(i=>{if(Vr(e.remoteAddr)){let o=Te(e.remoteAddr);return i.contains(o.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>{if(Vr(e.remoteAddr)){let o=Te(e.remoteAddr);return i.contains(o.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(Vr(e.remoteAddr)){let i=Te(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(i.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>se(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var eX=1e4,tX="1.0.0",rX="ping",nX="ipfs",ZR=32,iX=!0,B4=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??nX}/${rX}/${tX}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??eX,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??iX,this.timeout=new ao({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[Ge]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),i=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),o=W2(i);t=Date.now(),await Promise.all([o.write(wn(ZR),{signal:n}),o.read({bytes:ZR,signal:n})]),e.rtt=Date.now()-t,await i.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var M4=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()}),getAttributesFromYieldedValue:(n,i)=>({...i,providers:[...Array.isArray(i.providers)?i.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:K(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:K(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");let n=this,i=new fi;for await(let o of bn(...n.routers.filter(s=>s.findProviders instanceof Function).map(s=>s.findProviders(e,t))))o!=null&&(o.multiaddrs.length>0&&await this.components.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),!i.has(o.id)&&(i.add(o.id),yield o))}async provide(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new ri;await Promise.all(this.routers.filter(i=>i.put instanceof Function).map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new ri;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}};var U4=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,key:K(n,"base36")}),getAttributesFromYieldedValue:(n,i)=>({...i,peers:[...Array.isArray(i.peers)?i.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Pm("No peer routers available");if(e.toString()===this.peerId.toString())throw new w4("Should not try to find self");let n=this,i=bn(...this.routers.filter(o=>o.findPeer instanceof Function).map(o=>(async function*(){try{yield await o.findPeer(e,t)}catch(s){n.log.error("router failed to find peer - %e",s)}})()));for await(let o of i)if(o!=null)return o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),o;throw new je}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Pm("No peer routers available");let n=this,i=Rr(1024);for await(let o of vn((async function*(){let s=bn(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of s)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return a}})()))o!=null&&(o.multiaddrs.length>0&&await this.peerStore.merge(o.id,{multiaddrs:o.multiaddrs},t),!i.has(o.id.toMultihash().bytes)&&(i.add(o.id.toMultihash().bytes),yield o))}};var F4=class extends Ce{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=Oe([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=We(),yield(await st(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=Oe([this.walkController.signal,this.shutdownController.signal]);let t=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let i=wn(32),o=Date.now();for await(let s of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-o,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Et(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,n)}catch(i){this.log.error("random walk errored - %e",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored - %e",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}};var sv=32,av=64,$4=class{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let t={};for(let[n,i]of this.topologies)t[n]=i.size;return t}}),this.handlers=lr({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new x4(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new b4(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:sv,maxOutboundStreams:av,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(i=>{this.handlers.delete(i)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new O("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){let t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{let i=await this.components.peerStore.get(t,n);for(let o of i.protocols){let s=this.topologies.get(o);s!=null&&await Promise.all([...s.values()].map(async a=>{a.filter?.has(t)!==!1&&(a.filter?.remove(t),await a.onDisconnect?.(t))}))}}catch(i){if(i.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,i)}}async _onPeerUpdate(e){let{peer:t,previous:n}=e.detail,i=(n?.protocols??[]).filter(o=>!t.protocols.includes(o));try{for(let o of i){let s=this.topologies.get(o);s!=null&&await Promise.all([...s.values()].map(async a=>{a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),await a.onDisconnect?.(t.id))}))}}catch(o){this.log.error("could not inform topologies of updated peer %p - %e",t.id,o)}}async _onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;try{for(let o of t){let s=this.topologies.get(o);s!=null&&await Promise.all([...s.values()].map(async a=>{n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(i)!==!0&&(a.filter?.add(i),await a.onConnect?.(i,n))}))}}catch(o){this.log.error("could not inform topologies of updated peer after identify %p - %e",i,o)}}};var H4=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=lr({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=lr({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Xh.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(t==null)throw new O("Transport must have a valid tag");if(this.transports.has(t))throw new O(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new C4(`No transport available for address ${String(e)}`);return t?.onProgress?.(new G("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new ri("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(o=>{t.errors.set(o.toString(),new v4)});let n=[];for(let[o,s]of this.transports.entries()){let a=s.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",o,c);let l=s.createListener({upgrader:this.components.upgrader}),u=this.listeners.get(o)??[];u==null&&(u=[],this.listeners.set(o,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let f=u.findIndex(h=>h===l);u.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),kb.matches(c)?t.ipv4.attempts++:Pb.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),kb.matches(c)&&t.ipv4.success++,Pb.matches(c)&&t.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",o,c,f),t.errors.set(c.toString(),f),f}))}}let i=await Promise.allSettled(n);if(!(i.length>0&&i.every(o=>o.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Xh.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new E4(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([o,s])=>`
  ${o}: ${`${oX(s)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};function oX(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}var Go="/multistream/1.0.0";var sX=R(`
`);async function Lm(r,e){let n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==sX[0])throw new Ue("Missing newline");return K(n).trimEnd()}async function md(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");let n=r.log.newScope("mss:select"),i=za(r,{...t,maxDataLength:1024});for(let o=0;o<e.length;o++){let s=e[o],a;if(o===0){n.trace('write ["%s", "%s"]',Go,s);let c=R(`${Go}
`),l=R(`${s}
`);if(await i.writeV([c,l],t),n.trace("reading multistream-select header"),a=await Lm(i,t),n.trace('read "%s"',a),a!==Go){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',s),await i.write(R(`${s}
`),t);if(n.trace("reading protocol response"),a=await Lm(i,t),n.trace('read "%s"',a),a===s)return n.trace('selected "%s" after negotiation',a),i.unwrap(),s}throw new nf(`Protocol selection failed - could not negotiate ${e}`)}async function gd(r,e,t={}){e=Array.isArray(e)?e:[e];let n=r.log.newScope("mss:handle"),i=za(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){n.trace("reading incoming string");let o=await Lm(i,t);if(n.trace('read "%s"',o),o===Go){n.trace('respond with "%s" for "%s"',Go,o),await i.write(R(`${Go}
`),t),n.trace('responded with "%s" for "%s"',Go,o);continue}if(e.includes(o))return n.trace('respond with "%s" for "%s"',o,o),await i.write(R(`${o}
`),t),n.trace('responded with "%s" for "%s"',o,o),i.unwrap(),o;if(o==="ls"){let s=new oe(...e.map(a=>$s.single(R(`${a}
`))),R(`
`));n.trace('respond with "%s" for %s',e,o),await i.write(s,t),n.trace('responded with "%s" for %s',e,o);continue}n.trace('respond with "na" for "%s"',o),await i.write(R(`na
`),t),n('responded with "na" for "%s"',o)}}var lv=class extends Ce{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.closeTimeout=t.closeTimeout??1e3,this.direct=X9(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===421)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new va(n.local,n.error))})}[Symbol.toStringTag]="Connection";[n_]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new nc("Connection is not multiplexed");if(this.muxer.status!=="open")throw new zc(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new zc(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new Gh("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);let n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);let a=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:a}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await md(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);let i=lX(n.protocol,this.components.registrar,t),o=tD(n.protocol,"outbound",this);if(o>i){let a=new of(`Too many outbound protocol streams for protocol "${n.protocol}" - ${o}/${i}`);throw n.abort(a),a}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);let s=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,s)}catch(i){throw n.status==="open"?n.abort(i):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,i),i}};async onIncomingStream(e){let t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){let l=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",l),t.protocol=await gd(t,l,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);let i=cX(t.protocol,this.components.registrar);if(tD(t.protocol,"inbound",this)>i)throw new xg(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${i}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);let{handler:s,options:a}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&a.runOnLimitedConnection!==!0)throw new Gh("Cannot open protocol stream on limited connection");let c=this.components.registrar.getMiddleware(t.protocol);c.push(async(l,u,f)=>{await s(l,u),f(l,u)}),await this.runMiddlewareChain(t,this,c)}catch(i){t.abort(i)}}async runMiddlewareChain(e,t,n){for(let i=0;i<n.length;i++){let o=n[i];e.log.trace("running middleware",i,o),await new Promise((s,a)=>{try{let c=o(e,t,(l,u)=>{e=l,t=u,s()});c instanceof Promise&&c.catch(a)}catch(c){a(c)}}),e.log.trace("ran middleware",i,o)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){let t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}};function rD(r,e){return new lv(r,e)}function cX(r,e){try{let{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return sv}function lX(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??av}function tD(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}var V4=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=lr({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=lr({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.connectionCloseTimeout=t.connectionCloseTimeout??1e3,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new A4(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=Oe([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,i=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new _4("Connection denied");await Et(this.shouldBlockConnection("denyInboundConnection",e),i),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(o){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[o.name??"Error"]:!0}),o}finally{i.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getComponents().findLast(s=>s.code===421)?.value,i;n!=null&&(i=tt(n),await Et(this.shouldBlockConnection("denyOutboundConnection",i,e),t.signal));let o="outbound";return t.initiator===!1&&(o="inbound"),await this._performUpgrade(e,o,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let i=e,o,s,a,c,l=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${l}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){let f=this.components.connectionProtector;f!=null&&(e.log("protecting the %s connection",t),i=await f.protect(i,n))}try{if(uX(n)){if(n.remotePeer==null)throw new No(`${t} connection that skipped encryption must have a peer id`);c="native",o=n.remotePeer}else{let f=e.remoteAddr.getComponents().findLast(d=>d.code===421)?.value,h;f!=null&&(h=tt(f)),n?.onProgress?.(new G(`upgrader:encrypt-${t}-connection`)),{connection:i,remotePeer:o,protocol:c,streamMuxer:s}=await(t==="inbound"?this._encryptInbound(i,{...n,remotePeer:h}):this._encryptOutbound(i,{...n,remotePeer:h}))}if(o.equals(this.components.peerId)){let f=new rf("Can not dial self");throw e.abort(f),f}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",o,e),n?.muxerFactory!=null?s=n.muxerFactory:s==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new G(`upgrader:multiplex-${t}-connection`)),s=await(t==="inbound"?this._multiplexInbound(i,this.streamMuxers,n):this._multiplexOutbound(i,this.streamMuxers,n)))}catch(f){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,f),f}s!=null&&(e.log("create muxer %s",s.protocol),a=s.createStreamMuxer(i)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",o,e);let u=this._createConnection({id:l,cryptoProtocol:c,direction:t,maConn:e,stream:i,muxer:a,remotePeer:o,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return u.log("successfully upgraded connection"),u}_createConnection(e){let t=rD(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let i=await gd(e,n,t),o=this.connectionEncrypters.get(i);if(o==null)throw new Vl(`no crypto module found for ${i}`);return e.log("encrypting inbound connection using %s",i),{...await o.secureInbound(e,t),protocol:i}}catch(i){throw new Vl(i.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let i=await md(e,n,t),o=this.connectionEncrypters.get(i);if(o==null)throw new Vl(`no crypto module found for ${i}`);return e.log("encrypting outbound connection using %s",i),{...await o.secureOutbound(e,t),protocol:i}}catch(i){throw new Vl(i.message)}}async _multiplexOutbound(e,t,n){let i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);let o=await md(e,i,n),s=t.get(o);if(s==null)throw new nc(`No muxer configured for protocol "${o}"`);return e.log("selected %s as muxer protocol",o),s}catch(o){throw e.log.error("error multiplexing outbound connection - %e",o),new nc(String(o))}}async _multiplexInbound(e,t,n){let i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{e.log.trace("selecting stream muxer from %s",i);let o=await gd(e,i,n),s=t.get(o);if(s==null)throw new nc(`No muxer configured for protocol "${o}"`);return e.log("selected %s as muxer protocol",o),s}catch(o){throw e.log.error("error multiplexing inbound connection - %e",o),o}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};function uX(r){return r.skipEncryption===!0}var z4="3.1.0",K4="js-libp2p";function q4(r,e){return`${r??K4}/${e??z4} browser/${globalThis.navigator.userAgent}`}var Bm=class extends Ce{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new Ce,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{let u=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||f},this.peerId=e.peerId,this.logger=e.logger??Na(),this.log=this.logger.forComponent("libp2p"),this.services={};let i=e.nodeInfo?.name??K4,o=e.nodeInfo?.version??z4,s=this.components=VR({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:o,userAgent:e.nodeInfo?.userAgent??q4(i,o)},logger:this.logger,events:t,datastore:e.datastore??new Hl,connectionGater:KR(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",MR(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),s.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new V4(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new H4(this.components,e.transportManager)),this.configureComponent("connectionManager",new L4(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new B4(this.components,e.connectionMonitor)),this.configureComponent("registrar",new $4(this.components)),this.configureComponent("addressManager",new m4(this.components,e.addresses));let a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new U4(this.components,{routers:a}));let c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new M4(this.components,{routers:c})),this.configureComponent("randomWalk",new F4(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(let l of Object.keys(e.services)){let u=e.services[l],f=u(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[Do]!=null&&(this.log("registering service %s for content routing",l),c.push(f[Do])),f[Bo]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[Bo])),f[jc]!=null&&(this.log("registering service %s for peer discovery",l),f[jc].addEventListener?.("peer",h=>{this.#e(h)}))}zR(s)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new fi;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new O("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new O("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){jo(e)&&(e=tt(e.getComponents().findLast(n=>n.code===421)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let s=await this.peerStore.get(e,t);if(s.id.publicKey!=null)return s.id.publicKey}catch(s){if(s.name!=="NotFoundError")throw s}let n=it([R("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(n,t),o=er(i);return await this.peerStore.patch(e,{publicKey:o},t),o}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}};async function j4(r={}){r.privateKey??=await Oa("Ed25519");let e=new Bm({...await ER(r),peerId:Zk(r.privateKey)});return r.start!==!1&&await e.start(),e}var fX=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function iD(r){return r==null?!1:r instanceof Bm?!0:fX.every(e=>typeof r[e]=="function")}var rO=bt(hD(),1);var uv={keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"};var yd={};Ut(yd,{create:()=>AX,derivedEmptyPasswordKey:()=>W4});var W4={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function AX(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,i=r?.digest??"SHA-256",o=r?.saltLength??16,s=r?.iterations??32767,a=cr.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(o)),m=a.getRandomValues(new Uint8Array(n)),y={name:e,iv:m};typeof h=="string"&&(h=R(h));let w;if(h.length===0){w=await a.subtle.importKey("jwk",W4,{name:"AES-GCM"},!0,["encrypt"]);try{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,E,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",W4,{name:"AES-GCM"},!0,["encrypt"])}}else{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,E,{name:e,length:t},!0,["encrypt"])}let x=await a.subtle.encrypt(y,w,f);return it([d,y.iv,new Uint8Array(x)])}async function l(f,h){let d=f.subarray(0,o),m=f.subarray(o,o+n),y=f.subarray(o+n),w={name:e,iv:m};typeof h=="string"&&(h=R(h));let x;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},_=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(E,_,{name:e,length:t},!0,["decrypt"])}catch{x=await a.subtle.importKey("jwk",W4,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:s,hash:{name:i}},_=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(E,_,{name:e,length:t},!0,["decrypt"])}let v=await a.subtle.decrypt(w,x,y);return new Uint8Array(v)}return{encrypt:c,decrypt:l}}var Mi={};Ut(Mi,{Any:()=>Yo,BaseBlock:()=>dr,BaseStringBlock:()=>$m,BitString:()=>wo,BmpString:()=>jl,Boolean:()=>Kl,CharacterString:()=>tu,Choice:()=>bd,Constructed:()=>hr,DATE:()=>jm,DateTime:()=>Gm,Duration:()=>Xm,EndOfContent:()=>Hm,Enumerated:()=>ql,GeneralString:()=>eu,GeneralizedTime:()=>ru,GraphicString:()=>Jl,HexBlock:()=>Qo,IA5String:()=>Zl,Integer:()=>pi,Null:()=>Hn,NumericString:()=>Gl,ObjectIdentifier:()=>mi,OctetString:()=>hn,Primitive:()=>Zs,PrintableString:()=>Xl,RawData:()=>pv,RelativeObjectIdentifier:()=>qm,Repeated:()=>nu,Sequence:()=>It,Set:()=>In,TIME:()=>Ym,TeletexString:()=>Yl,TimeOfDay:()=>Wm,UTCTime:()=>sc,UniversalString:()=>Wl,Utf8String:()=>Bi,ValueBlock:()=>jr,VideotexString:()=>Ql,ViewWriter:()=>xd,VisibleString:()=>oc,compareSchema:()=>Ys,fromBER:()=>gi,verifySchema:()=>qX});var Fe=bt(Xs());function zl(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function ic(r,e,t=-1){let n=t,i=r,o=0,s=Math.pow(2,e);for(let a=1;a<8;a++){if(r<s){let c;if(n<0)c=new ArrayBuffer(a),o=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),o=n}let l=new Uint8Array(c);for(let u=a-1;u>=0;u--){let f=Math.pow(2,u*e);l[o-u-1]=Math.floor(i/f),i-=l[o-u-1]*f}return c}s*=Math.pow(2,e)}return new ArrayBuffer(0)}function Y4(...r){let e=0,t=0;for(let o of r)e+=o.length;let n=new ArrayBuffer(e),i=new Uint8Array(n);for(let o of r)i.set(o,t),t+=o.length;return i}function dv(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=zl(t,8),i=new ArrayBuffer(this.valueHex.byteLength),o=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)o[a]=r[a];return o[0]&=127,zl(o,8)-n}function pD(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let s=t-e,a=ic(s,8,n),c=new Uint8Array(a);return c[0]|=128,a}let i=ic(e,8,n),o=new Uint8Array(i);if(o[0]&128){let s=i.slice(0),a=new Uint8Array(s);i=new ArrayBuffer(i.byteLength+1),o=new Uint8Array(i);for(let c=0;c<s.byteLength;c++)o[c+1]=a[c];o[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function mD(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function Fn(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,i=new Array(n);for(let s=0;s<n;s++)i[s]="0";return i.join("").concat(t)}var ESe=Math.log(2);function Q4(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function mv(r){let e=0,t=0;for(let i=0;i<r.length;i++){let o=r[i];e+=o.byteLength}let n=new Uint8Array(e);for(let i=0;i<r.length;i++){let o=r[i];n.set(new Uint8Array(o),t),t+=o.byteLength}return n.buffer}function Js(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var xd=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return mv(this.items)}},Mm=[new Uint8Array([1])],gD="0123456789",hv="name",yD="valueHexView",OX="isHexOnly",NX="idBlock",LX="tagClass",BX="tagNumber",MX="isConstructed",UX="fromBER",FX="toBER",$X="local",$n="",xo=new ArrayBuffer(0),d6=new Uint8Array(0),Fm="EndOfContent",xD="OCTET STRING",bD="BIT STRING";function Qo(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var i;super(...n);let o=n[0]||{};this.isHexOnly=(i=o.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=o.valueHex?Fe.BufferSourceConverter.toUint8Array(o.valueHex):d6}fromBER(n,i,o){let s=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!Js(this,s,i,o))return-1;let a=i+o;return this.valueHexView=s.subarray(i,a),this.valueHexView.length?(this.blockLength=o,a):(this.warnings.push("Zero buffer length"),i)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",xo)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Fe.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var Qs=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=$n,warnings:n=[],valueBeforeDecode:i=d6}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Fe.BufferSourceConverter.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Fe.Convert.ToHex(this.valueBeforeDecodeView)}}};Qs.NAME="baseBlock";var jr=class extends Qs{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};jr.NAME="valueBlock";var Z4=class extends Qo(Qs){constructor({idBlock:e={}}={}){var t,n,i,o;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Fe.BufferSourceConverter.toUint8Array(e.valueHex):d6,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(o=e.isConstructed)!==null&&o!==void 0?o:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",xo}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let i=new Uint8Array(1);if(!e){let o=this.tagNumber;o&=31,t|=o,i[0]=t}return i.buffer}if(!this.isHexOnly){let i=ic(this.tagNumber,7),o=new Uint8Array(i),s=i.byteLength,a=new Uint8Array(s+1);if(a[0]=t|31,!e){for(let c=0;c<s-1;c++)a[c+1]=o[c]|128;a[s]=o[s-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let i=this.valueHexView;for(let o=0;o<i.length-1;o++)n[o+1]=i[o]|128;n[this.valueHexView.byteLength]=i[i.length-1]}return n.buffer}fromBER(e,t,n){let i=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,i,t,n))return-1;let o=i.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;switch(o[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(o[0]&32)===32,this.isHexOnly=!1;let a=o[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;o[c]&128;){if(l[c-1]=o[c]&127,c++,c>=o.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;let h=new Uint8Array(u);for(let d=0;d<l.length;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=o[c]&127;let f=new Uint8Array(c);for(let h=0;h<c;h++)f[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(f),this.blockLength<=9?this.tagNumber=zl(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};Z4.NAME="identificationBlock";var J4=class extends Qs{constructor({lenBlock:e={}}={}){var t,n,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,n){let i=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,i,t,n))return-1;let o=i.subarray(t,t+n);if(o.length===0)return this.error="Zero buffer length",-1;if(o[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=o[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(o[0]&128),this.longFormUsed===!1)return this.length=o[0],this.blockLength=1,t+this.blockLength;let s=o[0]&127;if(s>8)return this.error="Too big integer",-1;if(s+1>o.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=i.subarray(a,a+s);return c[s-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=zl(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let i=ic(this.length,8);if(i.byteLength>127)return this.error="Too big length",xo;if(t=new ArrayBuffer(i.byteLength+1),e)return t;let o=new Uint8Array(i);n=new Uint8Array(t),n[0]=i.byteLength|128;for(let s=0;s<i.byteLength;s++)n[s+1]=o[s];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};J4.NAME="lengthBlock";var ue={},dr=class extends Qs{constructor({name:e=$n,optional:t=!1,primitiveSchema:n,...i}={},o){super(i),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Z4(i),this.lenBlock=new J4(i),this.valueBlock=o?new o(i):new jr(i)}fromBER(e,t,n){let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){let n=t||new xd;t||vD(this);let i=this.idBlock.toBER(e);if(n.write(i),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let o=this.valueBlock.toBER(e);this.lenBlock.length=o.byteLength;let s=this.lenBlock.toBER(e);n.write(s),n.write(o)}return t?xo:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Fe.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=Fe.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return mD(t,n)}};dr.NAME="BaseBlock";function vD(r){var e;if(r instanceof ue.Constructed)for(let t of r.valueBlock.value)vD(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var $m=class extends dr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=$n,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};$m.NAME="BaseStringBlock";var e6=class extends Qo(jr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};e6.NAME="PrimitiveValueBlock";var ED,Zs=class extends dr{constructor(e={}){super(e,e6),this.idBlock.isConstructed=!1}};ED=Zs;ue.Primitive=ED;Zs.NAME="PRIMITIVE";function HX(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function vd(r,e=0,t=r.length){let n=e,i=new dr({},jr),o=new Qs;if(!Js(o,r,e,t))return i.error=o.error,{offset:-1,result:i};if(!r.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(r,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(r,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=dr;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=ue.EndOfContent;break;case 1:c=ue.Boolean;break;case 2:c=ue.Integer;break;case 3:c=ue.BitString;break;case 4:c=ue.OctetString;break;case 5:c=ue.Null;break;case 6:c=ue.ObjectIdentifier;break;case 10:c=ue.Enumerated;break;case 12:c=ue.Utf8String;break;case 13:c=ue.RelativeObjectIdentifier;break;case 14:c=ue.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=ue.Sequence;break;case 17:c=ue.Set;break;case 18:c=ue.NumericString;break;case 19:c=ue.PrintableString;break;case 20:c=ue.TeletexString;break;case 21:c=ue.VideotexString;break;case 22:c=ue.IA5String;break;case 23:c=ue.UTCTime;break;case 24:c=ue.GeneralizedTime;break;case 25:c=ue.GraphicString;break;case 26:c=ue.VisibleString;break;case 27:c=ue.GeneralString;break;case 28:c=ue.UniversalString;break;case 29:c=ue.CharacterString;break;case 30:c=ue.BmpString;break;case 31:c=ue.DATE;break;case 32:c=ue.TimeOfDay;break;case 33:c=ue.DateTime;break;case 34:c=ue.Duration;break;default:{let l=i.idBlock.isConstructed?new ue.Constructed:new ue.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?ue.Constructed:ue.Primitive}return i=HX(i,c),a=i.fromBER(r,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=r.subarray(n,n+i.blockLength),{offset:a,result:i}}function gi(r){if(!r.byteLength){let e=new dr({},jr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return vd(Fe.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function VX(r,e){return r?1:e}var Xo=class extends jr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let i=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,i,t,n))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let o=t;for(;VX(this.isIndefiniteForm,n)>0;){let s=vd(i,o,n);if(s.offset===-1)return this.error=s.result.error,this.warnings.concat(s.result.warnings),-1;if(o=s.offset,this.blockLength+=s.result.blockLength,n-=s.result.blockLength,this.value.push(s.result),this.isIndefiniteForm&&s.result.constructor.NAME===Fm)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Fm?this.value.pop():this.warnings.push("No EndOfContent block encoded")),o}toBER(e,t){let n=t||new xd;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,n);return t?xo:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};Xo.NAME="ConstructedValueBlock";var SD,hr=class extends dr{constructor(e={}){super(e,Xo),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};SD=hr;ue.Constructed=SD;hr.NAME="CONSTRUCTED";var t6=class extends jr{fromBER(e,t,n){return t}toBER(e){return xo}};t6.override="EndOfContentValueBlock";var AD,Hm=class extends dr{constructor(e={}){super(e,t6),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};AD=Hm;ue.EndOfContent=AD;Hm.NAME=Fm;var _D,Hn=class extends dr{constructor(e={}){super(e,jr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let i=new Uint8Array(n);i[0]=5,i[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};_D=Hn;ue.Null=_D;Hn.NAME="NULL";var r6=class extends Qo(jr){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Fe.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let i=Fe.BufferSourceConverter.toUint8Array(e);return Js(this,i,t,n)?(this.valueHexView=i.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,dv.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};r6.NAME="BooleanValueBlock";var CD,Kl=class extends dr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,r6),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};CD=Kl;ue.Boolean=CD;Kl.NAME="BOOLEAN";var n6=class extends Qo(Xo){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=Xo.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let o=0;o<this.value.length;o++){let s=this.value[o].constructor.NAME;if(s===Fm){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(s!==xD)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,n),this.blockLength=n;return i}toBER(e,t){return this.isConstructed?Xo.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};n6.NAME="OctetStringValueBlock";var gv,hn=class extends dr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,o;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},n6),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let o=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(o.byteLength){let s=vd(o,0,o.byteLength);s.offset!==-1&&s.offset===n&&(this.valueBlock.value=[s.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return hr.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=Fe.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof gv&&e.push(t.valueBlock.valueHexView);return Fe.BufferSourceConverter.concat(e)}};gv=hn;ue.OctetString=gv;hn.NAME=xD;var i6=class extends Qo(Xo){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let i=-1;if(this.isConstructed){if(i=Xo.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let a of this.value){let c=a.constructor.NAME;if(c===Fm){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==bD)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}let o=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,o,t,n))return-1;let s=o.subarray(t,t+n);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=s.subarray(1);try{if(a.byteLength){let c=vd(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+n}toBER(e,t){if(this.isConstructed)return Xo.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return xo;let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};i6.NAME="BitStringValueBlock";var TD,wo=class extends dr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,o;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((o=n.value)===null||o===void 0)&&o.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},i6),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return hr.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join(""),i=this.constructor.NAME,o=n.substring(0,n.length-this.valueBlock.unusedBits);return`${i} : ${o}`}}};TD=wo;ue.BitString=TD;wo.NAME=bD;var ID;function zX(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),i=new Uint8Array(e),o=n.slice(0),s=o.length-1,a=i.slice(0),c=a.length-1,l=0,u=c<s?s:c,f=0;for(let h=u;h>=0;h--,f++){switch(!0){case f<a.length:l=o[s-f]+a[c-f]+t[0];break;default:l=o[s-f]+t[0]}switch(t[0]=l/10,!0){case f>=o.length:o=Y4(new Uint8Array([l%10]),o);break;default:o[s-f]=l%10}}return t[0]>0&&(o=Y4(t,o)),o}function wD(r){if(r>=Mm.length)for(let e=Mm.length;e<=r;e++){let t=new Uint8Array([0]),n=Mm[e-1].slice(0);for(let i=n.length-1;i>=0;i--){let o=new Uint8Array([(n[i]<<1)+t[0]]);t[0]=o[0]/10,n[i]=o[0]%10}t[0]>0&&(n=Y4(t,n)),Mm.push(n)}return Mm[r]}function KX(r,e){let t=0,n=new Uint8Array(r),i=new Uint8Array(e),o=n.slice(0),s=o.length-1,a=i.slice(0),c=a.length-1,l,u=0;for(let f=c;f>=0;f--,u++)switch(l=o[s-u]-a[c-u]-t,!0){case l<0:t=1,o[s-u]=l+10;break;default:t=0,o[s-u]=l}if(t>0)for(let f=s-c+1;f>=0;f--,u++)if(l=o[s-u]-t,l<0)t=1,o[s-u]=l+10;else{t=0,o[s-u]=l;break}return o.slice()}var Vm=class extends Qo(jr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=dv.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(pD(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,i=0){let o=this.fromBER(e,t,n);if(o===-1)return o;let s=this.valueHexView;return s[0]===0&&(s[1]&128)!==0?this.valueHexView=s.subarray(1):i!==0&&s.length<i&&(i-s.length>1&&(i=s.length+1),this.valueHexView=s.subarray(i-s.length)),o}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let i=super.fromBER(e,t,n);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,i,o=this.valueHexView,s="",a=!1;for(let c=o.byteLength-1;c>=0;c--){i=o[c];for(let l=0;l<8;l++){if((i&1)===1)switch(n){case e:t=KX(wD(n),t),s="-";break;default:t=zX(t,wD(n))}n++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(s+=gD.charAt(t[c]));return a===!1&&(s+=gD.charAt(0)),s}};ID=Vm;Vm.NAME="IntegerValueBlock";Object.defineProperty(ID.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Um,pi=class extends dr{constructor(e={}){super(e,Vm),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Q4(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Q4();let t=BigInt(e),n=new xd,i=t.toString(16).replace(/^-/,""),o=new Uint8Array(Fe.Convert.FromHex(i));if(t<0){let a=new Uint8Array(o.length+(o[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${Fe.Convert.ToHex(a)}`)+t,u=Fe.BufferSourceConverter.toUint8Array(Fe.Convert.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else o[0]&128&&n.write(new Uint8Array([0])),n.write(o);return new Um({valueHex:n.final()})}convertToDER(){let e=new Um({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Um({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};Um=pi;ue.Integer=Um;pi.NAME="INTEGER";var kD,ql=class extends pi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};kD=ql;ue.Enumerated=kD;ql.NAME="ENUMERATED";var zm=class extends Qo(jr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let i=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,i,t,n))return-1;let o=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Q4();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let i=this.valueHexView,o=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)o[s]=i[s]|128;return o[this.blockLength-1]=i[this.blockLength-1],o.buffer}let t=ic(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",xo;let n=new Uint8Array(t.byteLength);if(!e){let i=new Uint8Array(t),o=t.byteLength-1;for(let s=0;s<o;s++)n[s]=i[s]|128;n[o]=i[o]}return n}toString(){let e="";if(this.isHexOnly)e=Fe.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};zm.NAME="sidBlock";var o6=class extends jr{constructor({value:e=$n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){let o=new zm;if(i=o.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=o.error,i;this.value.length===0&&(o.isFirstSid=!0),this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return i}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let i=this.value[n].toBER(e);if(i.byteLength===0)return this.error=this.value[n].error,xo;t.push(i)}return mv(t)}fromString(e){this.value=[];let t=0,n=0,i="",o=!1;do if(n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1,o){let s=this.value[0],a=0;switch(s.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(i,10);if(isNaN(c))return;s.valueDec=c+a,o=!1}else{let s=new zm;if(i>Number.MAX_SAFE_INTEGER){Q4();let a=BigInt(i);s.valueBigInt=a}else if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return;this.value.length||(s.isFirstSid=!0,o=!0),this.value.push(s)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[n].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};o6.NAME="ObjectIdentifierValueBlock";var PD,mi=class extends dr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,o6),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};PD=mi;ue.ObjectIdentifier=PD;mi.NAME="OBJECT IDENTIFIER";var Km=class extends Qo(Qs){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let i=Fe.BufferSourceConverter.toUint8Array(e);if(!Js(this,i,t,n))return-1;let o=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=o[a]&127,this.blockLength++,(o[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(o[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zl(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let i=this.valueHexView,o=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)o[s]=i[s]|128;return o[this.blockLength-1]=i[this.blockLength-1],o.buffer}let t=ic(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",xo;let n=new Uint8Array(t.byteLength);if(!e){let i=new Uint8Array(t),o=t.byteLength-1;for(let s=0;s<o;s++)n[s]=i[s]|128;n[o]=i[o]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Fe.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};Km.NAME="relativeSidBlock";var s6=class extends jr{constructor({value:e=$n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){let o=new Km;if(i=o.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=o.error,i;this.blockLength+=o.blockLength,n-=o.blockLength,this.value.push(o)}return i}toBER(e,t){let n=[];for(let i=0;i<this.value.length;i++){let o=this.value[i].toBER(e);if(o.byteLength===0)return this.error=this.value[i].error,xo;n.push(o)}return mv(n)}fromString(e){this.value=[];let t=0,n=0,i="";do{n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1;let o=new Km;if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return!0;this.value.push(o)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};s6.NAME="RelativeObjectIdentifierValueBlock";var RD,qm=class extends dr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,s6),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};RD=qm;ue.RelativeObjectIdentifier=RD;qm.NAME="RelativeObjectIdentifier";var DD,It=class extends hr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};DD=It;ue.Sequence=DD;It.NAME="SEQUENCE";var OD,In=class extends hr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};OD=In;ue.Set=OD;In.NAME="SET";var a6=class extends Qo(jr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=$n}toJSON(){return{...super.toJSON(),value:this.value}}};a6.NAME="StringValueBlock";var c6=class extends a6{};c6.NAME="SimpleStringValueBlock";var kn=class extends $m{constructor({...e}={}){super(e,c6)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Fe.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);this.valueBlock.value=e}};kn.NAME="SIMPLE STRING";var l6=class extends kn{fromBuffer(e){this.valueBlock.valueHexView=Fe.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=Fe.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Fe.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Fe.Convert.FromUtf8String(e)),this.valueBlock.value=e}};l6.NAME="Utf8StringValueBlock";var ND,Bi=class extends l6{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};ND=Bi;ue.Utf8String=ND;Bi.NAME="UTF8String";var u6=class extends kn{fromBuffer(e){this.valueBlock.value=Fe.Convert.ToUtf16String(e),this.valueBlock.valueHexView=Fe.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Fe.Convert.FromUtf16String(e))}};u6.NAME="BmpStringValueBlock";var LD,jl=class extends u6{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};LD=jl;ue.BmpString=LD;jl.NAME="BMPString";var f6=class extends kn{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let i=0;i<n.length;i+=4)n[i]=n[i+3],n[i+1]=n[i+2],n[i+2]=0,n[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){let o=ic(e.charCodeAt(i),8),s=new Uint8Array(o);if(s.length>4)continue;let a=4-s.length;for(let c=s.length-1;c>=0;c--)n[i*4+c+a]=s[c]}this.valueBlock.value=e}};f6.NAME="UniversalStringValueBlock";var BD,Wl=class extends f6{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};BD=Wl;ue.UniversalString=BD;Wl.NAME="UniversalString";var MD,Gl=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};MD=Gl;ue.NumericString=MD;Gl.NAME="NumericString";var UD,Xl=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};UD=Xl;ue.PrintableString=UD;Xl.NAME="PrintableString";var FD,Yl=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};FD=Yl;ue.TeletexString=FD;Yl.NAME="TeletexString";var $D,Ql=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};$D=Ql;ue.VideotexString=$D;Ql.NAME="VideotexString";var HD,Zl=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};HD=Zl;ue.IA5String=HD;Zl.NAME="IA5String";var VD,Jl=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};VD=Jl;ue.GraphicString=VD;Jl.NAME="GraphicString";var zD,oc=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};zD=oc;ue.VisibleString=zD;oc.NAME="VisibleString";var KD,eu=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};KD=eu;ue.GeneralString=KD;eu.NAME="GeneralString";var qD,tu=class extends kn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};qD=tu;ue.CharacterString=qD;tu.NAME="CharacterString";var jD,sc=class extends oc{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Fe.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let i=parseInt(n[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=Fn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=Fn(this.month,2),t[2]=Fn(this.day,2),t[3]=Fn(this.hour,2),t[4]=Fn(this.minute,2),t[5]=Fn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};jD=sc;ue.UTCTime=jD;sc.NAME="UTCTime";var WD,ru=class extends sc{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",i="",o=0,s,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let f=new Number(e[e.length-1]);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let f=1,h=n.indexOf("+"),d="";if(h===-1&&(h=n.indexOf("-"),f=-1),h!==-1){if(d=n.substring(h+1),n=n.substring(0,h),d.length!==2&&d.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(d.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=f*m,d.length===4){if(m=parseInt(d.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=f*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let f=new Number(`0${n.substring(l)}`);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");o=f.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case i.length===8:if(s=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.minute=Math.floor(f),f=60*(f-this.minute),this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case i.length===12:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*o;this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case i.length===14:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=1e3*o;this.millisecond=Math.floor(f)}break;default:throw new Error("Wrong input string for conversion")}let u=s.exec(i);if(u===null)throw new Error("Wrong input string for conversion");for(let f=1;f<u.length;f++)switch(f){case 1:this.year=parseInt(u[f],10);break;case 2:this.month=parseInt(u[f],10);break;case 3:this.day=parseInt(u[f],10);break;case 4:this.hour=parseInt(u[f],10)+a;break;case 5:this.minute=parseInt(u[f],10)+c;break;case 6:this.second=parseInt(u[f],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let f=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=f.getUTCFullYear(),this.month=f.getUTCMonth(),this.day=f.getUTCDay(),this.hour=f.getUTCHours(),this.minute=f.getUTCMinutes(),this.second=f.getUTCSeconds(),this.millisecond=f.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(Fn(this.year,4)),t.push(Fn(this.month,2)),t.push(Fn(this.day,2)),t.push(Fn(this.hour,2)),t.push(Fn(this.minute,2)),t.push(Fn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(Fn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};WD=ru;ue.GeneralizedTime=WD;ru.NAME="GeneralizedTime";var GD,jm=class extends Bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};GD=jm;ue.DATE=GD;jm.NAME="DATE";var XD,Wm=class extends Bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};XD=Wm;ue.TimeOfDay=XD;Wm.NAME="TimeOfDay";var YD,Gm=class extends Bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};YD=Gm;ue.DateTime=YD;Gm.NAME="DateTime";var QD,Xm=class extends Bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};QD=Xm;ue.Duration=QD;Xm.NAME="Duration";var ZD,Ym=class extends Bi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};ZD=Ym;ue.TIME=ZD;Ym.NAME="TIME";var Yo=class{constructor({name:e=$n,optional:t=!1}={}){this.name=e,this.optional=t}},bd=class extends Yo{constructor({value:e=[],...t}={}){super(t),this.value=e}},nu=class extends Yo{constructor({value:e=new Yo,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}},pv=class{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=Fe.BufferSourceConverter.toUint8Array(e)}constructor({data:e=d6}={}){this.dataView=Fe.BufferSourceConverter.toUint8Array(e)}fromBER(e,t,n){let i=t+n;return this.dataView=Fe.BufferSourceConverter.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}};function Ys(r,e,t){if(t instanceof bd){for(let o of t.value)if(Ys(r,e,o).verified)return{verified:!0,result:r};{let o={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(hv)&&(o.name=t.name),o}}if(t instanceof Yo)return t.hasOwnProperty(hv)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(NX in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(UX in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(FX in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(LX)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(BX)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(MX)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(OX in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(yD in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let o=t.idBlock.valueHexView,s=e.idBlock.valueHexView;if(o.length!==s.length)return{verified:!1,result:r};for(let a=0;a<o.length;a++)if(o[a]!==s[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&(r[t.name]=e)),t instanceof ue.Constructed){let o=0,s={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof nu&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-o>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){let l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof nu){if(s=Ys(r,e.valueBlock.value[c],t.valueBlock.value[0].value),s.verified===!1)if(t.valueBlock.value[0].optional)o++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&delete r[t.name]),s;if(hv in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};$X in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(s=Ys(r,e.valueBlock.value[c-o],t.valueBlock.value[c]),s.verified===!1)if(t.valueBlock.value[c].optional)o++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&delete r[t.name]),s;if(s.verified===!1){let c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&yD in e.valueBlock){let o=vd(e.valueBlock.valueHexView);if(o.offset===-1){let s={verified:!1,result:o.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,$n),t.name&&(delete r[t.name],s.name=t.name)),s}return Ys(r,o.result,t.primitiveSchema)}return{verified:!0,result:r}}function qX(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};let t=vd(Fe.BufferSourceConverter.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:Ys(t.result,t.result,e)}async function h6(r,e){let n=await yd.create().encrypt(r,e);return sr.encode(n)}async function yv(r,e,t){if(r.type==="RSA")return XX(r,e,t);if(r.type==="Ed25519")return jX(r,e,t);if(r.type==="secp256k1")return WX(r,e,t);if(r.type==="ECDSA")return GX(r,e,t);throw new Yi}async function jX(r,e,t="libp2p-key"){if(t==="libp2p-key")return h6(dl(r),e);throw new O(`export format '${t}' is not supported`)}async function WX(r,e,t="libp2p-key"){if(t==="libp2p-key")return h6(dl(r),e);throw new O("Export format is not supported")}async function GX(r,e,t="libp2p-key"){if(t==="libp2p-key")return h6(dl(r),e);throw new O(`export format '${t}' is not supported`)}async function XX(r,e,t="pkcs-8"){if(t==="pkcs-8")return YX(r,e);if(t==="libp2p-key")return h6(dl(r),e);throw new O("Export format is not supported")}async function YX(r,e){let t=cr.get(),i=new It({value:[new pi({value:0}),new It({value:[new mi({value:"1.2.840.113549.1.1.1"}),new Hn]}),new hn({valueHex:r.raw})]}).toBER(),o=new Uint8Array(i,0,i.byteLength),s=wn(16),a=await _2(Ta,e,s,{c:1e4,dkLen:32}),c=wn(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,o),f=new It({value:[new hn({valueHex:s}),new pi({value:1e4}),new pi({value:32}),new It({value:[new mi({value:"1.2.840.113549.2.11"}),new Hn]})]}),h=new It({value:[new mi({value:"1.2.840.113549.1.5.13"}),new It({value:[new It({value:[new mi({value:"1.2.840.113549.1.5.12"}),f]}),new It({value:[new mi({value:"2.16.840.1.101.3.4.1.42"}),new hn({valueHex:c})]})]})]}),m=new It({value:[h,new hn({valueHex:u})]}).toBER(),y=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...K(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function wv(r,e){try{let t=await QX(r,e);return uT(t)}catch{}if(!r.includes("BEGIN"))throw new O("Encrypted key was not a libp2p-key or a PEM file");return ZX(r,e)}async function QX(r,e){let t=sr.decode(r);return yd.create().decrypt(t,e)}async function ZX(r,e){let t=cr.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let o=R(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=gi(o),{iv:a,salt:c,iterations:l,keySize:u,cipherText:f}=JX(s),h=await _2(Ta,e,c,{c:l,dkLen:u}),d=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),m=Qm(await t.subtle.decrypt({name:"AES-CBC",iv:a},d,f)),{result:y}=gi(m);n=tO(y)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let o=R(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=gi(o);n=tO(s)}else throw new O("Could not parse private key from PEM data");let i=fT(n);if(i.type!=="RSA")throw new O("Could not parse RSA private key from PEM data");return i}function JX(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new O("Only pkcs5PBES2 encrypted private keys are supported");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new O("Only pkcs5PBKDF2 key derivation functions are supported");let o=n.valueBlock.value[1],s=Qm(o.valueBlock.value[0].getValue()),a=1e4,c=32;if(o.valueBlock.value.length===3)a=Number(o.valueBlock.value[1].toBigInt()),c=Number(o.valueBlock.value[2].toBigInt());else if(o.valueBlock.value.length===2)throw new O("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new O("Only AES-CBC encryption schemes are supported")}}}}let f=Qm(l.valueBlock.value[1].getValue());return{cipherText:Qm(r.valueBlock.value[1].getValue()),salt:s,iterations:a,keySize:c,iv:f}}function tO(r){return Qm(r.valueBlock.value[2].getValue())}function Qm(r){return new Uint8Array(r,0,r.byteLength)}var eY="/pkcs8/",xv="/info/",Zm=new WeakMap,iu={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function Ed(r){return r==null||typeof r!="string"?!1:r===(0,rO.default)(r.trim())&&r.length>0}async function Wr(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function ou(r){return new lt(eY+r)}function Sd(r){return new lt(xv+r)}async function tY(r){let e=dl(r),t=await ze.digest(e);return nt.encode(t.bytes).substring(1)}var p6=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...uv,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<iu.minKeyLength)throw new Error(`dek.keyLength must be least ${iu.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<iu.minSaltLength)throw new Error(`dek.saltLength must be least ${iu.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<iu.minIterationCount)throw new Error(`dek.iterationCount must be least ${iu.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Bp(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Zm.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[Ge]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},this.options),t=Math.ceil(iu.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=K(wn(t),"base64")),e}static get options(){return{dek:{...uv}}}async findKeyByName(e){if(!Ed(e))throw await Wr(),new O(`Invalid key name '${e}'`);let t=Sd(e);try{let n=await this.components.datastore.get(t);return JSON.parse(K(n))}catch(n){throw await Wr(),this.log.error("could not read key from datastore - %e",n),new je(`Key '${e}' does not exist.`)}}async findKeyById(e){try{let t={prefix:xv};for await(let n of this.components.datastore.query(t)){let i=JSON.parse(K(n.value));if(i.id===e)return i}throw new O(`Key with id '${e}' does not exist.`)}catch(t){throw await Wr(),t}}async importKey(e,t){if(!Ed(e))throw await Wr(),new O(`Invalid key name '${e}'`);if(t==null)throw await Wr(),new O("Key is required");let n=ou(e);if(await this.components.datastore.has(n))throw await Wr(),new O(`Key '${e}' already exists`);let o,s;try{o=await tY(t);let l=Zm.get(this);if(l==null)throw new O("dek missing");let u=l.dek;s=await yv(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Wr(),l}let a={name:e,id:o},c=this.components.datastore.batch();return c.put(n,R(s)),c.put(Sd(e),R(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!Ed(e))throw await Wr(),new O(`Invalid key name '${e}'`);let t=ou(e);try{let n=await this.components.datastore.get(t),i=K(n),o=Zm.get(this);if(o==null)throw new O("dek missing");let s=o.dek;return await wv(i,s)}catch(n){throw await Wr(),n}}async removeKey(e){if(!Ed(e)||e===this.self)throw await Wr(),new O(`Invalid key name '${e}'`);let t=ou(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(Sd(e)),await i.commit(),n}async listKeys(){let e={prefix:xv},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(K(n.value)));return t}async renameKey(e,t){if(!Ed(e)||e===this.self)throw await Wr(),new O(`Invalid old key name '${e}'`);if(!Ed(t)||t===this.self)throw await Wr(),new O(`Invalid new key name '${t}'`);let n=ou(e),i=ou(t),o=Sd(e),s=Sd(t);if(await this.components.datastore.has(i))throw await Wr(),new O(`Key '${t}' already exists`);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(o),u=JSON.parse(K(l));u.name=t;let f=this.components.datastore.batch();return f.put(i,c),f.put(s,R(JSON.stringify(u))),f.delete(n),f.delete(o),await f.commit(),u}catch(c){throw await Wr(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Wr(),new O(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Wr(),new O(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Wr(),new O(`Invalid pass length ${t.length}`);this.log("recreating keychain");let n=Zm.get(this);if(n==null)throw new O("dek missing");let i=n.dek;this.init.pass=t;let o=t!=null&&this.init.dek?.salt!=null?Bp(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Zm.set(this,{dek:o});let s=await this.listKeys();for(let a of s){let c=await this.components.datastore.get(ou(a.name)),l=K(c),u=await wv(l,i),f=o.toString(),h=await yv(u,f,u.type==="RSA"?"pkcs-8":"libp2p-key"),d=this.components.datastore.batch(),m={name:a.name,id:a.id};d.put(ou(a.name),R(h)),d.put(Sd(a.name),R(JSON.stringify(m))),await d.commit()}this.log("keychain reconstructed")}};function m6(r={}){return e=>new p6(e,r)}async function bv(r,e={}){let t=e.selfKey??"self",n=m6(e)({datastore:r,logger:Na()}),i;return await r.has(new lt(`/pkcs8/${t}`))?i=await n.exportKey(t):(i=await Oa(e.keyType??"Ed25519"),await n.importKey(t,i)),i}var Ad=!!globalThis.process?.env?.DUMP_SESSION_KEYS,vv=16;function rY(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function g6(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function y6(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Nr(r,e,t=""){let n=rY(r),i=r?.length,o=e!==void 0;if(!n||o&&i!==e){let s=t&&`"${t}" `,a=o?` of length ${e}`:"",c=n?`length=${i}`:`type=${typeof r}`;throw new Error(s+"expected Uint8Array"+a+", got "+c)}return r}function Ev(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function nO(r,e){Nr(r,void 0,"output");let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ea(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function ta(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function nY(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}var iY=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function iO(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function oO(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var Sv=(r,e)=>{function t(n,...i){if(Nr(n,void 0,"key"),!iY)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){let u=i[0];Nr(u,r.varSizeNonce?void 0:r.nonceLength,"nonce")}let o=r.tagLength;o&&i[1]!==void 0&&Nr(i[1],void 0,"AAD");let s=e(n,...i),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");Nr(f,void 0,"output")}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Nr(u),a(s.encrypt.length,f),s.encrypt(u,f)},decrypt(u,f){if(Nr(u),o&&u.length<o)throw new Error('"ciphertext" expected length bigger than tagLength='+o);return a(s.decrypt.length,f),s.decrypt(u,f)}}}return Object.assign(t,r),t};function Av(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error('"output" expected Uint8Array of length '+r+", got: "+e.length);if(t&&!oY(e))throw new Error("invalid output, must be aligned");return e}function sO(r,e,t){g6(t);let n=new Uint8Array(16),i=nY(n);return i.setBigUint64(0,BigInt(e),t),i.setBigUint64(8,BigInt(r),t),n}function oY(r){return r.byteOffset%4===0}function _d(r){return Uint8Array.from(r)}var cO=r=>Uint8Array.from(r.split(""),e=>e.charCodeAt(0)),sY=cO("expand 16-byte k"),aY=cO("expand 32-byte k"),cY=ea(sY),lY=ea(aY);function he(r,e){return r<<e|r>>>32-e}function _v(r){return r.byteOffset%4===0}var w6=64,uY=16,lO=2**32-1,aO=Uint32Array.of();function fY(r,e,t,n,i,o,s,a){let c=i.length,l=new Uint8Array(w6),u=ea(l),f=_v(i)&&_v(o),h=f?ea(i):aO,d=f?ea(o):aO;for(let m=0;m<c;s++){if(r(e,t,n,u,s,a),s>=lO)throw new Error("arx: counter overflow");let y=Math.min(w6,c-m);if(f&&y===w6){let w=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let x=0,v;x<uY;x++)v=w+x,d[v]=h[v]^u[x];m+=w6;continue}for(let w=0,x;w<y;w++)x=m+w,o[x]=i[x]^l[w];m+=y}}function Cv(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:o,rounds:s}=iO({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return y6(i),y6(s),g6(o),g6(t),(a,c,l,u,f=0)=>{Nr(a,void 0,"key"),Nr(c,void 0,"nonce"),Nr(l,void 0,"data");let h=l.length;if(u===void 0&&(u=new Uint8Array(h)),Nr(u,void 0,"output"),y6(f),f<0||f>=lO)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],m=a.length,y,w;if(m===32)d.push(y=_d(a)),w=lY;else if(m===16&&t)y=new Uint8Array(32),y.set(a),y.set(a,16),w=cY,d.push(y);else throw Nr(a,32,"arx key"),new Error("invalid key size");_v(c)||d.push(c=_d(c));let x=ea(y);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(w,x,ea(c.subarray(0,16)),x),c=c.subarray(16)}let v=16-i;if(v!==c.length)throw new Error(`arx: nonce must be ${v} or 16 bytes`);if(v!==12){let _=new Uint8Array(12);_.set(c,o?0:12-c.length),c=_,d.push(c)}let E=ea(c);return fY(r,w,x,E,l,u,f,s),ta(...d),u}}function Gr(r,e){return r[e++]&255|(r[e++]&255)<<8}var Tv=class{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(e){e=_d(Nr(e,32,"key"));let t=Gr(e,0),n=Gr(e,2),i=Gr(e,4),o=Gr(e,6),s=Gr(e,8),a=Gr(e,10),c=Gr(e,12),l=Gr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|o<<9)&8191,this.r[4]=(o>>>4|s<<12)&255,this.r[5]=s>>>1&8190,this.r[6]=(s>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Gr(e,16+2*u)}process(e,t,n=!1){let i=n?0:2048,{h:o,r:s}=this,a=s[0],c=s[1],l=s[2],u=s[3],f=s[4],h=s[5],d=s[6],m=s[7],y=s[8],w=s[9],x=Gr(e,t+0),v=Gr(e,t+2),E=Gr(e,t+4),_=Gr(e,t+6),B=Gr(e,t+8),H=Gr(e,t+10),U=Gr(e,t+12),C=Gr(e,t+14),I=o[0]+(x&8191),W=o[1]+((x>>>13|v<<3)&8191),z=o[2]+((v>>>10|E<<6)&8191),$=o[3]+((E>>>7|_<<9)&8191),S=o[4]+((_>>>4|B<<12)&8191),k=o[5]+(B>>>1&8191),T=o[6]+((B>>>14|H<<2)&8191),M=o[7]+((H>>>11|U<<5)&8191),X=o[8]+((U>>>8|C<<8)&8191),Y=o[9]+(C>>>5|i),F=0,Z=F+I*a+W*(5*w)+z*(5*y)+$*(5*m)+S*(5*d);F=Z>>>13,Z&=8191,Z+=k*(5*h)+T*(5*f)+M*(5*u)+X*(5*l)+Y*(5*c),F+=Z>>>13,Z&=8191;let te=F+I*c+W*a+z*(5*w)+$*(5*y)+S*(5*m);F=te>>>13,te&=8191,te+=k*(5*d)+T*(5*h)+M*(5*f)+X*(5*u)+Y*(5*l),F+=te>>>13,te&=8191;let V=F+I*l+W*c+z*a+$*(5*w)+S*(5*y);F=V>>>13,V&=8191,V+=k*(5*m)+T*(5*d)+M*(5*h)+X*(5*f)+Y*(5*u),F+=V>>>13,V&=8191;let Pe=F+I*u+W*l+z*c+$*a+S*(5*w);F=Pe>>>13,Pe&=8191,Pe+=k*(5*y)+T*(5*m)+M*(5*d)+X*(5*h)+Y*(5*f),F+=Pe>>>13,Pe&=8191;let Be=F+I*f+W*u+z*l+$*c+S*a;F=Be>>>13,Be&=8191,Be+=k*(5*w)+T*(5*y)+M*(5*m)+X*(5*d)+Y*(5*h),F+=Be>>>13,Be&=8191;let ce=F+I*h+W*f+z*u+$*l+S*c;F=ce>>>13,ce&=8191,ce+=k*a+T*(5*w)+M*(5*y)+X*(5*m)+Y*(5*d),F+=ce>>>13,ce&=8191;let Me=F+I*d+W*h+z*f+$*u+S*l;F=Me>>>13,Me&=8191,Me+=k*c+T*a+M*(5*w)+X*(5*y)+Y*(5*m),F+=Me>>>13,Me&=8191;let Qe=F+I*m+W*d+z*h+$*f+S*u;F=Qe>>>13,Qe&=8191,Qe+=k*l+T*c+M*a+X*(5*w)+Y*(5*y),F+=Qe>>>13,Qe&=8191;let xt=F+I*y+W*m+z*d+$*h+S*f;F=xt>>>13,xt&=8191,xt+=k*u+T*l+M*c+X*a+Y*(5*w),F+=xt>>>13,xt&=8191;let He=F+I*w+W*y+z*m+$*d+S*h;F=He>>>13,He&=8191,He+=k*f+T*u+M*l+X*c+Y*a,F+=He>>>13,He&=8191,F=(F<<2)+F|0,F=F+Z|0,Z=F&8191,F=F>>>13,te+=F,o[0]=Z,o[1]=te,o[2]=V,o[3]=Pe,o[4]=Be,o[5]=ce,o[6]=Me,o[7]=Qe,o[8]=xt,o[9]=He}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(i^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)e[a]=e[a]&o|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let s=e[0]+t[0];e[0]=s&65535;for(let a=1;a<8;a++)s=(e[a]+t[a]|0)+(s>>>16)|0,e[a]=s&65535;ta(n)}update(e){Ev(this),Nr(e),e=_d(e);let{buffer:t,blockLen:n}=this,i=e.length;for(let o=0;o<i;){let s=Math.min(n-this.pos,i-o);if(s===n){for(;n<=i-o;o+=n)this.process(e,o);continue}t.set(e.subarray(o,o+s),this.pos),this.pos+=s,o+=s,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){ta(this.h,this.r,this.buffer,this.pad)}digestInto(e){Ev(this),nO(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let o=0;for(let s=0;s<8;s++)e[o++]=n[s]>>>0,e[o++]=n[s]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function dY(r){let e=(n,i)=>r(i).update(n).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var uO=dY(r=>new Tv(r));function hO(r,e,t,n,i,o=20){let s=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],m=e[4],y=e[5],w=e[6],x=e[7],v=i,E=t[0],_=t[1],B=t[2],H=s,U=a,C=c,I=l,W=u,z=f,$=h,S=d,k=m,T=y,M=w,X=x,Y=v,F=E,Z=_,te=B;for(let Pe=0;Pe<o;Pe+=2)H=H+W|0,Y=he(Y^H,16),k=k+Y|0,W=he(W^k,12),H=H+W|0,Y=he(Y^H,8),k=k+Y|0,W=he(W^k,7),U=U+z|0,F=he(F^U,16),T=T+F|0,z=he(z^T,12),U=U+z|0,F=he(F^U,8),T=T+F|0,z=he(z^T,7),C=C+$|0,Z=he(Z^C,16),M=M+Z|0,$=he($^M,12),C=C+$|0,Z=he(Z^C,8),M=M+Z|0,$=he($^M,7),I=I+S|0,te=he(te^I,16),X=X+te|0,S=he(S^X,12),I=I+S|0,te=he(te^I,8),X=X+te|0,S=he(S^X,7),H=H+z|0,te=he(te^H,16),M=M+te|0,z=he(z^M,12),H=H+z|0,te=he(te^H,8),M=M+te|0,z=he(z^M,7),U=U+$|0,Y=he(Y^U,16),X=X+Y|0,$=he($^X,12),U=U+$|0,Y=he(Y^U,8),X=X+Y|0,$=he($^X,7),C=C+S|0,F=he(F^C,16),k=k+F|0,S=he(S^k,12),C=C+S|0,F=he(F^C,8),k=k+F|0,S=he(S^k,7),I=I+W|0,Z=he(Z^I,16),T=T+Z|0,W=he(W^T,12),I=I+W|0,Z=he(Z^I,8),T=T+Z|0,W=he(W^T,7);let V=0;n[V++]=s+H|0,n[V++]=a+U|0,n[V++]=c+C|0,n[V++]=l+I|0,n[V++]=u+W|0,n[V++]=f+z|0,n[V++]=h+$|0,n[V++]=d+S|0,n[V++]=m+k|0,n[V++]=y+T|0,n[V++]=w+M|0,n[V++]=x+X|0,n[V++]=v+Y|0,n[V++]=E+F|0,n[V++]=_+Z|0,n[V++]=B+te|0}function hY(r,e,t,n){let i=r[0],o=r[1],s=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],h=e[4],d=e[5],m=e[6],y=e[7],w=t[0],x=t[1],v=t[2],E=t[3];for(let B=0;B<20;B+=2)i=i+c|0,w=he(w^i,16),h=h+w|0,c=he(c^h,12),i=i+c|0,w=he(w^i,8),h=h+w|0,c=he(c^h,7),o=o+l|0,x=he(x^o,16),d=d+x|0,l=he(l^d,12),o=o+l|0,x=he(x^o,8),d=d+x|0,l=he(l^d,7),s=s+u|0,v=he(v^s,16),m=m+v|0,u=he(u^m,12),s=s+u|0,v=he(v^s,8),m=m+v|0,u=he(u^m,7),a=a+f|0,E=he(E^a,16),y=y+E|0,f=he(f^y,12),a=a+f|0,E=he(E^a,8),y=y+E|0,f=he(f^y,7),i=i+l|0,E=he(E^i,16),m=m+E|0,l=he(l^m,12),i=i+l|0,E=he(E^i,8),m=m+E|0,l=he(l^m,7),o=o+u|0,w=he(w^o,16),y=y+w|0,u=he(u^y,12),o=o+u|0,w=he(w^o,8),y=y+w|0,u=he(u^y,7),s=s+f|0,x=he(x^s,16),h=h+x|0,f=he(f^h,12),s=s+f|0,x=he(x^s,8),h=h+x|0,f=he(f^h,7),a=a+c|0,v=he(v^a,16),d=d+v|0,c=he(c^d,12),a=a+c|0,v=he(v^a,8),d=d+v|0,c=he(c^d,7);let _=0;n[_++]=i,n[_++]=o,n[_++]=s,n[_++]=a,n[_++]=w,n[_++]=x,n[_++]=v,n[_++]=E}var pY=Cv(hO,{counterRight:!1,counterLength:4,allowShortKeys:!1}),mY=Cv(hO,{counterRight:!1,counterLength:8,extendNonceFn:hY,allowShortKeys:!1});var gY=new Uint8Array(16),fO=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(gY.subarray(t))},yY=new Uint8Array(32);function dO(r,e,t,n,i){i!==void 0&&Nr(i,void 0,"AAD");let o=r(e,t,yY),s=sO(n.length,i?i.length:0,!0),a=uO.create(o);i&&fO(a,i),fO(a,n),a.update(s);let c=a.digest();return ta(o,s),c}var pO=r=>(e,t,n)=>({encrypt(o,s){let a=o.length;s=Av(a+16,s,!1),s.set(o);let c=s.subarray(0,-16);r(e,t,c,c,1);let l=dO(r,e,t,c,n);return s.set(l,a),ta(l),s},decrypt(o,s){s=Av(o.length-16,s,!1);let a=o.subarray(0,-16),c=o.subarray(-16),l=dO(r,e,t,a,n);if(!oO(c,l))throw new Error("invalid tag");return s.set(o.subarray(0,-16)),r(e,t,s,s,1),ta(l),s}}),Iv=Sv({blockSize:64,nonceLength:12,tagLength:16},pO(pY)),CAe=Sv({blockSize:64,nonceLength:24,tagLength:16},pO(mY));function gO(r,e,t){return As(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Ra(r,t,e)}var kv=Uint8Array.of(0),mO=Uint8Array.of();function yO(r,e,t,n=32){As(r),rn(n,"length");let i=r.outputLen;if(n>255*i)throw new Error("Length must be <= 255*HashLen");let o=Math.ceil(n/i);t===void 0?t=mO:Re(t,void 0,"info");let s=new Uint8Array(o*i),a=Ra.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<o;u++)kv[0]=u+1,c.update(u===0?mO:l).update(t).update(kv).digestInto(l),s.set(l,i*u),a._cloneInto(c);return a.destroy(),c.destroy(),nn(l,kv),s.slice(0,n)}var Pv={hashSHA256(r){return Pi(r.subarray())},getHKDF(r,e){let t=gO(Pi,e,r),i=yO(Pi,t,void 0,96),o=i.subarray(0,32),s=i.subarray(32,64),a=i.subarray(64,96);return[o,s,a]},generateX25519KeyPair(){let r=hp.utils.randomSecretKey();return{publicKey:hp.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:hp.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return hp.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return Iv(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,i){return Iv(n,e,t).decrypt(r.subarray(),i)}};var wO=Pv;function xO(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var Cd=r=>{let e=Ft(2);return e[0]=r>>8,e[1]=r,e};Cd.bytes=2;var Td=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Td.bytes=2;function bO(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function Rv(r,e){!e.enabled||!Ad||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${K(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${K(r.privateKey,"hex")}`)):e("Missing local static keys."))}function Dv(r,e){!e.enabled||!Ad||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${K(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${K(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function vO(r,e){!e.enabled||!Ad||e(r?`REMOTE_STATIC_PUBLIC_KEY ${K(r.subarray(),"hex")}`:"Missing remote static public key.")}function Ov(r,e){!e.enabled||!Ad||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${K(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Nv(r,e,t){!t.enabled||!Ad||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&K(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&K(e.k,"hex")}`))}var Id=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var wY=0,xY=4294967295,bY="Cipherstate has reached maximum n, a new handshake must be performed",x6=class{n;bytes;view;constructor(e=wY){this.n=e,this.bytes=ke(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>xY)throw new Error(bY)}};var su=ke(0),kd=class{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new x6(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),i}},Lv=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let n=R(t,"utf-8");this.h=vY(e,n),this.ck=this.h,this.cs=new kd(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new kd(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new oe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,su);return[new kd(this.crypto,e),new kd(this.crypto,t)]}},Bv=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:n,prologue:i,initiator:o,s,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new Lv(t,n),this.ss.mixHash(i),this.initiator=o,this.s=s,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let i=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(i),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},Jm=class extends Bv{writeMessageA(e){return new oe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new oe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new oe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new Id(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new Id(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new Id(`handshake stage 2 validation fail: ${t.message}`)}}};function vY(r,e){if(e.length<=32){let t=ke(32);return t.set(e),t}else return r.hash(e)}var b6;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let o of t.webtransportCerthashes)n.uint32(10),n.bytes(o);if(t.streamMuxers!=null)for(let o of t.streamMuxers)n.uint32(18),n.string(o);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={webtransportCerthashes:[],streamMuxers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.webtransportCerthashes!=null&&o.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new yt('Decode error - map field "webtransportCerthashes" had too many elements');o.webtransportCerthashes.push(t.bytes());break}case 2:{if(i.limits?.streamMuxers!=null&&o.streamMuxers.length===i.limits.streamMuxers)throw new yt('Decode error - map field "streamMuxers" had too many elements');o.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(b6||(b6={}));var e1;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),b6.codec().encode(t.extensions,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={identityKey:ke(0),identitySig:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.identityKey=t.bytes();break}case 2:{o.identitySig=t.bytes();break}case 4:{o.extensions=b6.codec().decode(t,t.uint32(),{limits:i.limits?.extensions});break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(e1||(e1={}));async function Uv(r,e,t){let n=await r.sign(SO(e));return e1.encode({identityKey:ar(r.publicKey),identitySig:n,extensions:t})}async function Fv(r,e,t){try{let n=e1.decode(r),i=er(n.identityKey);if(t?.equals(i)===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");let o=SO(e);if(!await i.verify(o,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new gg(n.message)}}function SO(r){let e=R("noise-libp2p-static-key:");return r instanceof Uint8Array?it([e,r],e.length+r.length):(r.prepend(e),r)}var Mv=class extends Ua{stream;handshake;metrics;decoder;constructor(e,t,n){super({log:e.log,inactivityTimeout:e.inactivityTimeout,maxReadBufferLength:e.maxReadBufferLength,direction:e.direction}),this.stream=e,this.handshake=t,this.metrics=n,this.decoder=new G2({lengthDecoder:Td,maxBufferSize:16*1024*1024,encodingLength:()=>2});let i=c=>{try{for(let l of this.decoder.decode(c.data))this.onData(this.decrypt(l))}catch(l){this.abort(l)}};this.stream.addEventListener("message",i);let o=c=>{c.error!=null?c.local===!0?this.abort(c.error):this.onRemoteReset():this.onTransportClosed()};this.stream.addEventListener("close",o);let s=()=>{this.safeDispatchEvent("drain")};this.stream.addEventListener("drain",s);let a=()=>{this.onRemoteCloseWrite()};this.stream.addEventListener("remoteCloseWrite",a)}encrypt(e){let t=new oe;for(let n=0;n<e.byteLength;n+=65519){let i=n+65519;i>e.byteLength&&(i=e.byteLength);let o;e instanceof Uint8Array?o=this.handshake.encrypt(e.subarray(n,i)):o=this.handshake.encrypt(e.sublist(n,i)),this.metrics?.encryptedPackets.increment(),t.append(Cd(o.byteLength)),t.append(o)}return t}decrypt(e){let t=new oe;for(let n=0;n<e.byteLength;n+=65535){let i=n+65535;if(i>e.byteLength&&(i=e.byteLength),i-vv<n)throw new Error("Invalid chunk");let o;e instanceof Uint8Array?o=e.subarray(n,i):o=e.sublist(n,i);let s=e.subarray(n,i-vv);try{let a=this.handshake.decrypt(o,s);this.metrics?.decryptedPackets.increment(),t.append(a)}catch(a){throw this.metrics?.decryptErrors.increment(),a}}return t}close(e){return this.stream.close(e)}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}sendReset(e){this.stream.abort(e)}sendData(e){return{sentBytes:e.byteLength,canSendMore:this.stream.send(this.encrypt(e))}}};function $v(r,e,t){return new Mv(r,e,t)}async function AO(r,e){let{log:t,connection:n,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await Uv(o,a.publicKey,l),f=new Jm({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});Rv(f.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(f.writeMessageA(su),e),t.trace("Stage 0 - Initiator finished sending first message."),Dv(f.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let h=f.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),Ov(f.re,t),vO(f.rs,t),t.trace("Initiator going to check remote's signature...");let d=await Fv(h,f.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(f.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[m,y]=f.ss.split();return Nv(m,y,t),{payload:d,encrypt:w=>m.encryptWithAd(su,w),decrypt:(w,x)=>y.decryptWithAd(su,w,x)}}async function _O(r,e){let{log:t,connection:n,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await Uv(o,a.publicKey,l),f=new Jm({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});Rv(f.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),f.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),Ov(f.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(f.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Dv(f.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let h=f.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let d=await Fv(h,f.rs,c),[m,y]=f.ss.split();return Nv(m,y,t),{payload:d,encrypt:w=>y.encryptWithAd(su,w),decrypt:(w,x)=>m.decryptWithAd(su,w,x)}}var v6=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;log;constructor(e,t={}){let{staticNoiseKey:n,extensions:i,crypto:o,prologueBytes:s}=t,{metrics:a}=e;this.components=e,this.log=e.logger.forComponent("libp2p:noise");let c=o??wO;this.crypto=xO(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?bO(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=s??ke(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[Ge]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){let n=e.log?.newScope("noise")??this.log,i=za(e,{lengthEncoder:Cd,lengthDecoder:Td,maxDataLength:65535}),o=await this.performHandshakeInitiator(i,this.components.privateKey,n,t?.remotePeer?.publicKey,t),s=er(o.payload.identityKey);return{connection:$v(i.unwrap(),o,this.metrics),remoteExtensions:o.payload.extensions,remotePeer:Wo(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;let t=this.components.upgrader.getStreamMuxers();if(t!=null)for(let n of e){let i=t.get(n);if(i!=null)return i}if(e.length)throw new yg("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){let n=e.log?.newScope("noise")??this.log,i=za(e,{lengthEncoder:Cd,lengthDecoder:Td,maxDataLength:65535}),o=await this.performHandshakeResponder(i,this.components.privateKey,n,t?.remotePeer?.publicKey,t),s=er(o.payload.identityKey);return{connection:$v(i.unwrap(),o,this.metrics),remoteExtensions:o.payload.extensions,remotePeer:Wo(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,i,o){let s,a=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await AO({connection:e,privateKey:t,remoteIdentityKey:i,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return s}async performHandshakeResponder(e,t,n,i,o){let s,a=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await _O({connection:e,privateKey:t,remoteIdentityKey:i,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return s}};function E6(r={}){return e=>new v6(e,r)}var Ht;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Ht||(Ht={}));var ct;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(ct||(ct={}));var N_e=Object.values(ct).filter(r=>typeof r!="string"),CO=0,vr;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(vr||(vr={}));var Zo=12;var ra=class extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}};function TO(r){return r?.reason!==null}var yi=class extends ra{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,vr.ProtocolError),this.name="InvalidFrameError"}},Pd=class extends ra{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,vr.ProtocolError),this.name="UnRequestedPingError"}},Rd=class extends ra{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,vr.ProtocolError),this.name="NotMatchingPingError"}};var S6=class extends ra{static name="StreamAlreadyExistsError";constructor(e="Stream already exists"){super(e,vr.ProtocolError),this.name="StreamAlreadyExistsError"}},A6=class extends ra{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e,vr.ProtocolError),this.name="DecodeInvalidVersionError"}},_6=class extends ra{static name="BothClientsError";constructor(e="Both clients"){super(e,vr.ProtocolError),this.name="BothClientsError"}},Dd=class extends ra{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,vr.ProtocolError),this.name="ReceiveWindowExceededError"}};var F_e=new Set([yi.name,Pd.name,Rd.name,S6.name,A6.name,_6.name,Dd.name]),r1=256*1024,C6=16*1024*1024;var n1={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,maxMessageSize:64*1024,maxEarlyStreams:10,streamOptions:{initialStreamWindowSize:r1,maxStreamWindowSize:C6,inactivityTimeout:12e4,maxReadBufferLength:4194304,maxWriteBufferLength:1/0}};function IO(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new O("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new O("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new O("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new O("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<r1)throw new O("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new O("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new O("MaxStreamWindowSize must be less than equal MAX_UINT32")}function PO(r){return r.header.type===Ht.Data&&r.data!==null}var kO=2**24;function EY(r){if(r[0]!==CO)throw new yi("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*kO+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*kO+(r[9]<<16)+(r[10]<<8)+r[11]}}var T6=class{buffer;constructor(){this.buffer=new oe}*emitFrames(e){for(this.buffer.append(e);;){let t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=Zo;if(this.buffer.byteLength<Zo)return;let t=EY(this.buffer.subarray(0,Zo));if(t.type===Ht.Data){if(e+=t.length,this.buffer.byteLength<e)return;let n=this.buffer.sublist(Zo,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}};function Hv(r){let e=new Uint8Array(Zo);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var Pn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(Pn||(Pn={}));var I6=class extends Ha{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){let t=e.initialStreamWindowSize??r1;super({...e,maxMessageSize:t-Zo}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??C6,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;let n=()=>{this.state=Pn.Finished};this.addEventListener("close",n)}sendData(e){let t=e.byteLength,n=0,i=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){i=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}let o=Math.min(this.sendWindowCapacity,e.byteLength),s=this.getSendFlags(),a=e.sublist(0,o);e.consume(o);let c=this.sendFrame({type:Ht.Data,flag:s,streamID:this.streamId,length:o},a);if(this.sendWindowCapacity-=o,n+=o,!c){i=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:i}}sendReset(){this.sendFrame({type:Ht.WindowUpdate,flag:ct.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|ct.FIN;this.sendFrame({type:Ht.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=Pn.Paused}sendResume(){this.state=Pn.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-Zo,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!PO(e))throw new yi("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new Dd("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&ct.ACK)===ct.ACK&&this.state===Pn.SYNSent&&(this.state=Pn.Established),(e&ct.FIN)===ct.FIN&&this.onRemoteCloseWrite(),(e&ct.RST)===ct.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case Pn.Init:return this.state=Pn.SYNSent,ct.SYN;case Pn.SYNReceived:return this.state=Pn.Established,ct.ACK;default:return 0}}sendWindowUpdate(){if(this.state===Pn.Paused){this.epochStart=Date.now();return}let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Ht.WindowUpdate,flag:e,streamID:this.streamId,length:i})}};function RO(r){return{type:Ht[r.type],flags:[(r.flag&ct.SYN)===ct.SYN?"SYN":void 0,(r.flag&ct.ACK)===ct.ACK?"ACK":void 0,(r.flag&ct.FIN)===ct.FIN?"FIN":void 0,(r.flag&ct.RST)===ct.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}var DO="/yamux/1.0.0",k6=class{protocol=DO;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[Ge]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new Vv(e,{...this._init})}},Vv=class extends $a{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:DO,name:"yamux"}),this.client=e.direction==="outbound",IO(t),this.enableKeepAlive=t.enableKeepAlive??n1.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??n1.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??n1.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??n1.maxOutboundStreams,this.decoder=new T6,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=Ka(async n=>{try{await this.ping(n)}catch(i){this.log.error("ping error: %s",i)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(let t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new Xi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Xi("Muxer closed locally");let e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new of("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);let t=this._newStream(e,Pn.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new Xi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Xi("Muxer closed locally");if(this.activePing!=null)return Et(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await Et(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{let t=e?.reason??vr.NormalTermination;this.log.trace("muxer close reason=%s",vr[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=vr.InternalError;TO(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(o=>o.streamId===e)!=null)throw new O("Stream already exists with that id");let i=new I6({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return i.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){let{streamID:t,type:n,length:i}=e.header;if(this.log.trace("received frame %o",RO(e.header)),t===0)switch(n){case Ht.Ping:{this.handlePing(e.header);return}case Ht.GoAway:{this.handleGoAway(i);return}default:throw new yi("Invalid frame type")}else switch(e.header.type){case Ht.Data:case Ht.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new yi("Invalid frame type")}}handlePing(e){if(e.flag===ct.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,ct.ACK);else if(e.flag===ct.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new yi("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new Pd("ping not requested");if(this.activePing.id!==e)throw new Rd("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",vr[e]??"unknown"),this.remoteGoAway=e,e===vr.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){let{streamID:t,flag:n,type:i}=e.header;(n&ct.SYN)===ct.SYN&&this.incomingStream(t);let o=this.streams.find(s=>s.streamId===t);if(o===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(i){case Ht.WindowUpdate:{o.handleWindowUpdate(e);return}case Ht.Data:{o.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new O("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Ht.WindowUpdate,flag:ct.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Ht.WindowUpdate,flag:ct.RST,streamID:e,length:0});return}let t=this._newStream(e,Pn.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===Ht.Data){if(t==null)throw new yi("Invalid frame");n=new oe(Hv(e),t)}else n=Hv(e);return this.log.trace("sending frame %o",RO(e)),this.send(n)}sendPing(e,t=ct.SYN){t===ct.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:Ht.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=vr.NormalTermination){this.log("sending GoAway reason=%s",vr[e]),this.localGoAway=e,this.sendFrame({type:Ht.GoAway,flag:0,streamID:0,length:e})}};function OO(r={}){return()=>new k6(r)}var NO="libp2p",LO="autonat",BO="1.0.0";var Dt;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),(function(l){l.codec=()=>_t(t)})(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(i||(i={})),(function(l){l.codec=()=>_t(i)})(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){let u;l.codec=()=>(u==null&&(u=ve((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let m of f.addrs)h.uint32(18),h.bytes(m);d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={addrs:[]},y=h==null?f.len:f.pos+h;for(;f.pos<y;){let w=f.uint32();switch(w>>>3){case 1:{m.id=f.bytes();break}case 2:{if(d.limits?.addrs!=null&&m.addrs.length===d.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');m.addrs.push(f.bytes());break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>be(f,l.codec()),l.decode=(f,h)=>xe(f,l.codec(),h)})(o=r.PeerInfo||(r.PeerInfo={}));let s;(function(l){let u;l.codec=()=>(u==null&&(u=ve((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},y=h==null?f.len:f.pos+h;for(;f.pos<y;){let w=f.uint32();switch(w>>>3){case 1:{m.peer=r.PeerInfo.codec().decode(f,f.uint32(),{limits:d.limits?.peer});break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>be(f,l.codec()),l.decode=(f,h)=>xe(f,l.codec(),h)})(s=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=ve((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},y=h==null?f.len:f.pos+h;for(;f.pos<y;){let w=f.uint32();switch(w>>>3){case 1:{m.status=r.ResponseStatus.codec().decode(f);break}case 2:{m.statusText=f.string();break}case 3:{m.addr=f.bytes();break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>be(f,l.codec()),l.decode=(f,h)=>xe(f,l.codec(),h)})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=ve((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u,f={})=>{let h={},d=u==null?l.len:l.pos+u;for(;l.pos<d;){let m=l.uint32();switch(m>>>3){case 1:{h.type=r.MessageType.codec().decode(l);break}case 2:{h.dial=r.Dial.codec().decode(l,l.uint32(),{limits:f.limits?.dial});break}case 3:{h.dialResponse=r.DialResponse.codec().decode(l,l.uint32(),{limits:f.limits?.dialResponse});break}default:{l.skipType(m&7);break}}}return h})),c),r.encode=l=>be(l,r.codec()),r.decode=(l,u)=>xe(l,r.codec(),u)})(Dt||(Dt={}));var IY=4,kY=8,P6=class{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??NO}/${LO}/${BO}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??20,this.connectionThreshold=t.connectionThreshold??80,this.maxMessageSize=t.maxMessageSize??8192,this.dialResults=lr({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=Ka(this.findRandomPeers.bind(this),6e4),this.addressFilter=Rr(1024)}[Symbol.toStringTag]="@libp2p/autonat";[Ge]=["@libp2p/autonat"];get[ni](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,(e,t)=>{this.handleIncomingAutonatStream(e,t).catch(n=>{this.log.error("error handling incoming autonat stream - %e",n)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;let t=Oe([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(let n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e,t){let n=AbortSignal.timeout(this.timeout);try{let i=Tt(e,{maxDataLength:this.maxMessageSize}).pb(Dt),o=await i.read({signal:n}),s=await this.handleAutonatMessage(o,t,{signal:n});await i.write(s,{signal:n}),await e.close({signal:n})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.abort(i)}}async handleAutonatMessage(e,t,n){let i=this.components.addressManager.getAddresses().map(f=>Te(f).host),o=e.dial;if(o==null)return this.log.error("dial was missing from message"),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,a=o.peer;if(a?.id==null)return this.log.error("peerId missing from message"),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{let f=Xe(a.id);s=ur(f)}catch(f){return this.log.error("invalid PeerId - %e",f),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let c=a.addrs.map(f=>se(f)).filter(f=>{try{let h=Te(f);return qt(f)?!1:h.host!==Te(t.remoteAddr).host?(this.log.trace("not dialing %a - target host did not match remote host %a",f,t.remoteAddr),!1):i.includes(h.host)?!1:this.components.transportManager.dialTransportForMultiaddr(f)==null?(this.log.trace("not dialing %a - transport unsupported",f),!1):!0}catch{return!1}}).map(f=>(f.getComponents().find(h=>h.code===421)?.value==null&&(f=f.encapsulate(`/p2p/${s.toString()}`)),f));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",s),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(f=>f.toString()).join(", "),s);let l="",u=c[0];for(let f of c){let h;u=f;try{if(h=await this.components.connectionManager.openConnection(f,n),!h.remoteAddr.equals(f))throw this.log.error("tried to dial %a but dialed %a",f,h.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",s,f),{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.OK,addr:h.remoteAddr.decapsulateCode(421).bytes}}}catch(d){this.log.error("could not dial %p - %e",s,d),l=d.message}finally{h!=null&&await h.close()}}return{type:Dt.MessageType.DIAL_RESPONSE,dialResponse:{status:Dt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){let n=this.components.addressManager.getAddressesWithMetadata().sort((i,o)=>i.type==="observed"&&o.type!=="observed"?1:o.type==="observed"&&i.type!=="observed"?-1:0).filter(i=>!(!(i.expires<Date.now())||Te(i.multiaddr).type==="ip6"&&(!t||!k2(i.multiaddr))||qt(i.multiaddr)));for(let i of n){let o=i.multiaddr.toString(),s=this.dialResults.get(o);if(s!=null){if(s.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",s.multiaddr,e);continue}if(s.queue.size>10){this.log.trace("%a already has enough peers queued",s.multiaddr);continue}}if(s==null){let a=i.expires<Date.now();if(a&&this.addressFilter.remove?.(o),this.addressFilter.has(o))continue;this.addressFilter.add(o),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",o),s={multiaddr:i.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:Vb(),queue:new Kr({concurrency:3,maxSize:50}),type:i.type,lastVerified:i.lastVerified},this.dialResults.set(o,s)}return s}}removeOutdatedMultiaddrResults(){let e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(let t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();let n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:s})=>Te(s).type==="ip6"),i=this.getNetworkSegment(e.remoteAddr),o=this.getFirstUnverifiedMultiaddr(i,n);if(o==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){o.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",o.multiaddr),this.confirmAddress(o)):this.log("skipping verifying %a because we are too close to the connection limit",o.multiaddr);return}o.queue.add(async s=>{await this.askPeerToVerify(e,i,s)},{peerId:e.remotePeer,multiaddr:o.multiaddr}).catch(s=>{o?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,o?.multiaddr,s)})}async askPeerToVerify(e,t,n){let i=this.dialResults.get(n.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}let o=AbortSignal.timeout(this.timeout);this.log.trace("asking %a to verify multiaddr %s",e.remoteAddr,n.multiaddr);let s=await e.newStream(this.protocol,{signal:o});try{let a=Tt(s).pb(Dt),[,c]=await Promise.all([a.write({type:Dt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:o}),a.read({signal:o})]);if(c.type!==Dt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}let l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==Dt.ResponseStatus.OK&&l!==Dt.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(n.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===Dt.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===Dt.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===IY&&this.confirmAddress(i),i.failure===kY&&this.unconfirmAddress(i)}finally{try{await s.close({signal:o})}catch(a){s.abort(a)}}}hasConnectionCapacity(){let t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){let t=Te(e);switch(t.type){case"ip4":return t.host.split(".")[0].padStart(3,"0");case"ip6":return t.host.split(":")[0].padStart(4,"0");default:throw new O(`Remote address ${e} was not an IPv4 or Ipv6 address`)}}};function MO(r={}){return e=>new P6(e,r)}var PY="bootstrap",RY=50,DY=1e3,zv=class extends Ce{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??DY,this.list=t.list.map(n=>se(n)).filter(n=>Yf.matches(n)?n.getComponents().findLast(o=>o.code===421)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:tt(n.getComponents().findLast(i=>i.code===421)?.value??""),multiaddrs:[n]})),this._init=t}[jc]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[Ge]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??PY]:{value:this._init.tagValue??RY,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function UO(r){return e=>new zv(e,r)}var Kv=1e3,FO=60*Kv;var FCe=120*FO,$O=1,R6=5e3,HO=100;var i1=`${Wc}-circuit-relay`,$Ce=2*FO,HCe=BigInt(1<<17),au="/libp2p/circuit/relay/0.2.0/hop",qv="/libp2p/circuit/relay/0.2.0/stop",VCe=30*Kv,zCe=30*Kv,jv=300,VO=4096,zO=.001;var ac;(function(r){let e;(function(i){i.RESERVE="RESERVE",i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.RESERVE=0]="RESERVE",i[i.CONNECT=1]="CONNECT",i[i.STATUS=2]="STATUS"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.peer!=null&&(o.uint32(18),Od.codec().encode(i.peer,o)),i.reservation!=null&&(o.uint32(26),D6.codec().encode(i.reservation,o)),i.limit!=null&&(o.uint32(34),Nd.codec().encode(i.limit,o)),i.status!=null&&(o.uint32(40),Xr.codec().encode(i.status,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.peer=Od.codec().decode(i,i.uint32(),{limits:s.limits?.peer});break}case 3:{a.reservation=D6.codec().decode(i,i.uint32(),{limits:s.limits?.reservation});break}case 4:{a.limit=Nd.codec().decode(i,i.uint32(),{limits:s.limits?.limit});break}case 5:{a.status=Xr.codec().decode(i);break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(ac||(ac={}));var Jo;(function(r){let e;(function(i){i.CONNECT="CONNECT",i.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.CONNECT=0]="CONNECT",i[i.STATUS=1]="STATUS"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.peer!=null&&(o.uint32(18),Od.codec().encode(i.peer,o)),i.limit!=null&&(o.uint32(26),Nd.codec().encode(i.limit,o)),i.status!=null&&(o.uint32(32),Xr.codec().encode(i.status,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.peer=Od.codec().decode(i,i.uint32(),{limits:s.limits?.peer});break}case 3:{a.limit=Nd.codec().decode(i,i.uint32(),{limits:s.limits?.limit});break}case 4:{a.status=Xr.codec().decode(i);break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(Jo||(Jo={}));var Od;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={id:ke(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.id=t.bytes();break}case 2:{if(i.limits?.addrs!=null&&o.addrs.length===i.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Od||(Od={}));var D6;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let o of t.addrs)n.uint32(18),n.bytes(o);t.voucher!=null&&(n.uint32(26),N6.codec().encode(t.voucher,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.expire=t.uint64();break}case 2:{if(i.limits?.addrs!=null&&o.addrs.length===i.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');o.addrs.push(t.bytes());break}case 3:{o.voucher=N6.codec().decode(t,t.uint32(),{limits:i.limits?.voucher});break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(D6||(D6={}));var Nd;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.duration=t.uint32();break}case 2:{o.data=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(Nd||(Nd={}));var Xr;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Xr||(Xr={}));var Wv;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Wv||(Wv={}));(function(r){r.codec=()=>_t(Wv)})(Xr||(Xr={}));var O6;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={relay:ke(0),peer:ke(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.relay=t.bytes();break}case 2:{o.peer=t.bytes();break}case 3:{o.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(O6||(O6={}));var N6;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),O6.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={publicKey:ke(0),payloadType:ke(0),signature:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{o.publicKey=t.bytes();break}case 2:{o.payloadType=t.bytes();break}case 3:{o.payload=O6.codec().decode(t,t.uint32(),{limits:i.limits?.payload});break}case 5:{o.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(N6||(N6={}));var o1=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},L6=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},B6=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function Gv(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var s1=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},M6=mt(at(Yf.matchers[0],pt(290))),U6=mt(pt(290));var F6=class extends Ce{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(au,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(au)],orders:[()=>Math.random()<.5?1:-1,(n,i)=>{let o=KO(n),s=KO(i);return o>s?-1:s>o?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new Kr({concurrency:5});this.log("start random walk");for await(let n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(i=>i.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p - %e",n.id,i)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;let t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,i)})}async dialPeer({peerId:e,signal:t}){let n=Oe([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}};function KO(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date(K(e)).getTime()}var Xv=class extends Ce{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??R6,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(U6.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(M6.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);let o=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(o)}}else throw new qc(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>se(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function qO(r){return new Xv(r)}var jO="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var WO=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=jO[t[r]&63];return e};var OY=60*1e3*10,NY=60*1e3*5,LY=30*1e3,$6=class extends Ce{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new un,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??HO,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??R6,this.started=!1,this.relayFilter=Rr(100),this.reserveQueue=new Kr({concurrency:t?.reservationConcurrency??$O,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(o=>o.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",n.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(i1)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[i1]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=WO();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new qc("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new B6("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new qc("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let i=Date.now();try{let o=this.reservations.get(e);if(o!=null){let m=this.connectionManager.getConnections(e),y=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(w=>w.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),y=!0),y&&Gv(o.reservation.expire)>OY)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:o};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new o1("Not making reservation on discovered relay because we do not need any more relays");let s=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:s});if(Or.matches(a.remoteAddr))throw new L6("not creating reservation over relayed connection");let c=await this.#e(a,{signal:s}),l=Gv(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());let u=Math.min(Math.max(l-NY,LY),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u),h;if(t==="discovered"){let m=this.pendingReservations.pop();if(m==null)throw new o1("Made reservation on relay but did not need any more discovered relays");h={timeout:f,reservation:c,type:t,connection:a.id,id:m}}else h={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[i1]:{value:1,ttl:l}}}),this.#r();let d={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:d}),d}catch(o){throw t==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(s=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,s)}),o}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(au,t),o=Tt(n).pb(ac);this.log.trace("send RESERVE to %p",e.remotePeer),await o.write({type:ac.Type.RESERVE},t);let s;try{this.log.trace("reading response from %p",e.remotePeer),s=await o.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",s.status),s.status===Xr.OK&&s.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let l of s.reservation.addrs){let u=se(l);u.getComponents().find(f=>f.code===421)==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=se(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return s.reservation.addrs=[...c].map(l=>se(l).bytes),s.reservation}let a=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[i1]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Rr(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var Yv=class extends Fa{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}};function Qv(r){return new Yv(r)}var BY=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(se)}catch{return!1}return!0},GO={maxInboundStopStreams:jv,maxOutboundStopStreams:jv,stopTimeout:3e4},H6=class{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??GO.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??GO.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new F6(e,{filter:t.discoveryFilter??zb(VO,zO)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,i)})}),this.reservationStore=new $6(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[Ge]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[ni](){return this.discovery!=null?["@libp2p/identify"]:[]}[Ea]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(qv,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await wr(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Cr(this.discovery,this.reservationStore),await this.components.registrar.unhandle(qv),this.started=!1}async dial(e,t){let n=e.toString().split("/p2p-circuit"),i=se(n[0]),o=se(n[n.length-1]),s=i.getComponents().find(d=>d.code===421)?.value,a=o.getComponents().find(d=>d.code===421)?.value;if(s==null||a==null){let d=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${d}`),new ba(`C${d}`)}let c=tt(s),l=tt(a),f=this.components.connectionManager.getConnections(c)[0];f==null?(await this.components.peerStore.merge(c,{multiaddrs:[i]}),t.onProgress?.(new G("circuit-relay:open-connection")),f=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new G("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new G("circuit-relay:open-hop-stream")),h=await f.newStream(au,t);let d=Tt(h).pb(ac);t.onProgress?.(new G("circuit-relay:write-connect-message")),await d.write({type:ac.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[se(o).bytes]}},t),t.onProgress?.(new G("circuit-relay:read-connect-response"));let m=await d.read(t);if(m.status!==Xr.OK)throw new Ue(`failed to connect via relay with status ${m?.status?.toString()??"undefined"}`);let y=new s1(m.limit),w=Qv({stream:d.unwrap().unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:y.onData,onDataWrite:y.onData,log:h.log.newScope("circuit-relay:connection")}),x=await this.components.upgrader.upgradeOutbound(w,{...t,limits:y.getLimits()});return x.log("outbound relayed connection established to %p with limits %o, over connection %s",x.remotePeer,m.limit??"none",f.id),x}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",l,c,d),h?.abort(d),d}}createListener(e){return qO({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>M6.exactMatch(t)||U6.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Or.exactMatch(t))}async onStop(e,t){let n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",f)}let i=Tt(e).pb(Jo),o=await i.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,o.type),o?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await i.write({type:Jo.Type.STATUS,status:Xr.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(o.type!==Jo.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await i.write({type:Jo.Type.STATUS,status:Xr.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!BY(o)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await i.write({type:Jo.Type.STATUS,status:Xr.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}let s=ur(Xe(o.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,s)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await i.write({type:Jo.Type.STATUS,status:Xr.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await i.write({type:Jo.Type.STATUS,status:Xr.OK},{signal:n});let a=new s1(o.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),l=this.components.addressManager.getAddresses()[0],u=Qv({stream:i.unwrap().unwrap(),remoteAddr:c,localAddr:l,onDataRead:a.onData,onDataWrite:a.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),u.log("inbound relayed connection established to %p with limits %o, over connection %s",s,o.limit??"none",t.id)}finally{n?.clear()}}};function XO(r={}){return e=>new H6(e,r)}var bo;(function(r){let e;(function(i){i.UNUSED="UNUSED",i.CONNECT="CONNECT",i.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.UNUSED=0]="UNUSED",i[i.CONNECT=100]="CONNECT",i[i.SYNC=300]="SYNC"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.observedAddresses!=null)for(let a of i.observedAddresses)o.uint32(18),o.bytes(a);s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={observedAddresses:[]},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{if(s.limits?.observedAddresses!=null&&a.observedAddresses.length===s.limits.observedAddresses)throw new yt('Decode error - map field "observedAddresses" had too many elements');a.observedAddresses.push(i.bytes());break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(bo||(bo={}));function Zv(r,e){return Or.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:sy.matches(r)?!0:Sk.matches(r)?!qt(r):!1}var YO=1024*4,QO=100,V6={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},z6=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??V6.timeout,this.retries=t.retries??V6.retries,this.maxInboundStreams=t.maxInboundStreams??V6.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??V6.maxOutboundStreams,this.handleIncomingUpgrade=this.handleIncomingUpgrade.bind(this)}[Symbol.toStringTag]="@libp2p/dcutr";[ni]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(a1,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Or.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt - %e",n)})}}),await this.registrar.handle(a1,this.handleIncomingUpgrade,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(a1),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([a1],{signal:i.signal,runOnLimitedConnection:!0});let o=Tt(t,{maxDataLength:YO}).pb(bo);this.log("B sending connect to %p",e.remotePeer);let s=Date.now();await o.write({type:bo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);let a=await o.read(i);if(a.type!==bo.Type.CONNECT)throw this.log("A sent wrong message type"),new Ue("DCUtR message type was incorrect");let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Ue("DCUtR connect message had no multiaddrs");let l=Date.now()-s;this.log("A sending sync, rtt %dms",l),await o.write({type:bo.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await yk(l/2),this.log("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:i.signal,priority:QO,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(o){if(this.log.error("error while attempting DCUtR on attempt %d of %d - %e",n+1,this.retries,o),t?.abort(o),n===this.retries)throw o}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{let o=i.multiaddr;return o.getComponents().find(s=>s.code===421)?.value==null?o.encapsulate(`/p2p/${e.remotePeer}`):o}).filter(i=>Zv(i,this.transportManager));if(n.length>0){let i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let o=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(Or.exactMatch(o.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,o.remoteAddr),await e.close({signal:i}),!0}catch(o){this.log.error("unilateral connection upgrade to %p on addresses %a failed - %e",e.remotePeer,n,o)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)},i=Tt(e,{maxDataLength:YO}).pb(bo);this.log("A receiving connect");let o=await i.read(n);if(o.type!==bo.Type.CONNECT)throw this.log("B sent wrong message type"),new Ue("DCUtR message type was incorrect");if(o.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Ue("DCUtR connect message had no multiaddrs");let s=this.getDialableMultiaddrs(o.observedAddresses);if(s.length===0)throw this.log("B had no dialable multiaddrs in %o",o.observedAddresses.map(l=>se(l))),new Ue("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:bo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(n)).type!==bo.Type.SYNC)throw new Ue("DCUtR message type was incorrect");this.log("A dialing",s);let c=await this.connectionManager.openConnection(s,{signal:n.signal,priority:QO,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n),await e.close(n)}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let i=se(n);if(!Zv(i,this.transportManager))continue;t.push(i)}catch{}return t}};var a1="/libp2p/dcutr";function ZO(r={}){return e=>new z6(e,r)}function fe(r){if(r!==void 0&&r!==fe.REQUEST&&r!==fe.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");r===void 0||this.initialize(r),this.maxHeaderSize=fe.maxHeaderSize}fe.prototype.initialize=function(r,e){if(r!==fe.REQUEST&&r!==fe.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");this.type=r,this.state=r+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1};fe.encoding="ascii";fe.maxHeaderSize=80*1024;fe.REQUEST="REQUEST";fe.RESPONSE="RESPONSE";var JO=fe.kOnHeaders=1,Jv=fe.kOnHeadersComplete=2,K6=fe.kOnBody=3,eE=fe.kOnMessageComplete=4;fe.prototype[JO]=fe.prototype[Jv]=fe.prototype[K6]=fe.prototype[eE]=function(){};var eN=!0;Object.defineProperty(fe,"kOnExecute",{get:function(){return eN=!1,99}});var tN=fe.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"],rN=tN.indexOf("CONNECT");fe.prototype.reinitialize=fe;fe.prototype.close=fe.prototype.pause=fe.prototype.resume=fe.prototype.remove=fe.prototype.free=function(){};fe.prototype._compatMode0_11=!1;fe.prototype.getAsyncId=function(){return 0};var MY={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};fe.prototype.execute=function(r,e,t){if(!(this instanceof fe))throw new TypeError("not a HTTPParser");e=e||0,t=typeof t=="number"?t:r.length,this.chunk=r,this.offset=e;var n=this.end=e+t;try{for(;this.offset<n&&!this[this.state](););}catch(i){if(this.isUserCall)throw i;return this.hadError=!0,i}return this.chunk=null,t=this.offset-e,MY[this.state]&&(this.headerSize+=t,this.headerSize>(this.maxHeaderSize||fe.maxHeaderSize))?new Error("max header size exceeded"):t};var UY={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};fe.prototype.finish=function(){if(!this.hadError){if(!UY[this.state])return new Error("invalid state for EOF");this.state==="BODY_RAW"&&this.userCall()(this[eE]())}};fe.prototype.consume=fe.prototype.unconsume=fe.prototype.getCurrentBuffer=function(){};fe.prototype.userCall=function(){this.isUserCall=!0;var r=this;return function(e){return r.isUserCall=!1,e}};fe.prototype.nextRequest=function(){this.userCall()(this[eE]()),this.reinitialize(this.type)};fe.prototype.consumeLine=function(){for(var r=this.end,e=this.chunk,t=this.offset;t<r;t++)if(e[t]===10){var n=this.line+K(e.subarray(this.offset,t),fe.encoding);return n.charAt(n.length-1)==="\r"&&(n=n.substr(0,n.length-1)),this.line="",this.offset=t+1,n}this.line+=K(e.subarray(this.offset,this.end),fe.encoding),this.offset=this.end};var FY=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,$Y=/^[ \t]+(.*[^ \t])/;fe.prototype.parseHeader=function(r,e){if(r.indexOf("\r")!==-1)throw q6("HPE_LF_EXPECTED");var t=FY.exec(r),n=t&&t[1];if(n)e.push(n),e.push(t[2]);else{var i=$Y.exec(r);i&&e.length&&(e[e.length-1]&&(e[e.length-1]+=" "),e[e.length-1]+=i[1])}};var HY=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;fe.prototype.REQUEST_LINE=function(){var r=this.consumeLine();if(r){var e=HY.exec(r);if(e===null)throw q6("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?e[1]:tN.indexOf(e[1]),this.info.method===-1)throw new Error("invalid request method");this.info.url=e[2],this.info.versionMajor=+e[3],this.info.versionMinor=+e[4],this.body_bytes=0,this.state="HEADER"}};var VY=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;fe.prototype.RESPONSE_LINE=function(){var r=this.consumeLine();if(r){var e=VY.exec(r);if(e===null)throw q6("HPE_INVALID_CONSTANT");this.info.versionMajor=+e[1],this.info.versionMinor=+e[2];var t=this.info.statusCode=+e[3];this.info.statusMessage=e[4],((t/100|0)===1||t===204||t===304)&&(this.body_bytes=0),this.state="HEADER"}};fe.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(this.connection.indexOf("close")!==-1)return!1}else if(this.connection.indexOf("keep-alive")===-1)return!1;return!!(this.body_bytes!==null||this.isChunked)};fe.prototype.HEADER=function(){var r=this.consumeLine();if(r!==void 0){var e=this.info;if(r)this.parseHeader(r,e.headers);else{for(var t=e.headers,n=!1,i,o=!1,s=0;s<t.length;s+=2)switch(t[s].toLowerCase()){case"transfer-encoding":this.isChunked=t[s+1].toLowerCase()==="chunked";break;case"content-length":if(i=+t[s+1],n){if(i!==this.body_bytes)throw q6("HPE_UNEXPECTED_CONTENT_LENGTH")}else n=!0,this.body_bytes=i;break;case"connection":this.connection+=t[s+1].toLowerCase();break;case"upgrade":o=!0;break}this.isChunked&&n&&(n=!1,this.body_bytes=null),o&&this.connection.indexOf("upgrade")!=-1?e.upgrade=this.type===fe.REQUEST||e.statusCode===101:e.upgrade=e.method===rN,this.isChunked&&e.upgrade&&(this.isChunked=!1),e.shouldKeepAlive=this.shouldKeepAlive();var a;if(eN?a=this.userCall()(this[Jv](e)):a=this.userCall()(this[Jv](e.versionMajor,e.versionMinor,e.headers,e.method,e.url,e.statusCode,e.statusMessage,e.upgrade,e.shouldKeepAlive)),a===2)return this.nextRequest(),!0;if(this.isChunked&&!a)this.state="BODY_CHUNKHEAD";else{if(a||this.body_bytes===0)return this.nextRequest(),e.upgrade;this.body_bytes===null?this.state="BODY_RAW":this.state="BODY_SIZED"}}}};fe.prototype.BODY_CHUNKHEAD=function(){var r=this.consumeLine();r!==void 0&&(this.body_bytes=parseInt(r,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")};fe.prototype.BODY_CHUNK=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[K6](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")};fe.prototype.BODY_CHUNKEMPTYLINE=function(){var r=this.consumeLine();if(r!==void 0){if(r!=="")throw new Error("Expected empty line");this.state="BODY_CHUNKHEAD"}};fe.prototype.BODY_CHUNKTRAILERS=function(){var r=this.consumeLine();r!==void 0&&(r?this.parseHeader(r,this.trailers):(this.trailers.length&&this.userCall()(this[JO](this.trailers,"")),this.nextRequest()))};fe.prototype.BODY_RAW=function(){this.userCall()(this[K6](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end};fe.prototype.BODY_SIZED=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[K6](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||this.nextRequest()};["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(r){var e=fe["kOn"+r];Object.defineProperty(fe.prototype,"on"+r,{get:function(){return this[e]},set:function(t){return this._compatMode0_11=!0,rN="CONNECT",this[e]=t}})});function q6(r){var e=new Error("Parse Error");return e.code=r,e}function nN(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function na(r,e={}){let t=nN(r),n={_cancelled:!1,async start(){this._cancelled=!1},async pull(i){try{let{value:o,done:s}=await t.next();if(this._cancelled)return;if(s===!0){i.close();return}i.enqueue(o)}catch(o){i.error(o)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(n,e)}var zY=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),iN=Es({name:"sha-1",code:17,encode:zY("SHA-1")});var j6=class extends globalThis.Request{constructor(e,t={}){let n=t.method??"GET",i=es(t),o=t.body;W6(n,i)&&(t.method="UPGRADE"),super(e,t),Object.defineProperties(this,{body:{value:o,writable:!1},method:{value:n,writable:!1},headers:{value:i,writable:!1}})}};var oN={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a Teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"};var ts=class extends globalThis.Response{constructor(e,t={}){let n=es(t),i=t.status??200;(i<200||i>599)&&(t.status=200),super(e,t),Object.defineProperties(this,{status:{value:i,writable:!1},statusText:{value:oN[i],writable:!1},headers:{value:n,writable:!1}})}};var KY=["dns","dns4","dns6","dnsaddr"];function l1(r,e){if(r instanceof URL)return r;let t=X6(r,e),{httpPath:n}=Y6(r);return new URL(`http://${t}${n}`)}function u1(r){return r instanceof Uint8Array?r:r instanceof DataView?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r,0,r.byteLength)}function aN(r,e){let t={method:r.method,headers:r.headers};if((t.method!=="GET"||r.upgrade)&&t.method!=="HEAD"){let n=e;r.upgrade||(n=jY(e,r.headers.get("content-length"))),t.body=na(n),t.duplex="half"}return new j6(tE(r).toString(),t)}async function cN(r,e){if(e.send(R([`HTTP/1.1 ${r.status} ${r.statusText}`,...G6(r.headers),"",""].join(`\r
`))),r.body==null){await e.close().catch(n=>{e.abort(n)});return}let t=r.body.getReader();for(;;){let n=await t.read();if(n.value!=null&&(e.send(n.value)||await e.onDrain()),n.done)break}await e.close().catch(n=>{e.abort(n)})}var lN=R(["HTTP/1.1 404 Not Found","Connection: close","",""].join(`\r
`)),qY=R(["HTTP/1.1 400 Bad Request","Connection: close","",""].join(`\r
`)),$Ie=R(["HTTP/1.1 500 Internal Server Error","Connection: close","",""].join(`\r
`)),HIe=R(["HTTP/1.1 501 Not Implemented","Connection: close","",""].join(`\r
`));function G6(r){let e=[];r.get("Connection")==null&&r.set("Connection","close");for(let[t,n]of r.entries())e.push(`${t}: ${n}`);return e}async function*jY(r,e){if(e=parseInt(`${e??""}`),e==null||isNaN(e))return r;let t=0;for await(let n of r){if(t+=n.byteLength,t>e){yield n.subarray(0,t-e);return}if(yield n.subarray(),t===e)return}}function Ld(r,e){if(typeof r=="string"&&(r.startsWith("/")?r=se(r):r=new URL(r)),_r(r)&&(r=se(`/p2p/${r}`)),r instanceof URL&&r.protocol==="multiaddr:"&&(r=n4(r.toString())),jo(r)&&(r=[r]),Array.isArray(r)){for(let t of r)if(t.getComponents().some(({name:i})=>i==="http")){let i=tc(t);return new URL(`${i}${e??""}`)}}return e==null?r:r instanceof URL?new URL(`${r}${e.substring(1)}`):r.map(t=>t.encapsulate(`/http-path/${encodeURIComponent(e.substring(1))}`))}function es(r={}){return r.headers instanceof Headers||(r.headers=new Headers(r.headers)),r.headers}function c1(r){return r!=null&&r!==""}function X6(r,e){let t,n=80,i="http:";if(r instanceof URL&&(t=r.hostname,n=parseInt(r.port,10),i=r.protocol),c1(t)||(t=e.get("host")??void 0),!c1(t)&&Array.isArray(r))for(let o of r){let a=o.getComponents().filter(({name:c})=>KY.includes(c))?.[0]?.value;if(a!=null){t=a;break}}if(!c1(t)&&Array.isArray(r))for(let o of r){let s=o.getComponents().findLast(a=>a.code===421)?.value;try{let a=Te(o);a.port!=null&&(n=a.port)}catch{}if(s!=null){t=tt(s).toCID().toString(Mr);break}}if(!c1(t)&&Array.isArray(r))for(let o of r)try{let s=Te(o);s.host!=null&&(t=s.host);break}catch{}if(c1(t))return i==="http:"&&n!==80&&(t=`${t}:${n}`),i==="https:"&&n!==443&&(t=`${t}:${n}`),t;throw new O("Could not determine request host name - a request must have a host header, be made to a DNS or IP-based multiaddr or an http(s) URL")}function Y6(r){let e="/";return r=r.map(t=>se(t.getComponents().filter(n=>n.name==="http-path"?(e=n.value??"/",!1):!0))),{httpPath:e,addresses:r}}function Q6(r,e=["GET"]){return r==null?e:(typeof r=="string"&&(r=[r]),r.map(t=>t.toUpperCase()))}function tE(r){let e=r.url??"/";if(e.startsWith("http"))return new URL(e);let t=WY(r);return new URL(`http://${t}${e}`)}function WY(r){let e=r.headers?.host;if(e==null&&(e=r.headers?.Host),e==null&&typeof r.headers.get=="function"&&(e=r.headers.get("host")),e==null)throw new O("Could not read host");return e}function W6(r,e){return r==="GET"&&e.get("connection")?.toLowerCase()==="upgrade"&&e.get("upgrade")?.toLowerCase()==="websocket"}function sN(r,e){if(r instanceof Headers)return r.get(e)??void 0;let t=r[e];return Array.isArray(t)?t.join(","):t}async function rE(r){if(sN(r,"sec-websocket-version")!=="13")throw new Kc("Invalid version");let e=sN(r,"sec-websocket-key");if(e==null)throw new Kc("Missing sec-websocket-key");let t=`${e}258EAFA5-E914-47DA-95CA-C5AB0DC85B11`,n=await iN.digest(R(t)),i=Jh.encode(n.digest).substring(1);return new Headers({Upgrade:"websocket",Connection:"upgrade","Sec-WebSocket-Accept":i})}async function uN(r,e){let t=new fe("REQUEST"),n=new oe,i;t[fe.kOnHeadersComplete]=o=>{let s=new Headers;for(let a=0;a<o.headers.length;a+=2)s.set(o.headers[a].toLowerCase(),o.headers[a+1]);i={...o,headers:s,raw:n,method:fe.methods[o.method]}};try{for(;;){let{data:o}=await An(r,"message",e?.signal),s=o.subarray(),a=t.execute(s,0,s.byteLength);if(a instanceof Error)throw a;if(n.append(s.subarray(0,a)),a<s.byteLength&&r.push(s.subarray(a)),i!=null)return i}}catch(o){r.abort(o)}finally{t.finish()}throw new Error("Failed to read header info from request")}var Z6=class extends Error{static name="InvalidResponseError";name="InvalidResponseError"};var GY=[101,204,205,304];async function fN(r,e,t){let n=Promise.withResolvers(),i=new TransformStream,o=i.writable.getWriter(),s=!1,a=new fe("RESPONSE");a.maxHeaderSize=t.maxHeaderSize??fe.maxHeaderSize,a[fe.kOnHeadersComplete]=l=>{t.log("response headers complete"),s=!0;let u=new Headers;for(let d=0;d<l.headers.length;d+=2)u.append(l.headers[d],l.headers[d+1]);let f=i.readable;GY.includes(l.statusCode)&&(i.writable.close().catch(()=>{}),i.readable.cancel().catch(()=>{}),f=null);let h=new ts(f,{status:l.statusCode,statusText:l.statusMessage,headers:u});n.resolve(h)},a[fe.kOnBody]=l=>{t.log("response read body %d bytes",l.byteLength),o.write(l).catch(u=>{n.reject(u)})},a[fe.kOnMessageComplete]=()=>{t.log("response message complete"),o.close().catch(l=>{n.reject(l)})};let c=0;return r.addEventListener("message",({data:l})=>{t.log("response stream read %d bytes",l.byteLength),c+=l.byteLength;let u=a.execute(l.subarray(),0,l.byteLength);u instanceof Error&&(r.abort(u),a.finish())}),r.addEventListener("remoteCloseWrite",()=>{s||n.reject(new Z6(`Response ended before headers were received, read ${c} bytes`)),a.finish()}),n.promise}function dN(r,e){return e.set("Content-Length",`${r.size}`),e.set("Content-Type",r.type!=null&&r.type!==""?r.type:"application/octet-stream"),r.stream()}function hN(r,e){return e.set("Content-Length",`${r.byteLength}`),e.set("Content-Type","application/octet-stream"),new ReadableStream({start(t){t.enqueue(u1(r)),t.close()}})}function XY(r,e,t){let n=[`--${t}`],i=0,o=2;return typeof e=="string"?(n.push(`Content-Disposition: form-data; name="${r}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${e.length}`,""),i=e.length+o):(n.push(`Content-Disposition: form-data; name="${r}"; filename="${encodeURIComponent(e.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${e.size}`,""),i=e.size+o),R(n.join(`\r
`)).byteLength+i}function pN(r,e){let t=`-----------------------------${crypto.randomUUID()}`;e.set("Content-Type",`multipart/form-data; boundary=${t}`);let n=0;for(let[c,l]of r.entries())n+=XY(c,l,t);e.set("Content-Length",`${n}`);let i=r.entries(),o;function s(c,l,u,f){let h=[`--${f}`];typeof u=="string"?h.push(`Content-Disposition: form-data; name="${l}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${u.length}`,"",u,""):(h.push(`Content-Disposition: form-data; name="${l}"; filename="${encodeURIComponent(u.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${u.size}`,""),o=u.stream().getReader()),c.enqueue(R(h.join(`\r
`)))}async function a(c,l){if(o!=null){let h=await o.read();h.value!=null&&c.enqueue(h.value),h.done&&(c.enqueue(R(`\r
`)),o=void 0);return}let{done:u,value:f}=i.next();if(f!=null){let[h,d]=f;s(c,h,d,l)}u===!0&&c.close()}return new ReadableStream({async pull(c){await a(c,t)}})}function mN(r,e){e.set("Content-Type","application/octet-stream"),e.set("Transfer-Encoding","chunked");let t=r.getReader();return new ReadableStream({async pull(n){let{done:i,value:o}=await t.read();o!=null&&(n.enqueue(R(`${o.byteLength}\r
`)),n.enqueue(o),n.enqueue(R(`\r
`))),i&&(n.enqueue(R(`0\r
\r
`)),n.close())}})}function nE(r,e){return e.set("Content-Length",`${r.length}`),e.set("Content-Type",'text/plain; charset="UTF-8"'),new ReadableStream({start(t){t.enqueue(R(r)),t.close()}})}function gN(r,e){if(r!=null){if(typeof r=="string")return nE(r,e);if(r instanceof Blob)return dN(r,e);if(YY(r))return hN(r,e);if(r instanceof URLSearchParams)return nE(r.toString(),e);if(r instanceof ReadableStream)return mN(r,e);if(r instanceof FormData)return pN(r,e);throw new Error("Unsupported body type")}}function YY(r){return r==null?!1:r.byteLength!=null}async function yN(r,e,t){let n=new Headers(t.headers),i=n.get("host")??e.hostname;n.set("host",i),n.get("user-agent")==null&&n.set("user-agent","libp2p/fetch");let o=gN(t.body,n),s=[`${t?.method?.toUpperCase()??"GET"} ${e.pathname??"/"} HTTP/1.1`,...G6(n),"",""];r.send(R(s.join(`\r
`)))||await r.onDrain({signal:t.signal??void 0}),o!=null&&(t.log("request sending body"),await QY(r,o,t))}async function QY(r,e,t){let n=e.getReader();for(;;){let{done:i,value:o}=await n.read();if(o!=null&&(t.log("request send %d bytes",o.byteLength),r.send(o)||await r.onDrain({signal:t.signal??void 0})),i){t.log("request finished sending body");break}}}async function wN(r,e,t={}){let n=r.log.newScope("http-fetch");e=typeof e=="string"?new URL(e):e;let[i]=await Promise.all([fN(r,e,{...t,log:n}),yN(r,e,{...t,log:n})]);return await r.close({signal:t.signal??void 0}),i}var J6=class extends Event{message;error;filename="";lineno=0;colno=0;constructor(e){super("error"),this.error=e,this.message=e.message}},f1=class extends Event{code;reason;wasClean;constructor(e,t){super(e),this.code=t?.code??0,this.reason=t?.reason??"",this.wasClean=t?.wasClean??!0}};var ZY={CONTINUATION:0,TEXT:1,BINARY:2,CONNECTION_CLOSE:8,PING:9,PONG:10},iE={0:"CONTINUATION",1:"TEXT",2:"BINARY",8:"CONNECTION_CLOSE",9:"PING",10:"PONG"};var d1={NORMAL_CLOSURE:1e3,GOING_AWAY:1001,PROTOCOL_ERROR:1002,UNSUPPORTED_DATA:1003,RESERVED:1004,NO_STATUS_RECEIVED:1005,ABNORMAL_CLOSURE:1006,INVALID_FRAME_PAYLOAD_DATA:1007,POLICY_VIOLATION:1008,MESSAGE_TOO_BIG:1009,MANDATORY_EXT:1010,INTERNAL_SERVER_ERROR:1011,TLS_HANDSHAKE:1015};function xN(r){let e=0;if(r.byteLength<e+1)return;let n=r.get(e)&15;if(e++,iE[n]==null)throw new Error(`Unknown opcode: ${n}`);if(r.byteLength<e+1)return;let i=r.get(e),o=(i&128)===128,s=i&127;if(e++,s===126){if(r.byteLength<e+2)return;s=r.getUint16(e),e+=2}else if(s===127){if(r.byteLength<e+8)return;s=r.getUint32(e),e+=8}if(s===0)return r.consume(e),{type:iE[n]};let a;if(o){if(r.byteLength<e+4)return;a=r.subarray(e,e+4),e+=4}if(r.byteLength<e+s)return;let c=r.subarray(e,e+s);return e+=s,a!=null&&(c=bN(c,a)),r.consume(e),{type:iE[n],data:c}}function bN(r,e){let t=0;for(let n=0;n<r.byteLength;n++)r[n]=r[n]^e[t],t++,t===e.byteLength&&(t=0);return r}function vN(r,e,t){let i=new oe(Uint8Array.from([128|ZY[r]])),o=e?.byteLength??0;if(o<126)i.append(Uint8Array.from([o|(t===!0?128:0)]));else if(o<65535){let s=new oe(new Uint8Array(3));s.set(0,126|(t===!0?128:0)),s.setUint16(1,o),i.append(s)}else if(o<18446744073709552e3){let s=new oe(new Uint8Array(9));s.set(0,127|(t===!0?128:0)),s.setUint32(1,o),i.append(s)}else throw new Error("Payload too large");if(t===!0&&e!=null){let s=Uint8Array.from([0,0,0,0]);i.append(s),e=bN(e,s)}return e!=null&&i.append(e),i}function EN(r){if(r instanceof Uint8Array||r instanceof ArrayBuffer||r instanceof DataView)return u1(r);if(typeof r=="string")return R(r);if(r instanceof Blob)return r.arrayBuffer().then(e=>u1(e));throw new O("Unsupported data type")}async function SN(r,e){return new Promise((t,n)=>{let i=!1,o=new fe("RESPONSE");o[fe.kOnHeadersComplete]=s=>{i=!0;let a=[];for(let c=0;c<s.headers.length;c+=2)a.push([s.headers[c],s.headers[c+1]]);t(new ts(null,{status:s.statusCode,statusText:s.statusMessage,headers:new Headers(a)}))},Promise.resolve().then(async()=>{for(;;){let{data:s}=await An(r,"message",e.signal),a=s.subarray(),c=o.execute(a,0,a.byteLength);if(c instanceof Error)throw c;if(c<a.byteLength&&r.push(a.subarray(c)),i)break}}).catch(s=>{n(s)})})}async function*AN(r,e=[],t){let n=Jh.encode(crypto.getRandomValues(new Uint8Array(16))).substring(1);t.set("host",r.hostname),t.set("connection","upgrade"),t.set("upgrade","websocket"),t.set("pragma","no-cache"),t.set("cache-control","no-cache"),t.set("sec-websocket-version","13"),t.set("sec-websocket-key",n),e.length>0&&t.set("sec-websocket-protocol",e.join(", ")),yield R([`GET ${r.pathname??"/"} HTTP/1.1`,...[...t.entries()].map(([i,o])=>`${i}: ${o}`),"",""].join(`\r
`))}var JY=["BINARY","TEXT","CONTINUATION"],eQ=10485760;var tQ="/http/1.1",e5=class extends Ce{binaryType="arraybuffer";bufferedAmount=0;extensions="";protocol="";readyState;url;CONNECTING=0;OPEN=1;CLOSING=2;CLOSED=3;_onclose;_onerror;_onmessage;_onopen;sentClose;isClient;buffer;maxMessageSize;_url;closeController;constructor(e,t={}){super(),this.readyState=this.CONNECTING,this.url=e.pathname,this.sentClose=!1,this.isClient=t.isClient??!0,this.buffer=new oe,this.closeController=new AbortController,this.maxMessageSize=t.maxMessageSize??eQ}send(e){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");let t=EN(e);U2(t)?t.then(n=>{this._send("BINARY",n)}).catch(n=>{this._errored(n)}):this._send("BINARY",t)}_send(e,t){if(this.readyState!==this.OPEN)return;let n=vN(e,t,this.isClient),i=n.byteLength;this.bufferedAmount+=i,this._write(n,o=>{this.bufferedAmount-=i,o!=null&&this._errored(o)})}close(e,t){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");this.readyState=this.CLOSING,this.sentClose=!0,this._send("CONNECTION_CLOSE")}_errored(e){this.readyState=this.CLOSED,this.dispatchEvent(new J6(e))}set onclose(e){this._onclose=e,this.addEventListener("close",e)}get onclose(){return this._onclose??null}set onerror(e){this._onerror=e,this.addEventListener("error",e)}get onerror(){return this._onerror??null}set onmessage(e){this._onmessage=e,this.addEventListener("message",e)}get onmessage(){return this._onmessage??null}set onopen(e){this._onopen=e,this.addEventListener("open",e)}get onopen(){return this._onopen??null}_push(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxMessageSize){this.close(d1.MESSAGE_TOO_BIG,"Max message size exceeded");return}for(;;){let t=xN(this.buffer);if(t==null)break;if(JY.includes(t.type)&&t.data!=null){let n;this.binaryType==="blob"?n=new Blob([t.data]):t.data.byteOffset===0&&t.data.byteLength===t.data.buffer.byteLength?n=t.data.buffer:(n=new ArrayBuffer(t.data.byteLength),new Uint8Array(n,0,n.byteLength).set(t.data)),this.dispatchEvent(new MessageEvent("message",{data:n,origin:this._url?.hostname}))}t.type==="PING"&&this._send("PONG",t.data),t.type==="CONNECTION_CLOSE"&&(this.sentClose||this.close(),this.closeController.abort(),this._close(void 0,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new f1("close"))}))}}_remoteClosed(e){this.readyState=this.CLOSING,this._close(e,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new f1("close"))})}};var h1=class extends e5{writer;writable;constructor(e,t,n={}){if(super(new URL(e.url),{...n,isClient:!1}),e.body==null)throw new O("Request body cannot be null");this.readyState=this.OPEN,this.writable=t,this.writer=t.getWriter();let i=e.body.getReader();Promise.resolve().then(async()=>{for(this.dispatchEvent(new Event("open"));;){let{value:o,done:s}=await i.read();if(o!=null&&this._push(o),s){this._remoteClosed();break}}}).catch(o=>{this._errored(o)})}_write(e,t){this.writer?.write(e).then(()=>{t()},n=>{t(n)})}_close(e,t){e!=null?this.writable.abort(e).then(()=>{t()},()=>{t()}):this.writable.close().then(()=>{t()},()=>{t()})}},p1=class extends e5{stream;handshakeTimeout;drainTimeout;constructor(e,t,n,i){super(t,{...i,isClient:!0}),this.handshakeTimeout=i.handshakeTimeout??1e4,this.drainTimeout=i.drainTimeout??1e4,Promise.resolve().then(async()=>{let o=AbortSignal.timeout(this.handshakeTimeout);this.stream=await n.openStream(e,tQ,{...i,signal:o});for await(let a of AN(t,i.protocols,es(i)))this.stream.send(a)||await this.stream.onDrain({signal:o});let s=await SN(this.stream,{signal:o});if(s.status!==101)throw new Error("Invalid WebSocket handshake - response status "+s.status);await i.onHandshakeResponse?.(s,{signal:o}),this.protocol=s.headers.get("Sec-WebSocket-Protocol")??"",this.readyState=this.OPEN,this.dispatchEvent(new Event("open"));for await(let a of this.stream)this._push(a)}).catch(o=>{this._errored(o)})}_write(e,t){if(this.stream==null){t(new Error("WebSocket was not open"));return}this.stream.send(e)?t():this.stream.onDrain({signal:AbortSignal.timeout(this.drainTimeout)}).then(()=>{t()},n=>{t(n)})}_close(e,t){if(this.stream==null){t();return}if(e!=null){this.stream.abort(e),t();return}this.stream.close().catch(n=>{this.stream?.abort(n)}).finally(()=>{t()})}};var m1="/http/1.1";var t5=Symbol.for("@libp2p/http/websocket-handler");var kN=bt(TN(),1),n5=class{log;cookies;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:http:cookies"),this.cookies=new Map}async prepareRequest(e,t){if((t.credentials??"same-origin")==="omit")return;let i=t.headers.get("origin");if(i==null||i==="null")return;let o=l1(e,t.headers),s=(this.cookies.get(o.hostname)??[]).filter(a=>!(a.expires!=null&&a.expires<Date.now()||a.path!=null&&!o.pathname.startsWith(a.path))).map(a=>`${a.name}=${a.value}`).join("; ");s.length>0&&t.headers.set("cookie",s)}async processResponse(e,t,n){if((t.credentials??"same-origin")==="omit"){IN(n);return}let o=t.headers.get("origin");if(o==null||o==="null")return;let s=l1(e,t.headers);for(let a of n.headers.getSetCookie()){let c=[...this.cookies.get(s.hostname)??[],...dQ(kN.default.parse(a))];this.cookies.set(s.hostname,c)}IN(n)}};function IN(r){return r.headers.has("set-cookie")&&r.headers.delete("set-cookie"),r}function dQ(r){let e={},t=[];return Object.entries(r).forEach(([n,i])=>{n.toLowerCase()==="domain"&&i!=null&&(e.domain=i),n.toLowerCase()==="max-age"&&i!=null&&(e.expires=Date.now()+parseInt(i,10)*1e3),!hQ.includes(n.toLowerCase())&&i!=null&&t.push({name:n,value:i})}),t.map(n=>({...n,...e}))}var hQ=["domain","expires","httponly","max-age","partitioned","path","samesite","secure"];var i5=class{async prepareRequest(e,t){if(t.headers.get("origin")!=null||t.mode==="no-cors")return;let n=l1(e,t.headers);t.headers.set("origin",`${n.protocol}//${n.host}`)}};function pQ(r){return typeof r.init=="function"}function o5(r,e){if(pQ(r)){let t=r;return t.handler=r.init(e),delete t.init,t}return r}function PN(r){let e=Q6(r.method,["GET"]);if(r.fallback==null&&e.filter(n=>n!=="GET").length>0)throw new O("WebSocket handlers only support the GET HTTP method");let t={...r,init:n=>{let i=o5(r,n);return t[t5]=i.handler,async o=>{if(!W6(o.method,o.headers))return r?.fallback!=null?r.fallback(o):new ts(null,{status:400});let s=new TransformStream;try{let a=new ts(s.readable,{status:101,headers:await rE(o.headers)}),c=new h1(o,s.writable,r);return i.handler(c),a}catch{return new ts(null,{status:500})}}}};return t}var s5="/.well-known/libp2p/protocols";function RN(r){return PN({path:s5,method:["GET"],cors:!0,handler:e=>{let t=JSON.stringify(r.getProtocolMap());e.send(t),e.close()},fallback:async e=>{let t=JSON.stringify(r.getProtocolMap());return new Response(t,{headers:{"Content-Type":"application/json","Content-Length":`${t.length}`}})}})}var a5=class{log;components;protocols;endpoint;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http:registrar"),this.protocols=[],this.onStream=this.onStream.bind(this),this.endpoint=t.server,this.handle("",RN(this))}async start(){await this.components.registrar.handle(m1,this.onStream.bind(this))}async stop(){await this.components.registrar.unhandle(m1)}async onStream(e,t){let n=await uN(e);if(this.canHandle(n)){this.log("handling incoming request %s %s",n.method,n.url);let i=await this.onRequest(aN(n,e));await cN(i,e),await e.close();return}if(this.endpoint==null){this.log("cannot handle incoming request %s %s and no endpoint configured",n.method,n.url),e.send(lN),await e.close();return}this.log("passing incoming request %s %s to endpoint",n.method,n.url),this.endpoint.inject(n,e,t).catch(i=>{this.log.error("error injecting request to endpoint - %e",i),e.abort(i)})}canHandle(e){let t=tE(e).pathname;return this.protocols.find(n=>n.route.path===t)!=null?(this.log.trace("can handle %s",t),!0):(this.log.trace("cannot handle %s",t),!1)}async onRequest(e){this.log("incoming request %s %s",e.method,e.url);let t=this.findHandler(e.url);if(t==null)return new Response(null,{status:404});let n;return t.route.method.includes(e.method)?n=await t.route.handler(e):e.method==="OPTIONS"?n=new Response(null,{status:204}):n=new Response(null,{status:405}),mQ(n,e,t),this.log("%s %s %d %s",e.method,e.url,n.status,n.statusText),n}onWebSocket(e){let t=this.findHandler(e.url);if(t!=null){let n=t.route[t5];if(n!=null){n(e);return}}e.close(d1.NORMAL_CLOSURE)}findHandler(e){let t=e.startsWith("/")?e:new URL(e).pathname;this.log("search for handler on path %s",t);let n=this.protocols.find(i=>i.route.path===t);return n!=null&&this.log("found handler for HTTP protocol %s on path %s",n.protocol,e),n}handle(e,t){if(t.path=t.path??e,this.protocols.find(n=>n.protocol===e)!=null)throw new O(`HTTP protocol handler for ${e} already registered`);(t.path===""||!t.path.startsWith("/"))&&(t.path=`/${t.path}`),t.cors=t.cors??!0,t.method=Q6(t.method),t=o5(t,this.components),this.protocols.push({protocol:e,route:t}),this.protocols.sort(({route:{path:n}},{route:{path:i}})=>i.length-n.length)}unhandle(e){this.protocols=this.protocols.filter(t=>t.protocol===e)}getProtocolMap(){let e={};for(let t of this.protocols)t.protocol!==""&&(e[t.protocol]={path:t.route.path});return e}};function mQ(r,e,t){let n=[...new Set(["OPTIONS",...t.route.method])].join(", ");t.route.cors&&(e.headers.get("Access-Control-Request-Method")!=null&&r.headers.set("access-control-allow-methods",n),e.headers.get("Access-Control-Request-Headers")!=null&&r.headers.set("access-control-allow-headers",e.headers.get("Access-Control-Request-Headers")??""),e.headers.get("Origin")!=null&&(r.headers.set("access-control-allow-origin",e.headers.get("Origin")??""),r.headers.set("vary","Origin"))),e.method==="OPTIONS"&&r.headers.set("allow",n)}async function DN(r,e,t){for(let n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function ON(r,e,t){for(let n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function NN(r,e,t){for(let n of e.middleware)await n.processResponse?.(r,e,t);return t}var c5=class{log;components;httpRegistrar;origin;cookies;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http"),this.httpRegistrar=new a5(e,t),this.origin=new i5,this.cookies=new n5(e,t)}[Symbol.toStringTag]="@libp2p/http";[Ge]=["@libp2p/http"];async start(){await wr(this.httpRegistrar)}async stop(){await Cr(this.httpRegistrar)}agent(...e){throw new jh("This method is not supported in browsers")}dispatcher(...e){throw new jh("This method is not supported in browsers")}async connect(e,t={}){let n=Ld(e),i=es(t),o={...t,headers:i,method:"GET",middleware:t.middleware?.map(s=>s(this.components))??[]};return i.set("connection","upgrade"),i.set("upgrade","websocket"),ON(n,o,async()=>{if(n instanceof URL){let c=new globalThis.WebSocket(n,t.protocols);return c.binaryType="arraybuffer",c}let{addresses:s,httpPath:a}=Y6(n);return new p1(s,new URL(`http://${X6(n,o.headers)}${decodeURIComponent(a)}`),this.components.connectionManager,o)})}async fetch(e,t={}){let n=Ld(e),i={...t,headers:es(t),method:"GET",middleware:[this.origin,this.cookies,...t.middleware?.map(s=>s(this.components))??[]]},o=await DN(n,i,async()=>this.sendRequest(n,t));return NN(n,i,o)}async connectProtocol(e,t,n){let i=await this.getProtocolPath(e,t,n),o=Ld(e,i);return this.connect(o,n)}async fetchProtocol(e,t,n={}){let i=await this.getProtocolPath(e,t,n),o=Ld(e,i);return this.fetch(o,n)}async getSupportedProtocols(e,t={}){let n=Ld(e,s5),i=await this.fetch(n,{method:"GET",headers:{Accept:"application/json"},signal:t.signal});if(i.status!==200)throw new Error(`Unexpected status code: ${i.status}`);return i.json()}async getProtocolPath(e,t,n={}){let i=await this.getSupportedProtocols(e,n);if(i[t]==null)throw new Error(`Peer does not serve protocol: ${t}`);return i[t].path}canHandle(e){return this.httpRegistrar.canHandle(e)}async onRequest(e){return this.httpRegistrar.onRequest(e)}onWebSocket(e){this.httpRegistrar.onWebSocket(e)}handle(e,t){this.httpRegistrar.handle(e,t)}unhandle(e){this.httpRegistrar.unhandle(e)}getProtocolMap(){return this.httpRegistrar.getProtocolMap()}async sendRequest(e,t){if(e instanceof URL)return this.log("making request to %s with global fetch"),globalThis.fetch(e,t);this.log("making request to %s with libp2p fetch",e);let n=X6(e,es(t)),{addresses:i,httpPath:o}=Y6(e),a=await(await this.components.connectionManager.openConnection(i,{signal:t.signal??void 0})).newStream(m1,{signal:t.signal??void 0});return wN(a,new URL(`http://${n}${decodeURIComponent(o)}`),t)}};function l5(r={}){return e=>new c5(e,r)}var LN="0.1.0";var BN="id/push",MN="1.0.0",UN="1.0.0";var cc;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let o of t.listenAddrs)n.uint32(18),n.bytes(o);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let o of t.protocols)n.uint32(26),n.string(o);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{let o={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 5:{o.protocolVersion=t.string();break}case 6:{o.agentVersion=t.string();break}case 1:{o.publicKey=t.bytes();break}case 2:{if(i.limits?.listenAddrs!=null&&o.listenAddrs.length===i.limits.listenAddrs)throw new yt('Decode error - map field "listenAddrs" had too many elements');o.listenAddrs.push(t.bytes());break}case 4:{o.observedAddr=t.bytes();break}case 3:{if(i.limits?.protocols!=null&&o.protocols.length===i.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');o.protocols.push(t.string());break}case 8:{o.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return o})),e),r.encode=t=>be(t,r.codec()),r.decode=(t,n)=>xe(t,r.codec(),n)})(cc||(cc={}));var Vn={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:32};function FN(r){if(r!=null&&r.length>0)try{return se(r)}catch{}}async function u5(r,e,t,n,i){if(t("received identify from %p",n.remotePeer),i==null)throw new Ue("message was null or undefined");let o={};if(i.listenAddrs.length>0&&(o.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:se(c)}))),i.protocols.length>0&&(o.protocols=i.protocols),i.publicKey!=null){let c=er(i.publicKey);if(!Wo(c).equals(n.remotePeer))throw new Ue("public key did not match remote PeerId");o.publicKey=c}let s;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=i.signedPeerRecord,l=await hi.openAndCertify(c,Tn.DOMAIN),u=Tn.createFromProtobuf(l.payload),f=En(l.publicKey.toCID());if(!u.peerId.equals(f))throw new Ue("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new Ue("signing key does not match remote PeerId");let h;try{h=await r.get(u.peerId)}catch(d){if(d.name!=="NotFoundError")throw d}if(h!=null&&(o.metadata=h.metadata,h.peerRecordEnvelope!=null)){let d=hi.createFromProtobuf(h.peerRecordEnvelope),m=Tn.createFromProtobuf(d.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=h.peerRecordEnvelope)}o.peerRecordEnvelope=c,o.addresses=u.multiaddrs.map(d=>({isCertified:!0,multiaddr:d})),s={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,o),await r.patch(n.remotePeer,o),i.agentVersion!=null||i.protocolVersion!=null){let c={};i.agentVersion!=null&&(c.AgentVersion=R(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=R(i.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>se(c)),observedAddr:i.observedAddr==null?void 0:se(i.observedAddr),protocols:i.protocols,signedPeerRecord:s,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var Bd=class{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??Vn.timeout,this.maxInboundStreams=t.maxInboundStreams??Vn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Vn.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Vn.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Vn.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Vn.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Vn.protocolPrefix}/${LN}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:R(this.host.agentVersion),ProtocolVersion:R(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}};var f5=class extends Bd{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Vn.protocolPrefix}/${BN}/${UN}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Vn.concurrency,this._push=Ls(this.sendPushMessage.bind(this),t.debounce??1e3),(t.runOnSelfUpdate??Vn.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(i=>{this.log.error("error pushing updates to peers - %e",i)})})}[Ge]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{let e=this.components.addressManager.getAddresses().map(u=>u.decapsulateCode(421)),t=new Tn({peerId:this.components.peerId,multiaddrs:e}),n=await hi.seal(t,this.components.privateKey),i=this.components.registrar.getProtocols(),o=await this.components.peerStore.get(this.components.peerId),s=K(o.metadata.get("AgentVersion")??R(this.host.agentVersion)),a=K(o.metadata.get("ProtocolVersion")??R(this.host.protocolVersion)),c=this;async function*l(){for(let u of c.connectionManager.getConnections())(await c.components.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let h,d=AbortSignal.timeout(c.timeout);try{h=await u.newStream(c.protocol,{signal:d,runOnLimitedConnection:c.runOnLimitedConnection}),await Tt(h,{maxDataLength:c.maxMessageSize}).pb(cc).write({listenAddrs:e.map(y=>y.bytes),signedPeerRecord:n.marshal(),protocols:i,agentVersion:s,protocolVersion:a},{signal:d}),await h.close({signal:d})}catch(m){h?.log.newScope("identify-push")?.error("could not push identify update to peer",m),h?.abort(m)}})}await ln(vn(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e,t){let n=e.log.newScope("identify-push");if(this.components.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let i={signal:AbortSignal.timeout(this.timeout)},s=await Tt(e,{maxDataLength:this.maxMessageSize}).pb(cc).read(i);await e.close(i),await u5(this.components.peerStore,this.components.events,n,t,s),n.trace("handled push from %p",t.remotePeer)}};var d5=class extends Bd{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Vn.protocolPrefix}/${"id"}/${MN}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Vn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let i=n.detail;this.identify(i).catch(()=>{})})}[Ge]=["@libp2p/identify"];async _identify(e,t={}){let n,i;if(t.signal==null){let o=AbortSignal.timeout(this.timeout);t={...t,signal:o}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),i=n.log.newScope("identify");let o=Tt(n,{maxDataLength:this.maxMessageSize}).pb(cc),s=await o.read(t);return await o.unwrap().unwrap().close(t),s}catch(o){throw i?.error("identify failed - %e",o),n?.abort(o),o}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:i,protocols:o,observedAddr:s}=n;if(i==null)throw new Ue("Public key was missing from identify message");let a=er(i),c=En(a.toCID());if(!e.remotePeer.equals(c))throw new Ue("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new Ue("Identified peer is our own peer id?");return this.maybeAddObservedAddress(s),this.log("completed for peer %p and protocols %o",c,o),u5(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){let t=FN(e);if(t==null||(this.log.trace("our observed address was %a",t),qt(t)))return;let n=t.getComponents();if((n[0].code===41||n[0].code===42&&n[1].code===41)&&!k2(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Il.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){let n=e.log.newScope("identify");n("responding to identify");let i=AbortSignal.timeout(this.timeout);let o=await this.components.peerStore.get(this.components.peerId,{signal:i}),s=this.components.addressManager.getAddresses().map(u=>u.decapsulateCode(421)),a=o.peerRecordEnvelope;if(s.length>0&&a==null){let u=new Tn({peerId:this.components.peerId,multiaddrs:s});a=(await hi.seal(u,this.components.privateKey,{signal:i})).marshal().subarray()}let c=t.remoteAddr.bytes;Ek.matches(t.remoteAddr)||(c=void 0);let l=Tt(e).pb(cc);n("send response"),await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:ar(this.components.privateKey.publicKey),listenAddrs:s.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:o.protocols},{signal:i}),n("close write"),await l.unwrap().unwrap().close({signal:i})}};function $N(r={}){return e=>new d5(e,r)}function HN(r={}){return e=>new f5(e,r)}var ft;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(ft||(ft={}));var g1=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),oE=Object.freeze({NEW_STREAM:ft.NEW_STREAM,MESSAGE:ft.MESSAGE_INITIATOR,CLOSE:ft.CLOSE_INITIATOR,RESET:ft.RESET_INITIATOR}),VN=Object.freeze({MESSAGE:ft.MESSAGE_RECEIVER,CLOSE:ft.CLOSE_RECEIVER,RESET:ft.RESET_RECEIVER});var y1=1<<20,sE=4<<20,h5=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=y1,t=sE){this._buffer=new oe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Ue("Unprocessed message queue size too large!");let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}let{id:n,type:i,length:o,offset:s}=this._headerInfo;if(this._buffer.length-s<o)break;let c={id:n,type:i};(i===ft.NEW_STREAM||i===ft.MESSAGE_INITIATOR||i===ft.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(s,s+o)),t.push(c),this._buffer.consume(s+o),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=KN(e),{value:i,offset:o}=KN(e,n),s=t&7;if(g1[s]==null)throw new Error(`Invalid type received: ${s}`);if(i>this._maxMessageSize)throw new Ue("Message size too large");return{id:t>>3,type:s,offset:n+o,length:i}}},bQ=128,zN=127;function KN(r,e=0){let t=0,n=0,i=e,o,s=r.length;do{if(i>=s||n>49)throw e=0,new RangeError("Could not decode varint");o=r.get(i++),t+=n<28?(o&zN)<<n:(o&zN)*Math.pow(2,n),n+=7}while(o>=bQ);return e=i-e,{value:t,offset:e}}var aE=10*1024,cE=class{_pool;_poolOffset;constructor(){this._pool=Ft(aE),this._poolOffset=0}write(e,t){let n=this._pool,i=this._poolOffset;sn(e.id<<3|e.type,n,i),i+=Ke(e.id<<3|e.type),(e.type===ft.NEW_STREAM||e.type===ft.MESSAGE_INITIATOR||e.type===ft.MESSAGE_RECEIVER)&&e.data!=null?(sn(e.data.length,n,i),i+=Ke(e.data.length)):(sn(0,n,i),i+=Ke(0));let o=n.subarray(this._poolOffset,i);aE-i<100?(this._pool=Ft(aE),this._poolOffset=0):this._poolOffset=i,t.append(o),(e.type===ft.NEW_STREAM||e.type===ft.MESSAGE_INITIATOR||e.type===ft.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},vQ=new cE;function w1(r){let e=new oe;return vQ.write(r,e),e}var lE=class extends Ha{streamId;types;maxDataSize;muxer;constructor(e){super(e),this.types=e.direction==="outbound"?oE:VN,this.maxDataSize=e.maxDataSize,this.muxer=e.muxer,this.streamId=parseInt(this.id.substring(1)),e.direction==="outbound"&&queueMicrotask(()=>{this.muxer.send(w1({id:this.streamId,type:oE.NEW_STREAM,data:new oe(R(this.id))}))})}sendData(e){let t=new oe,n=e.byteLength;for(;e.byteLength>0;){let i=Math.min(e.byteLength,this.maxDataSize),o=e.sublist(0,i);e=e.sublist(i),t.append(w1({id:this.streamId,type:this.types.MESSAGE,data:o}))}return{sentBytes:n,canSendMore:this.muxer.send(t)}}sendReset(){return this.muxer.send(w1({id:this.streamId,type:this.types.RESET}))}async sendCloseWrite(e){this.muxer.send(w1({id:this.streamId,type:this.types.CLOSE})),e?.signal?.throwIfAborted()}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}};function qN(r){let{id:e,muxer:t,direction:n,maxMsgSize:i=y1}=r;return new lE({...r,id:n==="outbound"?`i${e}`:`r${e}`,direction:n,maxDataSize:i,muxer:t,log:r.log.newScope(`${n}:${e}`),protocol:""})}var EQ=5;function SQ(r){let e={...r,type:`${g1[r.type]} (${r.type})`};return r.type===ft.NEW_STREAM&&(e.data=K(r.data.subarray())),(r.type===ft.MESSAGE_INITIATOR||r.type===ft.MESSAGE_RECEIVER)&&(e.data=K(r.data.subarray(),"base16")),e}var p5=class extends $a{_streamId;rateLimiter;maxMessageSize;maxUnprocessedMessageQueueSize;decoder;constructor(e,t){super(e,{...t,protocol:"/mplex/6.7.0",name:"mplex"}),this._streamId=0,this.maxMessageSize=t.maxMessageSize??y1,this.maxUnprocessedMessageQueueSize=t.maxUnprocessedMessageQueueSize??sE,this.decoder=new h5(this.maxMessageSize,this.maxUnprocessedMessageQueueSize),this.rateLimiter=new Xf({points:t.disconnectThreshold??EQ,duration:1})}onData(e){for(let t of this.decoder.write(e))this.handleMessage(t)}onCreateStream(e){if(this.status!=="open")throw new Xi("Muxer already closed");let t=this._streamId++;return this._newStream(t,"outbound",e)}_newStream(e,t,n){return this.log("new %s stream %s",t,e),qN({...n,id:e,direction:t,maxMsgSize:this.maxMessageSize,log:this.log,muxer:this})}handleMessage(e){if(this.log.enabled&&this.log.trace("incoming message",SQ(e)),e.type===ft.NEW_STREAM){try{this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}let i=this._newStream(e.id,"inbound",this.streamOptions);this.onRemoteStream(i);return}let t=`${(e.type&1)===1?"i":"r"}${e.id}`,n=this.streams.find(i=>i.id===t);if(n==null){this.log("missing stream %s for message type %s",t,g1[e.type]);try{this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}try{switch(e.type){case ft.MESSAGE_INITIATOR:case ft.MESSAGE_RECEIVER:n.onData(e.data);break;case ft.CLOSE_INITIATOR:case ft.CLOSE_RECEIVER:n.onRemoteCloseWrite();break;case ft.RESET_INITIATOR:case ft.RESET_RECEIVER:n.onRemoteReset();break;default:this.log("unknown message type")}}catch(i){this.log.error("error while processing message - %e",i),n.abort(i)}}};var uE=class{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@libp2p/mplex";[Ge]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new p5(e,{...this._init})}};function jN(r={}){return()=>new uE(r)}var WN="1.0.0",GN="ping",XN="ipfs";var m5=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??XN}/${GN}/${WN}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handlePing=this.handlePing.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[Ge]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handlePing,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async handlePing(e,t){let n=e.log.newScope("ping");n.trace("ping from %p",t.remotePeer);let i=AbortSignal.timeout(this.timeout);i.addEventListener("abort",()=>{e.abort(new Lo("Ping timed out"))});let o=Date.now();for await(let s of e){if(e.status!=="open"){n("stream status changed to %s",e.status);break}e.send(s)||(n("waiting for stream to drain"),await st(e,"drain",{rejectionEvents:["close"],signal:i}),n("stream drained"))}n("ping from %p complete in %dms",t.remotePeer,Date.now()-o),await e.close({signal:i})}async ping(e,t={}){let n=wn(32),i=await this.components.connectionManager.openStream(e,this.protocol,{runOnLimitedConnection:this.runOnLimitedConnection,...t}),o=i.log.newScope("ping");try{let s=Date.now(),a=Promise.withResolvers(),c=new oe,l=u=>{if(c.append(u.data),c.byteLength===32){i.removeEventListener("message",l);let f=Date.now()-s;Promise.all([i.closeRead(t)]).then(()=>{if(me(n,c.subarray()))a.resolve(f);else throw new Kc(`Received wrong ping ack after ${f}ms`)}).catch(h=>{i.abort(h),a.reject(h)})}};return i.addEventListener("message",l),i.send(n),await i.close(t),await Et(a.promise,t.signal)}catch(s){throw o.error("error while pinging %o - %e",e,s),i?.abort(s),s}finally{i?.close()}}};function QN(r={}){return e=>new m5(e,r)}var pn;(function(r){let e;(function(i){i.FIN="FIN",i.STOP_SENDING="STOP_SENDING",i.RESET="RESET",i.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(i){i[i.FIN=0]="FIN",i[i.STOP_SENDING=1]="STOP_SENDING",i[i.RESET=2]="RESET",i[i.FIN_ACK=3]="FIN_ACK"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.flag!=null&&(o.uint32(8),r.Flag.codec().encode(i.flag,o)),i.message!=null&&(o.uint32(18),o.bytes(i.message)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.flag=r.Flag.codec().decode(i);break}case 2:{a.message=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(pn||(pn={}));var ZN=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],fE=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),JN="libp2p+webrtc+v1/",eL=2*1024*1024,Md=16*1024;function TQ(r=Md){let e=Ke(r-Ke(r)),t=1+Ke(Object.keys(pn.Flag).length-1),n=1,i=r-e-t-n,o=Ke(i);return e+t+n+o}var tL=TQ();var rL=1e4,dE="/webrtc",x1="/webrtc-signaling/0.0.1",nL="/libp2p/webrtc-direct/certificate",iL="webrtc-direct-certificate-private-key";var oL=12096e5,hE=864e5;var sL=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,o;n<i;n++)(o||!(n in e))&&(o||(o=Array.prototype.slice.call(e,0,n)),o[n]=e[n]);return r.concat(o||Array.prototype.slice.call(e))},IQ=(function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r})();var kQ=(function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r})();var PQ=(function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r})();var RQ=(function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r})();var DQ=(function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r})();var OQ=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,NQ=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,aL=3,LQ=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",OQ]],cL=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function uL(r){return r?lL(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new DQ:typeof navigator<"u"?lL(navigator.userAgent):UQ()}function BQ(r){return r!==""&&LQ.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var o=i.exec(r);return!!o&&[n,o]},!1)}function lL(r){var e=BQ(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new RQ;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<aL&&(i=sL(sL([],i,!0),FQ(aL-i.length),!0)):i=[];var o=i.join("."),s=MQ(r),a=NQ.exec(r);return a&&a[1]?new PQ(t,o,s,a[1]):new IQ(t,o,s)}function MQ(r){for(var e=0,t=cL.length;e<t;e++){var n=cL[e],i=n[0],o=n[1],s=o.exec(r);if(s)return i}return null}function UQ(){var r=typeof process<"u"&&process.version;return r?new kQ(process.version.slice(1)):null}function FQ(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var fL=uL(),g5=fL!=null&&fL.name==="firefox";async function pE(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??ZN.map(e=>({urls:[e]})),r}var dL=(r=32)=>JN+[...Array(r)].map(()=>fE.at(Math.floor(Math.random()*fE.length))).join("");var mE=class extends Ha{channel;incomingData;maxBufferedAmount;receivedFinAck;finAckTimeout;constructor(e){super({...e,maxMessageSize:(e.maxMessageSize??Md)-tL}),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=xr(),this.maxBufferedAmount=e.maxBufferedAmount??eL,this.finAckTimeout=e.finAckTimeout??rL,this.channel.onclose=()=>{this.log.trace("received datachannel close event"),this.onRemoteCloseWrite(),this.onTransportClosed()},this.channel.onerror=n=>{let i=n.error;this.log.trace("received datachannel error event - %e",i),this.abort(i)},this.channel.onmessage=async n=>{this.log("incoming message %d bytes",n.data.byteLength);let{data:i}=n;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))},this.channel.bufferedAmountLowThreshold=0,this.channel.onbufferedamountlow=()=>{this.writableNeedsDrain&&this.safeDispatchEvent("drain")},Promise.resolve().then(async()=>{for await(let n of Cl(this.incomingData))this.processIncomingProtobuf(n)}).catch(n=>{this.log.error("error processing incoming data channel messages - %e",n)});let t=()=>{this.channel.readyState==="open"&&(this.log.trace("stream closed, closing underlying datachannel"),this.channel.close())};this.addEventListener("close",t),this.channel.readyState!=="open"&&(this.log('channel ready state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),st(this.channel,"open",{rejectionEvents:["close","error"]}).then(()=>{this.log('channel ready state is now "%s", dispatching drain',this.channel.readyState),this.safeDispatchEvent("drain")}).catch(n=>{this.abort(n.error??n)}))}sendNewStream(){}_sendMessage(e){if(this.channel.readyState!=="open")throw new Oo(`Invalid datachannel state - ${this.channel.readyState}`);if(this.log.trace('sending message, channel state "%s"',this.channel.readyState),g5){this.channel.send(e.subarray());return}for(let t of e)this.channel.send(t)}sendData(e){return this.channel.readyState!=="open"?{sentBytes:0,canSendMore:!1}:(this._sendMessage($s.single(pn.encode({message:e.subarray()}))),{sentBytes:e.byteLength,canSendMore:this.channel.bufferedAmount<this.maxBufferedAmount})}sendReset(e){try{this.log.error("sending reset - %e",e),this._sendFlag(pn.Flag.RESET),this.receivedFinAck?.reject(e)}catch(t){this.log.error("failed to send reset - %e",t)}}async sendCloseWrite(e){this._sendFlag(pn.Flag.FIN),e?.signal?.throwIfAborted(),this.receivedFinAck=Promise.withResolvers();let t=e?.signal??AbortSignal.timeout(this.finAckTimeout),n=[st(this.channel,"close",{signal:t}),st(this.channel,"error",{signal:t})];await Promise.any([Et(this.receivedFinAck.promise,t),...n]).finally(()=>{n.forEach(i=>i.cancel())})}async sendCloseRead(e){this._sendFlag(pn.Flag.STOP_SENDING),e?.signal?.throwIfAborted()}processIncomingProtobuf(e){let t=pn.decode(e);t.message!=null&&(this.readStatus==="readable"||this.readStatus==="paused")&&this.onData(new oe(t.message)),t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===pn.Flag.FIN&&(this._sendFlag(pn.Flag.FIN_ACK),this.onRemoteCloseWrite()),t.flag===pn.Flag.RESET&&(this.receivedFinAck?.reject(new tf("The stream was reset")),this.onRemoteReset()),t.flag===pn.Flag.STOP_SENDING&&this.onRemoteCloseRead(),t.flag===pn.Flag.FIN_ACK&&this.receivedFinAck?.resolve())}_sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());let t=pn.encode({flag:e}),n=$s.single(t);try{return this._sendMessage(n),!0}catch(i){this.log.error("could not send flag %s - %e",e.toString(),i)}return!1}sendPause(){}sendResume(){}};function b1(r){let{channel:e,direction:t,isHandshake:n}=r;return new mE({...r,id:`${e.id}`,log:r.log.newScope(`${n===!0?"handshake":t}:${e.id}`),protocol:""})}var lc=class{protocol;peerConnection;metrics;dataChannelOptions;earlyDataChannels;constructor(e){this.onEarlyDataChannel=this.onEarlyDataChannel.bind(this),this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??dE,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.addEventListener("datachannel",this.onEarlyDataChannel),this.earlyDataChannels=[]}onEarlyDataChannel(e){this.earlyDataChannels.push(e.channel)}createStreamMuxer(e){return this.peerConnection.removeEventListener("datachannel",this.onEarlyDataChannel),new gE(e,{peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,protocol:this.protocol,earlyDataChannels:this.earlyDataChannels})}},gE=class extends $a{peerConnection;dataChannelOptions;constructor(e,t){super(e,{...t,name:"muxer"}),this.peerConnection=t.peerConnection,this.protocol=t.protocol??dE,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{this.onDataChannel(n)},queueMicrotask(()=>{if(this.status!=="open"){t.earlyDataChannels.forEach(n=>{n.close()});return}t.earlyDataChannels.forEach(n=>{this.onDataChannel(n)})})}onDataChannel(e){if(this.log("incoming datachannel with channel id %d, protocol %s and status %s",e.id,e.protocol,e.readyState),e.label==="init"){this.log.trace("closing init channel %d",e.id),e.close();return}let t=b1({...this.streamOptions,...this.dataChannelOptions,channel:e,direction:"inbound",log:this.log});this.onRemoteStream(t)}async onCreateStream(e){let t=this.peerConnection.createDataChannel("",{});return this.log("open channel %d for protocol %s",t.id,e?.protocol),b1({...e,...this.dataChannelOptions,channel:t,direction:"outbound",log:this.log})}onData(){}};var yE=class extends Fa{peerConnection;constructor(e){super(e),this.peerConnection=e.peerConnection;let t=e.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change %s initial state %s",this.peerConnection.connectionState,t),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.onTransportClosed(),this.peerConnection.close())}}sendData(e){return{sentBytes:e.byteLength,canSendMore:!0}}async sendClose(e){this.peerConnection.close(),e?.signal?.throwIfAborted()}sendReset(){this.peerConnection.close()}sendPause(){}sendResume(){}},v1=r=>new yE(r);var y5=globalThis.RTCPeerConnection,w5=globalThis.RTCSessionDescription,hL=globalThis.RTCIceCandidate;var uc=class extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}},Ui=class extends uc{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}};var x5=class extends uc{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}};var b5=class extends uc{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}},v5=class extends uc{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}};var zn;(function(r){let e;(function(i){i.SDP_OFFER="SDP_OFFER",i.SDP_ANSWER="SDP_ANSWER",i.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(i){i[i.SDP_OFFER=0]="SDP_OFFER",i[i.SDP_ANSWER=1]="SDP_ANSWER",i[i.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{s.lengthDelimited!==!1&&o.fork(),i.type!=null&&(o.uint32(8),r.Type.codec().encode(i.type,o)),i.data!=null&&(o.uint32(18),o.string(i.data)),s.lengthDelimited!==!1&&o.ldelim()},(i,o,s={})=>{let a={},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(i);break}case 2:{a.data=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>be(i,r.codec()),r.decode=(i,o)=>xe(i,r.codec(),o)})(zn||(zn={}));var E5=async(r,e,t)=>{try{let n=Promise.withResolvers();for($Q(r,n);;){let i=await Promise.race([n.promise,e.read({signal:t.signal})]);if(i==null){t.signal?.throwIfAborted();break}if(i.type!==zn.Type.ICE_CANDIDATE)throw new Ue("ICE candidate message expected");let o=JSON.parse(i.data??"null");if(o===""||o===null){t.onProgress?.(new G("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let s=new hL(o);t.log.trace("%s received new ICE candidate %o",t.direction,o);try{t.onProgress?.(new G("webrtc:add-ice-candidate",s.candidate)),await r.addIceCandidate(s)}catch(a){t.log.error("%s bad candidate received %o - %e",t.direction,o,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate - %e",t.direction,n),t.signal?.aborted===!0&&r.connectionState!=="connected")throw n}};function $Q(r,e){if(r.connectionState==="connected"){e.resolve();return}r.onconnectionstatechange=t=>{switch(r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new ef(`RTCPeerConnection connection state became "${r.connectionState}"`));break;default:break}}}function S5(r){let e;for(let t of r.getComponents())t.name==="p2p"&&(e=tt(t.value??""));if(e==null)throw new No("Remote peerId must be present in multiaddr");return e}async function pL({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:i,connectionManager:o,transportManager:s,log:a,logger:c,onProgress:l}){let{circuitAddress:u,targetPeer:f}=mL(i);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);let h=o.getConnections(f),d;h.length===0?(l?.(new G("webrtc:dial-relay")),d=await s.dial(u,{signal:t,onProgress:l})):(l?.(new G("webrtc:reuse-relay-connection")),d=h[0]),l?.(new G("webrtc:open-signaling-stream"));let m=await d.newStream(x1,{signal:t,runOnLimitedConnection:!0}),y=Tt(m).pb(zn),w=new y5(r);w.addEventListener("connectionstatechange",()=>{switch(w.connectionState){case"closed":w.close();break;default:break}});let x=new lc({peerConnection:w,dataChannelOptions:e});try{let v=w.createDataChannel("init");w.onicecandidate=({candidate:H})=>{if(w.connectionState==="connected"){a.trace("ignore new ice candidate as peer connection is already connected");return}if(H==null||H?.candidate===""){a.trace("initiator detected end of ICE candidates");return}let U=JSON.stringify(H?.toJSON()??null);a.trace("initiator sending ICE candidate %o",H),y.write({type:zn.Type.ICE_CANDIDATE,data:U},{signal:t}).catch(C=>{a.error("error sending ICE candidate - %e",C)})},w.onicecandidateerror=H=>{a.error("initiator ICE candidate error",H)};let E=await w.createOffer().catch(H=>{throw a.error("could not execute createOffer - %e",H),new Ui("Failed to set createOffer")});a.trace("initiator send SDP offer %s",E.sdp),l?.(new G("webrtc:send-sdp-offer")),await y.write({type:zn.Type.SDP_OFFER,data:E.sdp},{signal:t}),await w.setLocalDescription(E).catch(H=>{throw a.error("could not execute setLocalDescription - %e",H),new Ui("Failed to set localDescription")}),l?.(new G("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");let _=await y.read({signal:t});if(_.type!==zn.Type.SDP_ANSWER)throw new Ui("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",_.data);let B=new w5({type:"answer",sdp:_.data});return await w.setRemoteDescription(B).catch(H=>{throw a.error("could not execute setRemoteDescription - %e",H),new Ui("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new G("webrtc:read-ice-candidates")),await E5(w,y,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected"),v.readyState!=="open"&&(a.trace("wait for init channel to open"),await st(v,"open",{signal:t})),a.trace("closing init channel"),v.close(),a.trace("waiting for init channel to close"),await st(v,"close",{signal:t}),l?.(new G("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:w,muxerFactory:x}}catch(v){throw a.error("outgoing signaling error - %e",v),w.close(),m.abort(v),v}finally{w.onicecandidate=null,w.onicecandidateerror=null}}var gL=mt(Yf.matchers[0],pt(290)),A5=class r extends Ce{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>gL.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r)).map(e=>e.getAddrs().filter(t=>gL.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}};async function yL(r,e,{peerConnection:t,signal:n,log:i}){i.trace("new inbound signaling stream");let o=Tt(r).pb(zn);try{t.onicecandidate=({candidate:f})=>{if(t.connectionState==="connected"){i.trace("ignore new ice candidate as peer connection is already connected");return}if(f==null||f?.candidate===""){i.trace("recipient detected end of ICE candidates");return}let h=JSON.stringify(f?.toJSON()??null);i.trace("recipient sending ICE candidate %s",h),o.write({type:zn.Type.ICE_CANDIDATE,data:h},{signal:n}).catch(d=>{i.error("error sending ICE candidate - %e",d)})},i.trace("recipient read SDP offer");let c=await o.read({signal:n});if(c.type!==zn.Type.SDP_OFFER)throw new Ui(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `);i.trace("recipient received SDP offer %s",c.data);let l=new w5({type:"offer",sdp:c.data});await t.setRemoteDescription(l).catch(f=>{throw i.error("could not execute setRemoteDescription - %e",f),new Ui("Failed to set remoteDescription")});let u=await t.createAnswer().catch(f=>{throw i.error("could not execute createAnswer - %e",f),new Ui("Failed to create answer")});i.trace("recipient send SDP answer %s",u.sdp),await o.write({type:zn.Type.SDP_ANSWER,data:u.sdp},{signal:n}),await t.setLocalDescription(u).catch(f=>{throw i.error("could not execute setLocalDescription - %e",f),new Ui("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await E5(t,o,{direction:"recipient",signal:n,log:i})}catch(c){if(t.connectionState!=="connected")throw i.error("error while handling signaling stream from peer %a - %e",e.remoteAddr,c),t.close(),c;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",e.remoteAddr,c)}let s=S5(e.remoteAddr),a=se(`/webrtc/p2p/${s}`);return i.trace("recipient connected to remote address %s",a),{remoteAddress:a,remotePeer:s}}var _5=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[Ea]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[Ge]=["@libp2p/transport"];[ni]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(x1,(e,t)=>{let n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t,n).catch(i=>{this.log.error("failed to handle incoming connect from %p - %e",t.remotePeer,i)}).finally(()=>{n.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(x1),this._started=!1}createListener(e){return new A5(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Zp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:i,muxerFactory:o}=await pL({rtcConfiguration:await pE(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=v1({peerConnection:i,remoteAddr:n,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,remotePeer:S5(e),muxerFactory:o,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,s),a}async _onProtocol(e,t,n){let i=new y5(await pE(this.init.rtcConfiguration));i.addEventListener("connectionstatechange",()=>{switch(i.connectionState){case"closed":i.close();break;default:break}});let o=new lc({peerConnection:i,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s,remotePeer:a}=await yL(e,t,{peerConnection:i,signal:n,log:this.log});await e.close({signal:n});let c=v1({peerConnection:i,remoteAddr:s,metrics:this.metrics?.listenerEvents,direction:"inbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,remotePeer:a,muxerFactory:o,signal:n}),this._closeOnShutdown(i,c)}catch(s){throw this.log.error("incoming signaling error - %e",s),i.close(),e.abort(s),s}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection - %e",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function mL(r){let e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new O("Destination peer id was missing");return{circuitAddress:se(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:tt(e)}}var MYe=bt(xL());var D;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(D||(D={}));var b;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(b||(b={}));var wE=bt(Xs()),rs=class{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(wE.BufferSourceConverter.isBufferSource(e))this.unusedBits=t,this.value=wE.BufferSourceConverter.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof wo))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new wo({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new wo({name:e})}toNumber(){let e="",t=new Uint8Array(this.value);for(let n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2),n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;let i=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let o=0;for(;o<n;)i[o]=parseInt(t.slice(o<<3,(o<<3)+8),2),o++;this.value=i.buffer}};var xE=bt(Xs()),Se=class{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):xE.BufferSourceConverter.isBufferSource(e)?this.buffer=xE.BufferSourceConverter.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof hn))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new hn({valueHex:this.buffer})}toSchema(e){return new hn({name:e})}};var HQ={fromASN:r=>r instanceof Hn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Hn;let e=gi(r);if(e.result.error)throw new Error(e.result.error);return e.result}},VQ={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new pi({value:+r})},zQ={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new ql({value:r})},$e={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new pi({valueHex:r})};var KQ={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new wo({valueHex:r})},qQ={fromASN:r=>r.valueBlock.toString(),toASN:r=>new mi({value:r})},jQ={fromASN:r=>r.valueBlock.value,toASN:r=>new Kl({value:r})},Ud={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new hn({valueHex:r})},bL={fromASN:r=>new Se(r.getValue()),toASN:r=>r.toASN()};function Fi(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}var bE=Fi(Bi),WQ=Fi(jl),GQ=Fi(Wl),XQ=Fi(Gl),YQ=Fi(Xl),QQ=Fi(Yl),ZQ=Fi(Ql),JQ=Fi(Zl),eZ=Fi(Jl),tZ=Fi(oc),rZ=Fi(eu),nZ=Fi(tu),iZ={fromASN:r=>r.toDate(),toASN:r=>new sc({valueDate:r})},oZ={fromASN:r=>r.toDate(),toASN:r=>new ru({valueDate:r})},sZ={fromASN:()=>null,toASN:()=>new Hn};function fc(r){switch(r){case b.Any:return HQ;case b.BitString:return KQ;case b.BmpString:return WQ;case b.Boolean:return jQ;case b.CharacterString:return nZ;case b.Enumerated:return zQ;case b.GeneralString:return rZ;case b.GeneralizedTime:return oZ;case b.GraphicString:return eZ;case b.IA5String:return JQ;case b.Integer:return VQ;case b.Null:return sZ;case b.NumericString:return XQ;case b.ObjectIdentifier:return qQ;case b.OctetString:return Ud;case b.PrintableString:return YQ;case b.TeletexString:return QQ;case b.UTCTime:return iZ;case b.UniversalString:return GQ;case b.Utf8String:return bE;case b.VideotexString:return ZQ;case b.VisibleString:return tZ;default:return null}}function $i(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:$i(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function EE(r){var e;if(r){let t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:EE(t)}return!1}function vL(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}var C5=class{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){let n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){let t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){let t={type:D.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){let n=this.items.get(e)||this.createDefault(e),i=[];for(let o in n.items){let s=n.items[o],a=t?o:"",c;if(typeof s.type=="number"){let u=b[s.type],f=Mi[u];if(!f)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new f({name:a})}else $i(s.type)?c=new s.type().toSchema(a):s.optional?this.get(s.type).type===D.Choice?c=new Yo({name:a}):(c=this.create(s.type,!1),c.name=a):c=new Yo({name:a});let l=!!s.optional||s.defaultValue!==void 0;if(s.repeated){c.name="";let u=s.repeated==="set"?In:It;c=new u({name:"",value:[new nu({name:a,value:c})]})}if(s.context!==null&&s.context!==void 0)if(s.implicit)if(typeof s.type=="number"||$i(s.type)){let u=s.repeated?hr:Zs;i.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:s.context}}))}else{this.cache(s.type);let u=!!s.repeated,f=u?c:this.get(s.type,!0).schema;f="valueBlock"in f?f.valueBlock.value:f.value,i.push(new hr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:f}))}else i.push(new hr({optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}));else c.optional=l,i.push(c)}switch(n.type){case D.Sequence:return new It({value:i,name:""});case D.Set:return new In({value:i,name:""});case D.Choice:return new bd({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){let t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}};var Xt=new C5;var L=r=>e=>{let t;Xt.has(e)?t=Xt.get(e):(t=Xt.createDefault(e),Xt.set(e,t)),Object.assign(t,r)};var g=r=>(e,t)=>{let n;Xt.has(e.constructor)?n=Xt.get(e.constructor):(n=Xt.createDefault(e.constructor),Xt.set(e.constructor,n));let i=Object.assign({},r);if(typeof i.type=="number"&&!i.converter){let o=fc(r.type);if(!o)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=o}i.raw=r.raw,n.items[t]=i};var dc=class extends Error{constructor(){super(...arguments),this.schemas=[]}};var E1=class{static parse(e,t){let n=gi(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if($i(t))return new t().fromASN(e);let n=Xt.get(t);Xt.cache(t);let i=n.schema,o=this.handleChoiceTypes(e,n,t,i);if(o?.result)return o.result;o?.targetSchema&&(i=o.targetSchema);let s=this.handleSequenceTypes(e,n,t,i);if(s&&"isManualMapping"in s)return s.result;let a=s,c=new t;return EE(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,a,c),c)}catch(n){throw n instanceof dc&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,i){if(e.constructor===hr&&t.type===D.Choice&&e.idBlock.tagClass===3)for(let o in t.items){let s=t.items[o];if(s.context===e.idBlock.tagNumber&&s.implicit&&typeof s.type=="function"&&Xt.has(s.type)){let a=Xt.get(s.type);if(a&&a.type===D.Sequence){let c=new It;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;let l=this.fromASN(c,s.type),u=new n;return u[o]=l,{result:u}}}}}else if(e.constructor===hr&&t.type!==D.Choice){let o=new hr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(let s in t.items)delete e[s];return{targetSchema:o}}return null}static handleSequenceTypes(e,t,n,i){if(t.type===D.Sequence){if(Object.keys(t.items).filter(a=>{let c=t.items[a];return c.optional&&typeof c.type=="function"&&Xt.has(c.type)&&Xt.get(c.type).type===D.Choice}).length>0&&"value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&n.name==="CertReqMsg")return this.handleManualMapping(e,t,n);let s=Ys({},e,i);if(!s.verified)throw new dc(`Data does not match to ${n.name} ASN1 schema.${s.result.error?` ${s.result.error}`:""}`);return s}else{let o=Ys({},e,i);if(!o.verified)throw new dc(`Data does not match to ${n.name} ASN1 schema.${o.result.error?` ${o.result.error}`:""}`);return o}}static handleManualMapping(e,t,n){let i=new n,o=e.valueBlock.value,s=Object.keys(t.items),a=0;for(let c=0;c<s.length;c++){let l=s[c],u=t.items[l];if(a>=o.length)break;if(u.repeated){i[l]=this.processRepeatedField(o,a,u);break}else if(typeof u.type=="number")i[l]=this.processPrimitiveField(o[a],u),a++;else if(this.isOptionalChoiceField(u)){let f=this.processOptionalChoiceField(o[a],u);f.processed&&(i[l]=f.value,a++)}else i[l]=this.fromASN(o[a],u.type),a++}return{result:i,verified:!0,isManualMapping:!0}}static processRepeatedField(e,t,n){let i=e.slice(t);if(i.length===1&&i[0].constructor.name==="Sequence"){let o=i[0];o.valueBlock&&o.valueBlock.value&&Array.isArray(o.valueBlock.value)&&(i=o.valueBlock.value)}if(typeof n.type=="number"){let o=fc(n.type);if(!o)throw new Error(`No converter for ASN.1 type ${n.type}`);return i.filter(s=>s&&s.valueBlock).map(s=>{try{return o.fromASN(s)}catch{return}}).filter(s=>s!==void 0)}else return i.filter(o=>o&&o.valueBlock).map(o=>{try{return this.fromASN(o,n.type)}catch{return}}).filter(o=>o!==void 0)}static processPrimitiveField(e,t){let n=fc(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&Xt.has(e.type)&&Xt.get(e.type).type===D.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof dc&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let i=t.itemType;if(typeof i=="number"){let o=fc(i);if(!o)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,s=>o.fromASN(s))}else return n.from(e.valueBlock.value,o=>this.fromASN(o,i))}static processSchemaItems(e,t,n){for(let i in e.items){let o=t.result[i];if(!o)continue;let s=e.items[i],a=s.type,c;typeof a=="number"||$i(a)?c=this.processPrimitiveSchemaItem(o,s,a):c=this.processComplexSchemaItem(o,s,a),c&&typeof c=="object"&&"value"in c&&"raw"in c?(n[i]=c.value,n[`${i}Raw`]=c.raw):n[i]=c}}static processPrimitiveSchemaItem(e,t,n){var i;let o=(i=t.converter)!==null&&i!==void 0?i:$i(n)?new n:null;if(!o)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,o):this.processSinglePrimitiveItem(e,t,n,o)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){let i=t.repeated==="sequence"?It:In,o=new i;o.valueBlock=e.valueBlock;let s=gi(o.toBER(!1));if(s.offset===-1)throw new Error(`Cannot parse the child item. ${s.result.error}`);if(!("value"in s.result.valueBlock&&Array.isArray(s.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let a=s.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,i=>n.fromASN(i))}static processSinglePrimitiveItem(e,t,n,i){let o=e;if(t.implicit){let s;if($i(n))s=new n().toSchema("");else{let a=b[n],c=Mi[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);s=new c}s.valueBlock=o.valueBlock,o=gi(s.toBER(!1)).result}return i.fromASN(o)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,i=>this.fromASN(i,n))}else{let i=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(i,n)}catch(o){if(o instanceof dc&&/Wrong values for Choice type/.test(o.message))return;throw o}else{let o=this.fromASN(i,n);return t.raw?{value:o,raw:e.valueBeforeDecodeView}:o}}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){let i=Xt.get(n);if(i.type===D.Sequence){let o=new It;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in o.valueBlock)return o.valueBlock.value=e.valueBlock.value,o}else if(i.type===D.Set){let o=new In;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in o.valueBlock)return o.valueBlock.value=e.valueBlock.value,o}}return e}};var S1=class r{static serialize(e){return e instanceof dr?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&$i(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");let t=e.constructor,n=Xt.get(t);Xt.cache(t);let i=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){let s=fc(n.itemType);if(!s)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>s.toASN(a))}else i=e.map(s=>this.toAsnItem({type:n.itemType},"[]",t,s))}else for(let s in n.items){let a=n.items[s],c=e[s];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&vL(this.serialize(a.defaultValue),this.serialize(c)))continue;let l=r.toAsnItem(a,s,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||$i(a.type))){let u={};u.valueHex=l instanceof Hn?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new Zs({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else i.push(new hr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new hr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let o;switch(n.type){case D.Sequence:o=new It({value:i});break;case D.Set:o=new In({value:i});break;case D.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);o=i[0];break}return o}static toAsnItem(e,t,n,i){let o;if(typeof e.type=="number"){let s=e.converter;if(!s)throw new Error(`Property '${t}' doesn't have converter for type ${b[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");let a=Array.from(i,l=>s.toASN(l)),c=e.repeated==="sequence"?It:In;o=new c({value:a})}else o=s.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");let s=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?It:In;o=new a({value:s})}else o=this.toASN(i);return o}};var we=class extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(let t of e)this.push(t)}}};var SE=bt(Xs());var ne=class r{static serialize(e){return S1.serialize(e)}static parse(e,t){return E1.parse(e,t)}static toString(e){let t=SE.BufferSourceConverter.isBufferSource(e)?SE.BufferSourceConverter.toArrayBuffer(e):r.serialize(e),n=gi(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}};function p(r,e,t,n){var i=arguments.length,o=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(o=(i<3?s(o):i>3?s(e,t,o):s(e,t))||o);return i>3&&o&&Object.defineProperty(e,t,o),o}function Le(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function Ot(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t}var EL=bt(Xs()),A1=class{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){let t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{let i=parseInt(n,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){let n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((i,o)=>{let s=parseInt(o,16);if(isNaN(s)||s<0||s>65535)throw new Error("Invalid IPv6 address part");return i.push(s>>8&255),i.push(s&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;let t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");let n=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],o=8-(n.length+i.length);if(o<0)throw new Error("Invalid IPv6 address");return[...n,...Array(o).fill("0"),...i].join(":")}static formatIPv6(e){let t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){let t=e.split(":"),n=-1,i=0,o=-1,s=0;for(let a=0;a<t.length;a++)t[a]==="0"?(o===-1&&(o=a),s++):(s>i&&(n=o,i=s),o=-1,s=0);if(s>i&&(n=o,i=s),i>1){let a=t.slice(0,n).join(":"),c=t.slice(n+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){let[t,n]=e.split("/"),i=parseInt(n,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;let t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,o)=>i+ +o,0),n=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){let t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){let n=t.length/2,i=t.slice(0,n),o=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";let a=o.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(EL.Convert.ToHex(e))}static fromString(e){if(e.includes("/")){let[n,i]=this.parseCIDR(e),o=new Uint8Array(n.length),s=i;for(let c=0;c<o.length;c++)s>=8?(o[c]=255,s-=8):s>0&&(o[c]=255<<8-s,s=0);let a=new Uint8Array(n.length*2);return a.set(n,0),a.set(o,n.length),a.buffer}let t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}};var SL=bt(Xs()),AE,_E,CE,pr=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};p([g({type:b.TeletexString})],pr.prototype,"teletexString",void 0);p([g({type:b.PrintableString})],pr.prototype,"printableString",void 0);p([g({type:b.UniversalString})],pr.prototype,"universalString",void 0);p([g({type:b.Utf8String})],pr.prototype,"utf8String",void 0);p([g({type:b.BmpString})],pr.prototype,"bmpString",void 0);pr=p([L({type:D.Choice})],pr);var Fd=class extends pr{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?SL.Convert.ToHex(this.anyValue):super.toString())}};p([g({type:b.IA5String})],Fd.prototype,"ia5String",void 0);p([g({type:b.Any})],Fd.prototype,"anyValue",void 0);Fd=p([L({type:D.Choice})],Fd);var cu=class{constructor(e={}){this.type="",this.value=new Fd,Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],cu.prototype,"type",void 0);p([g({type:Fd})],cu.prototype,"value",void 0);var hc=AE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,AE.prototype)}};hc=AE=p([L({type:D.Set,itemType:cu})],hc);var TE=_E=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,_E.prototype)}};TE=_E=p([L({type:D.Sequence,itemType:hc})],TE);var wt=CE=class extends TE{constructor(e){super(e),Object.setPrototypeOf(this,CE.prototype)}};wt=CE=p([L({type:D.Sequence})],wt);var aZ={fromASN:r=>A1.toString(Ud.fromASN(r)),toASN:r=>Ud.toASN(A1.fromString(r))},pc=class{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],pc.prototype,"typeId",void 0);p([g({type:b.Any,context:0})],pc.prototype,"value",void 0);var _1=class{constructor(e={}){this.partyName=new pr,Object.assign(this,e)}};p([g({type:pr,optional:!0,context:0,implicit:!0})],_1.prototype,"nameAssigner",void 0);p([g({type:pr,context:1,implicit:!0})],_1.prototype,"partyName",void 0);var _e=class{constructor(e={}){Object.assign(this,e)}};p([g({type:pc,context:0,implicit:!0})],_e.prototype,"otherName",void 0);p([g({type:b.IA5String,context:1,implicit:!0})],_e.prototype,"rfc822Name",void 0);p([g({type:b.IA5String,context:2,implicit:!0})],_e.prototype,"dNSName",void 0);p([g({type:b.Any,context:3,implicit:!0})],_e.prototype,"x400Address",void 0);p([g({type:wt,context:4,implicit:!1})],_e.prototype,"directoryName",void 0);p([g({type:_1,context:5})],_e.prototype,"ediPartyName",void 0);p([g({type:b.IA5String,context:6,implicit:!0})],_e.prototype,"uniformResourceIdentifier",void 0);p([g({type:b.OctetString,context:7,implicit:!0,converter:aZ})],_e.prototype,"iPAddress",void 0);p([g({type:b.ObjectIdentifier,context:8,implicit:!0})],_e.prototype,"registeredID",void 0);_e=p([L({type:D.Choice})],_e);var mc="1.3.6.1.5.5.7",gc=`${mc}.1`,AL=`${mc}.2`,lu=`${mc}.3`,T5=`${mc}.48`,_Ne=`${AL}.1`,CNe=`${AL}.2`,IE=`${T5}.1`,kE=`${T5}.2`,PE=`${T5}.3`,RE=`${T5}.5`,De="2.5.29";var DE,I5=`${gc}.1`,ia=class{constructor(e={}){this.accessMethod="",this.accessLocation=new _e,Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],ia.prototype,"accessMethod",void 0);p([g({type:_e})],ia.prototype,"accessLocation",void 0);var uu=DE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,DE.prototype)}};uu=DE=p([L({type:D.Sequence,itemType:ia})],uu);var k5=`${De}.35`,fu=class extends Se{},ns=class{constructor(e={}){e&&Object.assign(this,e)}};p([g({type:fu,context:0,optional:!0,implicit:!0})],ns.prototype,"keyIdentifier",void 0);p([g({type:_e,context:1,optional:!0,implicit:!0,repeated:"sequence"})],ns.prototype,"authorityCertIssuer",void 0);p([g({type:b.Integer,context:2,optional:!0,implicit:!0,converter:$e})],ns.prototype,"authorityCertSerialNumber",void 0);var P5=`${De}.19`,du=class{constructor(e={}){this.cA=!1,Object.assign(this,e)}};p([g({type:b.Boolean,defaultValue:!1})],du.prototype,"cA",void 0);p([g({type:b.Integer,optional:!0})],du.prototype,"pathLenConstraint",void 0);var OE,Nt=OE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,OE.prototype)}};Nt=OE=p([L({type:D.Sequence,itemType:_e})],Nt);var NE,cZ=`${De}.29`,_L=NE=class extends Nt{constructor(e){super(e),Object.setPrototypeOf(this,NE.prototype)}};_L=NE=p([L({type:D.Sequence})],_L);var LE,D5=`${De}.32`,iLe=`${D5}.0`,oa=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};p([g({type:b.IA5String})],oa.prototype,"ia5String",void 0);p([g({type:b.VisibleString})],oa.prototype,"visibleString",void 0);p([g({type:b.BmpString})],oa.prototype,"bmpString",void 0);p([g({type:b.Utf8String})],oa.prototype,"utf8String",void 0);oa=p([L({type:D.Choice})],oa);var C1=class{constructor(e={}){this.organization=new oa,this.noticeNumbers=[],Object.assign(this,e)}};p([g({type:oa})],C1.prototype,"organization",void 0);p([g({type:b.Integer,repeated:"sequence"})],C1.prototype,"noticeNumbers",void 0);var T1=class{constructor(e={}){Object.assign(this,e)}};p([g({type:C1,optional:!0})],T1.prototype,"noticeRef",void 0);p([g({type:oa,optional:!0})],T1.prototype,"explicitText",void 0);var R5=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.IA5String})],R5.prototype,"cPSuri",void 0);p([g({type:T1})],R5.prototype,"userNotice",void 0);R5=p([L({type:D.Choice})],R5);var I1=class{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],I1.prototype,"policyQualifierId",void 0);p([g({type:b.Any})],I1.prototype,"qualifier",void 0);var hu=class{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],hu.prototype,"policyIdentifier",void 0);p([g({type:I1,repeated:"sequence",optional:!0})],hu.prototype,"policyQualifiers",void 0);var k1=LE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,LE.prototype)}};k1=LE=p([L({type:D.Sequence,itemType:hu})],k1);var dLe=`${De}.20`,P1=class{constructor(e=0){this.value=e}};p([g({type:b.Integer})],P1.prototype,"value",void 0);P1=p([L({type:D.Choice})],P1);var xLe=`${De}.27`,CL=class extends P1{};CL=p([L({type:D.Choice})],CL);var BE,O5=`${De}.31`,vo;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(vo||(vo={}));var R1=class extends rs{toJSON(){let e=[],t=this.toNumber();return t&vo.aACompromise&&e.push("aACompromise"),t&vo.affiliationChanged&&e.push("affiliationChanged"),t&vo.cACompromise&&e.push("cACompromise"),t&vo.certificateHold&&e.push("certificateHold"),t&vo.cessationOfOperation&&e.push("cessationOfOperation"),t&vo.keyCompromise&&e.push("keyCompromise"),t&vo.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&vo.superseded&&e.push("superseded"),t&vo.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}},sa=class{constructor(e={}){Object.assign(this,e)}};p([g({type:_e,context:0,repeated:"sequence",implicit:!0})],sa.prototype,"fullName",void 0);p([g({type:hc,context:1,implicit:!0})],sa.prototype,"nameRelativeToCRLIssuer",void 0);sa=p([L({type:D.Choice})],sa);var is=class{constructor(e={}){Object.assign(this,e)}};p([g({type:sa,context:0,optional:!0})],is.prototype,"distributionPoint",void 0);p([g({type:R1,context:1,optional:!0,implicit:!0})],is.prototype,"reasons",void 0);p([g({type:_e,context:2,optional:!0,repeated:"sequence",implicit:!0})],is.prototype,"cRLIssuer",void 0);var yc=BE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,BE.prototype)}};yc=BE=p([L({type:D.Sequence,itemType:is})],yc);var ME,NLe=`${De}.46`,TL=ME=class extends yc{constructor(e){super(e),Object.setPrototypeOf(this,ME.prototype)}};TL=ME=p([L({type:D.Sequence,itemType:is})],TL);var VLe=`${De}.28`,wi=class r{constructor(e={}){this.onlyContainsUserCerts=r.ONLY,this.onlyContainsCACerts=r.ONLY,this.indirectCRL=r.ONLY,this.onlyContainsAttributeCerts=r.ONLY,Object.assign(this,e)}};wi.ONLY=!1;p([g({type:sa,context:0,optional:!0})],wi.prototype,"distributionPoint",void 0);p([g({type:b.Boolean,context:1,defaultValue:wi.ONLY,implicit:!0})],wi.prototype,"onlyContainsUserCerts",void 0);p([g({type:b.Boolean,context:2,defaultValue:wi.ONLY,implicit:!0})],wi.prototype,"onlyContainsCACerts",void 0);p([g({type:R1,context:3,optional:!0,implicit:!0})],wi.prototype,"onlySomeReasons",void 0);p([g({type:b.Boolean,context:4,defaultValue:wi.ONLY,implicit:!0})],wi.prototype,"indirectCRL",void 0);p([g({type:b.Boolean,context:5,defaultValue:wi.ONLY,implicit:!0})],wi.prototype,"onlyContainsAttributeCerts",void 0);var IL=`${De}.21`,D1;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(D1||(D1={}));var O1=class{constructor(e=D1.unspecified){this.reason=D1.unspecified,this.reason=e}toJSON(){return D1[this.reason]}toString(){return this.toJSON()}};p([g({type:b.Enumerated})],O1.prototype,"reason",void 0);O1=p([L({type:D.Choice})],O1);var UE,N5=`${De}.37`,N1=UE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,UE.prototype)}};N1=UE=p([L({type:D.Sequence,itemType:b.ObjectIdentifier})],N1);var JLe=`${N5}.0`,kL=`${lu}.1`,PL=`${lu}.2`,RL=`${lu}.3`,DL=`${lu}.4`,OL=`${lu}.8`,NL=`${lu}.9`;var iBe=`${De}.54`,FE=class{constructor(e=new ArrayBuffer(0)){this.value=e}};p([g({type:b.Integer,converter:$e})],FE.prototype,"value",void 0);FE=p([L({type:D.Choice})],FE);var LL=`${De}.24`,L1=class{constructor(e){this.value=new Date,e&&(this.value=e)}};p([g({type:b.GeneralizedTime})],L1.prototype,"value",void 0);L1=p([L({type:D.Choice})],L1);var $E,HE=`${De}.18`,BL=$E=class extends Nt{constructor(e){super(e),Object.setPrototypeOf(this,$E.prototype)}};BL=$E=p([L({type:D.Sequence})],BL);var L5=`${De}.15`,Eo;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(Eo||(Eo={}));var $d=class extends rs{toJSON(){let e=this.toNumber(),t=[];return e&Eo.cRLSign&&t.push("crlSign"),e&Eo.dataEncipherment&&t.push("dataEncipherment"),e&Eo.decipherOnly&&t.push("decipherOnly"),e&Eo.digitalSignature&&t.push("digitalSignature"),e&Eo.encipherOnly&&t.push("encipherOnly"),e&Eo.keyAgreement&&t.push("keyAgreement"),e&Eo.keyCertSign&&t.push("keyCertSign"),e&Eo.keyEncipherment&&t.push("keyEncipherment"),e&Eo.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}};var VE,_Be=`${De}.30`,Hd=class{constructor(e={}){this.base=new _e,this.minimum=0,Object.assign(this,e)}};p([g({type:_e})],Hd.prototype,"base",void 0);p([g({type:b.Integer,context:0,defaultValue:0,implicit:!0})],Hd.prototype,"minimum",void 0);p([g({type:b.Integer,context:1,optional:!0,implicit:!0})],Hd.prototype,"maximum",void 0);var B5=VE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,VE.prototype)}};B5=VE=p([L({type:D.Sequence,itemType:Hd})],B5);var M5=class{constructor(e={}){Object.assign(this,e)}};p([g({type:B5,context:0,optional:!0,implicit:!0})],M5.prototype,"permittedSubtrees",void 0);p([g({type:B5,context:1,optional:!0,implicit:!0})],M5.prototype,"excludedSubtrees",void 0);var RBe=`${De}.36`,U5=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.Integer,context:0,implicit:!0,optional:!0,converter:$e})],U5.prototype,"requireExplicitPolicy",void 0);p([g({type:b.Integer,context:1,implicit:!0,optional:!0,converter:$e})],U5.prototype,"inhibitPolicyMapping",void 0);var zE,BBe=`${De}.33`,B1=class{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],B1.prototype,"issuerDomainPolicy",void 0);p([g({type:b.ObjectIdentifier})],B1.prototype,"subjectDomainPolicy",void 0);var ML=zE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,zE.prototype)}};ML=zE=p([L({type:D.Sequence,itemType:B1})],ML);var KE,qE=`${De}.17`,F5=KE=class extends Nt{constructor(e){super(e),Object.setPrototypeOf(this,KE.prototype)}};F5=KE=p([L({type:D.Sequence})],F5);var Yr=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Yr.prototype,"type",void 0);p([g({type:b.Any,repeated:"set"})],Yr.prototype,"values",void 0);var jE,ZBe=`${De}.9`,UL=jE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,jE.prototype)}};UL=jE=p([L({type:D.Sequence,itemType:Yr})],UL);var WE=`${De}.14`,Kn=class extends fu{};var aMe=`${De}.16`,$5=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.GeneralizedTime,context:0,implicit:!0,optional:!0})],$5.prototype,"notBefore",void 0);p([g({type:b.GeneralizedTime,context:1,implicit:!0,optional:!0})],$5.prototype,"notAfter",void 0);var M1;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(M1||(M1={}));var H5=class extends rs{toJSON(){let e=[],t=this.toNumber();return t&M1.pKIXCertificate&&e.push("pKIXCertificate"),t&M1.newExtensions&&e.push("newExtensions"),t&M1.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}},V5=class{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new H5,Object.assign(this,e)}};p([g({type:b.GeneralString})],V5.prototype,"entrustVers",void 0);p([g({type:H5})],V5.prototype,"entrustInfoFlags",void 0);var GE,gMe=`${gc}.11`,FL=GE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,GE.prototype)}};FL=GE=p([L({type:D.Sequence,itemType:ia})],FL);var $L=bt(Xs()),J=class r{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof r&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&$L.isEqual(e.parameters,this.parameters)||e.parameters===this.parameters)}};p([g({type:b.ObjectIdentifier})],J.prototype,"algorithm",void 0);p([g({type:b.Any,optional:!0})],J.prototype,"parameters",void 0);var Qr=class{constructor(e={}){this.algorithm=new J,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:J})],Qr.prototype,"algorithm",void 0);p([g({type:b.BitString})],Qr.prototype,"subjectPublicKey",void 0);var Yt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){let t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){let e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};p([g({type:b.UTCTime})],Yt.prototype,"utcTime",void 0);p([g({type:b.GeneralizedTime})],Yt.prototype,"generalTime",void 0);Yt=p([L({type:D.Choice})],Yt);var aa=class{constructor(e){this.notBefore=new Yt(new Date),this.notAfter=new Yt(new Date),e&&(this.notBefore=new Yt(e.notBefore),this.notAfter=new Yt(e.notAfter))}};p([g({type:Yt})],aa.prototype,"notBefore",void 0);p([g({type:Yt})],aa.prototype,"notAfter",void 0);var XE,Zr=class r{constructor(e={}){this.extnID="",this.critical=r.CRITICAL,this.extnValue=new Se,Object.assign(this,e)}};Zr.CRITICAL=!1;p([g({type:b.ObjectIdentifier})],Zr.prototype,"extnID",void 0);p([g({type:b.Boolean,defaultValue:Zr.CRITICAL})],Zr.prototype,"critical",void 0);p([g({type:Se})],Zr.prototype,"extnValue",void 0);var xi=XE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,XE.prototype)}};xi=XE=p([L({type:D.Sequence,itemType:Zr})],xi);var os;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(os||(os={}));var Jr=class{constructor(e={}){this.version=os.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new J,this.issuer=new wt,this.validity=new aa,this.subject=new wt,this.subjectPublicKeyInfo=new Qr,Object.assign(this,e)}};p([g({type:b.Integer,context:0,defaultValue:os.v1})],Jr.prototype,"version",void 0);p([g({type:b.Integer,converter:$e})],Jr.prototype,"serialNumber",void 0);p([g({type:J})],Jr.prototype,"signature",void 0);p([g({type:wt})],Jr.prototype,"issuer",void 0);p([g({type:aa})],Jr.prototype,"validity",void 0);p([g({type:wt})],Jr.prototype,"subject",void 0);p([g({type:Qr})],Jr.prototype,"subjectPublicKeyInfo",void 0);p([g({type:b.BitString,context:1,implicit:!0,optional:!0})],Jr.prototype,"issuerUniqueID",void 0);p([g({type:b.BitString,context:2,implicit:!0,optional:!0})],Jr.prototype,"subjectUniqueID",void 0);p([g({type:xi,context:3,optional:!0})],Jr.prototype,"extensions",void 0);var Hi=class{constructor(e={}){this.tbsCertificate=new Jr,this.signatureAlgorithm=new J,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:Jr,raw:!0})],Hi.prototype,"tbsCertificate",void 0);p([g({type:J})],Hi.prototype,"signatureAlgorithm",void 0);p([g({type:b.BitString})],Hi.prototype,"signatureValue",void 0);var pu=class{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Yt,Object.assign(this,e)}};p([g({type:b.Integer,converter:$e})],pu.prototype,"userCertificate",void 0);p([g({type:Yt})],pu.prototype,"revocationDate",void 0);p([g({type:Zr,optional:!0,repeated:"sequence"})],pu.prototype,"crlEntryExtensions",void 0);var bi=class{constructor(e={}){this.signature=new J,this.issuer=new wt,this.thisUpdate=new Yt,Object.assign(this,e)}};p([g({type:b.Integer,optional:!0})],bi.prototype,"version",void 0);p([g({type:J})],bi.prototype,"signature",void 0);p([g({type:wt})],bi.prototype,"issuer",void 0);p([g({type:Yt})],bi.prototype,"thisUpdate",void 0);p([g({type:Yt,optional:!0})],bi.prototype,"nextUpdate",void 0);p([g({type:pu,repeated:"sequence",optional:!0})],bi.prototype,"revokedCertificates",void 0);p([g({type:Zr,optional:!0,context:0,repeated:"sequence"})],bi.prototype,"crlExtensions",void 0);var mu=class{constructor(e={}){this.tbsCertList=new bi,this.signatureAlgorithm=new J,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:bi,raw:!0})],mu.prototype,"tbsCertList",void 0);p([g({type:J})],mu.prototype,"signatureAlgorithm",void 0);p([g({type:b.BitString})],mu.prototype,"signature",void 0);var ee=bt(Xs());var So=class{constructor(e={}){this.issuer=new wt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:wt})],So.prototype,"issuer",void 0);p([g({type:b.Integer,converter:$e})],So.prototype,"serialNumber",void 0);var gu=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Kn,context:0,implicit:!0})],gu.prototype,"subjectKeyIdentifier",void 0);p([g({type:So})],gu.prototype,"issuerAndSerialNumber",void 0);gu=p([L({type:D.Choice})],gu);var en;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(en||(en={}));var yu=class extends J{};yu=p([L({type:D.Sequence})],yu);var U1=class extends J{};U1=p([L({type:D.Sequence})],U1);var qn=class extends J{};qn=p([L({type:D.Sequence})],qn);var F1=class extends J{};F1=p([L({type:D.Sequence})],F1);var VL=class extends J{};VL=p([L({type:D.Sequence})],VL);var z5=class extends J{};z5=p([L({type:D.Sequence})],z5);var Ao=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Ao.prototype,"attrType",void 0);p([g({type:b.Any,repeated:"set"})],Ao.prototype,"attrValues",void 0);var YE,jn=class{constructor(e={}){this.version=en.v0,this.sid=new gu,this.digestAlgorithm=new yu,this.signatureAlgorithm=new U1,this.signature=new Se,Object.assign(this,e)}};p([g({type:b.Integer})],jn.prototype,"version",void 0);p([g({type:gu})],jn.prototype,"sid",void 0);p([g({type:yu})],jn.prototype,"digestAlgorithm",void 0);p([g({type:Ao,repeated:"set",context:0,implicit:!0,optional:!0,raw:!0})],jn.prototype,"signedAttrs",void 0);p([g({type:U1})],jn.prototype,"signatureAlgorithm",void 0);p([g({type:Se})],jn.prototype,"signature",void 0);p([g({type:Ao,repeated:"set",context:1,implicit:!0,optional:!0})],jn.prototype,"unsignedAttrs",void 0);var $1=YE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,YE.prototype)}};$1=YE=p([L({type:D.Set,itemType:jn})],$1);var zL=class extends Yt{};zL=p([L({type:D.Choice})],zL);var KL=class extends jn{};KL=p([L({type:D.Sequence})],KL);var H1=class{constructor(e={}){this.acIssuer=new _e,this.acSerial=0,this.attrs=[],Object.assign(this,e)}};p([g({type:_e})],H1.prototype,"acIssuer",void 0);p([g({type:b.Integer})],H1.prototype,"acSerial",void 0);p([g({type:Yr,repeated:"sequence"})],H1.prototype,"attrs",void 0);var QE,V1=QE=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,QE.prototype)}};V1=QE=p([L({type:D.Sequence,itemType:b.ObjectIdentifier})],V1);var Vd=class{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}};p([g({type:b.Integer,optional:!0})],Vd.prototype,"pathLenConstraint",void 0);p([g({type:V1,implicit:!0,context:0,optional:!0})],Vd.prototype,"permittedAttrs",void 0);p([g({type:V1,implicit:!0,context:1,optional:!0})],Vd.prototype,"excludedAttrs",void 0);p([g({type:b.Boolean,defaultValue:!0})],Vd.prototype,"permitUnSpecified",void 0);var Vi=class{constructor(e={}){this.issuer=new Nt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:Nt})],Vi.prototype,"issuer",void 0);p([g({type:b.Integer,converter:$e})],Vi.prototype,"serial",void 0);p([g({type:b.BitString,optional:!0})],Vi.prototype,"issuerUID",void 0);var ZE;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(ZE||(ZE={}));var zi=class{constructor(e={}){this.digestedObjectType=ZE.publicKey,this.digestAlgorithm=new J,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.Enumerated})],zi.prototype,"digestedObjectType",void 0);p([g({type:b.ObjectIdentifier,optional:!0})],zi.prototype,"otherObjectTypeID",void 0);p([g({type:J})],zi.prototype,"digestAlgorithm",void 0);p([g({type:b.BitString})],zi.prototype,"objectDigest",void 0);var wu=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Nt,optional:!0})],wu.prototype,"issuerName",void 0);p([g({type:Vi,context:0,implicit:!0,optional:!0})],wu.prototype,"baseCertificateID",void 0);p([g({type:zi,context:1,implicit:!0,optional:!0})],wu.prototype,"objectDigestInfo",void 0);var xu=class{constructor(e={}){Object.assign(this,e)}};p([g({type:_e,repeated:"sequence"})],xu.prototype,"v1Form",void 0);p([g({type:wu,context:0,implicit:!0})],xu.prototype,"v2Form",void 0);xu=p([L({type:D.Choice})],xu);var bu=class{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}};p([g({type:b.GeneralizedTime})],bu.prototype,"notBeforeTime",void 0);p([g({type:b.GeneralizedTime})],bu.prototype,"notAfterTime",void 0);var wc=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Vi,implicit:!0,context:0,optional:!0})],wc.prototype,"baseCertificateID",void 0);p([g({type:Nt,implicit:!0,context:1,optional:!0})],wc.prototype,"entityName",void 0);p([g({type:zi,implicit:!0,context:2,optional:!0})],wc.prototype,"objectDigestInfo",void 0);var JE;(function(r){r[r.v2=1]="v2"})(JE||(JE={}));var Wn=class{constructor(e={}){this.version=JE.v2,this.holder=new wc,this.issuer=new xu,this.signature=new J,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new bu,this.attributes=[],Object.assign(this,e)}};p([g({type:b.Integer})],Wn.prototype,"version",void 0);p([g({type:wc})],Wn.prototype,"holder",void 0);p([g({type:xu})],Wn.prototype,"issuer",void 0);p([g({type:J})],Wn.prototype,"signature",void 0);p([g({type:b.Integer,converter:$e})],Wn.prototype,"serialNumber",void 0);p([g({type:bu})],Wn.prototype,"attrCertValidityPeriod",void 0);p([g({type:Yr,repeated:"sequence"})],Wn.prototype,"attributes",void 0);p([g({type:b.BitString,optional:!0})],Wn.prototype,"issuerUniqueID",void 0);p([g({type:xi,optional:!0})],Wn.prototype,"extensions",void 0);var vu=class{constructor(e={}){this.acinfo=new Wn,this.signatureAlgorithm=new J,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:Wn})],vu.prototype,"acinfo",void 0);p([g({type:J})],vu.prototype,"signatureAlgorithm",void 0);p([g({type:b.BitString})],vu.prototype,"signatureValue",void 0);var z1;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(z1||(z1={}));var zd=class extends rs{};var Kd=class{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier,implicit:!0,context:0})],Kd.prototype,"type",void 0);p([g({type:b.Any,implicit:!0,context:1})],Kd.prototype,"value",void 0);var K1=class{constructor(e={}){this.policyId="",this.classList=new zd(z1.unclassified),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],K1.prototype,"policyId",void 0);p([g({type:zd,defaultValue:new zd(z1.unclassified)})],K1.prototype,"classList",void 0);p([g({type:Kd,repeated:"set"})],K1.prototype,"securityCategories",void 0);var qd=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Se})],qd.prototype,"cotets",void 0);p([g({type:b.ObjectIdentifier})],qd.prototype,"oid",void 0);p([g({type:b.Utf8String})],qd.prototype,"string",void 0);var K5=class{constructor(e={}){this.values=[],Object.assign(this,e)}};p([g({type:Nt,implicit:!0,context:0,optional:!0})],K5.prototype,"policyAuthority",void 0);p([g({type:qd,repeated:"sequence"})],K5.prototype,"values",void 0);var Y$e=`${gc}.4`,Q$e=`${gc}.6`,Z$e=`${gc}.10`,J$e=`${De}.55`,q1=`${mc}.10`,eHe=`${q1}.1`,tHe=`${q1}.2`,rHe=`${q1}.3`,nHe=`${q1}.4`,iHe=`${q1}.6`,eS="2.5.4",oHe=`${eS}.72`;var tS,jd=class{constructor(e={}){this.targetCertificate=new Vi,Object.assign(this,e)}};p([g({type:Vi})],jd.prototype,"targetCertificate",void 0);p([g({type:_e,optional:!0})],jd.prototype,"targetName",void 0);p([g({type:zi,optional:!0})],jd.prototype,"certDigestInfo",void 0);var Wd=class{constructor(e={}){Object.assign(this,e)}};p([g({type:_e,context:0,implicit:!0})],Wd.prototype,"targetName",void 0);p([g({type:_e,context:1,implicit:!0})],Wd.prototype,"targetGroup",void 0);p([g({type:jd,context:2,implicit:!0})],Wd.prototype,"targetCert",void 0);Wd=p([L({type:D.Choice})],Wd);var q5=tS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,tS.prototype)}};q5=tS=p([L({type:D.Sequence,itemType:Wd})],q5);var rS,qL=rS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,rS.prototype)}};qL=rS=p([L({type:D.Sequence,itemType:q5})],qL);var j5=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Nt,implicit:!0,context:0,optional:!0})],j5.prototype,"roleAuthority",void 0);p([g({type:_e,implicit:!0,context:1})],j5.prototype,"roleName",void 0);var j1=class{constructor(e={}){this.service=new _e,this.ident=new _e,Object.assign(this,e)}};p([g({type:_e})],j1.prototype,"service",void 0);p([g({type:_e})],j1.prototype,"ident",void 0);p([g({type:Se,optional:!0})],j1.prototype,"authInfo",void 0);var nS,W1=class{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],W1.prototype,"otherCertFormat",void 0);p([g({type:b.Any})],W1.prototype,"otherCert",void 0);var Eu=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Hi})],Eu.prototype,"certificate",void 0);p([g({type:vu,context:2,implicit:!0})],Eu.prototype,"v2AttrCert",void 0);p([g({type:W1,context:3,implicit:!0})],Eu.prototype,"other",void 0);Eu=p([L({type:D.Choice})],Eu);var Su=nS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,nS.prototype)}};Su=nS=p([L({type:D.Set,itemType:Eu})],Su);var Ki=class{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Ki.prototype,"contentType",void 0);p([g({type:b.Any,context:0})],Ki.prototype,"content",void 0);var Gd=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Se})],Gd.prototype,"single",void 0);p([g({type:b.Any})],Gd.prototype,"any",void 0);Gd=p([L({type:D.Choice})],Gd);var Au=class{constructor(e={}){this.eContentType="",Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Au.prototype,"eContentType",void 0);p([g({type:Gd,context:0,optional:!0})],Au.prototype,"eContent",void 0);var G1=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Se,context:0,implicit:!0,optional:!0})],G1.prototype,"value",void 0);p([g({type:Se,converter:bL,context:0,implicit:!0,optional:!0,repeated:"sequence"})],G1.prototype,"constructedValue",void 0);G1=p([L({type:D.Choice})],G1);var xc=class{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new F1,Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],xc.prototype,"contentType",void 0);p([g({type:F1})],xc.prototype,"contentEncryptionAlgorithm",void 0);p([g({type:G1,optional:!0})],xc.prototype,"encryptedContent",void 0);var bc=class{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],bc.prototype,"keyAttrId",void 0);p([g({type:b.Any,optional:!0})],bc.prototype,"keyAttr",void 0);var iS,Xd=class{constructor(e={}){this.subjectKeyIdentifier=new Kn,Object.assign(this,e)}};p([g({type:Kn})],Xd.prototype,"subjectKeyIdentifier",void 0);p([g({type:b.GeneralizedTime,optional:!0})],Xd.prototype,"date",void 0);p([g({type:bc,optional:!0})],Xd.prototype,"other",void 0);var Yd=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Xd,context:0,implicit:!0,optional:!0})],Yd.prototype,"rKeyId",void 0);p([g({type:So,optional:!0})],Yd.prototype,"issuerAndSerialNumber",void 0);Yd=p([L({type:D.Choice})],Yd);var X1=class{constructor(e={}){this.rid=new Yd,this.encryptedKey=new Se,Object.assign(this,e)}};p([g({type:Yd})],X1.prototype,"rid",void 0);p([g({type:Se})],X1.prototype,"encryptedKey",void 0);var W5=iS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,iS.prototype)}};W5=iS=p([L({type:D.Sequence,itemType:X1})],W5);var Y1=class{constructor(e={}){this.algorithm=new J,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:J})],Y1.prototype,"algorithm",void 0);p([g({type:b.BitString})],Y1.prototype,"publicKey",void 0);var _u=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Kn,context:0,implicit:!0,optional:!0})],_u.prototype,"subjectKeyIdentifier",void 0);p([g({type:Y1,context:1,implicit:!0,optional:!0})],_u.prototype,"originatorKey",void 0);p([g({type:So,optional:!0})],_u.prototype,"issuerAndSerialNumber",void 0);_u=p([L({type:D.Choice})],_u);var ca=class{constructor(e={}){this.version=en.v3,this.originator=new _u,this.keyEncryptionAlgorithm=new qn,this.recipientEncryptedKeys=new W5,Object.assign(this,e)}};p([g({type:b.Integer})],ca.prototype,"version",void 0);p([g({type:_u,context:0})],ca.prototype,"originator",void 0);p([g({type:Se,context:1,optional:!0})],ca.prototype,"ukm",void 0);p([g({type:qn})],ca.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:W5})],ca.prototype,"recipientEncryptedKeys",void 0);var Qd=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Kn,context:0,implicit:!0})],Qd.prototype,"subjectKeyIdentifier",void 0);p([g({type:So})],Qd.prototype,"issuerAndSerialNumber",void 0);Qd=p([L({type:D.Choice})],Qd);var vc=class{constructor(e={}){this.version=en.v0,this.rid=new Qd,this.keyEncryptionAlgorithm=new qn,this.encryptedKey=new Se,Object.assign(this,e)}};p([g({type:b.Integer})],vc.prototype,"version",void 0);p([g({type:Qd})],vc.prototype,"rid",void 0);p([g({type:qn})],vc.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:Se})],vc.prototype,"encryptedKey",void 0);var Cu=class{constructor(e={}){this.keyIdentifier=new Se,Object.assign(this,e)}};p([g({type:Se})],Cu.prototype,"keyIdentifier",void 0);p([g({type:b.GeneralizedTime,optional:!0})],Cu.prototype,"date",void 0);p([g({type:bc,optional:!0})],Cu.prototype,"other",void 0);var Ec=class{constructor(e={}){this.version=en.v4,this.kekid=new Cu,this.keyEncryptionAlgorithm=new qn,this.encryptedKey=new Se,Object.assign(this,e)}};p([g({type:b.Integer})],Ec.prototype,"version",void 0);p([g({type:Cu})],Ec.prototype,"kekid",void 0);p([g({type:qn})],Ec.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:Se})],Ec.prototype,"encryptedKey",void 0);var Sc=class{constructor(e={}){this.version=en.v0,this.keyEncryptionAlgorithm=new qn,this.encryptedKey=new Se,Object.assign(this,e)}};p([g({type:b.Integer})],Sc.prototype,"version",void 0);p([g({type:z5,context:0,optional:!0})],Sc.prototype,"keyDerivationAlgorithm",void 0);p([g({type:qn})],Sc.prototype,"keyEncryptionAlgorithm",void 0);p([g({type:Se})],Sc.prototype,"encryptedKey",void 0);var Q1=class{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Q1.prototype,"oriType",void 0);p([g({type:b.Any})],Q1.prototype,"oriValue",void 0);var la=class{constructor(e={}){Object.assign(this,e)}};p([g({type:vc,optional:!0})],la.prototype,"ktri",void 0);p([g({type:ca,context:1,implicit:!0,optional:!0})],la.prototype,"kari",void 0);p([g({type:Ec,context:2,implicit:!0,optional:!0})],la.prototype,"kekri",void 0);p([g({type:Sc,context:3,implicit:!0,optional:!0})],la.prototype,"pwri",void 0);p([g({type:Q1,context:4,implicit:!0,optional:!0})],la.prototype,"ori",void 0);la=p([L({type:D.Choice})],la);var oS,Z1=oS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,oS.prototype)}};Z1=oS=p([L({type:D.Set,itemType:la})],Z1);var sS,jL=`${mc}.16`,ize=`${jL}.2`,oze=`${jL}.4`,Zd=class{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],Zd.prototype,"otherRevInfoFormat",void 0);p([g({type:b.Any})],Zd.prototype,"otherRevInfo",void 0);var G5=class{constructor(e={}){this.other=new Zd,Object.assign(this,e)}};p([g({type:Zd,context:1,implicit:!0})],G5.prototype,"other",void 0);G5=p([L({type:D.Choice})],G5);var Jd=sS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,sS.prototype)}};Jd=sS=p([L({type:D.Set,itemType:G5})],Jd);var eh=class{constructor(e={}){Object.assign(this,e)}};p([g({type:Su,context:0,implicit:!0,optional:!0})],eh.prototype,"certs",void 0);p([g({type:Jd,context:1,implicit:!0,optional:!0})],eh.prototype,"crls",void 0);var aS,cS=aS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,aS.prototype)}};cS=aS=p([L({type:D.Set,itemType:Ao})],cS);var Tu=class{constructor(e={}){this.version=en.v0,this.recipientInfos=new Z1,this.encryptedContentInfo=new xc,Object.assign(this,e)}};p([g({type:b.Integer})],Tu.prototype,"version",void 0);p([g({type:eh,context:0,implicit:!0,optional:!0})],Tu.prototype,"originatorInfo",void 0);p([g({type:Z1})],Tu.prototype,"recipientInfos",void 0);p([g({type:xc})],Tu.prototype,"encryptedContentInfo",void 0);p([g({type:cS,context:1,implicit:!0,optional:!0})],Tu.prototype,"unprotectedAttrs",void 0);var WL="1.2.840.113549.1.7.2";var lS,X5=lS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,lS.prototype)}};X5=lS=p([L({type:D.Set,itemType:yu})],X5);var ua=class{constructor(e={}){this.version=en.v0,this.digestAlgorithms=new X5,this.encapContentInfo=new Au,this.signerInfos=new $1,Object.assign(this,e)}};p([g({type:b.Integer})],ua.prototype,"version",void 0);p([g({type:X5})],ua.prototype,"digestAlgorithms",void 0);p([g({type:Au})],ua.prototype,"encapContentInfo",void 0);p([g({type:Su,context:0,implicit:!0,optional:!0})],ua.prototype,"certificates",void 0);p([g({type:Jd,context:1,implicit:!0,optional:!0})],ua.prototype,"crls",void 0);p([g({type:$1})],ua.prototype,"signerInfos",void 0);var Iu="1.2.840.10045.2.1";var J1="1.2.840.10045.4.1",Y5="1.2.840.10045.4.3.1",e0="1.2.840.10045.4.3.2",t0="1.2.840.10045.4.3.3",r0="1.2.840.10045.4.3.4";var uS="1.2.840.10045.3.1.7";var fS="1.3.132.0.34";var dS="1.3.132.0.35";function n0(r){return new J({algorithm:r})}var XL=n0(J1),tKe=n0(Y5),YL=n0(e0),QL=n0(t0),ZL=n0(r0);var i0=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],i0.prototype,"fieldType",void 0);p([g({type:b.Any})],i0.prototype,"parameters",void 0);i0=p([L({type:D.Sequence})],i0);var hS=class extends Se{};var th=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.OctetString})],th.prototype,"a",void 0);p([g({type:b.OctetString})],th.prototype,"b",void 0);p([g({type:b.BitString,optional:!0})],th.prototype,"seed",void 0);th=p([L({type:D.Sequence})],th);var pS;(function(r){r[r.ecpVer1=1]="ecpVer1"})(pS||(pS={}));var ss=class{constructor(e={}){this.version=pS.ecpVer1,Object.assign(this,e)}};p([g({type:b.Integer})],ss.prototype,"version",void 0);p([g({type:i0})],ss.prototype,"fieldID",void 0);p([g({type:th})],ss.prototype,"curve",void 0);p([g({type:hS})],ss.prototype,"base",void 0);p([g({type:b.Integer,converter:$e})],ss.prototype,"order",void 0);p([g({type:b.Integer,optional:!0})],ss.prototype,"cofactor",void 0);ss=p([L({type:D.Sequence})],ss);var as=class{constructor(e={}){Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],as.prototype,"namedCurve",void 0);p([g({type:b.Null})],as.prototype,"implicitCurve",void 0);p([g({type:ss})],as.prototype,"specifiedCurve",void 0);as=p([L({type:D.Choice})],as);var rh=class{constructor(e={}){this.version=1,this.privateKey=new Se,Object.assign(this,e)}};p([g({type:b.Integer})],rh.prototype,"version",void 0);p([g({type:Se})],rh.prototype,"privateKey",void 0);p([g({type:as,context:0,optional:!0})],rh.prototype,"parameters",void 0);p([g({type:b.BitString,context:1,optional:!0})],rh.prototype,"publicKey",void 0);var ku=class{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.Integer,converter:$e})],ku.prototype,"r",void 0);p([g({type:b.Integer,converter:$e})],ku.prototype,"s",void 0);var Gn="1.2.840.113549.1.1",cs=`${Gn}.1`,JL=`${Gn}.7`,eB=`${Gn}.9`,Ac=`${Gn}.10`,tB=`${Gn}.2`,rB=`${Gn}.4`,nh=`${Gn}.5`,nB=`${Gn}.14`;var Q5=`${Gn}.11`,ih=`${Gn}.12`,oh=`${Gn}.13`,mS=`${Gn}.15`,gS=`${Gn}.16`,Pu="1.3.14.3.2.26",Z5="2.16.840.1.101.3.4.2.4",Ru="2.16.840.1.101.3.4.2.1",Du="2.16.840.1.101.3.4.2.2",Ou="2.16.840.1.101.3.4.2.3",iB="2.16.840.1.101.3.4.2.5",oB="2.16.840.1.101.3.4.2.6",sB="1.2.840.113549.2.2",aB="1.2.840.113549.2.5",_c=`${Gn}.8`;function Er(r){return new J({algorithm:r,parameters:null})}var kKe=Er(sB),PKe=Er(aB),fa=Er(Pu),RKe=Er(Z5),DKe=Er(Ru),OKe=Er(Du),NKe=Er(Ou),LKe=Er(iB),BKe=Er(oB),J5=new J({algorithm:_c,parameters:ne.serialize(fa)}),yS=new J({algorithm:eB,parameters:ne.serialize(Ud.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))}),MKe=Er(cs),UKe=Er(tB),FKe=Er(rB),$Ke=Er(nh),HKe=Er(mS),VKe=Er(gS),zKe=Er(ih),KKe=Er(oh),qKe=Er(mS),jKe=Er(gS);var sh=class{constructor(e={}){this.hashAlgorithm=new J(fa),this.maskGenAlgorithm=new J({algorithm:_c,parameters:ne.serialize(fa)}),this.pSourceAlgorithm=new J(yS),Object.assign(this,e)}};p([g({type:J,context:0,defaultValue:fa})],sh.prototype,"hashAlgorithm",void 0);p([g({type:J,context:1,defaultValue:J5})],sh.prototype,"maskGenAlgorithm",void 0);p([g({type:J,context:2,defaultValue:yS})],sh.prototype,"pSourceAlgorithm",void 0);var JKe=new J({algorithm:JL,parameters:ne.serialize(new sh)});var ls=class{constructor(e={}){this.hashAlgorithm=new J(fa),this.maskGenAlgorithm=new J({algorithm:_c,parameters:ne.serialize(fa)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}};p([g({type:J,context:0,defaultValue:fa})],ls.prototype,"hashAlgorithm",void 0);p([g({type:J,context:1,defaultValue:J5})],ls.prototype,"maskGenAlgorithm",void 0);p([g({type:b.Integer,context:2,defaultValue:20})],ls.prototype,"saltLength",void 0);p([g({type:b.Integer,context:3,defaultValue:1})],ls.prototype,"trailerField",void 0);var sqe=new J({algorithm:Ac,parameters:ne.serialize(new ls)});var Nu=class{constructor(e={}){this.digestAlgorithm=new J,this.digest=new Se,Object.assign(this,e)}};p([g({type:J})],Nu.prototype,"digestAlgorithm",void 0);p([g({type:Se})],Nu.prototype,"digest",void 0);var wS,ah=class{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.Integer,converter:$e})],ah.prototype,"prime",void 0);p([g({type:b.Integer,converter:$e})],ah.prototype,"exponent",void 0);p([g({type:b.Integer,converter:$e})],ah.prototype,"coefficient",void 0);var e8=wS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,wS.prototype)}};e8=wS=p([L({type:D.Sequence,itemType:ah})],e8);var qi=class{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.Integer})],qi.prototype,"version",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"modulus",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"publicExponent",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"privateExponent",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"prime1",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"prime2",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"exponent1",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"exponent2",void 0);p([g({type:b.Integer,converter:$e})],qi.prototype,"coefficient",void 0);p([g({type:e8,optional:!0})],qi.prototype,"otherPrimeInfos",void 0);var ch=class{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.Integer,converter:$e})],ch.prototype,"modulus",void 0);p([g({type:b.Integer,converter:$e})],ch.prototype,"publicExponent",void 0);var xS;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(xS||(xS={}));var tn=xS;var bS=function(r,e){return bS=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},bS(r,e)};function o0(r,e){bS(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function cB(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function a(u){try{l(n.next(u))}catch(f){s(f)}}function c(u){try{l(n.throw(u))}catch(f){s(f)}}function l(u){u.done?o(u.value):i(u.value).then(a,c)}l((n=n.apply(r,e||[])).next())})}function lB(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(o=l[0]&2?i.return:l[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,l[1])).done)return o;switch(i=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){t.label=l[1];break}if(l[0]===6&&t.label<o[1]){t.label=o[1],o=l;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(l);break}o[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],i=0}finally{n=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function s0(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function lh(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),i,o=[],s;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(a){s={error:a}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(s)throw s.error}}return o}function us(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(lh(arguments[e]));return r}var pZ="injectionTokens";function vS(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(pZ,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function a0(r){return!!r.useClass}function uh(r){return!!r.useFactory}var t8=(function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},i=!1,o,s=function(){return i||(o=e(t.wrap()),i=!0),o};return new Proxy(n,this.createHandler(s))},r.prototype.createHandler=function(e){var t={},n=function(i){t[i]=function(){for(var o=[],s=0;s<arguments.length;s++)o[s]=arguments[s];o[0]=e();var a=Reflect[i];return a.apply(void 0,us(o))}};return this.reflectMethods.forEach(n),t},r})();function Cc(r){return typeof r=="string"||typeof r=="symbol"}function ES(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function r8(r){return typeof r=="object"&&"token"in r&&"transform"in r}function uB(r){return typeof r=="function"||r instanceof t8}function Lu(r){return!!r.useToken}function Bu(r){return r.useValue!=null}function fB(r){return a0(r)||Bu(r)||Lu(r)||uh(r)}var mZ=(function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r})(),c0=mZ;var gZ=(function(r){o0(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(c0),dB=gZ;var yZ=(function(){function r(){this.scopedResolutions=new Map}return r})(),l0=yZ;function wZ(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function xZ(r,e,t){return t===void 0&&(t="    "),us([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function SS(r,e,t){var n=lh(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=n[1],o=i===void 0?null:i,s=wZ(o,e);return xZ("Cannot inject the dependency "+s+' of "'+r.name+'" constructor. Reason:',t)}function hB(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var bZ=(function(r){o0(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(c0);var vZ=(function(r){o0(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(c0);var EZ=(function(){function r(){this.preResolution=new bZ,this.postResolution=new vZ}return r})(),pB=EZ;var AS=new Map,SZ=(function(){function r(e){this.parent=e,this._registry=new dB,this.interceptors=new pB,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:tn.Transient}),this.ensureNotDisposed();var i;if(fB(t)?i=t:i={useClass:t},Lu(i))for(var o=[e],s=i;s!=null;){var a=s.useToken;if(o.includes(a))throw new Error("Token registration cycle detected! "+us(o,[a]).join(" -> "));o.push(a);var c=this._registry.get(a);c&&Lu(c.provider)?s=c.provider:s=null}if((n.lifecycle===tn.Singleton||n.lifecycle==tn.ContainerScoped||n.lifecycle==tn.ResolutionScoped)&&(Bu(i)||uh(i)))throw new Error('Cannot use lifecycle "'+tn[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),Cc(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),Cc(e)){if(Cc(t))return this.register(e,{useToken:t},{lifecycle:tn.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:tn.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!Cc(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:tn.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new l0),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&Cc(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var o=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,o,"Single"),o}if(uB(e)){var o=this.construct(e,t);return this.executePostResolutionInterceptor(e,o,"Single"),o}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,i;if(this.interceptors.preResolution.has(e)){var o=[];try{for(var s=s0(this.interceptors.preResolution.getAll(e)),a=s.next();!a.done;a=s.next()){var c=a.value;c.options.frequency!="Once"&&o.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,o)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var i,o;if(this.interceptors.postResolution.has(e)){var s=[];try{for(var a=s0(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&s.push(l),l.callback(e,t,n)}}catch(u){i={error:u}}finally{try{c&&!c.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,s)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===tn.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===tn.Singleton,i=e.options.lifecycle===tn.ContainerScoped,o=n||i,s;return Bu(e.provider)?s=e.provider.useValue:Lu(e.provider)?s=o?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):a0(e.provider)?s=o?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):uh(e.provider)?s=e.provider.useFactory(this):s=this.construct(e.provider,t),e.options.lifecycle===tn.ResolutionScoped&&t.scopedResolutions.set(e,s),s},r.prototype.resolveAll=function(e,t,n){var i=this;t===void 0&&(t=new l0),n===void 0&&(n=!1),this.ensureNotDisposed();var o=this.getAllRegistrations(e);if(!o&&Cc(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),o){var s=o.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,s,"All"),s}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=s0(this._registry.entries()),i=n.next();!i.done;i=n.next()){var o=lh(i.value,2),s=o[0],a=o[1];this._registry.setAll(s,a.filter(function(c){return!Bu(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var i=s0(this._registry.entries()),o=i.next();!o.done;o=i.next()){var s=lh(o.value,2),a=s[0],c=s[1];c.some(function(l){var u=l.options;return u.lifecycle===tn.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===tn.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return cB(this,void 0,void 0,function(){var e;return lB(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var i=n.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof t8)return e.createProxy(function(o){return n.resolve(o,t)});var i=(function(){var o=AS.get(e);if(!o||o.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var s=o.map(n.resolveParams(t,e));return new(e.bind.apply(e,us([void 0],s)))})();return hB(i)&&this.disposables.add(i),i},r.prototype.resolveParams=function(e,t){var n=this;return function(i,o){var s,a,c;try{return ES(i)?r8(i)?i.multiple?(s=n.resolve(i.transform)).transform.apply(s,us([n.resolveAll(i.token,new l0,i.isOptional)],i.transformArgs)):(a=n.resolve(i.transform)).transform.apply(a,us([n.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?n.resolveAll(i.token,new l0,i.isOptional):n.resolve(i.token,e,i.isOptional):r8(i)?(c=n.resolve(i.transform,e)).transform.apply(c,us([n.resolve(i.token,e)],i.transformArgs)):n.resolve(i,e)}catch(l){throw new Error(SS(t,o,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r})(),kt=new SZ;function AZ(r){return function(e){AS.set(e,vS(e)),r&&r.token&&(Array.isArray(r.token)?r.token.forEach(function(t){kt.register(t,e)}):kt.register(r.token,e))}}var Tc=AZ;if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var CS,Mu=class{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}};p([g({type:b.ObjectIdentifier})],Mu.prototype,"attrId",void 0);p([g({type:b.Any,repeated:"set"})],Mu.prototype,"attrValues",void 0);var mB=CS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,CS.prototype)}};mB=CS=p([L({type:D.Sequence,itemType:Mu})],mB);var TS,gB=TS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,TS.prototype)}};gB=TS=p([L({type:D.Sequence,itemType:Ki})],gB);var _Z="1.2.840.113549",CZ=`${_Z}.1`,yB=`${CZ}.12`,fh=`${yB}.1`,zWe=`${fh}.1`,KWe=`${fh}.2`,qWe=`${fh}.3`,jWe=`${fh}.4`,WWe=`${fh}.5`,GWe=`${fh}.6`,Uu=`${yB}.10.1`;var QWe=`${Uu}.1`,ZWe=`${Uu}.2`,JWe=`${Uu}.3`,eGe=`${Uu}.4`,tGe=`${Uu}.5`,rGe=`${Uu}.6`,n8="1.2.840.113549.1.9";var i8=class{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],i8.prototype,"certId",void 0);p([g({type:b.Any,context:0})],i8.prototype,"certValue",void 0);var wB=`${n8}.22`,aGe=`${wB}.1`,cGe=`${wB}.2`;var o8=class{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],o8.prototype,"crlId",void 0);p([g({type:b.Any,context:0})],o8.prototype,"crltValue",void 0);var TZ=`${n8}.23`,hGe=`${TZ}.1`;var s8=class extends Se{},Ic=class{constructor(e={}){this.encryptionAlgorithm=new J,this.encryptedData=new s8,Object.assign(this,e)}};p([g({type:J})],Ic.prototype,"encryptionAlgorithm",void 0);p([g({type:s8})],Ic.prototype,"encryptedData",void 0);var IS,kS;(function(r){r[r.v1=0]="v1"})(kS||(kS={}));var a8=class extends Se{},PS=IS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,IS.prototype)}};PS=IS=p([L({type:D.Sequence,itemType:Yr})],PS);var kc=class{constructor(e={}){this.version=kS.v1,this.privateKeyAlgorithm=new J,this.privateKey=new a8,Object.assign(this,e)}};p([g({type:b.Integer})],kc.prototype,"version",void 0);p([g({type:J})],kc.prototype,"privateKeyAlgorithm",void 0);p([g({type:a8})],kc.prototype,"privateKey",void 0);p([g({type:PS,implicit:!0,context:0,optional:!0})],kc.prototype,"attributes",void 0);var xB=class extends kc{};xB=p([L({type:D.Sequence})],xB);var bB=class extends Ic{};bB=p([L({type:D.Sequence})],bB);var c8=class{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],c8.prototype,"secretTypeId",void 0);p([g({type:b.Any,context:0})],c8.prototype,"secretValue",void 0);var Pc=class{constructor(e={}){this.mac=new Nu,this.macSalt=new Se,this.iterations=1,Object.assign(this,e)}};p([g({type:Nu})],Pc.prototype,"mac",void 0);p([g({type:Se})],Pc.prototype,"macSalt",void 0);p([g({type:b.Integer,defaultValue:1})],Pc.prototype,"iterations",void 0);var Fu=class{constructor(e={}){this.version=3,this.authSafe=new Ki,this.macData=new Pc,Object.assign(this,e)}};p([g({type:b.Integer})],Fu.prototype,"version",void 0);p([g({type:Ki})],Fu.prototype,"authSafe",void 0);p([g({type:Pc,optional:!0})],Fu.prototype,"macData",void 0);var RS,dh=class{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:b.ObjectIdentifier})],dh.prototype,"bagId",void 0);p([g({type:b.Any,context:0})],dh.prototype,"bagValue",void 0);p([g({type:Mu,repeated:"set",optional:!0})],dh.prototype,"bagAttributes",void 0);var vB=RS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,RS.prototype)}};vB=RS=p([L({type:D.Sequence,itemType:dh})],vB);var DS,OS,NS,Qt="1.2.840.113549.1.9",mXe=`${Qt}.0`,LB=`${Qt}.24`,f0=`${Qt}.25`,BB=`${Qt}.26`,MB=`${Qt}.27`,gXe=`${LB}.1`,yXe=`${LB}.2`,wXe=`${Qt}.1`,xXe=`${Qt}.2`,bXe=`${Qt}.3`,vXe=`${Qt}.4`,EXe=`${Qt}.5`,SXe=`${Qt}.6`,VS=`${Qt}.7`,AXe=`${Qt}.8`,_Xe=`${Qt}.9`,CXe=`${Qt}.13`,d0=`${Qt}.14`,TXe=`${Qt}.15`,IXe=`${Qt}.20`,kXe=`${Qt}.21`;var PXe=`${f0}.1`,RXe=`${f0}.2`,DXe=`${f0}.3`,OXe=`${f0}.4`,NXe=`${f0}.5`,h0="1.3.6.1.5.5.7.9",LXe=`${h0}.1`,BXe=`${h0}.2`,MXe=`${h0}.3`,UXe=`${h0}.4`,FXe=`${h0}.5`,$Xe=`${BB}.1`,HXe=`${BB}.2`,VXe=`${MB}.1`,zXe=`${MB}.2`,KXe=`${Qt}.16`,qXe=`${Qt}.22`,jXe=`${Qt}.23`,WXe=`${eS}.65`,l8=class extends pr{constructor(e={}){super(e)}toString(){return{}.toString(),this.ia5String||super.toString()}};p([g({type:b.IA5String})],l8.prototype,"ia5String",void 0);l8=p([L({type:D.Choice})],l8);var EB=class extends Ki{};EB=p([L({type:D.Sequence})],EB);var SB=class extends Fu{};SB=p([L({type:D.Sequence})],SB);var AB=class extends Ic{};AB=p([L({type:D.Sequence})],AB);var LS=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:b.IA5String})],LS.prototype,"value",void 0);LS=p([L({type:D.Choice})],LS);var _B=class extends l8{};_B=p([L({type:D.Choice})],_B);var CB=class extends pr{};CB=p([L({type:D.Choice})],CB);var BS=class{constructor(e=new Date){this.value=e}};p([g({type:b.GeneralizedTime})],BS.prototype,"value",void 0);BS=p([L({type:D.Choice})],BS);var TB=class extends pr{};TB=p([L({type:D.Choice})],TB);var MS=class{constructor(e="M"){this.value=e}toString(){return this.value}};p([g({type:b.PrintableString})],MS.prototype,"value",void 0);MS=p([L({type:D.Choice})],MS);var u8=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:b.PrintableString})],u8.prototype,"value",void 0);u8=p([L({type:D.Choice})],u8);var IB=class extends u8{};IB=p([L({type:D.Choice})],IB);var kB=class extends pr{};kB=p([L({type:D.Choice})],kB);var US=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:b.ObjectIdentifier})],US.prototype,"value",void 0);US=p([L({type:D.Choice})],US);var PB=class extends Yt{};PB=p([L({type:D.Choice})],PB);var FS=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};p([g({type:b.Integer})],FS.prototype,"value",void 0);FS=p([L({type:D.Choice})],FS);var RB=class extends jn{};RB=p([L({type:D.Sequence})],RB);var u0=class extends pr{};u0=p([L({type:D.Choice})],u0);var DB=DS=class extends xi{constructor(e){super(e),Object.setPrototypeOf(this,DS.prototype)}};DB=DS=p([L({type:D.Sequence})],DB);var OB=OS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,OS.prototype)}};OB=OS=p([L({type:D.Set,itemType:Ao})],OB);var $S=class{constructor(e=""){this.value=e}toString(){return this.value}};p([g({type:b.BmpString})],$S.prototype,"value",void 0);$S=p([L({type:D.Choice})],$S);var HS=class extends J{};HS=p([L({type:D.Sequence})],HS);var NB=NS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,NS.prototype)}};NB=NS=p([L({type:D.Sequence,itemType:HS})],NB);var zS,p0=zS=class extends we{constructor(e){super(e),Object.setPrototypeOf(this,zS.prototype)}};p0=zS=p([L({type:D.Sequence,itemType:Yr})],p0);var fs=class{constructor(e={}){this.version=0,this.subject=new wt,this.subjectPKInfo=new Qr,this.attributes=new p0,Object.assign(this,e)}};p([g({type:b.Integer})],fs.prototype,"version",void 0);p([g({type:wt})],fs.prototype,"subject",void 0);p([g({type:Qr})],fs.prototype,"subjectPKInfo",void 0);p([g({type:p0,implicit:!0,context:0})],fs.prototype,"attributes",void 0);var Rc=class{constructor(e={}){this.certificationRequestInfo=new fs,this.signatureAlgorithm=new J,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([g({type:fs,raw:!0})],Rc.prototype,"certificationRequestInfo",void 0);p([g({type:J})],Rc.prototype,"signatureAlgorithm",void 0);p([g({type:b.BitString})],Rc.prototype,"signature",void 0);var U0="crypto.algorithm",JS=class{getAlgorithms(){return kt.resolveAll(U0)}toAsnAlgorithm(e){({...e});for(let t of this.getAlgorithms()){let n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){let t=new J({algorithm:e.name});if("parameters"in e){let n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(let n of this.getAlgorithms()){let i=n.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}},$u="crypto.algorithmProvider";kt.registerSingleton($u,JS);var p8,Yn="1.3.36.3.3.2.8.1.1",UB=`${Yn}.1`,FB=`${Yn}.2`,$B=`${Yn}.3`,HB=`${Yn}.4`,VB=`${Yn}.5`,zB=`${Yn}.6`,KB=`${Yn}.7`,qB=`${Yn}.8`,jB=`${Yn}.9`,WB=`${Yn}.10`,GB=`${Yn}.11`,XB=`${Yn}.12`,YB=`${Yn}.13`,QB=`${Yn}.14`,ZB="brainpoolP160r1",JB="brainpoolP160t1",eM="brainpoolP192r1",tM="brainpoolP192t1",rM="brainpoolP224r1",nM="brainpoolP224t1",iM="brainpoolP256r1",oM="brainpoolP256t1",sM="brainpoolP320r1",aM="brainpoolP320t1",cM="brainpoolP384r1",lM="brainpoolP384t1",uM="brainpoolP512r1",fM="brainpoolP512t1",Vt="ECDSA",N0=p8=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Vt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return XL;case"sha-256":return YL;case"sha-384":return QL;case"sha-512":return ZL}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=uS;break;case"K-256":t=p8.SECP256K1;break;case"P-384":t=fS;break;case"P-521":t=dS;break;case ZB:t=UB;break;case JB:t=FB;break;case eM:t=$B;break;case tM:t=HB;break;case rM:t=VB;break;case nM:t=zB;break;case iM:t=KB;break;case oM:t=qB;break;case sM:t=jB;break;case aM:t=WB;break;case cM:t=GB;break;case lM:t=XB;break;case uM:t=YB;break;case fM:t=QB;break}if(t)return new J({algorithm:Iu,parameters:ne.serialize(new as({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case J1:return{name:Vt,hash:{name:"SHA-1"}};case e0:return{name:Vt,hash:{name:"SHA-256"}};case t0:return{name:Vt,hash:{name:"SHA-384"}};case r0:return{name:Vt,hash:{name:"SHA-512"}};case Iu:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ne.parse(e.parameters,as).namedCurve){case uS:return{name:Vt,namedCurve:"P-256"};case p8.SECP256K1:return{name:Vt,namedCurve:"K-256"};case fS:return{name:Vt,namedCurve:"P-384"};case dS:return{name:Vt,namedCurve:"P-521"};case UB:return{name:Vt,namedCurve:ZB};case FB:return{name:Vt,namedCurve:JB};case $B:return{name:Vt,namedCurve:eM};case HB:return{name:Vt,namedCurve:tM};case VB:return{name:Vt,namedCurve:rM};case zB:return{name:Vt,namedCurve:nM};case KB:return{name:Vt,namedCurve:iM};case qB:return{name:Vt,namedCurve:oM};case jB:return{name:Vt,namedCurve:sM};case WB:return{name:Vt,namedCurve:aM};case GB:return{name:Vt,namedCurve:cM};case XB:return{name:Vt,namedCurve:lM};case YB:return{name:Vt,namedCurve:uM};case QB:return{name:Vt,namedCurve:fM}}}}return null}};N0.SECP256K1="1.3.132.0.10";N0=p8=p([Tc()],N0);kt.registerSingleton(U0,N0);var EM=Symbol("name"),SM=Symbol("value"),et=class{constructor(e,t={},n=""){this[EM]=e,this[SM]=n;for(let i in t)this[i]=t[i]}};et.NAME=EM;et.VALUE=SM;var eA=class{static toTextObject(e){let t=new et("Algorithm Identifier",{},hs.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Iu:{let n=new N0().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}},hs=class{static toString(e){let t=this.items[e];return t||e}};hs.items={[Pu]:"sha1",[Z5]:"sha224",[Ru]:"sha256",[Du]:"sha384",[Ou]:"sha512",[cs]:"rsaEncryption",[nh]:"sha1WithRSAEncryption",[nB]:"sha224WithRSAEncryption",[Q5]:"sha256WithRSAEncryption",[ih]:"sha384WithRSAEncryption",[oh]:"sha512WithRSAEncryption",[Iu]:"ecPublicKey",[J1]:"ecdsaWithSHA1",[Y5]:"ecdsaWithSHA224",[e0]:"ecdsaWithSHA256",[t0]:"ecdsaWithSHA384",[r0]:"ecdsaWithSHA512",[kL]:"TLS WWW server authentication",[PL]:"TLS WWW client authentication",[RL]:"Code Signing",[DL]:"E-mail Protection",[OL]:"Time Stamping",[NL]:"OCSP Signing",[WL]:"Signed Data"};var ha=class{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){let n=[],i=this.pad(t++),o="",s=e[et.VALUE];s&&(o=` ${s}`),n.push(`${i}${e[et.NAME]}:${o}`),i=this.pad(t);for(let a in e){if(typeof a=="symbol")continue;let c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${i}${l}${c}`);else if(c instanceof Date)n.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(let u of c)u[et.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof et)c[et.NAME]=a,n.push(...this.serializeObj(c,t));else if(ee.BufferSourceConverter.isBufferSource(c))a?(n.push(`${i}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){let u=c.toTextObject();u[et.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){let n=this.pad(t),i=ee.BufferSourceConverter.toUint8Array(e),o=[];for(let s=0;s<i.length;){let a=[];for(let c=0;c<16&&s<i.length;c++){c===8&&a.push("");let l=i[s++].toString(16).padStart(2,"0");a.push(l)}o.push(`${n}${a.join(" ")}`)}return o}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}};ha.oidSerializer=hs;ha.algorithmSerializer=eA;var hh,Dc=class r{get rawData(){return Le(this,hh,"f")||Ot(this,hh,ne.serialize(this.asn),"f"),Le(this,hh,"f")}constructor(...e){hh.set(this,void 0),ee.BufferSourceConverter.isBufferSource(e[0])?(this.asn=ne.parse(e[0],e[1]),Ot(this,hh,ee.BufferSourceConverter.toArrayBuffer(e[0]),"f"),this.onInit(this.asn)):(this.asn=e[0],this.onInit(this.asn))}equal(e){return e instanceof r?(0,ee.isEqual)(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ne.toString(this.rawData);case"text":return ha.serialize(this.toTextObject());case"hex":return ee.Convert.ToHex(this.rawData);case"base64":return ee.Convert.ToBase64(this.rawData);case"base64url":return ee.Convert.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){let e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new et(this.getTextName(),{},e)}};hh=new WeakMap;Dc.NAME="ASN";var vi=class r extends Dc{constructor(...e){let t;ee.BufferSourceConverter.isBufferSource(e[0])?t=ee.BufferSourceConverter.toArrayBuffer(e[0]):t=ne.serialize(new Zr({extnID:e[0],critical:e[1],extnValue:new Se(ee.BufferSourceConverter.toArrayBuffer(e[2]))})),super(t,Zr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[et.NAME]===r.NAME&&(e[et.NAME]=hs.toString(this.type)),e}},AM,L0=class r{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[AM]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(r.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(r.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=r.DEFAULT){let t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(r.DEFAULT,e);return this}};AM=Symbol.toStringTag;L0.DEFAULT="default";var Lr=new L0,RZ=/^[0-2](?:\.[1-9][0-9]*)+$/;function DZ(r){return new RegExp(RZ).test(r)}var g8=class{constructor(e={}){this.items={};for(let t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return DZ(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}},Xn=new g8;Xn.register("CN","2.5.4.3");Xn.register("L","2.5.4.7");Xn.register("ST","2.5.4.8");Xn.register("O","2.5.4.10");Xn.register("OU","2.5.4.11");Xn.register("C","2.5.4.6");Xn.register("DC","0.9.2342.19200300.100.1.25");Xn.register("E","1.2.840.113549.1.9.1");Xn.register("G","2.5.4.42");Xn.register("I","2.5.4.43");Xn.register("SN","2.5.4.4");Xn.register("T","2.5.4.12");function OZ(r,e){return`\\${ee.Convert.ToHex(ee.Convert.FromUtf8String(e)).toUpperCase()}`}function NZ(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,OZ)}var _o=class r{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new g8,this.asn=new wt;for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let i=t[n];this.extraNames.register(n,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof wt?this.asn=e:ee.BufferSourceConverter.isBufferSource(e)?this.asn=ne.parse(e,wt):this.asn=this.fromJSON(e)}getField(e){let t=this.extraNames.findId(e)||Xn.findId(e),n=[];for(let i of this.asn)for(let o of i)o.type===t&&n.push(o.value.toString());return n}getName(e){return this.extraNames.get(e)||Xn.get(e)}toString(){return this.asn.map(e=>e.map(t=>{let n=this.getName(t.type)||t.type,i=t.value.anyValue?`#${ee.Convert.ToHex(t.value.anyValue)}`:NZ(t.value.toString());return`${n}=${i}`}).join("+")).join(", ")}toJSON(){var e;let t=[];for(let n of this.asn){let i={};for(let o of n){let s=this.getName(o.type)||o.type;(e=i[s])!==null&&e!==void 0||(i[s]=[]),i[s].push(o.value.anyValue?`#${ee.Convert.ToHex(o.value.anyValue)}`:o.value.toString())}t.push(i)}return t}fromString(e){let t=new wt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g,i=null,o=",";for(;i=n.exec(`${e},`);){let[,s,a]=i,c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);let l=i[3];s=this.getTypeOid(s);let u=this.createAttribute(s,a);o==="+"?t[t.length-1].push(u):t.push(new hc([u])),o=l}return t}fromJSON(e){let t=new wt;for(let n of e){let i=new hc;for(let o in n){let s=this.getTypeOid(o),a=n[o];for(let c of a){let l=this.createAttribute(s,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){let n=new cu({type:e});if(typeof t=="object")for(let i in t)switch(i){case"ia5String":n.value.ia5String=t[i];break;case"utf8String":n.value.utf8String=t[i];break;case"universalString":n.value.universalString=t[i];break;case"bmpString":n.value.bmpString=t[i];break;case"printableString":n.value.printableString=t[i];break}else if(t[0]==="#")n.value.anyValue=ee.Convert.FromHex(t.slice(1));else{let i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=i:r.isPrintableString(i)?n.value.printableString=i:n.value.utf8String=i}return n}processStringValue(e){let t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ne.serialize(this.asn)}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||Lr.get()):n=e[0]||Lr.get(),await n.subtle.digest(i,this.toArrayBuffer())}},_M="Cannot initialize GeneralName from ASN.1 data.",dM=`${_M} Unsupported string format in use.`,LZ=`${_M} Value doesn't match to GUID regular expression.`,hM=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,pM="1.3.6.1.4.1.311.25.1",mM="1.3.6.1.4.1.311.20.2.3",KS="dns",qS="dn",jS="email",WS="ip",GS="url",XS="guid",YS="upn",f8="id",ds=class extends Dc{constructor(...e){let t;if(e.length===2)switch(e[0]){case qS:{let n=new _o(e[1]).toArrayBuffer(),i=ne.parse(n,wt);t=new _e({directoryName:i});break}case KS:t=new _e({dNSName:e[1]});break;case jS:t=new _e({rfc822Name:e[1]});break;case XS:{let n=new RegExp(hM,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");let i=n.slice(1).map((o,s)=>s<3?ee.Convert.ToHex(new Uint8Array(ee.Convert.FromHex(o)).reverse()):o).join("");t=new _e({otherName:new pc({typeId:pM,value:ne.serialize(new Se(ee.Convert.FromHex(i)))})});break}case WS:t=new _e({iPAddress:e[1]});break;case f8:t=new _e({registeredID:e[1]});break;case YS:{t=new _e({otherName:new pc({typeId:mM,value:ne.serialize(bE.toASN(e[1]))})});break}case GS:t=new _e({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else ee.BufferSourceConverter.isBufferSource(e[0])?t=ne.parse(e[0],_e):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=KS,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=jS,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=WS,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=GS,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=f8,this.value=e.registeredID;else if(e.directoryName!=null)this.type=qS,this.value=new _o(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===pM){this.type=XS;let t=ne.parse(e.otherName.value,Se),n=new RegExp(hM,"i").exec(ee.Convert.ToHex(t));if(!n)throw new Error(LZ);this.value=n.slice(1).map((i,o)=>o<3?ee.Convert.ToHex(new Uint8Array(ee.Convert.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===mM)this.type=YS,this.value=ne.parse(e.otherName.value,pr).toString();else throw new Error(dM);else throw new Error(dM)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case qS:case KS:case XS:case WS:case f8:case YS:case GS:e=this.type.toUpperCase();break;case jS:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===f8&&(t=hs.toString(t)),new et(e,void 0,t)}},pa=class extends Dc{constructor(e){let t;if(e instanceof Nt)t=e;else if(Array.isArray(e)){let n=[];for(let i of e)if(i instanceof _e)n.push(i);else{let o=ne.parse(new ds(i.type,i.value).rawData,_e);n.push(o)}t=new Nt(n)}else if(ee.BufferSourceConverter.isBufferSource(e))t=ne.parse(e,Nt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){let t=[];for(let n of e){let i=null;try{i=new ds(n)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){let e=super.toTextObjectEmpty();for(let t of this.items){let n=t.toTextObject(),i=e[n[et.NAME]];Array.isArray(i)||(i=[],e[n[et.NAME]]=i),i.push(n)}return e}};pa.NAME="GeneralNames";var O0="-{5}",B0="\\n",BZ=`[^${B0}]+`,MZ=`${O0}BEGIN (${BZ}(?=${O0}))${O0}`,UZ=`${O0}END \\1${O0}`,gh="\\n",FZ=`[^:${B0}]+`,$Z=`(?:[^${B0}]+${gh}(?: +[^${B0}]+${gh})*)`,HZ="[a-zA-Z0-9=+/]+",VZ=`(?:${HZ}${gh})+`,gM=`${MZ}${gh}(?:((?:${FZ}: ${$Z})+))?${gh}?(${VZ})${UZ}`,Rn=class{static isPem(e){return typeof e=="string"&&new RegExp(gM,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");let t=new RegExp(gM,"g"),n=[],i=null;for(;i=t.exec(e);){let o=i[3].replace(new RegExp(`[${B0}]+`,"g"),""),s={type:i[1],headers:[],rawData:ee.Convert.FromBase64(o)},a=i[2];if(a){let c=a.split(new RegExp(gh,"g")),l=null;for(let u of c){let[f,h]=u.split(/:(.*)/);if(h===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=f.trim()}else l&&s.headers.push(l),l={key:f,value:h.trim()}}l&&s.headers.push(l)}n.push(s)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){let t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){let n=new Array;return t?e.forEach(i=>{if(!ee.BufferSourceConverter.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:ee.BufferSourceConverter.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(i))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:ee.BufferSourceConverter.toArrayBuffer(e)})}}static encodeStruct(e){var t;let n=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(let l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}let o=ee.Convert.ToBase64(e.rawData),s,a=0,c=Array();for(;a<o.length&&(o.length-a<64?s=o.substring(a):(s=o.substring(a,a+64),a+=64),s.length!==0);)if(c.push(s),s.length<64)break;return i.push(...c),i.push(`-----END ${n}-----`),i.join(`
`)}};Rn.CertificateTag="CERTIFICATE";Rn.CrlTag="CRL";Rn.CertificateRequestTag="CERTIFICATE REQUEST";Rn.PublicKeyTag="PUBLIC KEY";Rn.PrivateKeyTag="PRIVATE KEY";var Oc=class r extends Dc{static isAsnEncoded(e){return ee.BufferSourceConverter.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(Rn.isPem(e))return Rn.decode(e)[0];if(ee.Convert.isHex(e))return ee.Convert.FromHex(e);if(ee.Convert.isBase64(e))return ee.Convert.FromBase64(e);if(ee.Convert.isBase64Url(e))return ee.Convert.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{let t=ee.BufferSourceConverter.toUint8Array(e);if(t.length>0&&t[0]===48)return ee.BufferSourceConverter.toArrayBuffer(e);let n=ee.Convert.ToBinary(e);if(Rn.isPem(n))return Rn.decode(n)[0];if(ee.Convert.isHex(n))return ee.Convert.FromHex(n);if(ee.Convert.isBase64(n))return ee.Convert.FromBase64(n);if(ee.Convert.isBase64Url(n))return ee.Convert.FromBase64Url(n);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}}constructor(...e){r.isAsnEncoded(e[0])?super(r.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return Rn.encode(this.rawData,this.tag);default:return super.toString(e)}}},da=class r extends Oc{static async create(e,t=Lr.get()){if(e instanceof r)return e;if(L0.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");let n=await t.subtle.exportKey("spki",e);return new r(n)}else{if(e.publicKey)return e.publicKey;if(ee.BufferSourceConverter.isBufferSource(e))return new r(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Oc.isAsnEncoded(e)?super(e,Qr):super(e),this.tag=Rn.PublicKeyTag}async export(...e){let t,n=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,n=e[1]||n,t=e[2]||Lr.get()):t=e[0]||Lr.get();let o=this.rawData,s=ne.parse(this.rawData,Qr);return s.algorithm.algorithm===Ac&&(o=zZ(s,o)),t.subtle.importKey("spki",o,i,!0,n)}onInit(e){let t=kt.resolve($u),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case cs:{let i=ne.parse(e.subjectPublicKey,ch),o=ee.BufferSourceConverter.toUint8Array(i.modulus);n.publicExponent=ee.BufferSourceConverter.toUint8Array(i.publicExponent),n.modulusLength=(o[0]?o:o.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||Lr.get()):n=e[0]||Lr.get(),await n.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=Lr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=Lr.get();let i=ne.parse(this.rawData,Qr);return await t.subtle.digest(n,i.subjectPublicKey)}toTextObject(){let e=this.toTextObjectEmpty(),t=ne.parse(this.rawData,Qr);switch(e.Algorithm=ha.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Iu:e["EC Point"]=t.subjectPublicKey;break;case cs:default:e["Raw Data"]=t.subjectPublicKey}return e}};function zZ(r,e){return r.algorithm=new J({algorithm:cs,parameters:null}),e=ne.serialize(r),e}var y8=class r extends vi{static async create(e,t=!1,n=Lr.get()){if("name"in e&&"serialNumber"in e)return new r(e,t);let o=await(await da.create(e,n)).getKeyIdentifier(n);return new r(ee.Convert.ToHex(o),t)}constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){let t=new ns({keyIdentifier:new fu(ee.Convert.FromHex(e[0]))});super(k5,e[1],ne.serialize(t))}else{let t=e[0],n=t.name instanceof pa?ne.parse(t.name.rawData,Nt):t.name,i=new ns({authorityCertIssuer:n,authorityCertSerialNumber:ee.Convert.FromHex(t.serialNumber)});super(k5,e[1],ne.serialize(i))}}onInit(e){super.onInit(e);let t=ne.parse(e.extnValue,ns);t.keyIdentifier&&(this.keyId=ee.Convert.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ee.Convert.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ne.parse(this.value,ns);return t.authorityCertIssuer&&(e["Authority Issuer"]=new pa(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}};y8.NAME="Authority Key Identifier";var yh=class extends vi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ne.parse(this.value,du);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{let t=new du({cA:e[0],pathLenConstraint:e[1]});super(P5,e[2],ne.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}};yh.NAME="Basic Constraints";var yM;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(yM||(yM={}));var w8=class extends vi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ne.parse(this.value,N1);this.usages=t.map(n=>n)}else{let t=new N1(e[0]);super(N5,e[1],ne.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>hs.toString(t)).join(", "),e}};w8.NAME="Extended Key Usages";var wM;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(wM||(wM={}));var x8=class extends vi{constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ne.parse(this.value,$d);this.usages=t.toNumber()}else{let t=new $d(e[0]);super(L5,e[1],ne.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ne.parse(this.value,$d);return e[""]=t.toJSON().join(", "),e}};x8.NAME="Key Usages";var b8=class r extends vi{static async create(e,t=!1,n=Lr.get()){let o=await(await da.create(e,n)).getKeyIdentifier(n);return new r(ee.Convert.ToHex(o),t)}constructor(...e){if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ne.parse(this.value,Kn);this.keyId=ee.Convert.ToHex(t)}else{let t=typeof e[0]=="string"?ee.Convert.FromHex(e[0]):e[0],n=new Kn(t);super(WE,e[1],ne.serialize(n)),this.keyId=ee.Convert.ToHex(t)}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ne.parse(this.value,Kn);return e[""]=t,e}};b8.NAME="Subject Key Identifier";var v8=class extends vi{constructor(...e){ee.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(qE,e[1],new pa(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=ne.parse(e.extnValue,F5);this.names=new pa(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};v8.NAME="Subject Alternative Name";var Dn=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new vi(e),n=this.items.get(t.type);return n?new n(e):t}};Dn.items=new Map;var E8=class extends vi{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let n=ne.parse(this.value,k1);this.policies=n.map(i=>i.policyIdentifier)}else{let n=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,o=new k1(n.map(s=>new hu({policyIdentifier:s})));super(D5,i,ne.serialize(o)),this.policies=n}}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new et("",{},hs.toString(t))),e}};E8.NAME="Certificate Policies";Dn.register(D5,E8);var S8=class extends vi{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){let i=e[0].map(s=>new is({distributionPoint:new sa({fullName:[new _e({uniformResourceIdentifier:s})]})})),o=new yc(i);super(O5,e[1],ne.serialize(o))}else{let n=new yc(e[0]);super(O5,e[1],ne.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);let t=ne.parse(e.extnValue,yc);this.distributionPoints=t}toTextObject(){let e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;let i={};return t.distributionPoint&&(i[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(o=>new ds(o).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(o=>o.toString()).join(", ")),i}),e}};S8.NAME="CRL Distribution Points";var A8=class extends vi{constructor(...e){var t,n,i,o;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof uu){let s=new uu(e[0]);super(I5,e[1],ne.serialize(s))}else{let s=e[0],a=new uu;h8(a,s,IE,"ocsp"),h8(a,s,kE,"caIssuers"),h8(a,s,PE,"timeStamping"),h8(a,s,RE,"caRepository"),super(I5,e[1],ne.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(o=this.caRepository)!==null&&o!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ne.parse(e.extnValue,uu).forEach(n=>{switch(n.accessMethod){case IE:this.ocsp.push(new ds(n.accessLocation));break;case kE:this.caIssuers.push(new ds(n.accessLocation));break;case PE:this.timeStamping.push(new ds(n.accessLocation));break;case RE:this.caRepository.push(new ds(n.accessLocation));break}})}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ocsp.length&&d8(e,"OCSP",this.ocsp),this.caIssuers.length&&d8(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&d8(e,"Time Stamping",this.timeStamping),this.caRepository.length&&d8(e,"CA Repository",this.caRepository),e}};A8.NAME="Authority Info Access";function d8(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{let n=new et("");t.forEach((i,o)=>{let s=i.toTextObject(),a=`${s[et.NAME]} ${o+1}`,c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(s)}),r[e]=n}}function h8(r,e,t,n){let i=e[n];i&&(Array.isArray(i)?i:[i]).forEach(s=>{typeof s=="string"&&(s=new ds("url",s)),r.push(new ia({accessMethod:t,accessLocation:ne.parse(s.rawData,_e)}))})}var _8=class extends vi{constructor(...e){ee.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(HE,e[1],new pa(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=ne.parse(e.extnValue,Nt);this.names=new pa(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};_8.NAME="Issuer Alternative Name";var wh=class r extends Dc{constructor(...e){let t;if(ee.BufferSourceConverter.isBufferSource(e[0]))t=ee.BufferSourceConverter.toArrayBuffer(e[0]);else{let n=e[0],i=Array.isArray(e[1])?e[1].map(o=>ee.BufferSourceConverter.toArrayBuffer(o)):[];t=ne.serialize(new Yr({type:n,values:i}))}super(t,Yr)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new et("",{"":t})),e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty();return e[et.NAME]===r.NAME&&(e[et.NAME]=hs.toString(this.type)),e}};wh.NAME="Attribute";var C8=class extends wh{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=new u0({printableString:e[0]});super(VS,[ne.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){let t=ne.parse(this.values[0],u0);this.password=t.toString()}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[et.VALUE]=this.password,e}};C8.NAME="Challenge Password";var M0=class extends wh{constructor(...e){var t;if(ee.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=e[0],i=new xi;for(let o of n)i.push(ne.parse(o.rawData,Zr));super(d0,[ne.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){let t=ne.parse(this.values[0],xi);this.items=t.map(n=>Dn.create(ne.serialize(n)))}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(let n of t)e[n[et.NAME]]=n;return e}};M0.NAME="Extensions";var xh=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new wh(e),n=this.items.get(t.type);return n?new n(e):t}};xh.items=new Map;var F0="crypto.signatureFormatter",tA=class{toAsnSignature(e,t){return ee.BufferSourceConverter.toArrayBuffer(t)}toWebSignature(e,t){return ee.BufferSourceConverter.toArrayBuffer(t)}},m8,rA=m8=class{static createPssParams(e,t){let n=m8.getHashAlgorithm(e);return n?new ls({hashAlgorithm:n,maskGenAlgorithm:new J({algorithm:_c,parameters:ne.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){let t=kt.resolve($u);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new J({algorithm:nh,parameters:null});case"sha-256":return new J({algorithm:Q5,parameters:null});case"sha-384":return new J({algorithm:ih,parameters:null});case"sha-512":return new J({algorithm:oh,parameters:null})}}else return new J({algorithm:cs,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");let t=m8.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new J({algorithm:Ac,parameters:ne.serialize(t)})}else return new J({algorithm:Ac,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case cs:return{name:"RSASSA-PKCS1-v1_5"};case nh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case Q5:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case ih:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case oh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case Ac:if(e.parameters){let t=ne.parse(e.parameters,ls);return{name:"RSA-PSS",hash:kt.resolve($u).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};rA=m8=p([Tc()],rA);kt.registerSingleton(U0,rA);var nA=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new J({algorithm:Pu});case"sha-256":return new J({algorithm:Ru});case"sha-384":return new J({algorithm:Du});case"sha-512":return new J({algorithm:Ou})}return null}toWebAlgorithm(e){switch(e.algorithm){case Pu:return{name:"SHA-1"};case Ru:return{name:"SHA-256"};case Du:return{name:"SHA-384"};case Ou:return{name:"SHA-512"}}return null}};nA=p([Tc()],nA);kt.registerSingleton(U0,nA);var ma=class r{addPadding(e,t){let n=ee.BufferSourceConverter.toUint8Array(t),i=new Uint8Array(e);return i.set(n,e-n.length),i.buffer}removePadding(e,t=!1){let n=ee.BufferSourceConverter.toUint8Array(e);for(let i=0;i<n.length;i++)if(n[i]){n=n.slice(i);break}if(t&&n[0]>127){let i=new Uint8Array(n.length+1);return i.set(n,1),i.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){let n=e.namedCurve,i=r.namedCurveSize.get(n)||r.defaultNamedCurveSize,o=new ku,s=ee.BufferSourceConverter.toUint8Array(t);return o.r=this.removePadding(s.slice(0,i),!0),o.s=this.removePadding(s.slice(i,i+i),!0),ne.serialize(o)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){let n=ne.parse(t,ku),i=e.namedCurve,o=r.namedCurveSize.get(i)||r.defaultNamedCurveSize,s=this.addPadding(o,this.removePadding(n.r)),a=this.addPadding(o,this.removePadding(n.s));return(0,ee.combine)(s,a)}return null}};ma.namedCurveSize=new Map;ma.defaultNamedCurveSize=32;var QS="1.3.101.110",xM="1.3.101.111",ZS="1.3.101.112",bM="1.3.101.113",iA=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=ZS;break;case"x25519":t=QS;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=ZS;break;case"ed448":t=bM;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=QS;break;case"x448":t=xM;break}}return t?new J({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case ZS:return{name:"Ed25519"};case bM:return{name:"EdDSA",namedCurve:"Ed448"};case QS:return{name:"X25519"};case xM:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};iA=p([Tc()],iA);kt.registerSingleton(U0,iA);var m0,g0,y0,w0,x0,b0,v0,ph,oA=class extends Oc{get subjectName(){return Le(this,g0,"f")||Ot(this,g0,new _o(this.asn.certificationRequestInfo.subject),"f"),Le(this,g0,"f")}get subject(){return Le(this,y0,"f")||Ot(this,y0,this.subjectName.toString(),"f"),Le(this,y0,"f")}get signatureAlgorithm(){if(!Le(this,w0,"f")){let e=kt.resolve($u);Ot(this,w0,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return Le(this,w0,"f")}get signature(){return Le(this,x0,"f")||Ot(this,x0,this.asn.signature,"f"),Le(this,x0,"f")}get publicKey(){return Le(this,b0,"f")||Ot(this,b0,new da(this.asn.certificationRequestInfo.subjectPKInfo),"f"),Le(this,b0,"f")}get attributes(){return Le(this,v0,"f")||Ot(this,v0,this.asn.certificationRequestInfo.attributes.map(e=>xh.create(ne.serialize(e))),"f"),Le(this,v0,"f")}get extensions(){if(!Le(this,ph,"f")){Ot(this,ph,[],"f");let e=this.getAttribute(d0);e instanceof M0&&Ot(this,ph,e.items,"f")}return Le(this,ph,"f")}get tbs(){return Le(this,m0,"f")||Ot(this,m0,this.asn.certificationRequestInfoRaw||ne.serialize(this.asn.certificationRequestInfo),"f"),Le(this,m0,"f")}constructor(e){let t=Oc.isAsnEncoded(e)?[e,Rc]:[e];super(t[0],t[1]),m0.set(this,void 0),g0.set(this,void 0),y0.set(this,void 0),w0.set(this,void 0),x0.set(this,void 0),b0.set(this,void 0),v0.set(this,void 0),ph.set(this,void 0),this.tag=Rn.CertificateRequestTag}onInit(e){}getAttribute(e){for(let t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(let t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=Lr.get()){let t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),i=kt.resolveAll(F0).reverse(),o=null;for(let a of i)if(o=a.toWebSignature(t,this.signature),o)break;if(!o)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,o,this.tbs)}toTextObject(){let e=this.toTextObjectEmpty(),t=ne.parse(this.rawData,Rc),n=t.certificationRequestInfo,i=new et("",{Version:`${os[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){let o=new et("");for(let s of this.attributes){let a=s.toTextObject();o[a[et.NAME]]=a}i.Attributes=o}return e.Data=i,e.Signature=new et("",{Algorithm:ha.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}};m0=new WeakMap,g0=new WeakMap,y0=new WeakMap,w0=new WeakMap,x0=new WeakMap,b0=new WeakMap,v0=new WeakMap,ph=new WeakMap;oA.NAME="PKCS#10 Certificate Request";var E0,S0,A0,_0,C0,T0,I0,k0,P0,R0,mh,D0,bh=class extends Oc{get publicKey(){return Le(this,D0,"f")||Ot(this,D0,new da(this.asn.tbsCertificate.subjectPublicKeyInfo),"f"),Le(this,D0,"f")}get serialNumber(){if(!Le(this,S0,"f")){let e=this.asn.tbsCertificate,t=new Uint8Array(e.serialNumber);t.length>1&&t[0]===0&&t[1]>127&&(t=t.slice(1)),Ot(this,S0,ee.Convert.ToHex(t),"f")}return Le(this,S0,"f")}get subjectName(){return Le(this,A0,"f")||Ot(this,A0,new _o(this.asn.tbsCertificate.subject),"f"),Le(this,A0,"f")}get subject(){return Le(this,_0,"f")||Ot(this,_0,this.subjectName.toString(),"f"),Le(this,_0,"f")}get issuerName(){return Le(this,C0,"f")||Ot(this,C0,new _o(this.asn.tbsCertificate.issuer),"f"),Le(this,C0,"f")}get issuer(){return Le(this,T0,"f")||Ot(this,T0,this.issuerName.toString(),"f"),Le(this,T0,"f")}get notBefore(){if(!Le(this,I0,"f")){let e=this.asn.tbsCertificate.validity.notBefore.utcTime||this.asn.tbsCertificate.validity.notBefore.generalTime;if(!e)throw new Error("Cannot get 'notBefore' value");Ot(this,I0,e,"f")}return Le(this,I0,"f")}get notAfter(){if(!Le(this,k0,"f")){let e=this.asn.tbsCertificate.validity.notAfter.utcTime||this.asn.tbsCertificate.validity.notAfter.generalTime;if(!e)throw new Error("Cannot get 'notAfter' value");Ot(this,k0,e,"f")}return Le(this,k0,"f")}get signatureAlgorithm(){if(!Le(this,P0,"f")){let e=kt.resolve($u);Ot(this,P0,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return Le(this,P0,"f")}get signature(){return Le(this,R0,"f")||Ot(this,R0,this.asn.signatureValue,"f"),Le(this,R0,"f")}get extensions(){return Le(this,mh,"f")||(Ot(this,mh,[],"f"),this.asn.tbsCertificate.extensions&&Ot(this,mh,this.asn.tbsCertificate.extensions.map(e=>Dn.create(ne.serialize(e))),"f")),Le(this,mh,"f")}get tbs(){return Le(this,E0,"f")||Ot(this,E0,this.asn.tbsCertificateRaw||ne.serialize(this.asn.tbsCertificate),"f"),Le(this,E0,"f")}constructor(e){let t=Oc.isAsnEncoded(e)?[e,Hi]:[e];super(t[0],t[1]),E0.set(this,void 0),S0.set(this,void 0),A0.set(this,void 0),_0.set(this,void 0),C0.set(this,void 0),T0.set(this,void 0),I0.set(this,void 0),k0.set(this,void 0),P0.set(this,void 0),R0.set(this,void 0),mh.set(this,void 0),D0.set(this,void 0),this.tag=Rn.CertificateTag}onInit(e){}getExtension(e){for(let t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=Lr.get()){let n,i,o=e.publicKey;try{if(!o)n={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(n,["verify"],t);else if("publicKey"in o)n={...o.publicKey.algorithm,...this.signatureAlgorithm},i=await o.publicKey.export(n,["verify"],t);else if(o instanceof da)n={...o.algorithm,...this.signatureAlgorithm},i=await o.export(n,["verify"],t);else if(ee.BufferSourceConverter.isBufferSource(o)){let l=new da(o);n={...l.algorithm,...this.signatureAlgorithm},i=await l.export(n,["verify"],t)}else n={...o.algorithm,...this.signatureAlgorithm},i=o}catch{return!1}let s=kt.resolveAll(F0).reverse(),a=null;for(let l of s)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");let c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{let u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=Lr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=Lr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){let e=this.toTextObjectEmpty(),t=ne.parse(this.rawData,Hi),n=t.tbsCertificate,i=new et("",{Version:`${os[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":ha.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new et("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(i["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(i["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){let o=new et("");for(let s of this.extensions){let a=s.toTextObject();o[a[et.NAME]]=a}i.Extensions=o}return e.Data=i,e.Signature=new et("",{Algorithm:ha.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}};E0=new WeakMap,S0=new WeakMap,A0=new WeakMap,_0=new WeakMap,C0=new WeakMap,T0=new WeakMap,I0=new WeakMap,k0=new WeakMap,P0=new WeakMap,R0=new WeakMap,mh=new WeakMap,D0=new WeakMap;bh.NAME="Certificate";function KZ(r,e=Lr.get()){let t=ee.BufferSourceConverter.toUint8Array(ee.Convert.FromHex(r||"")),n=t&&t.length&&t.some(o=>o>0)?new Uint8Array(t):void 0;n||(n=e.getRandomValues(new Uint8Array(16)));let i=0;for(;i<n.length-1&&n[i]===0;)i++;if(n=n.slice(i),n[0]>127){let o=new Uint8Array(n.length+1);o[0]=0,o.set(n,1),n=o}return n.buffer}var T8=class{static async createSelfSigned(e,t=Lr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=Lr.get()){var n;let i;e.publicKey instanceof da?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:ee.BufferSourceConverter.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);let o=KZ(e.serialNumber),s=e.notBefore||new Date,a=e.notAfter||new Date(s.getTime()+31536e6),c=new Hi({tbsCertificate:new Jr({version:os.v3,serialNumber:o,validity:new aa({notBefore:s,notAfter:a}),extensions:new xi(((n=e.extensions)===null||n===void 0?void 0:n.map(w=>ne.parse(w.rawData,Zr)))||[]),subjectPublicKeyInfo:ne.parse(i,Qr)})});if(e.subject){let w=e.subject instanceof _o?e.subject:new _o(e.subject);c.tbsCertificate.subject=ne.parse(w.toArrayBuffer(),wt)}if(e.issuer){let w=e.issuer instanceof _o?e.issuer:new _o(e.issuer);c.tbsCertificate.issuer=ne.parse(w.toArrayBuffer(),wt)}let l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},f=kt.resolve($u);c.tbsCertificate.signature=c.signatureAlgorithm=f.toAsnAlgorithm(u);let h=ne.serialize(c.tbsCertificate),d="signingKey"in e?await t.subtle.sign(u,e.signingKey,h):e.signature,m=kt.resolveAll(F0).reverse(),y=null;for(let w of m)if(y=w.toAsnSignature(u,d),y)break;if(!y)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=y,new bh(ne.serialize(c))}},qZ,jZ,WZ,GZ,XZ,vM;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(vM||(vM={}));qZ=new WeakMap,jZ=new WeakMap,WZ=new WeakMap,GZ=new WeakMap,XZ=new WeakMap;var YZ,QZ,ZZ,JZ,eJ,tJ,rJ;YZ=new WeakMap,QZ=new WeakMap,ZZ=new WeakMap,JZ=new WeakMap,eJ=new WeakMap,tJ=new WeakMap,rJ=new WeakMap;Dn.register(P5,yh);Dn.register(N5,w8);Dn.register(L5,x8);Dn.register(WE,b8);Dn.register(k5,y8);Dn.register(qE,v8);Dn.register(O5,S8);Dn.register(I5,A8);Dn.register(HE,_8);xh.register(VS,C8);xh.register(d0,M0);kt.registerSingleton(F0,tA);kt.registerSingleton(F0,ma);ma.namedCurveSize.set("P-256",32);ma.namedCurveSize.set("K-256",32);ma.namedCurveSize.set("P-384",48);ma.namedCurveSize.set("P-521",66);var I8=class extends Ce{async listen(){throw new b5("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}};var sA=Object.values(Qc).map(r=>r.decoder).reduce((r,e)=>r.or(e)),nJ=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function CM(r){return r?.match(nJ)?.groups?.fingerprint}function aA(r){let t=r.getComponents().find(n=>n.code===466)?.value;if(t===void 0||t==="")throw new O(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function iJ(r){return At.decode(sA.decode(r))}function oJ(r){let e=iJ(aA(r)),t=sJ(e.code),n=e.digest.reduce((o,s)=>o+s.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw new x5(n,r.toString());return`${t} ${i.join(":").toUpperCase()}`}function TM(r){let e=r.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),n=mn(ze.code,t);return se(`/certhash/${Yc.encode(n.bytes)}`)}function sJ(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new v5(r)}}function IM(r,e){let{host:t,port:n,type:i}=Te(r);if(i!=="ip4"&&i!=="ip6")throw new O(`Multiaddr ${r} was not an IPv4 or IPv6 address`);let o=oJ(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i==="ip4"?4:6} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i==="ip4"?4:6} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${o}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${Md}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function kM(r,e){let{host:t,port:n,type:i}=Te(r);if(i!=="ip4"&&i!=="ip6")throw new O(`Multiaddr ${r} was not an IPv4 or IPv6 address`);return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i==="ip4"?4:6} ${t}
s=-
c=IN IP${i==="ip4"?4:6} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${Md}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function cA(r,e){if(r.sdp===void 0)throw new O("Can't munge a missing SDP");let t=r.sdp.includes(`\r
`)?`\r
`:`
`;try{r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t)}catch{}return r}var lA=R("libp2p-webrtc-noise:");function RM(r,e,t){let n=r.trim().toLowerCase().replaceAll(":",""),i=R(n,"hex"),o=mn(ze.code,i),s=sA.decode(aA(e)),a=lA.byteLength+o.bytes.byteLength+s.byteLength;return t==="server"?it([lA,s,o.bytes],a):it([lA,o.bytes,s],a)}var aJ=g5?"iceconnectionstatechange":"connectionstatechange";function cJ(r,e){return r.role==="server"}async function DM(r,e,t,n){let i=r.createDataChannel("",{negotiated:!0,id:0});try{if(n.role==="client"){n.log.trace("client creating local offer");let f=await r.createOffer();n.log.trace("client created local offer %s",f.sdp);let h=cA(f,t);n.log.trace("client setting local offer %s",h.sdp),await r.setLocalDescription(h);let d=IM(n.remoteAddr,t);n.log.trace("client setting server description %s",d.sdp),await r.setRemoteDescription(d)}else{let f=kM(n.remoteAddr,t);n.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),n.log.trace("server creating local answer");let h=await r.createAnswer();n.log.trace("server created local answer");let d=cA(h,t);n.log.trace("server setting local description %s",h.sdp),await r.setLocalDescription(d)}if(i.readyState!=="open"&&(n.log.trace("%s wait for handshake channel to open, starting status %s",n.role,i.readyState),await st(i,"open",n)),n.log.trace("%s handshake channel opened",n.role),cJ(n,r)){let f=r.remoteFingerprint()?.value??"";n.remoteAddr=n.remoteAddr.encapsulate(TM(f))}let o=CM(r.localDescription?.sdp);if(o==null)throw new uc("Could not get fingerprint from local description sdp");n.log.trace("%s performing noise handshake",n.role);let s=RM(o,n.remoteAddr,n.role),a=E6({prologueBytes:s})(n),c=b1({channel:i,direction:"outbound",isHandshake:!0,log:n.log,...n.dataChannel??{}}),l=v1({peerConnection:r,remoteAddr:n.remoteAddr,metrics:n.events,direction:n.role==="client"?"outbound":"inbound",log:n.logger.forComponent("libp2p:webrtc-direct:connection")});if(r.addEventListener(aJ,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":l.close().catch(f=>{n.log.error("error closing connection - %e",f),l.abort(f)});break;default:break}}),n.events?.increment({peer_connection:!0}),n.role==="client"){n.log.trace("%s secure inbound",n.role);let f=await a.secureInbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});return n.log.trace("%s upgrade outbound",n.role),await n.upgrader.upgradeOutbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:f.remotePeer,muxerFactory:e,signal:n.signal})}n.log.trace("%s secure outbound",n.role);let u=await a.secureOutbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});l.remoteAddr=l.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),n.log.trace("%s upgrade inbound",n.role),await n.upgrader.upgradeInbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:u.remotePeer,muxerFactory:e,signal:n.signal})}catch(o){throw i.close(),r.close(),o}}async function OM(r,e,t={}){let n=t.certificate;n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));let i=typeof t.rtcConfiguration=="function"?await t.rtcConfiguration():t.rtcConfiguration,o=new RTCPeerConnection({...i??{},certificates:[n]}),s=new lc({peerConnection:o,metrics:t.events,dataChannelOptions:t.dataChannel});return{peerConnection:o,muxerFactory:s}}async function NM(r){let e=await jg(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...K(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var k8=class{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new Ce,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new O("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[Ea]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[Ge]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n,i=e.getComponents().findLast(c=>c.code===421)?.value;i!=null&&(n=tt(i));let o=dL(),{peerConnection:s,muxerFactory:a}=await OM("client",o,{rtcConfiguration:typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{},dataChannel:this.init.dataChannel});try{return await DM(s,a,o,{role:"client",log:this.log,logger:this.components.logger,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeer:n,privateKey:this.components.privateKey})}catch(c){throw s.close(),c}}createListener(e){if(this.certificate==null)throw new ri;return new I8(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(Qp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(lJ(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;let t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await NM(t),pem:n,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;let e=this.init.certificateKeychainName??iL,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new je;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await Oa("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n,i=new lt(this.init.certificateDatastoreKey??nL),o=await jg(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new je;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(i,o)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(i,o)}let s=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??hE)-Date.now();return s<0&&(s=100),this.log("will renew TLS certificate after %d ms",s),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},s),{pem:n.toString("pem"),certhash:Yc.encode((await ze.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){let n=await this.components.datastore.get(e),i=new bh(n),o=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??hE);if(Date.now()>o)throw this.log("stored TLS certificate has expired"),new je;this.log("loaded certificate, expires in %d ms",o);let s=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",s),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!me(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new je;return this.log("loaded certificate, expiry time is %o",o),i}async createCertificate(e,t){let n=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??oL));n.setMilliseconds(0),i.setMilliseconds(0);let o=await T8.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:i,keys:t,extensions:[new yh(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,R(o.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),o}getKeychain(){try{return this.components.keychain}catch{}}};function lJ(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function P8(r){return e=>new k8(e,r)}function LM(r){return e=>new _5(e,r)}function BM(){throw new Error("WebSocket Servers can not be created in the browser!")}var uJ=1024*1024*4,fJ=10,uA=class extends Fa{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??uJ,this.checkBufferedAmountTask=Ka(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??fJ),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=R(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(let n of e)this.websocket.send(n);let t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}};function MM(r){return new uA(r)}var fA=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Ea]=!0;[Symbol.toStringTag]="@libp2p/websockets";[Ge]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let n=MM({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);let i=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();let n=tc(e);this.log("create websocket connection to %s",n);let i=new WebSocket(n);i.binaryType="arraybuffer";try{t.onProgress?.(new G("websockets:open-connection")),await st(i,"open",t)}catch(o){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new ef(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{i.close()}catch{}throw o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return BM({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>Hs.exactMatch(t)||kl.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}};function R8(r={}){return e=>new fA(e,r)}var UM="6.0.8",FM="helia";var $M={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function Hu(r={}){let e=`${FM}/${UM} ${q4()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[XO(),LM(),P8(),R8()],connectionEncrypters:[E6()],streamMuxers:[OO(),jN()],peerDiscovery:[UO($M)],services:{autoNAT:MO(),dcutr:ZO(),delegatedRouting:()=>t4("https://delegated-ipfs.dev",N9()),dht:fP({clientMode:!0,validators:{ipns:gl},selectors:{ipns:g2}}),identify:$N(),identifyPush:HN(),keychain:m6(r.keychain),ping:QN(),http:l5()}}}async function HM(r){let e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await bv(r.datastore,r.keychain));let t=Hu(e);return t.datastore=t.datastore??r.datastore,await j4({...t,...e,start:!1})}async function VM(r={}){let e=r.datastore??new Hl,t=r.blockstore??new Cm,n;return iD(r.libp2p)?n=r.libp2p:n=await HM({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[Em(),vm()],routers:r.routers??[_m(n),Am()],metrics:n.metrics}}async function D8(r={}){let e=await VM(r),t=new H3(e);return e.start!==!1&&await t.start(),t}function zM(){let r=Hu();r.start=!1,r.addresses={listen:[]},r.transports=[P8(),R8()],r.peerDiscovery=[];let e={dcutr:r.services.dcutr,identify:r.services.identify,keychain:r.services.keychain,ping:r.services.ping};return{...r,start:!1,services:e}}var Nc=class extends Map{#e=0;#t=new Map;#r=new Map;#n;#i;#o;constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.#n=e.maxSize,this.#i=e.maxAge||Number.POSITIVE_INFINITY,this.#o=e.onEviction}get __oldCache(){return this.#r}#c(e){if(typeof this.#o=="function")for(let[t,n]of e)this.#o(t,n.value)}#a(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.#o=="function"&&this.#o(e,t.value),this.delete(e)):!1}#d(e,t){if(this.#a(e,t)===!1)return t.value}#u(e,t){return t.expiry?this.#d(e,t):t.value}#f(e,t){let n=t.get(e);return this.#u(e,n)}#s(e,t){this.#t.set(e,t),this.#e++,this.#e>=this.#n&&(this.#e=0,this.#c(this.#r),this.#r=this.#t,this.#t=new Map)}#m(e,t){this.#r.delete(e),this.#s(e,t)}*#l(){for(let e of this.#r){let[t,n]=e;this.#t.has(t)||this.#a(t,n)===!1&&(yield e)}for(let e of this.#t){let[t,n]=e;this.#a(t,n)===!1&&(yield e)}}get(e){if(this.#t.has(e)){let t=this.#t.get(e);return this.#u(e,t)}if(this.#r.has(e)){let t=this.#r.get(e);if(this.#a(e,t)===!1)return this.#m(e,t),t.value}}set(e,t,{maxAge:n=this.#i}={}){let i=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;return this.#t.has(e)?this.#t.set(e,{value:t,expiry:i}):this.#s(e,{value:t,expiry:i}),this}has(e){return this.#t.has(e)?!this.#a(e,this.#t.get(e)):this.#r.has(e)?!this.#a(e,this.#r.get(e)):!1}peek(e){if(this.#t.has(e))return this.#f(e,this.#t);if(this.#r.has(e))return this.#f(e,this.#r)}expiresIn(e){let t=this.#t.get(e)??this.#r.get(e);if(t)return t.expiry?t.expiry-Date.now():Number.POSITIVE_INFINITY}delete(e){let t=this.#t.delete(e);return t&&this.#e--,this.#r.delete(e)||t}clear(){this.#t.clear(),this.#r.clear(),this.#e=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");let t=[...this.#l()],n=t.length-e;n<0?(this.#t=new Map(t),this.#r=new Map,this.#e=t.length):(n>0&&this.#c(t.slice(0,n)),this.#r=new Map(t.slice(n)),this.#t=new Map,this.#e=0),this.#n=e}evict(e=1){let t=Number(e);if(!t||t<=0)return;let n=[...this.#l()],i=Math.trunc(Math.min(t,Math.max(n.length-1,0)));i<=0||(this.#c(n.slice(0,i)),this.#r=new Map(n.slice(i)),this.#t=new Map,this.#e=0)}*keys(){for(let[e]of this)yield e}*values(){for(let[,e]of this)yield e}*[Symbol.iterator](){for(let e of this.#t){let[t,n]=e;this.#a(t,n)===!1&&(yield[t,n.value])}for(let e of this.#r){let[t,n]=e;this.#t.has(t)||this.#a(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.#t];for(let t=e.length-1;t>=0;--t){let n=e[t],[i,o]=n;this.#a(i,o)===!1&&(yield[i,o.value])}e=[...this.#r];for(let t=e.length-1;t>=0;--t){let n=e[t],[i,o]=n;this.#t.has(i)||this.#a(i,o)===!1&&(yield[i,o.value])}}*entriesAscending(){for(let[e,t]of this.#l())yield[e,t.value]}get size(){if(!this.#e)return this.#r.size;let e=0;for(let t of this.#r.keys())this.#t.has(t)||e++;return Math.min(this.#e+e,this.#n)}get maxSize(){return this.#n}get maxAge(){return this.#i}entries(){return this.entriesAscending()}forEach(e,t=this){for(let[n,i]of this.entriesAscending())e.call(t,i,n,this)}get[Symbol.toStringTag](){return"QuickLRU"}toString(){return`QuickLRU(${this.size}/${this.maxSize})`}[Symbol.for("nodejs.util.inspect.custom")](){return this.toString()}};var O8=class extends Error{static name="DNSLinkNotFoundError";constructor(e="DNSLink not found"){super(e),this.name="DNSLinkNotFoundError"}},vh=class extends Error{static name="InvalidNamespaceError";constructor(e="Invalid namespace"){super(e),this.name="InvalidNamespaceError"}};var KM=(r,e)=>{let[,t,n,...i]=r.split("/");if(t!=="ipfs")throw new vh(`Namespace ${t} was not "ipfs"`);return{namespace:"ipfs",cid:j.parse(n),path:i.length>0?`/${i.join("/")}`:"",answer:e}};var qM=(r,e)=>{let[,t,n,...i]=r.split("/");if(t!=="ipns")throw new vh(`Namespace ${t} was not "ipns"`);return{namespace:"ipns",peerId:tt(n),path:i.length>0?`/${i.join("/")}`:"",answer:e}};var N8=class{dns;log;namespaces;cache;cacheMaxAnswers;constructor(e,t={}){this.dns=e.dns,this.log=e.logger.forComponent("helia:dnslink"),this.namespaces={ipfs:KM,ipns:qM,...t.namespaces},this.cache=new Nc({maxSize:t.cacheSize??1e3,maxAge:t.cacheMaxAge??3e4}),this.cacheMaxAnswers=t.cacheMaxAnswers??10}async resolve(e,t={}){if(t.nocache!==!0){let s=this.cache.get(e);if(s!=null){let a=[...s.values()];if(a.length>0)return a}}let n=await this.recursiveResolveDomain(e,t.maxRecursiveDepth??CP,t),i=new Nc({maxSize:this.cacheMaxAnswers});n.forEach((s,a)=>{i.set(a,s,{maxAge:s.answer.TTL*1e3})});let o=n.reduce((s,a)=>{let c=a.answer.TTL*1e3;return c>s?c:s},0);return this.cache.maxAge<o&&(o=this.cache.maxAge),this.cache.set(e,i,{maxAge:o}),n}async recursiveResolveDomain(e,t,n={}){if(t===0)throw new Error("recursion limit exceeded");e.startsWith("_dnslink.")||(e=`_dnslink.${e}`);try{return await this.recursiveResolveDnslink(e,t,n)}catch(i){if(i.code!=="ENOTFOUND"&&i.code!=="ENODATA"&&i.name!=="DNSLinkNotFoundError"&&i.name!=="NotFoundError")throw i;return e.startsWith("_dnslink.")?e=e.replace("_dnslink.",""):e=`_dnslink.${e}`,this.recursiveResolveDnslink(e,t,n)}}async recursiveResolveDnslink(e,t,n={}){if(t===0)throw new Error("recursion limit exceeded");this.log("query %s for TXT and CNAME records",e);let o=((await this.dns.query(e,{...n,types:[dn.TXT]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));this.log("found %d TXT records for %s",o.length,e);let s=[];for(let l of o)try{let u=l.data;if(u.startsWith('"')&&u.endsWith('"')&&(u=u.substring(1,u.length-1)),!u.startsWith("dnslink="))continue;this.log("%s TXT %s",l.name,u),u=u.replace("dnslink=","");let[,f,h]=u.split("/");if(f==="dnslink")return await this.recursiveResolveDomain(h,t-1,n);let d=this.namespaces[f];if(d==null){this.log('unknown protocol "%s" in DNSLink record for domain: %s',f,e);continue}s.push(d(u,l))}catch(u){this.log.error("could not parse DNS link record for domain %s, %s - %e",e,l.data,u)}if(s.length>0)return s;this.log("no DNSLink records found for %s, falling back to CNAME",e);let c=((await this.dns.query(e,{...n,types:[dn.CNAME]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));this.log("found %d CNAME records for %s",c.length,e);for(let l of c)try{return await this.recursiveResolveDomain(l.data,t-1,n)}catch(u){this.log.error("domain %s cname %s had no DNSLink records - %e",e,l.data,u)}throw new O8(`No DNSLink records found for domain: ${e}`)}};function jM(r,e={}){return new N8(r,e)}var Br=class extends Error{static name="InvalidRangeError";constructor(e="Invalid range request"){super(e),this.name="InvalidRangeError"}},L8=class extends Error{static name="NoContentError";constructor(e="No content found"){super(e),this.name="NoContentError"}},B8=class extends Error{static name="SubdomainNotSupportedError";constructor(e="Subdomain not supported"){super(e),this.name="SubdomainNotSupportedError"}};function WM(r,e){if(r==null)return;if(r instanceof Headers)return r.get(e)??void 0;if(Array.isArray(r))return r.find(([i])=>i.toLowerCase()===e.toLowerCase())?.[1];let t=Object.keys(r).find(n=>n.toLowerCase()===e.toLowerCase());if(t!=null)return r[t]}function GM(r,e,t){if((r??0)>(e??1/0))throw new Br("Invalid range: Range-start index is greater than range-end index.");if(r!=null&&(e??0)>=(t??1/0))throw new Br("Invalid range: Range-end index is greater than or equal to the size of the file.");if(r==null&&(e??0)>(t??1/0))throw new Br("Invalid range: Range-end index is greater than the size of the file.");if(r!=null&&r<0)throw new Br("Invalid range: Range-start index cannot be negative.");if(r!=null&&e!=null)return{byteSize:e-r+1,start:r,end:e};if(r==null&&e!=null)return t==null?{end:e}:e===t?{byteSize:t,start:0,end:t-1}:{byteSize:e,start:t-e,end:t-1};if(r!=null&&e==null){if(t==null)return{start:r};let n=t-1;return{byteSize:t-r,start:r,end:n}}return{byteSize:t,start:0,end:t!=null?t-1:0}}function XM({ttl:r,protocol:e,response:t}){if(t.headers.has("cache-control"))return;let n;e==="ipfs"?n="public, max-age=29030400, immutable":r==null?n="public, max-age=300":n=`public, max-age=${r}`,t.headers.set("cache-control",n)}function M8({byteStart:r,byteEnd:e,byteSize:t}){let n=t??"*";if((e??0)>=(t??1/0))throw new Br("Invalid range: Range-end index is greater than or equal to the size of the file.");if((r??0)>=(t??1/0))throw new Br("Invalid range: Range-start index is greater than or equal to the size of the file.");if(r!=null&&e==null)return t==null?`bytes */${n}`:`bytes ${r}-${t-1}/${t}`;if(r==null&&e!=null){if(t==null)return`bytes */${n}`;let i=t-1;return`bytes ${i-e+1}-${i}/${t}`}return r==null&&e==null?`bytes */${n}`:`bytes ${r}-${e}/${n}`}function U8(r,e){e!=null&&r.headers.set("X-Ipfs-Roots",dJ(e))}function dJ(r){return r.map(e=>e.toV1().toString()).join(",")}function hJ(r){return typeof r=="string"?r.length:r instanceof ArrayBuffer||r instanceof Uint8Array?r.byteLength:r instanceof Blob?r.size:(r instanceof ReadableStream,null)}function pJ(r){if(!r.startsWith("bytes="))throw new Br("Invalid range request");let t=r.substring(6).split(",").map(i=>i.trim()),n=[];for(let i of t){let o=i.match(/^(?<start>\d+)?-(?<end>\d+)?$/);if(o?.groups==null)throw new Br(`Invalid range specification: ${i}`);let{start:s,end:a}=o.groups;n.push({start:s??null,end:a??null})}if(n.length===0)throw new Br("No valid ranges found");return{ranges:n}}var F8=class{headers;isRangeRequest;_fileSize;_body=null;rangeRequestHeader;log;multiPartBoundary;requestRanges=[];byteRanges=[];isMultiRangeRequest=!1;_isValidRangeRequest=!1;constructor(e,t){if(this.headers=t,this.log=e.newScope("byte-range-context"),this.rangeRequestHeader=WM(this.headers,"Range"),this.rangeRequestHeader!=null){this.isRangeRequest=!0,this.log.trace("range request detected");try{let{ranges:n}=pJ(this.rangeRequestHeader);this.isMultiRangeRequest=n.length>1,this.requestRanges=n.map(i=>({start:i.start!=null?parseInt(i.start):null,end:i.end!=null?parseInt(i.end):null})),this.multiPartBoundary=`multipart_byteranges_${Math.floor(Math.random()*1e9)}`}catch(n){this.log.error("error parsing range request header - %e",n),this.requestRanges=[]}this.setOffsetDetails()}else this.log.trace("no range request detected"),this.isRangeRequest=!1}getByteRanges(){return this.byteRanges}setBody(e,t="application/octet-stream"){typeof e=="function"?this._body=this.createRangeStream(e,t):(this._body=e,this.setFileSize(this._fileSize??hJ(e))),this.log.trace("set request body with fileSize %o",this._fileSize)}getBody(e){let t=this._body;if(t==null)return this.log.trace("body is null"),t;if(!this.isRangeRequest||!this.isValidRangeRequest)return this.log.trace("returning body unmodified for non-range, or invalid range, request"),t;if(this.isMultiRangeRequest)return this._body instanceof ReadableStream?this._body:na(this.getMultipartBody(e));if(this.byteRanges.length>0){let n=this.byteRanges[0];return t instanceof ReadableStream?t:((n.start!=null||n.end!=null)&&this.log.trace("returning body with byteStart=%o, byteEnd=%o, byteSize=%o",n.start,n.end,n.size),this.getSlicedBody(t,n))}return this.log.error("returning unmodified body for valid range request"),t}getSlicedBody(e,t){let n=t.start??0,i;return t.end!=null&&t.start!=null?i=t.end-t.start+1:i=void 0,this.log.trace("slicing body with offset=%o and length=%o",n,i),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(n,i!==void 0?n+i:void 0):e}setFileSize(e){this._fileSize=e!=null?Number(e):null,this._isValidRangeRequest=!1,this.log.trace("set _fileSize to %o",this._fileSize),this.setOffsetDetails()}getFileSize(){return this._fileSize}isValidByteStart(e,t){return!(e!=null&&(e<0||this._fileSize!=null&&e>=this._fileSize||t!=null&&e>t))}isValidByteEnd(e,t){if(t!=null){if(t<0)return this.log.trace("invalid range request, byteEnd is less than 0"),!1;if(this._fileSize!=null&&t>=this._fileSize)return this.log.trace("invalid range request, byteEnd is greater than fileSize"),!1;if(e!=null&&t<e)return this.log.trace("invalid range request, byteEnd is less than byteStart"),!1}return!0}isValidByteRange(e){return this.log.trace("validating byte range: %o",e),e.start!=null&&!this.isValidByteStart(e.start,e.end)?(this.log.trace("invalid range request, byteStart is less than 0 or greater than fileSize"),!1):e.end!=null&&!this.isValidByteEnd(e.start,e.end)?(this.log.trace("invalid range request, byteEnd is less than 0 or greater than fileSize"),!1):!0}get isValidRangeRequest(){return this._isValidRangeRequest?!0:this.isRangeRequest?this.byteRanges.length===0?(this.log.trace("invalid range request, no valid ranges"),!1):this.byteRanges.every(t=>this.isValidByteRange(t))?(this._isValidRangeRequest=!0,!0):(this.log.trace("invalid range request, not all ranges are valid"),!1):!1}getLength(e){if(!this.isValidRangeRequest){this.log.error("cannot get length for invalid range request");return}if(!(this.isMultiRangeRequest&&e==null))return e??=this.byteRanges[0],this.log.trace("getting length for range: %o",e),e.end!=null&&e.start!=null?e.end-e.start+1:e.end!=null?e.end+1:e.size}setOffsetDetails(){if(this.requestRanges.length===0){this.log.trace("no request ranges defined");return}try{this.byteRanges=this.requestRanges.map(e=>{let{start:t,end:n,byteSize:i}=GM(e.start??void 0,e.end??void 0,this._fileSize??void 0);return{start:t,end:n,size:i}}),this.log.trace("set byte ranges: %o",this.byteRanges)}catch(e){this.log.error("error setting offset details: %o",e),this.byteRanges=[]}}async convertToUint8Array(e){if(typeof e=="string")return new TextEncoder().encode(e);if("arrayBuffer"in e&&typeof e.arrayBuffer=="function"){let t=await e.arrayBuffer();return new Uint8Array(t)}if("byteLength"in e&&!("buffer"in e))return new Uint8Array(e);if("buffer"in e&&"byteLength"in e&&"byteOffset"in e)return e;throw new Error("Unsupported content type for multipart response")}async*getMultipartBody(e="application/octet-stream"){let t=this._body;if(t instanceof ReadableStream)return t;if(t===null)throw new Error("Cannot create multipart body from null");let n=new TextEncoder;for(let i of this.byteRanges){if(i.start===void 0||i.end===void 0)continue;let o=`\r
--${this.multiPartBoundary}\r
Content-Type: ${e}\r
Content-Range: ${M8({byteStart:i.start,byteEnd:i.end,byteSize:this._fileSize??void 0})}\r
\r
`;yield n.encode(o);let s=this.getSlicedBodyForRange(t,i.start,i.end);yield await this.convertToUint8Array(s)}yield n.encode(`\r
--${this.multiPartBoundary}--`)}getSlicedBodyForRange(e,t,n){let i=t,o=n-t+1;return this.log.trace("slicing body with offset=%o and length=%o",i,o),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(i,i+o):e}getContentType(){if(this.isMultiRangeRequest&&this.isValidRangeRequest)return`multipart/byteranges; boundary=${this.multiPartBoundary}`}get contentRangeHeaderValue(){if(!this.isValidRangeRequest)throw this.log.error("cannot get contentRangeHeaderValue for invalid range request"),new Br("Invalid range request");if(this.isMultiRangeRequest)throw this.log.error("contentRangeHeaderValue should not be called for multipart responses"),new Br("Content-Range header not applicable for multipart responses");if(this.byteRanges.length>0){let e=this.byteRanges[0];return M8({byteStart:e.start,byteEnd:e.end,byteSize:this._fileSize??void 0})}throw new Br("No valid ranges found")}createRangeStream(e,t){let n=new TextEncoder,i=this.byteRanges,o=this.multiPartBoundary,s=this._fileSize,a=this.log,c=this.isMultiRangeRequest;if(i.length===0)throw a.error("Cannot create range stream with no byte ranges"),new Br("No valid ranges found");return new ReadableStream({async start(l){try{for(let u of i){if(c){let f=`\r
--${o}\r
Content-Type: ${t}\r
Content-Range: ${M8({byteStart:u.start,byteEnd:u.end,byteSize:s??void 0})}\r
\r
`;l.enqueue(n.encode(f))}try{let f=e(u);for await(let h of f)l.enqueue(h)}catch(f){throw a.error("Error processing range %o: %o",u,f),f}}c&&l.enqueue(n.encode(`\r
--${o}--`)),l.close()}catch(u){a.error("Error processing range(s): %o",u),l.error(u)}}})}};function dA(r,e,t){Object.defineProperty(r,e,{enumerable:!0,configurable:!1,set:()=>{},get:()=>t})}function ps(r,e){dA(r,"type",e)}function ms(r,e){dA(r,"url",e)}function YM(r){dA(r,"redirected",!0)}function mJ(r,e,t){let n=new Response(e,{...t??{},status:200,statusText:"OK"});return t?.redirected===!0&&YM(n),ps(n,"basic"),ms(n,r),n}function QM(r,e,t){let n=new Response(e,{...t??{},status:500,statusText:"Internal Server Error"});return n.headers.set("X-Content-Type-Options","nosniff"),ps(n,"basic"),ms(n,r),n}function $8(r,e,t){let n=new Response(e,{...t??{},status:502,statusText:"Bad Gateway"});return ps(n,"basic"),ms(n,r),n}function ZM(r,e,t){let n=new Response(e,{...t??{},status:501,statusText:"Not Implemented"});return n.headers.set("X-Content-Type-Options","nosniff"),ps(n,"basic"),ms(n,r),n}function ga(r,e,t){let n=new Response(e,{...t??{},status:406,statusText:"Not Acceptable"});return ps(n,"basic"),ms(n,r),n}function H8(r,e,t){let n=new Response(e,{...t??{},status:404,statusText:"Not Found"});return ps(n,"basic"),ms(n,r),n}function gJ(r){return Array.isArray(r)&&r.every(e=>e instanceof Error)}function $0(r,e,t){let n,i;gJ(e)?(n=e[e.length-1].stack,i=e.map(a=>({message:a.message,stack:a.stack??""}))):e instanceof Error&&(n=e.stack,i=[{message:e.message,stack:e.stack??""}]);let o=JSON.stringify({stack:n,errors:i}),s=new Response(o,{status:400,statusText:"Bad Request",...t??{},headers:{...t?.headers??{},"Content-Type":"application/json"}});return ps(s,"basic"),ms(s,r),s}function H0(r,e,t){let n=new Response(null,{...t??{},status:301,statusText:"Moved Permanently",headers:{...t?.headers??{},location:e}});return ps(n,"basic"),ms(n,r),n}function Qn(r,e,{byteRangeContext:t,log:n},i){if(!t.isRangeRequest)return mJ(r,e,i);if(!t.isValidRangeRequest)return Eh(r,e,i);let o;try{let s=new Headers(i?.headers),a=t.getContentType();a!=null?s.set("content-type",a):t.isMultiRangeRequest?s.set("content-type","multipart/byteranges"):s.set("content-range",t.contentRangeHeaderValue),o=new Response(e,{...i??{},status:206,statusText:"Partial Content",headers:s})}catch(s){return n?.error("failed to create range response",s),Eh(r,e,i)}return i?.redirected===!0&&YM(o),ps(o,"basic"),ms(o,r),o}function Eh(r,e,t){let n=new Response(e,{...t??{},status:416,statusText:"Requested Range Not Satisfiable"});return ps(n,"basic"),ms(n,r),n}var mr=class{codes=[];pluginOptions;_log;get log(){return this._log==null&&(this._log=this.pluginOptions.logger.newScope(this.id)),this._log}constructor(e){this.pluginOptions=e}};var V8=class extends mr{id="byte-range-context-plugin";canHandle(e){return e.byteRangeContext==null}async handle(e){return e.byteRangeContext=new F8(this.pluginOptions.logger,e.options?.headers),e.modified++,e.byteRangeContext.isRangeRequest&&!e.byteRangeContext.isValidRangeRequest?Eh(e.resource):null}};var mA=bt(z8(),1);var gA=40;function yA(r,e){if(!r.length)throw new Error("Unexpected end of data");let t=mA.default.decode(r);return e.seek(mA.default.decode.bytes),t}function wA(r){let e=new DataView(r.buffer,r.byteOffset,r.byteLength),t=0;return{version:2,characteristics:[e.getBigUint64(t,!0),e.getBigUint64(t+=8,!0)],dataOffset:Number(e.getBigUint64(t+=8,!0)),dataSize:Number(e.getBigUint64(t+=8,!0)),indexOffset:Number(e.getBigUint64(t+=8,!0))}}var Lc={Null:r=>r===null?r:void 0,Int:r=>Number.isInteger(r)?r:void 0,Float:r=>typeof r=="number"&&Number.isFinite(r)?r:void 0,String:r=>typeof r=="string"?r:void 0,Bool:r=>typeof r=="boolean"?r:void 0,Bytes:r=>r instanceof Uint8Array?r:void 0,Link:r=>r!==null&&typeof r=="object"&&r.asCID===r?r:void 0,List:r=>Array.isArray(r)?r:void 0,Map:r=>r!==null&&typeof r=="object"&&r.asCID!==r&&!Array.isArray(r)&&!(r instanceof Uint8Array)?r:void 0},V0={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":Lc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(Lc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=V0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let i=e;i<r.length;i++){let o=r[i];if(o=V0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;n.push(o)}return n}}return r}},Int:Lc.Int,CarV1HeaderOrV2Pragma:r=>{if(Lc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let i=0;i<e.length;i++){let[o,s]=e[i];switch(o){case"roots":{let a=V0["CarV1HeaderOrV2Pragma > roots (anon)"](r[o]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=V0.Int(r[o]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},z0={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":Lc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(Lc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=z0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let i=e;i<r.length;i++){let o=r[i];if(o=z0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](o),o===void 0)return;n.push(o)}return n}}return r}},Int:Lc.Int,CarV1HeaderOrV2Pragma:r=>{if(Lc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let i=0;i<e.length;i++){let[o,s]=e[i];switch(o){case"roots":{let a=z0["CarV1HeaderOrV2Pragma > roots (anon)"](s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=z0.Int(s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<i;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},xA={toTyped:V0.CarV1HeaderOrV2Pragma,toRepresentation:z0.CarV1HeaderOrV2Pragma};var jJe=M7();var OJ=bt(z8(),1);var QJe=[new Q(A.map,2),new Q(A.string,"version"),new Q(A.uint,1),new Q(A.string,"roots")],ZJe=new Q(A.tag,42);async function bA(r,e){let t=yA(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR header (zero length)");let n=await r.exactly(t,!0),i=Ja(n);if(xA.toTyped(i)===void 0)throw new Error("Invalid CAR header format");if(i.version!==1&&i.version!==2||e!==void 0&&i.version!==e)throw new Error(`Invalid CAR version: ${i.version}${e!==void 0?` (expected ${e})`:""}`);if(i.version===1){if(!Array.isArray(i.roots))throw new Error("Invalid CAR header format");return i}if(i.roots!==void 0)throw new Error("Invalid CAR header format");let o=wA(await r.exactly(gA,!0));r.seek(o.dataOffset-r.pos);let s=await bA(r,1);return Object.assign(s,o)}function K0(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t,n=!1){if(t>r.length-e)throw new Error("Unexpected end of data");let i=r.subarray(e,e+t);return n&&(e+=t),i},seek(t){e+=t},get pos(){return e}}}var vA=bt(z8(),1),uU=1;function EA(r){let e=id({version:uU,roots:r}),t=vA.default.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function fU(r){return{async setRoots(e){let t=EA(e);await r.write(t)},async writeBlock(e){let{cid:t,bytes:n}=e;await r.write(new Uint8Array(vA.default.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()},version(){return uU}}}function K8(){}function dU(){let r=[],e=null,t=K8,n=!1,i=null,o=K8,s=()=>(e||(e=new Promise(l=>{t=()=>{e=null,t=K8,l()}})),e),a={write(l){r.push(l);let u=s();return o(),u},async end(){n=!0;let l=s();o(),await l}},c={async next(){let l=r.shift();return l?(r.length===0&&t(),{done:!1,value:l}):n?(t(),{done:!0,value:void 0}):(i||(i=new Promise(u=>{o=()=>(i=null,o=K8,u(c.next()))})),i)}};return{writer:a,iterator:c}}var q0=class r{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");let t=j.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}version(){return this._encoder.version()}static create(e){e=MJ(e);let{encoder:t,iterator:n}=hU(),i=new r(e,t),o=new q8(n);return{writer:i,out:o}}static createAppender(){let{encoder:e,iterator:t}=hU();e.setRoots=()=>Promise.resolve();let n=new r([],e),i=new q8(t);return{writer:n,out:i}}static async updateRootsInBytes(e,t){let n=K0(e);await bA(n);let i=EA(t);if(Number(n.pos)!==i.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${i.length} bytes)`);return e.set(i,0),e}},q8=class{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}};function hU(){let r=dU(),{writer:e,iterator:t}=r;return{encoder:fU(e),iterator:t}}function MJ(r){if(r===void 0)return[];if(!Array.isArray(r)){let t=j.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}let e=[];for(let t of r){let n=j.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}var Sh=class{async*export(e,t,n,i){let o=k9({blockstore:t,getCodec:n});for await(let s of o.walk(e,i))yield s.block}};var j8=class{components;log;constructor(e){this.components=e,this.log=e.logger.forComponent("helia:car")}async import(e,t){await ln(this.components.blockstore.putMany(Wt(e.blocks(),({cid:n,bytes:i})=>({cid:n,bytes:i})),t))}async*export(e,t){let n=Array.isArray(e)?e:[e],{writer:i,out:o}=q0.create(n),s=o[Symbol.asyncIterator](),a=new AbortController;for(this._export(n,i,t).catch(c=>{this.log.error("error during streaming export - %e",c),a.abort(c)});;){let{done:c,value:l}=await Et(s.next(),a.signal);if(a.signal.aborted)throw a.signal.reason;if(l!=null&&(yield l),c===!0)break}}async _export(e,t,n){let i=n?.traversal;for(let o of e){if(o.multihash.code===0)continue;let s=n?.exporter??(o.code===112?new Ah:new Sh),a=o,c=!1;if(i!=null){for await(let{cid:l,bytes:u}of i.traverse(a,this.components.blockstore,this.components.getCodec,n))if(this.log.trace("next CID on path to %c is %c",o,l),a=l,o.equals(l)&&(c=!0),c||n?.includeTraversalBlocks===!0){if(n?.blockFilter?.has(l.multihash.bytes)===!0)continue;n?.blockFilter?.add(l.multihash.bytes),await t.put({cid:l,bytes:u})}}for await(let{cid:l,bytes:u}of s.export(a,this.components.blockstore,this.components.getCodec,n))n?.blockFilter?.has(l.multihash.bytes)!==!0&&l.multihash.code!==0&&(c&&l.equals(a)||(n?.blockFilter?.add(l.multihash.bytes),await t.put({cid:l,bytes:u})))}await t.close()}};var j0=class{async*export(e,t,n,i){let o=await Ne(t.get(e,i));yield Za({cid:e,bytes:o,codec:await n(e.code)})}};var W0=class r extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=r.name;code=r.code;constructor(e="Invalid type"){super(e)}},W8=class r extends Error{static name="InvalidUnixFSMessageError";static code="ERR_INVALID_MESSAGE";name=r.name;code=r.code;constructor(e="Invalid message"){super(e)}};var Co;(function(r){let e;(function(i){i.Raw="Raw",i.Directory="Directory",i.File="File",i.Metadata="Metadata",i.Symlink="Symlink",i.HAMTShard="HAMTShard"})(e=r.DataType||(r.DataType={}));let t;(function(i){i[i.Raw=0]="Raw",i[i.Directory=1]="Directory",i[i.File=2]="File",i[i.Metadata=3]="Metadata",i[i.Symlink=4]="Symlink",i[i.HAMTShard=5]="HAMTShard"})(t||(t={})),(function(i){i.codec=()=>_t(t)})(e=r.DataType||(r.DataType={}));let n;r.codec=()=>(n==null&&(n=ve((i,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),i.Type!=null&&(o.uint32(8),r.DataType.codec().encode(i.Type,o)),i.Data!=null&&(o.uint32(18),o.bytes(i.Data)),i.filesize!=null&&(o.uint32(24),o.uint64(i.filesize)),i.blocksizes!=null)for(let a of i.blocksizes)o.uint32(32),o.uint64(a);i.hashType!=null&&(o.uint32(40),o.uint64(i.hashType)),i.fanout!=null&&(o.uint32(48),o.uint64(i.fanout)),i.mode!=null&&(o.uint32(56),o.uint32(i.mode)),i.mtime!=null&&(o.uint32(66),G8.codec().encode(i.mtime,o)),s.lengthDelimited!==!1&&o.ldelim()},(i,o)=>{let s={blocksizes:[]},a=o==null?i.len:i.pos+o;for(;i.pos<a;){let c=i.uint32();switch(c>>>3){case 1:s.Type=r.DataType.codec().decode(i);break;case 2:s.Data=i.bytes();break;case 3:s.filesize=i.uint64();break;case 4:s.blocksizes.push(i.uint64());break;case 5:s.hashType=i.uint64();break;case 6:s.fanout=i.uint64();break;case 7:s.mode=i.uint32();break;case 8:s.mtime=G8.codec().decode(i,i.uint32());break;default:i.skipType(c&7);break}}return s})),n),r.encode=i=>be(i,r.codec()),r.decode=i=>xe(i,r.codec())})(Co||(Co={}));var G8;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Seconds!=null&&(n.uint32(8),n.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(n.uint32(21),n.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let s=t.uint32();switch(s>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(s&7);break}}return i})),e),r.encode=t=>be(t,r.codec()),r.decode=t=>xe(t,r.codec())})(G8||(G8={}));var mU;(function(r){let e;r.codec=()=>(e==null&&(e=ve((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.MimeType!=null&&(n.uint32(10),n.string(t.MimeType)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){let s=t.uint32();switch(s>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(s&7);break}}return i})),e),r.encode=t=>be(t,r.codec()),r.decode=t=>xe(t,r.codec())})(mU||(mU={}));var gU={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},FJ=["directory","hamt-sharded-directory"],yU=parseInt("0644",8),wU=parseInt("0755",8),xU=BigInt(1024),Ee=class r{static unmarshal(e){let t=Co.decode(e);if(t.fanout!=null&&t.fanout>xU)throw new W8(`Fanout size was too large - ${t.fanout} > ${xU}`);let n=new r({type:gU[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){let{type:t,data:n,blockSizes:i,hashType:o,fanout:s,mtime:a,mode:c}=e;if(t!=null&&!Object.values(gU).includes(t))throw new W0("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=o,this.fanout=s,this.blockSizes=i??[],this._originalMode=0,this.mode=c,this.mtime=a}set mode(e){e==null?this._mode=this.isDirectory()?wU:yU:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return FJ.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=Co.DataType.Raw;break;case"directory":e=Co.DataType.Directory;break;case"file":e=Co.DataType.File;break;case"metadata":e=Co.DataType.Metadata;break;case"symlink":e=Co.DataType.Symlink;break;case"hamt-sharded-directory":e=Co.DataType.HAMTShard;break;default:throw new W0(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(this.mode??0),n===yU&&!this.isDirectory()&&(n=void 0),n===wU&&this.isDirectory()&&(n=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),Co.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:i})}};var G0=class extends Error{static code="ERR_NOT_UNIXFS";static message="Not a UnixFS node";static name="NotUnixFSError";code="ERR_NOT_UNIXFS";message="Not a UnixFS node";name="NotUnixFSError"},X8=class extends Error{static name="NotDescendantError";name="NotDescendantError"},Y8=class extends Error{static name="InvalidTraversalError";name="InvalidTraversalError"};function HJ(r){return r.cid.code===85}function VJ(r){return r.cid.code===112}function zJ(r){if(HJ(r))return!0;if(VJ(r)&&r.value.Data!=null){let e=Ee.unmarshal(r.value.Data);return e.type==="file"||e.type==="raw"}else throw new G0("Encountered non raw/dag-pb CID in UnixFS DAG")}var Ah=class{options;constructor(e){this.options=e}async*export(e,t,n,i){if(e.code!==112&&e.code!==85)throw new G0("Target CID was not UnixFS - use the SubGraphExporter to export arbitrary graphs");let o=I9({blockstore:t,getCodec:n}),s=this.options?.offset??0,a=this.options?.length??1/0,c=this.options?.listingOnly??!1;if(s<0)throw new O("Offset cannot be negative");if(a<0)throw new O("Length cannot be negative");let l,u=new AbortController,f=Oe([u.signal,i?.signal]);u.signal;function h(d,m){if(l==null&&(l=zJ(m)),!l){let B=m.value.Links.find(U=>U.Hash.equals(d)),H=Ee.unmarshal(m.value.Data??new Uint8Array);return H.type==="directory"?!c:H.type==="hamt-sharded-directory"&&c?B?.Name?.length===2:!0}let y=m.value.Links.findIndex(B=>B.Hash.equals(d)),w=Ee.unmarshal(m.value.Data??new Uint8Array),x=s,v=x+a,E=Number([...w.blockSizes].slice(0,y).reduce((B,H)=>B+H,0n)),_=E+Number(w.blockSizes[y]);return x>=E&&x<_||v>=E&&v<_||x<=E&&v>=_}try{for await(let d of o.walk(e,{...i,includeChild:h,signal:f}))yield d.block}finally{u.abort(),f.clear()}}};var Q8=class{path;constructor(e){this.path=e}async*traverse(e,t,n,i){if(!this.path.some(s=>s.equals(e)))throw new Y8(`CIDPath traversal must include ${e}`);let o;for(let s of this.path){if(o!=null){let l=!1;for(let[,u]of o.links())if(u.equals(s)){l=!0;break}if(!l)throw new X8(`${s} is not a child of ${o.cid}`)}let a=await Ne(t.get(s,i)),c=Za({cid:s,bytes:a,codec:await n(s.code)});o=c,yield c}}};function KJ(r){return r[Symbol.asyncIterator]!=null}function qJ(r){if(KJ(r))return(async()=>{let t;for await(let n of r)t=n;return t})();let e;for(let t of r)e=t;return e}var To=qJ;var Z8=class r extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=r.name;code=r.code;constructor(e="Bad path"){super(e)}},ji=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not found"){super(e)}},J8=class r extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=r.name;code=r.code;constructor(e="No resolver"){super(e)}},Sr=class r extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=r.name;code=r.code;constructor(e="Not UnixFS"){super(e)}},ew=class r extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=r.name;code=r.code;constructor(e="Over read"){super(e)}},tw=class r extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=r.name;code=r.code;constructor(e="Under read"){super(e)}},rw=class r extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=r.name;code=r.code;constructor(e="No Property found"){super(e)}},Vu=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};function _h(r,e,t,n,i,o,s){let a=r,c=i;for(;o.length>0;){let l=o[0];if(l in a){o.shift(),c=`${c}/${l}`;let u=j.asCID(a[l]);if(u!=null)return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}},next:{cid:u,name:l,path:c,toResolve:o}};a=a[l]}else throw new rw(`No property named ${l} found in node ${t}`)}return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}}}}var jJ=async(r,e,t,n,i,o,s,a)=>{let c=await Ne(s.get(r,a)),l=Ja(c);return _h(l,c,r,e,t,n,o)},bU=jJ;var WJ=async(r,e,t,n,i,o,s,a)=>{let c=await Ne(s.get(r,a)),l=sd(c);return _h(l,c,r,e,t,n,o)},vU=WJ;function GJ(r,e,t,n){let i=BigInt(r.length),o=BigInt(e+i);return t>=o||n<e?new Uint8Array(0):(n>=e&&n<o&&(r=r.subarray(0,Number(n-e))),t>=e&&t<o&&(r=r.subarray(Number(t-e))),r)}var zu=GJ;var XJ=(r,e=0,t=r)=>{let n=BigInt(r),i=BigInt(e??0),o=BigInt(t);if(o!==n&&(o=i+o),o>n&&(o=n),i<0n)throw new Vu("Offset must be greater than or equal to 0");if(i>n)throw new Vu("Offset must be less than the file size");if(o<0n)throw new Vu("Length must be greater than or equal to 0");if(o>n)throw new Vu("Length must be less than the file size");return{start:i,end:o}},Ch=XJ;var YJ=r=>{async function*e(t={}){let{start:n,end:i}=Ch(r.length,t.offset,t.length),o=zu(r,0n,n,i);t.onProgress?.(new G("unixfs:exporter:progress:identity",{bytesRead:BigInt(o.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield o}return e},QJ=async(r,e,t,n,i,o,s,a)=>{if(n.length>0)throw new ji(`No link named ${t} found in raw node ${r}`);let c=Xe(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:YJ(c.digest),depth:o,size:BigInt(c.digest.length),node:c.digest}}},EU=QJ;var ZJ=async(r,e,t,n,i,o,s,a)=>{let c=await Ne(s.get(r,a)),l=yx(c);return _h(l,c,r,e,t,n,o)},SU=ZJ;var JJ=r=>{async function*e(t={}){let{start:n,end:i}=Ch(r.length,t.offset,t.length),o=zu(r,0n,n,i);t.onProgress?.(new G("unixfs:exporter:progress:raw",{bytesRead:BigInt(o.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield o}return e},eee=async(r,e,t,n,i,o,s,a)=>{if(n.length>0)throw new ji(`No link named ${t} found in raw node ${r}`);let c=await Ne(s.get(r,a));return{entry:{type:"raw",name:e,path:t,cid:r,content:JJ(c),depth:o,size:BigInt(c.length),node:c}}},AU=eee;var iw=bt(TU(),1);function tee(r){let e=new Array(4);for(let t=0;t<4;t++)e[t]=r&255,r=r>>8;return new Uint8Array(e)}var Vtt=Es({name:"murmur3-32",code:35,encode:r=>tee(iw.default.x86.hash32(r))}),Ku=Es({name:"murmur3-128",code:34,encode:r=>Gc.fromHex(iw.default.x64.hash128(r))}),ztt=Es({name:"murmur3-x64-64",code:34,encode:r=>Gc.fromHex(iw.default.x64.hash128(r)).subarray(0,8)});var PU=bt(ow(),1);var Ei=class r{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new PU.default,this.key=null}async put(e,t){let n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){let t=await this._findChild(e);if(t!=null)return t.value}async del(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof r?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){let e=this._children.compactArray();for(let t of e)t instanceof r?yield*t.eachLeafSeries():yield t}serialize(e,t){let n=[];return t(this._children.reduce((i,o,s)=>(o!=null&&(o instanceof r?i.push(o.serialize(e,t)):i.push(e(o,s))),i),n))}async asyncTransform(e,t){return RU(this,e,t)}toJSON(){return this.serialize(see,aee)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof r)&&n!=null&&n.key===e)return n}async _findPlace(e){let t=this._options.hash(typeof e=="string"?R(e):e),n=await t.take(this._options.bits),i=this._children.get(n);return i instanceof r?i._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:i}}async _findNewBucketAndPos(e){let t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){let n=new r(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);let i=await n._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){let e=this._children.find(oee);if(e!=null&&!(e instanceof r)){let t=e.hash;t.untake(this._options.bits);let n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}};function oee(r){return!!r}function see(r,e){return r.key}function aee(r){return r}async function RU(r,e,t){let n=[];for(let i of r._children.compactArray())if(i instanceof Ei)await RU(i,e,t);else{let o=await e(i);n.push({bitField:r._children.bitField(),children:o})}return t(n)}var cee=[255,254,252,248,240,224,192,128],lee=[1,3,7,15,31,63,127,255],sw=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let i=this._value[this._currentBytePos],o=this._currentBitPos+1,s=Math.min(o,t),a=uee(i,o-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function uee(r,e,t){let n=fee(e,t);return(r&n)>>>e}function fee(r,e){return cee[r]&lee[Math.min(e+r-1,7)]}function DU(r){function e(t){return t instanceof aw?t:new aw(t,r)}return e}var aw=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let i=this._buffers[this._currentBufferIndex],o=Math.min(i.availableBits(),t),s=i.take(o);n=(n<<o)+s,t-=o,this._availableBits-=o,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?it([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new sw(t);this._buffers.push(n),this._availableBits+=n.availableBits()}};function Th(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");let e={bits:r.bits??8,hash:DU(r.hashFn)};return new Ei(e)}var dee=async function(r){return(await Ku.encode(r)).slice(0,8).reverse()},hee=async(r,e,t)=>{let n=(e.tableSize()-1).toString(16).length;await Promise.all(r.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===n){let o=parseInt(i.Name,16);e._putObjectAt(o,new Ei({hash:t._options.hash,bits:t._options.bits},e,o));return}await t.put(i.Name.substring(2),!0)}))},OU=(r,e)=>r.toString(16).toUpperCase().padStart(e,"0").substring(0,e),pee=r=>{let e=r.bucket,t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},NU=async(r,e,t,n,i)=>{if(n==null){if(r.Data==null)throw new Sr("no data in PBNode");let f;try{f=Ee.unmarshal(r.Data)}catch(d){throw new Sr(d.message)}if(f.type!=="hamt-sharded-directory")throw new Sr("not a HAMT");if(f.fanout==null)throw new Sr("missing fanout");let h=Th({hashFn:dee,bits:Math.log2(Number(f.fanout))});n={rootBucket:h,hamtDepth:1,lastBucket:h}}let o=(n.lastBucket.tableSize()-1).toString(16).length;await hee(r.Links,n.lastBucket,n.rootBucket);let s=await n.rootBucket._findNewBucketAndPos(e),a=OU(s.pos,o),c=pee(s);c.length>n.hamtDepth&&(n.lastBucket=c[n.hamtDepth],a=OU(n.lastBucket._posAtParent,o));let l=r.Links.find(f=>{if(f.Name==null)return!1;let h=f.Name.substring(0,o),d=f.Name.substring(o);return!(h!==a||d!==""&&d!==e)});if(l==null)return;if(l.Name!=null&&l.Name.substring(o)===e)return l.Hash;n.hamtDepth++;let u=await Ne(t.get(l.Hash,i));return r=rr(u),NU(r,e,t,n,i)},LU=NU;function Ih(r){return r?.extended===!1}var mee=(r,e,t,n,i,o,s)=>{async function*a(c={}){let l=c.offset??0,u=c.length??e.Links.length,f=e.Links.slice(l,u);c.onProgress?.(new G("unixfs:exporter:walk:directory",{cid:r})),yield*br(f,h=>Wt(h,d=>async()=>{let m=d.Name??"",y=`${n}/${m}`;return Ih(c)?{cid:d.Hash,name:m,path:y}:(await i(d.Hash,m,y,[],o+1,s,c)).entry}),h=>vn(h,{ordered:!0,concurrency:c.blockReadConcurrency}),h=>Cn(h,d=>d!=null))}return a},BU=mee;async function MU(r,e,t,n,i,o,s){if(e instanceof Uint8Array){let l=zu(e,n,i,o);t.push(l);return}if(e.Data==null)throw new Sr("no data in PBNode");let a;try{a=Ee.unmarshal(e.Data)}catch(l){throw new Sr(l.message)}if(a.data!=null){let l=a.data,u=zu(l,n,i,o);t.push(u),n+=BigInt(u.byteLength)}let c=[];if(e.Links.length!==a.blockSizes.length)throw new Sr("Inconsistent block sizes and dag links");for(let l=0;l<e.Links.length;l++){let u=e.Links[l],f=n,h=f+a.blockSizes[l];if((i>=f&&i<h||o>=f&&o<=h||i<f&&o>h)&&c.push({link:u,blockStart:n}),n=h,n>o)break}await br(c,l=>Wt(l,u=>async()=>{let f=await Ne(r.get(u.link.Hash,s));return{...u,block:f}}),l=>vn(l,{ordered:!0,concurrency:s.blockReadConcurrency}),async l=>{for await(let{link:u,block:f,blockStart:h}of l){let d;switch(u.Hash.code){case gt:d=rr(f);break;case vt:d=f;break;default:t.end(new Sr(`Unsupported codec: ${u.Hash.code}`));return}let m=new Ks({concurrency:1});m.on("error",y=>{t.end(y)}),m.add(async()=>{s.onProgress?.(new G("unixfs:exporter:walk:file",{cid:u.Hash})),await MU(r,d,t,h,i,o,s)}),await m.onIdle()}}),n>=o&&t.end()}var gee=(r,e,t,n,i,o,s)=>{async function*a(c={}){let l=t.fileSize();if(l===void 0)throw new Error("File was a directory");let{start:u,end:f}=Ch(l,c.offset,c.length);if(f===0n)return;let h=0n,d=f-u,m=xr();c.onProgress?.(new G("unixfs:exporter:walk:file",{cid:r})),MU(s,e,m,0n,u,f,c).catch(y=>{m.end(y)});for await(let y of m)if(y!=null){if(h+=BigInt(y.byteLength),h>d)throw m.end(),new ew("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");h===d&&m.end(),c.onProgress?.(new G("unixfs:exporter:progress:unixfs:file",{bytesRead:h,totalBytes:d,fileSize:l})),yield y}if(h<d)throw new tw("Traversed entire DAG but did not read enough bytes")}return a},SA=gee;var yee=(r,e,t,n,i,o,s)=>{function a(c={}){return c.onProgress?.(new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:r})),UU(e,n,i,o,s,c)}return a};async function*UU(r,e,t,n,i,o){let s=r.Links;if(r.Data==null)throw new Sr("no data in PBNode");let a;try{a=Ee.unmarshal(r.Data)}catch(u){throw new Sr(u.message)}if(a.fanout==null)throw new Sr("missing fanout");let c=(a.fanout-1n).toString(16).length,l=br(s,u=>Wt(u,f=>async()=>{let h=f.Name!=null?f.Name.substring(c):null;if(h!=null&&h!==""){let d=`${e}/${h}`;return Ih(o)?{entries:[{cid:f.Hash,name:h,path:d}]}:{entries:[(await t(f.Hash,h,d,[],n+1,i,o)).entry].filter(Boolean)}}else{let d=await Ne(i.get(f.Hash,o));return r=rr(d),o.onProgress?.(new G("unixfs:exporter:walk:hamt-sharded-directory",{cid:f.Hash})),{entries:UU(r,e,t,n,i,o)}}}),u=>vn(u,{ordered:!0,concurrency:o.blockReadConcurrency}));for await(let{entries:u}of l)yield*u}var FU=yee;var wee=(r,e)=>r.Links.find(n=>n.Name===e)?.Hash,xee={raw:SA,file:SA,directory:BU,"hamt-sharded-directory":FU,metadata:(r,e,t,n,i,o,s)=>()=>[],symlink:(r,e,t,n,i,o,s)=>()=>[]},bee=async(r,e,t,n,i,o,s,a)=>{if(Ih(a)&&n.length===0)return{entry:{cid:r,name:e,path:t}};let c=await Ne(s.get(r,a)),l=rr(c),u,f;if(e==null&&(e=r.toString()),l.Data==null)throw new Sr("no data in PBNode");try{u=Ee.unmarshal(l.Data)}catch(d){throw new Sr(d.message)}if(t==null&&(t=e),n.length>0){let d;if(u?.type==="hamt-sharded-directory"?d=await LU(l,n[0],s):d=wee(l,n[0]),d==null)throw new ji("file does not exist");let m=n.shift(),y=`${t}/${m}`;f={cid:d,toResolve:n,name:m??"",path:y}}let h=xee[u.type](r,l,u,t,i,o,s);if(h==null)throw new ji("could not find content exporter");return u.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:r,content:h,unixfs:u,depth:o,node:l,size:u.fileSize()},next:f}:{entry:{type:"file",name:e,path:t,cid:r,content:h,unixfs:u,depth:o,node:l,size:u.fileSize()},next:f}},$U=bee;var vee={[gt]:$U,[vt]:AU,[Un]:bU,[po]:vU,[or.code]:EU,[Mo]:SU},HU=async(r,e,t,n,i,o,s)=>{let a=vee[r.code];if(a==null)throw new J8(`No resolver for code ${r.code}`);return a(r,e,t,n,HU,i,o,s)},VU=HU;var Eee=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),See=r=>{if(r instanceof Uint8Array)return{cid:j.decode(r),toResolve:[]};let e=j.asCID(r);if(e!=null)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));let t=Eee(r);return{cid:j.parse(t[0]),toResolve:t.slice(1)}}throw new Z8(`Unknown path type ${r}`)};async function*Y0(r,e,t={}){let{cid:n,toResolve:i}=See(r),o=n.toString(),s=o,a=i.length;for(;;){let c=await VU(n,o,s,i,a,e,t);if(c.entry==null&&c.next==null)throw new ji(`Could not resolve ${r}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,n=c.next.cid,o=c.next.name,s=c.next.path}}async function gr(r,e,t={}){let n=await To(Y0(r,e,t));if(n==null)throw new ji(`Could not resolve ${r}`);return n}async function*kh(r,e,t={}){let n=await gr(r,e,t);if(n==null)return;if(yield n,n.type==="directory")for await(let o of i(n,t))yield o;async function*i(o,s){for await(let a of o.content(s))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,s))}}function zU(r){return new j8(r)}function KU(r,e){if(e==null)return{offset:0,length:1/0};let t=e.split(":"),n=parseInt(t[0],10),i=t[1]==="*"?1/0:parseInt(t[1],10);if(isNaN(n)||isNaN(i))throw new Error("Could not parse entity-bytes");let o=Number(r.size);if(n>=0)return i>=0?{offset:n,length:i-n}:{offset:n,length:o-n+i};let s=o+n;return Math.abs(n)>o&&(s=0),i>=0?{offset:s,length:o-s+i}:{offset:s,length:o-s+i}}function Aee({cid:r,ipfsPath:e,query:t}){return t.filename!=null?t.filename:`${e.replace(/\/ipfs\//,"").replace(/\/ipns\//,"").replace(/\//g,"_")}.car`}function _ee({query:r}){let e=r["dag-scope"];return e==="all"||e==="entity"||e==="block"?e:r["entity-bytes"]?"entity":"all"}var cw=class extends mr{id="car-plugin";canHandle(e){return e.byteRangeContext==null||e.pathDetails==null?!1:e.accept?.mimeType.startsWith("application/vnd.ipld.car")===!0||e.query.format==="car"}async handle(e){let{options:t,pathDetails:n,cid:i,query:o,accept:s}=e,a=s?.options.order==="dfs"?"dfs":"unk",c=s?.options.dups!=="n";if(n==null)throw new Error("attempted to handle request for car with no path details");let{getBlockstore:l,helia:u}=this.pluginOptions;e.reqFormat="car",e.query.download=!0,e.query.filename=Aee(e);let f=l(i,e.resource,t?.session??!0,t),h=zU({blockstore:f,getCodec:u.getCodec,logger:u.logger}),d={...t,includeTraversalBlocks:!0};c||(d.blockFilter=Rr(1024)),n.ipfsRoots.length>1&&(d.traversal=new Q8(n.ipfsRoots));let m=_ee(e),y=n.terminalElement.cid??i;if(m==="block")d.exporter=new j0;else if(m==="entity")if(y.code===gt){let x={listingOnly:!0},v=KU(n.terminalElement,o["entity-bytes"]?.toString());x.offset=v.offset,x.length=v.length,d.exporter=new Ah(x)}else d.exporter=new j0;else d.exporter=new Sh;e.byteRangeContext.setBody(na(h.export(y,d)));let w=Qn(e.resource,e.byteRangeContext.getBody("application/vnd.ipld.car; version=1"),{byteRangeContext:e.byteRangeContext,log:this.log});return w.headers.set("content-type",e.byteRangeContext.getContentType()??`application/vnd.ipld.car; version=1; order=${a}; dups=${c?"y":"n"}`),w}};function qU(r){let e=xn(r,{allowIndefinite:!1,coerceUndefinedToNull:!1,allowNaN:!1,allowInfinity:!1,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,allowBigInt:!1});return new TextDecoder().decode(xm(e))}var Io=class extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}},Si=class extends Io{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}},Zn=class extends Io{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}},Bc=class extends Io{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}},Q0=class extends Io{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}},Ph=class extends Io{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}},Rh=class extends Io{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}},lw=class extends Io{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}},Mc=class extends Io{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}},Ar=class extends Io{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};async function Cee(r,e,t){let n=[],i;for await(let o of Y0(e,r,t))n.push(o.cid),i=o;if(i==null)throw new Ph("No terminal element found");return{ipfsRoots:n,terminalElement:i}}function AA(r){return r.type==="object"}async function jU({cid:r,path:e,resource:t,options:n,blockstore:i,log:o}){try{return await Cee(i,`${r}/${e}`,n)}catch(s){if(n?.signal?.aborted)throw new St(n?.signal?.reason);return["ERR_NO_PROP","ERR_NO_TERMINAL_ELEMENT","ERR_NOT_FOUND"].includes(s.code)?H8(t):(o.error('error walking path "%s" - %e',e,s),$8(t,"Error walking path"))}}var uw=class extends mr{id="dag-cbor-plugin";codes=[Un];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:i,plugins:o}){return n==null||!AA(n.terminalElement)||e.code!==Un||i==null||t!=null&&t.mimeType==="text/html"&&o.includes("dag-cbor-plugin-html-preview")?!1:AA(n.terminalElement)}async handle(e){let{cid:t,path:n,resource:i,accept:o,pathDetails:{terminalElement:s,ipfsRoots:a}}=e;this.log.trace("fetching %c/%s",t,n);let c=s.node,l;if(o?.mimeType==="application/octet-stream"||o?.mimeType==="application/vnd.ipld.dag-cbor"||o?.mimeType==="application/cbor")l=c;else if(o?.mimeType==="application/vnd.ipld.dag-json")try{let h=Ja(c);l=N3(h)}catch(h){return this.log.error("could not transform %c to application/vnd.ipld.dag-json",h),ga(i)}else try{l=qU(c)}catch(h){if(o?.mimeType==="application/json")return this.log('could not decode DAG-CBOR as JSON-safe, but the client sent "Accept: application/json"',h),ga(i);this.log("could not decode DAG-CBOR as JSON-safe, falling back to `application/octet-stream`",h),l=c}e.byteRangeContext.setBody(l);let u=o?.mimeType??(l instanceof Uint8Array?"application/octet-stream":"application/json"),f=Qn(i,e.byteRangeContext.getBody(u),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type",e.byteRangeContext.getContentType()??u),this.log.trace('setting content type to "%s"',e.byteRangeContext.getContentType()??u),U8(f,a),f}};function Tee(r){return r[Symbol.asyncIterator]!=null}function Iee(r,e=1){return e=Number(e),Tee(r)?(async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})():(function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})()}var fw=Iee;async function*Z0(r,e=1){for await(let t of fw(r,e)){let n=t.map(async i=>i().then(o=>({ok:!0,value:o}),o=>({ok:!1,err:o})));for(let i=0;i<n.length;i++){let o=await n[i];if(o.ok)yield o.value;else throw o.err}}}var kee=262144,J0=(r={})=>{let e=r.chunkSize??kee;return async function*(n){let i=new oe,o=0,s=!1;for await(let a of n)for(i.append(a),o+=a.length;o>=e;)if(yield i.slice(0,e),s=!0,e===i.length)i=new oe,o=0;else{let c=new oe;c.append(i.sublist(e)),i=c,o-=e}(!s||o>0)&&(yield i.subarray(0,o))}};var ko=async(r,e,t)=>{t.codec==null&&(t.codec=nr);let n=await ze.digest(r),i=j.create(t.cidVersion,t.codec.code,n);return await e.put(i,r,t),i};function WU(r){return async function*(t,n){let i=0n;for await(let o of t.content)yield async()=>{let s,a={codec:nr,cidVersion:r.cidVersion,onProgress:r.onProgress};r.rawLeaves?(a.codec=Nn,a.cidVersion=1):(s=new Ee({type:r.leafType,data:o}),o=Je({Data:s.marshal(),Links:[]}));let c=await ko(o,n,a);return i+=BigInt(o.byteLength),r.onProgress?.(new G("unixfs:importer:progress:file:write",{bytesWritten:i,cid:c,path:t.path})),{cid:c,unixfs:s,size:BigInt(o.length),block:o}}}}var dw=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};var Uc=class r extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=r.name;code=r.code;constructor(e="Invalid content"){super(e)}};var GU=async(r,e,t)=>{let n=new Ee({type:"directory",mtime:r.mtime,mode:r.mode}),i=Je(Gt({Data:n.marshal()})),o=await ko(i,e,t),s=r.path;return{cid:o,path:s,unixfs:n,size:BigInt(i.length),originalPath:r.originalPath,block:i}};async function*Pee(r,e,t){let n=-1,i;for await(let o of Z0(t.bufferImporter(r,e),t.blockWriteConcurrency)){if(n++,n===0){i={...o,single:!0};continue}else n===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...o,block:void 0}}i!=null&&(yield i)}function XU(r){return r.single===!0}var Ree=(r,e,t)=>async function(i){if(i.length===1&&XU(i[0])&&t.reduceSingleLeafToSelf){let u=i[0],f=u.block;return XU(u)&&(r.mtime!==void 0||r.mode!==void 0)&&(u.unixfs=new Ee({type:"file",mtime:r.mtime,mode:r.mode,data:u.block}),f={Data:u.unixfs.marshal(),Links:[]},u.block=Je(Gt(f)),u.cid=await ko(u.block,e,{...t,cidVersion:t.cidVersion}),u.size=BigInt(u.block.length)),t.onProgress?.(new G("unixfs:importer:progress:file:layout",{cid:u.cid,path:u.originalPath})),{cid:u.cid,path:r.path,unixfs:u.unixfs,size:u.size,originalPath:u.originalPath}}let o=new Ee({type:"file",mtime:r.mtime,mode:r.mode}),s=i.filter(u=>u.cid.code===vt&&u.size>0||u.unixfs!=null&&u.unixfs.data==null&&u.unixfs.fileSize()>0n?!0:!!u.unixfs?.data?.length).map(u=>u.cid.code===vt?(o.addBlockSize(u.size),{Name:"",Tsize:Number(u.size),Hash:u.cid}):(u.unixfs?.data==null?o.addBlockSize(u.unixfs?.fileSize()??0n):o.addBlockSize(BigInt(u.unixfs.data.length)),{Name:"",Tsize:Number(u.size),Hash:u.cid})),a={Data:o.marshal(),Links:s},c=Je(Gt(a)),l=await ko(c,e,t);return t.onProgress?.(new G("unixfs:importer:progress:file:layout",{cid:l,path:r.originalPath})),{cid:l,path:r.path,unixfs:o,size:BigInt(c.length+a.Links.reduce((u,f)=>u+(f.Tsize??0),0)),originalPath:r.originalPath,block:c}},YU=async(r,e,t)=>t.layout(Pee(r,e,t),Ree(r,e,t));function Dee(r){return Symbol.iterator in r}function Oee(r){return Symbol.asyncIterator in r}function Nee(r){try{if(r instanceof Uint8Array)return(async function*(){yield r})();if(Dee(r))return(async function*(){yield*r})();if(Oee(r))return r}catch{throw new Uc("Content was invalid")}throw new Uc("Content was invalid")}function QU(r){return async function*(t,n){for await(let i of t){let o;if(i.path!=null&&(o=i.path,i.path=i.path.split("/").filter(s=>s!=null&&s!==".").join("/")),Lee(i)){let s={path:i.path,mtime:i.mtime,mode:i.mode,content:(async function*(){let c=0n;for await(let l of r.chunker(r.chunkValidator(Nee(i.content)))){let u=BigInt(l.byteLength);c+=u,r.onProgress?.(new G("unixfs:importer:progress:file:read",{bytesRead:c,chunkSize:u,path:i.path})),yield l}})(),originalPath:o},a=r.fileBuilder??YU;yield async()=>a(s,n,r)}else if(i.path!=null){let s={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:o},a=r.dirBuilder??GU;yield async()=>a(s,n,r)}else throw new Error("Import candidate must have content or path or both")}}}function Lee(r){return r.content!=null}var ZU=()=>async function*(e){for await(let t of e){if(t.length===void 0)throw new Uc("Content was invalid");if(typeof t=="string"||t instanceof String)yield R(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new Uc("Content was invalid")}};var Bee=174;function eg(r){let e=r?.maxChildrenPerNode??Bee;return async function t(n,i){let o=[];for await(let s of fw(n,e))o.push(await i(s));return o.length>1?t(o,i):o[0]}}var gs=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},tg=j.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),rg=j.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var qu=class extends gs{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(let[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(let[e,t]of this._children.entries())t.size!=null&&t.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?rg.bytes.byteLength:tg.bytes.byteLength));return this.nodeSize}async*flush(e){let t=[];for(let[c,l]of this._children.entries()){let u=l;if(l instanceof gs)for await(let f of l.flush(e))u=f,yield f;u.size!=null&&u.cid!=null&&t.push({Name:c,Tsize:Number(u.size),Hash:u.cid})}let n=new Ee({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:n.marshal(),Links:t},o=Je(Gt(i)),s=await ko(o,e,this.options),a=o.length+i.Links.reduce((c,l)=>c+(l.Tsize??0),0);this.cid=s,this.size=a,yield{cid:s,unixfs:n,path:this.path,size:BigInt(a)}}};async function Mee(r){return(await Ku.encode(r)).slice(0,8).reverse()}var JU=BigInt(34),Uee=8,_A=class extends gs{_bucket;constructor(e,t){super(e,t),this._bucket=Th({hashFn:Mee,bits:t.shardFanoutBits??Uee})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=rF(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of tF(this._bucket,e,this,this.options))yield{...t,path:this.path}}},eF=_A;async function*tF(r,e,t,n){let i=r._children,o=(r.tableSize()-1).toString(16).length,s=[],a=0n;for(let m=0;m<i.length;m++){let y=i.get(m);if(y==null)continue;let w=m.toString(16).toUpperCase().padStart(o,"0");if(y instanceof Ei){let x;for await(let v of tF(y,e,null,n))x=v;if(x==null)throw new Error("Could not flush sharded directory, no subshard found");s.push({Name:w,Tsize:Number(x.size),Hash:x.cid}),a+=x.size}else if(Fee(y.value)){let x=y.value,v;for await(let _ of x.flush(e))v=_,yield v;if(v==null)throw new Error("Did not flush dir");let E=w+y.key;s.push({Name:E,Tsize:Number(v.size),Hash:v.cid}),a+=v.size}else{let x=y.value;if(x.cid==null)continue;let v=w+y.key,E=x.size;s.push({Name:v,Tsize:Number(E),Hash:x.cid}),a+=BigInt(E??0)}}let c=Uint8Array.from(i.bitField().reverse()),l=new Ee({type:"hamt-sharded-directory",data:c,fanout:BigInt(r.tableSize()),hashType:JU,mtime:t?.mtime,mode:t?.mode}),u={Data:l.marshal(),Links:s},f=Je(Gt(u)),h=await ko(f,e,n),d=BigInt(f.byteLength)+a;yield{cid:h,unixfs:l,size:d}}function Fee(r){return typeof r.flush=="function"}function rF(r,e,t){let n=r._children,i=(r.tableSize()-1).toString(16).length,o=[];for(let l=0;l<n.length;l++){let u=n.get(l);if(u==null)continue;let f=l.toString(16).toUpperCase().padStart(i,"0");if(u instanceof Ei){let h=rF(u,null,t);o.push({Name:f,Tsize:Number(h),Hash:t.cidVersion===0?tg:rg})}else if(typeof u.value.flush=="function"){let d=u.value.nodeSize();o.push({Name:f+u.key,Tsize:Number(d),Hash:t.cidVersion===0?tg:rg})}else{let h=u.value;if(h.cid==null)continue;let d=f+u.key,m=h.size;o.push({Name:d,Tsize:Number(m),Hash:h.cid})}}let s=Uint8Array.from(n.bitField().reverse()),a=new Ee({type:"hamt-sharded-directory",data:s,fanout:BigInt(r.tableSize()),hashType:JU,mtime:e?.mtime,mode:e?.mode});return Je(Gt({Data:a.marshal(),Links:o})).length}async function CA(r,e,t,n){let i=e;e instanceof qu&&e.estimateNodeSize()>t&&(i=await $ee(e,n));let o=i.parent;if(o!=null){if(i!==e){if(r!=null&&(r.parent=i),i.parentKey==null)throw new Error("No parent key found");await o.put(i.parentKey,i)}return CA(i,o,t,n)}return i}async function $ee(r,e){let t=new eF({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for(let{key:n,child:i}of r.eachChildSeries())await t.put(n,i);return t}var nF=(r="")=>r.split(/(?<!\\)\//).filter(Boolean);async function Hee(r,e,t){let n=nF(r.path??""),i=n.length-1,o=e,s="";for(let a=0;a<n.length;a++){let c=n[a];s+=`${s!==""?"/":""}${c}`;let l=a===i;if(o.dirty=!0,o.cid=void 0,o.size=void 0,l)await o.put(c,r),e=await CA(null,o,t.shardSplitThresholdBytes,t);else{let u=await o.get(c);(u==null||!(u instanceof gs))&&(u=new qu({root:!1,dir:!0,parent:o,parentKey:c,path:s,dirty:!0,flat:!0,mtime:u?.unixfs?.mtime,mode:u?.unixfs?.mode},t)),await o.put(c,u),o=u}}return e}async function*iF(r,e){if(!(r instanceof gs)){r.unixfs?.isDirectory()===!0&&(yield r);return}yield*r.flush(e)}function oF(r){return async function*(t,n){let i=new qu({root:!0,dir:!0,path:"",dirty:!0,flat:!0},r),o,s=!1;for await(let a of t){if(a==null)continue;let c=`${a.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(o==null?(o=c,s=!0):o!==c&&(s=!1)),i=await Hee(a,i,r),a.unixfs?.isDirectory()!==!0&&(yield a)}if(r.wrapWithDirectory||s&&i.childCount()>1)yield*iF(i,n);else for(let a of i.eachChildSeries())a!=null&&(yield*iF(a.child,n))}}async function*ju(r,e,t={}){let n;Symbol.asyncIterator in r||Symbol.iterator in r?n=r:n=[r];let i=t.wrapWithDirectory??!1,o=t.shardSplitThresholdBytes??262144,s=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,l=t.leafType??"file",u=t.fileImportConcurrency??50,f=t.blockWriteConcurrency??10,h=t.reduceSingleLeafToSelf??!0,d=t.chunker??J0(),m=t.chunkValidator??ZU(),y=t.dagBuilder??QU({chunker:d,chunkValidator:m,wrapWithDirectory:i,layout:t.layout??eg(),bufferImporter:t.bufferImporter??WU({cidVersion:a,rawLeaves:c,leafType:l,onProgress:t.onProgress}),blockWriteConcurrency:f,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:t.onProgress,dirBuilder:t.dirBuilder,fileBuilder:t.fileBuilder}),w=t.treeBuilder??oF({wrapWithDirectory:i,shardSplitThresholdBytes:o,shardFanoutBits:s,cidVersion:a,onProgress:t.onProgress});for await(let x of w(Z0(y(n,e),u),e))yield{cid:x.cid,path:x.path,unixfs:x.unixfs,size:x.size}}async function sF(r,e,t={}){let n=await dd(ju([r],e,t));if(n==null)throw new dw("Nothing imported");return n}async function aF(r,e,t={}){return sF({content:r},e,t)}async function cF(r,e,t={}){return sF({content:r},e,t)}var ng={cidVersion:1,rawLeaves:!0,layout:eg({maxChildrenPerNode:1024}),chunker:J0({chunkSize:1048576})};async function*hw(r,e,t={}){yield*ju(r,e,{...ng,...t})}async function lF(r,e,t={}){let{cid:n}=await aF(r,e,{...ng,...t});return n}async function uF(r,e,t={}){let{cid:n}=await cF(r,e,{...ng,...t});return n}async function fF(r,e,t={}){if(r.path==null)throw new Ar("path is required");if(r.content==null)throw new Ar("content is required");let n=await To(hw([r],e,{...ng,...t,wrapWithDirectory:!0}));if(n==null)throw new Ar("Nothing imported");return n.cid}async function dF(r,e,t={}){if(r.content!=null)throw new Ar("Directories cannot have content, use addFile instead");let i=await(r.path==null?dd:To)(hw([{...r,path:r.path??"-"}],e,{...ng,...t,wrapWithDirectory:r.path!=null}));if(i==null)throw new Ar("Nothing imported");return i.cid}var PA=bt(ow(),1);function mw(r){function e(t){return t instanceof pw?t:new pw(t,r)}return e}var pw=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let i=this._buffers[this._currentBufferIndex],o=Math.min(i.availableBits(),t),s=i.take(o);n=(n<<o)+s,t-=o,this._availableBits-=o,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?it([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new TA(t);this._buffers.push(n),this._availableBits+=n.availableBits()}},Vee=[255,254,252,248,240,224,192,128],zee=[1,3,7,15,31,63,127,255],TA=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let i=this._value[this._currentBytePos],o=this._currentBitPos+1,s=Math.min(o,t),a=Kee(i,o-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function Kee(r,e,t){let n=qee(e,t);return(r&n)>>>e}function qee(r,e){return Vee[r]&zee[Math.min(e+r-1,7)]}var ig=BigInt(Ku.code),Wu=8;async function Dh(r){return(await Ku.encode(r)).subarray(0,8).reverse()}var mF=bt(ow(),1);var Po=async(r,e,t)=>{t.codec==null&&(t.codec=nr);let n=await ze.digest(r),i=j.create(t.cidVersion??1,t.codec.code,n);return await e.put(i,r,{...t,signal:t.signal}),i};var IA=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},gw=class extends IA{_bucket;constructor(e,t){super(e,t),this._bucket=Th({hashFn:Dh,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=pF(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of hF(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*hF(r,e,t,n){let i=r._children,o=[],s=0n;for(let d=0;d<i.length;d++){let m=i.get(d);if(m==null)continue;let y=d.toString(16).toUpperCase().padStart(2,"0");if(m instanceof Ei){let w;for await(let x of hF(m,e,null,n))w=x;if(w==null)throw new Error("Could not flush sharded directory, no sub-shard found");o.push({Name:y,Tsize:Number(w.size),Hash:w.cid}),s+=w.size}else if(Wee(m.value)){let w=m.value,x;for await(let E of w.flush(e))x=E,yield x;if(x==null)throw new Error("Did not flush dir");let v=y+m.key;o.push({Name:v,Tsize:Number(x.size),Hash:x.cid}),s+=x.size}else{let w=m.value;if(w.cid==null)continue;let x=y+m.key,v=w.size;o.push({Name:x,Tsize:Number(v),Hash:w.cid}),s+=BigInt(v??0)}}let a=Uint8Array.from(i.bitField().reverse()),c=new Ee({type:"hamt-sharded-directory",data:a,fanout:BigInt(r.tableSize()),hashType:ig,mtime:t?.mtime,mode:t?.mode}),l={Data:c.marshal(),Links:o},u=Je(Gt(l)),f=await Po(u,e,n),h=BigInt(u.byteLength)+s;yield{cid:f,unixfs:c,size:h}}function Wee(r){return typeof r.flush=="function"}function pF(r,e,t){let n=r._children,i=[];for(let c=0;c<n.length;c++){let l=n.get(c);if(l==null)continue;let u=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof Ei){let f=pF(l,null,t);i.push({Name:u,Tsize:Number(f),Hash:t.cidVersion===0?yw:ww})}else if(typeof l.value.flush=="function"){let h=l.value.nodeSize();i.push({Name:u+l.key,Tsize:Number(h),Hash:t.cidVersion===0?yw:ww})}else{let f=l.value;if(f.cid==null)continue;let h=u+l.key,d=f.size;i.push({Name:h,Tsize:Number(d),Hash:f.cid})}}let o=Uint8Array.from(n.bitField().reverse()),s=new Ee({type:"hamt-sharded-directory",data:o,fanout:BigInt(r.tableSize()),hashType:ig,mtime:e?.mtime,mode:e?.mode});return Je(Gt({Data:s.marshal(),Links:i})).length}var yw=j.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),ww=j.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var kA=Ze("helia:unixfs:commands:utils:hamt-utils"),xw=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),gF=async(r,e,t)=>{let n=new gw({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let o=0;o<e.length;o++)await n._bucket.put(e[o].name,{size:e[o].size,cid:e[o].cid});let i=await To(n.flush(r));if(i==null)throw new Error("Flushing shard yielded no result");return i},bw=async(r,e,t)=>{let n=Ee.unmarshal(r[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,Wu));r.reverse();let o,s;for(let a=0;a<r.length;a++){let c=a===r.length-1,l=r[a],u=Uint8Array.from(l.children.bitField().reverse()),f=new Ee({type:"hamt-sharded-directory",data:u,fanout:i,hashType:ig});c&&(f.mtime=n.mtime,f.mode=n.mode),s={Data:f.marshal(),Links:l.node.Links};let h=Je(Gt(s));if(o=await Po(h,e,t),!c){let d=r[a+1];if(d==null)throw new Error("Was not operating on shard root but also had no parent?");kA("updating link in parent sub-shard with prefix %s",d.prefix),d.node.Links=d.node.Links.filter(m=>m.Name!==d.prefix),d.node.Links.push({Name:d.prefix,Hash:o,Tsize:l.node.Links.reduce((m,y)=>m+(y.Tsize??0),h.byteLength)})}}if(o==null||s==null)throw new Error("Noting persisted");return{cid:o,node:s}},vw=async(r,e,t,n)=>{let o=mw(Dh)(R(e)),s=[];for(;;){let a=await Ne(t.get(r,n)),c=rr(a),l=new mF.default,u=await o.take(Wu),f=xw(u);s.push({prefix:f,children:l,node:c});let h;for(let m of c.Links){let y=m.Name??"";if(y.length<2)throw new Error("Invalid HAMT - link name was too short");let w=parseInt(y.substring(0,2),16);l.set(w,!0),y.startsWith(f)&&(h=m)}if(h==null){kA("no link found with prefix %s for %s",f,e);break}let d=h.Name??"";if(d.length<2)throw new Error("Invalid HAMT - link name was too short");if(d.length===2){r=h.Hash,kA("descend into sub-shard with prefix %s",d);continue}break}return{path:s,hash:o}};async function Ew(r,e,t,n){if(r.Data==null)throw new Error("DagPB node had no data");let i=Ee.unmarshal(r.Data),o;if(i.type==="directory")o=Gee(r);else if(i.type==="hamt-sharded-directory")o=await yF(r,0,t,e,n);else throw new Error("Can only estimate the size of directories or shards");return o>t}function Gee(r){let e=0;for(let t of r.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?ww.bytes.byteLength:yw.bytes.byteLength;return e}async function yF(r,e,t,n,i){if(e>t)return t;if(r.Data==null||!Ee.unmarshal(r.Data).isDirectory())return e;for(let s of r.Links){let a=s.Name??"";if(a=a.substring(2),e+=a.length,e+=s.Hash.bytes.byteLength,s.Hash.code===gt){let c=await Ne(n.get(s.Hash,i)),l=rr(c);e+=await yF(l,e,t,n,i)}}return e}var ys=Ze("helia:unixfs:components:utils:add-link");async function Oh(r,e,t,n){if(r.node.Data==null)throw new Ar("Invalid parent passed to addLink");if(Ee.unmarshal(r.node.Data).type==="hamt-sharded-directory")return ys("adding link to sharded directory"),Zee(r,e,t,n);ys(`adding ${e.Name} (${e.Hash}) to regular directory`);let o=await Qee(r,e,t,n);if(await Ew(o.node,t,n.shardSplitThresholdBytes??262144,n)){ys("converting directory to sharded directory");let s=await Yee(o,t);o.cid=s.cid,o.node=rr(await Ne(t.get(s.cid,n)))}return o}var Yee=async(r,e)=>{if(r.node.Data==null)throw new Ar("Invalid parent passed to convertToShardedDirectory");let t=Ee.unmarshal(r.node.Data),n=await gF(e,r.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:r.cid.version});return ys(`converted directory to sharded directory ${n.cid}`),n},Qee=async(r,e,t,n)=>{let i=r.node.Links.filter(u=>{let f=u.Name===e.Name;if(f&&!n.allowOverwriting)throw new Q0;return!f});if(i.push(e),r.node.Data==null)throw new Zn("Parent node with no data passed to addToDirectory");let o=Ee.unmarshal(r.node.Data),s;if(o.mtime!=null){let u=Date.now(),f=Math.floor(u/1e3);o.mtime={secs:BigInt(f),nsecs:(u-f*1e3)*1e3},s=o.marshal()}else s=r.node.Data;r.node=Gt({Data:s,Links:i});let a=Je(r.node),c=await ze.digest(a),l=j.create(r.cid.version,gt,c);return await t.put(l,a),{node:r.node,cid:l}},Zee=async(r,e,t,n)=>{let{path:i,hash:o}=await vw(r.cid,e.Name,t,n),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");let a=s.prefix,c=parseInt(a,16);ys("next prefix for %s is %s",e.Name,a);let l=`${a}${e.Name}`,u=s.node.Links.find(f=>(f.Name??"").startsWith(a));if(u!=null)if(ys("link %s was present in shard",l),u.Name===l){if(!n.allowOverwriting)throw new Q0;ys("overwriting %s in sub-shard",e.Name),s.node.Links=s.node.Links.filter(f=>f.Name!==l),s.node.Links.push({Name:l,Hash:e.Hash,Tsize:e.Tsize})}else{if(u.Name?.length===2)throw new Error("Existing link was sub-shard?!");{ys("prefix %s already exists, creating new sub-shard",a);let f=s.node.Links.findIndex(w=>w.Name?.startsWith(a)),h=s.node.Links.splice(f,1)[0],d=(h.Name??"").substring(2),y=mw(Dh)(R(d));for(let w=0;w<i.length;w++)await y.take(Wu);for(;;){let w=await y.take(Wu),x=xw(w);h.Name=`${x}${d}`;let v=await o.take(Wu),E=xw(v);if(x===E){let B=new PA.default;B.set(v,!0),i.push({prefix:E,children:B,node:{Links:[]}});continue}let _=new PA.default;_.set(v,!0),_.set(w,!0),i.push({prefix:a,children:_,node:{Links:[h,{Name:`${E}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else ys("link %s was not present in sub-shard",l),e.Name=l,s.node.Links.push(e),s.children.set(c,!0),ys("adding %s to existing sub-shard",l);return bw(i,t,n)};async function Fc(r,e,t={}){let n=await gr(r,e,t);if(n.type!=="directory")throw new Mc(`${r.toString()} was not a UnixFS directory`);return{cid:r,node:n.node}}async function Nh(r,e,t,n){let i=await gr(r,t,n);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new Si(`${r.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:Jee(i.node),Hash:r}}function Jee(r){let e=r.Links.reduce((t,n)=>t+(n.Tsize??0),0);return Je(r).byteLength+e}var ete=Ze("helia:unixfs:components:utils:resolve");async function ws(r,e,t,n){if(e==null||e==="")return{cid:r};let i=`/ipfs/${r}${e==null?"":`/${e}`}`,o=await fo(Y0(i,t,n));if(o.length===0)throw new Ph("Could not find path in directory");return ete("resolved %s to %c",e,r),{cid:o[o.length-1].cid,path:e,segments:o}}async function Lh(r,e,t,n){if(e.segments==null||e.segments.length===0)return r;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=r,e.segments.reverse();for(let o of e.segments){let[s,a]=await Promise.all([Fc(o.cid,t,n),Nh(i.cid,i.name,t,n)]);r=(await Oh(s,a,t,{...n,allowOverwriting:!0,cidVersion:r.version})).cid,o.cid=r,i=o}return r}async function*wF(r,e,t={}){let n=await ws(r,t.path,e,t),i=await gr(n.cid,e,t);if(i.type!=="file"&&i.type!=="raw")throw new lw;if(i.content==null)throw new Rh;yield*i.content(t)}var tte=Ze("helia:unixfs:chmod");async function xF(r,e,t,n={}){let i=await ws(r,n.path,t,n);if(tte("chmod %c %d",i.cid,e),n.recursive===!0){let f=await br(async function*(){for await(let h of kh(i.cid,t,n)){let d,m=[];if(h.type==="raw")d=new Ee({type:"file",data:h.node});else if(h.type==="file"||h.type==="directory")d=h.unixfs,m=h.node.Links;else throw new Si;d.mode=e;let y={Data:d.marshal(),Links:m};yield{path:h.path,content:y}}},h=>ju(h,t,{...n,dagBuilder:async function*(d,m){for await(let y of d)yield async function(){let w=y.content,x=Je(w),v=await Po(x,m,{...n,cidVersion:r.version});if(w.Data==null)throw new Zn(`${v} had no data`);let E=Ee.unmarshal(w.Data);return{cid:v,size:BigInt(x.length),path:y.path,unixfs:E}}}}),async h=>To(h));if(f==null)throw new Bc(`Could not chmod ${i.cid.toString()}`);return Lh(f.cid,i,t,n)}let o=await Ne(t.get(i.cid,n)),s,a=[];if(i.cid.code===vt)s=new Ee({type:"file",data:o});else{let f=rr(o);if(f.Data==null)throw new Zn(`${i.cid.toString()} had no data`);a=f.Links,s=Ee.unmarshal(f.Data)}s.mode=e;let c=Je({Data:s.marshal(),Links:a}),l=await ze.digest(c),u=j.create(i.cid.version,gt,l);return await t.put(u,c),Lh(u,i,t,n)}var rte=Ze("helia:unixfs:cp");async function bF(r,e,t,n,i={}){if(t.includes("/"))throw new Ar("Name must not have slashes");let[o,s]=await Promise.all([Fc(e,n,i),Nh(r,t,n,i)]);return rte('Adding %c as "%s" to %c',r,t,e),(await Oh(o,s,n,{allowOverwriting:i.force,cidVersion:e.version,...i})).cid}async function*vF(r,e,t={}){let n=await ws(r,t.path,e,t),i=await gr(n.cid,e,{...t,extended:!0});if(i.type==="file"||i.type==="raw"){t.extended===!1?yield{name:i.name,path:i.path,cid:i.cid}:yield i;return}if(i.content==null)throw new Rh;if(i.type!=="directory")throw new Mc;yield*i.content(t)}var EF=Ze("helia:unixfs:mkdir");async function SF(r,e,t,n={}){if(e.includes("/"))throw new Ar("Path must not have slashes");if((await gr(r,t,n)).type!=="directory")throw new Mc(`${r.toString()} was not a UnixFS directory`);EF("creating %s",e);let s={Data:new Ee({type:"directory",mode:n.mode,mtime:n.mtime}).marshal(),Links:[]},a=Je(s),c=await ze.digest(a),l=j.create(n.cidVersion??1,gt,c);await t.put(l,a);let[u,f]=await Promise.all([Fc(r,t,n),Nh(l,e,t,n)]);return EF("adding empty dir called %s to %c",e,r),(await Oh(u,f,t,{...n,allowOverwriting:n.force})).cid}var Sw=Ze("helia:unixfs:utils:remove-link");async function AF(r,e,t,n){if(r.node.Data==null)throw new Zn("Parent node had no data");if(Ee.unmarshal(r.node.Data).type==="hamt-sharded-directory"){Sw(`removing ${e} from sharded directory`);let o=await ite(r,e,t,n);return await Ew(o.node,t,n.shardSplitThresholdBytes??262144,n)?o:(Sw("converting shard to flat directory %c",r.cid),ote(o,t,n))}return Sw(`removing link ${e} regular directory`),nte(r,e,t,n)}var nte=async(r,e,t,n)=>{r.node.Links=r.node.Links.filter(s=>s.Name!==e);let i=Je(r.node),o=await Po(i,t,{...n,cidVersion:r.cid.version});return Sw(`Updated regular directory ${o}`),{node:r.node,cid:o}},ite=async(r,e,t,n)=>{let{path:i}=await vw(r.cid,e,t,n),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");let s=o.node.Links.filter(l=>(l.Name??"").substring(2)===e).map(l=>l.Name).pop();if(s==null)throw new Error("File not found");let a=s.substring(0,2),c=parseInt(a,16);if(o.node.Links=o.node.Links.filter(l=>l.Name!==s),o.children.unset(c),o.node.Links.length===1)for(;i.length!==1;){let l=i[i.length-1];if(l==null||l.node.Links.length>1)break;i.pop();let u=i[i.length-1];if(u==null)break;let f=l.node.Links[0];u.node.Links=u.node.Links.filter(h=>!(h.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:f.Hash,Name:`${u.prefix}${(f.Name??"").substring(2)}`,Tsize:f.Tsize})}return bw(i,t,n)},ote=async(r,e,t)=>{if(r.node.Data==null)throw new Ar("Invalid parent passed to convertToFlatDirectory");let n={Links:[]},i=await gr(r.cid,e);if(i.type!=="directory")throw new Error("Unexpected node type");for await(let c of i.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=Je(c.node).length,n.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}let o=Ee.unmarshal(r.node.Data);n.Data=new Ee({type:"directory",mode:o.mode,mtime:o.mtime}).marshal();let s=Je(Gt(n));return{cid:await Po(s,e,{codec:nr,cidVersion:r.cid.version,signal:t.signal}),node:n}};var ste=Ze("helia:unixfs:rm");async function _F(r,e,t,n={}){if(e.includes("/"))throw new Ar("Name must not have slashes");let i=await Fc(r,t,n);return ste("Removing %s from %c",e,r),(await AF(i,e,t,{...n,cidVersion:r.version})).cid}var CF=1877,Aw=1604,ate=Ze("helia:unixfs:stat");async function TF(r,e,t={}){let n=await ws(r,t.path,e,t);ate("stat %c",n.cid);let i=await gr(n.cid,e,t);if(i.type==="raw")return t.extended===!0?fte(i):ute(i);if(i.type==="file"||i.type==="directory")return t.extended===!0?lte(i,e,t.filter??new Uf({filterSize:1024}),t):cte(i);throw new Si}function cte(r){return{type:r.type,cid:r.cid,unixfs:r.unixfs,mode:r.unixfs.mode??(r.unixfs.isDirectory()?CF:Aw),mtime:r.unixfs.mtime,size:r.unixfs.fileSize()}}async function lte(r,e,t,n){let i=await IF(r.cid,e,!1,t,n);return{type:r.type,cid:r.cid,unixfs:r.unixfs,size:r.unixfs.isDirectory()?i.dirSize:r.unixfs.fileSize(),mode:r.unixfs.mode??(r.unixfs.isDirectory()?CF:Aw),mtime:r.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function ute(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:Aw,mtime:void 0,size:BigInt(r.node.byteLength)}}function fte(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:Aw,mtime:void 0,size:BigInt(r.node.byteLength),localSize:BigInt(r.node.byteLength),dagSize:BigInt(r.node.byteLength),deduplicatedDagSize:BigInt(r.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function IF(r,e,t,n,i){let o={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{let s=n.has(r.bytes);n.add(r.bytes);let a=await Ne(e.get(r,i));if(o.blocks++,o.dagSize+=BigInt(a.byteLength),s||(o.uniqueBlocks++,o.deduplicatedDagSize+=BigInt(a.byteLength)),r.code===vt)o.localSize+=BigInt(a.byteLength),t&&(o.dirSize+=BigInt(a.byteLength));else if(r.code===gt){let c=rr(a),l;if(c.Data!=null&&(l=Ee.unmarshal(c.Data)),c.Links.length>0){for(let u of c.Links){let f=await IF(u.Hash,e,dte(u,l),n,i);o.localSize+=f.localSize,o.dagSize+=f.dagSize,o.deduplicatedDagSize+=f.deduplicatedDagSize,o.blocks+=f.blocks,o.uniqueBlocks+=f.uniqueBlocks,o.dirSize+=f.dirSize}t&&l!=null&&(o.dirSize+=l.fileSize())}else{if(l==null)throw new Zn(`PBNode ${r.toString()} had no data`);l.data!=null&&(o.localSize+=BigInt(l.data.byteLength??0)),t&&(o.dirSize+=l.fileSize())}}else throw new Bc(`${r.toString()} was neither DAG_PB nor RAW`)}catch(s){if(s.name!=="NotFoundError"||i.offline!==!0)throw s}return o}function dte(r,e){if(e==null)return!1;let t=r.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}var hte=Ze("helia:unixfs:touch");async function kF(r,e,t={}){let n=await ws(r,t.path,e,t),i=t.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(hte("touch %c %o",n.cid,i),t.recursive){let f=await br(async function*(){for await(let h of kh(n.cid,e)){let d,m;if(h.type==="raw")d=new Ee({data:h.node}),m=[];else if(h.type==="file"||h.type==="directory")d=h.unixfs,m=h.node.Links;else throw new Si;d.mtime=i;let y={Data:d.marshal(),Links:m};yield{path:h.path,content:y}}},h=>ju(h,e,{...t,dagBuilder:async function*(d,m){for await(let y of d)yield async function(){let w=y.content,x=Je(w),v=await Po(x,m,{...t,cidVersion:r.version});if(w.Data==null)throw new Zn(`${v} had no data`);let E=Ee.unmarshal(w.Data);return{cid:v,size:BigInt(x.length),path:y.path,unixfs:E}}}}),async h=>To(h));if(f==null)throw new Bc(`Could not chmod ${n.cid.toString()}`);return Lh(f.cid,n,e,t)}let o=await Ne(e.get(n.cid,t)),s,a=[];if(n.cid.code===vt)s=new Ee({data:o});else{let f=rr(o);if(a=f.Links,f.Data==null)throw new Zn(`${n.cid.toString()} had no data`);s=Ee.unmarshal(f.Data)}s.mtime=i;let c=Je({Data:s.marshal(),Links:a}),l=await ze.digest(c),u=j.create(n.cid.version,gt,l);return await e.put(u,c),Lh(u,n,e,t)}var _w=class{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*hw(e,this.components.blockstore,t)}async addBytes(e,t={}){return lF(e,this.components.blockstore,t)}async addByteStream(e,t={}){return uF(e,this.components.blockstore,t)}async addFile(e,t={}){return fF(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return dF(e,this.components.blockstore,t)}async*cat(e,t={}){yield*wF(e,this.components.blockstore,t)}async chmod(e,t,n={}){return xF(e,t,this.components.blockstore,n)}async cp(e,t,n,i={}){return bF(e,t,n,this.components.blockstore,i)}async*ls(e,t={}){yield*vF(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return SF(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return _F(e,t,this.components.blockstore,n)}async stat(e,t={}){return TF(e,this.components.blockstore,t)}async touch(e,t={}){return kF(e,this.components.blockstore,t)}};function PF(r){return new _w(r)}var OF=bt(RF(),1);var DA={128:"\u20AC",130:"\u201A",131:"\u0192",132:"\u201E",133:"\u2026",134:"\u2020",135:"\u2021",136:"\u02C6",137:"\u2030",138:"\u0160",139:"\u2039",140:"\u0152",142:"\u017D",145:"\u2018",146:"\u2019",147:"\u201C",148:"\u201D",149:"\u2022",150:"\u2013",151:"\u2014",152:"\u02DC",153:"\u2122",154:"\u0161",155:"\u203A",156:"\u0153",158:"\u017E",159:"\u0178"},pte={};for(let[r,e]of Object.entries(DA))pte[e]=Number.parseInt(r);function DF(r,e="utf-8"){switch(e.toLowerCase()){case"utf-8":case"utf8":return typeof globalThis.TextDecoder<"u"?new globalThis.TextDecoder("utf-8").decode(r):mte(r);case"utf-16le":return gte(r);case"ascii":return yte(r);case"latin1":case"iso-8859-1":return wte(r);case"windows-1252":return xte(r);default:throw new RangeError(`Encoding '${e}' not supported`)}}function mte(r){let e="",t=0;for(;t<r.length;){let n=r[t++];if(n<128)e+=String.fromCharCode(n);else if(n<224){let i=r[t++]&63;e+=String.fromCharCode((n&31)<<6|i)}else if(n<240){let i=r[t++]&63,o=r[t++]&63;e+=String.fromCharCode((n&15)<<12|i<<6|o)}else{let i=r[t++]&63,o=r[t++]&63,s=r[t++]&63,a=(n&7)<<18|i<<12|o<<6|s;a-=65536,e+=String.fromCharCode(55296+(a>>10&1023),56320+(a&1023))}}return e}function gte(r){let e="";for(let t=0;t<r.length;t+=2)e+=String.fromCharCode(r[t]|r[t+1]<<8);return e}function yte(r){return String.fromCharCode(...r.map(e=>e&127))}function wte(r){return String.fromCharCode(...r)}function xte(r){let e="";for(let t of r)t>=128&&t<=159&&DA[t]?e+=DA[t]:e+=String.fromCharCode(t);return e}function Jn(r){return new DataView(r.buffer,r.byteOffset)}var NF={len:1,get(r,e){return Jn(r).getUint8(e)},put(r,e,t){return Jn(r).setUint8(e,t),e+1}},Bt={len:2,get(r,e){return Jn(r).getUint16(e,!0)},put(r,e,t){return Jn(r).setUint16(e,t,!0),e+2}},Bh={len:2,get(r,e){return Jn(r).getUint16(e)},put(r,e,t){return Jn(r).setUint16(e,t),e+2}};var ir={len:4,get(r,e){return Jn(r).getUint32(e,!0)},put(r,e,t){return Jn(r).setUint32(e,t,!0),e+4}},LF={len:4,get(r,e){return Jn(r).getUint32(e)},put(r,e,t){return Jn(r).setUint32(e,t),e+4}};var BF={len:4,get(r,e){return Jn(r).getInt32(e)},put(r,e,t){return Jn(r).setInt32(e,t),e+4}};var MF={len:8,get(r,e){return Jn(r).getBigUint64(e,!0)},put(r,e,t){return Jn(r).setBigUint64(e,t,!0),e+8}};var ei=class{constructor(e,t){this.len=e,this.encoding=t}get(e,t=0){let n=e.subarray(t,t+this.len);return DF(n,this.encoding)}};var vte="End-Of-Stream",zt=class extends Error{constructor(){super(vte),this.name="EndOfStreamError"}},Gu=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var Xu=class{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}async peek(e,t=!1){let n=await this.read(e,t);return this.peekQueue.push(e.subarray(0,n)),n}async read(e,t=!1){if(e.length===0)return 0;let n=this.readFromPeekBuffer(e);if(this.endOfStream||(n+=await this.readRemainderFromStream(e.subarray(n),t)),n===0&&!t)throw new zt;return n}readFromPeekBuffer(e){let t=e.length,n=0;for(;this.peekQueue.length>0&&t>0;){let i=this.peekQueue.pop();if(!i)throw new Error("peekData should be defined");let o=Math.min(i.length,t);e.set(i.subarray(0,o),n),n+=o,t-=o,o<i.length&&this.peekQueue.push(i.subarray(o))}return n}async readRemainderFromStream(e,t){let n=0;for(;n<e.length&&!this.endOfStream;){if(this.interrupted)throw new Gu;let i=await this.readFromStream(e.subarray(n),t);if(i===0)break;n+=i}if(!t&&n<e.length)throw new zt;return n}};var Cw=class extends Xu{constructor(e){super(),this.reader=e}async abort(){return this.close()}async close(){this.reader.releaseLock()}};var og=class extends Cw{async readFromStream(e,t){if(e.length===0)return 0;let n=await this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return n.done&&(this.endOfStream=n.done),n.value?(e.set(n.value),n.value.length):0}};var Mh=class extends Xu{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){let n=Math.min(t.length,e.length);return e.set(t.subarray(0,n)),n<t.length?this.buffer=t.subarray(n):this.buffer=null,n}async readFromStream(e,t){if(e.length===0)return 0;let n=0;for(this.buffer&&(n+=this.writeChunk(e,this.buffer));n<e.length&&!this.endOfStream;){let i=await this.reader.read();if(i.done){this.endOfStream=!0;break}i.value&&(n+=this.writeChunk(e.subarray(n),i.value))}if(!t&&n===0&&this.endOfStream)throw new zt;return n}abort(){return this.interrupted=!0,this.reader.cancel()}async close(){await this.abort(),this.reader.releaseLock()}};function OA(r){try{let e=r.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new Mh(e):new og(e)}catch(e){if(e instanceof TypeError)return new Mh(r.getReader());throw e}}var $c=class{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e?.onClose,e?.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}async readToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.readBuffer(n,{position:t})<e.len)throw new zt;return e.get(n,0)}async peekToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.peekBuffer(n,{position:t})<e.len)throw new zt;return e.get(n,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new zt;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new zt;return e.get(this.numBuffer,0)}async ignore(e){if(this.fileInfo.size!==void 0){let t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){await this.abort(),await this.onClose?.()}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return{mayBeLess:!1,offset:0,length:e.length,position:this.position,...t}}abort(){return Promise.resolve()}};var Ste=256e3,Tw=class extends $c{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=t?.fileInfo??{}}async readBuffer(e,t){let n=this.normalizeOptions(e,t),i=n.position-this.position;if(i>0)return await this.ignore(i),this.readBuffer(e,t);if(i<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(n.length===0)return 0;let o=await this.streamReader.read(e.subarray(0,n.length),n.mayBeLess);if(this.position+=o,(!t||!t.mayBeLess)&&o<n.length)throw new zt;return o}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),i=0;if(n.position){let o=n.position-this.position;if(o>0){let s=new Uint8Array(n.length+o);return i=await this.peekBuffer(s,{mayBeLess:n.mayBeLess}),e.set(s.subarray(o)),i-o}if(o<0)throw new Error("Cannot peek from a negative offset in a stream")}if(n.length>0){try{i=await this.streamReader.peek(e.subarray(0,n.length),n.mayBeLess)}catch(o){if(t?.mayBeLess&&o instanceof zt)return 0;throw o}if(!n.mayBeLess&&i<n.length)throw new zt}return i}async ignore(e){let t=Math.min(Ste,e),n=new Uint8Array(t),i=0;for(;i<e;){let o=e-i,s=await this.readBuffer(n,{length:Math.min(t,o)});if(s<0)return s;i+=s}return i}abort(){return this.streamReader.abort()}async close(){return this.streamReader.close()}supportsRandomAccess(){return!1}};var Iw=class extends $c{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo={...t?.fileInfo??{},size:e.length}}async readBuffer(e,t){t?.position&&(this.position=t.position);let n=await this.peekBuffer(e,t);return this.position+=n,n}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),i=Math.min(this.uint8Array.length-n.position,n.length);if(!n.mayBeLess&&i<n.length)throw new zt;return e.set(this.uint8Array.subarray(n.position,n.position+i)),i}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}};function UF(r,e){let t=OA(r),n=e??{},i=n.onClose;return n.onClose=async()=>{if(await t.close(),i)return i()},new Tw(t,n)}function FF(r,e){return new Iw(r,e)}var _i=Uint8Array,Uh=Uint16Array,_te=Int32Array,$F=new _i([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),HF=new _i([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Cte=new _i([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),VF=function(r,e){for(var t=new Uh(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var i=new _te(t[30]),n=1;n<30;++n)for(var o=t[n];o<t[n+1];++o)i[o]=o-t[n]<<5|n;return{b:t,r:i}},zF=VF($F,2),KF=zF.b,Tte=zF.r;KF[28]=258,Tte[258]=28;var qF=VF(HF,0),Ite=qF.b,kct=qF.r,BA=new Uh(32768);for(dt=0;dt<32768;++dt)ya=(dt&43690)>>1|(dt&21845)<<1,ya=(ya&52428)>>2|(ya&13107)<<2,ya=(ya&61680)>>4|(ya&3855)<<4,BA[dt]=((ya&65280)>>8|(ya&255)<<8)>>1;var ya,dt,sg=(function(r,e,t){for(var n=r.length,i=0,o=new Uh(e);i<n;++i)r[i]&&++o[r[i]-1];var s=new Uh(e);for(i=1;i<e;++i)s[i]=s[i-1]+o[i-1]<<1;var a;if(t){a=new Uh(1<<e);var c=15-e;for(i=0;i<n;++i)if(r[i])for(var l=i<<4|r[i],u=e-r[i],f=s[r[i]-1]++<<u,h=f|(1<<u)-1;f<=h;++f)a[BA[f]>>c]=l}else for(a=new Uh(n),i=0;i<n;++i)r[i]&&(a[i]=BA[s[r[i]-1]++]>>15-r[i]);return a}),ag=new _i(288);for(dt=0;dt<144;++dt)ag[dt]=8;var dt;for(dt=144;dt<256;++dt)ag[dt]=9;var dt;for(dt=256;dt<280;++dt)ag[dt]=7;var dt;for(dt=280;dt<288;++dt)ag[dt]=8;var dt,jF=new _i(32);for(dt=0;dt<32;++dt)jF[dt]=5;var dt;var kte=sg(ag,9,1);var Pte=sg(jF,5,1),NA=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},Ro=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},LA=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},Rte=function(r){return(r+7)/8|0},Dte=function(r,e,t){return(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length),new _i(r.subarray(e,t))};var Ote=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ai=function(r,e,t){var n=new Error(e||Ote[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,Ai),!t)throw n;return n},MA=function(r,e,t,n){var i=r.length,o=n?n.length:0;if(!i||e.f&&!e.l)return t||new _i(0);var s=!t,a=s||e.i!=2,c=e.i;s&&(t=new _i(i*3));var l=function(Ci){var On=t.length;if(Ci>On){var Wi=new _i(Math.max(On*2,Ci));Wi.set(t),t=Wi}},u=e.f||0,f=e.p||0,h=e.b||0,d=e.l,m=e.d,y=e.m,w=e.n,x=i*8;do{if(!d){u=Ro(r,f,1);var v=Ro(r,f+1,3);if(f+=3,v)if(v==1)d=kte,m=Pte,y=9,w=5;else if(v==2){var H=Ro(r,f,31)+257,U=Ro(r,f+10,15)+4,C=H+Ro(r,f+5,31)+1;f+=14;for(var I=new _i(C),W=new _i(19),z=0;z<U;++z)W[Cte[z]]=Ro(r,f+z*3,7);f+=U*3;for(var $=NA(W),S=(1<<$)-1,k=sg(W,$,1),z=0;z<C;){var T=k[Ro(r,f,S)];f+=T&15;var E=T>>4;if(E<16)I[z++]=E;else{var M=0,X=0;for(E==16?(X=3+Ro(r,f,3),f+=2,M=I[z-1]):E==17?(X=3+Ro(r,f,7),f+=3):E==18&&(X=11+Ro(r,f,127),f+=7);X--;)I[z++]=M}}var Y=I.subarray(0,H),F=I.subarray(H);y=NA(Y),w=NA(F),d=sg(Y,y,1),m=sg(F,w,1)}else Ai(1);else{var E=Rte(f)+4,_=r[E-4]|r[E-3]<<8,B=E+_;if(B>i){c&&Ai(0);break}a&&l(h+_),t.set(r.subarray(E,B),h),e.b=h+=_,e.p=f=B*8,e.f=u;continue}if(f>x){c&&Ai(0);break}}a&&l(h+131072);for(var Z=(1<<y)-1,te=(1<<w)-1,V=f;;V=f){var M=d[LA(r,f)&Z],Pe=M>>4;if(f+=M&15,f>x){c&&Ai(0);break}if(M||Ai(2),Pe<256)t[h++]=Pe;else if(Pe==256){V=f,d=null;break}else{var Be=Pe-254;if(Pe>264){var z=Pe-257,ce=$F[z];Be=Ro(r,f,(1<<ce)-1)+KF[z],f+=ce}var Me=m[LA(r,f)&te],Qe=Me>>4;Me||Ai(3),f+=Me&15;var F=Ite[Qe];if(Qe>3){var ce=HF[Qe];F+=LA(r,f)&(1<<ce)-1,f+=ce}if(f>x){c&&Ai(0);break}a&&l(h+131072);var xt=h+Be;if(h<F){var He=o-F,rt=Math.min(F,xt);for(He+h<0&&Ai(3);h<rt;++h)t[h]=n[He+h]}for(;h<xt;++h)t[h]=t[h-F]}}e.l=d,e.p=V,e.b=h,e.f=u,d&&(u=1,e.m=y,e.d=m,e.n=w)}while(!u);return h!=t.length&&s?Dte(t,0,h):t.subarray(0,h)};var Nte=new _i(0);var Lte=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&Ai(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!r[t++]);return t+(e&2)},Bte=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0};var Mte=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&Ai(6,"invalid zlib data"),(r[1]>>5&1)==+!e&&Ai(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Ute(r,e){return MA(r,{i:2},e&&e.out,e&&e.dictionary)}function Fte(r,e){var t=Lte(r);return t+8>r.length&&Ai(6,"invalid gzip data"),MA(r.subarray(t,-8),{i:2},e&&e.out||new _i(Bte(r)),e&&e.dictionary)}function $te(r,e){return MA(r.subarray(Mte(r,e&&e.dictionary),-4),{i:2},e&&e.out,e&&e.dictionary)}function WF(r,e){return r[0]==31&&r[1]==139&&r[2]==8?Fte(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Ute(r,e):$te(r,e)}var Hte=typeof TextDecoder<"u"&&new TextDecoder,Vte=0;try{Hte.decode(Nte,{stream:!0}),Vte=1}catch{}var r$=bt(ZF(),1);var Qu={LocalFileHeader:67324752,DataDescriptor:134695760,CentralFileHeader:33639248,EndOfCentralDirectory:101010256},UA={get(r){let e=Bt.get(r,6);return{signature:ir.get(r,0),compressedSize:ir.get(r,8),uncompressedSize:ir.get(r,12)}},len:16},JF={get(r){let e=Bt.get(r,6);return{signature:ir.get(r,0),minVersion:Bt.get(r,4),dataDescriptor:!!(e&8),compressedMethod:Bt.get(r,8),compressedSize:ir.get(r,18),uncompressedSize:ir.get(r,22),filenameLength:Bt.get(r,26),extraFieldLength:Bt.get(r,28),filename:null}},len:30},e$={get(r){return{signature:ir.get(r,0),nrOfThisDisk:Bt.get(r,4),nrOfThisDiskWithTheStart:Bt.get(r,6),nrOfEntriesOnThisDisk:Bt.get(r,8),nrOfEntriesOfSize:Bt.get(r,10),sizeOfCd:ir.get(r,12),offsetOfStartOfCd:ir.get(r,16),zipFileCommentLength:Bt.get(r,20)}},len:22},t$={get(r){let e=Bt.get(r,8);return{signature:ir.get(r,0),minVersion:Bt.get(r,6),dataDescriptor:!!(e&8),compressedMethod:Bt.get(r,10),compressedSize:ir.get(r,20),uncompressedSize:ir.get(r,24),filenameLength:Bt.get(r,28),extraFieldLength:Bt.get(r,30),fileCommentLength:Bt.get(r,32),relativeOffsetOfLocalHeader:ir.get(r,42),filename:null}},len:46};function n$(r){let e=new Uint8Array(ir.len);return ir.put(e,0,r),e}var xs=(0,r$.default)("tokenizer:inflate"),FA=256*1024,tre=n$(Qu.DataDescriptor),Rw=n$(Qu.EndOfCentralDirectory),Dw=class{constructor(e){this.tokenizer=e,this.syncBuffer=new Uint8Array(FA)}async isZip(){return await this.peekSignature()===Qu.LocalFileHeader}peekSignature(){return this.tokenizer.peekToken(ir)}async findEndOfCentralDirectoryLocator(){let e=this.tokenizer,t=Math.min(16*1024,e.fileInfo.size),n=this.syncBuffer.subarray(0,t);await this.tokenizer.readBuffer(n,{position:e.fileInfo.size-t});for(let i=n.length-4;i>=0;i--)if(n[i]===Rw[0]&&n[i+1]===Rw[1]&&n[i+2]===Rw[2]&&n[i+3]===Rw[3])return e.fileInfo.size-t+i;return-1}async readCentralDirectory(){if(!this.tokenizer.supportsRandomAccess()){xs("Cannot reading central-directory without random-read support");return}xs("Reading central-directory...");let e=this.tokenizer.position,t=await this.findEndOfCentralDirectoryLocator();if(t>0){xs("Central-directory 32-bit signature found");let n=await this.tokenizer.readToken(e$,t),i=[];this.tokenizer.setPosition(n.offsetOfStartOfCd);for(let o=0;o<n.nrOfEntriesOfSize;++o){let s=await this.tokenizer.readToken(t$);if(s.signature!==Qu.CentralFileHeader)throw new Error("Expected Central-File-Header signature");s.filename=await this.tokenizer.readToken(new ei(s.filenameLength,"utf-8")),await this.tokenizer.ignore(s.extraFieldLength),await this.tokenizer.ignore(s.fileCommentLength),i.push(s),xs(`Add central-directory file-entry: n=${o+1}/${i.length}: filename=${i[o].filename}`)}return this.tokenizer.setPosition(e),i}this.tokenizer.setPosition(e)}async unzip(e){let t=await this.readCentralDirectory();if(t)return this.iterateOverCentralDirectory(t,e);let n=!1;do{let i=await this.readLocalFileHeader();if(!i)break;let o=e(i);n=!!o.stop;let s;if(await this.tokenizer.ignore(i.extraFieldLength),i.dataDescriptor&&i.compressedSize===0){let a=[],c=FA;xs("Compressed-file-size unknown, scanning for next data-descriptor-signature....");let l=-1;for(;l<0&&c===FA;){c=await this.tokenizer.peekBuffer(this.syncBuffer,{mayBeLess:!0}),l=rre(this.syncBuffer.subarray(0,c),tre);let u=l>=0?l:c;if(o.handler){let f=new Uint8Array(u);await this.tokenizer.readBuffer(f),a.push(f)}else await this.tokenizer.ignore(u)}xs(`Found data-descriptor-signature at pos=${this.tokenizer.position}`),o.handler&&await this.inflate(i,nre(a),o.handler)}else o.handler?(xs(`Reading compressed-file-data: ${i.compressedSize} bytes`),s=new Uint8Array(i.compressedSize),await this.tokenizer.readBuffer(s),await this.inflate(i,s,o.handler)):(xs(`Ignoring compressed-file-data: ${i.compressedSize} bytes`),await this.tokenizer.ignore(i.compressedSize));if(xs(`Reading data-descriptor at pos=${this.tokenizer.position}`),i.dataDescriptor&&(await this.tokenizer.readToken(UA)).signature!==134695760)throw new Error(`Expected data-descriptor-signature at position ${this.tokenizer.position-UA.len}`)}while(!n)}async iterateOverCentralDirectory(e,t){for(let n of e){let i=t(n);if(i.handler){this.tokenizer.setPosition(n.relativeOffsetOfLocalHeader);let o=await this.readLocalFileHeader();if(o){await this.tokenizer.ignore(o.extraFieldLength);let s=new Uint8Array(n.compressedSize);await this.tokenizer.readBuffer(s),await this.inflate(o,s,i.handler)}}if(i.stop)break}}inflate(e,t,n){if(e.compressedMethod===0)return n(t);xs(`Decompress filename=${e.filename}, compressed-size=${t.length}`);let i=WF(t);return n(i)}async readLocalFileHeader(){let e=await this.tokenizer.peekToken(ir);if(e===Qu.LocalFileHeader){let t=await this.tokenizer.readToken(JF);return t.filename=await this.tokenizer.readToken(new ei(t.filenameLength,"utf-8")),t}if(e===Qu.CentralFileHeader)return!1;throw e===3759263696?new Error("Encrypted ZIP"):new Error("Unexpected signature")}};function rre(r,e){let t=r.length,n=e.length;if(n>t)return-1;for(let i=0;i<=t-n;i++){let o=!0;for(let s=0;s<n;s++)if(r[i+s]!==e[s]){o=!1;break}if(o)return i}return-1}function nre(r){let e=r.reduce((i,o)=>i+o.length,0),t=new Uint8Array(e),n=0;for(let i of r)t.set(i,n),n+=i.length;return t}var Fct={utf8:new globalThis.TextDecoder("utf8")};var $ct=new globalThis.TextEncoder;var Hct=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function $A(r){let{byteLength:e}=r;if(e===6)return r.getUint16(0)*2**32+r.getUint32(2);if(e===5)return r.getUint8(0)*2**32+r.getUint32(1);if(e===4)return r.getUint32(0);if(e===3)return r.getUint8(0)*2**16+r.getUint16(1);if(e===2)return r.getUint16(0);if(e===1)return r.getUint8(0)}function i$(r){return[...r].map(e=>e.charCodeAt(0))}function o$(r,e=0){let t=Number.parseInt(new ei(6).get(r,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(t))return!1;let n=256;for(let i=e;i<e+148;i++)n+=r[i];for(let i=e+156;i<e+512;i++)n+=r[i];return t===n}var s$={get:(r,e)=>r[e+3]&127|r[e+2]<<7|r[e+1]<<14|r[e]<<21,len:4};var a$=["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ttc","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx","vtt","apk","drc","lz4","potx","xltx","dotx","xltm","ott","ots","otp","odg","otg","xlsm","docm","dotm","potm","pptm","jar","rm","ppsm","ppsx"],c$=["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.ms-powerpoint.slideshow.macroenabled.12","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.slideshow","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/vnd.apache.arrow.file","video/mp4","audio/midi","video/matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","video/ogg","audio/ogg","audio/ogg; codecs=opus","application/ogg","audio/flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","font/collection","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","text/vtt","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/vnd.apache.parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio","application/vnd.android.package-archive","application/vnd.google.draco","application/x-lz4","application/vnd.openxmlformats-officedocument.presentationml.template","application/vnd.openxmlformats-officedocument.spreadsheetml.template","application/vnd.openxmlformats-officedocument.wordprocessingml.template","application/vnd.ms-excel.template.macroenabled.12","application/vnd.oasis.opendocument.text-template","application/vnd.oasis.opendocument.spreadsheet-template","application/vnd.oasis.opendocument.presentation-template","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.graphics-template","application/vnd.ms-excel.sheet.macroenabled.12","application/vnd.ms-word.document.macroenabled.12","application/vnd.ms-word.template.macroenabled.12","application/vnd.ms-powerpoint.template.macroenabled.12","application/vnd.ms-powerpoint.presentation.macroenabled.12","application/java-archive","application/vnd.rn-realmedia"];var HA=4100;async function l$(r,e){return new zA(e).fromBuffer(r)}function VA(r){switch(r=r.toLowerCase(),r){case"application/epub+zip":return{ext:"epub",mime:r};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:r};case"application/vnd.oasis.opendocument.text-template":return{ext:"ott",mime:r};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:r};case"application/vnd.oasis.opendocument.spreadsheet-template":return{ext:"ots",mime:r};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:r};case"application/vnd.oasis.opendocument.presentation-template":return{ext:"otp",mime:r};case"application/vnd.oasis.opendocument.graphics":return{ext:"odg",mime:r};case"application/vnd.oasis.opendocument.graphics-template":return{ext:"otg",mime:r};case"application/vnd.openxmlformats-officedocument.presentationml.slideshow":return{ext:"ppsx",mime:r};case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return{ext:"xlsx",mime:r};case"application/vnd.ms-excel.sheet.macroenabled":return{ext:"xlsm",mime:"application/vnd.ms-excel.sheet.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.template":return{ext:"xltx",mime:r};case"application/vnd.ms-excel.template.macroenabled":return{ext:"xltm",mime:"application/vnd.ms-excel.template.macroenabled.12"};case"application/vnd.ms-powerpoint.slideshow.macroenabled":return{ext:"ppsm",mime:"application/vnd.ms-powerpoint.slideshow.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return{ext:"docx",mime:r};case"application/vnd.ms-word.document.macroenabled":return{ext:"docm",mime:"application/vnd.ms-word.document.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.template":return{ext:"dotx",mime:r};case"application/vnd.ms-word.template.macroenabledtemplate":return{ext:"dotm",mime:"application/vnd.ms-word.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.template":return{ext:"potx",mime:r};case"application/vnd.ms-powerpoint.template.macroenabled":return{ext:"potm",mime:"application/vnd.ms-powerpoint.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.presentation":return{ext:"pptx",mime:r};case"application/vnd.ms-powerpoint.presentation.macroenabled":return{ext:"pptm",mime:"application/vnd.ms-powerpoint.presentation.macroenabled.12"};case"application/vnd.ms-visio.drawing":return{ext:"vsdx",mime:"application/vnd.visio"};case"application/vnd.ms-package.3dmanufacturing-3dmodel+xml":return{ext:"3mf",mime:"model/3mf"};default:}}function bs(r,e,t){t={offset:0,...t};for(let[n,i]of e.entries())if(t.mask){if(i!==(t.mask[n]&r[n+t.offset]))return!1}else if(i!==r[n+t.offset])return!1;return!0}var zA=class{constructor(e){this.options={mpegOffsetTolerance:0,...e},this.detectors=[...e?.customDetectors??[],{id:"core",detect:this.detectConfident},{id:"core.imprecise",detect:this.detectImprecise}],this.tokenizerOptions={abortSignal:e?.signal}}async fromTokenizer(e){let t=e.position;for(let n of this.detectors){let i=await n.detect(e);if(i)return i;if(t!==e.position)return}}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);let t=e instanceof Uint8Array?e:new Uint8Array(e);if(t?.length>1)return this.fromTokenizer(FF(t,this.tokenizerOptions))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){let t=await UF(e,this.tokenizerOptions);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){let{sampleSize:n=HA}=t,i,o,s=e.getReader({mode:"byob"});try{let{value:l,done:u}=await s.read(new Uint8Array(n));if(o=l,!u&&l)try{i=await this.fromBuffer(l.subarray(0,n))}catch(f){if(!(f instanceof zt))throw f;i=void 0}o=l}finally{s.releaseLock()}let a=new TransformStream({async start(l){l.enqueue(o)},transform(l,u){u.enqueue(l)}}),c=e.pipeThrough(a);return c.fileType=i,c}check(e,t){return bs(this.buffer,e,t)}checkString(e,t){return this.check(i$(e),t)}detectConfident=async e=>{if(this.buffer=new Uint8Array(HA),e.fileInfo.size===void 0&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.detectConfident(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);let t=await e.readToken(s$);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((this.buffer[0]===67||this.buffer[0]===70)&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){let t;return await new Dw(e).unzip(n=>{switch(n.filename){case"META-INF/mozilla.rsa":return t={ext:"xpi",mime:"application/x-xpinstall"},{stop:!0};case"META-INF/MANIFEST.MF":return t={ext:"jar",mime:"application/java-archive"},{stop:!0};case"mimetype":return{async handler(i){let o=new TextDecoder("utf-8").decode(i).trim();t=VA(o)},stop:!0};case"[Content_Types].xml":return{async handler(i){let o=new TextDecoder("utf-8").decode(i),s=o.indexOf('.main+xml"');if(s===-1){let a="application/vnd.ms-package.3dmanufacturing-3dmodel+xml";o.includes(`ContentType="${a}"`)&&(t=VA(a))}else{o=o.slice(0,Math.max(0,s));let a=o.lastIndexOf('"'),c=o.slice(Math.max(0,a+1));t=VA(c)}},stop:!0};default:return/classes\d*\.dex/.test(n.filename)?(t={ext:"apk",mime:"application/vnd.android.package-archive"},{stop:!0}):{}}}),t??{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);let t=new Uint8Array(8);return await e.readBuffer(t),bs(t,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/ogg; codecs=opus"}:bs(t,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:bs(t,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:bs(t,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:bs(t,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:bs(t,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(this.buffer[2]===3||this.buffer[2]===5||this.buffer[2]===7)&&(this.buffer[3]===4||this.buffer[3]===6||this.buffer[3]===8))return{ext:"zip",mime:"application/zip"};if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF"))return{ext:"pdf",mime:"application/pdf"};if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){let t=await this.readTiffHeader(!1);if(t)return t}if(this.check([77,77])){let t=await this.readTiffHeader(!0);if(t)return t}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function t(){let a=await e.peekNumber(NF),c=128,l=0;for(;(a&c)===0&&c!==0;)++l,c>>=1;let u=new Uint8Array(l+1);return await e.readBuffer(u),u}async function n(){let a=await t(),c=await t();c[0]^=128>>c.length-1;let l=Math.min(6,c.length),u=new DataView(a.buffer),f=new DataView(c.buffer,c.length-l,l);return{id:$A(u),len:$A(f)}}async function i(a){for(;a>0;){let c=await n();if(c.id===17026)return(await e.readToken(new ei(c.len))).replaceAll(/\00.*$/g,"");await e.ignore(c.len),--a}}let o=await n();switch(await i(o.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/matroska"};default:return}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1")||this.checkString("PARE"))return{ext:"parquet",mime:"application/vnd.apache.parquet"};if(this.checkString("ttcf"))return{ext:"ttc",mime:"font/collection"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([4,34,77,24]))return{ext:"lz4",mime:"application/x-lz4"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.checkString(".RMF"))return{ext:"rm",mime:"application/vnd.rn-realmedia"};if(this.checkString("DRACO"))return{ext:"drc",mime:"application/vnd.google.draco"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(this.buffer[6]===0||this.buffer[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){let t=new ei(4,"latin1").get(this.buffer,2);if(t.match("^d*")&&t>=1e3&&t<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),await e.readToken(new ei(13,"ascii"))==="debian-binary"?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("WEBVTT")&&[`
`,"\r","	"," ","\0"].some(t=>this.checkString(t,{offset:6})))return{ext:"vtt",mime:"text/vtt"};if(this.check([137,80,78,71,13,10,26,10])){await e.ignore(8);async function t(){return{length:await e.readToken(BF),type:await e.readToken(new ei(4,"latin1"))}}do{let n=await t();if(n.length<0)return;switch(n.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(n.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/vnd.apache.arrow.file"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.checkString("ftyp",{offset:4})&&(this.buffer[8]&96)!==0){let t=new ei(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(t){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return t.startsWith("3g")?t.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.check([82,73,70,70])){if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function t(){let n=new Uint8Array(16);return await e.readBuffer(n),{id:n,size:Number(await e.readToken(MF))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){let n=await t(),i=n.size-24;if(bs(n.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){let o=new Uint8Array(16);if(i-=await e.readBuffer(o),bs(o,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(bs(o,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(i)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new ei(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("**ACE",{offset:7})&&this.checkString("**",{offset:12}))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){let t=new DataView(this.buffer.buffer).getUint32(12,!0);if(t>12&&this.buffer.length>=t+16)try{let n=new TextDecoder().decode(this.buffer.subarray(16,t+16));if(JSON.parse(n).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),this.checkString("ustar",{offset:257})&&(this.checkString("\0",{offset:262})||this.checkString(" ",{offset:262}))||this.check([0,0,0,0,0,0],{offset:257})&&o$(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"}};detectImprecise=async e=>{if(this.buffer=new Uint8Array(HA),await e.peekBuffer(this.buffer,{length:Math.min(8,e.fileInfo.size),mayBeLess:!0}),this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(await e.peekBuffer(this.buffer,{length:Math.min(2+this.options.mpegOffsetTolerance,e.fileInfo.size),mayBeLess:!0}),this.buffer.length>=2+this.options.mpegOffsetTolerance)for(let t=0;t<=this.options.mpegOffsetTolerance;++t){let n=this.scanMpeg(t);if(n)return n}};async readTiffTag(e){let t=await this.tokenizer.readToken(e?Bh:Bt);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"};default:}}async readTiffIFD(e){let t=await this.tokenizer.readToken(e?Bh:Bt);for(let n=0;n<t;++n){let i=await this.readTiffTag(e);if(i)return i}}async readTiffHeader(e){let t=(e?Bh:Bt).get(this.buffer,2),n=(e?LF:ir).get(this.buffer,4);if(t===42){if(n>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(n>=8){let o=(e?Bh:Bt).get(this.buffer,8),s=(e?Bh:Bt).get(this.buffer,10);if(o===28&&s===254||o===31&&s===11)return{ext:"nef",mime:"image/x-nikon-nef"}}}return await this.tokenizer.ignore(n),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(t===43)return{ext:"tif",mime:"image/tiff"}}scanMpeg(e){if(this.check([255,224],{offset:e,mask:[255,224]})){if(this.check([16],{offset:e+1,mask:[22]}))return this.check([8],{offset:e+1,mask:[8]})?{ext:"aac",mime:"audio/aac"}:{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:e+1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:e+1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:e+1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}}},Yct=new Set(a$),Qct=new Set(c$);var Ow="application/octet-stream";function ire(r){return/^(<\?xml[^>]+>)?[^<^\w]+<svg/ig.test(r)}async function ore(r){try{return JSON.parse(r),!0}catch{return!1}}function sre(r){let e=new TextDecoder("utf-8",{fatal:!0});try{return e.decode(r)}catch{return null}}async function are(r){return/^\s*<(?:!doctype\s+html|html|head|body)\b/i.test(r)}async function u$(r,e){let t=(await l$(r))?.mime;if(t!=null)return t==="application/xml"&&e?.toLowerCase().endsWith(".svg")?"image/svg+xml":t;if(e==null){let n=sre(r);return n!=null?ire(n)?"image/svg+xml":await ore(n)?"application/json":await are(n)?"text/html; charset=utf-8":"text/plain; charset=utf-8":Ow}switch(e.split(".").pop()){case"css":return"text/css";case"html":return"text/html; charset=utf-8";case"js":return"application/javascript";case"json":return"application/json";case"txt":return"text/plain";case"woff2":return"font/woff2";case"svg":return"image/svg+xml";case"csv":return"text/csv";case"doc":return"application/msword";case"xls":return"application/vnd.ms-excel";case"ppt":return"application/vnd.ms-powerpoint";case"msi":return"application/x-msdownload";default:return Ow}}function f$(r){return r?.then!=null}async function cg({bytes:r,path:e,contentTypeParser:t,log:n,defaultContentType:i="application/octet-stream",filename:o}){let s;if(t!=null)try{let a;o==null?(a=e?.split("/").pop()?.trim(),a=a===""||a?.split(".").length===1?void 0:a):a=o;let c=t(r,a);if(f$(c)){let l=await c;l!=null&&(s=l)}else c!=null&&(s=c);n.trace("contentTypeParser returned %s",s)}catch(a){n.error("error parsing content type",a)}return s===Ow&&(s=i),s??i}async function KA(r,e,t,n){let i=t.newScope("get-stream-from-async-iterable"),o=r[Symbol.asyncIterator](),{value:s,done:a}=await o.next();if(a===!0)throw i.error('no content found for path "%s"',e),new L8;return{stream:new ReadableStream({async start(l){n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(s)},async pull(l){let{value:u,done:f}=await o.next();if(n?.signal?.aborted){l.error(new St(n.signal.reason??"signal aborted by user")),l.close();return}if(f===!0){u!=null&&(n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(u)),l.close();return}n?.onProgress?.(new G("verified-fetch:request:progress:chunk")),l.enqueue(u)}}),firstChunk:s}}var Nw=class extends mr{id="dag-pb-plugin";codes=[gt];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:i}){return n==null||i==null||t!=null&&t.mimeType!=="application/octet-stream"?!1:e.code===gt}getRedirectUrl(e){let{resource:t,path:n}=e;if(n===""?!t.toString().endsWith("/"):!n.endsWith("/"))try{let o=new URL(t.toString());return o.pathname.endsWith("/")?null:(o.pathname=`${o.pathname}/`,o.toString())}catch{return`${t.toString()}/`}return null}async handle(e){let{cid:t,options:n,pathDetails:i,query:o}=e,{contentTypeParser:s,helia:a,getBlockstore:c}=this.pluginOptions,l=this.log,u=e.resource,f=e.path,h=!1,d=e.byteRangeContext,m=i.ipfsRoots,y=i.terminalElement,w=y.cid,x=PF({...a,blockstore:c(e.cid,e.resource,n?.session??!0,n)});if(y?.type==="directory"){let v=y.cid,E=this.getRedirectUrl(e);if(E!=null){if(l.trace("directory url normalization spec requires redirect..."),n?.redirect==="error")throw l('could not redirect to %s as redirect option was set to "error"',E),new TypeError("Failed to fetch");if(n?.redirect==="manual")return l("returning 301 permanent redirect to %s",E),H0(u,E);l("following redirect to %s",E),u=E,h=!0}let _="index.html";try{l.trace("found directory at %c/%s, looking for index.html",t,f);let B=await e.serverTiming.time("exporter-dir","",gr(`/ipfs/${v}/${_}`,a.blockstore,{signal:n?.signal,onProgress:n?.onProgress}));l.trace("found root file at %c/%s with cid %c",v,_,B.cid),f=_,w=B.cid}catch(B){if(n?.signal?.aborted)throw new St(n?.signal?.reason);this.log.error("error loading path %c/%s - %e",v,_,B),e.isDirectory=!0,e.directoryEntries=[],e.modified++,this.log.trace("attempting to get directory entries because index.html was not found");for await(let H of x.ls(v,{signal:n?.signal,onProgress:n?.onProgress,extended:!1}))e.directoryEntries.push(H);return null}finally{n?.onProgress?.(new G("verified-fetch:request:end",{cid:v,path:_}))}}try{let v=await x.stat(w,{extended:!0,signal:AbortSignal.timeout(500)});d.setFileSize(v.size)}catch(v){l.error("error getting exact file size for %c/%s - %e",t,f,v),d.setFileSize(i.terminalElement.size),l.trace("using terminal element size of %d for %c/%s",i.terminalElement.size,t,f)}try{let v=await e.serverTiming.time("exporter-file","",gr(w,a.blockstore,{signal:n?.signal,onProgress:n?.onProgress})),E,_;if(d.isValidRangeRequest)_=await this.handleRangeRequest(e,v);else{let H=v.content({signal:n?.signal,onProgress:n?.onProgress});l("got async iterator for %c/%s",t,f);let U=await e.serverTiming.time("stream-and-chunk","",KA(H,f,this.pluginOptions.logger,{onProgress:n?.onProgress,signal:n?.signal})),C=U.stream;E=U.firstChunk,_=await e.serverTiming.time("get-content-type","",cg({filename:o.filename,bytes:E,path:f,contentTypeParser:s,log:l})),d.setBody(C)}let B=Qn(u,d.getBody(_),{byteRangeContext:d,log:l},{redirected:h});return B.headers.set("Content-Type",d.getContentType()??_),U8(B,m),B}catch(v){if(n?.signal?.aborted)throw new St(n?.signal?.reason);return l.error("error streaming %c/%s - %e",t,f,v),d.isRangeRequest&&v.code==="ERR_INVALID_PARAMS"?Eh(u):$8(u,"Unable to stream content")}}async handleRangeRequest(e,t){let{path:n,byteRangeContext:i,options:o}=e,{contentTypeParser:s}=this.pluginOptions,a=this.log,c=t.content({signal:o?.signal,onProgress:o?.onProgress,offset:0,length:8192}),{firstChunk:l}=await KA(c,n??"",this.pluginOptions.logger,{onProgress:o?.onProgress,signal:o?.signal}),u=await e.serverTiming.time("get-content-type","",cg({bytes:l,path:n,contentTypeParser:s,log:a}));return i?.setBody(f=>{if(o?.signal?.aborted)throw new St(o?.signal?.reason??"aborted while streaming");return t.content({signal:o?.signal,onProgress:o?.onProgress,offset:f.start??0,length:i.getLength(f)})},u),u}};var Lw=class extends mr{id="dag-walk-plugin";canHandle(e){let{pathDetails:t,cid:n}=e;return t!=null?!1:n.code===gt||n.code===Un||n.multihash.code===0}async handle(e){let{cid:t,resource:n,options:i}=e,{getBlockstore:o}=this.pluginOptions,s=o(t,n,i?.session??!0,i),a=await e.serverTiming.time("path-walking","",jU({...e,blockstore:s,log:this.log}));return a instanceof Response?(this.log.trace("path walking failed"),a.status===404?a:null):(e.modified++,e.pathDetails=a,null)}};function d$(r){return r.charAt(0)==="1"||r.charAt(0)==="Q"?tt(r):En(j.parse(r))}var Bw=class extends mr{id="ipns-record-plugin";codes=[];canHandle({resource:e,accept:t,query:n,path:i,byteRangeContext:o}){return o==null?!1:t?.mimeType==="application/vnd.ipfs.ipns-record"||n.format==="ipns-record"}async handle(e){let{resource:t,path:n,query:i,options:o}=e,{ipnsResolver:s}=this.pluginOptions;if(e.reqFormat="ipns-record",n!==""||!(t.startsWith("ipns://")||t.includes(".ipns.")||t.includes("/ipns/")))return this.log.error('invalid request for IPNS name "%s" and path "%s"',t,n),$0(t,new Error("Invalid IPNS name"));let a;try{let f;t.startsWith("ipns://")?f=t.replace("ipns://",""):t.includes("/ipns/")?f=t.split("/ipns/")[1].split("/")[0].split("?")[0]:f=t.split(".ipns.")[0].split("://")[1],this.log.trace('trying to parse peer id from "%s"',f),a=d$(f)}catch(f){return this.log.error("could not parse peer id from IPNS url %s",t,f),$0(t,f)}i.filename=i.filename??`${a}.bin`,i.download=!0;let c=await s.resolve(a,o),l=io(c.record);e.byteRangeContext.setBody(l);let u=Qn(t,e.byteRangeContext.getBody("application/vnd.ipfs.ipns-record"),{byteRangeContext:e.byteRangeContext,log:this.log});return u.headers.set("content-type",e.byteRangeContext.getContentType()??"application/vnd.ipfs.ipns-record"),u.headers.set("content-length",l.byteLength.toString()),u.headers.set("x-ipfs-roots",c.cid.toV1().toString()),u}};var Mw=class extends mr{id="json-plugin";codes=[po,Mo];canHandle({cid:e,accept:t,byteRangeContext:n}){return n==null?!1:t?.mimeType==="application/vnd.ipld.dag-json"&&e.code!==Un?!0:po===e.code||Mo===e.code}async handle(e){let{path:t,resource:n,cid:i,accept:o,options:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.session??!0;this.log.trace("fetching %c/%s",i,t);let l=e.pathDetails?.terminalElement.cid??e.cid,u=a(l,n,c,s),f=await Ne(u.get(l,s)),h;if(o?.mimeType==="application/vnd.ipld.dag-cbor"||o?.mimeType==="application/cbor")try{let y=sd(f);h=id(y)}catch(y){return this.log.error("could not transform %c to application/vnd.ipld.dag-cbor",y),ga(n)}else h=f;let d;o==null?po===i.code?d="application/vnd.ipld.dag-json":d="application/json":d=o?.mimeType.split(";")[0],e.byteRangeContext.setBody(h);let m=Qn(n,e.byteRangeContext.getBody(d),{byteRangeContext:e.byteRangeContext,log:this.log});return m.headers.set("content-type",e.byteRangeContext.getContentType()??d),e.byteRangeContext.isValidRangeRequest||m.headers.set("content-length",h.length.toString()),m}};var cre=["application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/octet-stream"];function lre({headers:r,accept:e}){let n=(e?.mimeType??new Headers(r).get("accept")??"").split(",").map(i=>i.split(";")[0]).map(i=>i.trim());for(let i of n){if(i==="*/*")return;if(cre.includes(i??""))return i}}var Uw=class extends mr{id="raw-plugin";codes=[vt,or.code];canHandle({cid:e,accept:t,query:n,byteRangeContext:i}){return i==null?!1:t?.mimeType==="application/vnd.ipld.raw"||n.format==="raw"}async handle(e){let{path:t,resource:n,cid:i,accept:o,query:s,options:a}=e,{getBlockstore:c,contentTypeParser:l}=this.pluginOptions,u=a?.session??!0,f=this.log;if(o?.mimeType==="application/vnd.ipld.raw"||s.format==="raw"?(e.reqFormat="raw",e.query.download=!0,e.query.filename=e.query.filename??`${i.toString()}.bin`,f.trace("set content disposition to force download")):f.trace("did not set content disposition, raw block will display inline"),t!==""&&i.code===vt)return f.trace("404-ing raw codec request for %c/%s",i,t),H8(n);let h=e.pathDetails?.terminalElement.cid??e.cid,d=c(h,n,u,a),m=await Ne(d.get(h,a));e.byteRangeContext.setBody(m);let y=await cg({filename:s.filename,bytes:m,path:t,defaultContentType:lre({headers:a?.headers,accept:o}),contentTypeParser:l,log:f}),w=Qn(n,e.byteRangeContext.getBody(y),{byteRangeContext:e.byteRangeContext,log:f},{redirected:!1});return w.headers.set("content-type",e.byteRangeContext.getContentType()??y),w.headers.set("x-ipfs-roots",h.toV1().toString()),e.byteRangeContext.isRangeRequest||w.headers.set("content-length",m.byteLength.toString()),w}};var ure=({weak:r,reqFormat:e})=>e==="tar"||e==="car"||e==="ipns-record"||r===!0?"W/":"",fre=({reqFormat:r})=>r==null?"":r==="tar"?".x-tar":`.${r}`;function Fw({cid:r,reqFormat:e,weak:t,rangeStart:n,rangeEnd:i,contentPrefix:o}){let s=ure({weak:t,reqFormat:e}),a=fre({reqFormat:e});return(n!=null||i!=null)&&(a+=`.${n??"0"}-${i??"N"}`),`${s}"${o??""}${r.toString()}${a}"`}var Qlt=R("ustar\0","binary"),Zlt=R("ustar ","binary"),Jlt=R(" \0","binary");var g$=bt(p$(),1);var hre="0000000000000000000",pre="7777777777777777777",mre=48,gre=R("ustar\0","binary"),yre=R("00","binary"),wre=parseInt("7777",8),xre=257,bre=263,vre=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},Ere=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},Hc=function(r,e){let t=r.toString(8);return t.length>e?R(pre.slice(0,e)+" "):R(hre.slice(0,e-t.length)+t+" ")},qA=function(r){let e=R(r).byteLength,t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function m$(r){let e="";r.name!=null&&(e+=qA(" path="+r.name+`
`)),r.linkname!=null&&(e+=qA(" linkpath="+r.linkname+`
`));let t=r.pax;if(t!=null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=qA(" "+n+"="+t[n]+`
`));return R(e)}function $w(r){let e=new Uint8Array(512),t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),R(t).byteLength!==t.length)return null;for(;R(t).byteLength>100;){let i=t.indexOf("/");if(i===-1)return null;n+=n!==""?"/"+t.slice(0,i):t.slice(0,i),t=t.slice(i+1)}return R(t).byteLength>100||R(n).byteLength>155||r.linkname!=null&&R(r.linkname).byteLength>100?null:(e.set(R(t),0),e.set(Hc(r.mode&wre,6),100),e.set(Hc(r.uid,6),108),e.set(Hc(r.gid,6),116),e.set(Hc(r.size,11),124),e.set(Hc(r.mtime.getTime()/1e3|0,11),136),e[156]=mre+vre(r.type),r.linkname!=null&&e.set(R(r.linkname),157),e.set(gre,xre),e.set(yre,bre),r.uname!=null&&e.set(R(r.uname),265),r.gname!=null&&e.set(R(r.gname),297),e.set(Hc(r.devmajor??0,6),329),e.set(Hc(r.devminor??0,6),337),n!=null&&e.set(R(n),345),e.set(Hc(Ere(e),6),148),e)}var{S_IFMT:Are,S_IFBLK:_re,S_IFCHR:Cre,S_IFDIR:Tre,S_IFIFO:Ire,S_IFLNK:kre}=g$.default,Pre=parseInt("755",8),Rre=parseInt("644",8),y$=new Uint8Array(1024);function Dre(r=0){switch(r&Are){case _re:return"block-device";case Cre:return"character-device";case Tre:return"directory";case Ire:return"fifo";case kre:return"symlink";default:return"file"}}function WA(r){return r&=511,r!==0?y$.subarray(0,512-r):new Uint8Array(0)}function jA(r){if(r.pax==null){let e=$w(r);if(e!=null)return e}return Ore(r)}function Ore(r){let e=m$(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new oe($w(t)??new Uint8Array(0),e,WA(e.length),$w({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function Hw(){return async function*(r){for await(let{header:e,body:t}of r){let n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??Dre(e.mode),mode:e.mode??(e.type==="directory"?Pre:Rre),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=R(t)),t instanceof Uint8Array||Ii(t)){n.size=t.length,yield jA(n),yield Ii(t)?t.subarray():t,yield WA(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=K(await Ne(t)),yield jA(n);continue}if(yield jA(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let i=0;for await(let o of t??[])i+=o.length,yield Ii(o)?o.subarray():o;if(i!==n.size)throw new Error(`size mismatch, wrote ${i} of ${n.size} bytes`);yield WA(n.size)}yield y$}}var Nre=["file","raw","directory"];function Lre(r){let e,t;return(r.type==="file"||r.type==="directory")&&(e=r.unixfs.mode,t=r.unixfs.mtime!=null?new Date(Number(r.unixfs.mtime.secs*1000n)):void 0),{name:r.path,mode:e,mtime:t,size:Number(r.size),type:r.type==="directory"?"directory":"file"}}function w$(r){if(!Nre.includes(r.type))throw new Si(`${r.type} is not a UnixFS node`);let e={header:Lre(r)};return(r.type==="file"||r.type==="raw")&&(e.body=r.content()),e}async function*x$(r,e,t){let n=await gr(r,e,t);if(n.type==="file"||n.type==="raw"){yield*br([w$(n)],Hw());return}if(n.type==="directory"){yield*br(kh(r,e,t),i=>Wt(i,o=>w$(o)),Hw());return}throw new Si("Not a UnixFS node")}var Vw=class extends mr{id="tar-plugin";codes=[];canHandle({cid:e,accept:t,query:n,byteRangeContext:i}){return i==null?!1:t?.mimeType==="application/x-tar"||n.format==="tar"}async handle(e){let{cid:t,path:n,resource:i,options:o,pathDetails:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.terminalElement.cid??t;if(c.code!==gt&&c.code!==vt)return ga("only UnixFS data can be returned in a TAR file");e.reqFormat="tar",e.query.download=!0,e.query.filename=e.query.filename??`${c.toString()}.tar`;let l=a(c,i,o?.session,o),u=na(x$(`/ipfs/${t}/${n}`,l,o));e.byteRangeContext.setBody(u);let f=Qn(i,e.byteRangeContext.getBody("application/x-tar"),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type",e.byteRangeContext.getContentType()??"application/x-tar"),f.headers.set("etag",Fw({cid:c,reqFormat:e.reqFormat,weak:!0})),f}};var Bre=/^(?<protocol>ip[fn]s):\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<query>.*)$/,Mre=/^\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<query>.*)$/,Ure=/^https?:\/\/(.*[^/])\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<query>.*)$/,b$=/^https?:\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\.(?<protocol>ip[fn]s)\.([^/?]+)\/?(?<path>[^?]*)\??(?<query>.*)$/;function Fre(r){let e=r?.protocol;if(e==null)return!1;let t=r?.cidOrPeerIdOrDnsLink;if(t==null)return!1;let n=r?.path,i=r?.query;return["ipns","ipfs"].includes(e)&&typeof t=="string"&&(n==null||typeof n=="string")&&(i==null||typeof i=="string")}function Vh(r){for(let e of[b$,Bre,Ure,Mre]){let t=r.match(e);if(Fre(t?.groups)){let n=t.groups;return n.path!=null&&(n.path=decodeURIComponent(n.path)),e===b$&&n.protocol==="ipns"&&Hre(n.cidOrPeerIdOrDnsLink)&&(n.cidOrPeerIdOrDnsLink=Vre(n.cidOrPeerIdOrDnsLink)),n}}throw new TypeError(`Invalid URL: ${r}, please use ipfs://, ipns://, or gateway URLs only`)}var $re=/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;function Hre(r){return $re.test(r)&&r.includes("-")&&!r.includes(".")}function Vre(r){return r.replace(/--/g,"%").replace(/-/g,".").replace(/%/g,"-")}var zre=114;function GA(r){if(r==null)return{};let e=new URLSearchParams(r),t={};for(let[n,i]of e.entries())t[n]=i,i==="true"&&(t[n]=!0),i==="false"&&(t[n]=!1);return t}var zw=class{components;constructor(e){this.components=e}async resolve(e,t={}){if(typeof e=="string")return this.parseUrlString(e,t);let n=j.asCID(e);if(n!=null)return this.resolveCIDResource(n,"",{},t);throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${e}`)}async parseUrlString(e,t={}){let{protocol:n,cidOrPeerIdOrDnsLink:i,path:o,query:s}=Vh(e);if(n==="ipfs"){let a=j.parse(i);return this.resolveCIDResource(a,o??"",GA(s),t)}if(n==="ipns"){let a;try{a=tt(i)}catch{return this.resolveDNSLink(i,o??"",GA(s),t)}return this.resolveIPNSName(i,a,o??"",GA(s),t)}throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${e}`)}async resolveCIDResource(e,t,n,i={}){return e.code===zre?this.resolveIPNSName(e.toString(),En(e),t,n,i):{cid:e,protocol:"ipfs",query:n,path:t,ttl:29030400,ipfsPath:`/ipfs/${e}${t===""?"":`/${t}`}`}}async resolveDNSLink(e,t,n,i){let s=(await this.components.timing.time("dnsLink.resolve",`Resolve DNSLink ${e}`,this.components.dnsLink.resolve(e,i)))?.[0];if(s==null)throw new TypeError(`Invalid resource. Cannot resolve DNSLink from domain: ${e}`);if(s.namespace==="ipns")return this.resolveIPNSName(e,s.peerId,t,n,i);if(s.namespace!=="ipfs")throw new TypeError(`Invalid resource. Unexpected DNSLink namespace ${s.namespace} from domain: ${e}`);return{cid:s.cid,path:v$(s.path,t),protocol:"ipns",ttl:s.answer.TTL,query:n,ipfsPath:`/ipns/${e}${t===""?"":`/${t}`}`}}async resolveIPNSName(e,t,n,i,o){let s=await this.components.timing.time("ipns.resolve",`Resolve IPNS name ${t}`,this.components.ipnsResolver.resolve(t,o));return{cid:s.cid,path:v$(s.path,n),query:i,protocol:"ipns",ttl:Number((s.record.ttl??0n)/BigInt(1e9)),ipfsPath:`/ipns/${e}${n===""?"":`/${n}`}`}}};function v$(...r){return`${r.filter(e=>e!=null&&e!=="").join("/").replaceAll(/(\/+)/g,"/").replace(/^(\/)+/,"").replace(/(\/)+$/,"/")}`}function Kre(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r?.errors)}function Kw(r){let e;return Kre(r)&&(e=r.errors.map(t=>Kw(t))),{name:r.name,message:r.message,stack:r.stack,errors:e}}function E$(r){let e=qre(r);return e===r?`filename="${r}"`:`filename="${e}"; filename*=UTF-8''${encodeURIComponent(r)}`}function qre(r){return r.replace(/[^\x00-\x7F]/g,"_")}var jre={[Un]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","text/html"],[po]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[Mo]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[gt]:["application/octet-stream","application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","application/x-tar"],[vt]:["application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.dag-json","application/vnd.ipld.car","application/x-tar"]};function S$(r,e){let t=jre[r.code];if(e!=null)return Wre(e,t)}function Wre(r,e){let t=r.split(",").map(n=>{let i=n.trim().split(";"),o={q:"0"};for(let s=1;s<i.length;s++){let[a,c]=i[s].split("=").map(l=>l.trim());o[a]=c}return{mimeType:`${i[0]}`.trim(),options:o}}).sort((n,i)=>n.options.q===i.options.q?0:n.options.q>i.options.q?-1:1);for(let n of t)for(let i of e){if(n.mimeType.includes(i))return n;if(n.mimeType==="*/*")return{mimeType:i,options:n.options};if(n.mimeType.startsWith("*/")&&i.split("/")[1]===n.mimeType.split("/")[1])return{mimeType:i,options:n.options};if(n.mimeType.endsWith("/*")&&i.split("/")[0]===n.mimeType.split("/")[0])return{mimeType:i,options:n.options}}}var qw={raw:"application/vnd.ipld.raw",car:"application/vnd.ipld.car","dag-json":"application/vnd.ipld.dag-json","dag-cbor":"application/vnd.ipld.dag-cbor",json:"application/json",cbor:"application/cbor","ipns-record":"application/vnd.ipfs.ipns-record",tar:"application/x-tar"};function A$(r){if(r!=null)return qw[r]}function XA(r){let e=r.get("accept");return e==null?!1:Object.values(qw).some(t=>e.includes(t))}function YA(r){let e=r?.format;return!!(e!=null&&Object.keys(qw).includes(e))}function _$({query:r,headers:e}){return XA(e)||YA(r)}function C$({query:r,headers:e,logger:t}){let n=t.forComponent("helia:verified-fetch:get-resolved-accept-header"),i=new Headers(e),o=i.get("accept")??void 0;if(o!=null&&n('incoming accept header "%s"',o),!_$({query:r,headers:i}))return n("no explicit IPLD content-type requested, returning incoming accept header %s",o),o;let s=A$(r?.format);r?.format!=null&&n('incoming query format "%s", mapped to %s',r.format,s);let a=o;return!XA(i)&&YA(r)&&(n("accept header not recognized, but query format provided, setting accept header to %s",s),a=s),n('resolved accept header to "%s"',a),a}function T$(r){return r.match(/\.[a-zA-Z0-9]{1,4}$/)!=null||r.endsWith("/")?r:`${r}/`}async function I$({resource:r,options:e,logger:t,cid:n,fetch:i=globalThis.fetch}){let o=t.forComponent("helia:verified-fetch:get-redirect-response");if(typeof r!="string"||e==null||["ipfs://","ipns://"].some(u=>r.startsWith(u)))return null;let s=new Headers(e?.headers),a=s.get("x-forwarded-host"),c=s.get("host");if(s.get("x-forwarded-for")==null&&a==null&&c==null)return o.trace("no redirect info found in headers"),null;o.trace("checking for redirect info");try{let u=Vh(r),f=new URL(r),h=a??f.host,d=new URL(f);if(u.protocol==="ipfs"&&n.version===0?d.host=`${n.toV1()}.ipfs.${h}`:d.host=`${u.cidOrPeerIdOrDnsLink}.${u.protocol}.${h}`,c?.includes(u.protocol)===!0&&d.host.includes(c))return o.trace("request was for a subdomain already, not setting location header"),null;if(c!=null&&!d.host.includes(c))return o.trace("host header is not the same as the subdomain url host, not setting location header"),null;if(f.host===d.host)return o.trace("req url is the same as the subdomain url, not setting location header"),null;d.pathname=T$(f.pathname.replace(`/${u.cidOrPeerIdOrDnsLink}`,"").replace(`/${u.protocol}`,"")),o.trace("subdomain url %s",d.href);let m=new URL(f,`${f.protocol}//${h}`);m.pathname=T$(f.pathname),o.trace("path url %s",m.href);try{let y=await i(d,{method:"HEAD"});if(y.ok)return o("subdomain supported, redirecting to subdomain"),H0(r.toString(),d.href);throw o("subdomain not supported, subdomain failed with status %s %s",y.status,y.statusText),new B8("subdomain not supported")}catch(y){return o("subdomain not supported - %e",y),m.href===f.href?(o("path url is the same as the request url, not setting location header"),null):H0(r.toString(),m.href)}}catch(u){o.error("error setting location header for x-forwarded-host",u)}return null}function k$(r){return r.split("/").map(e=>encodeURIComponent(e)).join("/")}function P$(r){let e=j.asCID(r);if(e!=null)return`ipfs://${e}`;try{return`ipfs://${j.parse(r.toString())}`}catch{}let{protocol:t,cidOrPeerIdOrDnsLink:n}=Vh(r.toString());return`${t}://${n}`}var jw=class{headers;constructor(){this.headers=[]}getHeader(){return this.headers.join(",")}async time(e,t,n){let i=performance.now();try{return await n}finally{let s=(performance.now()-i).toFixed(1);this.headers.push(`${e};dur=${s};desc="${t}"`)}}};var Gre=100,Xre=60*1e3;function Yre(r){if(r==null)return;let e;return r?.signal===null?e=void 0:e=r?.signal,{...r,signal:e}}var Ww=class{helia;ipnsResolver;dnsLink;log;contentTypeParser;blockstoreSessions;withServerTiming;plugins=[];constructor(e,t={}){this.helia=e,this.log=e.logger.forComponent("helia:verified-fetch"),this.ipnsResolver=t.ipnsResolver??hP(e),this.dnsLink=t.dnsLink??jM(e),this.contentTypeParser=t.contentTypeParser??u$,this.blockstoreSessions=new Nc({maxSize:t?.sessionCacheSize??Gre,maxAge:t?.sessionTTLms??Xre,onEviction:(s,a)=>{a.close()}}),this.withServerTiming=t?.withServerTiming??!1;let n={...t,logger:e.logger.forComponent("verified-fetch"),getBlockstore:(s,a,c,l)=>this.getBlockstore(s,a,c,l),helia:e,contentTypeParser:this.contentTypeParser,ipnsResolver:this.ipnsResolver},i=[new Lw(n),new V8(n),new Bw(n),new cw(n),new Uw(n),new Vw(n),new Mw(n),new uw(n),new Nw(n)],o=t.plugins?.map(s=>s(n))??[];if(o.length>0){let s=new Map(i.map(c=>[c.id,c])),a=new Map(o.map(c=>[c.id,c]));this.plugins=i.map(c=>a.get(c.id)??c),this.plugins.push(...o.filter(c=>!s.has(c.id)))}else this.plugins=i}getBlockstore(e,t,n=!0,i={}){let o=P$(t);if(!n)return this.helia.blockstore;let s=this.blockstoreSessions.get(o);return s==null&&(s=this.helia.blockstore.createSession(e,i),this.blockstoreSessions.set(o,s)),s}handleFinalResponse(e,t){if((this.withServerTiming||t?.withServerTiming===!0)&&t?.serverTiming!=null&&e.headers.set("Server-Timing",t?.serverTiming.getHeader()),e.headers.get("Transfer-Encoding")!=="chunked"&&t?.byteRangeContext!=null){let i=t.byteRangeContext.getLength();i!=null&&(this.log.trace("Setting Content-Length from byteRangeContext: %d",i),e.headers.set("Content-Length",i.toString()))}let n;return t?.query?.download===!0&&(this.log.trace("download requested"),n="attachment"),t?.query?.filename!=null&&(this.log.trace("specific filename requested"),n==null&&(n="inline"),n=`${n}; ${E$(t.query.filename)}`),n!=null&&(this.log.trace("content disposition %s",n),e.headers.set("Content-Disposition",n)),t?.cid!=null&&e.headers.get("etag")==null&&e.headers.set("etag",Fw({cid:t.pathDetails?.terminalElement.cid??t.cid,reqFormat:t.reqFormat,weak:!1})),t?.protocol!=null&&t.ttl!=null&&XM({response:e,ttl:t.ttl,protocol:t.protocol}),t?.ipfsPath!=null&&e.headers.set("X-Ipfs-Path",k$(t.ipfsPath)),e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, HEAD, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Range, X-Requested-With"),e.headers.set("Access-Control-Expose-Headers","Content-Range, Content-Length, X-Ipfs-Path, X-Ipfs-Roots, X-Stream-Output"),t?.reqFormat!=="car"?e.headers.set("Accept-Ranges","bytes"):e.headers.set("Accept-Ranges","none"),(e.headers.get("Content-Type")?.includes("application/vnd.ipld.car")===!0||e.headers.get("Content-Type")?.includes("application/vnd.ipld.raw")===!0)&&e.headers.set("X-Content-Type-Options","nosniff"),t?.options?.method==="HEAD"?new Response(null,{status:200,headers:e.headers}):e}async runPluginPipeline(e,t=3){let n,i=0,o=new Set,s=e.modified;for(;i<t;){this.log(`starting pipeline pass #${i+1}`),i++,this.log.trace("checking which plugins can handle %c%s with accept %o",e.cid,e.path!=null?`/${e.path}`:"",e.accept);let a=this.plugins.filter(u=>!o.has(u.id)).filter(u=>u.canHandle(e));if(a.length===0){this.log.trace("no plugins can handle the current context, checking by CID code");let u=this.plugins.filter(f=>f.codes.includes(e.cid.code));if(u.length>0)a.push(...u);else{this.log.trace("no plugins found that can handle request by CID code; exiting pipeline");break}}this.log.trace("plugins ready to handle request: %s",a.map(u=>u.id).join(", "));let c=!1,l=!1;for(let u of a){try{this.log("invoking plugin: %s",u.id),o.add(u.id);let f=await u.handle(e);if(this.log("plugin response %s %o",u.id,f),f!=null){n=f,l=!0;break}}catch(f){if(e.options?.signal?.aborted)throw new St(e.options?.signal?.reason);return this.log.error("error in plugin %s - %e",u.id,f),QM(e.resource,JSON.stringify({error:Kw(f)}),{headers:{"content-type":"application/json"}})}finally{let f=e.modified;c=f!==s,c&&(s=f)}if(n!=null){this.log.trace("plugin %s produced final response",u.id);break}}if(l&&n!=null)break;if(!c){this.log.trace("no context changes and no final response; exiting pipeline.");break}}return n??ZM(e.resource,JSON.stringify({error:Kw(new Error("No verified fetch plugin could handle the request"))}),{headers:{"content-type":"application/json"}})}async fetch(e,t){if(this.log("fetch %s",e),t?.method==="OPTIONS")return this.handleFinalResponse(new Response(null,{status:200}));let n=Yre(t),i=new jw,o=new zw({ipnsResolver:this.ipnsResolver,dnsLink:this.dnsLink,timing:i});n?.onProgress?.(new G("verified-fetch:request:start",{resource:e}));let s;try{s=await o.resolve(e,n)}catch(d){if(n?.signal?.aborted)throw new St(n?.signal?.reason);return this.log.error("error parsing resource %s",e,d),this.handleFinalResponse($0(e.toString(),d))}n?.onProgress?.(new G("verified-fetch:request:resolve",{cid:s.cid,path:s.path}));let a=C$({query:s.query,headers:n?.headers,logger:this.helia.logger}),c=S$(s.cid,a);if(this.log("accept %o",c),a!=null&&c==null)return this.log.error("could not fulfil request based on accept header"),this.handleFinalResponse(ga(e.toString()));let l=c?.mimeType.split(";")[0]??"application/octet-stream",u=await I$({resource:e,options:n,logger:this.helia.logger,cid:s.cid});if(u!=null)return this.handleFinalResponse(u);let f={...s,resource:e.toString(),accept:c,options:n,onProgress:n?.onProgress,modified:0,plugins:this.plugins.map(d=>d.id),query:s.query??{},withServerTiming:!!n?.withServerTiming||!!this.withServerTiming,serverTiming:i};this.log.trace('finding handler for cid code "%s" and response content type "%s"',s.cid.code,l);let h=await this.runPluginPipeline(f);return n?.onProgress?.(new G("verified-fetch:request:end",{cid:s.cid,path:s.path})),h==null&&this.log.error("no plugin could handle request for %s",e),this.handleFinalResponse(h,f)}async start(){await this.helia.start()}async stop(){await this.helia.stop()}};async function R$(r,e){let t;if(!Qre(r)){let o=Zre(r?.dnsResolvers),s=zM();s.dns=o;let a=r?.routers??["https://delegated-ipfs.dev"];for(let u=0;u<a.length;u++){let f=a[u];s.services[`delegatedRouting${u}`]=()=>t4(f)}r?.libp2pConfig!=null&&Object.assign(s,r.libp2pConfig),t=await j4(s);let c=[vm()],l=[_m(t)];(r?.gateways==null||r.gateways.length>0)&&(c.push(Em({allowInsecure:r?.allowInsecure,allowLocal:r?.allowLocal})),l.push(Am({gateways:r?.gateways??["https://trustless-gateway.link"]}))),r=await D8({libp2p:t,blockBrokers:c,dns:o,routers:l,hashers:r?.hashers}),r.logger.forComponent("helia:verified-fetch").trace("created verified-fetch with libp2p config: %j",s)}let n=new Ww(r,e);async function i(o,s){return n.fetch(o,s)}return i.start=n.start.bind(n),i.stop=n.stop.bind(n),i}function Qre(r){return r?.blockstore!=null&&r?.datastore!=null&&r?.gc!=null&&r?.stop!=null&&r?.start!=null}function Zre(r){if(r!=null)return Array.isArray(r)?Ll({resolvers:{".":r}}):Ll({resolvers:r})}var wa=class{#e;#t;#r;async asInit(){console.debug("Initializing..."),console.debug("Http...");let e=Hu();e.services.http=l5(),console.debug(e),console.debug("Helia..."),this.#e=await D8({libp2p:e}),console.debug("IPNS..."),this.#t=dP(this.#e),console.debug("VerifiedFetch..."),this.#r=await R$(this.#e),console.debug("Initialized")}async asResolve(e,t){return(await this.#t.resolve(e,t)).cid.toString()}async asFetch(e,t){return await this.#e.libp2p.services.http.fetch(e,t)}async asFetchCidJson(e){let t=j.parse(e),n={signal:AbortSignal.timeout(2e4)};return await(await this.#r(t,n)).json()}async asFetchCidImage(e){let t=j.parse(e),i=await(await this.#r(t,{signal:AbortSignal.timeout(2e4)})).blob();return new Promise((o,s)=>{let a=new FileReader;a.onloadend=()=>o(a.result),a.onerror=s,a.readAsDataURL(i)})}async asStop(){await this.#e.stop()}};var Vc={ipfs:new wa};async function Jre(){await Vc.ipfs.asInit()}var lg=class{isCid(e){try{return j.parse(e),!0}catch{return!1}}};var Zu=class{#e;#t;#r;#n;#i;#o=new wa;#c=new lg;_dataSource;_delegate;constructor(e){this.#e=e}isFeed(){return!1}hasIdol(e){return this.#r?this.#r.idols.some(t=>t.id==e):(this._asGetOrInitIdolRoot().then(t=>this.#a()),!1)}getId(){return this._getData("uuid")}getUsername(){return this.getId()}getProfile(){return this._getDataOrDefault("profile",{})}getNickname(){return this._getDataOrDefault("profile",{}).nickname}getIconUrl(){if(this.#i)return this.#i;{let e=this._getDataOrDefault("profile",{}).icon_cid;return e?(this.#f(e).then(()=>this.#d()),null):(this.#i="",this.#i)}}getLogoUrl(){return this.getIconUrl()}getInfoImageUrl(){return null}getDomainUrl(){return"N/A"}getBackgroundColor(){return null}getColorTheme(){return null}getNIdols(){return this.#r?this.#r.idols.length:(this._asGetOrInitIdolRoot().then(e=>this.#a()),0)}getNFollowers(){return 0}getBriefBio(){return""}setDataSource(e){this._dataSource=e}setDelegate(e){this._delegate=e}reset(e){this._reset(e)}async asyncGetIdolIds(){return(await this._asGetOrInitIdolRoot()).idols.map(t=>t.id)}async asyncFindMark(e){if(!e)return null;let t=await this._asGetOrInitMarkRoot();return await this.#u("",e,t.marks)}async asyncLoadMorePostInfos(e){let t=await this._asGetOrInitPostRoot();return e.getNextSegmentId()>0?Promise.resolve():t.posts}_hasData(){return!!this.#e}_getData(e){return this.#e?this.#e[e]:null}_getDataOrDefault(e,t){let n=this._getData(e);return n||t}_reset(e){this.#e=e,this.#t=null,this.#n=null,this.#i=null}async _asGetOrInitIdolRoot(){if(!this.#r){let e=this._getData("idols");this.#c.isCid(e)?this.#r=await this.#o.asFetchCidJson(e):this.#r={idols:[]}}return this.#r}async _asGetOrInitPostRoot(){if(!this.#t){let e=this._getData("posts");if(this.#c.isCid(e))try{this.#t=await this.#o.asFetchCidJson(e)}catch{this.#t={posts:[]}}else this.#t={posts:[]}}return this.#t}async _asGetOrInitMarkRoot(){if(!this.#n){let e=this._getData("marks");this.#c.isCid(e)?this.#n=await this.#o.asFetchCidJson(e):this.#n={marks:{}}}return this.#n}_setData(e,t){this.#e[e]=t}#a(){this._delegate&&this._delegate.onWeb3UserIdolsLoaded(this)}#d(){this._delegate&&this._delegate.onWeb3UserProfileLoaded(this)}async#u(e,t,n){if(!n)return null;let i=e+t;if(i in n)return n[i];if(t.length>2&&(i=t.slice(0,2),i in n)){let o=n[i],s=await this.#o.asFetchCidJson(o);return await this.#u(e+i,t.slice(2),s.marks)}return null}async#f(e){this.#i=await this.#o.asFetchCidImage(e)}};var ug=class extends Zu{static#e="1.0";#t=[];#r=null;hasPublished(){return this._getDataOrDefault("edition",0)>0}isAuthenticated(){return this._hasData()}isWebOwner(){return this.isAuthenticated()}isFollowing(e){return this.hasIdol(e)}isIdolOf(e){return e.hasIdol(this.getId())}getId(){return this._getData("uuid")}getNickname(){return this._getDataOrDefault("profile",{}).nickname}getUserNickname(e,t){return e}getPreferredLanguage(){return null}getPublicKey(){return this._dataSource.onWeb3OwnerRequestGetPublicKey(this)}setStorage(e){this.#r=e}setPublishers(e){this.#t=e}asyncFollow(e){this.#c(e).then(()=>this.#n())}asyncUnfollow(e){this.#a(e).then(()=>this.#n())}asyncReload(){}reset(e){super.reset(e),this.#n()}loadCheckPoint(){let e=this._dataSource.onWeb3OwnerRequestLoadCheckPoint(this);this._reset(e?JSON.parse(e):null)}saveCheckPoint(){this._delegate.onWeb3OwnerRequestSaveCheckPoint(this,JSON.stringify(this.#o()))}async asRegister(e,t){let n=JSON.stringify({id:this.getId(),name:t}),i=await this.#i(n);await e.asRegister(n,this.getPublicKey(),i)}async asUploadFile(e){let t=await this.#r.asGetUploadToken(this.getId()),n=await this.#i(t),i;return e.type.startsWith("image")?i=await this.#r.asUploadImage(e,this.getId(),t,n):i=await this.#r.asUploadFile(e,this.getId(),t,n),i.cid}async asUploadJson(e){let t=JSON.stringify(e),n=await this.#i(t);return await this.#r.asUploadJson(t,this.getId(),n)}async asLike(e){let t=await this.asyncFindMark(e);t||(t={comments:[]}),!t.like&&(t.like=!0,await this.#d(e,t,[]))}async asUnlike(e){let t=await this.asyncFindMark(e);t&&t.like&&(t.like=!1,await this.#d(e,t,[]))}async asComment(e,t,n){let i=await this.asyncFindMark(e);i||(i={comments:[]}),i.comments.unshift(t),await this.#d(e,i,n)}async asUpdateProfile(e,t){this._setData("profile",e),await this.#f({texts:t})}async asPublishPost(e,t){console.debug("Publishing post..."),e.timestamp=Date.now();let n=[...t],i=await this._asGetOrInitPostRoot();i.posts.unshift(e);let o=this._getData("posts");console.debug("Uploading post list..."),o=await this.asUploadJson(i),this._setData("posts",o),n.push(o),await this.#f({texts:n})}#n(){this._delegate&&this._delegate.onWeb3OwnerProfileUpdated(this)}async#i(e){return this._delegate.asOnWeb3OwnerRequestSign(this,e)}#o(){let e={uuid:this.getId(),profile:this._getDataOrDefault("profile",{}),idols:this._getDataOrDefault("idols",null),posts:this._getDataOrDefault("posts",null),marks:this._getDataOrDefault("marks",null)};return e.version=this.constructor.#e,e.edition=this._getDataOrDefault("edition",0),e}async#c(e){let t={timestamp:Date.now(),type:"USER",id:e,nickname:null},n=await this._asGetOrInitIdolRoot();n.idols.unshift(t),await this.#u(n)}async#a(e){let t=await this._asGetOrInitIdolRoot();t.idols=t.idols.filter(n=>n.id!=e),await this.#u(t)}async#d(e,t,n){let i=await this._asGetOrInitMarkRoot();i.marks[e]=t;let o=[...n],s=this._getData("marks");s=await this.asUploadJson(i),this._setData("marks",s),o.push(s),await this.#f({texts:o})}async#u(e){let t=[],n=this._getData("idols");n=await this.asUploadJson(e),this._setData("idols",n),t.push(n),await this.#f({texts:t})}async#f(e){try{await this.#s(e)}catch(t){throw this.loadCheckPoint(),t}}async#s(e){console.debug("Publishing content..."),this._setData("edition",this._getDataOrDefault("edition",0)+1),console.debug("Uploading content...");let t=await this.asUploadJson(this.#o());this._setData("_cid",t),e.texts.push(t);let n=await this.#i(t);console.debug("Publishing...");for(let o of this.#t)await o.asPublish(t,this.getId(),n);console.debug("Pinning content...");let i=JSON.stringify({cids:e.texts});n=await this.#i(i),await this.#r.asPin(i,this.getId(),n),this.saveCheckPoint()}};var fg=class{static T_REGISTER={PEER:"PEER",GROUP:"GROUP"};#e=null;#t=null;isRegisterEnabled(){return this.#e.register&&this.#e.register.is_enabled}getName(){return this.#n(this.#t)}getAddress(){return this.#n(this.#t)}getPeerId(){return this.#e.peer_id}getRegisterType(){return this.#e.register?this.#e.register.type:null}getApiAddr(e){return this.#t.toString()+encodeURIComponent(e)}getApiUrl(e){return this.#t?this.#n(this.#t)+e:null}async asInit(e){return this.#t=this.#i(e),this.#e=await this.#o(),!!this.#e}#r(){let e=window.location.hostname,t=window.location.port;return t.length<1&&(window.location.protocol=="https"?t="443":t="80"),"/dns4/"+e+"/tcp/"+t}#n(e){let t="http",n,i;for(let o of e.getComponents())switch(o.name){case"https":t="https";break;case"ip4":n=o.value;break;case"ip6":n="["+o.value+"]";break;case"tcp":i=o.value;break;default:break}return t+"://"+n+":"+i}#i(e){let t=e;return!t&&glb.env.hasHost()&&(t=this.#r()),se(t)}async#o(){if(!this.#t)return null;let e=this.getApiUrl("/api/host/info"),t;try{let i={method:"GET",signal:AbortSignal.timeout(5e3)};t=await this.#c(e,i)}catch(i){return console.error("Failed to contact server",i.message),null}let n=await t.json();return n.error?(console.error("Error in server",n.error),null):n.data.info}async#c(e,t){return await Vc.ipfs.asFetch(e,t)}};var dg=class{#e;constructor(e){this.#e=e}getHostName(){return this.#e.getName()}getHostAddress(){return this.#e.getAddress()}getServer(){return this.#e}};var hg=class extends dg{async asGetUploadToken(e){let t=this.getServer().getApiUrl("/api/upload/token"),n={method:"GET",headers:{Authorization:"Bearer "+e}},o=await(await Vc.ipfs.asFetch(t,n)).json();if(o.error)throw o.error;return o.data.token}async asUploadJson(e,t,n){let i=this.getServer().getApiUrl("/api/upload/json");return(await this.#e(i,e,t,n)).cid}async asUploadFile(e,t,n,i){let o=this.getServer().getApiUrl("/api/upload/file");return await this.#t(o,e,t,n,i)}async asUploadImage(e,t,n,i){let o=this.getServer().getApiUrl("/api/upload/image");return await this.#t(o,e,t,n,i)}async asUploadAudio(e,t,n,i){let o=this.getServer().getApiUrl("/api/upload/audio");return await this.#t(o,e,t,n,i)}async asUploadVideo(e,t,n,i){let o=this.getServer().getApiUrl("/api/upload/video");return await this.#t(o,e,t,n,i)}async asPin(e,t,n){let i=this.getServer().getApiUrl("/api/pin/add");await this.#e(i,e,t,n)}async#e(e,t,n,i){let o={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+n},body:JSON.stringify({data:t,signature:i})},a=await(await Vc.ipfs.asFetch(e,o)).json();if(a.error)throw a.error;return a.data}async#t(e,t,n,i,o){let s=new FormData;s.append("signature",o),s.append("token",i),s.append("file",t);let a={method:"POST",headers:{Authorization:"Bearer "+n},body:s},l=await(await Vc.ipfs.asFetch(e,a)).json();if(l.error)throw l.error;return l.data}};return j$(ene);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

ieee754/index.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/abstract/montgomery.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

tslib/tslib.es6.js:
  (*! *****************************************************************************
  Copyright (c) Microsoft Corporation.
  
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.
  
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** *)

@peculiar/x509/build/x509.es.js:
  (*!
   * MIT License
   * 
   * Copyright (c) Peculiar Ventures. All rights reserved.
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)
*/
