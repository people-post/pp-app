var pp = (() => {
  var __defProp = Object.defineProperty;
  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
  var __getOwnPropNames = Object.getOwnPropertyNames;
  var __hasOwnProp = Object.prototype.hasOwnProperty;
  var __export = (target, all) => {
    for (var name in all)
      __defProp(target, name, { get: all[name], enumerable: true });
  };
  var __copyProps = (to, from, except, desc) => {
    if (from && typeof from === "object" || typeof from === "function") {
      for (let key of __getOwnPropNames(from))
        if (!__hasOwnProp.call(to, key) && key !== except)
          __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
    }
    return to;
  };
  var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

  // src/index.js
  var index_exports = {};
  __export(index_exports, {
    Owner: () => Owner,
    User: () => User
  });

  // src/User.js
  var User = class {
    #data;
    #dPosts;
    #dIdols;
    #dMarks;
    #iconUrl;
    _dataSource;
    _delegate;
    constructor(data) {
      this.#data = data;
    }
    isFeed() {
      return false;
    }
    hasIdol(userId) {
      if (this.#dIdols) {
        return this.#dIdols.idols.some((i) => i.id == userId);
      } else {
        this._asGetOrInitIdolRoot().then((d) => this.#onIdolsLoaded());
        return false;
      }
    }
    getId() {
      return this._getData("uuid");
    }
    getUsername() {
      return this.getId();
    }
    getProfile() {
      return this._getDataOrDefault("profile", {});
    }
    getNickname() {
      return this._getDataOrDefault("profile", {}).nickname;
    }
    getIconUrl() {
      if (this.#iconUrl) {
        return this.#iconUrl;
      } else {
        let cid = this._getDataOrDefault("profile", {}).icon_cid;
        if (cid) {
          this.#asFetchIconImage(cid).then(() => this.#onProfileLoaded());
          return null;
        } else {
          this.#iconUrl = "";
          return this.#iconUrl;
        }
      }
    }
    getLogoUrl() {
      return this.getIconUrl();
    }
    getInfoImageUrl() {
      return null;
    }
    getDomainUrl() {
      return "N/A";
    }
    getBackgroundColor() {
      return null;
    }
    getColorTheme() {
      return null;
    }
    getNIdols() {
      if (this.#dIdols) {
        return this.#dIdols.idols.length;
      } else {
        this._asGetOrInitIdolRoot().then((d) => this.#onIdolsLoaded());
        return 0;
      }
    }
    getNFollowers() {
      return 0;
    }
    getBriefBio() {
      return "";
    }
    setDataSource(dataSource) {
      this._dataSource = dataSource;
    }
    setDelegate(delegate) {
      this._delegate = delegate;
    }
    reset(data) {
      this._reset(data);
    }
    async asyncGetIdolIds() {
      let d = await this._asGetOrInitIdolRoot();
      return d.idols.map((i) => i.id);
    }
    async asyncFindMark(key) {
      if (!key) {
        return null;
      }
      let d = await this._asGetOrInitMarkRoot();
      return await this.#asFindMark("", key, d.marks);
    }
    async asyncLoadMorePostInfos(idRecord) {
      let dPosts = await this._asGetOrInitPostRoot();
      let segId = idRecord.getNextSegmentId();
      if (segId > 0) {
        return Promise.resolve();
      } else {
        return dPosts.posts;
      }
    }
    _hasData() {
      return !!this.#data;
    }
    _getData(name) {
      return this.#data ? this.#data[name] : null;
    }
    _getDataOrDefault(name, vDefault) {
      let d = this._getData(name);
      return d ? d : vDefault;
    }
    _reset(data) {
      this.#data = data;
      this.#dPosts = null;
      this.#dMarks = null;
      this.#iconUrl = null;
    }
    async _asGetOrInitIdolRoot() {
      if (!this.#dIdols) {
        let cid = this._getData("idols");
        if (Utilities.isCid(cid)) {
          this.#dIdols = await this.#asFetchCidJson(cid);
        } else {
          this.#dIdols = { idols: [] };
        }
      }
      return this.#dIdols;
    }
    async _asGetOrInitPostRoot() {
      if (!this.#dPosts) {
        let cid = this._getData("posts");
        if (Utilities.isCid(cid)) {
          try {
            this.#dPosts = await this.#asFetchCidJson(cid);
          } catch (e) {
            this.#dPosts = { posts: [] };
          }
        } else {
          this.#dPosts = { posts: [] };
        }
      }
      return this.#dPosts;
    }
    async _asGetOrInitMarkRoot() {
      if (!this.#dMarks) {
        let cid = this._getData("marks");
        if (Utilities.isCid(cid)) {
          this.#dMarks = await this.#asFetchCidJson(cid);
        } else {
          this.#dMarks = { marks: {} };
        }
      }
      return this.#dMarks;
    }
    _setData(name, value) {
      this.#data[name] = value;
    }
    #onIdolsLoaded() {
      if (this._delegate) {
        this._delegate.onWeb3UserIdolsLoaded(this);
      }
    }
    #onProfileLoaded() {
      if (this._delegate) {
        this._delegate.onWeb3UserProfileLoaded(this);
      }
    }
    async #asFetchCidJson(cid) {
      return await this._dataSource.asOnWeb3UserRequestFetchCidJson(this, cid);
    }
    async #asFetchCidImage(cid) {
      return await this._dataSource.asOnWeb3UserRequestFetchCidImage(this, cid);
    }
    async #asFindMark(prefix, suffix, dMarks) {
      if (!dMarks) {
        return null;
      }
      let key = prefix + suffix;
      if (key in dMarks) {
        return dMarks[key];
      }
      if (suffix.length > 2) {
        key = suffix.slice(0, 2);
        if (key in dMarks) {
          let cid = dMarks[key];
          let d = await this.#asFetchCidJson(cid);
          return await this.#asFindMark(prefix + key, suffix.slice(2), d.marks);
        }
      }
      return null;
    }
    async #asFetchIconImage(cid) {
      this.#iconUrl = await this.#asFetchCidImage(cid);
    }
  };

  // src/Owner.js
  var Owner = class extends User {
    // Note: This file is version sensitive, shall be backward compatible
    static #VERSION = "1.0";
    #aPublishers = [];
    #aStorage = null;
    hasPublished() {
      return this._getDataOrDefault("edition", 0) > 0;
    }
    // TODO: Clearly define isAuthenticated
    isAuthenticated() {
      return this._hasData();
    }
    isWebOwner() {
      return this.isAuthenticated();
    }
    isFollowing(userId) {
      return this.hasIdol(userId);
    }
    isIdolOf(user) {
      return user.hasIdol(this.getId());
    }
    getId() {
      return this._getData("uuid");
    }
    getNickname() {
      return this._getDataOrDefault("profile", {}).nickname;
    }
    getUserNickname(userId, defaultName) {
      return userId;
    }
    getPreferredLanguage() {
      return null;
    }
    getPublicKey() {
      return this._dataSource.onWeb3OwnerRequestGetPublicKey(this);
    }
    setStorage(agent) {
      this.#aStorage = agent;
    }
    setPublishers(agents) {
      this.#aPublishers = agents;
    }
    asyncFollow(userId) {
      this.#asFollow(userId).then(() => this.#onProfileUpdated());
    }
    asyncUnfollow(userId) {
      this.#asUnfollow(userId).then(() => this.#onProfileUpdated());
    }
    asyncReload() {
    }
    reset(data) {
      super.reset(data);
      this.#onProfileUpdated();
    }
    loadCheckPoint() {
      let s = this._dataSource.onWeb3OwnerRequestLoadCheckPoint(this);
      this._reset(s ? JSON.parse(s) : null);
    }
    saveCheckPoint() {
      this._delegate.onWeb3OwnerRequestSaveCheckPoint(
        this,
        JSON.stringify(this.#toLtsJsonData())
      );
    }
    async asRegister(agent, name) {
      const msg = JSON.stringify({ id: this.getId(), name });
      const sig = await this.#asSign(msg);
      await agent.asRegister(msg, this.getPublicKey(), sig);
    }
    async asUploadFile(file) {
      const token = await this.#aStorage.asGetUploadToken(this.getId());
      const sig = await this.#asSign(token);
      let d;
      if (file.type.startsWith("image")) {
        d = await this.#aStorage.asUploadImage(file, this.getId(), token, sig);
      } else {
        d = await this.#aStorage.asUploadFile(file, this.getId(), token, sig);
      }
      return d.cid;
    }
    async asUploadJson(data) {
      const msg = JSON.stringify(data);
      const sig = await this.#asSign(msg);
      return await this.#aStorage.asUploadJson(msg, this.getId(), sig);
    }
    async asLike(key) {
      let d = await this.asyncFindMark(key);
      if (!d) {
        d = { comments: [] };
      }
      if (d.like) {
        return;
      }
      d.like = true;
      await this.#asMark(key, d, []);
    }
    async asUnlike(key) {
      let d = await this.asyncFindMark(key);
      if (!d) {
        return;
      }
      if (!d.like) {
        return;
      }
      d.like = false;
      await this.#asMark(key, d, []);
    }
    async asComment(key, postInfo, refCids) {
      let d = await this.asyncFindMark(key);
      if (!d) {
        d = { comments: [] };
      }
      d.comments.unshift(postInfo);
      await this.#asMark(key, d, refCids);
    }
    async asUpdateProfile(d, newCids) {
      this._setData("profile", d);
      await this.#asPublish({ texts: newCids });
    }
    async asPublishPost(postInfo, refCids) {
      console.debug("Publishing post...");
      postInfo.timestamp = Date.now();
      let newCids = [...refCids];
      let dIdx = await this._asGetOrInitPostRoot();
      dIdx.posts.unshift(postInfo);
      let cid = this._getData("posts");
      console.debug("Uploading post list...");
      cid = await this.asUploadJson(dIdx);
      this._setData("posts", cid);
      newCids.push(cid);
      await this.#asPublish({ texts: newCids });
    }
    #onProfileUpdated() {
      if (this._delegate) {
        this._delegate.onWeb3OwnerProfileUpdated(this);
      }
    }
    async #asSign(msg) {
      return this._delegate.asOnWeb3OwnerRequestSign(this, msg);
    }
    #toLtsJsonData() {
      let d = {
        uuid: this.getId(),
        profile: this._getDataOrDefault("profile", {}),
        idols: this._getDataOrDefault("idols", null),
        posts: this._getDataOrDefault("posts", null),
        marks: this._getDataOrDefault("marks", null)
      };
      d.version = this.constructor.#VERSION;
      d.edition = this._getDataOrDefault("edition", 0);
      return d;
    }
    async #asFollow(userId) {
      let idolInfo = { timestamp: Date.now(), type: "USER", id: userId, nickname: null };
      let dIdx = await this._asGetOrInitIdolRoot();
      dIdx.idols.unshift(idolInfo);
      await this.#asUpdateIdols(dIdx);
    }
    async #asUnfollow(userId) {
      let dIdx = await this._asGetOrInitIdolRoot();
      dIdx.idols = dIdx.idols.filter((i) => i.id != userId);
      await this.#asUpdateIdols(dIdx);
    }
    async #asMark(key, markInfo, refCids) {
      let dRoot = await this._asGetOrInitMarkRoot();
      dRoot.marks[key] = markInfo;
      let newCids = [...refCids];
      let cid = this._getData("marks");
      cid = await this.asUploadJson(dRoot);
      this._setData("marks", cid);
      newCids.push(cid);
      await this.#asPublish({ texts: newCids });
    }
    async #asUpdateIdols(dIdx) {
      let newCids = [];
      let cid = this._getData("idols");
      cid = await this.asUploadJson(dIdx);
      this._setData("idols", cid);
      newCids.push(cid);
      await this.#asPublish({ texts: newCids });
    }
    async #asPublish(newCidInfo) {
      try {
        await this.#asDoPublish(newCidInfo);
      } catch (e) {
        this.loadCheckPoint();
        throw e;
      }
    }
    async #asDoPublish(newCidInfo) {
      console.debug("Publishing content...");
      this._setData("edition", this._getDataOrDefault("edition", 0) + 1);
      console.debug("Uploading content...");
      let cid = await this.asUploadJson(this.#toLtsJsonData());
      this._setData("_cid", cid);
      newCidInfo.texts.push(cid);
      let sig = await this.#asSign(cid);
      console.debug("Publishing...");
      for (let a of this.#aPublishers) {
        await a.asPublish(cid, this.getId(), sig);
      }
      console.debug("Pinning content...");
      const msg = JSON.stringify({ cids: newCidInfo.texts });
      sig = await this.#asSign(msg);
      await this.#aStorage.asPin(msg, this.getId(), sig);
      this.saveCheckPoint();
    }
  };
  return __toCommonJS(index_exports);
})();
